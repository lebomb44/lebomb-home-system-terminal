<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="contents">
<h1>uart/uart.c</h1>Copyright (C) 2001-2003 by egnite Software GmbH. All rights reserved.<p>
Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<p>
1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. 3. Neither the name of the copyright holders nor the names of contributors may be used to endorse or promote products derived from this software without specific prior written permission.<p>
THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.<p>
For additional information see <a href="http://www.ethernut.de/">http://www.ethernut.de/</a><p>
$Log$ Revision 1.6 2009/02/08 01:00:33 thiagocorrea Remove unused variable in sample app<p>
Revision 1.5 2008/01/31 09:38:15 haraldkipp Added return statement in main to avoid warnings with latest GCC.<p>
Revision 1.4 2005/11/22 09:14:13 haraldkipp Replaced specific device names by generalized macros.<p>
Revision 1.3 2004/11/24 16:35:56 haraldkipp Configurable floating point support<p>
Revision 1.2 2004/09/10 10:33:28 haraldkipp Temporarly removed non-configurable FP support<p>
Revision 1.1 2003/08/05 18:59:52 haraldkipp Release 3.3 update<p>
Revision 1.3 2003/02/04 18:19:41 harald Version 3 released<p>
Revision 1.2 2003/02/04 16:24:38 harald Adapted to version 3<p>
Revision 1.1 2002/08/09 12:44:10 harald Renamed for make rules<p>
Revision 1.5 2002/06/12 11:00:10 harald *** empty log message ***<p>
Revision 1.4 2002/06/04 19:13:21 harald *** empty log message ***<p>
Revision 1.3 2002/05/08 16:02:34 harald First Imagecraft compilation<p>
Revision 1.2 2001/08/10 18:20:41 harald GCC version 3 update<p>
Revision 1.1 2001/06/28 18:43:13 harald Preview release<p>
This sample demonstrates the usage of the ATmega on-chip UART. Note, that we don't do any error checking, because without this UART we can't tell the user our problem.<p>
We use floating points. Make sure to link with nutlibcrtf.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;<a class="code" href="crt_8h.html">cfg/crt.h</a>&gt;</span>    <span class="comment">/* Floating point configuration. */</span>

<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="board_8h.html">dev/board.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> *banner = <span class="stringliteral">"\nNut/OS UART Sample\n"</span>;
<span class="keyword">static</span> <a name="a0"></a><a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> presskey_P[] = <span class="stringliteral">"Press any key..."</span>;
<span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> pgm_ptr[] = <span class="stringliteral">"\nHello stranger!\n"</span>;

<span class="keyword">static</span> <span class="keywordtype">char</span> inbuf[128];

<span class="comment">/*</span>
<span class="comment"> * UART sample.</span>
<span class="comment"> *</span>
<span class="comment"> * Some functions do not work with ICCAVR.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> <a name="a1"></a><a class="code" href="arm_8h.html#a4e97f3782107649d3e4eb3875090b3a">main</a>(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> got;
    <span class="keywordtype">char</span> *cp;
    <a name="a2"></a><a class="code" href="group__xg_nut_o_s.html#g8f25a50daf29ce2cee1ec038a4d744ea" title="Unsigned 32-bit value.">u_long</a> baud = 115200;
    <a name="a3"></a><a class="code" href="group__xg_crt_stdio.html#gb940bd570245f248e9464829cd7c8c75" title="Stream structure type.">FILE</a> *uart;
<span class="preprocessor">#ifdef STDIO_FLOATING_POINT</span>
<span class="preprocessor"></span>    <span class="keywordtype">float</span> dval = 0.0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Each device must be registered. We do this by referencing the </span>
<span class="comment">     * device structure of the driver. The advantage is, that only </span>
<span class="comment">     * those device drivers are included in our flash code, which we </span>
<span class="comment">     * really need.</span>
<span class="comment">     *</span>
<span class="comment">     * The uart0 device is the first one on the ATmega chip. So it </span>
<span class="comment">     * has no configurable base address or interrupt and we set both </span>
<span class="comment">     * parameters to zero.</span>
<span class="comment">     */</span>
    <a name="a4"></a><a class="code" href="group__xg_device.html#g0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a5"></a><a class="code" href="board_8h.html#baa1375bc843b5722366b23d9d7d4f21">DEV_UART</a>, 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * Now, as the device is registered, we can open it. The fopen()</span>
<span class="comment">     * function returns a pointer to a FILE structure, which we use </span>
<span class="comment">     * for subsequent reading and writing.</span>
<span class="comment">     */</span>
    uart = <a name="a6"></a><a class="code" href="group__xg_crt_stdio.html#g84fc076beb69f76fa7a1796e2666bfe1" title="Open a stream.">fopen</a>(<a name="a7"></a><a class="code" href="board_8h.html#0fedadb8acad34bd107a9fc94477136a">DEV_UART_NAME</a>, <span class="stringliteral">"r+"</span>);

    <span class="comment">/*</span>
<span class="comment">     * Before doing the first read or write, we set the baudrate.</span>
<span class="comment">     * This low level function doesn't know about FILE structures</span>
<span class="comment">     * and we use _fileno() to get the low level file descriptor</span>
<span class="comment">     * of the stream.</span>
<span class="comment">     *</span>
<span class="comment">     * The short sleep allows the UART to settle after the baudrate</span>
<span class="comment">     * change.</span>
<span class="comment">     */</span>
    <a name="a8"></a><a class="code" href="group__xg_crt_lowio.html#g6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(<a name="a9"></a><a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(uart), <a name="a10"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#g2f1b5053775ad3be83ae499273a04de8" title="UART _ioctl() command code to set the line speed.">UART_SETSPEED</a>, &amp;baud);

    <span class="comment">/*</span>
<span class="comment">     * Stream devices can use low level read and write functions. </span>
<span class="comment">     * Writing program space data is supported too.</span>
<span class="comment">     */</span>
    <a name="a11"></a><a class="code" href="io_8h.html#901fa187b164dd6faaac1b62c88614b5">_write</a>(<a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(uart), banner, <a name="a12"></a><a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(banner));
    {
        <a name="a13"></a><a class="code" href="io_8h.html#455d5658c1358c9e7a88d587390537ea">_write_P</a>(<a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(uart), presskey_P, <span class="keyword">sizeof</span>(presskey_P));
    }

    <span class="comment">/*</span>
<span class="comment">     * Stream devices do buffered I/O. That means, nothing will be </span>
<span class="comment">     * passed to the hardware device until either the output buffer </span>
<span class="comment">     * is full or we do a flush. With stream I/O we typically use</span>
<span class="comment">     * fflush(), but low level writing a null pointer will also flush </span>
<span class="comment">     * the output buffer.</span>
<span class="comment">     */</span>
    <a class="code" href="io_8h.html#901fa187b164dd6faaac1b62c88614b5">_write</a>(<a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(uart), 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * The low level function read() will grab all available bytes </span>
<span class="comment">     * from the input buffer. If the buffer is empty, the call will</span>
<span class="comment">     * block until something is available for reading.</span>
<span class="comment">     */</span>
    got = <a name="a14"></a><a class="code" href="io_8h.html#a7278892ff16de3dd3d00ff4a89d11e4">_read</a>(<a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(uart), inbuf, <span class="keyword">sizeof</span>(inbuf));
    <a class="code" href="io_8h.html#901fa187b164dd6faaac1b62c88614b5">_write</a>(<a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(uart), inbuf, got);

    <span class="comment">/*</span>
<span class="comment">     * Nut/OS never expects a thread to return. So we enter an </span>
<span class="comment">     * endless loop here.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/*</span>
<span class="comment">         * A bit more advanced input routine is able to read a string </span>
<span class="comment">         * up to and including the first newline character or until a</span>
<span class="comment">         * specified maximum number of characters, whichever comes first.</span>
<span class="comment">         */</span>
        <a name="a15"></a><a class="code" href="group__xg_crt_stdio.html#g14acfae1988535199b72df91e18f72f3" title="Write a string to a stream.">fputs</a>(<span class="stringliteral">"\nEnter your name: "</span>, uart);
        <a name="a16"></a><a class="code" href="group__xg_crt_stdio.html#gdb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(uart);
        <a name="a17"></a><a class="code" href="group__xg_crt_stdio.html#g1c00c22c5e85d002e202cb733b644d63" title="Read a line from a stream.">fgets</a>(inbuf, <span class="keyword">sizeof</span>(inbuf), uart);

        <span class="comment">/*</span>
<span class="comment">         * Chop off trailing linefeed.</span>
<span class="comment">         */</span>
        cp = <a name="a18"></a><a class="code" href="group__xg_crt_string.html#g36feeebd3867be51852ba56dee5e53eb" title="Locate the first occurrence of a character in a string.">strchr</a>(inbuf, <span class="charliteral">'\n'</span>);
        <span class="keywordflow">if</span> (cp)
            *cp = 0;

        <span class="comment">/*</span>
<span class="comment">         * Streams support formatted output as well as printing strings </span>
<span class="comment">         * from program space.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (inbuf[0])
            <a name="a19"></a><a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(uart, <span class="stringliteral">"\nHello %s!\n"</span>, inbuf);
        <span class="keywordflow">else</span> {
            <a name="a20"></a><a class="code" href="h8_8h.html#a972577646c6e64c54658f123a8044c8">fputs_P</a>(pgm_ptr, uart);
        }

        <span class="comment">/*</span>
<span class="comment">         * Just to demonstrate formatted floating point output.</span>
<span class="comment">         * In order to use this, we need to link the application</span>
<span class="comment">         * with nutcrtf instead of nutcrt for pure integer.</span>
<span class="comment">         */</span>
<span class="preprocessor">#ifdef STDIO_FLOATING_POINT</span>
<span class="preprocessor"></span>        dval += 1.0125;
        <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(uart, <span class="stringliteral">"FP %f\n"</span>, dval);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>    }
    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
