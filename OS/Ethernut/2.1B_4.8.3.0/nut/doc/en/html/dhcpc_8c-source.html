<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_70d8cf967ca8ef90744839cf4a057d4a.html">pro</a>
  </div>
<div class="contents">
<h1>dhcpc.c</h1><a href="dhcpc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2005 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * -</span>
<a name="l00033"></a>00033 <span class="comment"> * Portions Copyright (c) 1983, 1993 by</span>
<a name="l00034"></a>00034 <span class="comment"> *  The Regents of the University of California.  All rights reserved.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00037"></a>00037 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00038"></a>00038 <span class="comment"> * are met:</span>
<a name="l00039"></a>00039 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00040"></a>00040 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00041"></a>00041 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00042"></a>00042 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00043"></a>00043 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00044"></a>00044 <span class="comment"> * 3. Neither the name of the University nor the names of its contributors</span>
<a name="l00045"></a>00045 <span class="comment"> *    may be used to endorse or promote products derived from this software</span>
<a name="l00046"></a>00046 <span class="comment"> *    without specific prior written permission.</span>
<a name="l00047"></a>00047 <span class="comment"> *</span>
<a name="l00048"></a>00048 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND</span>
<a name="l00049"></a>00049 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00050"></a>00050 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00051"></a>00051 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<a name="l00052"></a>00052 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a name="l00053"></a>00053 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<a name="l00054"></a>00054 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<a name="l00055"></a>00055 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00056"></a>00056 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<a name="l00057"></a>00057 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00058"></a>00058 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00059"></a>00059 <span class="comment"> * -</span>
<a name="l00060"></a>00060 <span class="comment"> * Portions Copyright (c) 1993 by Digital Equipment Corporation.</span>
<a name="l00061"></a>00061 <span class="comment"> *</span>
<a name="l00062"></a>00062 <span class="comment"> * Permission to use, copy, modify, and distribute this software for any</span>
<a name="l00063"></a>00063 <span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span>
<a name="l00064"></a>00064 <span class="comment"> * copyright notice and this permission notice appear in all copies, and that</span>
<a name="l00065"></a>00065 <span class="comment"> * the name of Digital Equipment Corporation not be used in advertising or</span>
<a name="l00066"></a>00066 <span class="comment"> * publicity pertaining to distribution of the document or software without</span>
<a name="l00067"></a>00067 <span class="comment"> * specific, written prior permission.</span>
<a name="l00068"></a>00068 <span class="comment"> * </span>
<a name="l00069"></a>00069 <span class="comment"> * THE SOFTWARE IS PROVIDED "AS IS" AND DIGITAL EQUIPMENT CORP. DISCLAIMS ALL</span>
<a name="l00070"></a>00070 <span class="comment"> * WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES</span>
<a name="l00071"></a>00071 <span class="comment"> * OF MERCHANTABILITY AND FITNESS.   IN NO EVENT SHALL DIGITAL EQUIPMENT</span>
<a name="l00072"></a>00072 <span class="comment"> * CORPORATION BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL</span>
<a name="l00073"></a>00073 <span class="comment"> * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR</span>
<a name="l00074"></a>00074 <span class="comment"> * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS</span>
<a name="l00075"></a>00075 <span class="comment"> * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
<a name="l00076"></a>00076 <span class="comment"> * SOFTWARE.</span>
<a name="l00077"></a>00077 <span class="comment"> */</span>
<a name="l00078"></a>00078 
<a name="l00199"></a>00199 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00200"></a>00200 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00201"></a>00201 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00202"></a>00202 <span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html" title="Header file for network configuration.">sys/confnet.h</a>&gt;</span>
<a name="l00203"></a>00203 <span class="preprocessor">#include &lt;<a class="code" href="confos_8h.html" title="Header file for global system configuration.">sys/confos.h</a>&gt;</span>
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00206"></a>00206 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00207"></a>00207 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>
<a name="l00208"></a>00208 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html" title="Internet address conversion.">arpa/inet.h</a>&gt;</span>
<a name="l00211"></a>00211 <span class="preprocessor">#include &lt;<a class="code" href="in_8h.html" title="Internet definitions.">netinet/in.h</a>&gt;</span>
<a name="l00212"></a>00212 <span class="preprocessor">#include &lt;<a class="code" href="netdb_8h.html">netdb.h</a>&gt;</span>
<a name="l00213"></a>00213 <span class="preprocessor">#include &lt;<a class="code" href="route_8h.html" title="Routing information definitions.">net/route.h</a>&gt;</span>
<a name="l00214"></a>00214 <span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html" title="UDP and TCP socket interface definitions.">sys/socket.h</a>&gt;</span>
<a name="l00215"></a>00215 <span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html" title="DHCP protocol definitions.">pro/dhcp.h</a>&gt;</span>
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="netdebug_8h.html">net/netdebug.h</a>&gt;</span>
<a name="l00219"></a>00219 <span class="preprocessor">#endif</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>
<a name="l00221"></a>00221 <span class="preprocessor">#if 0</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span><span class="comment">/* Use for local debugging. */</span>
<a name="l00223"></a>00223 <span class="preprocessor">#define NUTDEBUG</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00225"></a>00225 <span class="preprocessor">#define __tcp_trs stdout</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="stdint_8h.html#d0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> <a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> = 1;
<a name="l00227"></a>00227 <span class="preprocessor">#endif</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span>
<a name="l00233"></a>00233 
<a name="l00240"></a>00240 
<a name="l00246"></a>00246 <span class="preprocessor">#ifndef DHCP_SERVERPORT</span>
<a name="l00247"></a><a class="code" href="group__xg_d_h_c_p_c.html#g3acf53e1d76d3ac7ce7bb68c6e946792">00247</a> <span class="preprocessor"></span><span class="preprocessor">#define DHCP_SERVERPORT      67</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>
<a name="l00255"></a>00255 <span class="preprocessor">#ifndef DHCP_CLIENTPORT</span>
<a name="l00256"></a><a class="code" href="group__xg_d_h_c_p_c.html#g79a9a113fa47629510b6d5dd6fef9f83">00256</a> <span class="preprocessor"></span><span class="preprocessor">#define DHCP_CLIENTPORT      68</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span>
<a name="l00268"></a>00268 <span class="preprocessor">#ifndef MAX_DHCP_MSGSIZE</span>
<a name="l00269"></a><a class="code" href="group__xg_d_h_c_p_c.html#gd3f666f92061936c7d8be6c00cbf9cd0">00269</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_MSGSIZE    576</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>
<a name="l00279"></a>00279 <span class="preprocessor">#ifndef MIN_DHCP_MSGSIZE</span>
<a name="l00280"></a><a class="code" href="group__xg_d_h_c_p_c.html#g270c234bea4dc7da27ee3b5b561d0bc4">00280</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN_DHCP_MSGSIZE    300</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>
<a name="l00298"></a>00298 <span class="preprocessor">#ifndef MAX_DHCP_BUFSIZE</span>
<a name="l00299"></a><a class="code" href="group__xg_d_h_c_p_c.html#g800db42c93d35caa64eb2b0d6f492731">00299</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_BUFSIZE    1728</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>
<a name="l00311"></a>00311 <span class="preprocessor">#ifndef MIN_DHCP_WAIT</span>
<a name="l00312"></a><a class="code" href="group__xg_d_h_c_p_c.html#g4ab1c132c4f2daaab22d85b3d4afe984">00312</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN_DHCP_WAIT       4000</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>
<a name="l00323"></a>00323 <span class="preprocessor">#ifndef MAX_DHCP_WAIT</span>
<a name="l00324"></a><a class="code" href="group__xg_d_h_c_p_c.html#gcd76719c532ca403fc624016fd56ade3">00324</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_WAIT       64000</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>
<a name="l00335"></a>00335 <span class="preprocessor">#ifndef MAX_DCHP_RETRIES</span>
<a name="l00336"></a><a class="code" href="group__xg_d_h_c_p_c.html#g0f2c916299b753d6201f90917d83793a">00336</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DCHP_RETRIES    3</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>
<a name="l00347"></a>00347 <span class="preprocessor">#ifndef MAX_DCHP_RELEASE_RETRIES</span>
<a name="l00348"></a><a class="code" href="group__xg_d_h_c_p_c.html#gb9e5603e983fc563188a47a2397537d8">00348</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DCHP_RELEASE_RETRIES    0</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>
<a name="l00358"></a>00358 <span class="preprocessor">#ifndef DHCP_DEFAULT_LEASE</span>
<a name="l00359"></a><a class="code" href="group__xg_d_h_c_p_c.html#g7574583d7750943017fa8cde5ee952a0">00359</a> <span class="preprocessor"></span><span class="preprocessor">#define DHCP_DEFAULT_LEASE  43200</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span>
<a name="l00367"></a>00367 <span class="preprocessor">#ifndef MAX_DHCP_NAPTIME</span>
<a name="l00368"></a><a class="code" href="group__xg_d_h_c_p_c.html#g954acae12281d9d625376976442a5713">00368</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_NAPTIME    4294967</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span>
<a name="l00376"></a>00376 <span class="preprocessor">#ifndef NUT_THREAD_DHCPSTACK</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span><span class="preprocessor">#if defined(__AVR__)</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span><span class="preprocessor">#if defined(__GNUC__)</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span><span class="comment">/* avr-gcc size optimized code used 192 bytes. */</span>
<a name="l00380"></a>00380 <span class="preprocessor">#define NUT_THREAD_DHCPSTACK    288</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span><span class="comment">/* icc-avr v7.19 used 360 bytes. */</span>
<a name="l00383"></a>00383 <span class="preprocessor">#define NUT_THREAD_DHCPSTACK    512</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span><span class="comment">/* arm-elf-gcc used 276 bytes with size optimized, 680 bytes with debug code. */</span>
<a name="l00387"></a><a class="code" href="group__xg_d_h_c_p_c.html#g2f3a479eff1da93bc057498174f94f78">00387</a> <span class="preprocessor">#define NUT_THREAD_DHCPSTACK    384</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>
<a name="l00399"></a>00399 
<a name="l00402"></a><a class="code" href="group__xg_d_h_c_p_c.html#g368aca81d0a71853aa3939f546cc25ae">00402</a> <span class="preprocessor">#define DHCP_DISCOVER   1</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span>
<a name="l00408"></a><a class="code" href="group__xg_d_h_c_p_c.html#g4649df4abbae20e28fe422d09decd450">00408</a> <span class="preprocessor">#define DHCP_OFFER      2</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span>
<a name="l00417"></a><a class="code" href="group__xg_d_h_c_p_c.html#g98a346c53c91848070fd980a98fa77d1">00417</a> <span class="preprocessor">#define DHCP_REQUEST    3</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>
<a name="l00423"></a><a class="code" href="group__xg_d_h_c_p_c.html#ge7469660afdf7997c020f7fbf5164548">00423</a> <span class="preprocessor">#define DHCP_DECLINE    4</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span>
<a name="l00429"></a><a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e">00429</a> <span class="preprocessor">#define DHCP_ACK        5</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span>
<a name="l00435"></a><a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221">00435</a> <span class="preprocessor">#define DHCP_NAK        6</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>
<a name="l00439"></a><a class="code" href="group__xg_d_h_c_p_c.html#ge629d2dc5df40f03ea87cc94a5e3f3eb">00439</a> <span class="preprocessor">#define DHCP_RELEASE    7</span>
<a name="l00440"></a>00440 <span class="preprocessor"></span>
<a name="l00445"></a><a class="code" href="group__xg_d_h_c_p_c.html#gaea6a969c0da81c2611885514bbe433f">00445</a> <span class="preprocessor">#define DHCP_INFORM     8</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span>
<a name="l00456"></a>00456 
<a name="l00463"></a><a class="code" href="group__xg_d_h_c_p_c.html#ge4c88fabfacd94d1c6ba3e4334d0ba3a">00463</a> <span class="preprocessor">#define DHCPOPT_PAD          0</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span>
<a name="l00468"></a><a class="code" href="group__xg_d_h_c_p_c.html#g674742203c633d7b8d832acaddbc0e97">00468</a> <span class="preprocessor">#define DHCPOPT_NETMASK      1</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span>
<a name="l00473"></a><a class="code" href="group__xg_d_h_c_p_c.html#g94a8a8a86b5c060777a78985ba8a5b3c">00473</a> <span class="preprocessor">#define DHCPOPT_GATEWAY      3</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span>
<a name="l00478"></a><a class="code" href="group__xg_d_h_c_p_c.html#g91e45feb40748587587943ec54bbd84b">00478</a> <span class="preprocessor">#define DHCPOPT_DNS          6</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span>
<a name="l00483"></a><a class="code" href="group__xg_d_h_c_p_c.html#gfeee77350e816dc77536191de1f96d18">00483</a> <span class="preprocessor">#define DHCPOPT_HOSTNAME     12</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>
<a name="l00488"></a><a class="code" href="group__xg_d_h_c_p_c.html#g016f2d39467829054af8983362cf3f25">00488</a> <span class="preprocessor">#define DHCPOPT_DOMAIN       15</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>
<a name="l00493"></a><a class="code" href="group__xg_d_h_c_p_c.html#gf3a20d70f3031064737e2590bbb11117">00493</a> <span class="preprocessor">#define DHCPOPT_BROADCAST    28</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span>
<a name="l00498"></a><a class="code" href="group__xg_d_h_c_p_c.html#g9c2fb45faa505750ea030d53c9358461">00498</a> <span class="preprocessor">#define DHCPOPT_REQESTIP     50</span>
<a name="l00499"></a>00499 <span class="preprocessor"></span>
<a name="l00503"></a><a class="code" href="group__xg_d_h_c_p_c.html#gb6526238588621f1a79810fa60844a06">00503</a> <span class="preprocessor">#define DHCPOPT_LEASETIME    51</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>
<a name="l00508"></a><a class="code" href="group__xg_d_h_c_p_c.html#g656aec5e7e57c681b762299c5e2aedee">00508</a> <span class="preprocessor">#define DHCPOPT_MSGTYPE      53</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>
<a name="l00513"></a><a class="code" href="group__xg_d_h_c_p_c.html#gded839fd1ad6d43e60374db9e13cab34">00513</a> <span class="preprocessor">#define DHCPOPT_SID          54</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>
<a name="l00518"></a><a class="code" href="group__xg_d_h_c_p_c.html#g77d347bafe70ed15f161851d06dacf53">00518</a> <span class="preprocessor">#define DHCPOPT_PARAMREQUEST 55</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span>
<a name="l00523"></a><a class="code" href="group__xg_d_h_c_p_c.html#g2c7a6575a0b44e10eaef28472a0daa01">00523</a> <span class="preprocessor">#define DHCPOPT_MAXMSGSIZE   57</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span>
<a name="l00528"></a><a class="code" href="group__xg_d_h_c_p_c.html#g196e0f2e83a278ac19f8f31c64bdac0b">00528</a> <span class="preprocessor">#define DHCPOPT_RENEWALTIME  58</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span>
<a name="l00533"></a><a class="code" href="group__xg_d_h_c_p_c.html#g8f8581ab278c2f8db2eb5a7b0bc9a91a">00533</a> <span class="preprocessor">#define DHCPOPT_REBINDTIME   59</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>
<a name="l00538"></a><a class="code" href="group__xg_d_h_c_p_c.html#g4e0c63157dd2df622328943ac434e1cf">00538</a> <span class="preprocessor">#define DHCPOPT_END          255</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>
<a name="l00545"></a>00545 <span class="keyword">typedef</span> <span class="keyword">struct </span>bootp BOOTP;
<a name="l00546"></a>00546 
<a name="l00550"></a>00550 <span class="keyword">struct </span><a class="code" href="icc_8h.html#9d373a9b65ff25b2db84c07394e1c212" title="Object attribute support.">__attribute__</a> ((packed)) bootp {
<a name="l00551"></a>00551     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_op;              
<a name="l00552"></a>00552     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_htype;           
<a name="l00553"></a>00553     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_hlen;            
<a name="l00554"></a>00554     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_hops;            
<a name="l00555"></a>00555     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> bp_xid;              
<a name="l00556"></a>00556     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> bp_secs;            
<a name="l00557"></a>00557     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> bp_flags;           
<a name="l00558"></a>00558     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> bp_ciaddr;           
<a name="l00559"></a>00559     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> bp_yiaddr;           
<a name="l00560"></a>00560     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> bp_siaddr;           
<a name="l00561"></a>00561     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> bp_giaddr;           
<a name="l00562"></a>00562     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_chaddr[16];      
<a name="l00563"></a>00563     <span class="keywordtype">char</span> bp_sname[64];          
<a name="l00564"></a>00564     <span class="keywordtype">char</span> bp_file[128];          
<a name="l00565"></a>00565     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_options[312];    
<a name="l00566"></a>00566 };
<a name="l00567"></a>00567 
<a name="l00571"></a>00571 <span class="keyword">typedef</span> <span class="keyword">struct </span>dyn_cfg DYNCFG;
<a name="l00572"></a>00572 
<a name="l00576"></a>00576 <span class="keyword">struct </span>dyn_cfg {
<a name="l00577"></a>00577     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> dyn_msgtyp;         
<a name="l00578"></a>00578     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_yiaddr;          
<a name="l00579"></a>00579     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_netmask;         
<a name="l00580"></a>00580     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_broadcast;       
<a name="l00581"></a>00581     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_gateway;         
<a name="l00582"></a>00582     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_pdns;            
<a name="l00583"></a>00583     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_sdns;            
<a name="l00584"></a>00584     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_sid;             
<a name="l00585"></a>00585     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_renewalTime;     
<a name="l00586"></a>00586     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_rebindTime;      
<a name="l00587"></a>00587     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dyn_leaseTime;       
<a name="l00588"></a>00588     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *dyn_hostname;      
<a name="l00589"></a>00589     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *dyn_domain;        
<a name="l00590"></a>00590 };
<a name="l00591"></a>00591 
<a name="l00598"></a>00598 <span class="keyword">static</span> DYNCFG *dhcpConfig;
<a name="l00599"></a>00599 
<a name="l00606"></a>00606 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> dhcpThread;
<a name="l00607"></a>00607 
<a name="l00611"></a>00611 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> dhcpState;
<a name="l00612"></a>00612 
<a name="l00616"></a>00616 <span class="keyword">static</span> <span class="keywordtype">int</span> dhcpError;
<a name="l00617"></a>00617 
<a name="l00623"></a>00623 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> dhcpWake;
<a name="l00624"></a>00624 
<a name="l00630"></a>00630 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> dhcpDone;
<a name="l00631"></a>00631 
<a name="l00637"></a>00637 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dhcpApiTimeout;
<a name="l00638"></a>00638 
<a name="l00645"></a>00645 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> dhcpApiStart;
<a name="l00646"></a>00646 
<a name="l00653"></a>00653 <span class="preprocessor">#ifdef __arm__</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span><span class="keyword">static</span> NUTDEVICE *dhcpDev;
<a name="l00655"></a>00655 <span class="preprocessor">#endif</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span>
<a name="l00668"></a>00668 <span class="keyword">static</span> <span class="keywordtype">void</span> copy_str(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ** dst, <span class="keywordtype">void</span> *src, <span class="keywordtype">int</span> len)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (*dst) {
<a name="l00671"></a>00671         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(*dst);
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673     <span class="keywordflow">if</span> ((*dst = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(len + 1)) != 0) {
<a name="l00674"></a>00674         <span class="keywordflow">if</span> (len) {
<a name="l00675"></a>00675             <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(*dst, src, len);
<a name="l00676"></a>00676         }
<a name="l00677"></a>00677         *(*dst + len) = 0;
<a name="l00678"></a>00678     }
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00688"></a>00688 <span class="keyword">static</span> <span class="keywordtype">void</span> ReleaseDynCfg(DYNCFG * dyncfg)
<a name="l00689"></a>00689 {
<a name="l00690"></a>00690     <span class="keywordflow">if</span> (dyncfg) {
<a name="l00691"></a>00691         <span class="keywordflow">if</span> (dyncfg-&gt;dyn_hostname) {
<a name="l00692"></a>00692             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dyncfg-&gt;dyn_hostname);
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694         <span class="keywordflow">if</span> (dyncfg-&gt;dyn_domain) {
<a name="l00695"></a>00695             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dyncfg-&gt;dyn_domain);
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dyncfg);
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00712"></a>00712 <span class="keyword">static</span> DYNCFG *ParseReply(BOOTP *bp, <span class="keywordtype">int</span> len)
<a name="l00713"></a>00713 {
<a name="l00714"></a>00714     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op;
<a name="l00715"></a>00715     <span class="keywordtype">int</span> left;
<a name="l00716"></a>00716     DYNCFG *cfgp;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="comment">/* Allocate and initialize a new structure. */</span>
<a name="l00719"></a>00719     <span class="keywordflow">if</span> ((cfgp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(DYNCFG))) == 0) {
<a name="l00720"></a>00720         <span class="keywordflow">return</span> 0;
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(cfgp, 0, <span class="keyword">sizeof</span>(DYNCFG));
<a name="l00723"></a>00723     cfgp-&gt;dyn_leaseTime = <a class="code" href="group__xg_d_h_c_p_c.html#g7574583d7750943017fa8cde5ee952a0" title="Default lease time in seconds.">DHCP_DEFAULT_LEASE</a>;
<a name="l00724"></a>00724 
<a name="l00725"></a>00725     <span class="comment">/* Set the assigned IP address. */</span>
<a name="l00726"></a>00726     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(&amp;cfgp-&gt;dyn_yiaddr, &amp;bp-&gt;bp_yiaddr, 4);
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     <span class="comment">/* </span>
<a name="l00729"></a>00729 <span class="comment">     * Parse options until an end option is found or until we reached</span>
<a name="l00730"></a>00730 <span class="comment">     * the end of the message.</span>
<a name="l00731"></a>00731 <span class="comment">     */</span>
<a name="l00732"></a>00732     op = bp-&gt;bp_options + 4;
<a name="l00733"></a>00733     left = len - (<span class="keyword">sizeof</span>(*bp) - <span class="keyword">sizeof</span>(bp-&gt;bp_options)) - 4;
<a name="l00734"></a>00734     <span class="keywordflow">while</span> (*op != <a class="code" href="group__xg_d_h_c_p_c.html#g4e0c63157dd2df622328943ac434e1cf" title="DHCP end option.">DHCPOPT_END</a> &amp;&amp; left &gt; 0) {
<a name="l00735"></a>00735         <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ol;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00738"></a>00738 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l00739"></a>00739             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Opt-%u]"</span>, *op);
<a name="l00740"></a>00740         }
<a name="l00741"></a>00741 <span class="preprocessor">#endif</span>
<a name="l00742"></a>00742 <span class="preprocessor"></span>        <span class="comment">/* Pad option is used for boundary alignment. */</span>
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ge4c88fabfacd94d1c6ba3e4334d0ba3a" title="DHCP pad option.">DHCPOPT_PAD</a>) {
<a name="l00744"></a>00744             op++;
<a name="l00745"></a>00745             left--;
<a name="l00746"></a>00746             <span class="keywordflow">continue</span>;
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749         <span class="comment">/* Reject if option length exceeds total length. */</span>
<a name="l00750"></a>00750         <span class="keywordflow">if</span> ((ol = *(op + 1)) &gt; left) {
<a name="l00751"></a>00751             <span class="keywordflow">break</span>;
<a name="l00752"></a>00752         }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <span class="comment">/* Type of this message. */</span>
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g656aec5e7e57c681b762299c5e2aedee" title="DHCP message type option.">DHCPOPT_MSGTYPE</a>) {
<a name="l00756"></a>00756             <span class="keywordflow">if</span> (ol != 1) {
<a name="l00757"></a>00757                 <span class="keywordflow">break</span>;
<a name="l00758"></a>00758             }
<a name="l00759"></a>00759             cfgp-&gt;dyn_msgtyp = *(op + 2);
<a name="l00760"></a>00760         }
<a name="l00761"></a>00761         <span class="comment">/* Our host name. May or may not include the domain. */</span>
<a name="l00762"></a>00762         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gfeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>) {
<a name="l00763"></a>00763             copy_str(&amp;cfgp-&gt;dyn_hostname, op + 2, ol);
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765         <span class="comment">/* Name of the domain we are in. */</span>
<a name="l00766"></a>00766         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g016f2d39467829054af8983362cf3f25" title="DHCP domain name option.">DHCPOPT_DOMAIN</a>) {
<a name="l00767"></a>00767             copy_str(&amp;cfgp-&gt;dyn_domain, op + 2, ol);
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         <span class="comment">/* All remaining options require at least 4 octets. */</span>
<a name="l00771"></a>00771         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ol &gt;= 4) {
<a name="l00772"></a>00772             <span class="comment">/* Preset most often used long value. */</span>
<a name="l00773"></a>00773             <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> lval = *(op + 2);
<a name="l00774"></a>00774             lval += (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 3)) &lt;&lt; 8;
<a name="l00775"></a>00775             lval += (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 4)) &lt;&lt; 16;
<a name="l00776"></a>00776             lval += (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 5)) &lt;&lt; 24;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778             <span class="comment">/* Our IP network mask. */</span>
<a name="l00779"></a>00779             <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g674742203c633d7b8d832acaddbc0e97" title="DHCP subnet mask option.">DHCPOPT_NETMASK</a>) {
<a name="l00780"></a>00780                 cfgp-&gt;dyn_netmask = lval;
<a name="l00781"></a>00781             }
<a name="l00782"></a>00782             <span class="comment">/* Our IP broadcast address. */</span>
<a name="l00783"></a>00783             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gf3a20d70f3031064737e2590bbb11117" title="DHCP broadcast address option.">DHCPOPT_BROADCAST</a>) {
<a name="l00784"></a>00784                 cfgp-&gt;dyn_broadcast = lval;
<a name="l00785"></a>00785             }
<a name="l00786"></a>00786             <span class="comment">/* Our IP default gate. More than one gateway may be </span>
<a name="l00787"></a>00787 <span class="comment">               specified. We take the fist one only and ignore the </span>
<a name="l00788"></a>00788 <span class="comment">               rest. */</span>
<a name="l00789"></a>00789             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g94a8a8a86b5c060777a78985ba8a5b3c" title="DHCP router option.">DHCPOPT_GATEWAY</a>) {
<a name="l00790"></a>00790                 cfgp-&gt;dyn_gateway = lval;
<a name="l00791"></a>00791             }
<a name="l00792"></a>00792             <span class="comment">/* Our DNS server. Updated by Jelle Martijn Kok to </span>
<a name="l00793"></a>00793 <span class="comment">               support a secondary DNS. */</span>
<a name="l00794"></a>00794             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g91e45feb40748587587943ec54bbd84b" title="DHCP domain name server option.">DHCPOPT_DNS</a>) {
<a name="l00795"></a>00795                 cfgp-&gt;dyn_pdns = lval;
<a name="l00796"></a>00796                 <span class="keywordflow">if</span> (ol &gt;= 8) {
<a name="l00797"></a>00797                     cfgp-&gt;dyn_sdns = *(op + 6);
<a name="l00798"></a>00798                     cfgp-&gt;dyn_sdns += (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 7)) &lt;&lt; 8;
<a name="l00799"></a>00799                     cfgp-&gt;dyn_sdns += (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 8)) &lt;&lt; 16;
<a name="l00800"></a>00800                     cfgp-&gt;dyn_sdns += (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 9)) &lt;&lt; 24;
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802             }
<a name="l00803"></a>00803             <span class="comment">/* Server identifier. */</span>
<a name="l00804"></a>00804             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gded839fd1ad6d43e60374db9e13cab34" title="DHCP server identifier option.">DHCPOPT_SID</a>) {
<a name="l00805"></a>00805                 cfgp-&gt;dyn_sid = lval;
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807             <span class="comment">/* Renewal time. */</span>
<a name="l00808"></a>00808             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g196e0f2e83a278ac19f8f31c64bdac0b" title="DHCP renewal time option.">DHCPOPT_RENEWALTIME</a>) {
<a name="l00809"></a>00809                 cfgp-&gt;dyn_renewalTime = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(lval);
<a name="l00810"></a>00810             }
<a name="l00811"></a>00811             <span class="comment">/* Rebinding time. */</span>
<a name="l00812"></a>00812             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#g8f8581ab278c2f8db2eb5a7b0bc9a91a" title="DHCP rebinding time option.">DHCPOPT_REBINDTIME</a>) {
<a name="l00813"></a>00813                 cfgp-&gt;dyn_rebindTime = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(lval);
<a name="l00814"></a>00814             }
<a name="l00815"></a>00815             <span class="comment">/* Total lease time granted. */</span>
<a name="l00816"></a>00816             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gb6526238588621f1a79810fa60844a06" title="DHCP IP address lease time option.">DHCPOPT_LEASETIME</a>) {
<a name="l00817"></a>00817                 cfgp-&gt;dyn_leaseTime = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(lval);
<a name="l00818"></a>00818             }
<a name="l00819"></a>00819         }
<a name="l00820"></a>00820         op += ol + 2;
<a name="l00821"></a>00821         left -= ol + 2;
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824     <span class="comment">/*</span>
<a name="l00825"></a>00825 <span class="comment">     * Discard this configuration if parsing stopped before reaching </span>
<a name="l00826"></a>00826 <span class="comment">     * the end option or if we didn't receive an expected message type.</span>
<a name="l00827"></a>00827 <span class="comment">     */</span>
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (*op != <a class="code" href="group__xg_d_h_c_p_c.html#g4e0c63157dd2df622328943ac434e1cf" title="DHCP end option.">DHCPOPT_END</a> ||   <span class="comment">/* */</span>
<a name="l00829"></a>00829         (cfgp-&gt;dyn_msgtyp != <a class="code" href="group__xg_d_h_c_p_c.html#g4649df4abbae20e28fe422d09decd450" title="Server to client in response to DHCP_DISCOVER.">DHCP_OFFER</a> &amp;&amp;      <span class="comment">/* */</span>
<a name="l00830"></a>00830          cfgp-&gt;dyn_msgtyp != <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a> &amp;&amp;        <span class="comment">/* */</span>
<a name="l00831"></a>00831          cfgp-&gt;dyn_msgtyp != <a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221" title="Server to client indicating client&amp;#39;s notion of network address is incorrect.">DHCP_NAK</a>)) {
<a name="l00832"></a>00832 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l00834"></a>00834             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Parse Error]"</span>);
<a name="l00835"></a>00835         }
<a name="l00836"></a>00836 <span class="preprocessor">#endif</span>
<a name="l00837"></a>00837 <span class="preprocessor"></span>        ReleaseDynCfg(cfgp);
<a name="l00838"></a>00838         <span class="keywordflow">return</span> 0;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="comment">/* Calculate renewal and rebind times. */</span>
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (cfgp-&gt;dyn_renewalTime == 0) {
<a name="l00843"></a>00843         cfgp-&gt;dyn_renewalTime = cfgp-&gt;dyn_leaseTime / 2;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (cfgp-&gt;dyn_rebindTime == 0) {
<a name="l00846"></a>00846         cfgp-&gt;dyn_rebindTime = cfgp-&gt;dyn_renewalTime +  <span class="comment">/* */</span>
<a name="l00847"></a>00847             cfgp-&gt;dyn_renewalTime / 2 + <span class="comment">/* */</span>
<a name="l00848"></a>00848             cfgp-&gt;dyn_renewalTime / 4;
<a name="l00849"></a>00849     }
<a name="l00850"></a>00850     <span class="keywordflow">return</span> cfgp;
<a name="l00851"></a>00851 }
<a name="l00852"></a>00852 
<a name="l00863"></a>00863 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddOption(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ot, <span class="keywordtype">void</span> *ov, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> len)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865     *op++ = ot;
<a name="l00866"></a>00866     *op++ = len;
<a name="l00867"></a>00867     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(op, ov, len);
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <span class="keywordflow">return</span> 2 + len;
<a name="l00870"></a>00870 }
<a name="l00871"></a>00871 
<a name="l00881"></a>00881 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddByteOption(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ot, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ov)
<a name="l00882"></a>00882 {
<a name="l00883"></a>00883     *op++ = ot;
<a name="l00884"></a>00884     *op++ = 1;
<a name="l00885"></a>00885     *op++ = ov;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     <span class="keywordflow">return</span> 3;
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00900"></a>00900 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddShortOption(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ot, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> ov)
<a name="l00901"></a>00901 {
<a name="l00902"></a>00902     *op++ = ot;
<a name="l00903"></a>00903     *op++ = 2;
<a name="l00904"></a>00904     ov = <a class="code" href="group__xg_nut_o_s.html#g51799f5ebb4c7228ef7e95c247030f42" title="Convert short value from host to network byte order.">htons</a>(ov);
<a name="l00905"></a>00905     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(op, &amp;ov, 2);
<a name="l00906"></a>00906 
<a name="l00907"></a>00907     <span class="keywordflow">return</span> 4;
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00922"></a>00922 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddParmReqOption(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#g77d347bafe70ed15f161851d06dacf53" title="DHCP parameter request list option.">DHCPOPT_PARAMREQUEST</a>;
<a name="l00925"></a>00925     *op++ = 3;                  <span class="comment">/* Adjust when adding more options! */</span>
<a name="l00926"></a>00926     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#g674742203c633d7b8d832acaddbc0e97" title="DHCP subnet mask option.">DHCPOPT_NETMASK</a>;    <span class="comment">/* Typically sent by default, but play safe. */</span>
<a name="l00927"></a>00927     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#g94a8a8a86b5c060777a78985ba8a5b3c" title="DHCP router option.">DHCPOPT_GATEWAY</a>;    <span class="comment">/* We want a default gateway. */</span>
<a name="l00928"></a>00928     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#g91e45feb40748587587943ec54bbd84b" title="DHCP domain name server option.">DHCPOPT_DNS</a>;        <span class="comment">/* We want the DNS' IP. */</span>
<a name="l00929"></a>00929     <span class="keywordflow">return</span> 5;                   <span class="comment">/* Adjust when adding more options! */</span>
<a name="l00930"></a>00930 }
<a name="l00931"></a>00931 
<a name="l00953"></a>00953 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> DhcpPrepHeader(BOOTP *bp, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> msgtyp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> ciaddr, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op;
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(bp, 0, <span class="keyword">sizeof</span>(*bp));
<a name="l00958"></a>00958     <span class="comment">/* Clients send bootp requests (op code 1) only. */</span>
<a name="l00959"></a>00959     bp-&gt;bp_op = 1;
<a name="l00960"></a>00960     <span class="comment">/* Ethernet addresses are type 1 with 6 octets. */</span>
<a name="l00961"></a>00961     bp-&gt;bp_htype = 1;
<a name="l00962"></a>00962     bp-&gt;bp_hlen = 6;
<a name="l00963"></a>00963     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(bp-&gt;bp_chaddr, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_mac, 6);
<a name="l00964"></a>00964     <span class="comment">/* Transaction identifier. */</span>
<a name="l00965"></a>00965     bp-&gt;bp_xid = xid;
<a name="l00966"></a>00966     <span class="comment">/* Seconds elapsed since address acquisition. */</span>
<a name="l00967"></a>00967     bp-&gt;bp_secs = <a class="code" href="group__xg_nut_o_s.html#g51799f5ebb4c7228ef7e95c247030f42" title="Convert short value from host to network byte order.">htons</a>(secs);
<a name="l00968"></a>00968 
<a name="l00969"></a>00969 <span class="preprocessor">#ifdef DHCP_BROADCAST_FLAG</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00971"></a>00971 <span class="comment">     * We do not need the broadcast flag, because our stack accepts IP </span>
<a name="l00972"></a>00972 <span class="comment">     * messages to any destination if no local address has been assigned,</span>
<a name="l00973"></a>00973 <span class="comment">     * However, we continue supporting this compile time option.</span>
<a name="l00974"></a>00974 <span class="comment">     */</span>
<a name="l00975"></a>00975     bp-&gt;bp_flags = <a class="code" href="group__xg_nut_o_s.html#g51799f5ebb4c7228ef7e95c247030f42" title="Convert short value from host to network byte order.">htons</a>(0x8000);
<a name="l00976"></a>00976 <span class="preprocessor">#endif</span>
<a name="l00977"></a>00977 <span class="preprocessor"></span>
<a name="l00978"></a>00978     bp-&gt;bp_ciaddr = ciaddr;
<a name="l00979"></a>00979 
<a name="l00980"></a>00980     <span class="comment">/* Add the DHCP magic cookie according to RFC 1497. */</span>
<a name="l00981"></a>00981     op = bp-&gt;bp_options;
<a name="l00982"></a>00982     *op++ = 0x63;
<a name="l00983"></a>00983     *op++ = 0x82;
<a name="l00984"></a>00984     *op++ = 0x53;
<a name="l00985"></a>00985     *op++ = 0x63;
<a name="l00986"></a>00986 
<a name="l00987"></a>00987     <span class="comment">/* Add the DHCP message type option. */</span>
<a name="l00988"></a>00988     <span class="keywordflow">return</span> DhcpAddByteOption(op, <a class="code" href="group__xg_d_h_c_p_c.html#g656aec5e7e57c681b762299c5e2aedee" title="DHCP message type option.">DHCPOPT_MSGTYPE</a>, msgtyp) + 4;
<a name="l00989"></a>00989 }
<a name="l00990"></a>00990 
<a name="l01009"></a>01009 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendMessage(UDPSOCKET * sock, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> addr, BOOTP *bp, <span class="keywordtype">size_t</span> len)
<a name="l01010"></a>01010 {
<a name="l01011"></a>01011     <span class="comment">/* Add 'end of options'. */</span>
<a name="l01012"></a>01012     bp-&gt;bp_options[len++] = <a class="code" href="group__xg_d_h_c_p_c.html#g4e0c63157dd2df622328943ac434e1cf" title="DHCP end option.">DHCPOPT_END</a>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="comment">/* Maintain a BOOTP compatible minimum packet size of 300 octets. </span>
<a name="l01015"></a>01015 <span class="comment">       Thanks to Tomohiro Haraikawa. */</span>
<a name="l01016"></a>01016     <span class="keywordflow">if</span> ((len += <span class="keyword">sizeof</span>(BOOTP) - <span class="keyword">sizeof</span>(bp-&gt;bp_options)) &lt; <a class="code" href="group__xg_d_h_c_p_c.html#g270c234bea4dc7da27ee3b5b561d0bc4" title="Minimum DHCP message length.">MIN_DHCP_MSGSIZE</a>) {
<a name="l01017"></a>01017         len = <a class="code" href="group__xg_d_h_c_p_c.html#g270c234bea4dc7da27ee3b5b561d0bc4" title="Minimum DHCP message length.">MIN_DHCP_MSGSIZE</a>;
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01020"></a>01020 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l01021"></a>01021         <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Send to %s]"</span>, <a class="code" href="group__xg_i_p.html#g9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(addr));
<a name="l01022"></a>01022     }
<a name="l01023"></a>01023 <span class="preprocessor">#endif</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__xg_udp_socket.html#g10191929e17f17de9f49c5b1f8822154" title="Send a UDP datagram.">NutUdpSendTo</a>(sock, addr, <a class="code" href="group__xg_d_h_c_p_c.html#g3acf53e1d76d3ac7ce7bb68c6e946792" title="UDP port of DHCP server.">DHCP_SERVERPORT</a>, bp, len) &lt; 0) {
<a name="l01025"></a>01025         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#g7406fc3703f9bca15d9acc123d53df7c" title="DHCP transmit error.">DHCPERR_TRANSMIT</a>;
<a name="l01026"></a>01026         <span class="keywordflow">return</span> -1;
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     <span class="keywordflow">return</span> 0;
<a name="l01029"></a>01029 }
<a name="l01030"></a>01030 
<a name="l01044"></a>01044 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpRecvMessage(UDPSOCKET * sock, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid, BOOTP *bp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> tmo)
<a name="l01045"></a>01045 {
<a name="l01046"></a>01046     <span class="keywordtype">int</span> rc;
<a name="l01047"></a>01047     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> port;
<a name="l01048"></a>01048     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> addr;
<a name="l01049"></a>01049     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> etim;
<a name="l01050"></a>01050     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> wtim;
<a name="l01051"></a>01051 
<a name="l01052"></a>01052     <span class="comment">/* Set our start time. */</span>
<a name="l01053"></a>01053     etim = <a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>();
<a name="l01054"></a>01054     <span class="comment">/* Set the initial receive timeout. */</span>
<a name="l01055"></a>01055     wtim = tmo;
<a name="l01056"></a>01056     <span class="keywordflow">for</span> (;;) {
<a name="l01057"></a>01057         rc = <a class="code" href="group__xg_udp_socket.html#g6b8b9b8ddce0e1024f75c7575d8c9e3b" title="Receive a UDP datagram.">NutUdpReceiveFrom</a>(sock, &amp;addr, &amp;port, bp, <span class="keyword">sizeof</span>(BOOTP), wtim);
<a name="l01058"></a>01058 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l01060"></a>01060             <span class="keywordflow">if</span> (rc &gt; 0) {
<a name="l01061"></a>01061                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Recv from %s]"</span>, <a class="code" href="group__xg_i_p.html#g9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(addr));
<a name="l01062"></a>01062             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01063"></a>01063                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Recv Error]"</span>);
<a name="l01064"></a>01064             } <span class="keywordflow">else</span> {
<a name="l01065"></a>01065                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Recv Timeout %lu]"</span>, tmo);
<a name="l01066"></a>01066             }
<a name="l01067"></a>01067         }
<a name="l01068"></a>01068 <span class="preprocessor">#endif</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span>        <span class="comment">/* Immediately return on receive errors and timeouts. */</span>
<a name="l01070"></a>01070         <span class="keywordflow">if</span> (rc &lt;= 0) {
<a name="l01071"></a>01071             <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01072"></a>01072                 dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#g848d743685215f672e45520af5df2a56" title="DHCP receive error.">DHCPERR_RECEIVE</a>;
<a name="l01073"></a>01073             }
<a name="l01074"></a>01074             <span class="keywordflow">break</span>;
<a name="l01075"></a>01075         }
<a name="l01076"></a>01076         <span class="comment">/* The message must at least include the BOOTP header plus five </span>
<a name="l01077"></a>01077 <span class="comment">           bytes of options (magic and end). We are quite liberal here. */</span>
<a name="l01078"></a>01078         <span class="keywordflow">if</span> (rc &gt; <span class="keyword">sizeof</span>(BOOTP) - <span class="keyword">sizeof</span>(bp-&gt;bp_options) + 5) {
<a name="l01079"></a>01079             <span class="comment">/* The message must be a BOOTP reply with the expected XID. */</span>
<a name="l01080"></a>01080             <span class="keywordflow">if</span> (bp-&gt;bp_op == 2 &amp;&amp; bp-&gt;bp_xid == xid) {
<a name="l01081"></a>01081                 <span class="comment">/* Message is acceptable. */</span>
<a name="l01082"></a>01082                 <span class="keywordflow">break</span>;
<a name="l01083"></a>01083             }
<a name="l01084"></a>01084         }
<a name="l01085"></a>01085         <span class="comment">/* Calculate the remaining timeout for not getting trapped here </span>
<a name="l01086"></a>01086 <span class="comment">           on a busy network, which regularly broadcasts DHCP messages. */</span>
<a name="l01087"></a>01087         wtim = <a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() - etim;
<a name="l01088"></a>01088         <span class="keywordflow">if</span> (wtim &gt;= tmo - 250) {
<a name="l01089"></a>01089             <span class="comment">/* Less than 250 ms left, return timeout. */</span>
<a name="l01090"></a>01090             rc = 0;
<a name="l01091"></a>01091             <span class="keywordflow">break</span>;
<a name="l01092"></a>01092         }
<a name="l01093"></a>01093         wtim = tmo - wtim;
<a name="l01094"></a>01094     }
<a name="l01095"></a>01095     <span class="keywordflow">return</span> rc;
<a name="l01096"></a>01096 }
<a name="l01097"></a>01097 
<a name="l01112"></a>01112 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpBroadcastDiscover(UDPSOCKET * sock, BOOTP *bp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> raddr, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l01113"></a>01113 {
<a name="l01114"></a>01114     <span class="keywordtype">size_t</span> optlen;
<a name="l01115"></a>01115     <span class="keywordtype">int</span> len;
<a name="l01116"></a>01116     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;bp_options;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#g368aca81d0a71853aa3939f546cc25ae" title="Client broadcast to locate available servers.">DHCP_DISCOVER</a>, xid, 0, secs);
<a name="l01119"></a>01119 
<a name="l01120"></a>01120     <span class="comment">/* Request a specific IP if one had been assigned previously. */</span>
<a name="l01121"></a>01121     <span class="keywordflow">if</span> (raddr) {
<a name="l01122"></a>01122         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#g9c2fb45faa505750ea030d53c9358461" title="DHCP requested IP address option.">DHCPOPT_REQESTIP</a>, &amp;raddr, <span class="keyword">sizeof</span>(raddr));
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     optlen += DhcpAddParmReqOption(op + optlen);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127     <span class="comment">/* Pass host name if specified in confos structure.  </span>
<a name="l01128"></a>01128 <span class="comment">     * Win2k DHCP server can register this as dynamic DNS entry.</span>
<a name="l01129"></a>01129 <span class="comment">     * Also viewing DHCP lease table shows something sensible.</span>
<a name="l01130"></a>01130 <span class="comment">     */</span>
<a name="l01131"></a>01131     len = <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(<a class="code" href="group__xg_conf_os.html#ge98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.hostname);
<a name="l01132"></a>01132     <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l01133"></a>01133         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gfeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>, <a class="code" href="group__xg_conf_os.html#ge98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.hostname, len);
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="comment">/* Request a maximum message size. */</span>
<a name="l01137"></a>01137     optlen += DhcpAddShortOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#g2c7a6575a0b44e10eaef28472a0daa01" title="Maximum DHCP message size option.">DHCPOPT_MAXMSGSIZE</a>, <a class="code" href="group__xg_d_h_c_p_c.html#gd3f666f92061936c7d8be6c00cbf9cd0" title="Maximum DHCP message size we can accept.">MAX_DHCP_MSGSIZE</a>);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     <span class="keywordflow">return</span> DhcpSendMessage(sock, <a class="code" href="in_8h.html#4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>, bp, optlen);
<a name="l01140"></a>01140 }
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 
<a name="l01162"></a>01162 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendRequest(UDPSOCKET * sock, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> daddr, BOOTP *bp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid,        <span class="comment">/* */</span>
<a name="l01163"></a>01163                            <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> caddr, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> raddr, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> sid, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l01164"></a>01164 {
<a name="l01165"></a>01165     <span class="keywordtype">size_t</span> optlen;
<a name="l01166"></a>01166     <span class="keywordtype">int</span> len;
<a name="l01167"></a>01167     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;bp_options;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="comment">/* Initialize the BOOTP header. */</span>
<a name="l01170"></a>01170     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#g98a346c53c91848070fd980a98fa77d1" title="Client message to servers.">DHCP_REQUEST</a>, xid, caddr, secs);
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="comment">/* Add specified options. */</span>
<a name="l01173"></a>01173     <span class="keywordflow">if</span> (raddr) {
<a name="l01174"></a>01174         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#g9c2fb45faa505750ea030d53c9358461" title="DHCP requested IP address option.">DHCPOPT_REQESTIP</a>, &amp;raddr, <span class="keyword">sizeof</span>(raddr));
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176     <span class="keywordflow">if</span> (sid) {
<a name="l01177"></a>01177         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gded839fd1ad6d43e60374db9e13cab34" title="DHCP server identifier option.">DHCPOPT_SID</a>, &amp;sid, <span class="keyword">sizeof</span>(sid));
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179     optlen += DhcpAddParmReqOption(op + optlen);
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="comment">/* Pass host name if specified in confos structure.  */</span>
<a name="l01182"></a>01182     <span class="comment">/* viewing DHCP lease table shows something sensible. */</span>
<a name="l01183"></a>01183     len = <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(<a class="code" href="group__xg_conf_os.html#ge98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.hostname);
<a name="l01184"></a>01184     <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l01185"></a>01185         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gfeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>, <a class="code" href="group__xg_conf_os.html#ge98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.hostname, len);
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     <span class="keywordflow">return</span> DhcpSendMessage(sock, daddr, bp, optlen);
<a name="l01189"></a>01189 }
<a name="l01190"></a>01190 
<a name="l01209"></a>01209 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpBroadcastRequest(UDPSOCKET * sock, BOOTP *bp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid, <span class="comment">/* */</span>
<a name="l01210"></a>01210                                 <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> caddr, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> raddr, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> sid, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l01211"></a>01211 {
<a name="l01212"></a>01212     <span class="keywordflow">return</span> DhcpSendRequest(sock, <a class="code" href="in_8h.html#4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>, bp, xid, caddr, raddr, sid, secs);
<a name="l01213"></a>01213 }
<a name="l01214"></a>01214 
<a name="l01230"></a>01230 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendRelease(UDPSOCKET * sock, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> daddr, BOOTP *bp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> caddr, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> sid)
<a name="l01231"></a>01231 {
<a name="l01232"></a>01232     <span class="keywordtype">size_t</span> optlen;
<a name="l01233"></a>01233     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;bp_options;
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="comment">/* Prepare BOOTP header. 'secs' is set to zero. */</span>
<a name="l01236"></a>01236     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#ge629d2dc5df40f03ea87cc94a5e3f3eb" title="Client to server relinquishing network address and cancelling remaining lease.">DHCP_RELEASE</a>, xid, caddr, 0);
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     <span class="comment">/* Optionally add server identifier. */</span>
<a name="l01239"></a>01239     <span class="keywordflow">if</span> (sid) {
<a name="l01240"></a>01240         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gded839fd1ad6d43e60374db9e13cab34" title="DHCP server identifier option.">DHCPOPT_SID</a>, &amp;sid, <span class="keyword">sizeof</span>(sid));
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242     <span class="keywordflow">return</span> DhcpSendMessage(sock, daddr, bp, optlen);
<a name="l01243"></a>01243 }
<a name="l01244"></a>01244 
<a name="l01257"></a>01257 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendInform(UDPSOCKET * sock, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> daddr, BOOTP *bp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> caddr)
<a name="l01258"></a>01258 {
<a name="l01259"></a>01259     <span class="keywordtype">size_t</span> optlen;
<a name="l01260"></a>01260     <span class="keywordtype">size_t</span> len;
<a name="l01261"></a>01261     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;bp_options;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263     <span class="comment">/* Prepare BOOTP header. 'secs' is set to zero. */</span>
<a name="l01264"></a>01264     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#gaea6a969c0da81c2611885514bbe433f" title="Client to server, asking only for local configuration parameters.">DHCP_INFORM</a>, xid, caddr, 0);
<a name="l01265"></a>01265 
<a name="l01266"></a>01266     <span class="comment">/* Additional options we want. */</span>
<a name="l01267"></a>01267     optlen += DhcpAddParmReqOption(op + optlen);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269     <span class="comment">/* Add our configured host name. */</span>
<a name="l01270"></a>01270     len = <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(<a class="code" href="group__xg_conf_os.html#ge98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.hostname);
<a name="l01271"></a>01271     <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l01272"></a>01272         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gfeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>, <a class="code" href="group__xg_conf_os.html#ge98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.hostname, len);
<a name="l01273"></a>01273     }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275     <span class="comment">/* We should provide the maximum message size. */</span>
<a name="l01276"></a>01276     optlen += DhcpAddShortOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#g2c7a6575a0b44e10eaef28472a0daa01" title="Maximum DHCP message size option.">DHCPOPT_MAXMSGSIZE</a>, <a class="code" href="group__xg_d_h_c_p_c.html#gd3f666f92061936c7d8be6c00cbf9cd0" title="Maximum DHCP message size we can accept.">MAX_DHCP_MSGSIZE</a>);
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <span class="keywordflow">return</span> DhcpSendMessage(sock, daddr, bp, optlen);
<a name="l01279"></a>01279 }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281 
<a name="l01292"></a>01292 <span class="keyword">static</span> DYNCFG *CheckOffer(DYNCFG * dyncfg, BOOTP *bp, <span class="keywordtype">size_t</span> len)
<a name="l01293"></a>01293 {
<a name="l01294"></a>01294     DYNCFG *offer;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296     <span class="comment">/* Parse the new offer. If it's invalid, return the current </span>
<a name="l01297"></a>01297 <span class="comment">       configuration. */</span>
<a name="l01298"></a>01298     <span class="keywordflow">if</span> ((offer = ParseReply(bp, len)) == 0) {
<a name="l01299"></a>01299         <span class="keywordflow">return</span> dyncfg;
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302     <span class="comment">/* Discard anything which is not an offer. */</span>
<a name="l01303"></a>01303     <span class="keywordflow">if</span> (offer-&gt;dyn_msgtyp != <a class="code" href="group__xg_d_h_c_p_c.html#g4649df4abbae20e28fe422d09decd450" title="Server to client in response to DHCP_DISCOVER.">DHCP_OFFER</a>) {
<a name="l01304"></a>01304         ReleaseDynCfg(offer);
<a name="l01305"></a>01305         <span class="keywordflow">return</span> dyncfg;
<a name="l01306"></a>01306     }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     <span class="comment">/* First offer, take it. */</span>
<a name="l01309"></a>01309     <span class="keywordflow">if</span> (dyncfg == 0) {
<a name="l01310"></a>01310         dyncfg = offer;
<a name="l01311"></a>01311     }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313     <span class="comment">/* </span>
<a name="l01314"></a>01314 <span class="comment">     * Check if the new offer is better than the current configuration:</span>
<a name="l01315"></a>01315 <span class="comment">     */</span>
<a name="l01316"></a>01316     <span class="keywordflow">else</span> {
<a name="l01317"></a>01317         <span class="comment">/* If we remember a previously allocated IP which isn't in the</span>
<a name="l01318"></a>01318 <span class="comment">           current configuration but in the new offer, then let's take </span>
<a name="l01319"></a>01319 <span class="comment">           the new one. */</span>
<a name="l01320"></a>01320         <span class="keywordflow">if</span> (<a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr &amp; <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_mask) {
<a name="l01321"></a>01321             <span class="keywordflow">if</span> (dyncfg-&gt;dyn_yiaddr != <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr &amp;&amp;    <span class="comment">/* */</span>
<a name="l01322"></a>01322                 offer-&gt;dyn_yiaddr == <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr) {
<a name="l01323"></a>01323                 ReleaseDynCfg(dyncfg);
<a name="l01324"></a>01324                 dyncfg = offer;
<a name="l01325"></a>01325             }
<a name="l01326"></a>01326         }
<a name="l01327"></a>01327         <span class="comment">/* In the second place prefer long lease times. */</span>
<a name="l01328"></a>01328         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (offer-&gt;dyn_leaseTime &gt; dyncfg-&gt;dyn_leaseTime) {
<a name="l01329"></a>01329             ReleaseDynCfg(dyncfg);
<a name="l01330"></a>01330             dyncfg = offer;
<a name="l01331"></a>01331         }
<a name="l01332"></a>01332         <span class="comment">/* The new one deosn't offer anything interesting. Discard it. */</span>
<a name="l01333"></a>01333         <span class="keywordflow">else</span> {
<a name="l01334"></a>01334             ReleaseDynCfg(offer);
<a name="l01335"></a>01335         }
<a name="l01336"></a>01336     }
<a name="l01337"></a>01337     <span class="keywordflow">return</span> dyncfg;
<a name="l01338"></a>01338 }
<a name="l01339"></a>01339 
<a name="l01353"></a><a class="code" href="group__xg_d_h_c_p_c.html#gec068ced6e47d6a29ba229b256b16628">01353</a> <a class="code" href="thread_8h.html#9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a class="code" href="group__xg_d_h_c_p_c.html#gec068ced6e47d6a29ba229b256b16628" title="DHCP client thread.">NutDhcpClient</a>, arg)
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355     DYNCFG *reply = 0;
<a name="l01356"></a>01356     UDPSOCKET *sock = 0;
<a name="l01357"></a>01357     BOOTP *bp = 0;
<a name="l01358"></a>01358     <span class="keywordtype">int</span> n;
<a name="l01359"></a>01359     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> xid;
<a name="l01360"></a>01360     IFNET *nif;
<a name="l01361"></a>01361     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs = 0;
<a name="l01362"></a>01362     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> aqsTime = <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>();
<a name="l01363"></a>01363     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> leaseTime = 0;
<a name="l01364"></a>01364     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> napTime;
<a name="l01365"></a>01365     <a class="code" href="nut__types_8h.html#e15262a08334eeeacd9a24f219a89d46" title="Unsigned register type.">ureg_t</a> retries;
<a name="l01366"></a>01366     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> tmo = <a class="code" href="group__xg_d_h_c_p_c.html#g4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>;
<a name="l01367"></a>01367     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> last_ip = <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr;
<a name="l01368"></a>01368     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> server_ip;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     <span class="comment">/*</span>
<a name="l01371"></a>01371 <span class="comment">     * Hack alert: Our ARM port doesn't allow parameter</span>
<a name="l01372"></a>01372 <span class="comment">     * passing to threads.</span>
<a name="l01373"></a>01373 <span class="comment">     */</span>
<a name="l01374"></a>01374 <span class="preprocessor">#ifdef __arm__</span>
<a name="l01375"></a>01375 <span class="preprocessor"></span>    nif = dhcpDev-&gt;dev_icb;
<a name="l01376"></a>01376 <span class="preprocessor">#else</span>
<a name="l01377"></a>01377 <span class="preprocessor"></span>    nif = ((NUTDEVICE *) arg)-&gt;dev_icb;
<a name="l01378"></a>01378 <span class="preprocessor">#endif</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>
<a name="l01380"></a>01380     <span class="comment">/* </span>
<a name="l01381"></a>01381 <span class="comment">     * Generate a random transaction identifier based on our MAC </span>
<a name="l01382"></a>01382 <span class="comment">     * address with the least significant byte of the MAC address </span>
<a name="l01383"></a>01383 <span class="comment">     * becoming the most significant byte of the identifier. This </span>
<a name="l01384"></a>01384 <span class="comment">     * should give a sufficient unique value when several Ethernuts </span>
<a name="l01385"></a>01385 <span class="comment">     * are started concurrently. </span>
<a name="l01386"></a>01386 <span class="comment">     */</span>
<a name="l01387"></a>01387     xid = 0;
<a name="l01388"></a>01388     <span class="keywordflow">for</span> (retries = 0; retries &lt; <span class="keyword">sizeof</span>(xid); retries++) {
<a name="l01389"></a>01389         xid &lt;&lt;= 8;
<a name="l01390"></a>01390         xid += nif-&gt;if_mac[5 - retries];
<a name="l01391"></a>01391     }
<a name="l01392"></a>01392     retries = 0;
<a name="l01393"></a>01393 
<a name="l01394"></a>01394     <span class="keywordflow">for</span> (;;) {
<a name="l01395"></a>01395 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01396"></a>01396 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l01397"></a>01397             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"\n[%u.DHCP-"</span>, retries + 1);
<a name="l01398"></a>01398             <span class="keywordflow">switch</span> (dhcpState) {
<a name="l01399"></a>01399             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>:
<a name="l01400"></a>01400                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"INIT]"</span>);
<a name="l01401"></a>01401                 <span class="keywordflow">break</span>;
<a name="l01402"></a>01402             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>:
<a name="l01403"></a>01403                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"SELECTING]"</span>);
<a name="l01404"></a>01404                 <span class="keywordflow">break</span>;
<a name="l01405"></a>01405             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>:
<a name="l01406"></a>01406                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"REQUESTING]"</span>);
<a name="l01407"></a>01407                 <span class="keywordflow">break</span>;
<a name="l01408"></a>01408             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#gf62a09c8a9ec624a01d4a250b429416e" title="DHCP state: Rebooting.">DHCPST_REBOOTING</a>:
<a name="l01409"></a>01409                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"REBOOTING %s]"</span>, <a class="code" href="group__xg_i_p.html#g9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(last_ip));
<a name="l01410"></a>01410                 <span class="keywordflow">break</span>;
<a name="l01411"></a>01411             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>:
<a name="l01412"></a>01412                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"BOUND %lu]"</span>, <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime);
<a name="l01413"></a>01413                 <span class="keywordflow">break</span>;
<a name="l01414"></a>01414             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>:
<a name="l01415"></a>01415                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"RENEWING %lu]"</span>, <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime);
<a name="l01416"></a>01416                 <span class="keywordflow">break</span>;
<a name="l01417"></a>01417             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>:
<a name="l01418"></a>01418                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"REBINDING %lu]"</span>, <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime);
<a name="l01419"></a>01419                 <span class="keywordflow">break</span>;
<a name="l01420"></a>01420             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g4abafabe4257cdd6afd733dd9a12bee7" title="DHCP state: Informing.">DHCPST_INFORMING</a>:
<a name="l01421"></a>01421                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"INFORMING]"</span>);
<a name="l01422"></a>01422                 <span class="keywordflow">break</span>;
<a name="l01423"></a>01423             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g512ac4affb0ba009424b5a46b5216c08" title="DHCP state: Releasing.">DHCPST_RELEASING</a>:
<a name="l01424"></a>01424                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"RELEASING]"</span>);
<a name="l01425"></a>01425                 <span class="keywordflow">break</span>;
<a name="l01426"></a>01426             <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>:
<a name="l01427"></a>01427                 <span class="keywordflow">if</span> (dhcpError) {
<a name="l01428"></a>01428                     <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"ERROR %u]"</span>, dhcpError);
<a name="l01429"></a>01429                 } <span class="keywordflow">else</span> {
<a name="l01430"></a>01430                     <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"IDLE]"</span>);
<a name="l01431"></a>01431                 }
<a name="l01432"></a>01432                 <span class="keywordflow">break</span>;
<a name="l01433"></a>01433             <span class="keywordflow">default</span>:
<a name="l01434"></a>01434                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"UNKNOWN %u]"</span>, dhcpState);
<a name="l01435"></a>01435                 <span class="keywordflow">break</span>;
<a name="l01436"></a>01436             }
<a name="l01437"></a>01437         }
<a name="l01438"></a>01438 <span class="preprocessor">#endif</span>
<a name="l01439"></a>01439 <span class="preprocessor"></span>
<a name="l01440"></a>01440         <span class="comment">/*</span>
<a name="l01441"></a>01441 <span class="comment">         * Setup some values based on the number of retry attempts.</span>
<a name="l01442"></a>01442 <span class="comment">         */</span>
<a name="l01443"></a>01443         server_ip = <a class="code" href="in_8h.html#4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>;   <span class="comment">/* Broadcasting is default. */</span>
<a name="l01444"></a>01444         <span class="keywordflow">if</span> (retries) {
<a name="l01445"></a>01445             <span class="comment">/* Double our timeout on each retry. */</span>
<a name="l01446"></a>01446             tmo += tmo;
<a name="l01447"></a>01447             <span class="keywordflow">if</span> (tmo &gt; <a class="code" href="group__xg_d_h_c_p_c.html#gcd76719c532ca403fc624016fd56ade3" title="Maximum number of milliseconds to wait for a response.">MAX_DHCP_WAIT</a>) {
<a name="l01448"></a>01448                 tmo = <a class="code" href="group__xg_d_h_c_p_c.html#gcd76719c532ca403fc624016fd56ade3" title="Maximum number of milliseconds to wait for a response.">MAX_DHCP_WAIT</a>;
<a name="l01449"></a>01449             }
<a name="l01450"></a>01450         } <span class="keywordflow">else</span> {
<a name="l01451"></a>01451             <span class="comment">/* Start with minimum timeout first. */</span>
<a name="l01452"></a>01452             tmo = <a class="code" href="group__xg_d_h_c_p_c.html#g4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>;
<a name="l01453"></a>01453             <span class="comment">/* Use a new xid for the first message in each state except </span>
<a name="l01454"></a>01454 <span class="comment">             * when requesting, where we should continue using the xid </span>
<a name="l01455"></a>01455 <span class="comment">             * from the offer message we received.</span>
<a name="l01456"></a>01456 <span class="comment">             */</span>
<a name="l01457"></a>01457             <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#g838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>) {
<a name="l01458"></a>01458                 xid++;
<a name="l01459"></a>01459             }
<a name="l01460"></a>01460 
<a name="l01461"></a>01461             <span class="comment">/* If we know the server's IP, try to unicast on the first </span>
<a name="l01462"></a>01462 <span class="comment">               attempt. */</span>
<a name="l01463"></a>01463             <span class="keywordflow">if</span> (dhcpConfig &amp;&amp; dhcpConfig-&gt;dyn_sid) {
<a name="l01464"></a>01464                 server_ip = dhcpConfig-&gt;dyn_sid;
<a name="l01465"></a>01465             }
<a name="l01466"></a>01466         }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468         <span class="comment">/*</span>
<a name="l01469"></a>01469 <span class="comment">         * Keep track of the API timeout.</span>
<a name="l01470"></a>01470 <span class="comment">         */</span>
<a name="l01471"></a>01471         <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a> &amp;&amp; dhcpApiTimeout != <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>) {
<a name="l01472"></a>01472             <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> tt = <a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() - dhcpApiStart;
<a name="l01473"></a>01473 
<a name="l01474"></a>01474             <span class="keywordflow">if</span> (dhcpApiTimeout &lt;= tt) {
<a name="l01475"></a>01475                 dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gb48de5519f2f998b14e321e092e71008" title="DHCP timeout error.">DHCPERR_TIMEOUT</a>;
<a name="l01476"></a>01476                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01477"></a>01477                 <span class="keywordflow">continue</span>;
<a name="l01478"></a>01478             }
<a name="l01479"></a>01479             <span class="keywordflow">if</span> ((tt = dhcpApiTimeout - tt) &lt; tmo) {
<a name="l01480"></a>01480                 tmo = tt;
<a name="l01481"></a>01481             }
<a name="l01482"></a>01482         }
<a name="l01483"></a>01483 
<a name="l01484"></a>01484         <span class="comment">/*</span>
<a name="l01485"></a>01485 <span class="comment">         * Keep track of acquisition time.</span>
<a name="l01486"></a>01486 <span class="comment">         */</span>
<a name="l01487"></a>01487         <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a> || dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a> || dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>) {
<a name="l01488"></a>01488             <span class="comment">/* For retries make sure that secs doesn't overflow. */</span>
<a name="l01489"></a>01489             <span class="keywordflow">if</span> (retries) {
<a name="l01490"></a>01490                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - aqsTime &gt; 0xffffUL) {
<a name="l01491"></a>01491                     secs = 0xffff;
<a name="l01492"></a>01492                 } <span class="keywordflow">else</span> {
<a name="l01493"></a>01493                     secs = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) (<a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - aqsTime);
<a name="l01494"></a>01494                 }
<a name="l01495"></a>01495             }
<a name="l01496"></a>01496             <span class="comment">/* For first transmissions make sure that secs is zero. */</span>
<a name="l01497"></a>01497             <span class="keywordflow">else</span> {
<a name="l01498"></a>01498                 aqsTime = <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>();
<a name="l01499"></a>01499                 secs = 0;
<a name="l01500"></a>01500             }
<a name="l01501"></a>01501         }
<a name="l01502"></a>01502 
<a name="l01503"></a>01503         <span class="comment">/*</span>
<a name="l01504"></a>01504 <span class="comment">         * Release UDP socket and buffer in states with long inactive time.</span>
<a name="l01505"></a>01505 <span class="comment">         */</span>
<a name="l01506"></a>01506         <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a> || dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>) {
<a name="l01507"></a>01507             <span class="keywordflow">if</span> (sock) {
<a name="l01508"></a>01508                 <a class="code" href="group__xg_udp_socket.html#g73efaff2acbe9b93f6a27a643471ef63" title="Close UDP socket.">NutUdpDestroySocket</a>(sock);
<a name="l01509"></a>01509                 sock = 0;
<a name="l01510"></a>01510             }
<a name="l01511"></a>01511             <span class="keywordflow">if</span> (bp) {
<a name="l01512"></a>01512                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(bp);
<a name="l01513"></a>01513                 bp = 0;
<a name="l01514"></a>01514             }
<a name="l01515"></a>01515         }
<a name="l01516"></a>01516 
<a name="l01517"></a>01517         <span class="comment">/*</span>
<a name="l01518"></a>01518 <span class="comment">         * In all other states we need the socket and the buffer.</span>
<a name="l01519"></a>01519 <span class="comment">         */</span>
<a name="l01520"></a>01520         <span class="keywordflow">else</span> {
<a name="l01521"></a>01521             <span class="comment">/*</span>
<a name="l01522"></a>01522 <span class="comment">             * Check if something else configured our interface.</span>
<a name="l01523"></a>01523 <span class="comment">             */</span>
<a name="l01524"></a>01524             <span class="keywordflow">if</span> (dhcpConfig == 0 &amp;&amp; nif-&gt;if_local_ip) {
<a name="l01525"></a>01525                 <span class="comment">/* If we need additional configuration, we can sent</span>
<a name="l01526"></a>01526 <span class="comment">                   a DHCP Inform message here. */</span>
<a name="l01527"></a>01527                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01528"></a>01528                 <span class="keywordflow">continue</span>;
<a name="l01529"></a>01529             }
<a name="l01530"></a>01530 
<a name="l01531"></a>01531             <span class="keywordflow">if</span> (sock == 0 || bp == 0) {
<a name="l01532"></a>01532                 <span class="keywordflow">if</span> (sock == 0) {
<a name="l01533"></a>01533                     sock = <a class="code" href="group__xg_udp_socket.html#ge3f0a4c71eecf9a01920852dd0f0592d" title="Create a UDP socket.">NutUdpCreateSocket</a>(<a class="code" href="group__xg_d_h_c_p_c.html#g79a9a113fa47629510b6d5dd6fef9f83" title="UDP port of DHCP client.">DHCP_CLIENTPORT</a>);
<a name="l01534"></a>01534                 }
<a name="l01535"></a>01535                 <span class="keywordflow">if</span> (bp == 0) {
<a name="l01536"></a>01536                     bp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(BOOTP));
<a name="l01537"></a>01537                 }
<a name="l01538"></a>01538                 <span class="keywordflow">if</span> (sock == 0 || bp == 0) {
<a name="l01539"></a>01539                     <span class="comment">/* Looks like we are out of memory. */</span>
<a name="l01540"></a>01540                     dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#g8a82e5f1081e5d941e848d4a0a6debd5" title="DHCP system error.">DHCPERR_SYSTEM</a>;
<a name="l01541"></a>01541                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01542"></a>01542                     <span class="comment">/* At this point either socket or buffer may be allocated. </span>
<a name="l01543"></a>01543 <span class="comment">                       Thus we need to jump back to the top of our state loop</span>
<a name="l01544"></a>01544 <span class="comment">                       to release it. */</span>
<a name="l01545"></a>01545                     <span class="keywordflow">continue</span>;
<a name="l01546"></a>01546                 }
<a name="l01547"></a>01547 <span class="preprocessor">#if MAX_DHCP_BUFSIZE</span>
<a name="l01548"></a>01548 <span class="preprocessor"></span>                {
<a name="l01549"></a>01549                     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> max_ms = <a class="code" href="group__xg_d_h_c_p_c.html#g800db42c93d35caa64eb2b0d6f492731" title="Maximum UDP buffer size used by the DHCP client.">MAX_DHCP_BUFSIZE</a>;
<a name="l01550"></a>01550                     <a class="code" href="group__xg_udp_socket.html#g2051b9300c656a4e01b964d054f0a9ec" title="Set value of a UDP socket option.">NutUdpSetSockOpt</a>(sock, <a class="code" href="socket_8h.html#0db12e960ac303030400d9fd95391b52" title="Receive buffer size.">SO_RCVBUF</a>, &amp;max_ms, <span class="keyword">sizeof</span>(max_ms));
<a name="l01551"></a>01551                 }
<a name="l01552"></a>01552 <span class="preprocessor">#endif</span>
<a name="l01553"></a>01553 <span class="preprocessor"></span>            }
<a name="l01554"></a>01554         }
<a name="l01555"></a>01555 
<a name="l01556"></a>01556         <span class="comment">/*</span>
<a name="l01557"></a>01557 <span class="comment">         * (Re)Start.</span>
<a name="l01558"></a>01558 <span class="comment">         */</span>
<a name="l01559"></a>01559         <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>) {
<a name="l01560"></a>01560             <span class="comment">/* Clear the retry counter. */</span>
<a name="l01561"></a>01561             retries = 0;
<a name="l01562"></a>01562             <span class="comment">/* Use a new XID on each attempt. */</span>
<a name="l01563"></a>01563             xid++;
<a name="l01564"></a>01564             <span class="comment">/* Determine whether this is an initial boot or a reboot. */</span>
<a name="l01565"></a>01565             <span class="keywordflow">if</span> ((last_ip &amp; <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_mask) == 0) {
<a name="l01566"></a>01566                 <span class="comment">/* No previous IP, start from ground up. */</span>
<a name="l01567"></a>01567                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>;
<a name="l01568"></a>01568             } <span class="keywordflow">else</span> {
<a name="l01569"></a>01569                 <span class="comment">/* We got a previously allocated IP configuration from</span>
<a name="l01570"></a>01570 <span class="comment">                 * non-volatile configuration memory. Try to re-use it. */</span>
<a name="l01571"></a>01571                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gf62a09c8a9ec624a01d4a250b429416e" title="DHCP state: Rebooting.">DHCPST_REBOOTING</a>;
<a name="l01572"></a>01572             }
<a name="l01573"></a>01573         }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575         <span class="comment">/*</span>
<a name="l01576"></a>01576 <span class="comment">         * Broadcast discover and collect incoming offers.</span>
<a name="l01577"></a>01577 <span class="comment">         */</span>
<a name="l01578"></a>01578         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>) {
<a name="l01579"></a>01579             <span class="keywordflow">if</span> (retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#g0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01580"></a>01580                 <span class="comment">/* Too many retries while discovering DHCP. Give up. */</span>
<a name="l01581"></a>01581                 dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gb48de5519f2f998b14e321e092e71008" title="DHCP timeout error.">DHCPERR_TIMEOUT</a>;
<a name="l01582"></a>01582                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01583"></a>01583             }
<a name="l01584"></a>01584             <span class="comment">/* Send the discovering broadcast. */</span>
<a name="l01585"></a>01585             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastDiscover(sock, bp, xid, last_ip, secs) &lt; 0) {
<a name="l01586"></a>01586                 <span class="comment">/* Fatal transmit error on broadcast. */</span>
<a name="l01587"></a>01587                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01588"></a>01588             } <span class="keywordflow">else</span> {
<a name="l01589"></a>01589                 <span class="comment">/* Collect incoming offers. */</span>
<a name="l01590"></a>01590                 <span class="keywordflow">while</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &gt; 0) {
<a name="l01591"></a>01591                     <span class="comment">/* Check if this is a valid offer. */</span>
<a name="l01592"></a>01592                     <span class="keywordflow">if</span> ((dhcpConfig = CheckOffer(dhcpConfig, bp, n)) != 0) {
<a name="l01593"></a>01593                         <span class="comment">/* If the callers timeout is low, do not collect</span>
<a name="l01594"></a>01594 <span class="comment">                           more than one. Thanks to Jelle Kok. */</span>
<a name="l01595"></a>01595                         <span class="keywordflow">if</span> (dhcpApiTimeout &lt; <a class="code" href="group__xg_d_h_c_p_c.html#g4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a> * 3) {
<a name="l01596"></a>01596                             <span class="keywordflow">break</span>;
<a name="l01597"></a>01597                         }
<a name="l01598"></a>01598                         <span class="comment">/* Switch to lowest timeout after we received</span>
<a name="l01599"></a>01599 <span class="comment">                           a first response. */</span>
<a name="l01600"></a>01600                         tmo = <a class="code" href="group__xg_d_h_c_p_c.html#g4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>;
<a name="l01601"></a>01601                     }
<a name="l01602"></a>01602                 }
<a name="l01603"></a>01603                 <span class="comment">/* Change to ERROR state on fatal receive errors. */</span>
<a name="l01604"></a>01604                 <span class="keywordflow">if</span> (n &lt; 0) {
<a name="l01605"></a>01605                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01606"></a>01606                 }
<a name="l01607"></a>01607                 <span class="comment">/* Change to REQUESTING state if we got a valid offer.</span>
<a name="l01608"></a>01608 <span class="comment">                   Otherwise we stay in SELECTING state. */</span>
<a name="l01609"></a>01609                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpConfig) {
<a name="l01610"></a>01610                     retries = 0;
<a name="l01611"></a>01611                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>;
<a name="l01612"></a>01612                 }
<a name="l01613"></a>01613             }
<a name="l01614"></a>01614         }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616         <span class="comment">/*</span>
<a name="l01617"></a>01617 <span class="comment">         * Send request and wait for an acknowledge.</span>
<a name="l01618"></a>01618 <span class="comment">         */</span>
<a name="l01619"></a>01619         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>) {
<a name="l01620"></a>01620             <span class="keywordflow">if</span> (retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#g0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01621"></a>01621                 <span class="comment">/* Too many retries with this server, fall back to discovery. */</span>
<a name="l01622"></a>01622                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01623"></a>01623             }
<a name="l01624"></a>01624             <span class="comment">/* Request an offered configuration. According to RFC 2131 this</span>
<a name="l01625"></a>01625 <span class="comment">               has to be broadcasted. */</span>
<a name="l01626"></a>01626             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastRequest(sock, bp, xid, 0, dhcpConfig-&gt;dyn_yiaddr, dhcpConfig-&gt;dyn_sid, secs) &lt; 0) {
<a name="l01627"></a>01627                 <span class="comment">/* Fatal transmit error on broadcast. Give up. */</span>
<a name="l01628"></a>01628                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01629"></a>01629             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01630"></a>01630                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01631"></a>01631                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01632"></a>01632             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01633"></a>01633                 <span class="comment">/* The server accepted our request. We are bound. */</span>
<a name="l01634"></a>01634                 <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01635"></a>01635                     ReleaseDynCfg(dhcpConfig);
<a name="l01636"></a>01636                     dhcpConfig = reply;
<a name="l01637"></a>01637                     reply = 0;
<a name="l01638"></a>01638                     leaseTime = aqsTime;
<a name="l01639"></a>01639                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01640"></a>01640                 }
<a name="l01641"></a>01641                 <span class="comment">/* The server declines a previously offered configuration. </span>
<a name="l01642"></a>01642 <span class="comment">                   Restart discovery. */</span>
<a name="l01643"></a>01643                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221" title="Server to client indicating client&amp;#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01644"></a>01644                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01645"></a>01645                 }
<a name="l01646"></a>01646             }
<a name="l01647"></a>01647         }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649         <span class="comment">/*</span>
<a name="l01650"></a>01650 <span class="comment">         * Reusing a previously allocated network address after reboot.</span>
<a name="l01651"></a>01651 <span class="comment">         */</span>
<a name="l01652"></a>01652         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#gf62a09c8a9ec624a01d4a250b429416e" title="DHCP state: Rebooting.">DHCPST_REBOOTING</a>) {
<a name="l01653"></a>01653             <span class="keywordflow">if</span> (++retries &gt; <a class="code" href="group__xg_d_h_c_p_c.html#g0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01654"></a>01654                 <span class="comment">/* Too many retries, fall back to discovery. */</span>
<a name="l01655"></a>01655                 last_ip = 0;
<a name="l01656"></a>01656                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01657"></a>01657             }
<a name="l01658"></a>01658             <span class="comment">/* Broadcast a request for our previous configuration. */</span>
<a name="l01659"></a>01659             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastRequest(sock, bp, xid, 0, last_ip, 0, secs) &lt; 0) {
<a name="l01660"></a>01660                 <span class="comment">/* Fatal transmit error on broadcast. Give up. */</span>
<a name="l01661"></a>01661                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01662"></a>01662             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01663"></a>01663                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01664"></a>01664                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01665"></a>01665             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01666"></a>01666                 <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01667"></a>01667                     ReleaseDynCfg(dhcpConfig);
<a name="l01668"></a>01668                     dhcpConfig = reply;
<a name="l01669"></a>01669                     reply = 0;
<a name="l01670"></a>01670                     leaseTime = aqsTime;
<a name="l01671"></a>01671                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01672"></a>01672                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221" title="Server to client indicating client&amp;#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01673"></a>01673                     <span class="comment">/* Either our previous address had been allocated by</span>
<a name="l01674"></a>01674 <span class="comment">                       someone else or we changed the network. Remove the</span>
<a name="l01675"></a>01675 <span class="comment">                       previous address and restart. */</span>
<a name="l01676"></a>01676                     last_ip = 0;
<a name="l01677"></a>01677                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01678"></a>01678                 }
<a name="l01679"></a>01679             }
<a name="l01680"></a>01680         }
<a name="l01681"></a>01681 
<a name="l01682"></a>01682         <span class="comment">/*</span>
<a name="l01683"></a>01683 <span class="comment">         * Maintain lease time.</span>
<a name="l01684"></a>01684 <span class="comment">         */</span>
<a name="l01685"></a>01685         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) {
<a name="l01686"></a>01686             retries = 0;
<a name="l01687"></a>01687             <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;dhcpDone);
<a name="l01688"></a>01688             <span class="keywordflow">if</span> (dhcpConfig-&gt;dyn_renewalTime &lt;= <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) {
<a name="l01689"></a>01689                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>;
<a name="l01690"></a>01690             } <span class="keywordflow">else</span> {
<a name="l01691"></a>01691                 <span class="comment">/* Calculate the remaining lease time and take a nap. */</span>
<a name="l01692"></a>01692                 napTime = dhcpConfig-&gt;dyn_renewalTime - (<a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime);
<a name="l01693"></a>01693                 <span class="keywordflow">if</span> (napTime &gt; <a class="code" href="group__xg_d_h_c_p_c.html#g954acae12281d9d625376976442a5713" title="Maximum sleep time in seconds.">MAX_DHCP_NAPTIME</a>) {
<a name="l01694"></a>01694                     napTime = <a class="code" href="group__xg_d_h_c_p_c.html#g954acae12281d9d625376976442a5713" title="Maximum sleep time in seconds.">MAX_DHCP_NAPTIME</a>;
<a name="l01695"></a>01695                 }
<a name="l01696"></a>01696                 <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dhcpWake, napTime * 1000UL);
<a name="l01697"></a>01697             }
<a name="l01698"></a>01698         }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700         <span class="comment">/*</span>
<a name="l01701"></a>01701 <span class="comment">         * Waiting for an acknowledge of our renewal request.</span>
<a name="l01702"></a>01702 <span class="comment">         */</span>
<a name="l01703"></a>01703         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>) {
<a name="l01704"></a>01704             retries++;
<a name="l01705"></a>01705             <span class="keywordflow">if</span> (tmo / 1000 &gt; dhcpConfig-&gt;dyn_rebindTime - (<a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime)) {
<a name="l01706"></a>01706                 tmo = dhcpConfig-&gt;dyn_rebindTime - (<a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) * 1000;
<a name="l01707"></a>01707             }
<a name="l01708"></a>01708             <span class="keywordflow">if</span> (dhcpConfig-&gt;dyn_rebindTime &lt;= <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) {
<a name="l01709"></a>01709                 retries = 0;
<a name="l01710"></a>01710                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01711"></a>01711             }
<a name="l01712"></a>01712             <span class="comment">/* Send a request to our leasing server. We must not include</span>
<a name="l01713"></a>01713 <span class="comment">               the server identifier. */</span>
<a name="l01714"></a>01714             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpSendRequest(sock, dhcpConfig-&gt;dyn_sid, bp, xid, dhcpConfig-&gt;dyn_yiaddr, dhcpConfig-&gt;dyn_yiaddr, 0, secs) &lt;
<a name="l01715"></a>01715                      0) {
<a name="l01716"></a>01716                 <span class="comment">/* Unicast transmit error. */</span>
<a name="l01717"></a>01717                 retries = 0;
<a name="l01718"></a>01718                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01719"></a>01719             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01720"></a>01720                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01721"></a>01721                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01722"></a>01722             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01723"></a>01723                 <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01724"></a>01724                     <span class="comment">/* Got an acknowledge, return to bound state. */</span>
<a name="l01725"></a>01725                     ReleaseDynCfg(dhcpConfig);
<a name="l01726"></a>01726                     dhcpConfig = reply;
<a name="l01727"></a>01727                     reply = 0;
<a name="l01728"></a>01728                     leaseTime = aqsTime;
<a name="l01729"></a>01729                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01730"></a>01730                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221" title="Server to client indicating client&amp;#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01731"></a>01731                     <span class="comment">/* Unexpected NAK. */</span>
<a name="l01732"></a>01732                     retries = 0;
<a name="l01733"></a>01733                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01734"></a>01734                 }
<a name="l01735"></a>01735             }
<a name="l01736"></a>01736         }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738         <span class="comment">/*</span>
<a name="l01739"></a>01739 <span class="comment">         * Waiting for an acknowledge of our rebind request.</span>
<a name="l01740"></a>01740 <span class="comment">         */</span>
<a name="l01741"></a>01741         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>) {
<a name="l01742"></a>01742             retries++;
<a name="l01743"></a>01743             <span class="keywordflow">if</span> (tmo &gt; dhcpConfig-&gt;dyn_rebindTime - (<a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime)) {
<a name="l01744"></a>01744                 tmo = dhcpConfig-&gt;dyn_rebindTime - <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime;
<a name="l01745"></a>01745             }
<a name="l01746"></a>01746             <span class="keywordflow">if</span> (dhcpConfig-&gt;dyn_rebindTime &lt;= <a class="code" href="group__xg_timer.html#g8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) {
<a name="l01747"></a>01747                 retries = 0;
<a name="l01748"></a>01748                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01749"></a>01749             }
<a name="l01750"></a>01750             <span class="comment">/* Broadcast a request for our previous configuration. We </span>
<a name="l01751"></a>01751 <span class="comment">               must not include a server identifier. */</span>
<a name="l01752"></a>01752             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastRequest(sock, bp, xid, dhcpConfig-&gt;dyn_yiaddr, dhcpConfig-&gt;dyn_yiaddr, 0, secs) &lt; 0) {
<a name="l01753"></a>01753                 <span class="comment">/* Fatal transmit error on broadcast. Give up. */</span>
<a name="l01754"></a>01754                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01755"></a>01755             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01756"></a>01756                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01757"></a>01757                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01758"></a>01758             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01759"></a>01759                 <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01760"></a>01760                     <span class="comment">/* Got an acknowledge, return to bound state. */</span>
<a name="l01761"></a>01761                     ReleaseDynCfg(dhcpConfig);
<a name="l01762"></a>01762                     dhcpConfig = reply;
<a name="l01763"></a>01763                     reply = 0;
<a name="l01764"></a>01764                     leaseTime = aqsTime;
<a name="l01765"></a>01765                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01766"></a>01766                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221" title="Server to client indicating client&amp;#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01767"></a>01767                     <span class="comment">/*</span>
<a name="l01768"></a>01768 <span class="comment">                     * We have a problem here if the last DHCP server died. </span>
<a name="l01769"></a>01769 <span class="comment">                     * If a backup server exists, it may probe our IP address</span>
<a name="l01770"></a>01770 <span class="comment">                     * using ARP or ICMP. Our interface is up and responding,</span>
<a name="l01771"></a>01771 <span class="comment">                     * so the backup server may think that the IP address</span>
<a name="l01772"></a>01772 <span class="comment">                     * is in use and respond with NAK. Without shutting</span>
<a name="l01773"></a>01773 <span class="comment">                     * down our interface (not yet implemented) we are stuck.</span>
<a name="l01774"></a>01774 <span class="comment">                     * We switch to discovery state, but the problem remains.</span>
<a name="l01775"></a>01775 <span class="comment">                     */</span>
<a name="l01776"></a>01776                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01777"></a>01777                 }
<a name="l01778"></a>01778             }
<a name="l01779"></a>01779         }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781         <span class="comment">/*</span>
<a name="l01782"></a>01782 <span class="comment">         * Send an inform and wait for its (optional) echo.</span>
<a name="l01783"></a>01783 <span class="comment">         */</span>
<a name="l01784"></a>01784         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g4abafabe4257cdd6afd733dd9a12bee7" title="DHCP state: Informing.">DHCPST_INFORMING</a>) {
<a name="l01785"></a>01785             <span class="keywordflow">if</span> (retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#g0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01786"></a>01786                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01787"></a>01787             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpSendInform(sock, server_ip, bp, xid, nif-&gt;if_local_ip) &lt; 0) {
<a name="l01788"></a>01788                 <span class="keywordflow">if</span> (server_ip == <a class="code" href="in_8h.html#4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>) {
<a name="l01789"></a>01789                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01790"></a>01790                 }
<a name="l01791"></a>01791             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) != 0) {
<a name="l01792"></a>01792                 <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp;    <span class="comment">/* No receive error. */</span>
<a name="l01793"></a>01793                     (reply = ParseReply(bp, n)) != 0 &amp;&amp; <span class="comment">/* No parser error. */</span>
<a name="l01794"></a>01794                     reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {    <span class="comment">/* Acknowledged. */</span>
<a name="l01795"></a>01795                     <span class="comment">/* Take over this configuration. */</span>
<a name="l01796"></a>01796                     ReleaseDynCfg(dhcpConfig);
<a name="l01797"></a>01797                     dhcpConfig = reply;
<a name="l01798"></a>01798                     reply = 0;
<a name="l01799"></a>01799                 }
<a name="l01800"></a>01800                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01801"></a>01801             }
<a name="l01802"></a>01802         }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804         <span class="comment">/*</span>
<a name="l01805"></a>01805 <span class="comment">         * Send a release and wait for its (optional) echo.</span>
<a name="l01806"></a>01806 <span class="comment">         */</span>
<a name="l01807"></a>01807         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g512ac4affb0ba009424b5a46b5216c08" title="DHCP state: Releasing.">DHCPST_RELEASING</a>) {
<a name="l01808"></a>01808             <span class="keywordflow">if</span> (dhcpConfig == 0 ||      <span class="comment">/* Not configured. */</span>
<a name="l01809"></a>01809                 retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#gb9e5603e983fc563188a47a2397537d8" title="Maximum number of release retries.">MAX_DCHP_RELEASE_RETRIES</a> || <span class="comment">/* Too many retries. */</span>
<a name="l01810"></a>01810                 DhcpSendRelease(sock, server_ip, bp, xid, dhcpConfig-&gt;dyn_yiaddr, dhcpConfig-&gt;dyn_sid) &lt; 0) {
<a name="l01811"></a>01811                 <span class="keywordflow">if</span> (server_ip == <a class="code" href="in_8h.html#4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>) {
<a name="l01812"></a>01812                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01813"></a>01813                 }
<a name="l01814"></a>01814             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01815"></a>01815                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01816"></a>01816                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01817"></a>01817             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01818"></a>01818                 <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01819"></a>01819                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01820"></a>01820                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;dyn_msgtyp == <a class="code" href="group__xg_d_h_c_p_c.html#g12682fd5edb10129309f2046504d4221" title="Server to client indicating client&amp;#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01821"></a>01821                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01822"></a>01822                 }
<a name="l01823"></a>01823             }
<a name="l01824"></a>01824         }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826         <span class="comment">/*</span>
<a name="l01827"></a>01827 <span class="comment">         * We are done somehow. Either a fatal error occured or we </span>
<a name="l01828"></a>01828 <span class="comment">         * reached the specified timeout time or our lease has been</span>
<a name="l01829"></a>01829 <span class="comment">         * release or something else configured our interface.</span>
<a name="l01830"></a>01830 <span class="comment">         * Release all resources and wait for a new API call to</span>
<a name="l01831"></a>01831 <span class="comment">         * wake us up.</span>
<a name="l01832"></a>01832 <span class="comment">         */</span>
<a name="l01833"></a>01833         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>) {
<a name="l01834"></a>01834             ReleaseDynCfg(dhcpConfig);
<a name="l01835"></a>01835             dhcpConfig = 0;
<a name="l01836"></a>01836             retries = 0;
<a name="l01837"></a>01837             <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;dhcpDone);
<a name="l01838"></a>01838             <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dhcpWake, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l01839"></a>01839         }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841         <span class="comment">/* Release any received reply. */</span>
<a name="l01842"></a>01842         <span class="keywordflow">if</span> (reply) {
<a name="l01843"></a>01843             ReleaseDynCfg(reply);
<a name="l01844"></a>01844             reply = 0;
<a name="l01845"></a>01845         }
<a name="l01846"></a>01846     }
<a name="l01847"></a>01847 }
<a name="l01848"></a>01848 
<a name="l01863"></a>01863 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpKick(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> state, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l01864"></a>01864 {
<a name="l01865"></a>01865     NUTDEVICE *dev;
<a name="l01866"></a>01866     IFNET *nif;
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <span class="comment">/* Lookup the Ethernet device. */</span>
<a name="l01869"></a>01869     <span class="keywordflow">if</span> ((dev = <a class="code" href="group__xg_device.html#g913130771bea4118ae58e2a0ccb50a4d" title="Find device entry by name.">NutDeviceLookup</a>(name)) == 0 ||   <span class="comment">/* No device */</span>
<a name="l01870"></a>01870         dev-&gt;dev_type != <a class="code" href="group__xg_device.html#ga3f88c08759f21a3a876721fd184d0ba" title="Net device.">IFTYP_NET</a> ||   <span class="comment">/* Wrong type */</span>
<a name="l01871"></a>01871         (nif = dev-&gt;dev_icb) == 0 ||    <span class="comment">/* No netif */</span>
<a name="l01872"></a>01872         nif-&gt;if_type != <a class="code" href="if__types_8h.html#e4eb2208d7f67fefe11586dd32cb1bcc" title="Ethernet interface.">IFT_ETHER</a>) {    <span class="comment">/* Wrong if type */</span>
<a name="l01873"></a>01873         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#g0b7d014e36cbac1c1dd67d7e40ec06cd" title="DHCP error: Bad device.">DHCPERR_BADDEV</a>;
<a name="l01874"></a>01874         <span class="keywordflow">return</span> -1;
<a name="l01875"></a>01875     }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877     <span class="comment">/* Initialize timeout checking. */</span>
<a name="l01878"></a>01878     dhcpApiStart = <a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>();
<a name="l01879"></a>01879     dhcpApiTimeout = timeout;
<a name="l01880"></a>01880 
<a name="l01881"></a>01881     dhcpState = state;
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (dhcpThread == 0) {
<a name="l01883"></a>01883 <span class="preprocessor">#ifdef __arm__</span>
<a name="l01884"></a>01884 <span class="preprocessor"></span>        dhcpDev = dev;
<a name="l01885"></a>01885 <span class="preprocessor">#endif</span>
<a name="l01886"></a>01886 <span class="preprocessor"></span>        dhcpThread = <a class="code" href="group__xg_nut_arch_avr_os_context_gcc.html#g8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="stringliteral">"dhcpc"</span>, <a class="code" href="group__xg_d_h_c_p_c.html#gec068ced6e47d6a29ba229b256b16628" title="DHCP client thread.">NutDhcpClient</a>, dev, 
<a name="l01887"></a>01887             (<a class="code" href="group__xg_d_h_c_p_c.html#g2f3a479eff1da93bc057498174f94f78" title="Stack size of the DHCP client thread.">NUT_THREAD_DHCPSTACK</a> * <a class="code" href="thread_8h.html#829893ef9f0c6a5efc2559ed359c8592" title="Stack size factor.">NUT_THREAD_STACK_MULT</a>) + <a class="code" href="thread_8h.html#61adeb6c97cb1f740e729fbf33e9a15c" title="Stack size summand.">NUT_THREAD_STACK_ADD</a>);
<a name="l01888"></a>01888     }
<a name="l01889"></a>01889     <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dhcpWake);
<a name="l01890"></a>01890     <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dhcpDone, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <span class="keywordflow">return</span> 0;
<a name="l01893"></a>01893 }
<a name="l01894"></a>01894 
<a name="l01934"></a><a class="code" href="group__xg_d_h_c_p_c.html#g23fddfde13e6e0581258ac7f0fc1d025">01934</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#g23fddfde13e6e0581258ac7f0fc1d025" title="Automatically configure an Ethernet network interface.">NutDhcpIfConfig</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * mac, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l01935"></a>01935 {
<a name="l01936"></a>01936     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> mac0[6];
<a name="l01937"></a>01937     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> macF[6];
<a name="l01938"></a>01938     NUTDEVICE *dev;
<a name="l01939"></a>01939     IFNET *nif;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941     <span class="comment">/*</span>
<a name="l01942"></a>01942 <span class="comment">     * Lookup the Ethernet device.</span>
<a name="l01943"></a>01943 <span class="comment">     */</span>
<a name="l01944"></a>01944     <span class="keywordflow">if</span> ((dev = <a class="code" href="group__xg_device.html#g913130771bea4118ae58e2a0ccb50a4d" title="Find device entry by name.">NutDeviceLookup</a>(name)) == 0 ||   <span class="comment">/* No device */</span>
<a name="l01945"></a>01945         dev-&gt;dev_type != <a class="code" href="group__xg_device.html#ga3f88c08759f21a3a876721fd184d0ba" title="Net device.">IFTYP_NET</a> ||   <span class="comment">/* Wrong type */</span>
<a name="l01946"></a>01946         (nif = dev-&gt;dev_icb) == 0 ||    <span class="comment">/* No netif */</span>
<a name="l01947"></a>01947         nif-&gt;if_type != <a class="code" href="if__types_8h.html#e4eb2208d7f67fefe11586dd32cb1bcc" title="Ethernet interface.">IFT_ETHER</a>) {    <span class="comment">/* Wrong if type */</span>
<a name="l01948"></a>01948         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#g0b7d014e36cbac1c1dd67d7e40ec06cd" title="DHCP error: Bad device.">DHCPERR_BADDEV</a>;
<a name="l01949"></a>01949         <span class="keywordflow">return</span> -1;
<a name="l01950"></a>01950     }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952     <span class="comment">/*</span>
<a name="l01953"></a>01953 <span class="comment">     * We determine whether the interface is enabled by checking</span>
<a name="l01954"></a>01954 <span class="comment">     * the MAC address. This is so bloody brain dead.</span>
<a name="l01955"></a>01955 <span class="comment">     */</span>
<a name="l01956"></a>01956     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(mac0, 0x00, <span class="keyword">sizeof</span>(mac0));   <span class="comment">/* Uses more code but less RAM... */</span>
<a name="l01957"></a>01957     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(macF, 0xFF, <span class="keyword">sizeof</span>(macF));   <span class="comment">/* ...than init in declaration.   */</span>
<a name="l01958"></a>01958     <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#g135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(nif-&gt;if_mac, mac0, 6) == 0 || <a class="code" href="group__xg_crt_string.html#g135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(nif-&gt;if_mac, macF, 6) == 0) {
<a name="l01959"></a>01959         <span class="comment">/*</span>
<a name="l01960"></a>01960 <span class="comment">         * If the caller specified a MAC address, we use it and</span>
<a name="l01961"></a>01961 <span class="comment">         * overwrite the configuration.</span>
<a name="l01962"></a>01962 <span class="comment">         */</span>
<a name="l01963"></a>01963         <span class="keywordflow">if</span> (mac) {
<a name="l01964"></a>01964             <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(<a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_mac, mac, <span class="keyword">sizeof</span>(<a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_mac));
<a name="l01965"></a>01965         }
<a name="l01966"></a>01966 
<a name="l01967"></a>01967         <span class="comment">/*</span>
<a name="l01968"></a>01968 <span class="comment">         * If no MAC address has been specified, read the configuration </span>
<a name="l01969"></a>01969 <span class="comment">         * from EEPROM. If this fails, we do not continue any further,</span>
<a name="l01970"></a>01970 <span class="comment">         * but let the caller know that something is wrong. He may call</span>
<a name="l01971"></a>01971 <span class="comment">         * us again with a valid MAC address.</span>
<a name="l01972"></a>01972 <span class="comment">         */</span>
<a name="l01973"></a>01973         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__xg_conf_net.html#g1b658703cf61dd0152f312a59989bed0" title="Load network configuration from non-volatile memory.">NutNetLoadConfig</a>(name)) {
<a name="l01974"></a>01974             dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#g9fb8f0830e5a38a65177fd3f91d7d0ae" title="DHCP MAC error.">DHCPERR_NOMAC</a>;
<a name="l01975"></a>01975             <span class="keywordflow">return</span> -1;
<a name="l01976"></a>01976         }
<a name="l01977"></a>01977 
<a name="l01978"></a>01978         <span class="comment">/*</span>
<a name="l01979"></a>01979 <span class="comment">         * Copy the MAC address to the interface structure. This will</span>
<a name="l01980"></a>01980 <span class="comment">         * magically brain dead enable the interface.</span>
<a name="l01981"></a>01981 <span class="comment">         */</span>
<a name="l01982"></a>01982         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(nif-&gt;if_mac, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_mac, 6);
<a name="l01983"></a>01983         <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(500);
<a name="l01984"></a>01984     }
<a name="l01985"></a>01985 
<a name="l01986"></a>01986     <span class="comment">/*</span>
<a name="l01987"></a>01987 <span class="comment">     * If the EEPROM contains a fixed network configuration, we skip DHCP.</span>
<a name="l01988"></a>01988 <span class="comment">     */</span>
<a name="l01989"></a>01989     <span class="keywordflow">if</span> ((<a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_cip_addr &amp; <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_mask) != 0) {
<a name="l01990"></a>01990         <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr = <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_cip_addr;
<a name="l01991"></a>01991         <a class="code" href="group__xg_i_p.html#ga7092b805dccd43209f32ad437dc2a3f" title="Configure a network interface including the default gateway.">NutNetIfConfig2</a>(name, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_mac, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_mask, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_gateway);
<a name="l01992"></a>01992         <span class="keywordflow">return</span> 0;
<a name="l01993"></a>01993     }
<a name="l01994"></a>01994 
<a name="l01995"></a>01995     <span class="comment">/*</span>
<a name="l01996"></a>01996 <span class="comment">     * Start the DHCP thread if not running or wake it up. Pass the caller's </span>
<a name="l01997"></a>01997 <span class="comment">     * timeout to the thread and wait an infinite time. We rely on the thread </span>
<a name="l01998"></a>01998 <span class="comment">     * to wake us up on timeout.</span>
<a name="l01999"></a>01999 <span class="comment">     */</span>
<a name="l02000"></a>02000     <span class="keywordflow">if</span> (DhcpKick(name, <a class="code" href="group__xg_d_h_c_p_c.html#gb3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>, timeout) == 0) {
<a name="l02001"></a>02001         <span class="comment">/*</span>
<a name="l02002"></a>02002 <span class="comment">         * The thread finished its task. If it reached the bound state, then</span>
<a name="l02003"></a>02003 <span class="comment">         * we got a valid configuration from DHCP.</span>
<a name="l02004"></a>02004 <span class="comment">         */</span>
<a name="l02005"></a>02005         <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) {
<a name="l02006"></a>02006 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l02007"></a>02007 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l02008"></a>02008                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Config %s]"</span>, <a class="code" href="group__xg_i_p.html#g9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(dhcpConfig-&gt;dyn_yiaddr));
<a name="l02009"></a>02009             }
<a name="l02010"></a>02010 <span class="preprocessor">#endif</span>
<a name="l02011"></a>02011 <span class="preprocessor"></span>            <a class="code" href="group__xg_i_p.html#gbf73942328e57e1c1c72abe1f9e6e359" title="Network interface setup.">NutNetIfSetup</a>(dev, dhcpConfig-&gt;dyn_yiaddr, dhcpConfig-&gt;dyn_netmask, dhcpConfig-&gt;dyn_gateway);
<a name="l02012"></a>02012             <a class="code" href="group__xg_d_n_s.html#gdacc495d10d52d37fb9a9b567c1d715e" title="Set DNS configuration.">NutDnsConfig2</a>(0, 0, dhcpConfig-&gt;dyn_pdns, dhcpConfig-&gt;dyn_sdns);
<a name="l02013"></a>02013             <span class="keywordflow">return</span> 0;
<a name="l02014"></a>02014         }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016         <span class="comment">/*</span>
<a name="l02017"></a>02017 <span class="comment">         * Our interface has been configured externally, possibly by auto </span>
<a name="l02018"></a>02018 <span class="comment">         * ARP or a similar function implemented by the application.</span>
<a name="l02019"></a>02019 <span class="comment">         */</span>
<a name="l02020"></a>02020         <span class="keywordflow">if</span> (nif-&gt;if_local_ip) {
<a name="l02021"></a>02021 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l02022"></a>02022 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l02023"></a>02023                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-External %s]"</span>, <a class="code" href="group__xg_i_p.html#g9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(nif-&gt;if_local_ip));
<a name="l02024"></a>02024             }
<a name="l02025"></a>02025 <span class="preprocessor">#endif</span>
<a name="l02026"></a>02026 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02027"></a>02027         }
<a name="l02028"></a>02028 
<a name="l02029"></a>02029         <span class="comment">/*</span>
<a name="l02030"></a>02030 <span class="comment">         * DHCP failed. In case we remember a previously allocated address, </span>
<a name="l02031"></a>02031 <span class="comment">         * then let's use it.</span>
<a name="l02032"></a>02032 <span class="comment">         */</span>
<a name="l02033"></a>02033         <span class="keywordflow">if</span> ((<a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr &amp; <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_mask) != 0) {
<a name="l02034"></a>02034 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l02035"></a>02035 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l02036"></a>02036                 <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"[DHCP-Reusing %s]"</span>, <a class="code" href="group__xg_i_p.html#g9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(<a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr));
<a name="l02037"></a>02037             }
<a name="l02038"></a>02038 <span class="preprocessor">#endif</span>
<a name="l02039"></a>02039 <span class="preprocessor"></span>            <a class="code" href="group__xg_i_p.html#ga7092b805dccd43209f32ad437dc2a3f" title="Configure a network interface including the default gateway.">NutNetIfConfig2</a>(name, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_mac, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_addr, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_ip_mask, <a class="code" href="group__xg_conf_net.html#g7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.cdn_gateway);
<a name="l02040"></a>02040             <span class="keywordflow">return</span> 0;
<a name="l02041"></a>02041         }
<a name="l02042"></a>02042     }
<a name="l02043"></a>02043     <span class="keywordflow">return</span> -1;
<a name="l02044"></a>02044 }
<a name="l02045"></a>02045 
<a name="l02062"></a><a class="code" href="group__xg_d_h_c_p_c.html#g2efa947f8718bb11f6674cb3011aa520">02062</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#g2efa947f8718bb11f6674cb3011aa520" title="Relinguish our DHCP lease.">NutDhcpRelease</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l02063"></a>02063 {
<a name="l02064"></a>02064     <span class="comment">/* Check the state. */</span>
<a name="l02065"></a>02065     <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) {
<a name="l02066"></a>02066         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gba878e739d434e142fe34a96be7e2f5b" title="DHCP state error.">DHCPERR_STATE</a>;
<a name="l02067"></a>02067         <span class="keywordflow">return</span> -1;
<a name="l02068"></a>02068     }
<a name="l02069"></a>02069 
<a name="l02070"></a>02070     <span class="comment">/* Action! */</span>
<a name="l02071"></a>02071     <span class="keywordflow">return</span> DhcpKick(name, <a class="code" href="group__xg_d_h_c_p_c.html#g512ac4affb0ba009424b5a46b5216c08" title="DHCP state: Releasing.">DHCPST_RELEASING</a>, timeout);
<a name="l02072"></a>02072 }
<a name="l02073"></a>02073 
<a name="l02084"></a><a class="code" href="group__xg_d_h_c_p_c.html#g503ce1d2310d16f60ea1f88ae38d119a">02084</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#g503ce1d2310d16f60ea1f88ae38d119a" title="Inform DHCP about an allocated address.">NutDhcpInform</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l02085"></a>02085 {
<a name="l02086"></a>02086     <span class="comment">/* Check the state. */</span>
<a name="l02087"></a>02087     <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#g5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>) {
<a name="l02088"></a>02088         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gba878e739d434e142fe34a96be7e2f5b" title="DHCP state error.">DHCPERR_STATE</a>;
<a name="l02089"></a>02089         <span class="keywordflow">return</span> -1;
<a name="l02090"></a>02090     }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092     <span class="comment">/* Action! */</span>
<a name="l02093"></a>02093     <span class="keywordflow">return</span> DhcpKick(name, <a class="code" href="group__xg_d_h_c_p_c.html#g4abafabe4257cdd6afd733dd9a12bee7" title="DHCP state: Informing.">DHCPST_INFORMING</a>, timeout);
<a name="l02094"></a>02094 }
<a name="l02095"></a>02095 
<a name="l02113"></a><a class="code" href="group__xg_d_h_c_p_c.html#g9c16be9d86c6824b7fc557fd2289442a">02113</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#g9c16be9d86c6824b7fc557fd2289442a" title="Return DHCP client status.">NutDhcpStatus</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name)
<a name="l02114"></a>02114 {
<a name="l02115"></a>02115     <span class="keywordflow">return</span> dhcpState;
<a name="l02116"></a>02116 }
<a name="l02117"></a>02117 
<a name="l02136"></a><a class="code" href="group__xg_d_h_c_p_c.html#g444065dc84a618a407d05913552942fa">02136</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#g444065dc84a618a407d05913552942fa" title="Return DHCP error code.">NutDhcpError</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name)
<a name="l02137"></a>02137 {
<a name="l02138"></a>02138     <span class="keywordtype">int</span> rc = dhcpError;
<a name="l02139"></a>02139     dhcpError = 0;
<a name="l02140"></a>02140     <span class="keywordflow">return</span> rc;
<a name="l02141"></a>02141 }
<a name="l02142"></a>02142 
<a name="l02150"></a><a class="code" href="group__xg_d_h_c_p_c.html#gf62239b0c937c5c43d7e085876a51f0a">02150</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#gf62239b0c937c5c43d7e085876a51f0a" title="Check if DHCP has configured our interface.">NutDhcpIsConfigured</a>(<span class="keywordtype">void</span>)
<a name="l02151"></a>02151 {
<a name="l02152"></a>02152     <span class="keywordflow">return</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#g740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>);
<a name="l02153"></a>02153 }
<a name="l02154"></a>02154 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
