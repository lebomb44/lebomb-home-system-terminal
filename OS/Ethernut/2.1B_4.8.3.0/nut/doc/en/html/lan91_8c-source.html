<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_62cc943d9a5c6ffd14cbda02228b93ec.html">dev</a>
  </div>
<div class="contents">
<h1>lan91.c</h1><a href="lan91_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2003-2006 by egnite Software GmbH.</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (C) 2008 by egnite GmbH.</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * All rights reserved.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00008"></a>00008 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00009"></a>00009 <span class="comment"> * are met:</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00012"></a>00012 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00013"></a>00013 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00014"></a>00014 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00015"></a>00015 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00016"></a>00016 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00017"></a>00017 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00018"></a>00018 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00021"></a>00021 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00022"></a>00022 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00023"></a>00023 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<a name="l00024"></a>00024 <span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00025"></a>00025 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00026"></a>00026 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00027"></a>00027 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00028"></a>00028 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00029"></a>00029 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00030"></a>00030 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00031"></a>00031 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00034"></a>00034 <span class="comment"> *</span>
<a name="l00035"></a>00035 <span class="comment"> */</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">/*</span>
<a name="l00038"></a>00038 <span class="comment"> * $Id: lan91.c 2351 2008-10-23 08:54:07Z haraldkipp $</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="os_8h.html">cfg/os.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="include_2sys_2atom_8h.html">sys/atom.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html" title="Header file for network configuration.">sys/confnet.h</a>&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="if__ether_8h.html" title="Ethernet interface definitions.">netinet/if_ether.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="ether_8h.html" title="Ethernet protocol definitions.">net/ether.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="if_8h.html" title="Network interface header file.">net/if.h</a>&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="if__var_8h.html" title="Network interface structure.">net/if_var.h</a>&gt;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="cfg_2arch_2gpio_8h.html" title="Port configuration.">cfg/arch/gpio.h</a>&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;<a class="code" href="dev_2irqreg_8h.html" title="Interrupt management definitions.">dev/irqreg.h</a>&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;<a class="code" href="lan91_8h.html">dev/lan91.h</a>&gt;</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="comment">/*</span>
<a name="l00065"></a>00065 <span class="comment"> * Determine interrupt settings.</span>
<a name="l00066"></a>00066 <span class="comment"> */</span>
<a name="l00067"></a>00067 <span class="preprocessor">#if (LAN91_SIGNAL_IRQ == INT0)</span>
<a name="l00068"></a><a class="code" href="lan91_8c.html#5d0d70c9f41a3fdf438eeef522e4bf20">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT0</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT1)</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT1</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT2)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT2</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT3)</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT3</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT4)</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT4</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT5)</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT5</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT6)</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT6</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#elif (LAN91_SIGNAL_IRQ == INT7)</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_SIGNAL          sig_INTERRUPT7</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a>00085 <span class="comment">/*</span>
<a name="l00086"></a>00086 <span class="comment"> * Determine poll timers.</span>
<a name="l00087"></a>00087 <span class="comment"> */</span>
<a name="l00088"></a>00088 <span class="preprocessor">#if !defined(LAN91_RX_POLLTIME)</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">#if defined(LAN91_SIGNAL)</span>
<a name="l00090"></a><a class="code" href="lan91_8c.html#cc5c87f3b20200f1e0a8cdd2da06946f">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define LAN91_RX_POLLTIME   2000</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_RX_POLLTIME   200</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a>00096 <span class="preprocessor">#if !defined(LAN91_TX_POLLTIME)</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">#if defined(LAN91_SIGNAL)</span>
<a name="l00098"></a><a class="code" href="lan91_8c.html#2b7b4427323bcd3fe0c1b5ba4db870c5">00098</a> <span class="preprocessor"></span><span class="preprocessor">#define LAN91_TX_POLLTIME   5000</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span><span class="preprocessor">#define LAN91_TX_POLLTIME   200</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a>00104 
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="group__xg_nic_lan91.html#gdd2109a2e3569486b5218ec5762bc733">00110</a> <span class="preprocessor">#define nic_outlb(addr, val) (*(volatile uint8_t *)(addr) = (val))</span>
<a name="l00111"></a><a class="code" href="group__xg_nic_lan91.html#g86c9bb36994f7db997ec7e42f8b78486">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define nic_outhb(addr, val) (*(volatile uint8_t *)((addr) + 1) = (val))</span>
<a name="l00112"></a><a class="code" href="group__xg_nic_lan91.html#g5dc37af297b808530394316f39861e67">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define nic_outwx(addr, val) (*(volatile uint16_t *)(addr) = (val))</span>
<a name="l00113"></a><a class="code" href="group__xg_nic_lan91.html#ga9e2892dddc57005835acbf5ffdfe232">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define nic_outw(addr, val) { \</span>
<a name="l00114"></a>00114 <span class="preprocessor">    *(volatile uint8_t *)(addr) = (uint8_t)(val); \</span>
<a name="l00115"></a>00115 <span class="preprocessor">    *((volatile uint8_t *)(addr) + 1) = (uint8_t)((val) &gt;&gt; 8); \</span>
<a name="l00116"></a>00116 <span class="preprocessor">}</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>
<a name="l00118"></a><a class="code" href="group__xg_nic_lan91.html#g7ad23fcbf87e5b251c6c15c3c33feecb">00118</a> <span class="preprocessor">#define nic_inlb(addr) (*(volatile uint8_t *)(addr))</span>
<a name="l00119"></a><a class="code" href="group__xg_nic_lan91.html#g18ed6304cfef871057f6bbfe72353b27">00119</a> <span class="preprocessor"></span><span class="preprocessor">#define nic_inhb(addr) (*(volatile uint8_t *)((addr) + 1))</span>
<a name="l00120"></a><a class="code" href="group__xg_nic_lan91.html#g7199e8b834f981e8300a86de51f372d6">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define nic_inw(addr) (*(volatile uint16_t *)(addr))</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>
<a name="l00122"></a><a class="code" href="group__xg_nic_lan91.html#ga31140f42b6cef629a69e8cf19077508">00122</a> <span class="preprocessor">#define nic_bs(bank)    nic_outlb(LAN91_BSR, bank)</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>
<a name="l00128"></a>00128 <span class="keyword">struct </span><a class="code" href="struct___n_i_c_i_n_f_o.html" title="Network interface controller information structure.">_NICINFO</a> {
<a name="l00129"></a>00129     <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> <span class="keyword">volatile</span> <a class="code" href="struct___n_i_c_i_n_f_o.html#feab7f79c7a470880c6414ca9da06951">ni_rx_rdy</a>;      
<a name="l00130"></a>00130     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#253e20d5d4e36c77dfaf71afa7191943">ni_tx_cnt</a>;             
<a name="l00131"></a>00131 <span class="preprocessor">#ifdef NUT_PERFMON</span>
<a name="l00132"></a>00132 <span class="preprocessor"></span>    <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#c858ef9d5b524dc537c29e0526c59bd7">ni_rx_packets</a>;         
<a name="l00133"></a>00133     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#4fb3fe93bc81f71cf13b9747851de06a">ni_tx_packets</a>;         
<a name="l00134"></a>00134     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#22d11af4d47b099e6e0e0b9f886c6cf4">ni_interrupts</a>;         
<a name="l00135"></a>00135     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#60181fe0c50bd2c06d09ecdd4aba7292">ni_overruns</a>;           
<a name="l00136"></a>00136     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#f522df3c363490bd3db41f9bf3854cb3">ni_rx_frame_errors</a>;    
<a name="l00137"></a>00137     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#bef05894ceb07d8b408b57207952b806">ni_rx_crc_errors</a>;      
<a name="l00138"></a>00138     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="struct___n_i_c_i_n_f_o.html#5b3222fd2d5aa1af84803f85a8e444fb">ni_rx_missed_errors</a>;   
<a name="l00139"></a>00139 <span class="preprocessor">#endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>};
<a name="l00141"></a>00141 
<a name="l00145"></a>00145 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="struct___n_i_c_i_n_f_o.html" title="Network interface controller information structure.">_NICINFO</a> <a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> mutex;
<a name="l00148"></a>00148 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> maq;
<a name="l00149"></a>00149 
<a name="l00160"></a>00160 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> NicPhyRegSelect(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> reg, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> we)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> rs;
<a name="l00163"></a>00163     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> msk;
<a name="l00164"></a>00164     <a class="code" href="stdint_8h.html#d0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> i;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(3);
<a name="l00167"></a>00167     rs = (<a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>) &amp; ~(<a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a> | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>)) | <a class="code" href="group__xg_nic_lan91.html#g1284f0995d6b50cf125969c640da9edc">LAN91_MGMT_MDOE</a>;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">/* Send idle pattern. */</span>
<a name="l00170"></a>00170     <span class="keywordflow">for</span> (i = 0; i &lt; 33; i++) {
<a name="l00171"></a>00171         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00172"></a>00172         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">/* Send start sequence. */</span>
<a name="l00176"></a>00176     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00177"></a>00177     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00178"></a>00178     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00179"></a>00179     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="comment">/* Write or read mode. */</span>
<a name="l00182"></a>00182     <span class="keywordflow">if</span> (we) {
<a name="l00183"></a>00183         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00184"></a>00184         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00185"></a>00185         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00186"></a>00186         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00187"></a>00187     } <span class="keywordflow">else</span> {
<a name="l00188"></a>00188         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00189"></a>00189         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00190"></a>00190         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00191"></a>00191         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="comment">/* Send PHY address. Zero is used for the internal PHY. */</span>
<a name="l00195"></a>00195     <span class="keywordflow">for</span> (i = 0; i &lt; 5; i++) {
<a name="l00196"></a>00196         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00197"></a>00197         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="comment">/* Send PHY register number. */</span>
<a name="l00201"></a>00201     <span class="keywordflow">for</span> (msk = 0x10; msk; msk &gt;&gt;= 1) {
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (reg &amp; msk) {
<a name="l00203"></a>00203             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00204"></a>00204             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00205"></a>00205         } <span class="keywordflow">else</span> {
<a name="l00206"></a>00206             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00207"></a>00207             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="keywordflow">return</span> rs;
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00224"></a>00224 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> reg)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> rc = 0;
<a name="l00227"></a>00227     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> rs;
<a name="l00228"></a>00228     <a class="code" href="stdint_8h.html#d0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> i;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="comment">/* Select register for reading. */</span>
<a name="l00231"></a>00231     rs = NicPhyRegSelect(reg, 0);
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     <span class="comment">/* Switch data direction. */</span>
<a name="l00234"></a>00234     rs &amp;= ~<a class="code" href="group__xg_nic_lan91.html#g1284f0995d6b50cf125969c640da9edc">LAN91_MGMT_MDOE</a>;
<a name="l00235"></a>00235     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00236"></a>00236     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <span class="comment">/* Clock data in. */</span>
<a name="l00239"></a>00239     <span class="keywordflow">for</span> (i = 0; i &lt; 16; i++) {
<a name="l00240"></a>00240         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00241"></a>00241         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00242"></a>00242         rc &lt;&lt;= 1;
<a name="l00243"></a>00243         rc |= (<a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>) &amp; <a class="code" href="group__xg_nic_lan91.html#gdfc4509f3e61867fa9f04b1bdcfae311">LAN91_MGMT_MDI</a>) != 0;
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="comment">/* This will set the clock line to low. */</span>
<a name="l00247"></a>00247     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="keywordflow">return</span> rc;
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00260"></a>00260 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> reg, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> val)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> msk;
<a name="l00263"></a>00263     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> rs;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="comment">/* Select register for writing. */</span>
<a name="l00266"></a>00266     rs = NicPhyRegSelect(reg, 1);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">/* Switch data direction dummy. */</span>
<a name="l00269"></a>00269     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00270"></a>00270     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00271"></a>00271     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00272"></a>00272     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="comment">/* Clock data out. */</span>
<a name="l00275"></a>00275     <span class="keywordflow">for</span> (msk = 0x8000; msk; msk &gt;&gt;= 1) {
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (val &amp; msk) {
<a name="l00277"></a>00277             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a>);
<a name="l00278"></a>00278             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g48c4325fcac99b62dd85864e4fa3b4b4">LAN91_MGMT_MDO</a> | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00279"></a>00279         } <span class="keywordflow">else</span> {
<a name="l00280"></a>00280             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs);
<a name="l00281"></a>00281             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs | <a class="code" href="group__xg_nic_lan91.html#g42c0c9d17f340cad22c709d3b584856c">LAN91_MGMT_MCLK</a>);
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="comment">/* Set clock line low and output line int z-state. */</span>
<a name="l00286"></a>00286     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g9f832408a090f77563f8ba5b18c8b32f" title="Bank 3 - Management interface register.">LAN91_MGMT</a>, rs &amp; ~<a class="code" href="group__xg_nic_lan91.html#g1284f0995d6b50cf125969c640da9edc">LAN91_MGMT_MDOE</a>);
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00294"></a>00294 <span class="keyword">static</span> <span class="keywordtype">int</span> NicPhyConfig(<span class="keywordtype">void</span>)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> phy_sor;
<a name="l00297"></a>00297     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> phy_sr;
<a name="l00298"></a>00298     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> phy_to;
<a name="l00299"></a>00299     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> mode;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     <span class="comment">/* </span>
<a name="l00302"></a>00302 <span class="comment">     * Reset the PHY and wait until this self clearing bit</span>
<a name="l00303"></a>00303 <span class="comment">     * becomes zero. We sleep 63 ms before each poll and</span>
<a name="l00304"></a>00304 <span class="comment">     * give up after 3 retries. </span>
<a name="l00305"></a>00305 <span class="comment">     */</span>
<a name="l00306"></a>00306     <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#gc257f052e419c16b44b77a07bb482bad" title="PHY control register.">LAN91_PHYCR</a>, <a class="code" href="group__xg_nic_lan91.html#ga92ca5d968eec6a069143971dbac394e">LAN91_PHYCR_RST</a>);
<a name="l00307"></a>00307     <span class="keywordflow">for</span> (phy_to = 0;; phy_to++) {
<a name="l00308"></a>00308         <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(63);
<a name="l00309"></a>00309         <span class="keywordflow">if</span> ((<a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="group__xg_nic_lan91.html#gc257f052e419c16b44b77a07bb482bad" title="PHY control register.">LAN91_PHYCR</a>) &amp; <a class="code" href="group__xg_nic_lan91.html#ga92ca5d968eec6a069143971dbac394e">LAN91_PHYCR_RST</a>) == 0)
<a name="l00310"></a>00310             <span class="keywordflow">break</span>;
<a name="l00311"></a>00311         <span class="keywordflow">if</span> (phy_to &gt; 3)
<a name="l00312"></a>00312             <span class="keywordflow">return</span> -1;
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment">/* Store PHY status output. */</span>
<a name="l00316"></a>00316     phy_sor = <a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="group__xg_nic_lan91.html#g067480f98beb0b43c11382dd80e011e5" title="PHY status output register.">LAN91_PHYSOR</a>);
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="comment">/* Enable PHY interrupts. */</span>
<a name="l00319"></a>00319     <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#g99690a747c0cbe7e9ac822302a4e2feb" title="PHY mask register.">LAN91_PHYMSK</a>, <a class="code" href="group__xg_nic_lan91.html#gcc3576c90136822e4cc8ab763ca7c6cf">LAN91_PHYMSK_MLOSSSYN</a> | <a class="code" href="group__xg_nic_lan91.html#g2210ff7b58a259bdae7a8c523a35ac00">LAN91_PHYMSK_MCWRD</a> | <a class="code" href="group__xg_nic_lan91.html#g0607bd79b2181aa5f067d2fa886f1e93">LAN91_PHYMSK_MSSD</a> |
<a name="l00320"></a>00320                 <a class="code" href="group__xg_nic_lan91.html#g53b35b263d67592bd8b3266b18324c71">LAN91_PHYMSK_MESD</a> | <a class="code" href="group__xg_nic_lan91.html#g0b4f2e18c4dfcec1cb23006db245dea9">LAN91_PHYMSK_MRPOL</a> | <a class="code" href="group__xg_nic_lan91.html#g292c910c906d5a811495172f609ce9a4">LAN91_PHYMSK_MJAB</a> | <a class="code" href="group__xg_nic_lan91.html#g85285fec554a0c31394aee4a838ac916">LAN91_PHYMSK_MSPDDT</a> | <a class="code" href="group__xg_nic_lan91.html#gb2c6e9904fa95a4766dd876820b551e1">LAN91_PHYMSK_MDPLDT</a>);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="comment">/* Set RPC register. */</span>
<a name="l00323"></a>00323     mode = <a class="code" href="group__xg_nic_lan91.html#gb0e8d02381e02da2304435a23ec018f7">LAN91_RPCR_ANEG</a> | <a class="code" href="group__xg_nic_lan91.html#g95b78243ee5916c6a50ec8135dd0f3e9">LAN91_RPCR_LEDA_PAT</a> | <a class="code" href="group__xg_nic_lan91.html#g7bb7ec0fc962593c324dfc8792025d03">LAN91_RPCR_LEDB_PAT</a>;
<a name="l00324"></a>00324     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(0);
<a name="l00325"></a>00325     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g8028fb0816b6a2a2717f4f67011f5d5c" title="Bank 0 - Receive / PHY control register.">LAN91_RPCR</a>, mode);
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 <span class="preprocessor">#ifdef LAN91_FIXED</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>    <span class="comment">/* Disable link. */</span>
<a name="l00329"></a>00329     phy_sr = <a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="group__xg_nic_lan91.html#g065cff85bc6527500d4168e4c2fd7dd1" title="PHY configuration register 1.">LAN91_PHYCFR1</a>);
<a name="l00330"></a>00330     <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#g065cff85bc6527500d4168e4c2fd7dd1" title="PHY configuration register 1.">LAN91_PHYCFR1</a>, phy_sr | 0x8000);
<a name="l00331"></a>00331     <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(63);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     <span class="comment">/* Set fixed capabilities. */</span>
<a name="l00334"></a>00334     <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#gc257f052e419c16b44b77a07bb482bad" title="PHY control register.">LAN91_PHYCR</a>, LAN91_FIXED);
<a name="l00335"></a>00335     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(0);
<a name="l00336"></a>00336     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g8028fb0816b6a2a2717f4f67011f5d5c" title="Bank 0 - Receive / PHY control register.">LAN91_RPCR</a>, mode);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">/* Enable link. */</span>
<a name="l00339"></a>00339     phy_sr = <a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="group__xg_nic_lan91.html#g065cff85bc6527500d4168e4c2fd7dd1" title="PHY configuration register 1.">LAN91_PHYCFR1</a>);
<a name="l00340"></a>00340     <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#g065cff85bc6527500d4168e4c2fd7dd1" title="PHY configuration register 1.">LAN91_PHYCFR1</a>, phy_sr &amp; ~0x8000);
<a name="l00341"></a>00341     phy_sr = <a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="group__xg_nic_lan91.html#g065cff85bc6527500d4168e4c2fd7dd1" title="PHY configuration register 1.">LAN91_PHYCFR1</a>);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="preprocessor">#else</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00345"></a>00345 <span class="comment">     * Advertise our capabilities, initiate auto negotiation</span>
<a name="l00346"></a>00346 <span class="comment">     * and wait until this has been completed.</span>
<a name="l00347"></a>00347 <span class="comment">     */</span>
<a name="l00348"></a>00348     <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#g57fb3621b772bbbd1e7fb67c95ca67e9" title="PHY auto-negotiation advertisement register.">LAN91_PHYANAD</a>, <a class="code" href="group__xg_nic_lan91.html#gd5c017cf23fb6212d96d2d00ca25db8e">LAN91_PHYANAD_TX_FDX</a> | <a class="code" href="group__xg_nic_lan91.html#geb4429b3a9bca3398f2dfe74c8809604">LAN91_PHYANAD_TX_HDX</a> | <a class="code" href="group__xg_nic_lan91.html#g8b3e52b4006221c1c47622d707c93c43">LAN91_PHYANAD_10FDX</a> | <a class="code" href="group__xg_nic_lan91.html#gaef776ba1072c3e444d9459e7851680d">LAN91_PHYANAD_10_HDX</a> | <a class="code" href="group__xg_nic_lan91.html#g6d57cf2f5ae3031775f6abedf33fb20f">LAN91_PHYANAD_CSMA</a>);
<a name="l00349"></a>00349     <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(63);
<a name="l00350"></a>00350     <span class="keywordflow">for</span> (phy_to = 0, phy_sr = 0;; phy_to++) {
<a name="l00351"></a>00351         <span class="comment">/* Give up after 10 seconds. */</span>
<a name="l00352"></a>00352         <span class="keywordflow">if</span> (phy_to &gt;= 1024)
<a name="l00353"></a>00353             <span class="keywordflow">return</span> -1;
<a name="l00354"></a>00354         <span class="comment">/* Restart auto negotiation every 4 seconds or on failures. */</span>
<a name="l00355"></a>00355         <span class="keywordflow">if</span> ((phy_to &amp; 127) == 0 <span class="comment">/* || (phy_sr &amp; LAN91_PHYSR_REM_FLT) != 0 */</span> ) {
<a name="l00356"></a>00356             <a class="code" href="group__xg_nic_asix.html#gea734133b886d979f8f8a153560bf945" title="Write value to PHY register.">NicPhyWrite</a>(<a class="code" href="group__xg_nic_lan91.html#gc257f052e419c16b44b77a07bb482bad" title="PHY control register.">LAN91_PHYCR</a>, <a class="code" href="group__xg_nic_lan91.html#gcf121c1ff9dc12e9abcdb1273e77706e">LAN91_PHYCR_ANEG_EN</a> | <a class="code" href="group__xg_nic_lan91.html#g81cbed64f0f89c3a30c096bedccf3acf">LAN91_PHYCR_ANEG_RST</a>);
<a name="l00357"></a>00357             <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(63);
<a name="l00358"></a>00358         }
<a name="l00359"></a>00359         <span class="comment">/* Check if we are done. */</span>
<a name="l00360"></a>00360         phy_sr = <a class="code" href="group__xg_nic_asix.html#g17ca59ae690cd4431ef86afbcb4b1da2" title="Read contents of internel PHY register on 0x10 adress.">NicPhyRead</a>(<a class="code" href="group__xg_nic_lan91.html#gfe0b1f1fae6fc6028f2349f88b9b2b44" title="PHY status register.">LAN91_PHYSR</a>);
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (phy_sr &amp; <a class="code" href="group__xg_nic_lan91.html#g1ddfe6e0749e895b51c6bab6b3cd52e1">LAN91_PHYSR_ANEG_ACK</a>)
<a name="l00362"></a>00362             <span class="keywordflow">break</span>;
<a name="l00363"></a>00363         <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(63);
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 <span class="preprocessor">#endif</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>
<a name="l00367"></a>00367     <span class="keywordflow">return</span> 0;
<a name="l00368"></a>00368 }
<a name="l00369"></a>00369 
<a name="l00380"></a>00380 <span class="keyword">static</span> <a class="code" href="arm_8h.html#2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <span class="keywordtype">int</span> NicMmuWait(<a class="code" href="stdint_8h.html#6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> tmo)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382     <span class="keywordflow">while</span> (tmo--) {
<a name="l00383"></a>00383         <span class="keywordflow">if</span> ((<a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>) &amp; <a class="code" href="group__xg_nic_lan91.html#gb43b9c2aa08a3a7adcdbebcbc07f3f7b">LAN91_MMUCR_BUSY</a>) == 0)
<a name="l00384"></a>00384             <span class="keywordflow">break</span>;
<a name="l00385"></a>00385         <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(1);
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <span class="keywordflow">return</span> tmo ? 0 : -1;
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 
<a name="l00395"></a>00395 <span class="keyword">static</span> <span class="keywordtype">int</span> NicReset(<span class="keywordtype">void</span>)
<a name="l00396"></a>00396 {
<a name="l00397"></a>00397 <span class="preprocessor">#ifdef LAN91_RESET_BIT</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>    <a class="code" href="dev_2gpio_8h.html#28632a49f76af1ecf6539a2f55f3f8a1" title="Set pin configuration.">GpioPinConfigSet</a>(LAN91_RESET_GPIO_BANK, LAN91_RESET_GPIO_BIT, <a class="code" href="dev_2gpio_8h.html#ad0c4b9c093f1d57fd03061b7456193a" title="GPIO output direction enabled.">GPIO_CFG_OUTPUT</a>);
<a name="l00399"></a>00399     <a class="code" href="dev_2gpio_8h.html#253940c2985718d2d74000f211f64500" title="Set pin level.">GpioPinSet</a>(LAN91_RESET_GPIO_BANK, LAN91_RESET_GPIO_BIT, 1);
<a name="l00400"></a>00400     <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(10);
<a name="l00401"></a>00401     <a class="code" href="dev_2gpio_8h.html#253940c2985718d2d74000f211f64500" title="Set pin level.">GpioPinSet</a>(LAN91_RESET_GPIO_BANK, LAN91_RESET_GPIO_BIT, 0);
<a name="l00402"></a>00402     <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(100);
<a name="l00403"></a>00403 <span class="preprocessor">#endif</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>
<a name="l00405"></a>00405     <span class="comment">/* Disable all interrupts. */</span>
<a name="l00406"></a>00406     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, 0);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="comment">/* MAC and PHY software reset. */</span>
<a name="l00409"></a>00409     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(0);
<a name="l00410"></a>00410     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#ga85beabf9e35a64dc793526048305947" title="Bank 0 - Receive control register.">LAN91_RCR</a>, <a class="code" href="group__xg_nic_lan91.html#g2ce79511221fb471c88fe6947a3bdd62">LAN91_RCR_SOFT_RST</a>);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">/* Enable Ethernet protocol handler. */</span>
<a name="l00413"></a>00413     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(1);
<a name="l00414"></a>00414     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#gdca223b93dcf1d5bfee6eac4029b27e4" title="Bank 1 - Configuration register.">LAN91_CR</a>, <a class="code" href="group__xg_nic_lan91.html#ge3d2c3cb924d1c63ff5685060725d4d3">LAN91_CR_EPH_EN</a>);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(10);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="comment">/* Disable transmit and receive. */</span>
<a name="l00419"></a>00419     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(0);
<a name="l00420"></a>00420     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#ga85beabf9e35a64dc793526048305947" title="Bank 0 - Receive control register.">LAN91_RCR</a>, 0);
<a name="l00421"></a>00421     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g3a25c7ba5d67dff24d91a0c3f82847c2" title="Bank 0 - Transmit control register.">LAN91_TCR</a>, 0);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="comment">/* Enable auto release. */</span>
<a name="l00424"></a>00424     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(1);
<a name="l00425"></a>00425     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g0032bf65874769e9bbbedfeb6b42405a" title="Bank 1 - Control register.">LAN91_CTR</a>, <a class="code" href="group__xg_nic_lan91.html#g8382e1cd6aedf51178d7105783c5c2e3">LAN91_CTR_AUTO_RELEASE</a>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="comment">/* Reset MMU. */</span>
<a name="l00428"></a>00428     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(2);
<a name="l00429"></a>00429     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#g31c24658f68946abca1ad38f6765cf37">LAN91_MMU_RST</a>);
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (NicMmuWait(1000))
<a name="l00431"></a>00431         <span class="keywordflow">return</span> -1;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="keywordflow">return</span> 0;
<a name="l00434"></a>00434 }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436 <span class="comment">/*</span>
<a name="l00437"></a>00437 <span class="comment"> * Fires up the network interface. NIC interrupts</span>
<a name="l00438"></a>00438 <span class="comment"> * should have been disabled when calling this</span>
<a name="l00439"></a>00439 <span class="comment"> * function.</span>
<a name="l00440"></a>00440 <span class="comment"> *</span>
<a name="l00441"></a>00441 <span class="comment"> * \param mac Six byte unique MAC address.</span>
<a name="l00442"></a>00442 <span class="comment"> */</span>
<a name="l00443"></a>00443 <span class="keyword">static</span> <span class="keywordtype">int</span> NicStart(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * mac)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445     <a class="code" href="stdint_8h.html#d0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> i;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (NicReset())
<a name="l00448"></a>00448         <span class="keywordflow">return</span> -1;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="comment">/* Enable receiver. */</span>
<a name="l00451"></a>00451     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(3);
<a name="l00452"></a>00452     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g71228df4b41cbd10ea13e81e098c3e74" title="Bank 3 - Early RCV register.">LAN91_ERCV</a>, 7);
<a name="l00453"></a>00453     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(0);
<a name="l00454"></a>00454     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#ga85beabf9e35a64dc793526048305947" title="Bank 0 - Receive control register.">LAN91_RCR</a>, <a class="code" href="group__xg_nic_lan91.html#g7639b248215290f89c7d16d6c7f4bd4e">LAN91_RCR_RXEN</a>);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">/* Enable transmitter and padding. */</span>
<a name="l00457"></a>00457     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g3a25c7ba5d67dff24d91a0c3f82847c2" title="Bank 0 - Transmit control register.">LAN91_TCR</a>, <a class="code" href="group__xg_nic_lan91.html#g44a9627fb8e5d57d7386b8d46898b56b">LAN91_TCR_PAD_EN</a> | <a class="code" href="group__xg_nic_lan91.html#g4c4dddba94884257b8e5fd16fe4c8bbe">LAN91_TCR_TXENA</a>);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="comment">/* Configure the PHY. */</span>
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (NicPhyConfig())
<a name="l00461"></a>00461         <span class="keywordflow">return</span> -1;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="comment">/* Set MAC address. */</span>
<a name="l00464"></a>00464     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(1);
<a name="l00465"></a>00465     <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++)
<a name="l00466"></a>00466         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#ga8ec19dad2788976d10c13b3fad430c2" title="Bank 1 - Individual address register.">LAN91_IAR</a> + i, mac[i]);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <span class="comment">/* Enable interrupts. */</span>
<a name="l00469"></a>00469     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(2);
<a name="l00470"></a>00470     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, <a class="code" href="group__xg_nic_lan91.html#gbfb9f048a81b84fe47a79b06a2d6ce66" title="Early receive interrupt bit mask.">LAN91_INT_ERCV</a> | <a class="code" href="group__xg_nic_lan91.html#gf44e59b35841dd563e64d1e796e2c7d6" title="Receive interrupt bit mask.">LAN91_INT_RCV</a> | <a class="code" href="group__xg_nic_lan91.html#gd6578e07609f4421f5d65a88b5efc8c2" title="Receive overrun interrupt bit mask.">LAN91_INT_RX_OVRN</a>);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="keywordflow">return</span> 0;
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="preprocessor">#if defined(LAN91_SIGNAL)</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00477"></a>00477 <span class="comment"> * NIC interrupt entry.</span>
<a name="l00478"></a>00478 <span class="comment"> */</span>
<a name="l00479"></a>00479 <span class="keyword">static</span> <span class="keywordtype">void</span> NicInterrupt(<span class="keywordtype">void</span> *arg)
<a name="l00480"></a>00480 {
<a name="l00481"></a>00481     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> isr;
<a name="l00482"></a>00482     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> imr;
<a name="l00483"></a>00483     <a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> *ni = (<a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> *) ((NUTDEVICE *) arg)-&gt;dev_dcb;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 <span class="preprocessor">#ifdef NUT_PERFMON</span>
<a name="l00486"></a>00486 <span class="preprocessor"></span>    ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#22d11af4d47b099e6e0e0b9f886c6cf4">ni_interrupts</a>++;
<a name="l00487"></a>00487 <span class="preprocessor">#endif</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span>    <span class="comment">/* Read the interrupt mask and disable all interrupts. */</span>
<a name="l00489"></a>00489     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(2);
<a name="l00490"></a>00490     imr = <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>);
<a name="l00491"></a>00491     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, 0);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <span class="comment">/* Read the interrupt status and acknowledge all interrupts. */</span>
<a name="l00494"></a>00494     isr = <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g8df466f269757a31696a8d4981392f48" title="Bank 2 - Interrupt status register.">LAN91_IST</a>);
<a name="l00495"></a>00495     isr &amp;= imr;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="comment">/*</span>
<a name="l00498"></a>00498 <span class="comment">     * If this is a transmit interrupt, then a packet has been sent. </span>
<a name="l00499"></a>00499 <span class="comment">     * So we can clear the transmitter busy flag and wake up the </span>
<a name="l00500"></a>00500 <span class="comment">     * transmitter thread.</span>
<a name="l00501"></a>00501 <span class="comment">     */</span>
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (isr &amp; <a class="code" href="group__xg_nic_lan91.html#g9c72527ed7bb6cfbf6d7f9d27d1ae568" title="Transmitter empty interrupt bit mask.">LAN91_INT_TX_EMPTY</a>) {
<a name="l00503"></a>00503         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g39aae5c7397e445e37a6a7bebcac5747" title="Bank 2 - Interrupt acknowledge register.">LAN91_ACK</a>, LAN91_INT_TX_EMPTY);
<a name="l00504"></a>00504         imr &amp;= ~LAN91_INT_TX_EMPTY;
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506     <span class="comment">/* Transmit error. */</span>
<a name="l00507"></a>00507     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isr &amp; <a class="code" href="group__xg_nic_lan91.html#g5237a49599a011740f14e2e9783f4a47" title="Transmit complete interrupt bit mask.">LAN91_INT_TX</a>) {
<a name="l00508"></a>00508         <span class="comment">/* re-enable transmit */</span>
<a name="l00509"></a>00509         <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(0);
<a name="l00510"></a>00510         <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g3a25c7ba5d67dff24d91a0c3f82847c2" title="Bank 0 - Transmit control register.">LAN91_TCR</a>, <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g3a25c7ba5d67dff24d91a0c3f82847c2" title="Bank 0 - Transmit control register.">LAN91_TCR</a>) | <a class="code" href="group__xg_nic_lan91.html#g4c4dddba94884257b8e5fd16fe4c8bbe">LAN91_TCR_TXENA</a>);
<a name="l00511"></a>00511         <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(2);
<a name="l00512"></a>00512         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g39aae5c7397e445e37a6a7bebcac5747" title="Bank 2 - Interrupt acknowledge register.">LAN91_ACK</a>, LAN91_INT_TX);
<a name="l00513"></a>00513         <span class="comment">/* kill the packet */</span>
<a name="l00514"></a>00514         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#g7a313157aa560be913f7ab895ff1e596">LAN91_MMU_PKT</a>);
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="comment">/*</span>
<a name="l00519"></a>00519 <span class="comment">     * If this is a receive interrupt, then wake up the receiver </span>
<a name="l00520"></a>00520 <span class="comment">     * thread.</span>
<a name="l00521"></a>00521 <span class="comment">     */</span>
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (isr &amp; <a class="code" href="group__xg_nic_lan91.html#gd6578e07609f4421f5d65a88b5efc8c2" title="Receive overrun interrupt bit mask.">LAN91_INT_RX_OVRN</a>) {
<a name="l00523"></a>00523         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g39aae5c7397e445e37a6a7bebcac5747" title="Bank 2 - Interrupt acknowledge register.">LAN91_ACK</a>, LAN91_INT_RX_OVRN);
<a name="l00524"></a>00524         <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#feab7f79c7a470880c6414ca9da06951">ni_rx_rdy</a>);
<a name="l00525"></a>00525     }
<a name="l00526"></a>00526     <span class="keywordflow">if</span> (isr &amp; <a class="code" href="group__xg_nic_lan91.html#gbfb9f048a81b84fe47a79b06a2d6ce66" title="Early receive interrupt bit mask.">LAN91_INT_ERCV</a>) {
<a name="l00527"></a>00527         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g39aae5c7397e445e37a6a7bebcac5747" title="Bank 2 - Interrupt acknowledge register.">LAN91_ACK</a>, LAN91_INT_ERCV);
<a name="l00528"></a>00528         <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#feab7f79c7a470880c6414ca9da06951">ni_rx_rdy</a>);
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (isr &amp; <a class="code" href="group__xg_nic_lan91.html#gf44e59b35841dd563e64d1e796e2c7d6" title="Receive interrupt bit mask.">LAN91_INT_RCV</a>) {
<a name="l00531"></a>00531         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g39aae5c7397e445e37a6a7bebcac5747" title="Bank 2 - Interrupt acknowledge register.">LAN91_ACK</a>, LAN91_INT_RCV);
<a name="l00532"></a>00532         imr &amp;= ~LAN91_INT_RCV;
<a name="l00533"></a>00533         <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#feab7f79c7a470880c6414ca9da06951">ni_rx_rdy</a>);
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <span class="keywordflow">if</span> (isr &amp; <a class="code" href="group__xg_nic_lan91.html#g6a60b7ef7409780798f1d8c0a7a4cecd" title="Transmit allocation interrupt bit mask.">LAN91_INT_ALLOC</a>) {
<a name="l00537"></a>00537         imr &amp;= ~LAN91_INT_ALLOC;
<a name="l00538"></a>00538         <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;maq);
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, imr);
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 <span class="preprocessor">#endif</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>
<a name="l00544"></a>00544 <span class="comment">/*</span>
<a name="l00545"></a>00545 <span class="comment"> * Write data block to the NIC.</span>
<a name="l00546"></a>00546 <span class="comment"> */</span>
<a name="l00547"></a>00547 <span class="keyword">static</span> <span class="keywordtype">void</span> NicWrite(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * buf, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> len)
<a name="l00548"></a>00548 {
<a name="l00549"></a>00549     <span class="keyword">register</span> <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> l = len - 1;
<a name="l00550"></a>00550     <span class="keyword">register</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ih = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) l &gt;&gt; 8;
<a name="l00551"></a>00551     <span class="keyword">register</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> il = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) l;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="keywordflow">if</span> (!len)
<a name="l00554"></a>00554         <span class="keywordflow">return</span>;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="keywordflow">do</span> {
<a name="l00557"></a>00557         <span class="keywordflow">do</span> {
<a name="l00558"></a>00558             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>, *buf++);
<a name="l00559"></a>00559         } <span class="keywordflow">while</span> (il-- != 0);
<a name="l00560"></a>00560     } <span class="keywordflow">while</span> (ih-- != 0);
<a name="l00561"></a>00561 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563 <span class="comment">/*</span>
<a name="l00564"></a>00564 <span class="comment"> * Read data block from the NIC.</span>
<a name="l00565"></a>00565 <span class="comment"> */</span>
<a name="l00566"></a>00566 <span class="keyword">static</span> <span class="keywordtype">void</span> NicRead(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * buf, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> len)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568     <span class="keyword">register</span> <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> l = len - 1;
<a name="l00569"></a>00569     <span class="keyword">register</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ih = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) l &gt;&gt; 8;
<a name="l00570"></a>00570     <span class="keyword">register</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> il = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) l;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (!len)
<a name="l00573"></a>00573         <span class="keywordflow">return</span>;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="keywordflow">do</span> {
<a name="l00576"></a>00576         <span class="keywordflow">do</span> {
<a name="l00577"></a>00577             *buf++ = <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>);
<a name="l00578"></a>00578         } <span class="keywordflow">while</span> (il-- != 0);
<a name="l00579"></a>00579     } <span class="keywordflow">while</span> (ih-- != 0);
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00592"></a>00592 <span class="keyword">static</span> NETBUF *NicGetPacket(<span class="keywordtype">void</span>)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     NETBUF *nb = 0;
<a name="l00595"></a>00595     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> fsw;
<a name="l00596"></a>00596     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> fbc;
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="comment">/* Check the fifo empty bit. If it is set, then there is </span>
<a name="l00599"></a>00599 <span class="comment">       nothing in the receiver fifo. */</span>
<a name="l00600"></a>00600     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(2);
<a name="l00601"></a>00601     <span class="keywordflow">if</span> (<a class="code" href="group__xg_smsc_regs.html#g7199e8b834f981e8300a86de51f372d6">nic_inw</a>(<a class="code" href="group__xg_nic_lan91.html#g7d8f4509d5a21f91e63d99610b35899d" title="Bank 2 - FIFO ports register.">LAN91_FIFO</a>) &amp; 0x8000) {
<a name="l00602"></a>00602         <span class="keywordflow">return</span> 0;
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">/* Inialize pointer register. */</span>
<a name="l00606"></a>00606     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#gfe79991f5c429561b63a7379e479e0a0" title="Bank 2 - Pointer register.">LAN91_PTR</a>, <a class="code" href="group__xg_nic_lan91.html#g9f4d9d154fde176f5d93fd632bf9623a">LAN91_PTR_READ</a> | <a class="code" href="group__xg_nic_lan91.html#gd08e4960cc64f770d8f32ca09153f710">LAN91_PTR_RCV</a> | <a class="code" href="group__xg_nic_lan91.html#gb0c6981b9751fc0e5f1a54fd692d14cb">LAN91_PTR_AUTO_INCR</a>);
<a name="l00607"></a>00607     <a class="code" href="arm_8h.html#46388d9db8422abfea56ae2323f7a77c">_NOP</a>();
<a name="l00608"></a>00608     <a class="code" href="arm_8h.html#46388d9db8422abfea56ae2323f7a77c">_NOP</a>();
<a name="l00609"></a>00609     <a class="code" href="arm_8h.html#46388d9db8422abfea56ae2323f7a77c">_NOP</a>();
<a name="l00610"></a>00610     <a class="code" href="arm_8h.html#46388d9db8422abfea56ae2323f7a77c">_NOP</a>();
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     <span class="comment">/* Read status word and byte count. */</span>
<a name="l00613"></a>00613     fsw = <a class="code" href="group__xg_smsc_regs.html#g7199e8b834f981e8300a86de51f372d6">nic_inw</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>);
<a name="l00614"></a>00614     fbc = <a class="code" href="group__xg_smsc_regs.html#g7199e8b834f981e8300a86de51f372d6">nic_inw</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="comment">/* Check for frame errors. */</span>
<a name="l00617"></a>00617     <span class="keywordflow">if</span> (fsw &amp; 0xAC00) {
<a name="l00618"></a>00618         nb = (NETBUF *) 0xFFFF;
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620     <span class="comment">/* Check the byte count. */</span>
<a name="l00621"></a>00621     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fbc &lt; 66 || fbc &gt; 1524) {
<a name="l00622"></a>00622         nb = (NETBUF *) 0xFFFF;
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="keywordflow">else</span> {
<a name="l00626"></a>00626         <span class="comment">/* </span>
<a name="l00627"></a>00627 <span class="comment">         * Allocate a NETBUF. </span>
<a name="l00628"></a>00628 <span class="comment">         * Hack alert: Rev A chips never set the odd frame indicator.</span>
<a name="l00629"></a>00629 <span class="comment">         */</span>
<a name="l00630"></a>00630         fbc -= 3;
<a name="l00631"></a>00631         nb = <a class="code" href="group__xgnetbuf.html#g7a733aed1e6c15aaabb6657abe5f4e39" title="Allocate or re-allocate a network buffer part.">NutNetBufAlloc</a>(0, <a class="code" href="group__xgnetbuf.html#g76d35e2032a765ab5bd310cf47841d18" title="Datalink buffer allocated flag.">NBAF_DATALINK</a>, fbc);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="comment">/* Perform the read. */</span>
<a name="l00634"></a>00634         <span class="keywordflow">if</span> (nb)
<a name="l00635"></a>00635             NicRead(nb-&gt;nb_dl.vp, fbc);
<a name="l00636"></a>00636     }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <span class="comment">/* Release the packet. */</span>
<a name="l00639"></a>00639     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#gdfe6a1edad9a6f76a89c77cb94109fa9">LAN91_MMU_TOP</a>);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     <span class="keywordflow">return</span> nb;
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00658"></a>00658 <span class="keyword">static</span> <span class="keywordtype">int</span> NicPutPacket(NETBUF * nb)
<a name="l00659"></a>00659 {
<a name="l00660"></a>00660     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> sz;
<a name="l00661"></a>00661     <a class="code" href="stdint_8h.html#d0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> odd = 0;
<a name="l00662"></a>00662     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> imsk;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     <span class="comment">/*</span>
<a name="l00665"></a>00665 <span class="comment">     * Calculate the number of bytes to be send. Do not send packets </span>
<a name="l00666"></a>00666 <span class="comment">     * larger than the Ethernet maximum transfer unit. The MTU</span>
<a name="l00667"></a>00667 <span class="comment">     * consist of 1500 data bytes plus the 14 byte Ethernet header</span>
<a name="l00668"></a>00668 <span class="comment">     * plus 4 bytes CRC. We check the data bytes only.</span>
<a name="l00669"></a>00669 <span class="comment">     */</span>
<a name="l00670"></a>00670     <span class="keywordflow">if</span> ((sz = nb-&gt;nb_nw.sz + nb-&gt;nb_tp.sz + nb-&gt;nb_ap.sz) &gt; <a class="code" href="if__ether_8h.html#4baa77b0245fb4398faaecfc9b803649" title="Ethernet maximum transfer unit.">ETHERMTU</a>)
<a name="l00671"></a>00671         <span class="keywordflow">return</span> -1;
<a name="l00672"></a>00672 
<a name="l00673"></a>00673     <span class="comment">/* Disable all interrupts. */</span>
<a name="l00674"></a>00674     imsk = <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>);
<a name="l00675"></a>00675     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, 0);
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     <span class="comment">/* Allocate packet buffer space. */</span>
<a name="l00678"></a>00678     <a class="code" href="group__xg_smsc_regs.html#ga31140f42b6cef629a69e8cf19077508">nic_bs</a>(2);
<a name="l00679"></a>00679     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#g6b07fa0e130f408449d8468f1d875eca">LAN91_MMU_ALO</a>);
<a name="l00680"></a>00680     <span class="keywordflow">if</span> (NicMmuWait(100))
<a name="l00681"></a>00681         <span class="keywordflow">return</span> -1;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="comment">/* Enable interrupts including allocation success. */</span>
<a name="l00684"></a>00684     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, imsk | <a class="code" href="group__xg_nic_lan91.html#g6a60b7ef7409780798f1d8c0a7a4cecd" title="Transmit allocation interrupt bit mask.">LAN91_INT_ALLOC</a>);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">/* The MMU needs some time. Use it to calculate the byte count. */</span>
<a name="l00687"></a>00687     sz += nb-&gt;nb_dl.sz;
<a name="l00688"></a>00688     sz += 6;
<a name="l00689"></a>00689     <span class="keywordflow">if</span> (sz &amp; 1) {
<a name="l00690"></a>00690         sz++;
<a name="l00691"></a>00691         odd++;
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="comment">/* Wait for allocation success. */</span>
<a name="l00695"></a>00695     <span class="keywordflow">while</span> ((<a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g8df466f269757a31696a8d4981392f48" title="Bank 2 - Interrupt status register.">LAN91_IST</a>) &amp; <a class="code" href="group__xg_nic_lan91.html#g6a60b7ef7409780798f1d8c0a7a4cecd" title="Transmit allocation interrupt bit mask.">LAN91_INT_ALLOC</a>) == 0) {
<a name="l00696"></a>00696         <span class="keywordflow">if</span> (<a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;maq, 125)) {
<a name="l00697"></a>00697             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#g31c24658f68946abca1ad38f6765cf37">LAN91_MMU_RST</a>);
<a name="l00698"></a>00698             NicMmuWait(1000);
<a name="l00699"></a>00699             <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#g6b07fa0e130f408449d8468f1d875eca">LAN91_MMU_ALO</a>);
<a name="l00700"></a>00700             <span class="keywordflow">if</span> (NicMmuWait(100) || (<a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#g8df466f269757a31696a8d4981392f48" title="Bank 2 - Interrupt status register.">LAN91_IST</a>) &amp; LAN91_INT_ALLOC) == 0) {
<a name="l00701"></a>00701                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;maq, 125)) {
<a name="l00702"></a>00702                     <span class="keywordflow">return</span> -1;
<a name="l00703"></a>00703                 }
<a name="l00704"></a>00704             }
<a name="l00705"></a>00705         }
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/* Disable interrupts. */</span>
<a name="l00709"></a>00709     imsk = <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>);
<a name="l00710"></a>00710     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, 0);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g89ad9d8bc20edd3cb3aabcf664da6b0b" title="Bank 2 - Packet number register.">LAN91_PNR</a>, <a class="code" href="group__xg_smsc_regs.html#g18ed6304cfef871057f6bbfe72353b27">nic_inhb</a>(<a class="code" href="group__xg_nic_lan91.html#g89ad9d8bc20edd3cb3aabcf664da6b0b" title="Bank 2 - Packet number register.">LAN91_PNR</a>));
<a name="l00714"></a>00714 
<a name="l00715"></a>00715     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#gfe79991f5c429561b63a7379e479e0a0" title="Bank 2 - Pointer register.">LAN91_PTR</a>, 0x4000);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="comment">/* Transfer control word. */</span>
<a name="l00718"></a>00718     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>, 0);
<a name="l00719"></a>00719     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>, 0);
<a name="l00720"></a>00720 
<a name="l00721"></a>00721     <span class="comment">/* Transfer the byte count. */</span>
<a name="l00722"></a>00722     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>, sz);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="comment">/* Transfer the Ethernet frame. */</span>
<a name="l00725"></a>00725     NicWrite(nb-&gt;nb_dl.vp, nb-&gt;nb_dl.sz);
<a name="l00726"></a>00726     NicWrite(nb-&gt;nb_nw.vp, nb-&gt;nb_nw.sz);
<a name="l00727"></a>00727     NicWrite(nb-&gt;nb_tp.vp, nb-&gt;nb_tp.sz);
<a name="l00728"></a>00728     NicWrite(nb-&gt;nb_ap.vp, nb-&gt;nb_ap.sz);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (odd)
<a name="l00731"></a>00731         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>, 0);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="comment">/* Transfer the control word. */</span>
<a name="l00734"></a>00734     <a class="code" href="group__xg_smsc_regs.html#ga9e2892dddc57005835acbf5ffdfe232">nic_outw</a>(<a class="code" href="group__xg_nic_lan91.html#g5f79e4b2d2c13e53b93a3efc86712d90" title="Bank 2 - Data register.">LAN91_DATA</a>, 0);
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="comment">/* Enqueue packet. */</span>
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (NicMmuWait(100))
<a name="l00738"></a>00738         <span class="keywordflow">return</span> -1;
<a name="l00739"></a>00739     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#g1146a228c52ca0678b977e2646c9246f" title="Bank 2 - MMU command register.">LAN91_MMUCR</a>, <a class="code" href="group__xg_nic_lan91.html#g0eb3edfcafafc4700e18d8e88b46d14f">LAN91_MMU_ENQ</a>);
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="comment">/* Enable interrupts. */</span>
<a name="l00742"></a>00742     imsk |= LAN91_INT_TX | LAN91_INT_TX_EMPTY;
<a name="l00743"></a>00743     <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, imsk);
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     <span class="keywordflow">return</span> 0;
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 
<a name="l00753"></a><a class="code" href="group__xg_nic_lan91.html#gc4f8fdd12d77abf5e672f6cb7b7bb0ba">00753</a> <a class="code" href="thread_8h.html#9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a class="code" href="group__xg_nic_lanc111.html#gf4399dc11d6969cc10000141f3e7d0ad" title="NIC receiver thread.">NicRxLanc</a>, arg)
<a name="l00754"></a>00754 {
<a name="l00755"></a>00755     NUTDEVICE *dev;
<a name="l00756"></a>00756     IFNET *ifn;
<a name="l00757"></a>00757     <a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> *ni;
<a name="l00758"></a>00758     NETBUF *nb;
<a name="l00759"></a>00759     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> imsk;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761     dev = arg;
<a name="l00762"></a>00762     ifn = (IFNET *) dev-&gt;dev_icb;
<a name="l00763"></a>00763     ni = (<a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> *) dev-&gt;dev_dcb;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     <span class="comment">/*</span>
<a name="l00766"></a>00766 <span class="comment">     * This is a temporary hack. Due to a change in initialization,</span>
<a name="l00767"></a>00767 <span class="comment">     * we may not have got a MAC address yet. Wait until one has been</span>
<a name="l00768"></a>00768 <span class="comment">     * set.</span>
<a name="l00769"></a>00769 <span class="comment">     */</span>
<a name="l00770"></a>00770     <span class="keywordflow">for</span> (;;) {
<a name="l00771"></a>00771         <span class="keywordflow">if</span> (<a class="code" href="if__ether_8h.html#f3c3e385567f879b25cd951d752d2516" title="Determine if a given Ethernet address is a unicast address.">ETHER_IS_UNICAST</a>(ifn-&gt;if_mac)) {
<a name="l00772"></a>00772             <span class="keywordflow">break</span>;
<a name="l00773"></a>00773         }
<a name="l00774"></a>00774         <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(10);
<a name="l00775"></a>00775     }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777     <span class="comment">/*</span>
<a name="l00778"></a>00778 <span class="comment">     * Do not continue unless we managed to start the NIC. We are</span>
<a name="l00779"></a>00779 <span class="comment">     * trapped here if the Ethernet link cannot be established.</span>
<a name="l00780"></a>00780 <span class="comment">     * This happens, for example, if no Ethernet cable is plugged</span>
<a name="l00781"></a>00781 <span class="comment">     * in.</span>
<a name="l00782"></a>00782 <span class="comment">     */</span>
<a name="l00783"></a>00783     <span class="keywordflow">while</span>(NicStart(ifn-&gt;if_mac)) {
<a name="l00784"></a>00784         <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="preprocessor">#ifdef LAN91_SIGNAL</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span>    <a class="code" href="group__xg_interrupt.html#gab80f74dedb50b849fdfa92ca1f5558a" title="Modify the interrupt mode.">NutIrqSetMode</a>(&amp;<a class="code" href="lan91_8c.html#5d0d70c9f41a3fdf438eeef522e4bf20">LAN91_SIGNAL</a>, <a class="code" href="group__xg_irq_reg.html#gd2d5613d1b4bfa61f427a7beb85101ed">NUT_IRQMODE_RISINGEDGE</a>);
<a name="l00789"></a>00789     <a class="code" href="group__xg_interrupt.html#g9d27f5ecdebd2acd835df5d3d2af02f5" title="Enable a specified interrupt.">NutIrqEnable</a>(&amp;<a class="code" href="lan91_8c.html#5d0d70c9f41a3fdf438eeef522e4bf20">LAN91_SIGNAL</a>);
<a name="l00790"></a>00790 <span class="preprocessor">#endif</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span>
<a name="l00792"></a>00792     <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;mutex);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <span class="comment">/* Run at high priority. */</span>
<a name="l00795"></a>00795     <a class="code" href="group__xg_thread.html#g8ebe134e9c404072584e80fb8d7e8985" title="Set the current thread&amp;#39;s priority.">NutThreadSetPriority</a>(9);
<a name="l00796"></a>00796 
<a name="l00797"></a>00797     <span class="keywordflow">for</span> (;;) {
<a name="l00798"></a>00798         <span class="comment">/*</span>
<a name="l00799"></a>00799 <span class="comment">         * Wait for the arrival of new packets or</span>
<a name="l00800"></a>00800 <span class="comment">         * check the receiver every two second.</span>
<a name="l00801"></a>00801 <span class="comment">         */</span>
<a name="l00802"></a>00802         <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#feab7f79c7a470880c6414ca9da06951">ni_rx_rdy</a>, <a class="code" href="lan91_8c.html#cc5c87f3b20200f1e0a8cdd2da06946f">LAN91_RX_POLLTIME</a>);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804         <span class="comment">/*</span>
<a name="l00805"></a>00805 <span class="comment">         * Fetch all packets from the NIC's internal</span>
<a name="l00806"></a>00806 <span class="comment">         * buffer and pass them to the registered handler.</span>
<a name="l00807"></a>00807 <span class="comment">         */</span>
<a name="l00808"></a>00808         imsk = <a class="code" href="group__xg_smsc_regs.html#g7ad23fcbf87e5b251c6c15c3c33feecb">nic_inlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>);
<a name="l00809"></a>00809         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, 0);
<a name="l00810"></a>00810         <span class="keywordflow">while</span> ((nb = NicGetPacket()) != 0) {
<a name="l00811"></a>00811             <span class="keywordflow">if</span> (nb != (NETBUF *) 0xFFFF) {
<a name="l00812"></a>00812 <span class="preprocessor">#ifdef NUT_PERFMON</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span>                ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#c858ef9d5b524dc537c29e0526c59bd7">ni_rx_packets</a>++;
<a name="l00814"></a>00814 <span class="preprocessor">#endif</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>                (*ifn-&gt;if_recv) (dev, nb);
<a name="l00816"></a>00816             }
<a name="l00817"></a>00817         }
<a name="l00818"></a>00818         <a class="code" href="group__xg_smsc_regs.html#gdd2109a2e3569486b5218ec5762bc733">nic_outlb</a>(<a class="code" href="group__xg_nic_lan91.html#gd0a928ca55717854f97d645bb850f6cc" title="Bank 2 - Interrupt mask register.">LAN91_MSK</a>, imsk | LAN91_INT_RCV | LAN91_INT_ERCV);
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00832"></a>00832 <span class="keyword">static</span> <span class="keywordtype">int</span> Lan91Output(NUTDEVICE * dev, NETBUF * nb)
<a name="l00833"></a>00833 {
<a name="l00834"></a>00834     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> mx_wait = <a class="code" href="lan91_8c.html#2b7b4427323bcd3fe0c1b5ba4db870c5">LAN91_TX_POLLTIME</a>;
<a name="l00835"></a>00835     <span class="keywordtype">int</span> rc = -1;
<a name="l00836"></a>00836     <a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> *ni;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="comment">/*</span>
<a name="l00839"></a>00839 <span class="comment">     * After initialization we are waiting for a long time to give</span>
<a name="l00840"></a>00840 <span class="comment">     * the PHY a chance to establish an Ethernet link.</span>
<a name="l00841"></a>00841 <span class="comment">     */</span>
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (<a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;mutex, mx_wait) == 0) {
<a name="l00843"></a>00843         ni = (<a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> *) dev-&gt;dev_dcb;
<a name="l00844"></a>00844 
<a name="l00845"></a>00845         if (NicPutPacket(nb) == 0) {
<a name="l00846"></a>00846 <span class="preprocessor">#ifdef NUT_PERFMON</span>
<a name="l00847"></a>00847 <span class="preprocessor"></span>            ni-&gt;<a class="code" href="struct_n_i_c_i_n_f_o.html#4fb3fe93bc81f71cf13b9747851de06a">ni_tx_packets</a>++;
<a name="l00848"></a>00848 <span class="preprocessor">#endif</span>
<a name="l00849"></a>00849 <span class="preprocessor"></span>            rc = 0;
<a name="l00850"></a>00850             <span class="comment">/* Ethernet works. Set a long waiting time in case we</span>
<a name="l00851"></a>00851 <span class="comment">               temporarly lose the link next time. */</span>
<a name="l00852"></a>00852             mx_wait = <a class="code" href="lan91_8c.html#2b7b4427323bcd3fe0c1b5ba4db870c5">LAN91_TX_POLLTIME</a>;
<a name="l00853"></a>00853         }
<a name="l00854"></a>00854         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;mutex);
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 <span class="preprocessor">#if defined(LAN91_SIGNAL)</span>
<a name="l00857"></a>00857 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00858"></a>00858 <span class="comment">     * Probably no Ethernet link. Significantly reduce the waiting</span>
<a name="l00859"></a>00859 <span class="comment">     * time, so following transmission will soon return an error.</span>
<a name="l00860"></a>00860 <span class="comment">     */</span>
<a name="l00861"></a>00861     <span class="keywordflow">else</span> {
<a name="l00862"></a>00862         mx_wait = 500;
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864 <span class="preprocessor">#endif</span>
<a name="l00865"></a>00865 <span class="preprocessor"></span>    <span class="keywordflow">return</span> rc;
<a name="l00866"></a>00866 }
<a name="l00867"></a>00867 
<a name="l00885"></a>00885 <span class="keyword">static</span> <span class="keywordtype">int</span> Lan91Init(NUTDEVICE * dev)
<a name="l00886"></a>00886 {
<a name="l00887"></a>00887     <span class="comment">/* Disable NIC interrupt and clear NICINFO structure. */</span>
<a name="l00888"></a>00888 <span class="preprocessor">#ifdef LAN91_SIGNAL</span>
<a name="l00889"></a>00889 <span class="preprocessor"></span>    <a class="code" href="group__xg_interrupt.html#g119a2bc13dfa1a774997588dbea31130" title="Disable a specified interrupt.">NutIrqDisable</a>(&amp;<a class="code" href="lan91_8c.html#5d0d70c9f41a3fdf438eeef522e4bf20">LAN91_SIGNAL</a>);
<a name="l00890"></a>00890 <span class="preprocessor">#endif</span>
<a name="l00891"></a>00891 <span class="preprocessor"></span>    <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(dev-&gt;dev_dcb, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a>));
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="preprocessor">#ifdef LAN91_SIGNAL</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span>    <span class="comment">/* Register interrupt handler and enable interrupts. */</span>
<a name="l00895"></a>00895     <span class="keywordflow">if</span> (<a class="code" href="group__xg_interrupt.html#ga459696030a9cdf621ce3df7b3ac939d" title="Register an interrupt handler.">NutRegisterIrqHandler</a>(&amp;<a class="code" href="lan91_8c.html#5d0d70c9f41a3fdf438eeef522e4bf20">LAN91_SIGNAL</a>, NicInterrupt, dev))
<a name="l00896"></a>00896         <span class="keywordflow">return</span> -1;
<a name="l00897"></a>00897 <span class="preprocessor">#endif</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span>
<a name="l00899"></a>00899     <span class="comment">/*</span>
<a name="l00900"></a>00900 <span class="comment">     * Start the receiver thread.</span>
<a name="l00901"></a>00901 <span class="comment">     */</span>
<a name="l00902"></a>00902     <a class="code" href="group__xg_nut_arch_avr_os_context_gcc.html#g8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="stringliteral">"lan91rx"</span>, <a class="code" href="group__xg_nic_lanc111.html#gf4399dc11d6969cc10000141f3e7d0ad" title="NIC receiver thread.">NicRxLanc</a>, dev, 640);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <span class="keywordflow">return</span> 0;
<a name="l00905"></a>00905 }
<a name="l00906"></a>00906 
<a name="l00907"></a>00907 <span class="keyword">static</span> <span class="keywordtype">int</span> Lan91IOCtl(NUTDEVICE * dev, <span class="keywordtype">int</span> req, <span class="keywordtype">void</span> *conf)
<a name="l00908"></a>00908 {
<a name="l00909"></a>00909     <span class="keywordtype">int</span> rc = 0;
<a name="l00910"></a>00910     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *lvp = (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *) conf;
<a name="l00911"></a>00911     IFNET *nif = (IFNET *) dev-&gt;dev_icb;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     switch (req) {
<a name="l00914"></a>00914     <span class="keywordflow">case</span> <a class="code" href="group__xg_i_p.html#g16fd8c78df5bab66520ed3663dfc10fc" title="Set interface flags.">SIOCSIFFLAGS</a>:
<a name="l00915"></a>00915         <span class="comment">/* Set interface flags. */</span>
<a name="l00916"></a>00916         <span class="keywordflow">if</span> (*lvp &amp; <a class="code" href="if_8h.html#fe3b956069abb0a0a60c8ec1d4c13174" title="Interface is up.">IFF_UP</a>) {
<a name="l00917"></a>00917             <span class="keywordflow">if</span> ((nif-&gt;if_flags &amp; IFF_UP) == 0) {
<a name="l00918"></a>00918                 <span class="comment">/* Start interface. */</span>
<a name="l00919"></a>00919             }
<a name="l00920"></a>00920         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nif-&gt;if_flags &amp; IFF_UP) {
<a name="l00921"></a>00921             <span class="comment">/* Stop interface. */</span>
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923         <span class="keywordflow">break</span>;
<a name="l00924"></a>00924     <span class="keywordflow">case</span> <a class="code" href="group__xg_i_p.html#g2eb6d9c5e11662c1729da29fb5186eb7" title="Get interface flags.">SIOCGIFFLAGS</a>:
<a name="l00925"></a>00925         <span class="comment">/* Get interface flags. */</span>
<a name="l00926"></a>00926         *lvp = nif-&gt;if_flags;
<a name="l00927"></a>00927         <span class="keywordflow">break</span>;
<a name="l00928"></a>00928     <span class="keywordflow">case</span> <a class="code" href="group__xg_i_p.html#g3346dcad9baad294b79ddd4657baf1ac" title="Set interface address.">SIOCSIFADDR</a>:
<a name="l00929"></a>00929         <span class="comment">/* Set interface hardware address. */</span>
<a name="l00930"></a>00930         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(nif-&gt;if_mac, conf, <span class="keyword">sizeof</span>(nif-&gt;if_mac));
<a name="l00931"></a>00931         <span class="keywordflow">break</span>;
<a name="l00932"></a>00932     <span class="keywordflow">case</span> <a class="code" href="group__xg_i_p.html#gdab78d45998fbc4045e5a089f34a768a" title="Get interface address.">SIOCGIFADDR</a>:
<a name="l00933"></a>00933         <span class="comment">/* Get interface hardware address. */</span>
<a name="l00934"></a>00934         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(conf, nif-&gt;if_mac, <span class="keyword">sizeof</span>(nif-&gt;if_mac));
<a name="l00935"></a>00935         <span class="keywordflow">break</span>;
<a name="l00936"></a>00936     <span class="keywordflow">default</span>:
<a name="l00937"></a>00937         rc = -1;
<a name="l00938"></a>00938         <span class="keywordflow">break</span>;
<a name="l00939"></a>00939     }
<a name="l00940"></a>00940     <span class="keywordflow">return</span> rc;
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943 <span class="keyword">static</span> <a class="code" href="struct_n_i_c_i_n_f_o.html">NICINFO</a> dcb_eth0;
<a name="l00944"></a>00944 
<a name="l00950"></a>00950 <span class="keyword">static</span> IFNET ifn_eth0 = {
<a name="l00951"></a>00951     <a class="code" href="if__types_8h.html#e4eb2208d7f67fefe11586dd32cb1bcc" title="Ethernet interface.">IFT_ETHER</a>,          
<a name="l00952"></a>00952     0,                  
<a name="l00953"></a>00953     {0, 0, 0, 0, 0, 0}, 
<a name="l00954"></a>00954     0,                  
<a name="l00955"></a>00955     0,                  
<a name="l00956"></a>00956     0,                  
<a name="l00957"></a>00957     <a class="code" href="if__ether_8h.html#4baa77b0245fb4398faaecfc9b803649" title="Ethernet maximum transfer unit.">ETHERMTU</a>,           
<a name="l00958"></a>00958     0,                  
<a name="l00959"></a>00959     0,                  
<a name="l00960"></a>00960     0,                  
<a name="l00961"></a>00961     <a class="code" href="group__xg_ethernet.html#g99fa1136157a0400962096b3e426ee2f" title="Handle incoming Ethernet frames.">NutEtherInput</a>,      
<a name="l00962"></a>00962     Lan91Output,        
<a name="l00963"></a>00963     <a class="code" href="group__xg_ethernet.html#g5342e8b68b9af648aa943a9a9166099b" title="Send Ethernet frame.">NutEtherOutput</a>,     
<a name="l00964"></a>00964     NULL                
<a name="l00965"></a>00965 };
<a name="l00966"></a>00966 
<a name="l00976"></a><a class="code" href="group__xg_nic_lan91.html#g815e799d28f901911532702c0803ac33">00976</a> NUTDEVICE <a class="code" href="group__xg_nic_lan91.html#g815e799d28f901911532702c0803ac33" title="Device information structure.">devLan91</a> = {
<a name="l00977"></a>00977     0,          <span class="comment">/* Pointer to next device. */</span>
<a name="l00978"></a>00978     {<span class="charliteral">'e'</span>, <span class="charliteral">'t'</span>, <span class="charliteral">'h'</span>, <span class="charliteral">'0'</span>, 0, 0, 0, 0, 0},        <span class="comment">/* Unique device name. */</span>
<a name="l00979"></a>00979     <a class="code" href="group__xg_device.html#ga3f88c08759f21a3a876721fd184d0ba" title="Net device.">IFTYP_NET</a>,  <span class="comment">/* Type of device. */</span>
<a name="l00980"></a>00980     0,          <span class="comment">/* Base address. */</span>
<a name="l00981"></a>00981     0,          <span class="comment">/* First interrupt number. */</span>
<a name="l00982"></a>00982     &amp;ifn_eth0,  <span class="comment">/* Interface control block. */</span>
<a name="l00983"></a>00983     &amp;dcb_eth0,  <span class="comment">/* Driver control block. */</span>
<a name="l00984"></a>00984     Lan91Init,  <span class="comment">/* Driver initialization routine. */</span>
<a name="l00985"></a>00985     Lan91IOCtl, <span class="comment">/* Driver specific control function. */</span>
<a name="l00986"></a>00986     0,          <span class="comment">/* Read from device. */</span>
<a name="l00987"></a>00987     0,          <span class="comment">/* Write to device. */</span>
<a name="l00988"></a>00988 <span class="preprocessor">#ifdef __HARVARD_ARCH__</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>    0,          <span class="comment">/* Write from program space data to device. */</span>
<a name="l00990"></a>00990 <span class="preprocessor">#endif</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span>    0,          <span class="comment">/* Open a device or file. */</span>
<a name="l00992"></a>00992     0,          <span class="comment">/* Close a device or file. */</span>
<a name="l00993"></a>00993     0           <span class="comment">/* Request file size. */</span>
<a name="l00994"></a>00994 };
<a name="l00995"></a>00995 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
