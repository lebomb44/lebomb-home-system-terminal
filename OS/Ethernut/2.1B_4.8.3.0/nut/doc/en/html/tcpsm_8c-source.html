<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_eceb8d165fbe8f9d6166a1183f1e74d1.html">net</a>
  </div>
<div class="contents">
<h1>tcpsm.c</h1><a href="tcpsm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2007 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * -</span>
<a name="l00033"></a>00033 <span class="comment"> * Portions Copyright (C) 2000 David J. Hudson &lt;dave@humbug.demon.co.uk&gt;</span>
<a name="l00034"></a>00034 <span class="comment"> *</span>
<a name="l00035"></a>00035 <span class="comment"> * This file is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00036"></a>00036 <span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00037"></a>00037 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE.</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * You can redistribute this file and/or modify it under the terms of the GNU</span>
<a name="l00040"></a>00040 <span class="comment"> * General Public License (GPL) as published by the Free Software Foundation;</span>
<a name="l00041"></a>00041 <span class="comment"> * either version 2 of the License, or (at your discretion) any later version.</span>
<a name="l00042"></a>00042 <span class="comment"> * See the accompanying file "copying-gpl.txt" for more details.</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * As a special exception to the GPL, permission is granted for additional</span>
<a name="l00045"></a>00045 <span class="comment"> * uses of the text contained in this file.  See the accompanying file</span>
<a name="l00046"></a>00046 <span class="comment"> * "copying-liquorice.txt" for details.</span>
<a name="l00047"></a>00047 <span class="comment"> * -</span>
<a name="l00048"></a>00048 <span class="comment"> * Portions Copyright (c) 1983, 1993 by</span>
<a name="l00049"></a>00049 <span class="comment"> *  The Regents of the University of California.  All rights reserved.</span>
<a name="l00050"></a>00050 <span class="comment"> *</span>
<a name="l00051"></a>00051 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00052"></a>00052 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00053"></a>00053 <span class="comment"> * are met:</span>
<a name="l00054"></a>00054 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00055"></a>00055 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00056"></a>00056 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00057"></a>00057 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00058"></a>00058 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00059"></a>00059 <span class="comment"> * 3. Neither the name of the University nor the names of its contributors</span>
<a name="l00060"></a>00060 <span class="comment"> *    may be used to endorse or promote products derived from this software</span>
<a name="l00061"></a>00061 <span class="comment"> *    without specific prior written permission.</span>
<a name="l00062"></a>00062 <span class="comment"> *</span>
<a name="l00063"></a>00063 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND</span>
<a name="l00064"></a>00064 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00065"></a>00065 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00066"></a>00066 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<a name="l00067"></a>00067 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a name="l00068"></a>00068 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<a name="l00069"></a>00069 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<a name="l00070"></a>00070 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00071"></a>00071 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<a name="l00072"></a>00072 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00073"></a>00073 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00074"></a>00074 <span class="comment"> * -</span>
<a name="l00075"></a>00075 <span class="comment"> * Portions Copyright (c) 1993 by Digital Equipment Corporation.</span>
<a name="l00076"></a>00076 <span class="comment"> *</span>
<a name="l00077"></a>00077 <span class="comment"> * Permission to use, copy, modify, and distribute this software for any</span>
<a name="l00078"></a>00078 <span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span>
<a name="l00079"></a>00079 <span class="comment"> * copyright notice and this permission notice appear in all copies, and that</span>
<a name="l00080"></a>00080 <span class="comment"> * the name of Digital Equipment Corporation not be used in advertising or</span>
<a name="l00081"></a>00081 <span class="comment"> * publicity pertaining to distribution of the document or software without</span>
<a name="l00082"></a>00082 <span class="comment"> * specific, written prior permission.</span>
<a name="l00083"></a>00083 <span class="comment"> * </span>
<a name="l00084"></a>00084 <span class="comment"> * THE SOFTWARE IS PROVIDED "AS IS" AND DIGITAL EQUIPMENT CORP. DISCLAIMS ALL</span>
<a name="l00085"></a>00085 <span class="comment"> * WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES</span>
<a name="l00086"></a>00086 <span class="comment"> * OF MERCHANTABILITY AND FITNESS.   IN NO EVENT SHALL DIGITAL EQUIPMENT</span>
<a name="l00087"></a>00087 <span class="comment"> * CORPORATION BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL</span>
<a name="l00088"></a>00088 <span class="comment"> * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR</span>
<a name="l00089"></a>00089 <span class="comment"> * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS</span>
<a name="l00090"></a>00090 <span class="comment"> * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
<a name="l00091"></a>00091 <span class="comment"> * SOFTWARE.</span>
<a name="l00092"></a>00092 <span class="comment"> */</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="comment">/*</span>
<a name="l00095"></a>00095 <span class="comment"> * $Log$</span>
<a name="l00096"></a>00096 <span class="comment"> * Revision 1.29  2009/02/22 12:30:36  olereinhardt</span>
<a name="l00097"></a>00097 <span class="comment"> * Include "include/errno.h" instead of "include/net/errno.h"</span>
<a name="l00098"></a>00098 <span class="comment"> *</span>
<a name="l00099"></a>00099 <span class="comment"> * Revision 1.28  2009/02/06 15:37:40  haraldkipp</span>
<a name="l00100"></a>00100 <span class="comment"> * Added stack space multiplier and addend. Adjusted stack space.</span>
<a name="l00101"></a>00101 <span class="comment"> *</span>
<a name="l00102"></a>00102 <span class="comment"> * Revision 1.27  2009/01/17 11:26:51  haraldkipp</span>
<a name="l00103"></a>00103 <span class="comment"> * Getting rid of two remaining BSD types in favor of stdint.</span>
<a name="l00104"></a>00104 <span class="comment"> * Replaced 'u_int' by 'unsinged int' and 'uptr_t' by 'uintptr_t'.</span>
<a name="l00105"></a>00105 <span class="comment"> *</span>
<a name="l00106"></a>00106 <span class="comment"> * Revision 1.26  2008/08/11 07:00:32  haraldkipp</span>
<a name="l00107"></a>00107 <span class="comment"> * BSD types replaced by stdint types (feature request #1282721).</span>
<a name="l00108"></a>00108 <span class="comment"> *</span>
<a name="l00109"></a>00109 <span class="comment"> * Revision 1.25  2008/07/27 11:43:22  haraldkipp</span>
<a name="l00110"></a>00110 <span class="comment"> * Configurable TCP retransmissions.</span>
<a name="l00111"></a>00111 <span class="comment"> *</span>
<a name="l00112"></a>00112 <span class="comment"> * Revision 1.24  2008/04/06 13:29:01  haraldkipp</span>
<a name="l00113"></a>00113 <span class="comment"> * In unreliable or high traffic networks connections may suddenly freeze.</span>
<a name="l00114"></a>00114 <span class="comment"> * The problem is, that during overflows (happening every 65s) the</span>
<a name="l00115"></a>00115 <span class="comment"> * retransmission timer may be loaded with 0, which in turn disables all</span>
<a name="l00116"></a>00116 <span class="comment"> * outstanding retransmission. Applied fix contributed by Henrik Maier.</span>
<a name="l00117"></a>00117 <span class="comment"> *</span>
<a name="l00118"></a>00118 <span class="comment"> * Revision 1.23  2007/02/15 15:59:59  haraldkipp</span>
<a name="l00119"></a>00119 <span class="comment"> * Serious bug in the TCP state machine froze socket connection on 32-bit</span>
<a name="l00120"></a>00120 <span class="comment"> * platforms.</span>
<a name="l00121"></a>00121 <span class="comment"> *</span>
<a name="l00122"></a>00122 <span class="comment"> * Revision 1.22  2006/10/05 17:25:41  haraldkipp</span>
<a name="l00123"></a>00123 <span class="comment"> * Avoid possible alignment errors. Fixes bug #1567748.</span>
<a name="l00124"></a>00124 <span class="comment"> *</span>
<a name="l00125"></a>00125 <span class="comment"> * Revision 1.21  2006/05/15 12:49:12  haraldkipp</span>
<a name="l00126"></a>00126 <span class="comment"> * ICCAVR doesn't accept void pointer calculation.</span>
<a name="l00127"></a>00127 <span class="comment"> *</span>
<a name="l00128"></a>00128 <span class="comment"> * Revision 1.20  2006/03/21 21:22:19  drsung</span>
<a name="l00129"></a>00129 <span class="comment"> * Enhancement made to TCP state machine. Now TCP options</span>
<a name="l00130"></a>00130 <span class="comment"> * are read from peer and at least the maximum segment size is stored.</span>
<a name="l00131"></a>00131 <span class="comment"> *</span>
<a name="l00132"></a>00132 <span class="comment"> * Revision 1.19  2005/04/30 16:42:42  chaac</span>
<a name="l00133"></a>00133 <span class="comment"> * Fixed bug in handling of NUTDEBUG. Added include for cfg/os.h. If NUTDEBUG</span>
<a name="l00134"></a>00134 <span class="comment"> * is defined in NutConf, it will make effect where it is used.</span>
<a name="l00135"></a>00135 <span class="comment"> *</span>
<a name="l00136"></a>00136 <span class="comment"> * Revision 1.18  2005/04/05 17:44:57  haraldkipp</span>
<a name="l00137"></a>00137 <span class="comment"> * Made stack space configurable.</span>
<a name="l00138"></a>00138 <span class="comment"> *</span>
<a name="l00139"></a>00139 <span class="comment"> * Revision 1.17  2005/03/30 15:17:58  mrjones4u</span>
<a name="l00140"></a>00140 <span class="comment"> * Defussed race condition in NutTcpStateActiveOpenEvent where the NutEventWait would be called after sock-&gt;so_ac_tq had been signaled and therefore the calling thread will hang due to usage of NutEventBroadcast which will not ‘store’ the signaled state. This condition can e.g. occur when attempting connection an unconnected target port on an active host. The returning RST would be processed and signaled before the NutEventWait is called.</span>
<a name="l00141"></a>00141 <span class="comment"> *</span>
<a name="l00142"></a>00142 <span class="comment"> * Revision 1.16  2005/02/04 17:17:49  haraldkipp</span>
<a name="l00143"></a>00143 <span class="comment"> * Unused include files removed.</span>
<a name="l00144"></a>00144 <span class="comment"> *</span>
<a name="l00145"></a>00145 <span class="comment"> * Revision 1.15  2005/01/21 16:49:46  freckle</span>
<a name="l00146"></a>00146 <span class="comment"> * Seperated calls to NutEventPostAsync between Threads and IRQs</span>
<a name="l00147"></a>00147 <span class="comment"> *</span>
<a name="l00148"></a>00148 <span class="comment"> * Revision 1.14  2005/01/03 08:43:29  haraldkipp</span>
<a name="l00149"></a>00149 <span class="comment"> * Replaced unprotected calls to NutEventPostAsync() by late calls to NutEventPost().</span>
<a name="l00150"></a>00150 <span class="comment"> * This should fix the infrequent system halts/resets. The event to the transmitter</span>
<a name="l00151"></a>00151 <span class="comment"> * waiting queue will be broadcasted on relevant state changes.</span>
<a name="l00152"></a>00152 <span class="comment"> *</span>
<a name="l00153"></a>00153 <span class="comment"> * Revision 1.13  2004/07/30 19:54:46  drsung</span>
<a name="l00154"></a>00154 <span class="comment"> * Some code of TCP stack redesigned. Round trip time calculation is now</span>
<a name="l00155"></a>00155 <span class="comment"> * supported. Fixed several bugs in TCP state machine. Now TCP connections</span>
<a name="l00156"></a>00156 <span class="comment"> * should be more reliable under heavy traffic or poor physical connections.</span>
<a name="l00157"></a>00157 <span class="comment"> *</span>
<a name="l00158"></a>00158 <span class="comment"> * Revision 1.12  2004/04/15 11:08:21  haraldkipp</span>
<a name="l00159"></a>00159 <span class="comment"> * Bugfix: Sequence number had not been incremented on FIN segments.</span>
<a name="l00160"></a>00160 <span class="comment"> * Added Realtek hack to reduce concurrent connection problems.</span>
<a name="l00161"></a>00161 <span class="comment"> * Rely on TCP output to set the retransmission timer.</span>
<a name="l00162"></a>00162 <span class="comment"> *</span>
<a name="l00163"></a>00163 <span class="comment"> * Revision 1.11  2004/02/28 20:14:38  drsung</span>
<a name="l00164"></a>00164 <span class="comment"> * Merge from nut-3_4-release b/c of bugfixes.</span>
<a name="l00165"></a>00165 <span class="comment"> *</span>
<a name="l00166"></a>00166 <span class="comment"> * Revision 1.9.2.1  2004/02/28 20:02:23  drsung</span>
<a name="l00167"></a>00167 <span class="comment"> * Bugfix in several tcp state functions. Swapped around the check</span>
<a name="l00168"></a>00168 <span class="comment"> * for ACK and SYN flag. Because initial SYN packets don't have</span>
<a name="l00169"></a>00169 <span class="comment"> * an ACK flag, recevied SYN packets were never rejected.</span>
<a name="l00170"></a>00170 <span class="comment"> * Thanks to Damian Slee, who discovered that.</span>
<a name="l00171"></a>00171 <span class="comment"> *</span>
<a name="l00172"></a>00172 <span class="comment"> * Revision 1.9  2004/01/25 11:50:03  drsung</span>
<a name="l00173"></a>00173 <span class="comment"> * setting correct error code on timeout while NutTcpConnect.</span>
<a name="l00174"></a>00174 <span class="comment"> *</span>
<a name="l00175"></a>00175 <span class="comment"> * Revision 1.8  2004/01/25 11:29:48  drsung</span>
<a name="l00176"></a>00176 <span class="comment"> * bugfix for connection establishing.</span>
<a name="l00177"></a>00177 <span class="comment"> *</span>
<a name="l00178"></a>00178 <span class="comment"> * Revision 1.7  2004/01/14 19:35:19  drsung</span>
<a name="l00179"></a>00179 <span class="comment"> * New TCP output buffer handling and fixed not starting retransmission timer for NutTcpConnect.</span>
<a name="l00180"></a>00180 <span class="comment"> *</span>
<a name="l00181"></a>00181 <span class="comment"> * Revision 1.6  2003/11/28 19:49:58  haraldkipp</span>
<a name="l00182"></a>00182 <span class="comment"> * TCP connections suddenly drop during transmission.</span>
<a name="l00183"></a>00183 <span class="comment"> * Bug in retransmission timer fixed.</span>
<a name="l00184"></a>00184 <span class="comment"> *</span>
<a name="l00185"></a>00185 <span class="comment"> * Revision 1.5  2003/11/04 17:57:35  haraldkipp</span>
<a name="l00186"></a>00186 <span class="comment"> * Bugfix: Race condition left socket in close-wait state</span>
<a name="l00187"></a>00187 <span class="comment"> *</span>
<a name="l00188"></a>00188 <span class="comment"> * Revision 1.4  2003/11/03 16:48:02  haraldkipp</span>
<a name="l00189"></a>00189 <span class="comment"> * Use the system timer for retransmission timouts</span>
<a name="l00190"></a>00190 <span class="comment"> *</span>
<a name="l00191"></a>00191 <span class="comment"> * Revision 1.3  2003/08/14 15:10:31  haraldkipp</span>
<a name="l00192"></a>00192 <span class="comment"> * Two bugfixes: 1. NutTcpAccept fails if caller got higher priority.</span>
<a name="l00193"></a>00193 <span class="comment"> * 2. Incoming TCP NETBUFs will never be released if TCP is not used by</span>
<a name="l00194"></a>00194 <span class="comment"> * the application.</span>
<a name="l00195"></a>00195 <span class="comment"> *</span>
<a name="l00196"></a>00196 <span class="comment"> * Revision 1.2  2003/07/13 19:22:23  haraldkipp</span>
<a name="l00197"></a>00197 <span class="comment"> * TCP transfer speed increased by changing the character receive buffer</span>
<a name="l00198"></a>00198 <span class="comment"> * in TCPSOCKET to a NETBUF queue. (More confusing diff lines by using</span>
<a name="l00199"></a>00199 <span class="comment"> * indent, sorry.)</span>
<a name="l00200"></a>00200 <span class="comment"> *</span>
<a name="l00201"></a>00201 <span class="comment"> * Revision 1.1.1.1  2003/05/09 14:41:42  haraldkipp</span>
<a name="l00202"></a>00202 <span class="comment"> * Initial using 3.2.1</span>
<a name="l00203"></a>00203 <span class="comment"> *</span>
<a name="l00204"></a>00204 <span class="comment"> * Revision 1.20  2003/05/06 18:20:02  harald</span>
<a name="l00205"></a>00205 <span class="comment"> * Stack size reduced</span>
<a name="l00206"></a>00206 <span class="comment"> *</span>
<a name="l00207"></a>00207 <span class="comment"> * Revision 1.19  2003/04/01 18:36:11  harald</span>
<a name="l00208"></a>00208 <span class="comment"> * Added forced ACK response on same sequence</span>
<a name="l00209"></a>00209 <span class="comment"> *</span>
<a name="l00210"></a>00210 <span class="comment"> * Revision 1.18  2003/03/31 12:29:45  harald</span>
<a name="l00211"></a>00211 <span class="comment"> * Check NEBUF allocation</span>
<a name="l00212"></a>00212 <span class="comment"> *</span>
<a name="l00213"></a>00213 <span class="comment"> * Revision 1.17  2003/02/04 18:14:57  harald</span>
<a name="l00214"></a>00214 <span class="comment"> * Version 3 released</span>
<a name="l00215"></a>00215 <span class="comment"> *</span>
<a name="l00216"></a>00216 <span class="comment"> * Revision 1.16  2003/01/14 16:51:29  harald</span>
<a name="l00217"></a>00217 <span class="comment"> * Handle possible deadlock in the TCP state machine in low memory situations.</span>
<a name="l00218"></a>00218 <span class="comment"> * Fixed: TCP might fail to process incoming packets on slow connections.</span>
<a name="l00219"></a>00219 <span class="comment"> *</span>
<a name="l00220"></a>00220 <span class="comment"> * Revision 1.15  2002/09/15 17:05:41  harald</span>
<a name="l00221"></a>00221 <span class="comment"> * Silently ignore late SYNs.</span>
<a name="l00222"></a>00222 <span class="comment"> * Detect host down in local networks during connect.</span>
<a name="l00223"></a>00223 <span class="comment"> * Avoid re-sending packets too soon.</span>
<a name="l00224"></a>00224 <span class="comment"> *</span>
<a name="l00225"></a>00225 <span class="comment"> * Revision 1.14  2002/09/03 17:42:20  harald</span>
<a name="l00226"></a>00226 <span class="comment"> * Buffer sequences received in advance</span>
<a name="l00227"></a>00227 <span class="comment"> *</span>
<a name="l00228"></a>00228 <span class="comment"> * Revision 1.13  2002/08/16 17:54:56  harald</span>
<a name="l00229"></a>00229 <span class="comment"> * Count out of sequence drops</span>
<a name="l00230"></a>00230 <span class="comment"> *</span>
<a name="l00231"></a>00231 <span class="comment"> * Revision 1.12  2002/06/26 17:29:36  harald</span>
<a name="l00232"></a>00232 <span class="comment"> * First pre-release with 2.4 stack</span>
<a name="l00233"></a>00233 <span class="comment"> *</span>
<a name="l00234"></a>00234 <span class="comment"> */</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 <span class="preprocessor">#include &lt;<a class="code" href="os_8h.html">cfg/os.h</a>&gt;</span>
<a name="l00237"></a>00237 <span class="preprocessor">#include &lt;<a class="code" href="cfg_2tcp_8h.html" title="TCP configuration.">cfg/tcp.h</a>&gt;</span>
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00240"></a>00240 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00241"></a>00241 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00242"></a>00242 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00243"></a>00243 
<a name="l00244"></a>00244 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00245"></a>00245 <span class="preprocessor">#include &lt;<a class="code" href="in_8h.html" title="Internet definitions.">netinet/in.h</a>&gt;</span>
<a name="l00246"></a>00246 <span class="preprocessor">#include &lt;<a class="code" href="netinet_2ip_8h.html" title="Definitions for internet protocol version 4.">netinet/ip.h</a>&gt;</span>
<a name="l00247"></a>00247 <span class="preprocessor">#include &lt;<a class="code" href="route_8h.html" title="Routing information definitions.">net/route.h</a>&gt;</span>
<a name="l00248"></a>00248 <span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html" title="UDP and TCP socket interface definitions.">sys/socket.h</a>&gt;</span>
<a name="l00249"></a>00249 <span class="preprocessor">#include &lt;<a class="code" href="tcputil_8h.html" title="TCP utility function prototypes.">netinet/tcputil.h</a>&gt;</span>
<a name="l00250"></a>00250 <span class="preprocessor">#include &lt;<a class="code" href="netinet_2tcp_8h.html" title="TCP protocol definitions.">netinet/tcp.h</a>&gt;</span>
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="netdebug_8h.html">net/netdebug.h</a>&gt;</span>
<a name="l00254"></a>00254 <span class="preprocessor">#endif</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span>
<a name="l00256"></a>00256 <span class="preprocessor">#ifndef NUT_THREAD_TCPSMSTACK</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#if defined(__AVR__)</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#if defined(__GNUC__)</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="comment">/* avr-gcc size optimized code used 148 bytes. */</span>
<a name="l00260"></a>00260 <span class="preprocessor">#define NUT_THREAD_TCPSMSTACK   256</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span><span class="comment">/* icc-avr v7.19 used 312 bytes. */</span>
<a name="l00263"></a>00263 <span class="preprocessor">#define NUT_THREAD_TCPSMSTACK   512</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="comment">/* arm-elf-gcc used 260 bytes with size optimized, 644 bytes with debug code. */</span>
<a name="l00267"></a><a class="code" href="tcpsm_8c.html#2dd57271cab4df50fc83070235b1f57f">00267</a> <span class="preprocessor">#define NUT_THREAD_TCPSMSTACK   384</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span>
<a name="l00271"></a>00271 <span class="preprocessor">#ifndef TCP_RETRIES_MAX</span>
<a name="l00272"></a><a class="code" href="tcpsm_8c.html#ae70ed2330837b5d6ff3cb78d59e0595">00272</a> <span class="preprocessor"></span><span class="preprocessor">#define TCP_RETRIES_MAX         7</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>
<a name="l00275"></a>00275 <span class="keyword">extern</span> TCPSOCKET *<a class="code" href="group__xg_tcp_socket.html#g2fcec3521061173b7bdd704877a57395">tcpSocketList</a>;
<a name="l00276"></a>00276 
<a name="l00281"></a>00281 
<a name="l00282"></a><a class="code" href="group__xg_t_c_p.html#ge222ee1ca91575390b1c8eb98272b8c3">00282</a> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> <a class="code" href="group__xg_t_c_p.html#ge222ee1ca91575390b1c8eb98272b8c3">tcp_in_rdy</a>;
<a name="l00283"></a><a class="code" href="group__xg_t_c_p.html#g08e37e1f12909836bf31c91360e6fa7f">00283</a> NETBUF *<span class="keyword">volatile</span> <a class="code" href="group__xg_t_c_p.html#g08e37e1f12909836bf31c91360e6fa7f">tcp_in_nbq</a>;
<a name="l00284"></a>00284 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> tcp_in_cnt;
<a name="l00285"></a>00285 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> tcpThread = 0;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="comment">/* ================================================================</span>
<a name="l00288"></a>00288 <span class="comment"> * Helper functions</span>
<a name="l00289"></a>00289 <span class="comment"> * ================================================================</span>
<a name="l00290"></a>00290 <span class="comment"> */</span>
<a name="l00291"></a>00291 
<a name="l00300"></a>00300 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpInputOptions(TCPSOCKET * sock, NETBUF * nb)
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *cp;
<a name="l00303"></a>00303     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> s;
<a name="l00304"></a>00304     
<a name="l00305"></a>00305     <span class="comment">/* any options there? */</span>
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (nb-&gt;nb_tp.sz &lt;= sizeof (<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a>))
<a name="l00307"></a>00307         <span class="keywordflow">return</span>;
<a name="l00308"></a>00308     
<a name="l00309"></a>00309     <span class="comment">/* loop through available options */</span>
<a name="l00310"></a>00310     <span class="keywordflow">for</span> (cp = ((<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>*) nb-&gt;nb_tp.vp) + <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a>); (*cp != <a class="code" href="netinet_2tcp_8h.html#49d47a2de46ce98ea1531499f0cb810e" title="End of options.">TCPOPT_EOL</a>) 
<a name="l00311"></a>00311        &amp;&amp; (cp - (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *)nb-&gt;nb_tp.vp &lt; (<span class="keywordtype">int</span>)nb-&gt;nb_tp.sz); )
<a name="l00312"></a>00312     {
<a name="l00313"></a>00313         <span class="keywordflow">switch</span> (*cp)
<a name="l00314"></a>00314         {
<a name="l00315"></a>00315             <span class="comment">/* On NOP just proceed to next option */</span>
<a name="l00316"></a>00316             <span class="keywordflow">case</span> <a class="code" href="netinet_2tcp_8h.html#cd72ee3d812fc1c152cacff6850be664" title="Nothing.">TCPOPT_NOP</a>:
<a name="l00317"></a>00317                 cp++;
<a name="l00318"></a>00318                 <span class="keywordflow">continue</span>;
<a name="l00319"></a>00319                 
<a name="l00320"></a>00320             <span class="comment">/* Read MAXSEG option */</span>
<a name="l00321"></a>00321             <span class="keywordflow">case</span> <a class="code" href="netinet_2tcp_8h.html#4b5d06a220aa36a996fcc0b6639e09a5" title="Maximum segment size.">TCPOPT_MAXSEG</a>:
<a name="l00322"></a>00322                 s = <a class="code" href="group__xg_nut_o_s.html#gda37feda716b4ba89cf9dba34288141d" title="Convert short value from network to host byte order.">ntohs</a>(((<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>)cp[2] &lt;&lt; 8) | cp[3]);
<a name="l00323"></a>00323                 <span class="keywordflow">if</span> (s &lt; sock-&gt;so_mss)
<a name="l00324"></a>00324                     sock-&gt;so_mss = s;
<a name="l00325"></a>00325                 cp += <a class="code" href="netinet_2tcp_8h.html#66056a105a2ca36fcd1a0740a8eb888e" title="Maximum segment size length.">TCPOLEN_MAXSEG</a>;
<a name="l00326"></a>00326                 <span class="keywordflow">break</span>;
<a name="l00327"></a>00327             <span class="comment">/* Ignore any other options */</span>
<a name="l00328"></a>00328             <span class="keywordflow">default</span>:
<a name="l00329"></a>00329                 cp += *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>*) (cp + 1);
<a name="l00330"></a>00330                 <span class="keywordflow">break</span>;
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00343"></a>00343 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpProcessAppData(TCPSOCKET * sock, NETBUF * nb)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     <span class="comment">/*</span>
<a name="l00346"></a>00346 <span class="comment">     * Add the NETBUF to the socket's input buffer.</span>
<a name="l00347"></a>00347 <span class="comment">     */</span>
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (sock-&gt;so_rx_buf) {
<a name="l00349"></a>00349         NETBUF *nbp = sock-&gt;so_rx_buf;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="keywordflow">while</span> (nbp-&gt;nb_next)
<a name="l00352"></a>00352             nbp = nbp-&gt;nb_next;
<a name="l00353"></a>00353         nbp-&gt;nb_next = nb;
<a name="l00354"></a>00354     } <span class="keywordflow">else</span>
<a name="l00355"></a>00355         sock-&gt;so_rx_buf = nb;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="comment">/*</span>
<a name="l00358"></a>00358 <span class="comment">     * Update the number of bytes available in the socket's input buffer</span>
<a name="l00359"></a>00359 <span class="comment">     * and the sequence number we expect next.</span>
<a name="l00360"></a>00360 <span class="comment">     */</span>
<a name="l00361"></a>00361     sock-&gt;so_rx_cnt += nb-&gt;nb_ap.sz;
<a name="l00362"></a>00362     sock-&gt;so_rx_nxt += nb-&gt;nb_ap.sz;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     <span class="comment">/*</span>
<a name="l00365"></a>00365 <span class="comment">     * Reduce our TCP window size.</span>
<a name="l00366"></a>00366 <span class="comment">     */</span>
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (nb-&gt;nb_ap.sz &gt;= sock-&gt;so_rx_win)
<a name="l00368"></a>00368         sock-&gt;so_rx_win = 0;
<a name="l00369"></a>00369     <span class="keywordflow">else</span>
<a name="l00370"></a>00370         sock-&gt;so_rx_win -= nb-&gt;nb_ap.sz;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="comment">/*</span>
<a name="l00373"></a>00373 <span class="comment">     * Set the socket's ACK flag. This will enable ACK transmission in</span>
<a name="l00374"></a>00374 <span class="comment">     * the next outgoing segment. If no more NETBUFs are queued, we</span>
<a name="l00375"></a>00375 <span class="comment">     * force immediate transmission of the ACK.</span>
<a name="l00376"></a>00376 <span class="comment">     */</span>
<a name="l00377"></a>00377     sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>;
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (nb-&gt;nb_next)
<a name="l00379"></a>00379         nb-&gt;nb_next = 0;
<a name="l00380"></a>00380     <span class="keywordflow">else</span>
<a name="l00381"></a>00381         sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0);
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">/*</span>
<a name="l00387"></a>00387 <span class="comment"> * \param sock Socket descriptor.</span>
<a name="l00388"></a>00388 <span class="comment"> */</span>
<a name="l00389"></a>00389 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpProcessSyn(TCPSOCKET * sock, IPHDR * ih, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th)
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> mss;
<a name="l00392"></a>00392     NUTDEVICE *dev;
<a name="l00393"></a>00393     IFNET *nif;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     sock-&gt;so_local_addr = ih-&gt;ip_dst;
<a name="l00396"></a>00396     sock-&gt;so_remote_port = th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#9ac07bf8feede24316ce6872b8cc9dcb" title="Source port.">th_sport</a>;
<a name="l00397"></a>00397     sock-&gt;so_remote_addr = ih-&gt;ip_src;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     sock-&gt;so_rx_nxt = sock-&gt;so_tx_wl1 = sock-&gt;so_rx_isn = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>);
<a name="l00400"></a>00400     sock-&gt;so_rx_nxt++;
<a name="l00401"></a>00401     sock-&gt;so_tx_win = <a class="code" href="group__xg_nut_o_s.html#gda37feda716b4ba89cf9dba34288141d" title="Convert short value from network to host byte order.">ntohs</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#a2f3bcd44b55f8732112963f3ef19e1f" title="Number of acceptable octects.">th_win</a>);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">/*</span>
<a name="l00404"></a>00404 <span class="comment">     * To avoid unnecessary fragmentation, limit the</span>
<a name="l00405"></a>00405 <span class="comment">     * maximum segment size to the maximum transfer</span>
<a name="l00406"></a>00406 <span class="comment">     * unit of our interface.</span>
<a name="l00407"></a>00407 <span class="comment">     */</span>
<a name="l00408"></a>00408     <span class="keywordflow">if</span> ((dev = <a class="code" href="group__xg_i_p.html#g2534f1918ba2a63523659fc005344b25" title="Find a device associated with a particular IP route.">NutIpRouteQuery</a>(ih-&gt;ip_src, 0)) != 0) {
<a name="l00409"></a>00409         nif = dev-&gt;dev_icb;
<a name="l00410"></a>00410         mss = nif-&gt;if_mtu - <span class="keyword">sizeof</span>(IPHDR) - <span class="keyword">sizeof</span>(<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a>);
<a name="l00411"></a>00411         <span class="keywordflow">if</span> (sock-&gt;so_mss == 0 || sock-&gt;so_mss &gt; mss)
<a name="l00412"></a>00412             sock-&gt;so_mss = mss;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414         <span class="comment">/* Limit output buffer size to mms */</span>
<a name="l00415"></a>00415         <span class="keywordflow">if</span> (sock-&gt;so_devobsz &gt; sock-&gt;so_mss)
<a name="l00416"></a>00416             sock-&gt;so_devobsz = sock-&gt;so_mss;
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00427"></a>00427 <span class="keyword">static</span> <span class="keywordtype">int</span> NutTcpProcessAck(TCPSOCKET * sock, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> length)
<a name="l00428"></a>00428 {
<a name="l00429"></a>00429     NETBUF *nb;
<a name="l00430"></a>00430     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> h_seq;
<a name="l00431"></a>00431     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> h_ack;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <span class="comment">/*</span>
<a name="l00434"></a>00434 <span class="comment">     * If remote acked something not yet send, reply immediately.</span>
<a name="l00435"></a>00435 <span class="comment">     */</span>
<a name="l00436"></a>00436     h_ack = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#49e29d973cc4b0d4bddfdf027550fb5f" title="Expected sequence number of next octet.">th_ack</a>);
<a name="l00437"></a>00437     <span class="keywordflow">if</span> (h_ack &gt; sock-&gt;so_tx_nxt) {
<a name="l00438"></a>00438         sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00439"></a>00439         <span class="keywordflow">return</span> 0;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment">/*</span>
<a name="l00443"></a>00443 <span class="comment">     * If the new sequence number or acknowledged sequence number</span>
<a name="l00444"></a>00444 <span class="comment">     * is above our last update, we adjust our transmit window.</span>
<a name="l00445"></a>00445 <span class="comment">     * Avoid dupe ACK processing on window updates.</span>
<a name="l00446"></a>00446 <span class="comment">     */</span>
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (h_ack == sock-&gt;so_tx_una) {
<a name="l00448"></a>00448         h_seq = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>);
<a name="l00449"></a>00449         <span class="keywordflow">if</span> (h_seq &gt; sock-&gt;so_tx_wl1 || (h_seq == sock-&gt;so_tx_wl1 &amp;&amp; h_ack &gt;= sock-&gt;so_tx_wl2)) {
<a name="l00450"></a>00450             sock-&gt;so_tx_win = <a class="code" href="group__xg_nut_o_s.html#gda37feda716b4ba89cf9dba34288141d" title="Convert short value from network to host byte order.">ntohs</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#a2f3bcd44b55f8732112963f3ef19e1f" title="Number of acceptable octects.">th_win</a>);
<a name="l00451"></a>00451             sock-&gt;so_tx_wl1 = h_seq;
<a name="l00452"></a>00452             sock-&gt;so_tx_wl2 = h_ack;
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456     <span class="comment">/*</span>
<a name="l00457"></a>00457 <span class="comment">     * Ignore old ACKs but wake up sleeping transmitter threads, because</span>
<a name="l00458"></a>00458 <span class="comment">     * the window size may have changed.</span>
<a name="l00459"></a>00459 <span class="comment">     */</span>
<a name="l00460"></a>00460     <span class="keywordflow">if</span> (h_ack &lt; sock-&gt;so_tx_una) {
<a name="l00461"></a>00461         <span class="keywordflow">return</span> 0;
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="comment">/*</span>
<a name="l00465"></a>00465 <span class="comment">     * Process duplicate ACKs.</span>
<a name="l00466"></a>00466 <span class="comment">     */</span>
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (h_ack == sock-&gt;so_tx_una) {
<a name="l00468"></a>00468         <span class="comment">/*</span>
<a name="l00469"></a>00469 <span class="comment">         * Don't count, if nothing is waiting for ACK,</span>
<a name="l00470"></a>00470 <span class="comment">         * segment contains data or on SYN/FIN segments.</span>
<a name="l00471"></a>00471 <span class="comment">         */</span>
<a name="l00472"></a>00472         <span class="keywordflow">if</span> (sock-&gt;so_tx_nbq &amp;&amp; length == 0 &amp;&amp; (th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#0d142ef566a2a01dd8dbdad8a66aef95" title="Control flags.">th_flags</a> &amp; (<a class="code" href="netinet_2tcp_8h.html#91006117f7ae427b957773ab0e80bfa4" title="Synchronizing sequence numbers.">TH_SYN</a> | <a class="code" href="netinet_2tcp_8h.html#1cec9b372679734fcd8394d779442ddb" title="Finishing transmission.">TH_FIN</a>)) == 0) {
<a name="l00473"></a>00473             <span class="comment">/*</span>
<a name="l00474"></a>00474 <span class="comment">             * If dupe counter reaches it's limit, resend</span>
<a name="l00475"></a>00475 <span class="comment">             * the oldest unacknowledged netbuf.</span>
<a name="l00476"></a>00476 <span class="comment">             */</span>
<a name="l00477"></a>00477             <span class="keywordflow">if</span> (++sock-&gt;so_tx_dup &gt;= 3) {
<a name="l00478"></a>00478                 sock-&gt;so_tx_dup = 0;
<a name="l00479"></a>00479 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>)
<a name="l00481"></a>00481                     <a class="code" href="netdebug_8h.html#13243e59b9857a6c4ee17e4cee73af51">NutDumpTcpHeader</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"RET"</span>, sock, sock-&gt;so_tx_nbq);
<a name="l00482"></a>00482 <span class="preprocessor">#endif</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>                <span class="comment">/*</span>
<a name="l00484"></a>00484 <span class="comment">                 * Retransmit first unacked packet from queue.</span>
<a name="l00485"></a>00485 <span class="comment">                 * Actually we got much more trouble if this fails.</span>
<a name="l00486"></a>00486 <span class="comment">                 */</span>
<a name="l00487"></a>00487                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_t_c_p.html#gd8b7767f85c9dc3cd4a1f1f961ae7a84" title="Retransmit a segment after ACK timeout.">NutTcpStateRetranTimeout</a>(sock))
<a name="l00488"></a>00488                     <span class="keywordflow">return</span> -1;
<a name="l00489"></a>00489             }
<a name="l00490"></a>00490         }
<a name="l00491"></a>00491         <span class="keywordflow">return</span> 0;
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="comment">/*</span>
<a name="l00495"></a>00495 <span class="comment">     * We're here, so the ACK must have actually acked something</span>
<a name="l00496"></a>00496 <span class="comment">     */</span>
<a name="l00497"></a>00497     sock-&gt;so_tx_dup = 0;
<a name="l00498"></a>00498     sock-&gt;so_tx_una = h_ack;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="comment">/*</span>
<a name="l00501"></a>00501 <span class="comment">     * Bugfix contributed by Liu Limin: If the remote is slow and this</span>
<a name="l00502"></a>00502 <span class="comment">     * line is missing, then Ethernut will send a full data packet even</span>
<a name="l00503"></a>00503 <span class="comment">     * if the remote closed the window.</span>
<a name="l00504"></a>00504 <span class="comment">     */</span>
<a name="l00505"></a>00505     sock-&gt;so_tx_win = <a class="code" href="group__xg_nut_o_s.html#gda37feda716b4ba89cf9dba34288141d" title="Convert short value from network to host byte order.">ntohs</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#a2f3bcd44b55f8732112963f3ef19e1f" title="Number of acceptable octects.">th_win</a>);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     <span class="comment">/* </span>
<a name="l00508"></a>00508 <span class="comment">     * Do round trip time calculation.</span>
<a name="l00509"></a>00509 <span class="comment">     */</span>
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (sock-&gt;so_rtt_seq &amp;&amp; sock-&gt;so_rtt_seq &lt; h_ack)
<a name="l00511"></a>00511         <a class="code" href="group__xg_t_c_p.html#gf85cd27c9a8694e8098409b5f92003c7">NutTcpCalcRtt</a> (sock);
<a name="l00512"></a>00512     sock-&gt;so_rtt_seq = 0;
<a name="l00513"></a>00513     <span class="comment">/*</span>
<a name="l00514"></a>00514 <span class="comment">     * Remove all acknowledged netbufs.</span>
<a name="l00515"></a>00515 <span class="comment">     */</span>
<a name="l00516"></a>00516     <span class="keywordflow">while</span> ((nb = sock-&gt;so_tx_nbq) != 0) {
<a name="l00517"></a>00517         <span class="comment">/* Calculate the sequence beyond this netbuf. */</span>
<a name="l00518"></a>00518         h_seq = <a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(((<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *) (nb-&gt;nb_tp.vp))-&gt;th_seq) + nb-&gt;nb_ap.sz;
<a name="l00519"></a>00519         <span class="keywordflow">if</span> (((<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *) (nb-&gt;nb_tp.vp))-&gt;th_flags &amp; (<a class="code" href="netinet_2tcp_8h.html#91006117f7ae427b957773ab0e80bfa4" title="Synchronizing sequence numbers.">TH_SYN</a> | <a class="code" href="netinet_2tcp_8h.html#1cec9b372679734fcd8394d779442ddb" title="Finishing transmission.">TH_FIN</a>)) {
<a name="l00520"></a>00520             h_seq++;
<a name="l00521"></a>00521         }
<a name="l00522"></a>00522         <span class="comment">//@@@printf ("[%04X]*: processack, check seq#: %lu\n", (u_short) sock, h_seq);</span>
<a name="l00523"></a>00523         <span class="keywordflow">if</span> (h_seq &gt; h_ack) {
<a name="l00524"></a>00524             <span class="keywordflow">break</span>;
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526         sock-&gt;so_tx_nbq = nb-&gt;nb_next;
<a name="l00527"></a>00527         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="comment">/*</span>
<a name="l00531"></a>00531 <span class="comment">     * Reset retransmit timer and wake up waiting transmissions.</span>
<a name="l00532"></a>00532 <span class="comment">     */</span>
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (sock-&gt;so_tx_nbq) {
<a name="l00534"></a>00534         sock-&gt;so_retran_time = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) <a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() | 1;
<a name="l00535"></a>00535     } <span class="keywordflow">else</span> {
<a name="l00536"></a>00536         sock-&gt;so_retran_time = 0;
<a name="l00537"></a>00537     }
<a name="l00538"></a>00538     sock-&gt;so_retransmits = 0;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="keywordflow">return</span> 0;
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 <span class="comment">/* ================================================================</span>
<a name="l00546"></a>00546 <span class="comment"> * State changes.</span>
<a name="l00547"></a>00547 <span class="comment"> * ================================================================</span>
<a name="l00548"></a>00548 <span class="comment"> */</span>
<a name="l00557"></a>00557 <span class="keyword">static</span> <span class="keywordtype">int</span> NutTcpStateChange(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> state)
<a name="l00558"></a>00558 {
<a name="l00559"></a>00559     <span class="keywordtype">int</span> rc = 0;
<a name="l00560"></a>00560     <a class="code" href="nut__types_8h.html#e15262a08334eeeacd9a24f219a89d46" title="Unsigned register type.">ureg_t</a> txf = 0;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="keywordflow">switch</span> (sock-&gt;so_state) {
<a name="l00563"></a>00563         <span class="comment">/* Handle the most common case first. */</span>
<a name="l00564"></a>00564     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>:
<a name="l00565"></a>00565         <span class="keywordflow">switch</span> (state) {
<a name="l00566"></a>00566         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>:
<a name="l00567"></a>00567             <span class="comment">/*</span>
<a name="l00568"></a>00568 <span class="comment">             * Closed by application.</span>
<a name="l00569"></a>00569 <span class="comment">             */</span>
<a name="l00570"></a>00570             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gefdf0c5749674efdd40a37857ca45f78" title="Socket transmit flag. Send FIN after all data has been transmitted.">SO_FIN</a> | <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>;
<a name="l00571"></a>00571             txf = 1;
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 <span class="preprocessor">#ifdef RTLCONNECTHACK</span>
<a name="l00574"></a>00574 <span class="preprocessor"></span>            <span class="comment">/*</span>
<a name="l00575"></a>00575 <span class="comment">             * Hack alert!</span>
<a name="l00576"></a>00576 <span class="comment">             * On the RTL8019AS we got a problem. Because of not handling</span>
<a name="l00577"></a>00577 <span class="comment">             * the CHRDY line, the controller drops outgoing packets when</span>
<a name="l00578"></a>00578 <span class="comment">             * a browser opens multiple connections concurrently, producing</span>
<a name="l00579"></a>00579 <span class="comment">             * several short incoming packets. Empirical test showed, that</span>
<a name="l00580"></a>00580 <span class="comment">             * a slight delay during connects and disconnects helped to</span>
<a name="l00581"></a>00581 <span class="comment">             * remarkably reduce this problem.</span>
<a name="l00582"></a>00582 <span class="comment">             */</span>
<a name="l00583"></a>00583             <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(5);
<a name="l00584"></a>00584 <span class="preprocessor">#endif</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
<a name="l00586"></a>00586         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>:
<a name="l00587"></a>00587             <span class="comment">/*</span>
<a name="l00588"></a>00588 <span class="comment">             * FIN received.</span>
<a name="l00589"></a>00589 <span class="comment">             */</span>
<a name="l00590"></a>00590             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00591"></a>00591             txf = 1;
<a name="l00592"></a>00592             <span class="keywordflow">break</span>;
<a name="l00593"></a>00593         <span class="keywordflow">default</span>:
<a name="l00594"></a>00594             rc = -1;
<a name="l00595"></a>00595             <span class="keywordflow">break</span>;
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597         <span class="keywordflow">break</span>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>:
<a name="l00600"></a>00600         <span class="comment">/*</span>
<a name="l00601"></a>00601 <span class="comment">         * SYN received.</span>
<a name="l00602"></a>00602 <span class="comment">         */</span>
<a name="l00603"></a>00603         <span class="keywordflow">if</span> (state == <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>) {
<a name="l00604"></a>00604             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#g4a15c49046e1b3c0c3b4a3fad2b55c6c" title="Socket transmit flag. Send SYN first.">SO_SYN</a> | <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>;
<a name="l00605"></a>00605             txf = 1;
<a name="l00606"></a>00606 <span class="preprocessor">#ifdef RTLCONNECTHACK</span>
<a name="l00607"></a>00607 <span class="preprocessor"></span>            <span class="comment">/*</span>
<a name="l00608"></a>00608 <span class="comment">             * Hack alert!</span>
<a name="l00609"></a>00609 <span class="comment">             * On the RTL8019AS we got a problem. Because of not handling</span>
<a name="l00610"></a>00610 <span class="comment">             * the CHRDY line, the controller drops outgoing packets when</span>
<a name="l00611"></a>00611 <span class="comment">             * a browser opens multiple connections concurrently, producing</span>
<a name="l00612"></a>00612 <span class="comment">             * several short incoming packets. Empirical test showed, that</span>
<a name="l00613"></a>00613 <span class="comment">             * a slight delay during connects and disconnects helped to</span>
<a name="l00614"></a>00614 <span class="comment">             * remarkably reduce this problem.</span>
<a name="l00615"></a>00615 <span class="comment">             */</span>
<a name="l00616"></a>00616             <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(5);
<a name="l00617"></a>00617 <span class="preprocessor">#endif</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span>        } <span class="keywordflow">else</span>
<a name="l00619"></a>00619             rc = -1;
<a name="l00620"></a>00620         <span class="keywordflow">break</span>;
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>:
<a name="l00623"></a>00623         <span class="keywordflow">switch</span> (state) {
<a name="l00624"></a>00624         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>:
<a name="l00625"></a>00625             <span class="comment">/*</span>
<a name="l00626"></a>00626 <span class="comment">             * RST received on passive socket.</span>
<a name="l00627"></a>00627 <span class="comment">             */</span>
<a name="l00628"></a>00628             <span class="keywordflow">break</span>;
<a name="l00629"></a>00629         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>:
<a name="l00630"></a>00630             <span class="comment">/*</span>
<a name="l00631"></a>00631 <span class="comment">             * SYN received.</span>
<a name="l00632"></a>00632 <span class="comment">             */</span>
<a name="l00633"></a>00633             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#g4a15c49046e1b3c0c3b4a3fad2b55c6c" title="Socket transmit flag. Send SYN first.">SO_SYN</a> | <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>;
<a name="l00634"></a>00634             txf = 1;
<a name="l00635"></a>00635             <span class="keywordflow">break</span>;
<a name="l00636"></a>00636         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>:
<a name="l00637"></a>00637             <span class="comment">/*</span>
<a name="l00638"></a>00638 <span class="comment">             * SYNACK received.</span>
<a name="l00639"></a>00639 <span class="comment">             */</span>
<a name="l00640"></a>00640             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00641"></a>00641             txf = 1;
<a name="l00642"></a>00642             <span class="keywordflow">break</span>;
<a name="l00643"></a>00643         <span class="keywordflow">default</span>:
<a name="l00644"></a>00644             rc = -1;
<a name="l00645"></a>00645             <span class="keywordflow">break</span>;
<a name="l00646"></a>00646         }
<a name="l00647"></a>00647         <span class="keywordflow">break</span>;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>:
<a name="l00650"></a>00650         <span class="keywordflow">switch</span> (state) {
<a name="l00651"></a>00651         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>:
<a name="l00652"></a>00652             <span class="comment">/*</span>
<a name="l00653"></a>00653 <span class="comment">             * RST received on passive socket.</span>
<a name="l00654"></a>00654 <span class="comment">             */</span>
<a name="l00655"></a>00655             <span class="keywordflow">break</span>;
<a name="l00656"></a>00656         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>:
<a name="l00657"></a>00657             <span class="comment">/*</span>
<a name="l00658"></a>00658 <span class="comment">             * ACK of SYN received.</span>
<a name="l00659"></a>00659 <span class="comment">             */</span>
<a name="l00660"></a>00660             <span class="keywordflow">break</span>;
<a name="l00661"></a>00661         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>:
<a name="l00662"></a>00662             <span class="comment">/*</span>
<a name="l00663"></a>00663 <span class="comment">             * Closed by application.</span>
<a name="l00664"></a>00664 <span class="comment">             */</span>
<a name="l00665"></a>00665             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gefdf0c5749674efdd40a37857ca45f78" title="Socket transmit flag. Send FIN after all data has been transmitted.">SO_FIN</a>;
<a name="l00666"></a>00666             txf = 1;
<a name="l00667"></a>00667             <span class="keywordflow">break</span>;
<a name="l00668"></a>00668         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>:
<a name="l00669"></a>00669             <span class="comment">/*</span>
<a name="l00670"></a>00670 <span class="comment">             * FIN received.</span>
<a name="l00671"></a>00671 <span class="comment">             */</span>
<a name="l00672"></a>00672             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gefdf0c5749674efdd40a37857ca45f78" title="Socket transmit flag. Send FIN after all data has been transmitted.">SO_FIN</a> | <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>;
<a name="l00673"></a>00673             txf = 1;
<a name="l00674"></a>00674             <span class="keywordflow">break</span>;
<a name="l00675"></a>00675         <span class="keywordflow">default</span>:
<a name="l00676"></a>00676             rc = -1;
<a name="l00677"></a>00677             <span class="keywordflow">break</span>;
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679         <span class="keywordflow">break</span>;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>:
<a name="l00682"></a>00682         <span class="keywordflow">switch</span> (state) {
<a name="l00683"></a>00683         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>:
<a name="l00684"></a>00684         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>:
<a name="l00685"></a>00685             <span class="comment">/*</span>
<a name="l00686"></a>00686 <span class="comment">             * ACK of FIN received.</span>
<a name="l00687"></a>00687 <span class="comment">             */</span>
<a name="l00688"></a>00688             <span class="keywordflow">break</span>;
<a name="l00689"></a>00689         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#1be9cca16dc9d0363d31ee80c98bc8bf" title="closed xchd FIN; await FIN ACK">TCPS_CLOSING</a>:
<a name="l00690"></a>00690             <span class="comment">/*</span>
<a name="l00691"></a>00691 <span class="comment">             * FIN received.</span>
<a name="l00692"></a>00692 <span class="comment">             */</span>
<a name="l00693"></a>00693             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00694"></a>00694             txf = 1;
<a name="l00695"></a>00695             <span class="keywordflow">break</span>;
<a name="l00696"></a>00696         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>:
<a name="l00697"></a>00697             <span class="comment">/*</span>
<a name="l00698"></a>00698 <span class="comment">             * FIN and ACK of FIN received.</span>
<a name="l00699"></a>00699 <span class="comment">             */</span>
<a name="l00700"></a>00700             <span class="keywordflow">break</span>;
<a name="l00701"></a>00701         <span class="keywordflow">default</span>:
<a name="l00702"></a>00702             rc = -1;
<a name="l00703"></a>00703             <span class="keywordflow">break</span>;
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705         <span class="keywordflow">break</span>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>:
<a name="l00708"></a>00708         <span class="comment">/*</span>
<a name="l00709"></a>00709 <span class="comment">         * FIN received.</span>
<a name="l00710"></a>00710 <span class="comment">         */</span>
<a name="l00711"></a>00711         <span class="keywordflow">if</span> (state != <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>)
<a name="l00712"></a>00712             rc = -1;
<a name="l00713"></a>00713         sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00714"></a>00714         txf = 1;
<a name="l00715"></a>00715         <span class="keywordflow">break</span>;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>:
<a name="l00718"></a>00718         <span class="comment">/*</span>
<a name="l00719"></a>00719 <span class="comment">         * Closed by application.</span>
<a name="l00720"></a>00720 <span class="comment">         */</span>
<a name="l00721"></a>00721         <span class="keywordflow">if</span> (state == <a class="code" href="tcp__fsm_8h.html#bc253767192111e900d000cf5dac7fee" title="had fin and close; await FIN ACK">TCPS_LAST_ACK</a>) {
<a name="l00722"></a>00722             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gefdf0c5749674efdd40a37857ca45f78" title="Socket transmit flag. Send FIN after all data has been transmitted.">SO_FIN</a> | <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>;
<a name="l00723"></a>00723             txf = 1;
<a name="l00724"></a>00724         } <span class="keywordflow">else</span>
<a name="l00725"></a>00725             rc = -1;
<a name="l00726"></a>00726         <span class="keywordflow">break</span>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#1be9cca16dc9d0363d31ee80c98bc8bf" title="closed xchd FIN; await FIN ACK">TCPS_CLOSING</a>:
<a name="l00729"></a>00729         <span class="comment">/*</span>
<a name="l00730"></a>00730 <span class="comment">         * ACK of FIN received.</span>
<a name="l00731"></a>00731 <span class="comment">         */</span>
<a name="l00732"></a>00732         <span class="keywordflow">if</span> (state != <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>)
<a name="l00733"></a>00733             rc = -1;
<a name="l00734"></a>00734         <span class="keywordflow">break</span>;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#bc253767192111e900d000cf5dac7fee" title="had fin and close; await FIN ACK">TCPS_LAST_ACK</a>:
<a name="l00737"></a>00737         rc = -1;
<a name="l00738"></a>00738         <span class="keywordflow">break</span>;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>:
<a name="l00741"></a>00741         rc = -1;
<a name="l00742"></a>00742         <span class="keywordflow">break</span>;
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#f100e134b318729b9824f95ac09ab5d8" title="closed">TCPS_CLOSED</a>:
<a name="l00745"></a>00745         <span class="keywordflow">switch</span> (state) {
<a name="l00746"></a>00746         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>:
<a name="l00747"></a>00747             <span class="comment">/*</span>
<a name="l00748"></a>00748 <span class="comment">             * Passive open by application.</span>
<a name="l00749"></a>00749 <span class="comment">             */</span>
<a name="l00750"></a>00750             <span class="keywordflow">break</span>;
<a name="l00751"></a>00751         <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>:
<a name="l00752"></a>00752             <span class="comment">/*</span>
<a name="l00753"></a>00753 <span class="comment">             * Active open by application.</span>
<a name="l00754"></a>00754 <span class="comment">             */</span>
<a name="l00755"></a>00755             sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#g4a15c49046e1b3c0c3b4a3fad2b55c6c" title="Socket transmit flag. Send SYN first.">SO_SYN</a>;
<a name="l00756"></a>00756             txf = 1;
<a name="l00757"></a>00757             <span class="keywordflow">break</span>;
<a name="l00758"></a>00758         <span class="keywordflow">default</span>:
<a name="l00759"></a>00759             rc = -1;
<a name="l00760"></a>00760             <span class="keywordflow">break</span>;
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762         <span class="keywordflow">break</span>;
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l00766"></a>00766         <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">" %04x-"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) sock);
<a name="l00767"></a>00767         <span class="keywordflow">if</span> (rc)
<a name="l00768"></a>00768             <a class="code" href="netdebug_8h.html#87cbcba93ddf1f08d4fc58307ef8780c">NutDumpSockState</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, sock-&gt;so_state, <span class="stringliteral">"**ERR "</span>, <span class="stringliteral">"**&gt;"</span>);
<a name="l00769"></a>00769         <a class="code" href="netdebug_8h.html#87cbcba93ddf1f08d4fc58307ef8780c">NutDumpSockState</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, state, <span class="stringliteral">"[&gt;"</span>, <span class="stringliteral">"]"</span>);
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771 <span class="preprocessor">#endif</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span>
<a name="l00773"></a>00773     <span class="keywordflow">if</span> (rc == 0) {
<a name="l00774"></a>00774         sock-&gt;so_state = state;
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (txf &amp;&amp; <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0)) {
<a name="l00776"></a>00776             <span class="keywordflow">if</span> (state == <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>) {
<a name="l00777"></a>00777                 rc = -1;
<a name="l00778"></a>00778                 sock-&gt;so_last_error = <a class="code" href="errno_8h.html#a92bcaf70544db6998f4c503026359c5">EHOSTDOWN</a>;
<a name="l00779"></a>00779                 <a class="code" href="group__xg_event.html#g129d2de44ddf083f252d0754fc45d9d3" title="Asynchronously post an event to a specified queue.">NutEventPostAsync</a>(&amp;sock-&gt;so_ac_tq);
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781         }
<a name="l00782"></a>00782         <span class="keywordflow">if</span> (state == <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>) {
<a name="l00783"></a>00783             <span class="comment">/*</span>
<a name="l00784"></a>00784 <span class="comment">             * Inform application.</span>
<a name="l00785"></a>00785 <span class="comment">             */</span>
<a name="l00786"></a>00786             <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_rx_tq);
<a name="l00787"></a>00787             <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_pc_tq);
<a name="l00788"></a>00788             <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_ac_tq);
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790     }
<a name="l00791"></a>00791     <span class="keywordflow">return</span> rc;
<a name="l00792"></a>00792 }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794 <span class="comment">/* ================================================================</span>
<a name="l00795"></a>00795 <span class="comment"> * Application events.</span>
<a name="l00796"></a>00796 <span class="comment"> * ================================================================</span>
<a name="l00797"></a>00797 <span class="comment"> */</span>
<a name="l00806"></a><a class="code" href="group__xg_t_c_p.html#gc5d18facd9bf6a983652d415fc806083">00806</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#gc5d18facd9bf6a983652d415fc806083" title="Initiated by the application.">NutTcpStatePassiveOpenEvent</a>(TCPSOCKET * sock)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808     <span class="keywordflow">if</span> (sock-&gt;so_state != <a class="code" href="tcp__fsm_8h.html#f100e134b318729b9824f95ac09ab5d8" title="closed">TCPS_CLOSED</a>)
<a name="l00809"></a>00809         <span class="keywordflow">return</span> (sock-&gt;so_last_error = <a class="code" href="errno_8h.html#164ca8549da7a385e2fe1cba823b9eaf">EISCONN</a>);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813     <span class="comment">/*</span>
<a name="l00814"></a>00814 <span class="comment">     * Block application.</span>
<a name="l00815"></a>00815 <span class="comment">     */</span>
<a name="l00816"></a>00816     <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;sock-&gt;so_pc_tq, 0);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <span class="keywordflow">return</span> 0;
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00831"></a><a class="code" href="group__xg_t_c_p.html#g77edd214cf89e11aebfc556b6879e487">00831</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#g77edd214cf89e11aebfc556b6879e487" title="Initiated by the application.">NutTcpStateActiveOpenEvent</a>(TCPSOCKET * sock)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833     <span class="comment">/*</span>
<a name="l00834"></a>00834 <span class="comment">     * Switch state to SYN_SENT. This will</span>
<a name="l00835"></a>00835 <span class="comment">     * transmit a SYN packet.</span>
<a name="l00836"></a>00836 <span class="comment">     */</span>
<a name="l00837"></a>00837     NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>);
<a name="l00838"></a>00838 
<a name="l00839"></a>00839     <span class="comment">/*</span>
<a name="l00840"></a>00840 <span class="comment">     * Block application.</span>
<a name="l00841"></a>00841 <span class="comment">     */</span>
<a name="l00842"></a>00842      <span class="keywordflow">if</span>(sock-&gt;so_state == <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>)
<a name="l00843"></a>00843         <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;sock-&gt;so_ac_tq, 0);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (sock-&gt;so_state != <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>)
<a name="l00846"></a>00846         <span class="keywordflow">return</span> -1;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="keywordflow">return</span> 0;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00863"></a><a class="code" href="group__xg_t_c_p.html#ge64ae871579ec8252d41240a947f1a5e">00863</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#ge64ae871579ec8252d41240a947f1a5e" title="Socket close by application.">NutTcpStateCloseEvent</a>(TCPSOCKET * sock)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865     <span class="keywordflow">if</span> (sock == 0)
<a name="l00866"></a>00866         <span class="keywordflow">return</span> -1;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <a class="code" href="group__xg_thread.html#g075836f9a2596c5983b7ba88420afd11" title="Give up the CPU.">NutThreadYield</a>();
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="keywordflow">switch</span> (sock-&gt;so_state) {
<a name="l00871"></a>00871     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>:
<a name="l00872"></a>00872     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>:
<a name="l00873"></a>00873     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#f100e134b318729b9824f95ac09ab5d8" title="closed">TCPS_CLOSED</a>:
<a name="l00874"></a>00874         <span class="comment">/*</span>
<a name="l00875"></a>00875 <span class="comment">         * No connection yet, immediately destroy the socket.</span>
<a name="l00876"></a>00876 <span class="comment">         */</span>
<a name="l00877"></a>00877         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l00878"></a>00878         <span class="keywordflow">break</span>;
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>:
<a name="l00881"></a>00881     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>:
<a name="l00882"></a>00882         <span class="comment">/*</span>
<a name="l00883"></a>00883 <span class="comment">         * Send a FIN and wait for ACK or FIN.</span>
<a name="l00884"></a>00884 <span class="comment">         */</span>
<a name="l00885"></a>00885         <span class="comment">//@@@printf ("[%04X]ESTABLISHED: going to FIN_WAIT_1\n", (u_short) sock);</span>
<a name="l00886"></a>00886         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>);
<a name="l00887"></a>00887         <span class="keywordflow">break</span>;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>:
<a name="l00890"></a>00890         <span class="comment">/* </span>
<a name="l00891"></a>00891 <span class="comment">         * RFC 793 is wrong. </span>
<a name="l00892"></a>00892 <span class="comment">         */</span>
<a name="l00893"></a>00893         <span class="comment">//@@@printf("[%04X]CLOSE_WAIT: going to LAST_ACK\n", (u_short) sock);</span>
<a name="l00894"></a>00894         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#bc253767192111e900d000cf5dac7fee" title="had fin and close; await FIN ACK">TCPS_LAST_ACK</a>);
<a name="l00895"></a>00895         <span class="keywordflow">break</span>;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>:
<a name="l00898"></a>00898     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>:
<a name="l00899"></a>00899     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#1be9cca16dc9d0363d31ee80c98bc8bf" title="closed xchd FIN; await FIN ACK">TCPS_CLOSING</a>:
<a name="l00900"></a>00900     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#bc253767192111e900d000cf5dac7fee" title="had fin and close; await FIN ACK">TCPS_LAST_ACK</a>:
<a name="l00901"></a>00901     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>:
<a name="l00902"></a>00902         sock-&gt;so_last_error = <a class="code" href="errno_8h.html#a4ccb54aa806de3e41a8515f06db85d4">EALREADY</a>;
<a name="l00903"></a>00903         <span class="keywordflow">return</span> -1;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="keywordflow">default</span>:
<a name="l00906"></a>00906         sock-&gt;so_last_error = <a class="code" href="errno_8h.html#f23e48762a0676f49d480db91cfd5e4b">ENOTCONN</a>;
<a name="l00907"></a>00907         <span class="keywordflow">return</span> -1;
<a name="l00908"></a>00908     }
<a name="l00909"></a>00909     <span class="keywordflow">return</span> 0;
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00918"></a><a class="code" href="group__xg_t_c_p.html#g9f691b65c2a49fbb90202f3d45c5b000">00918</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#g9f691b65c2a49fbb90202f3d45c5b000" title="Initiated by the application.">NutTcpStateWindowEvent</a>(TCPSOCKET * sock)
<a name="l00919"></a>00919 {
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (sock == 0)
<a name="l00921"></a>00921         <span class="keywordflow">return</span> -1;
<a name="l00922"></a>00922     sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l00923"></a>00923     <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <span class="keywordflow">return</span> 0;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 <span class="comment">/* ================================================================</span>
<a name="l00929"></a>00929 <span class="comment"> * Timeout events.</span>
<a name="l00930"></a>00930 <span class="comment"> * ================================================================</span>
<a name="l00931"></a>00931 <span class="comment"> */</span>
<a name="l00943"></a><a class="code" href="group__xg_t_c_p.html#gd8b7767f85c9dc3cd4a1f1f961ae7a84">00943</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#gd8b7767f85c9dc3cd4a1f1f961ae7a84" title="Retransmit a segment after ACK timeout.">NutTcpStateRetranTimeout</a>(TCPSOCKET * sock)
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945     NETBUF *so_tx_next;
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (sock-&gt;so_retransmits++ &gt; <a class="code" href="tcpsm_8c.html#ae70ed2330837b5d6ff3cb78d59e0595">TCP_RETRIES_MAX</a>)
<a name="l00947"></a>00947     {
<a name="l00948"></a>00948         <span class="comment">/* Abort the socket */</span>
<a name="l00949"></a>00949         <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(sock, <a class="code" href="errno_8h.html#597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>);
<a name="l00950"></a>00950         <span class="keywordflow">return</span> -1;
<a name="l00951"></a>00951     } <span class="keywordflow">else</span> {
<a name="l00952"></a>00952 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00953"></a>00953 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>)
<a name="l00954"></a>00954             <a class="code" href="netdebug_8h.html#13243e59b9857a6c4ee17e4cee73af51">NutDumpTcpHeader</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">"RET"</span>, sock, sock-&gt;so_tx_nbq);
<a name="l00955"></a>00955 <span class="preprocessor">#endif</span>
<a name="l00956"></a>00956 <span class="preprocessor"></span>        <span class="comment">/* We must save sock-&gt;so_tx_nbq-&gt;nb_next before calling NutIpOutput,</span>
<a name="l00957"></a>00957 <span class="comment">         * because in case of error the NETBUF is release by NutIpOutput and</span>
<a name="l00958"></a>00958 <span class="comment">         * not longer available.</span>
<a name="l00959"></a>00959 <span class="comment">         */</span>
<a name="l00960"></a>00960         so_tx_next = sock-&gt;so_tx_nbq-&gt;nb_next;
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (<a class="code" href="group__xg_i_p.html#ga1d170f1dc44c4292480d40990483d85" title="Send IP datagram.">NutIpOutput</a>(<a class="code" href="in_8h.html#94f83c72c1e5e6ef453e47cf59885fb5" title="Transmission control protocol.">IPPROTO_TCP</a>, sock-&gt;so_remote_addr, sock-&gt;so_tx_nbq)) {
<a name="l00962"></a>00962             <span class="comment">/* Adjust packet queue */</span>
<a name="l00963"></a>00963             sock-&gt;so_tx_nbq = so_tx_next;
<a name="l00964"></a>00964             <span class="comment">/* Abort the socket */</span>
<a name="l00965"></a>00965             <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(sock, <a class="code" href="errno_8h.html#ac51995026fa19cdd0ad84a272304af0">ENETDOWN</a>);
<a name="l00966"></a>00966             <span class="keywordflow">return</span> -1;
<a name="l00967"></a>00967         } <span class="keywordflow">else</span> {
<a name="l00968"></a>00968             <span class="comment">/* Restart the retransmission timer. */</span>
<a name="l00969"></a>00969             sock-&gt;so_retran_time = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) <a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() | 1;
<a name="l00970"></a>00970             <span class="keywordflow">return</span> 0;
<a name="l00971"></a>00971         }
<a name="l00972"></a>00972     }
<a name="l00973"></a>00973 }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975 <span class="comment">/* ================================================================</span>
<a name="l00976"></a>00976 <span class="comment"> * Segment arrival events.</span>
<a name="l00977"></a>00977 <span class="comment"> * ================================================================</span>
<a name="l00978"></a>00978 <span class="comment"> */</span>
<a name="l00979"></a>00979 
<a name="l00989"></a>00989 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateListen(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991     <span class="comment">/*</span>
<a name="l00992"></a>00992 <span class="comment">     * Got a SYN segment. Store relevant data in our socket</span>
<a name="l00993"></a>00993 <span class="comment">     * structure and switch to TCPS_SYN_RECEIVED.</span>
<a name="l00994"></a>00994 <span class="comment">     */</span>
<a name="l00995"></a>00995     <span class="keywordflow">if</span> ((flags &amp; (<a class="code" href="netinet_2tcp_8h.html#91006117f7ae427b957773ab0e80bfa4" title="Synchronizing sequence numbers.">TH_SYN</a> | <a class="code" href="netinet_2tcp_8h.html#362dae974cf06bab2b79b70f0cde524f" title="Acknowledge field is valid.">TH_ACK</a> | <a class="code" href="netinet_2tcp_8h.html#7f2ce15991898c8d3397045087c4381f" title="Reset connection.">TH_RST</a>)) == <a class="code" href="netinet_2tcp_8h.html#91006117f7ae427b957773ab0e80bfa4" title="Synchronizing sequence numbers.">TH_SYN</a>) {
<a name="l00996"></a>00996         NutTcpProcessSyn(sock, nb-&gt;nb_nw.vp, th);
<a name="l00997"></a>00997         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>);
<a name="l00998"></a>00998         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l00999"></a>00999     } <span class="keywordflow">else</span>
<a name="l01000"></a>01000         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003 
<a name="l01012"></a>01012 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateSynSent(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014     <span class="comment">/*</span>
<a name="l01015"></a>01015 <span class="comment">     * Validate ACK, if set.</span>
<a name="l01016"></a>01016 <span class="comment">     */</span>
<a name="l01017"></a>01017     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="netinet_2tcp_8h.html#362dae974cf06bab2b79b70f0cde524f" title="Acknowledge field is valid.">TH_ACK</a>) {
<a name="l01018"></a>01018         <span class="keywordflow">if</span> (!<a class="code" href="group__xg_t_c_p.html#gcff7d63177023b5f4a6d1f9c32e7e7ab" title="Sequence number comparisons.">IsInLimits</a>(<a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#49e29d973cc4b0d4bddfdf027550fb5f" title="Expected sequence number of next octet.">th_ack</a>), sock-&gt;so_tx_isn + 1, sock-&gt;so_tx_nxt)) {
<a name="l01019"></a>01019             <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01020"></a>01020             <span class="keywordflow">return</span>;
<a name="l01021"></a>01021         }
<a name="l01022"></a>01022     }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024     <span class="comment">/*</span>
<a name="l01025"></a>01025 <span class="comment">     * Handle RST flag. If we were in the LISTEN state,</span>
<a name="l01026"></a>01026 <span class="comment">     * then we return to the LISTEN state, otherwise we</span>
<a name="l01027"></a>01027 <span class="comment">     * abort the connection and go to the CLOSED state.</span>
<a name="l01028"></a>01028 <span class="comment">     */</span>
<a name="l01029"></a>01029     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="netinet_2tcp_8h.html#7f2ce15991898c8d3397045087c4381f" title="Reset connection.">TH_RST</a>) {
<a name="l01030"></a>01030         <span class="keywordflow">if</span> (flags &amp; TH_ACK) {
<a name="l01031"></a>01031             <span class="comment">/*if (sock-&gt;so_pc_tq)</span>
<a name="l01032"></a>01032 <span class="comment">                NutTcpStateChange(sock, TCPS_LISTEN);</span>
<a name="l01033"></a>01033 <span class="comment">            else */</span>
<a name="l01034"></a>01034                 <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(sock, <a class="code" href="errno_8h.html#ad88020b394ef1aa4af2f4ef9b4c8b39">ECONNREFUSED</a>);
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01037"></a>01037         <span class="keywordflow">return</span>;
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039 
<a name="l01040"></a>01040     <span class="comment">/*</span>
<a name="l01041"></a>01041 <span class="comment">     * Handle SYN flag. If we got a valid ACK too, then</span>
<a name="l01042"></a>01042 <span class="comment">     * our connection is established. Otherwise enter</span>
<a name="l01043"></a>01043 <span class="comment">     * SYNRCVD state.</span>
<a name="l01044"></a>01044 <span class="comment">     */</span>
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="netinet_2tcp_8h.html#91006117f7ae427b957773ab0e80bfa4" title="Synchronizing sequence numbers.">TH_SYN</a>) {
<a name="l01046"></a>01046         NutTcpProcessSyn(sock, nb-&gt;nb_nw.vp, th);
<a name="l01047"></a>01047         <span class="keywordflow">if</span> (flags &amp; TH_ACK) {
<a name="l01048"></a>01048             NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01049"></a>01049             NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>);
<a name="l01050"></a>01050             <span class="comment">/* Wake up the actively connecting thread. */</span>
<a name="l01051"></a>01051             <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;sock-&gt;so_ac_tq);
<a name="l01052"></a>01052         } <span class="keywordflow">else</span> {
<a name="l01053"></a>01053             NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>);
<a name="l01054"></a>01054         }
<a name="l01055"></a>01055     }
<a name="l01056"></a>01056     <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059 <span class="comment">/*</span>
<a name="l01060"></a>01060 <span class="comment"> * \brief</span>
<a name="l01061"></a>01061 <span class="comment"> * Process incoming segments in SYN-RECEIVED state.</span>
<a name="l01062"></a>01062 <span class="comment"> *</span>
<a name="l01063"></a>01063 <span class="comment"> * Waiting for a confirming connection request</span>
<a name="l01064"></a>01064 <span class="comment"> * acknowledgment after having both received</span>
<a name="l01065"></a>01065 <span class="comment"> * and sent a connection request.</span>
<a name="l01066"></a>01066 <span class="comment"> *</span>
<a name="l01067"></a>01067 <span class="comment"> * \param sock Socket descriptor.</span>
<a name="l01068"></a>01068 <span class="comment"> * \param nb   Network buffer structure containing a TCP segment.</span>
<a name="l01069"></a>01069 <span class="comment"> */</span>
<a name="l01070"></a>01070 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateSynReceived(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01071"></a>01071 {
<a name="l01072"></a>01072     <span class="comment">/*</span>
<a name="l01073"></a>01073 <span class="comment">     * If our previous ack receives a reset response,</span>
<a name="l01074"></a>01074 <span class="comment">     * then we fall back to the listening state.</span>
<a name="l01075"></a>01075 <span class="comment">     */</span>
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01077"></a>01077         <span class="keywordflow">if</span> (sock-&gt;so_pc_tq)
<a name="l01078"></a>01078             NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>);
<a name="l01079"></a>01079         <span class="keywordflow">else</span> 
<a name="l01080"></a>01080             <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(sock, <a class="code" href="errno_8h.html#ad88020b394ef1aa4af2f4ef9b4c8b39">ECONNREFUSED</a>);
<a name="l01081"></a>01081         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01082"></a>01082         sock-&gt;so_retran_time = 0;
<a name="l01083"></a>01083         <a class="code" href="group__xg_tcp_socket.html#ge062b546a18e3a15d4fa87209d6160ca">NutTcpDiscardBuffers</a>(sock);
<a name="l01084"></a>01084         <span class="keywordflow">return</span>;
<a name="l01085"></a>01085     }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     <span class="comment">/*</span>
<a name="l01088"></a>01088 <span class="comment">     * Reject SYNs.</span>
<a name="l01089"></a>01089 <span class="comment">     */</span>
<a name="l01090"></a>01090     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01091"></a>01091         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01092"></a>01092         <span class="keywordflow">return</span>;
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="comment">/*</span>
<a name="l01096"></a>01096 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01097"></a>01097 <span class="comment">     */</span>
<a name="l01098"></a>01098     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01099"></a>01099         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01100"></a>01100         <span class="keywordflow">return</span>;
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="comment">/*</span>
<a name="l01104"></a>01104 <span class="comment">     * Reject out of window sequence.</span>
<a name="l01105"></a>01105 <span class="comment">     */</span>
<a name="l01106"></a>01106     <span class="keywordflow">if</span> (!<a class="code" href="group__xg_t_c_p.html#gcff7d63177023b5f4a6d1f9c32e7e7ab" title="Sequence number comparisons.">IsInLimits</a>(<a class="code" href="group__xg_nut_o_s.html#gc317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#49e29d973cc4b0d4bddfdf027550fb5f" title="Expected sequence number of next octet.">th_ack</a>), sock-&gt;so_tx_una + 1, sock-&gt;so_tx_nxt)) {
<a name="l01107"></a>01107         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01108"></a>01108         <span class="keywordflow">return</span>;
<a name="l01109"></a>01109     }
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     <span class="comment">/* Acknowledge processing. */</span>
<a name="l01112"></a>01112     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     <span class="comment">/*</span>
<a name="l01115"></a>01115 <span class="comment">     * Even SYN segments may contain application data, which will be stored</span>
<a name="l01116"></a>01116 <span class="comment">     * in the socket's input buffer. However, there is no need to post an</span>
<a name="l01117"></a>01117 <span class="comment">     * event to any thread waiting for data, because our connection is not </span>
<a name="l01118"></a>01118 <span class="comment">     * yet established.</span>
<a name="l01119"></a>01119 <span class="comment">     */</span>
<a name="l01120"></a>01120     <span class="keywordflow">if</span> (nb-&gt;nb_ap.sz)
<a name="l01121"></a>01121         NutTcpProcessAppData(sock, nb);
<a name="l01122"></a>01122     <span class="keywordflow">else</span>
<a name="l01123"></a>01123         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">/*</span>
<a name="l01126"></a>01126 <span class="comment">     * Process state change.</span>
<a name="l01127"></a>01127 <span class="comment">     */</span>
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="netinet_2tcp_8h.html#1cec9b372679734fcd8394d779442ddb" title="Finishing transmission.">TH_FIN</a>) {
<a name="l01129"></a>01129         sock-&gt;so_rx_nxt++;
<a name="l01130"></a>01130         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>);
<a name="l01131"></a>01131     } <span class="keywordflow">else</span> {
<a name="l01132"></a>01132         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>);
<a name="l01133"></a>01133         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;sock-&gt;so_pc_tq);
<a name="l01134"></a>01134         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;sock-&gt;so_ac_tq);
<a name="l01135"></a>01135     }
<a name="l01136"></a>01136 }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138 <span class="comment">/*</span>
<a name="l01139"></a>01139 <span class="comment"> * \brief Process incoming segments from established connections.</span>
<a name="l01140"></a>01140 <span class="comment"> *</span>
<a name="l01141"></a>01141 <span class="comment"> * Received application data will be delivered to the application</span>
<a name="l01142"></a>01142 <span class="comment"> * until we receive a FIN segment.</span>
<a name="l01143"></a>01143 <span class="comment"> *</span>
<a name="l01144"></a>01144 <span class="comment"> * \param sock  Socket descriptor.</span>
<a name="l01145"></a>01145 <span class="comment"> * \param flags TCP flags.</span>
<a name="l01146"></a>01146 <span class="comment"> * \param th    Pointer to the TCP header within the NETBUF.</span>
<a name="l01147"></a>01147 <span class="comment"> * \param nb    Network buffer structure containing a TCP segment.</span>
<a name="l01148"></a>01148 <span class="comment"> *</span>
<a name="l01149"></a>01149 <span class="comment"> * \todo We may remove the unused counter of dropped segments, which</span>
<a name="l01150"></a>01150 <span class="comment"> *       were out of sequence.</span>
<a name="l01151"></a>01151 <span class="comment"> */</span>
<a name="l01152"></a>01152 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateEstablished(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01153"></a>01153 {
<a name="l01154"></a>01154     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01155"></a>01155         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01156"></a>01156         <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(sock, <a class="code" href="errno_8h.html#dd4258b08af02fbe4590fbaae7260037">ECONNRESET</a>);
<a name="l01157"></a>01157         <span class="keywordflow">return</span>;
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="comment">/*</span>
<a name="l01161"></a>01161 <span class="comment">     * Reject SYNs. Silently discard late SYNs</span>
<a name="l01162"></a>01162 <span class="comment">     * (Thanks to Mike Cornelius).</span>
<a name="l01163"></a>01163 <span class="comment">     */</span>
<a name="l01164"></a>01164     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01165"></a>01165         <span class="keywordflow">if</span> (<a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>) != sock-&gt;so_rx_isn)
<a name="l01166"></a>01166             <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01167"></a>01167         <span class="keywordflow">else</span>
<a name="l01168"></a>01168             <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01169"></a>01169         <span class="keywordflow">return</span>;
<a name="l01170"></a>01170     }
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="comment">/*</span>
<a name="l01173"></a>01173 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01174"></a>01174 <span class="comment">     */</span>
<a name="l01175"></a>01175     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01176"></a>01176         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01177"></a>01177         <span class="keywordflow">return</span>;
<a name="l01178"></a>01178     }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="comment">/*</span>
<a name="l01183"></a>01183 <span class="comment">     * If the sequence number of the incoming segment is larger than </span>
<a name="l01184"></a>01184 <span class="comment">     * expected, we probably missed one or more previous segments. Let's </span>
<a name="l01185"></a>01185 <span class="comment">     * add this one to a linked list of segments received in advance and </span>
<a name="l01186"></a>01186 <span class="comment">     * hope that the missing data will arrive later.</span>
<a name="l01187"></a>01187 <span class="comment">     */</span>
<a name="l01188"></a>01188     <span class="keywordflow">if</span> (<a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>) &gt; sock-&gt;so_rx_nxt) {
<a name="l01189"></a>01189         NETBUF *nbq;
<a name="l01190"></a>01190         NETBUF **nbqp;
<a name="l01191"></a>01191         <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *thq;
<a name="l01192"></a>01192         <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> th_seq;
<a name="l01193"></a>01193         <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> thq_seq;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195         <span class="keywordflow">if</span> (nb-&gt;nb_ap.sz) {
<a name="l01196"></a>01196             nbq = sock-&gt;so_rx_nbq;
<a name="l01197"></a>01197             nbqp = &amp;sock-&gt;so_rx_nbq;
<a name="l01198"></a>01198             <span class="keywordflow">while</span> (nbq) {
<a name="l01199"></a>01199                 thq = (<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *) (nbq-&gt;nb_tp.vp);
<a name="l01200"></a>01200                 th_seq = <a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>);
<a name="l01201"></a>01201                 thq_seq = <a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(thq-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>);
<a name="l01202"></a>01202                 <span class="keywordflow">if</span> (th_seq &lt; thq_seq) {
<a name="l01203"></a>01203                     *nbqp = nb;
<a name="l01204"></a>01204                     nb-&gt;nb_next = nbq;
<a name="l01205"></a>01205                     <span class="keywordflow">break</span>;
<a name="l01206"></a>01206                 }
<a name="l01207"></a>01207                 <span class="keywordflow">if</span> (th_seq == thq_seq) {
<a name="l01208"></a>01208                     <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01209"></a>01209                     sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l01210"></a>01210                     <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0);
<a name="l01211"></a>01211                     <span class="keywordflow">return</span>;
<a name="l01212"></a>01212                 }
<a name="l01213"></a>01213                 nbqp = &amp;nbq-&gt;nb_next;
<a name="l01214"></a>01214                 nbq = nbq-&gt;nb_next;
<a name="l01215"></a>01215             }
<a name="l01216"></a>01216             <span class="keywordflow">if</span> (nbq == 0) {
<a name="l01217"></a>01217                 *nbqp = nb;
<a name="l01218"></a>01218                 nb-&gt;nb_next = 0;
<a name="l01219"></a>01219             }
<a name="l01220"></a>01220         } <span class="keywordflow">else</span>
<a name="l01221"></a>01221             <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l01224"></a>01224         <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0);
<a name="l01225"></a>01225         <span class="keywordflow">return</span>;
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="comment">/*</span>
<a name="l01229"></a>01229 <span class="comment">     * Acknowledge any sequence numbers not expected, </span>
<a name="l01230"></a>01230 <span class="comment">     * even if they do not contain any data. Keepalive</span>
<a name="l01231"></a>01231 <span class="comment">     * packets contain a sequence number one less</span>
<a name="l01232"></a>01232 <span class="comment">     * than the next data expected and they do not </span>
<a name="l01233"></a>01233 <span class="comment">     * contain any data.</span>
<a name="l01234"></a>01234 <span class="comment">     */</span>
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (<a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>) != sock-&gt;so_rx_nxt) {
<a name="l01236"></a>01236         sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a> | <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l01237"></a>01237         <span class="comment">/* This seems to be unused. */</span>
<a name="l01238"></a>01238         sock-&gt;so_oos_drop++;
<a name="l01239"></a>01239         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01240"></a>01240         <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0);
<a name="l01241"></a>01241     } 
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     <span class="comment">/*</span>
<a name="l01244"></a>01244 <span class="comment">     * The sequence number is exactly what we expected.</span>
<a name="l01245"></a>01245 <span class="comment">     */</span>
<a name="l01246"></a>01246     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nb-&gt;nb_ap.sz) {
<a name="l01247"></a>01247         NutTcpProcessAppData(sock, nb);
<a name="l01248"></a>01248         <span class="comment">/*</span>
<a name="l01249"></a>01249 <span class="comment">         * Process segments we may have received in advance.</span>
<a name="l01250"></a>01250 <span class="comment">         */</span>
<a name="l01251"></a>01251         <span class="keywordflow">while</span> ((nb = sock-&gt;so_rx_nbq) != 0) {
<a name="l01252"></a>01252             th = (<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *) (nb-&gt;nb_tp.vp);
<a name="l01253"></a>01253             <span class="keywordflow">if</span> (<a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>) &gt; sock-&gt;so_rx_nxt)
<a name="l01254"></a>01254                 <span class="keywordflow">break</span>;
<a name="l01255"></a>01255             sock-&gt;so_rx_nbq = nb-&gt;nb_next;
<a name="l01256"></a>01256             <span class="keywordflow">if</span> (<a class="code" href="group__xg_nut_o_s.html#ge4027a6ad07f13aa12eab285a1b46019" title="Convert long value from host to network byte order.">htonl</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#7d35bbc09de8bc960bf47320bab2bf74" title="Sequence number of first octet in this segment.">th_seq</a>) == sock-&gt;so_rx_nxt) {
<a name="l01257"></a>01257                 NutTcpProcessAppData(sock, nb);
<a name="l01258"></a>01258                 flags |= th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#0d142ef566a2a01dd8dbdad8a66aef95" title="Control flags.">th_flags</a>;
<a name="l01259"></a>01259             } <span class="keywordflow">else</span>
<a name="l01260"></a>01260                 <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01261"></a>01261         }
<a name="l01262"></a>01262         <span class="comment">/* Wake up a thread waiting for data. */</span>
<a name="l01263"></a>01263         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;sock-&gt;so_rx_tq);
<a name="l01264"></a>01264     } <span class="keywordflow">else</span> {
<a name="l01265"></a>01265         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01266"></a>01266         <span class="comment">//sock-&gt;so_tx_flags |= SO_ACK | SO_FORCE;</span>
<a name="l01267"></a>01267         <span class="comment">//NutTcpOutput(sock, 0, 0);</span>
<a name="l01268"></a>01268     }
<a name="l01269"></a>01269     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="netinet_2tcp_8h.html#1cec9b372679734fcd8394d779442ddb" title="Finishing transmission.">TH_FIN</a>) {
<a name="l01270"></a>01270         <span class="comment">//@@@printf ("[%04X]ESTABLISHED: going to CLOSE_WAIT\n", (u_short) sock);</span>
<a name="l01271"></a>01271         sock-&gt;so_rx_nxt++;
<a name="l01272"></a>01272         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>);
<a name="l01273"></a>01273     }
<a name="l01274"></a>01274 }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276 <span class="comment">/*</span>
<a name="l01277"></a>01277 <span class="comment"> * \brief Process incoming segments in FIN-WAIT1 state.</span>
<a name="l01278"></a>01278 <span class="comment"> *</span>
<a name="l01279"></a>01279 <span class="comment"> * Waiting for a connection termination request</span>
<a name="l01280"></a>01280 <span class="comment"> * from the remote, or an acknowledgment of the</span>
<a name="l01281"></a>01281 <span class="comment"> * connection termination request previously sent.</span>
<a name="l01282"></a>01282 <span class="comment"> *</span>
<a name="l01283"></a>01283 <span class="comment"> * The application already closed the socket.</span>
<a name="l01284"></a>01284 <span class="comment"> *</span>
<a name="l01285"></a>01285 <span class="comment"> * \param sock Socket descriptor.</span>
<a name="l01286"></a>01286 <span class="comment"> * \param nb   Network buffer structure containing a TCP segment.</span>
<a name="l01287"></a>01287 <span class="comment"> *</span>
<a name="l01288"></a>01288 <span class="comment"> * \todo The out of sync case seems to be ignored. Anyway, do we</span>
<a name="l01289"></a>01289 <span class="comment"> *       really need to process application data in this state?</span>
<a name="l01290"></a>01290 <span class="comment"> */</span>
<a name="l01291"></a>01291 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateFinWait1(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01292"></a>01292 {
<a name="l01293"></a>01293     <span class="comment">//@@@printf ("[%04X]FIN_WAIT_1: incomming segment, IP %04X\n", (u_short) sock, ntohs(((IPHDR*)nb-&gt;nb_nw.vp)-&gt;ip_id));</span>
<a name="l01294"></a>01294     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01295"></a>01295         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01296"></a>01296         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l01297"></a>01297         <span class="keywordflow">return</span>;
<a name="l01298"></a>01298     }
<a name="l01299"></a>01299 
<a name="l01300"></a>01300     <span class="comment">/*</span>
<a name="l01301"></a>01301 <span class="comment">     * Reject SYNs.</span>
<a name="l01302"></a>01302 <span class="comment">     */</span>
<a name="l01303"></a>01303     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01304"></a>01304         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01305"></a>01305         <span class="keywordflow">return</span>;
<a name="l01306"></a>01306     }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308     <span class="comment">/*</span>
<a name="l01309"></a>01309 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01310"></a>01310 <span class="comment">     */</span>
<a name="l01311"></a>01311     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01312"></a>01312         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01313"></a>01313         <span class="keywordflow">return</span>;
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     <span class="comment">//@@@if (flags &amp; TH_FIN) printf ("[%04X]FIN_WAIT_1: received FIN\n", (u_short) sock);</span>
<a name="l01317"></a>01317     <span class="comment">//@@@printf ("[%04X]FIN_WAIT_1: received ACK: %lu, unack: %lu, next: %lu\n", (u_short) sock, ntohl(th-&gt;th_ack), sock-&gt;so_tx_una, sock-&gt;so_tx_nxt);</span>
<a name="l01318"></a>01318     
<a name="l01319"></a>01319     <span class="comment">//@@@printf ("[%04X]FIN_WAIT_1:  pre processack, nbq: %04X\n", (u_short) sock, (u_short) sock-&gt;so_tx_nbq);</span>
<a name="l01320"></a>01320     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01321"></a>01321     <span class="comment">//@@@printf ("[%04X]FIN_WAIT_1: post processack, nbq: %04X\n", (u_short) sock, (u_short) sock-&gt;so_tx_nbq);</span>
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     <span class="comment">/*</span>
<a name="l01324"></a>01324 <span class="comment">     * All segments had been acknowledged, including our FIN.</span>
<a name="l01325"></a>01325 <span class="comment">     */</span>
<a name="l01326"></a>01326     <span class="keywordflow">if</span> (sock-&gt;so_tx_nxt == sock-&gt;so_tx_una) {
<a name="l01327"></a>01327         <span class="comment">//@@@printf ("[%04X]FIN_WAIT_1: going to FIN_WAIT_2\n", (u_short) sock);</span>
<a name="l01328"></a>01328         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>);
<a name="l01329"></a>01329     }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331     <span class="comment">/*</span>
<a name="l01332"></a>01332 <span class="comment">     * Process application data and release the network buffer.</span>
<a name="l01333"></a>01333 <span class="comment">     * Is this really required?</span>
<a name="l01334"></a>01334 <span class="comment">     */</span>
<a name="l01335"></a>01335     <span class="keywordflow">if</span> (nb-&gt;nb_ap.sz) {
<a name="l01336"></a>01336         NutTcpProcessAppData(sock, nb);
<a name="l01337"></a>01337         <span class="comment">/* Wake up a thread waiting for data. */</span>
<a name="l01338"></a>01338         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;sock-&gt;so_rx_tq);
<a name="l01339"></a>01339     }
<a name="l01340"></a>01340     <span class="keywordflow">else</span>
<a name="l01341"></a>01341         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01342"></a>01342 
<a name="l01343"></a>01343     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="netinet_2tcp_8h.html#1cec9b372679734fcd8394d779442ddb" title="Finishing transmission.">TH_FIN</a>) {
<a name="l01344"></a>01344         sock-&gt;so_rx_nxt++;
<a name="l01345"></a>01345         <span class="comment">/* </span>
<a name="l01346"></a>01346 <span class="comment">         * Our FIN has been acked.</span>
<a name="l01347"></a>01347 <span class="comment">         */</span>
<a name="l01348"></a>01348         sock-&gt;so_time_wait = 0;
<a name="l01349"></a>01349         <span class="comment">//@@@printf ("[%04X]FIN_WAIT_1: going to CLOSING\n", (u_short) sock);</span>
<a name="l01350"></a>01350         <span class="keywordflow">if</span> (sock-&gt;so_state == <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>)
<a name="l01351"></a>01351             NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>);
<a name="l01352"></a>01352         <span class="keywordflow">else</span>
<a name="l01353"></a>01353             NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#1be9cca16dc9d0363d31ee80c98bc8bf" title="closed xchd FIN; await FIN ACK">TCPS_CLOSING</a>);
<a name="l01354"></a>01354     }
<a name="l01355"></a>01355 }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357 <span class="comment">/*</span>
<a name="l01358"></a>01358 <span class="comment"> * \brief Process incoming segments in FIN-WAIT2 state.</span>
<a name="l01359"></a>01359 <span class="comment"> *</span>
<a name="l01360"></a>01360 <span class="comment"> * Waiting for a connection termination request</span>
<a name="l01361"></a>01361 <span class="comment"> * from the remote.</span>
<a name="l01362"></a>01362 <span class="comment"> *</span>
<a name="l01363"></a>01363 <span class="comment"> * The application already closed the socket.</span>
<a name="l01364"></a>01364 <span class="comment"> *</span>
<a name="l01365"></a>01365 <span class="comment"> * \param sock Socket descriptor.</span>
<a name="l01366"></a>01366 <span class="comment"> * \param nb   Network buffer structure containing a TCP segment.</span>
<a name="l01367"></a>01367 <span class="comment"> *</span>
<a name="l01368"></a>01368 <span class="comment"> * \todo There's probably no need to process application data.</span>
<a name="l01369"></a>01369 <span class="comment"> */</span>
<a name="l01370"></a>01370 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateFinWait2(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01371"></a>01371 {
<a name="l01372"></a>01372     <span class="comment">//@@@printf ("[%04X]FIN_WAIT_2: incomming segment, IP %04X\n", (u_short) sock, ntohs(((IPHDR*)nb-&gt;nb_nw.vp)-&gt;ip_id));</span>
<a name="l01373"></a>01373     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01374"></a>01374         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01375"></a>01375         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l01376"></a>01376         <span class="keywordflow">return</span>;
<a name="l01377"></a>01377     }
<a name="l01378"></a>01378 
<a name="l01379"></a>01379     <span class="comment">/*</span>
<a name="l01380"></a>01380 <span class="comment">     * Reject SYNs.</span>
<a name="l01381"></a>01381 <span class="comment">     */</span>
<a name="l01382"></a>01382     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01383"></a>01383         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01384"></a>01384         <span class="keywordflow">return</span>;
<a name="l01385"></a>01385     }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387     <span class="comment">/*</span>
<a name="l01388"></a>01388 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01389"></a>01389 <span class="comment">     */</span>
<a name="l01390"></a>01390     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01391"></a>01391         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01392"></a>01392         <span class="keywordflow">return</span>;
<a name="l01393"></a>01393     }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395     <span class="comment">//@@@printf ("[%04X]FIN_WAIT_2: received ACK: %lu, unack: %lu, next: %lu\n", (u_short) sock, ntohl(th-&gt;th_ack), sock-&gt;so_tx_una, sock-&gt;so_tx_nxt);</span>
<a name="l01396"></a>01396     <span class="comment">/*</span>
<a name="l01397"></a>01397 <span class="comment">     * Process acknowledge and application data and release the </span>
<a name="l01398"></a>01398 <span class="comment">     * network buffer.</span>
<a name="l01399"></a>01399 <span class="comment">     */</span>
<a name="l01400"></a>01400     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01401"></a>01401 
<a name="l01402"></a>01402     <span class="comment">//@@@if (sock-&gt;so_tx_nbq) printf ("[%04X]FIN_WAIT_2: xmit buffer not empty!", (u_short) sock);</span>
<a name="l01403"></a>01403     <span class="comment">/* Do we really need this? */</span>
<a name="l01404"></a>01404     <span class="keywordflow">if</span> (nb-&gt;nb_ap.sz) {
<a name="l01405"></a>01405         NutTcpProcessAppData(sock, nb);
<a name="l01406"></a>01406         <span class="comment">/* Wake up a thread waiting for data. */</span>
<a name="l01407"></a>01407         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;sock-&gt;so_rx_tq);
<a name="l01408"></a>01408     }
<a name="l01409"></a>01409     <span class="keywordflow">else</span>
<a name="l01410"></a>01410         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01411"></a>01411 
<a name="l01412"></a>01412     <span class="keywordflow">if</span> (flags &amp; TH_FIN) {
<a name="l01413"></a>01413         sock-&gt;so_rx_nxt++;
<a name="l01414"></a>01414         sock-&gt;so_time_wait = 0;
<a name="l01415"></a>01415         <span class="comment">//@@@printf ("[%04X]FIN_WAIT_2: going to TIME_WAIT\n", (u_short) sock);</span>
<a name="l01416"></a>01416         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>);
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 <span class="comment">/*</span>
<a name="l01421"></a>01421 <span class="comment"> * \brief</span>
<a name="l01422"></a>01422 <span class="comment"> * Process incoming segments in CLOSE-WAIT state.</span>
<a name="l01423"></a>01423 <span class="comment"> *</span>
<a name="l01424"></a>01424 <span class="comment"> * Waiting for a connection termination request</span>
<a name="l01425"></a>01425 <span class="comment"> * from the local application.</span>
<a name="l01426"></a>01426 <span class="comment"> *</span>
<a name="l01427"></a>01427 <span class="comment"> * \param sock Socket descriptor.</span>
<a name="l01428"></a>01428 <span class="comment"> * \param nb   Network buffer structure containing a TCP segment.</span>
<a name="l01429"></a>01429 <span class="comment"> */</span>
<a name="l01430"></a>01430 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateCloseWait(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01431"></a>01431 {
<a name="l01432"></a>01432     <span class="comment">//@@@printf ("[%04X]CLOSE_WAIT: incomming segment, IP %04X\n", (u_short) sock, ((IPHDR*)nb-&gt;nb_nw.vp)-&gt;ip_id);</span>
<a name="l01433"></a>01433     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01434"></a>01434         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01435"></a>01435         <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(sock, <a class="code" href="errno_8h.html#dd4258b08af02fbe4590fbaae7260037">ECONNRESET</a>);
<a name="l01436"></a>01436         <span class="keywordflow">return</span>;
<a name="l01437"></a>01437     }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="comment">/*</span>
<a name="l01440"></a>01440 <span class="comment">     * Reject SYNs.</span>
<a name="l01441"></a>01441 <span class="comment">     */</span>
<a name="l01442"></a>01442     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01443"></a>01443         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01444"></a>01444         <span class="keywordflow">return</span>;
<a name="l01445"></a>01445     }
<a name="l01446"></a>01446 
<a name="l01447"></a>01447     <span class="comment">/*</span>
<a name="l01448"></a>01448 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01449"></a>01449 <span class="comment">     */</span>
<a name="l01450"></a>01450     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01451"></a>01451         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01452"></a>01452         <span class="keywordflow">return</span>;
<a name="l01453"></a>01453     }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01456"></a>01456 
<a name="l01457"></a>01457     <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01458"></a>01458 }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460 <span class="comment">/*</span>
<a name="l01461"></a>01461 <span class="comment"> * \brief</span>
<a name="l01462"></a>01462 <span class="comment"> * Process incoming segments in CLOSING state.</span>
<a name="l01463"></a>01463 <span class="comment"> *</span>
<a name="l01464"></a>01464 <span class="comment"> * Waiting for a connection termination request</span>
<a name="l01465"></a>01465 <span class="comment"> * acknowledgment from the remote.</span>
<a name="l01466"></a>01466 <span class="comment"> *</span>
<a name="l01467"></a>01467 <span class="comment"> * The application already closed the socket.</span>
<a name="l01468"></a>01468 <span class="comment"> *</span>
<a name="l01469"></a>01469 <span class="comment"> * \param sock Socket descriptor.</span>
<a name="l01470"></a>01470 <span class="comment"> * \param nb   Network buffer structure containing a TCP segment.</span>
<a name="l01471"></a>01471 <span class="comment"> */</span>
<a name="l01472"></a>01472 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateClosing(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01473"></a>01473 {
<a name="l01474"></a>01474     <span class="comment">//@@@printf ("[%04X]CLOSING: Incomming segment\n", (u_short) sock);</span>
<a name="l01475"></a>01475     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01476"></a>01476         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01477"></a>01477         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l01478"></a>01478         <span class="keywordflow">return</span>;
<a name="l01479"></a>01479     }
<a name="l01480"></a>01480 
<a name="l01481"></a>01481     <span class="comment">/*</span>
<a name="l01482"></a>01482 <span class="comment">     * Reject SYNs.</span>
<a name="l01483"></a>01483 <span class="comment">     */</span>
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01485"></a>01485         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01486"></a>01486         <span class="keywordflow">return</span>;
<a name="l01487"></a>01487     }
<a name="l01488"></a>01488 
<a name="l01489"></a>01489     <span class="comment">/*</span>
<a name="l01490"></a>01490 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01491"></a>01491 <span class="comment">     */</span>
<a name="l01492"></a>01492     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01493"></a>01493         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01494"></a>01494         <span class="keywordflow">return</span>;
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <span class="comment">/*</span>
<a name="l01500"></a>01500 <span class="comment">     * All segments had been acknowledged, including our FIN.</span>
<a name="l01501"></a>01501 <span class="comment">     */</span>
<a name="l01502"></a>01502     <span class="keywordflow">if</span> (sock-&gt;so_tx_nxt == sock-&gt;so_tx_una) {
<a name="l01503"></a>01503         sock-&gt;so_time_wait = 0;
<a name="l01504"></a>01504         NutTcpStateChange(sock, <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>);
<a name="l01505"></a>01505         <span class="comment">//@@@printf ("[%04X]CLOSING: Going to TIME_WAIT\n", (u_short) sock);</span>
<a name="l01506"></a>01506     }
<a name="l01507"></a>01507     <span class="comment">//@@@else printf ("[%04X]CLOSING: NOT changing state\n", (u_short) sock);</span>
<a name="l01508"></a>01508 
<a name="l01509"></a>01509     <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01510"></a>01510 }
<a name="l01511"></a>01511 
<a name="l01526"></a>01526 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateLastAck(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags, <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> * th, NETBUF * nb)
<a name="l01527"></a>01527 {
<a name="l01528"></a>01528     <span class="comment">//@@@printf ("[%04X]LAST_ACK: incomming segment, IP %04X\n", (u_short) sock, ((IPHDR*)nb-&gt;nb_nw.vp)-&gt;ip_id);</span>
<a name="l01529"></a>01529     <span class="keywordflow">if</span> (flags &amp; TH_RST) {
<a name="l01530"></a>01530         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01531"></a>01531         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l01532"></a>01532         <span class="keywordflow">return</span>;
<a name="l01533"></a>01533     }
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     <span class="comment">/*</span>
<a name="l01536"></a>01536 <span class="comment">     * Reject SYNs.</span>
<a name="l01537"></a>01537 <span class="comment">     */</span>
<a name="l01538"></a>01538     <span class="keywordflow">if</span> (flags &amp; TH_SYN) {
<a name="l01539"></a>01539         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01540"></a>01540         <span class="keywordflow">return</span>;
<a name="l01541"></a>01541     }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     <span class="comment">/*</span>
<a name="l01544"></a>01544 <span class="comment">     * Silently discard segments without ACK.</span>
<a name="l01545"></a>01545 <span class="comment">     */</span>
<a name="l01546"></a>01546     <span class="keywordflow">if</span> ((flags &amp; TH_ACK) == 0) {
<a name="l01547"></a>01547         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01548"></a>01548         <span class="keywordflow">return</span>;
<a name="l01549"></a>01549     }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551     NutTcpProcessAck(sock, th, nb-&gt;nb_ap.sz);
<a name="l01552"></a>01552     <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01553"></a>01553 
<a name="l01554"></a>01554     <span class="keywordflow">if</span> (sock-&gt;so_tx_nxt == sock-&gt;so_tx_una) 
<a name="l01555"></a>01555         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l01556"></a>01556     <span class="comment">//@@@else printf ("[%04X]LAST_ACK: no destroy sock\n", (u_short) sock);</span>
<a name="l01557"></a>01557 }
<a name="l01558"></a>01558 
<a name="l01569"></a>01569 <span class="keyword">static</span> <span class="keywordtype">void</span> NutTcpStateProcess(TCPSOCKET * sock, NETBUF * nb)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> tx_win;
<a name="l01572"></a>01572     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> tx_una;
<a name="l01573"></a>01573     <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *th = (<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *) nb-&gt;nb_tp.vp;
<a name="l01574"></a>01574     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> flags = th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#0d142ef566a2a01dd8dbdad8a66aef95" title="Control flags.">th_flags</a>;
<a name="l01575"></a>01575 
<a name="l01576"></a>01576 #ifdef NUTDEBUG
<a name="l01577"></a>01577     if (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l01578"></a>01578         <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">" %04x-"</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) sock);
<a name="l01579"></a>01579         <a class="code" href="netdebug_8h.html#87cbcba93ddf1f08d4fc58307ef8780c">NutDumpSockState</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, sock-&gt;so_state, <span class="stringliteral">"["</span>, <span class="stringliteral">"&gt;]"</span>);
<a name="l01580"></a>01580     }
<a name="l01581"></a>01581 <span class="preprocessor">#endif</span>
<a name="l01582"></a>01582 <span class="preprocessor"></span>    <span class="keywordflow">switch</span> (sock-&gt;so_state) {
<a name="l01583"></a>01583         <span class="comment">/* Handle the most common case first. */</span>
<a name="l01584"></a>01584     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a>:
<a name="l01585"></a>01585         tx_win = sock-&gt;so_tx_win;
<a name="l01586"></a>01586         tx_una = sock-&gt;so_tx_una;
<a name="l01587"></a>01587         NutTcpStateEstablished(sock, flags, th, nb);
<a name="l01588"></a>01588         <span class="comment">/* Wake up all threads waiting for transmit, if something interesting happened. */</span>
<a name="l01589"></a>01589         <span class="keywordflow">if</span>(sock-&gt;so_state != <a class="code" href="tcp__fsm_8h.html#aee5f0ed8e8577e942860fd22415fe70" title="established">TCPS_ESTABLISHED</a> || <span class="comment">/* Status changed. */</span>
<a name="l01590"></a>01590            sock-&gt;so_tx_win &gt; tx_win ||           <span class="comment">/* Windows changed. */</span>
<a name="l01591"></a>01591            sock-&gt;so_tx_una &gt; tx_una) {           <span class="comment">/* Unacknowledged data changed. */</span>
<a name="l01592"></a>01592             <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_tx_tq);
<a name="l01593"></a>01593         }
<a name="l01594"></a>01594         <span class="keywordflow">break</span>;
<a name="l01595"></a>01595     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>:
<a name="l01596"></a>01596         NutTcpStateListen(sock, flags, th, nb);
<a name="l01597"></a>01597         <span class="keywordflow">break</span>;
<a name="l01598"></a>01598     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b17abd4e2132d0e1145dba3b50e8229b" title="active, have sent syn">TCPS_SYN_SENT</a>:
<a name="l01599"></a>01599         NutTcpStateSynSent(sock, flags, th, nb);
<a name="l01600"></a>01600         <span class="keywordflow">break</span>;
<a name="l01601"></a>01601     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>:
<a name="l01602"></a>01602         NutTcpStateSynReceived(sock, flags, th, nb);
<a name="l01603"></a>01603         <span class="keywordflow">break</span>;
<a name="l01604"></a>01604     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>:
<a name="l01605"></a>01605         NutTcpStateFinWait1(sock, flags, th, nb);
<a name="l01606"></a>01606         <span class="keywordflow">break</span>;
<a name="l01607"></a>01607     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>:
<a name="l01608"></a>01608         NutTcpStateFinWait2(sock, flags, th, nb);
<a name="l01609"></a>01609         <span class="keywordflow">break</span>;
<a name="l01610"></a>01610     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#c5b30597ddc7a4b704f1be18266a630e" title="rcvd fin, waiting for close">TCPS_CLOSE_WAIT</a>:
<a name="l01611"></a>01611         NutTcpStateCloseWait(sock, flags, th, nb);
<a name="l01612"></a>01612         <span class="keywordflow">break</span>;
<a name="l01613"></a>01613     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#1be9cca16dc9d0363d31ee80c98bc8bf" title="closed xchd FIN; await FIN ACK">TCPS_CLOSING</a>:
<a name="l01614"></a>01614         NutTcpStateClosing(sock, flags, th, nb);
<a name="l01615"></a>01615         <span class="keywordflow">break</span>;
<a name="l01616"></a>01616     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#bc253767192111e900d000cf5dac7fee" title="had fin and close; await FIN ACK">TCPS_LAST_ACK</a>:
<a name="l01617"></a>01617         NutTcpStateLastAck(sock, flags, th, nb);
<a name="l01618"></a>01618         <span class="keywordflow">break</span>;
<a name="l01619"></a>01619     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>:
<a name="l01620"></a>01620         <span class="comment">/*</span>
<a name="l01621"></a>01621 <span class="comment">         * Ignore everything while in TIME_WAIT state.</span>
<a name="l01622"></a>01622 <span class="comment">         */</span>
<a name="l01623"></a>01623         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01624"></a>01624         <span class="keywordflow">break</span>;
<a name="l01625"></a>01625     <span class="keywordflow">case</span> <a class="code" href="tcp__fsm_8h.html#f100e134b318729b9824f95ac09ab5d8" title="closed">TCPS_CLOSED</a>:
<a name="l01626"></a>01626         <span class="comment">/*</span>
<a name="l01627"></a>01627 <span class="comment">         * Reject everything while in CLOSED state.</span>
<a name="l01628"></a>01628 <span class="comment">         */</span>
<a name="l01629"></a>01629         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01630"></a>01630         <span class="keywordflow">break</span>;
<a name="l01631"></a>01631     <span class="keywordflow">default</span>:
<a name="l01632"></a>01632         <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01633"></a>01633         <span class="keywordflow">break</span>;
<a name="l01634"></a>01634     }
<a name="l01635"></a>01635 }
<a name="l01636"></a>01636 
<a name="l01643"></a><a class="code" href="group__xg_t_c_p.html#gc0a5f54bde677941f7cf555c2f89a367">01643</a> <a class="code" href="thread_8h.html#9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a class="code" href="group__xg_t_c_p.html#gc0a5f54bde677941f7cf555c2f89a367" title="TCP state machine thread.">NutTcpSm</a>, arg)
<a name="l01644"></a>01644 {
<a name="l01645"></a>01645     NETBUF *nb;
<a name="l01646"></a>01646     NETBUF *nbx;
<a name="l01647"></a>01647     <a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *th;
<a name="l01648"></a>01648     IPHDR *ih;
<a name="l01649"></a>01649     TCPSOCKET *sock;
<a name="l01650"></a>01650     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tac = 0;
<a name="l01651"></a>01651 
<a name="l01652"></a>01652     <span class="comment">/*</span>
<a name="l01653"></a>01653 <span class="comment">     * It won't help giving us a higher priority than the application</span>
<a name="l01654"></a>01654 <span class="comment">     * code. We depend on the speed of the reading application.</span>
<a name="l01655"></a>01655 <span class="comment">     */</span>
<a name="l01656"></a>01656     <a class="code" href="group__xg_thread.html#g8ebe134e9c404072584e80fb8d7e8985" title="Set the current thread&amp;#39;s priority.">NutThreadSetPriority</a> (32);
<a name="l01657"></a>01657     
<a name="l01658"></a>01658     <span class="keywordflow">for</span> (;;) {
<a name="l01659"></a>01659         <span class="keywordflow">if</span> (++tac &gt; 3 || <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;<a class="code" href="group__xg_t_c_p.html#ge222ee1ca91575390b1c8eb98272b8c3">tcp_in_rdy</a>, 200)) {
<a name="l01660"></a>01660             tac = 0;
<a name="l01661"></a>01661             <span class="keywordflow">for</span> (sock = <a class="code" href="group__xg_tcp_socket.html#g2fcec3521061173b7bdd704877a57395">tcpSocketList</a>; sock; sock = sock-&gt;so_next) {
<a name="l01662"></a>01662 
<a name="l01663"></a>01663                 <span class="comment">/*</span>
<a name="l01664"></a>01664 <span class="comment">                 * Send late acks.</span>
<a name="l01665"></a>01665 <span class="comment">                 */</span>
<a name="l01666"></a>01666                 <span class="keywordflow">if</span> (sock-&gt;so_tx_flags &amp; <a class="code" href="group__xg_tcp_socket.html#gb60d40db730ce72950328301beae2c1c" title="Socket transmit flag. Send ACK.">SO_ACK</a>) {
<a name="l01667"></a>01667                     sock-&gt;so_tx_flags |= <a class="code" href="group__xg_tcp_socket.html#g070f5c81fc9c6442a0576f42d67c794c" title="Socket transmit flag. Force sending ACK.">SO_FORCE</a>;
<a name="l01668"></a>01668                     <a class="code" href="sock__var_8h.html#2dbf5a03e60e89a32ffcfd429aa81775" title="Initiate TCP segment transmission.">NutTcpOutput</a>(sock, 0, 0);
<a name="l01669"></a>01669                 }
<a name="l01670"></a>01670 
<a name="l01671"></a>01671                 <span class="comment">/*</span>
<a name="l01672"></a>01672 <span class="comment">                 * Process retransmit timer.</span>
<a name="l01673"></a>01673 <span class="comment">                 */</span>
<a name="l01674"></a>01674                 <span class="keywordflow">if</span> (sock-&gt;so_tx_nbq &amp;&amp; sock-&gt;so_retran_time) {
<a name="l01675"></a>01675                     <span class="keywordflow">if</span> ((<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>)((<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>)<a class="code" href="group__xg_timer.html#gc1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() - sock-&gt;so_retran_time) &gt; sock-&gt;so_rtto) {
<a name="l01676"></a>01676                         <a class="code" href="group__xg_t_c_p.html#gd8b7767f85c9dc3cd4a1f1f961ae7a84" title="Retransmit a segment after ACK timeout.">NutTcpStateRetranTimeout</a>(sock);
<a name="l01677"></a>01677                     }
<a name="l01678"></a>01678                 }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680                 <span class="comment">/*</span>
<a name="l01681"></a>01681 <span class="comment">                 * Destroy sockets after timeout in TIMEWAIT state.</span>
<a name="l01682"></a>01682 <span class="comment">                 */</span>
<a name="l01683"></a>01683                 <span class="keywordflow">if</span> (sock-&gt;so_state == <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a> || sock-&gt;so_state == <a class="code" href="tcp__fsm_8h.html#d851e16acce9ea476f312543755d7573" title="have closed, fin is acked">TCPS_FIN_WAIT_2</a>) {
<a name="l01684"></a>01684                     <span class="keywordflow">if</span> (sock-&gt;so_time_wait++ &gt;= 9) {
<a name="l01685"></a>01685                         <a class="code" href="group__xg_tcp_socket.html#g551224f0a840a9cbf97b4d49dbc7c018" title="Destroy a previously allocated socket.">NutTcpDestroySocket</a>(sock);
<a name="l01686"></a>01686                         <span class="keywordflow">break</span>;
<a name="l01687"></a>01687                     }
<a name="l01688"></a>01688                 }
<a name="l01689"></a>01689 
<a name="l01690"></a>01690                 <span class="comment">/*</span>
<a name="l01691"></a>01691 <span class="comment">                 * Recover from SYN flood attacks.</span>
<a name="l01692"></a>01692 <span class="comment">                 */</span>
<a name="l01693"></a>01693                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sock-&gt;so_state == <a class="code" href="tcp__fsm_8h.html#b9e60a4efd7450620226e7d3507e8443" title="have sent and received syn">TCPS_SYN_RECEIVED</a>) {
<a name="l01694"></a>01694                     <span class="keywordflow">if</span> (sock-&gt;so_time_wait++ &gt;= 45) {
<a name="l01695"></a>01695                         sock-&gt;so_state = <a class="code" href="tcp__fsm_8h.html#d0549b21a0f4cc0050f493e6cb5771ff" title="listening for connection">TCPS_LISTEN</a>;
<a name="l01696"></a>01696                         sock-&gt;so_time_wait = 0;
<a name="l01697"></a>01697                     }
<a name="l01698"></a>01698                 }
<a name="l01699"></a>01699             }
<a name="l01700"></a>01700         } <span class="keywordflow">else</span> {
<a name="l01701"></a>01701             nb = <a class="code" href="group__xg_t_c_p.html#g08e37e1f12909836bf31c91360e6fa7f">tcp_in_nbq</a>;
<a name="l01702"></a>01702             <a class="code" href="group__xg_t_c_p.html#g08e37e1f12909836bf31c91360e6fa7f">tcp_in_nbq</a> = 0;
<a name="l01703"></a>01703             tcp_in_cnt = 0;
<a name="l01704"></a>01704             <span class="keywordflow">while</span> (nb) {
<a name="l01705"></a>01705                 ih = (IPHDR *) nb-&gt;nb_nw.vp;
<a name="l01706"></a>01706                 th = (<a class="code" href="struct_t_c_p_h_d_r.html">TCPHDR</a> *) nb-&gt;nb_tp.vp;
<a name="l01707"></a>01707                 sock = <a class="code" href="group__xg_tcp_socket.html#g376cfd10344a38e74cde7ee2667ae3fe" title="Find a matching socket.">NutTcpFindSocket</a>(th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#b5120911e321829f85aebdbc03fc932c" title="Destination port.">th_dport</a>, th-&gt;<a class="code" href="struct_t_c_p_h_d_r.html#9ac07bf8feede24316ce6872b8cc9dcb" title="Source port.">th_sport</a>, ih-&gt;ip_src);
<a name="l01708"></a>01708 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01709"></a>01709 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>)
<a name="l01710"></a>01710                     <a class="code" href="netdebug_8h.html#13243e59b9857a6c4ee17e4cee73af51">NutDumpTcpHeader</a>(<a class="code" href="netdebug_8h.html#cfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">" IN"</span>, sock, nb);
<a name="l01711"></a>01711 <span class="preprocessor">#endif</span>
<a name="l01712"></a>01712 <span class="preprocessor"></span>                nbx = nb-&gt;nb_next;
<a name="l01713"></a>01713                 <span class="keywordflow">if</span> (sock) {
<a name="l01714"></a>01714                     NutTcpInputOptions(sock, nb);
<a name="l01715"></a>01715                     NutTcpStateProcess(sock, nb);
<a name="l01716"></a>01716                 }
<a name="l01717"></a>01717 
<a name="l01718"></a>01718                 <span class="comment">/*</span>
<a name="l01719"></a>01719 <span class="comment">                 * Reject the segment, if no matching socket was found.</span>
<a name="l01720"></a>01720 <span class="comment">                 */</span>
<a name="l01721"></a>01721                 <span class="keywordflow">else</span>
<a name="l01722"></a>01722                     <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01723"></a>01723                 nb = nbx;
<a name="l01724"></a>01724             }
<a name="l01725"></a>01725         }
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727 }
<a name="l01728"></a>01728 
<a name="l01740"></a><a class="code" href="group__xg_t_c_p.html#g3402b7ed85f67803cc473f636290d22a">01740</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_t_c_p.html#g3402b7ed85f67803cc473f636290d22a" title="Process incoming TCP segments.">NutTcpStateMachine</a>(NETBUF * nb)
<a name="l01741"></a>01741 {
<a name="l01742"></a>01742     NETBUF *nbp;
<a name="l01743"></a>01743     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> size;
<a name="l01744"></a>01744 
<a name="l01745"></a>01745     nb-&gt;nb_next = 0;
<a name="l01746"></a>01746 
<a name="l01747"></a>01747     <span class="comment">/*</span>
<a name="l01748"></a>01748 <span class="comment">     * Incoming TCP segments are rejected and released if no TCP</span>
<a name="l01749"></a>01749 <span class="comment">     * sockets have been opened. Not doing so would add them</span>
<a name="l01750"></a>01750 <span class="comment">     * to the queue and never release the NETBUF. Thanks to</span>
<a name="l01751"></a>01751 <span class="comment">     * Ralph Mason for this fix.</span>
<a name="l01752"></a>01752 <span class="comment">     */</span>
<a name="l01753"></a>01753     <span class="keywordflow">if</span> (tcpThread == 0) {
<a name="l01754"></a>01754         <a class="code" href="sock__var_8h.html#47fb9b8095e5720d1cf8bc1b9db8df2c" title="Reject an incoming segment.">NutTcpReject</a>(nb);
<a name="l01755"></a>01755         <span class="keywordflow">return</span>;
<a name="l01756"></a>01756     }
<a name="l01757"></a>01757 
<a name="l01758"></a>01758     <span class="keywordflow">if</span> ((nbp = <a class="code" href="group__xg_t_c_p.html#g08e37e1f12909836bf31c91360e6fa7f">tcp_in_nbq</a>) == 0) {
<a name="l01759"></a>01759         <a class="code" href="group__xg_t_c_p.html#g08e37e1f12909836bf31c91360e6fa7f">tcp_in_nbq</a> = nb;
<a name="l01760"></a>01760         <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;<a class="code" href="group__xg_t_c_p.html#ge222ee1ca91575390b1c8eb98272b8c3">tcp_in_rdy</a>);
<a name="l01761"></a>01761     } <span class="keywordflow">else</span> {
<a name="l01762"></a>01762         size = nb-&gt;nb_nw.sz + nb-&gt;nb_tp.sz + nb-&gt;nb_ap.sz;
<a name="l01763"></a>01763         <span class="keywordflow">if</span> (tcp_in_cnt + size + 2048 &lt; <a class="code" href="heap_8h.html#59ff999107d29a73d3bdbeaee8dce952">NutHeapAvailable</a>()) {
<a name="l01764"></a>01764             tcp_in_cnt += size;
<a name="l01765"></a>01765             <span class="keywordflow">while</span> (nbp-&gt;nb_next)
<a name="l01766"></a>01766                 nbp = nbp-&gt;nb_next;
<a name="l01767"></a>01767             nbp-&gt;nb_next = nb;
<a name="l01768"></a>01768             <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;<a class="code" href="group__xg_t_c_p.html#ge222ee1ca91575390b1c8eb98272b8c3">tcp_in_rdy</a>);
<a name="l01769"></a>01769         } <span class="keywordflow">else</span>
<a name="l01770"></a>01770             <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01771"></a>01771     }
<a name="l01772"></a>01772 }
<a name="l01773"></a>01773 
<a name="l01782"></a><a class="code" href="group__xg_t_c_p.html#gf4276abdc9e3a9912632c592769eb13a">01782</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#gf4276abdc9e3a9912632c592769eb13a" title="Start TCP state machine.">NutTcpInitStateMachine</a>(<span class="keywordtype">void</span>)
<a name="l01783"></a>01783 {
<a name="l01784"></a>01784     <span class="keywordflow">if</span> (tcpThread == 0 &amp;&amp; (tcpThread = <a class="code" href="group__xg_nut_arch_avr_os_context_gcc.html#g8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="stringliteral">"tcpsm"</span>, <a class="code" href="group__xg_t_c_p.html#gc0a5f54bde677941f7cf555c2f89a367" title="TCP state machine thread.">NutTcpSm</a>, NULL, 
<a name="l01785"></a>01785         (<a class="code" href="tcpsm_8c.html#2dd57271cab4df50fc83070235b1f57f">NUT_THREAD_TCPSMSTACK</a> * <a class="code" href="thread_8h.html#829893ef9f0c6a5efc2559ed359c8592" title="Stack size factor.">NUT_THREAD_STACK_MULT</a>) + <a class="code" href="thread_8h.html#61adeb6c97cb1f740e729fbf33e9a15c" title="Stack size summand.">NUT_THREAD_STACK_ADD</a>)) == 0)
<a name="l01786"></a>01786         <span class="keywordflow">return</span> -1;
<a name="l01787"></a>01787     <span class="keywordflow">return</span> 0;
<a name="l01788"></a>01788 }
<a name="l01789"></a>01789 
<a name="l01803"></a><a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992">01803</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_t_c_p.html#gf821e7425534f4f62fd8ea64b0f98992" title="Closes socket with error.">NutTcpAbortSocket</a>(TCPSOCKET * sock, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> last_error)
<a name="l01804"></a>01804 {
<a name="l01805"></a>01805     sock-&gt;so_last_error = last_error;
<a name="l01806"></a>01806     sock-&gt;so_retran_time = 0;
<a name="l01807"></a>01807     sock-&gt;so_time_wait = 0;
<a name="l01808"></a>01808     <span class="comment">/*</span>
<a name="l01809"></a>01809 <span class="comment">     * If NutTcpCloseSocket was already called, we have to change</span>
<a name="l01810"></a>01810 <span class="comment">     * to TCPS_TIME_WAIT state, otherwise the socket will not be destroyed.</span>
<a name="l01811"></a>01811 <span class="comment">     * For the other cases just go to TCPS_CLOSED.</span>
<a name="l01812"></a>01812 <span class="comment">     */</span>
<a name="l01813"></a>01813     <span class="keywordflow">if</span> (sock-&gt;so_state &gt;= <a class="code" href="tcp__fsm_8h.html#410acd9bab431772b0f60efe5e9db1f8" title="have closed, sent fin">TCPS_FIN_WAIT_1</a>)      <span class="comment">/* FIN_WAIT_1, FIN_WAIT_2, CLOSING, LAST_ACK, TIME_WAIT */</span>
<a name="l01814"></a>01814         sock-&gt;so_state = <a class="code" href="tcp__fsm_8h.html#99daf1084fbb93426963b1cfb9e08562" title="in 2*msl quiet wait after close">TCPS_TIME_WAIT</a>;
<a name="l01815"></a>01815     <span class="keywordflow">else</span>
<a name="l01816"></a>01816         sock-&gt;so_state = <a class="code" href="tcp__fsm_8h.html#f100e134b318729b9824f95ac09ab5d8" title="closed">TCPS_CLOSED</a>;
<a name="l01817"></a>01817     <a class="code" href="group__xg_tcp_socket.html#ge062b546a18e3a15d4fa87209d6160ca">NutTcpDiscardBuffers</a>(sock);
<a name="l01818"></a>01818     <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_rx_tq);
<a name="l01819"></a>01819     <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_tx_tq);
<a name="l01820"></a>01820     <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_pc_tq);
<a name="l01821"></a>01821     <a class="code" href="group__xg_event.html#g575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;sock-&gt;so_ac_tq);
<a name="l01822"></a>01822     <span class="keywordflow">return</span> 0;
<a name="l01823"></a>01823 }
<a name="l01824"></a>01824 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
