<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_f74ade614ec31c2ba6c13faba1bd859c.html">fs</a>
  </div>
<div class="contents">
<h1>pnutfs.c</h1><a href="pnutfs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2004-2006 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 
<a name="l00095"></a>00095 <span class="preprocessor">#include &lt;<a class="code" href="compiler_8h.html">compiler.h</a>&gt;</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>
<a name="l00100"></a>00100 <span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<a name="l00101"></a>00101 <span class="preprocessor">#include &lt;<a class="code" href="dirent_8h.html" title="Filesystem directory structure.">dirent.h</a>&gt;</span>
<a name="l00102"></a>00102 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00103"></a>00103 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="preprocessor">#include &lt;<a class="code" href="stat_8h.html" title="File system status declarations.">sys/stat.h</a>&gt;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &lt;<a class="code" href="file_8h.html">sys/file.h</a>&gt;</span>
<a name="l00107"></a>00107 <span class="preprocessor">#include &lt;<a class="code" href="sys_2bankmem_8h.html" title="Banked memory management definitions.">sys/bankmem.h</a>&gt;</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <span class="preprocessor">#include &lt;<a class="code" href="fs_2fs_8h.html" title="File system access.">fs/fs.h</a>&gt;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &lt;<a class="code" href="pnut_8h.html">dev/pnut.h</a>&gt;</span>
<a name="l00111"></a>00111 
<a name="l00116"></a>00116 
<a name="l00123"></a>00123 
<a name="l00128"></a>00128 <span class="preprocessor">#ifndef PNUT_BLOCK_SIZE</span>
<a name="l00129"></a><a class="code" href="group__xg_p_nut.html#gfe7b66c5d4d005c0eb561138db5f58c7">00129</a> <span class="preprocessor"></span><span class="preprocessor">#define PNUT_BLOCK_SIZE     512</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>
<a name="l00138"></a>00138 <span class="preprocessor">#ifndef PNUT_DIRENT_SIZE</span>
<a name="l00139"></a><a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define PNUT_DIRENT_SIZE  32</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>
<a name="l00154"></a>00154 <span class="preprocessor">#ifndef PNUT_BLOCKS_PER_NODE</span>
<a name="l00155"></a><a class="code" href="group__xg_p_nut.html#gd35267ab23b76e3ab82648bf23580256">00155</a> <span class="preprocessor"></span><span class="preprocessor">#define PNUT_BLOCKS_PER_NODE      250</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>
<a name="l00158"></a>00158 <span class="preprocessor">#ifndef PNUTBANK_COUNT</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span><span class="preprocessor">#ifdef ARTHERNET1</span>
<a name="l00160"></a>00160 <span class="preprocessor"></span><span class="comment">/* Default for Arthernet 1. */</span>
<a name="l00161"></a>00161 <span class="preprocessor">#define PNUTBANK_COUNT 15</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span><span class="preprocessor">#elif MMNET02  || MMNET03  || MMNET04 ||\</span>
<a name="l00163"></a>00163 <span class="preprocessor">      MMNET102 || MMNET103 || MMNET104  </span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="comment">/* Default for MMnte02. */</span>
<a name="l00165"></a>00165 <span class="preprocessor">#define PNUTBANK_COUNT 6</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="comment">/* Default for Ethernet 2. */</span>
<a name="l00168"></a><a class="code" href="group__xg_p_nut.html#g4293e35138194851cce8bef591a894ad">00168</a> <span class="preprocessor">#define PNUTBANK_COUNT 30</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span>
<a name="l00175"></a>00175 <span class="preprocessor">#ifndef SEEK_SET</span>
<a name="l00176"></a><a class="code" href="group__xg_p_nut.html#g0d112bae8fd35be772185b6ec6bcbe64">00176</a> <span class="preprocessor"></span><span class="preprocessor">#  define SEEK_SET        0     </span><span class="comment">/* Seek from beginning of file.  */</span>
<a name="l00177"></a><a class="code" href="group__xg_p_nut.html#g4c8d0b76b470ba65a43ca46a88320f39">00177</a> <span class="preprocessor">#  define SEEK_CUR        1     </span><span class="comment">/* Seek from current position.  */</span>
<a name="l00178"></a><a class="code" href="group__xg_p_nut.html#gd2a2e6c114780c3071efd24f16c7f7d8">00178</a> <span class="preprocessor">#  define SEEK_END        2     </span><span class="comment">/* Set file pointer to EOF plus "offset" */</span>
<a name="l00179"></a>00179 <span class="preprocessor">#endif</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>
<a name="l00181"></a><a class="code" href="group__xg_p_nut.html#ge9cc3f70052dd31a2e9eb7ef5ccba0b8">00181</a> <span class="preprocessor">#define NODETYPE_REG        0</span>
<a name="l00182"></a><a class="code" href="group__xg_p_nut.html#gc4183a62d414b9d45cfb2753acf68345">00182</a> <span class="preprocessor"></span><span class="preprocessor">#define NODETYPE_DIR        1</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">00185</a> <span class="keyword">typedef</span> <span class="keywordtype">short</span> <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a>;
<a name="l00186"></a>00186 
<a name="l00205"></a>00205 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00206"></a>00206     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> node_type;           
<a name="l00207"></a>00207     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> node_refs;           
<a name="l00218"></a>00218     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> node_links;
<a name="l00219"></a>00219     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> node_size;           
<a name="l00220"></a>00220     <a class="code" href="group__xg_crt_time.html#ge33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> node_mtime;          
<a name="l00221"></a>00221     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node_blocks[<a class="code" href="group__xg_p_nut.html#gd35267ab23b76e3ab82648bf23580256" title="Maximum number of blocks per node.">PNUT_BLOCKS_PER_NODE</a>];      
<a name="l00222"></a>00222 } PNUT_NODE;
<a name="l00223"></a>00223 
<a name="l00230"></a><a class="code" href="group__xg_p_nut.html#g5c33ceb9dfe33aa33dc7c0cb741ad679">00230</a> <span class="preprocessor">#define PNUT_MAX_NAMELEN    (PNUT_DIRENT_SIZE - sizeof(PNUT_BLKNUM) - sizeof(uint8_t) - 1)</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>
<a name="l00240"></a>00240 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00246"></a>00246     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> dir_node;
<a name="l00252"></a>00252     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> dir_inuse;
<a name="l00258"></a>00258     <span class="keywordtype">char</span> dir_name[<a class="code" href="group__xg_p_nut.html#g5c33ceb9dfe33aa33dc7c0cb741ad679" title="Maximum length of a base name.">PNUT_MAX_NAMELEN</a> + 1];
<a name="l00259"></a>00259 } PNUT_DIRENTRY;
<a name="l00260"></a>00260 
<a name="l00267"></a><a class="code" href="group__xg_p_nut.html#g5a13a0b0b8f7b78b710c9f156625e31c">00267</a> <span class="preprocessor">#define PNUT_MAX_FILESIZE    (PNUT_BLOCKS_PER_NODE * PNUT_BLOCK_SIZE)</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00272"></a>00272 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00276"></a>00276     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> fr_node;
<a name="l00277"></a>00277 
<a name="l00281"></a>00281     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> fr_pnode;
<a name="l00282"></a>00282 
<a name="l00288"></a>00288     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *fr_name;
<a name="l00289"></a>00289 } PNUT_FINDRESULT;
<a name="l00290"></a>00290 
<a name="l00294"></a>00294 <span class="keyword">typedef</span> <span class="keyword">struct </span>_PNUTFILE PNUTFILE;
<a name="l00295"></a>00295 
<a name="l00299"></a>00299 <span class="keyword">struct </span>_PNUTFILE {
<a name="l00300"></a>00300     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> f_node;         <span class="comment">/* Node of the file or directory. */</span>
<a name="l00301"></a>00301     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> f_pos;               <span class="comment">/* Current file pointer position. */</span>
<a name="l00302"></a>00302     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> f_flag;               <span class="comment">/* File mode. */</span>
<a name="l00303"></a>00303 };
<a name="l00304"></a>00304 
<a name="l00306"></a>00306 <span class="keyword">static</span> <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> root;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308 <span class="comment">/* -------------------- Banking hardware routines ------------------- */</span>
<a name="l00309"></a>00309 
<a name="l00311"></a>00311 <span class="preprocessor">#ifndef NUTBANK_SIZE</span>
<a name="l00312"></a><a class="code" href="group__xg_p_nut.html#g26a2c011ea6632c117da727631f11a1f">00312</a> <span class="preprocessor"></span><span class="preprocessor">#define NUTBANK_SIZE 16384</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>
<a name="l00325"></a>00325 <span class="preprocessor">#ifndef PNUT_TOTAL_BLOCKS</span>
<a name="l00326"></a><a class="code" href="group__xg_p_nut.html#g7ca418ff25e56062efc19694a920aef8">00326</a> <span class="preprocessor"></span><span class="preprocessor">#define PNUT_TOTAL_BLOCKS   (PNUTBANK_COUNT * (NUTBANK_SIZE / PNUT_BLOCK_SIZE))</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>
<a name="l00329"></a><a class="code" href="group__xg_p_nut.html#g55570d30e39bb5d1ef421dab4a326dd8">00329</a> <span class="preprocessor">#define BLOCKS_PER_BANK  (NUTBANK_SIZE / PNUT_BLOCK_SIZE)</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>
<a name="l00331"></a>00331 <span class="preprocessor">#ifndef NUTBANK_SR</span>
<a name="l00332"></a><a class="code" href="group__xg_p_nut.html#g14bf50b6797af8fb3bda12c9aef80887">00332</a> <span class="preprocessor"></span><span class="preprocessor">#define NUTBANK_SR 0xFF00</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span>
<a name="l00335"></a>00335 <span class="preprocessor">#ifndef NUTBANK_START</span>
<a name="l00336"></a><a class="code" href="group__xg_p_nut.html#g500d68a36132539458d98c8966ec3b18">00336</a> <span class="preprocessor"></span><span class="preprocessor">#define NUTBANK_START 0x8000</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>
<a name="l00339"></a><a class="code" href="group__xg_p_nut.html#g93247ae4ecd231b533806d35307e68a8">00339</a> <span class="preprocessor">#define NUTBANK_PTR ((char *)NUTBANK_START)</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>
<a name="l00352"></a><a class="code" href="group__xg_p_nut.html#gcabe6f787aea232ef3b91b8151c743ee">00352</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_p_nut.html#gcabe6f787aea232ef3b91b8151c743ee" title="Make the bank visible, which contains the specified block.">BankSelect</a>(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> blk)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 <span class="comment">// This is a hack to avoid compiler warning if no banking is enabled... </span>
<a name="l00356"></a>00356 <span class="comment">// But I don't like moving code to header files at all.. (Ole Reinhardt)</span>
<a name="l00357"></a>00357 <span class="preprocessor">#if NUTBANK_COUNT </span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>    <span class="keywordtype">int</span> bank = blk / <a class="code" href="group__xg_p_nut.html#g55570d30e39bb5d1ef421dab4a326dd8">BLOCKS_PER_BANK</a>;
<a name="l00359"></a>00359 <span class="preprocessor">#endif</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>    <span class="comment">// Bankswitching is now handled in bankmem.h</span>
<a name="l00361"></a>00361     <a class="code" href="sys_2bankmem_8h.html#f4adea8e94e99494e690d1625f213766">NutSegBufEnable</a>(bank);
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00367"></a><a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28">00367</a> PNUT_NODE *<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> blk)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (blk &lt; 0) {
<a name="l00370"></a>00370         <span class="keywordflow">return</span> NULL;
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372     <a class="code" href="group__xg_p_nut.html#gcabe6f787aea232ef3b91b8151c743ee" title="Make the bank visible, which contains the specified block.">BankSelect</a>(blk);
<a name="l00373"></a>00373     <span class="keywordflow">return</span> (PNUT_NODE *) &amp; <a class="code" href="group__xg_p_nut.html#g93247ae4ecd231b533806d35307e68a8">NUTBANK_PTR</a>[(blk % <a class="code" href="group__xg_p_nut.html#g55570d30e39bb5d1ef421dab4a326dd8">BLOCKS_PER_BANK</a>) * <a class="code" href="group__xg_p_nut.html#gfe7b66c5d4d005c0eb561138db5f58c7" title="Size of a filesystem block.">PNUT_BLOCK_SIZE</a>];
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 <span class="comment">/* ------------------------ Block routines ------------------------ */</span>
<a name="l00378"></a>00378 
<a name="l00379"></a>00379 <span class="comment">/*</span>
<a name="l00380"></a>00380 <span class="comment"> * \brief Index of the first free block.</span>
<a name="l00381"></a>00381 <span class="comment"> *</span>
<a name="l00382"></a>00382 <span class="comment"> * All free blocks are collected in a linked list. This global variable </span>
<a name="l00383"></a>00383 <span class="comment"> * contains the index of the first free block. Each free block contains </span>
<a name="l00384"></a>00384 <span class="comment"> * nothing but the index of the next free block, which is -1 in the last </span>
<a name="l00385"></a>00385 <span class="comment"> * member of this list.</span>
<a name="l00386"></a>00386 <span class="comment"> *</span>
<a name="l00387"></a>00387 <span class="comment"> * If this variable is set to -1, then there are no more free blocks </span>
<a name="l00388"></a>00388 <span class="comment"> * available. During file system initialization all available blocks are </span>
<a name="l00389"></a>00389 <span class="comment"> * added to this list.</span>
<a name="l00390"></a>00390 <span class="comment"> */</span>
<a name="l00391"></a>00391 <span class="keyword">static</span> <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> blockFreeList = -1;
<a name="l00392"></a>00392 
<a name="l00400"></a>00400 <span class="keyword">static</span> <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> PnutBlockAlloc(<span class="keywordtype">void</span>)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> rc = blockFreeList;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="keywordflow">if</span> (rc &gt;= 0) {
<a name="l00405"></a>00405         <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> *bankptr = (<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> *) <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(blockFreeList);
<a name="l00406"></a>00406         blockFreeList = *bankptr;
<a name="l00407"></a>00407         <span class="comment">/* Clear the block contents. */</span>
<a name="l00408"></a>00408         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(bankptr, 0, <a class="code" href="group__xg_p_nut.html#gfe7b66c5d4d005c0eb561138db5f58c7" title="Size of a filesystem block.">PNUT_BLOCK_SIZE</a>);
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="keywordflow">return</span> rc;
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00420"></a>00420 <span class="keyword">static</span> <span class="keywordtype">void</span> PnutBlockRelease(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> blk)
<a name="l00421"></a>00421 {
<a name="l00422"></a>00422     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> *bankptr = (<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> *) <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(blk);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     *bankptr = blockFreeList;
<a name="l00425"></a>00425     blockFreeList = blk;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="comment">/* ------------------------ Node routines ------------------------ */</span>
<a name="l00429"></a>00429 
<a name="l00439"></a>00439 <span class="keyword">static</span> <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> PnutNodeAlloc(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> type)
<a name="l00440"></a>00440 {
<a name="l00441"></a>00441     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node = PnutBlockAlloc();
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="keywordflow">if</span> (node &gt;= 0) {
<a name="l00444"></a>00444         <span class="keywordtype">int</span> i;
<a name="l00445"></a>00445         PNUT_NODE *np = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node);
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         <span class="comment">/* Clear the data block list of this node. */</span>
<a name="l00448"></a>00448         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__xg_p_nut.html#gd35267ab23b76e3ab82648bf23580256" title="Maximum number of blocks per node.">PNUT_BLOCKS_PER_NODE</a>; i++) {
<a name="l00449"></a>00449             np-&gt;node_blocks[i] = -1;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452         <span class="comment">/* Set the type and the last modification date. */</span>
<a name="l00453"></a>00453         np-&gt;node_type = type;
<a name="l00454"></a>00454         np-&gt;node_mtime = <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(0);
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456     <span class="keywordflow">return</span> node;
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 <span class="comment">/*</span>
<a name="l00460"></a>00460 <span class="comment"> * \brief Free all blocks of a specified node.</span>
<a name="l00461"></a>00461 <span class="comment"> */</span>
<a name="l00462"></a>00462 <span class="keyword">static</span> <span class="keywordtype">void</span> PnutNodeDataRelease(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464     <span class="keywordtype">int</span> i;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__xg_p_nut.html#gd35267ab23b76e3ab82648bf23580256" title="Maximum number of blocks per node.">PNUT_BLOCKS_PER_NODE</a>; i++) {
<a name="l00467"></a>00467         <span class="keywordflow">if</span> (<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_blocks[i] &gt;= 0) {
<a name="l00468"></a>00468             PnutBlockRelease(<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_blocks[i]);
<a name="l00469"></a>00469             <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_blocks[i] = -1;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472     <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size = 0;
<a name="l00473"></a>00473     <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_mtime = <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(0);
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00479"></a>00479 <span class="keyword">static</span> <span class="keywordtype">void</span> PnutNodeRelease(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node)
<a name="l00480"></a>00480 {
<a name="l00481"></a>00481     PnutNodeDataRelease(node);
<a name="l00482"></a>00482     PnutBlockRelease(node);
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00501"></a>00501 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutNodeGetDataPtr(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> pos, <span class="keywordtype">void</span> **buffer, <span class="keywordtype">size_t</span> * size, <span class="keywordtype">int</span> create)
<a name="l00502"></a>00502 {
<a name="l00503"></a>00503     <span class="keywordtype">int</span> blkidx;                 <span class="comment">/* Number of full blocks */</span>
<a name="l00504"></a>00504     <span class="keywordtype">int</span> rc = <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     *buffer = NULL;
<a name="l00507"></a>00507     *size = 0;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509     <span class="comment">/* Calculate the block index. Make sure it fits in our maximum file size. */</span>
<a name="l00510"></a>00510     <span class="keywordflow">if</span> ((blkidx = pos / <a class="code" href="group__xg_p_nut.html#gfe7b66c5d4d005c0eb561138db5f58c7" title="Size of a filesystem block.">PNUT_BLOCK_SIZE</a>) &lt; PNUT_BLOCKS_PER_NODE) {
<a name="l00511"></a>00511         <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> blk;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         <span class="comment">/* Get the data block number. Optionally allocate a new block. */</span>
<a name="l00514"></a>00514         <span class="keywordflow">if</span> ((blk = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_blocks[blkidx]) &lt; 0 &amp;&amp; create) {
<a name="l00515"></a>00515             <span class="keywordflow">if</span> ((blk = PnutBlockAlloc()) &lt; 0) {
<a name="l00516"></a>00516                 rc = <a class="code" href="errno_8h.html#088abe8bad2df798edad3053d719b937">ENOSPC</a>;
<a name="l00517"></a>00517             } <span class="keywordflow">else</span> {
<a name="l00518"></a>00518                 <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_blocks[blkidx] = blk;
<a name="l00519"></a>00519             }
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522         <span class="comment">/* </span>
<a name="l00523"></a>00523 <span class="comment">         * If we got a valid block, then set the pointer at the specified</span>
<a name="l00524"></a>00524 <span class="comment">         * position and the remaining bytes within this block.</span>
<a name="l00525"></a>00525 <span class="comment">         */</span>
<a name="l00526"></a>00526         <span class="keywordflow">if</span> (blk &gt;= 0) {
<a name="l00527"></a>00527             <span class="keywordtype">char</span> *blkptr = (<span class="keywordtype">char</span> *) <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(blk);
<a name="l00528"></a>00528             <span class="keywordtype">int</span> blkpos = pos % <a class="code" href="group__xg_p_nut.html#gfe7b66c5d4d005c0eb561138db5f58c7" title="Size of a filesystem block.">PNUT_BLOCK_SIZE</a>; <span class="comment">/* Position within block */</span>
<a name="l00529"></a>00529 
<a name="l00530"></a>00530             *buffer = blkptr + blkpos;
<a name="l00531"></a>00531             *size = <a class="code" href="group__xg_p_nut.html#gfe7b66c5d4d005c0eb561138db5f58c7" title="Size of a filesystem block.">PNUT_BLOCK_SIZE</a> - blkpos;
<a name="l00532"></a>00532             rc = 0;
<a name="l00533"></a>00533         }
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535     <span class="keywordflow">return</span> rc;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 <span class="comment">/* ------------------------ Directory routines ------------------------ */</span>
<a name="l00540"></a>00540 
<a name="l00544"></a>00544 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirIsEmpty(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546     <span class="keywordtype">int</span> rc = 1;
<a name="l00547"></a>00547     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> pos;
<a name="l00548"></a>00548     <span class="keywordtype">size_t</span> size;
<a name="l00549"></a>00549     PNUT_DIRENTRY *entry;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="comment">/* Loop through the data blocks of this directory node. */</span>
<a name="l00552"></a>00552     <span class="keywordflow">for</span> (pos = 0; pos &lt; <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size; pos += <a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d" title="Size of a directory entry.">PNUT_DIRENT_SIZE</a>) {
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">/* Get the pointer to the next directory entry. */</span>
<a name="l00555"></a>00555         <span class="keywordflow">if</span> (PnutNodeGetDataPtr(node, pos, (<span class="keywordtype">void</span> *) &amp;entry, &amp;size, 0) || size == 0) {
<a name="l00556"></a>00556             <span class="comment">/* No more entries. */</span>
<a name="l00557"></a>00557             <span class="keywordflow">break</span>;
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">if</span> (size &gt;= <a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d" title="Size of a directory entry.">PNUT_DIRENT_SIZE</a>) {
<a name="l00561"></a>00561             <span class="keywordflow">if</span> (entry-&gt;dir_inuse &amp;&amp; <a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(entry-&gt;dir_name, <span class="stringliteral">"."</span>) &amp;&amp; <a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(entry-&gt;dir_name, <span class="stringliteral">".."</span>)) {
<a name="l00562"></a>00562                 <span class="comment">/* Entry found */</span>
<a name="l00563"></a>00563                 rc = 0;
<a name="l00564"></a>00564                 <span class="keywordflow">break</span>;
<a name="l00565"></a>00565             }
<a name="l00566"></a>00566         }
<a name="l00567"></a>00567     }
<a name="l00568"></a>00568     <span class="keywordflow">return</span> rc;
<a name="l00569"></a>00569 }
<a name="l00570"></a>00570 
<a name="l00584"></a>00584 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirFindEntry(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, <span class="keywordtype">size_t</span> len, PNUT_DIRENTRY ** entry)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586     <span class="keywordtype">int</span> rc = <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>;
<a name="l00587"></a>00587     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> pos;
<a name="l00588"></a>00588     <span class="keywordtype">size_t</span> size;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="comment">/* Loop through the data blocks of this directory node. */</span>
<a name="l00591"></a>00591     <span class="keywordflow">for</span> (pos = 0; pos &lt; <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size; pos += <a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d" title="Size of a directory entry.">PNUT_DIRENT_SIZE</a>) {
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         <span class="comment">/* Get the pointer to the next directory entry. */</span>
<a name="l00594"></a>00594         <span class="keywordflow">if</span> (PnutNodeGetDataPtr(node, pos, (<span class="keywordtype">void</span> **) entry, &amp;size, 0) || size == 0) {
<a name="l00595"></a>00595             <span class="comment">/* No more entries. */</span>
<a name="l00596"></a>00596             <span class="keywordflow">break</span>;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599         <span class="comment">/* Compare this entry. */</span>
<a name="l00600"></a>00600         <span class="keywordflow">if</span> (size &gt;= <a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d" title="Size of a directory entry.">PNUT_DIRENT_SIZE</a>) { <span class="comment">/* Skip entries across block boundaries. */</span>
<a name="l00601"></a>00601             <span class="keywordflow">if</span> ((*entry)-&gt;dir_inuse &amp;&amp;  <span class="comment">/* Skip unused entries. */</span>
<a name="l00602"></a>00602                 <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>((*entry)-&gt;dir_name) == len &amp;&amp;    <span class="comment">/* Skip non-matching names. */</span>
<a name="l00603"></a>00603                 <a class="code" href="group__xg_crt_string.html#g7c9f18d51e4325827ed3cadd369fcb7c" title="Compare two strings up to a given number of characters.">strncmp</a>((*entry)-&gt;dir_name, path, len) == 0) {
<a name="l00604"></a>00604                 <span class="comment">/* Requested entry found */</span>
<a name="l00605"></a>00605                 rc = 0;
<a name="l00606"></a>00606                 <span class="keywordflow">break</span>;
<a name="l00607"></a>00607             }
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609     }
<a name="l00610"></a>00610     <span class="keywordflow">return</span> rc;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613 <span class="comment">/*</span>
<a name="l00614"></a>00614 <span class="comment"> * \brief Find directory entry of a specified path.</span>
<a name="l00615"></a>00615 <span class="comment"> *</span>
<a name="l00616"></a>00616 <span class="comment"> * \param node   First node block to search.</span>
<a name="l00617"></a>00617 <span class="comment"> * \param path   Path to find.</span>
<a name="l00618"></a>00618 <span class="comment"> * \param result Search result.</span>
<a name="l00619"></a>00619 <span class="comment"> *</span>
<a name="l00620"></a>00620 <span class="comment"> * \return Error code.</span>
<a name="l00621"></a>00621 <span class="comment"> */</span>
<a name="l00622"></a>00622 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirFindPath(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, PNUT_FINDRESULT * result)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordtype">int</span> rc = 0;
<a name="l00625"></a>00625     <span class="keywordtype">size_t</span> len;
<a name="l00626"></a>00626     PNUT_DIRENTRY *entry;
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     result-&gt;fr_pnode = node;
<a name="l00629"></a>00629     result-&gt;fr_node = -1;
<a name="l00630"></a>00630     result-&gt;fr_name = NULL;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="keywordflow">while</span> (*path == <span class="charliteral">'/'</span>) {
<a name="l00633"></a>00633         path++;
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (*path == 0) {
<a name="l00637"></a>00637         path = <span class="stringliteral">"."</span>;
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="comment">/* </span>
<a name="l00641"></a>00641 <span class="comment">     * Loop for each path component.</span>
<a name="l00642"></a>00642 <span class="comment">     */</span>
<a name="l00643"></a>00643     <span class="keywordflow">while</span> (*path) {
<a name="l00644"></a>00644         <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *cp;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="comment">/* Make sure that this is a directory node. */</span>
<a name="l00647"></a>00647         <span class="keywordflow">if</span> (<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_type != <a class="code" href="group__xg_p_nut.html#gc4183a62d414b9d45cfb2753acf68345">NODETYPE_DIR</a>) {
<a name="l00648"></a>00648             rc = <a class="code" href="errno_8h.html#9262fb92f7ef662d0bdd577912a5b101">ENOTDIR</a>;
<a name="l00649"></a>00649             <span class="keywordflow">break</span>;
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <span class="comment">/* Retrieve the length of first path component. */</span>
<a name="l00653"></a>00653         <span class="keywordflow">for</span> (len = 0, cp = path; *cp &amp;&amp; *cp != <span class="charliteral">'/'</span>; cp++) {
<a name="l00654"></a>00654             len++;
<a name="l00655"></a>00655         }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657         <span class="comment">/* </span>
<a name="l00658"></a>00658 <span class="comment">         * If this component is last, we found all parents.</span>
<a name="l00659"></a>00659 <span class="comment">         * Keep the last one stored in the result.</span>
<a name="l00660"></a>00660 <span class="comment">         */</span>
<a name="l00661"></a>00661         <span class="keywordflow">if</span> (*cp == 0) {
<a name="l00662"></a>00662             result-&gt;fr_name = path;
<a name="l00663"></a>00663         }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665         <span class="comment">/* Try to find this component. */</span>
<a name="l00666"></a>00666         <span class="keywordflow">if</span> ((rc = PnutDirFindEntry(node, path, len, &amp;entry)) != 0) {
<a name="l00667"></a>00667             rc = <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>;
<a name="l00668"></a>00668             <span class="keywordflow">break</span>;
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671         <span class="comment">/* Component found. Return if this was the last one. */</span>
<a name="l00672"></a>00672         result-&gt;fr_node = entry-&gt;dir_node;
<a name="l00673"></a>00673         <span class="keywordflow">if</span> (*cp == 0) {
<a name="l00674"></a>00674             <span class="keywordflow">break</span>;
<a name="l00675"></a>00675         }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677         <span class="comment">/* Not the last component. Store node as previous node. */</span>
<a name="l00678"></a>00678         result-&gt;fr_pnode = result-&gt;fr_node;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680         <span class="comment">/* Move forward to the next path component. */</span>
<a name="l00681"></a>00681         node = result-&gt;fr_node;
<a name="l00682"></a>00682         path += len;
<a name="l00683"></a>00683         <span class="keywordflow">while</span> (*path == <span class="charliteral">'/'</span>) {
<a name="l00684"></a>00684             path++;
<a name="l00685"></a>00685         }
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687     <span class="keywordflow">return</span> rc;
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 
<a name="l00701"></a>00701 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirOpen(NUTDEVICE * dev, <a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> * dir)
<a name="l00702"></a>00702 {
<a name="l00703"></a>00703     PNUTFILE *fp;
<a name="l00704"></a>00704     PNUT_FINDRESULT found;
<a name="l00705"></a>00705     <span class="keywordtype">int</span> rc;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="comment">/* Locate the entry in our directory structure. */</span>
<a name="l00708"></a>00708     <span class="keywordflow">if</span> ((rc = PnutDirFindPath(root, dir-&gt;<a class="code" href="struct_d_i_r.html#f36e05d988a827346a3d2d8b98225131" title="Data buffer.">dd_buf</a>, &amp;found)) != 0) {
<a name="l00709"></a>00709         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = rc;
<a name="l00710"></a>00710         rc = -1;
<a name="l00711"></a>00711     } <span class="keywordflow">else</span> {
<a name="l00712"></a>00712         <span class="keywordflow">if</span> (<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(found.fr_node)-&gt;node_type != <a class="code" href="group__xg_p_nut.html#gc4183a62d414b9d45cfb2753acf68345">NODETYPE_DIR</a>) {
<a name="l00713"></a>00713             <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#9262fb92f7ef662d0bdd577912a5b101">ENOTDIR</a>;
<a name="l00714"></a>00714             rc = -1;
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716         <span class="comment">/* Allocate a PNUT file descriptor. */</span>
<a name="l00717"></a>00717         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((fp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(PNUTFILE))) == 0) {
<a name="l00718"></a>00718             rc = -1;
<a name="l00719"></a>00719         }
<a name="l00720"></a>00720         <span class="comment">/* </span>
<a name="l00721"></a>00721 <span class="comment">         * Initialize the descriptor and store it in the directory</span>
<a name="l00722"></a>00722 <span class="comment">         * information structure.</span>
<a name="l00723"></a>00723 <span class="comment">         */</span>
<a name="l00724"></a>00724         <span class="keywordflow">else</span> {
<a name="l00725"></a>00725             fp-&gt;f_node = found.fr_node;
<a name="l00726"></a>00726             fp-&gt;f_pos = 0;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728             <span class="keywordflow">if</span> ((dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a> = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(NUTFILE))) == 0) {
<a name="l00729"></a>00729                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(fp);
<a name="l00730"></a>00730                 rc = -1;
<a name="l00731"></a>00731             }
<a name="l00732"></a>00732             <span class="keywordflow">else</span> {
<a name="l00733"></a>00733                 <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>, 0, <span class="keyword">sizeof</span>(NUTFILE));
<a name="l00734"></a>00734                 dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>-&gt;nf_dev = dev;
<a name="l00735"></a>00735                 dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>-&gt;nf_fcb = fp;
<a name="l00736"></a>00736                 <span class="comment">/* Keep track of the number of open calls. */</span>
<a name="l00737"></a>00737                 <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_refs++;
<a name="l00738"></a>00738             }
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741     <span class="keywordflow">return</span> rc;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00747"></a>00747 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirClose(<a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> * dir)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (dir &amp;&amp; dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>) {
<a name="l00750"></a>00750         <span class="keywordflow">if</span> (dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>-&gt;nf_fcb) {
<a name="l00751"></a>00751             PNUTFILE *fp = dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>-&gt;nf_fcb;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753             <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_refs--;
<a name="l00754"></a>00754             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(fp);
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>);
<a name="l00757"></a>00757         <span class="keywordflow">return</span> 0;
<a name="l00758"></a>00758     }
<a name="l00759"></a>00759     <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00765"></a>00765 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirRead(<a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> * dir)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767     <span class="keywordtype">int</span> rc = -1;
<a name="l00768"></a>00768     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> pos;
<a name="l00769"></a>00769     PNUT_DIRENTRY *entry;
<a name="l00770"></a>00770     <span class="keywordtype">size_t</span> size;
<a name="l00771"></a>00771     PNUTFILE *fp = dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>-&gt;nf_fcb;
<a name="l00772"></a>00772     <span class="keyword">struct </span><a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a> *ent = (<span class="keyword">struct </span><a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a> *) dir-&gt;<a class="code" href="struct_d_i_r.html#f36e05d988a827346a3d2d8b98225131" title="Data buffer.">dd_buf</a>;
<a name="l00773"></a>00773 
<a name="l00774"></a>00774     ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>[0] = 0;
<a name="l00775"></a>00775     for (pos = fp-&gt;f_pos; pos &lt; <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_size; pos += <a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d" title="Size of a directory entry.">PNUT_DIRENT_SIZE</a>) {
<a name="l00776"></a>00776         <span class="comment">/* Retrieve the entry at the current position. */</span>
<a name="l00777"></a>00777         rc = PnutNodeGetDataPtr(fp-&gt;f_node, pos, (<span class="keywordtype">void</span> *) &amp;entry, &amp;size, 0);
<a name="l00778"></a>00778         <span class="keywordflow">if</span> (rc || size == 0) {
<a name="l00779"></a>00779             <span class="comment">/* No more entries. */</span>
<a name="l00780"></a>00780             rc = -1;
<a name="l00781"></a>00781             <span class="keywordflow">break</span>;
<a name="l00782"></a>00782         }
<a name="l00783"></a>00783         fp-&gt;f_pos = pos + <a class="code" href="group__xg_p_nut.html#ge2da73bc0e5b28eb88d65afb7e9d358d" title="Size of a directory entry.">PNUT_DIRENT_SIZE</a>;
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         <span class="comment">/* Skip entries across block boundaries and unused entires. */</span>
<a name="l00786"></a>00786         <span class="keywordflow">if</span> (size &gt;= PNUT_DIRENT_SIZE &amp;&amp; entry-&gt;dir_inuse) {
<a name="l00787"></a>00787             <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ent, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a>));
<a name="l00788"></a>00788             ent-&gt;<a class="code" href="structdirent.html#5741833384510ceacda73c87293682f0" title="File number, unused.">d_fileno</a> = entry-&gt;dir_node;
<a name="l00789"></a>00789             ent-&gt;<a class="code" href="structdirent.html#99c6f10c9d89ed5cb752dc01d0a2daf0" title="Length of string in d_name.">d_namlen</a> = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(entry-&gt;dir_name);
<a name="l00790"></a>00790             <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>, entry-&gt;dir_name);
<a name="l00791"></a>00791             <span class="keywordflow">break</span>;
<a name="l00792"></a>00792         }
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794     <span class="keywordflow">return</span> rc;
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00806"></a>00806 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirAddEntry(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> dnode, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> enode)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808     <span class="keywordtype">int</span> rc = 0;
<a name="l00809"></a>00809     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> pos = 0;
<a name="l00810"></a>00810     <span class="keywordtype">size_t</span> size;
<a name="l00811"></a>00811     PNUT_DIRENTRY *entry;
<a name="l00812"></a>00812     PNUT_NODE *np;
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     <span class="comment">/*</span>
<a name="l00815"></a>00815 <span class="comment">     * Loop through all directory entries until an unused one</span>
<a name="l00816"></a>00816 <span class="comment">     * is found. If required, a new data block is allocated,</span>
<a name="l00817"></a>00817 <span class="comment">     * so success is guaranteed unless we run out of free</span>
<a name="l00818"></a>00818 <span class="comment">     * blocks.</span>
<a name="l00819"></a>00819 <span class="comment">     */</span>
<a name="l00820"></a>00820     <span class="keywordflow">for</span> (;;) {
<a name="l00821"></a>00821         <span class="comment">/* </span>
<a name="l00822"></a>00822 <span class="comment">         * Get the data pointer to the specified position. Automatically</span>
<a name="l00823"></a>00823 <span class="comment">         * create a new block if we reached the end of the data.</span>
<a name="l00824"></a>00824 <span class="comment">         */</span>
<a name="l00825"></a>00825         <span class="keywordflow">if</span> ((rc = PnutNodeGetDataPtr(dnode, pos, (<span class="keywordtype">void</span> *) &amp;entry, &amp;size, 1)) != 0) {
<a name="l00826"></a>00826             <span class="keywordflow">break</span>;
<a name="l00827"></a>00827         }
<a name="l00828"></a>00828         pos += PNUT_DIRENT_SIZE;
<a name="l00829"></a>00829 
<a name="l00830"></a>00830         <span class="comment">/* Process entry if it doesn't cross block boundaries. */</span>
<a name="l00831"></a>00831         <span class="keywordflow">if</span> (size &gt;= PNUT_DIRENT_SIZE) {
<a name="l00832"></a>00832             <span class="comment">/* Did we find a previously released or a newly allocated entry? */</span>
<a name="l00833"></a>00833             <span class="keywordflow">if</span> (entry-&gt;dir_inuse == 0) {
<a name="l00834"></a>00834                 <span class="comment">/* Update the entry. */</span>
<a name="l00835"></a>00835                 entry-&gt;dir_node = enode;
<a name="l00836"></a>00836                 entry-&gt;dir_inuse = 1;
<a name="l00837"></a>00837                 <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(entry-&gt;dir_name, name);
<a name="l00838"></a>00838 
<a name="l00839"></a>00839                 <span class="comment">/* Update the directory node. */</span>
<a name="l00840"></a>00840                 np = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(dnode);
<a name="l00841"></a>00841                 np-&gt;node_mtime = <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(0);
<a name="l00842"></a>00842                 <span class="keywordflow">if</span> (pos &gt; np-&gt;node_size) {
<a name="l00843"></a>00843                     np-&gt;node_size = pos;
<a name="l00844"></a>00844                 }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846                 <span class="comment">/* Update the entry's node. */</span>
<a name="l00847"></a>00847                 np = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(enode);
<a name="l00848"></a>00848                 np-&gt;node_links++;
<a name="l00849"></a>00849                 <span class="keywordflow">break</span>;
<a name="l00850"></a>00850             }
<a name="l00851"></a>00851         }
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853     <span class="keywordflow">return</span> rc;
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00872"></a>00872 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirDelEntry(<a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name)
<a name="l00873"></a>00873 {
<a name="l00874"></a>00874     <span class="keywordtype">int</span> rc;
<a name="l00875"></a>00875     PNUT_DIRENTRY *entry;
<a name="l00876"></a>00876     PNUT_NODE *rnp;
<a name="l00877"></a>00877     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> rnode;
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="comment">/* Make sure this entry exists. */</span>
<a name="l00880"></a>00880     <span class="keywordflow">if</span> ((rc = PnutDirFindEntry(node, name, <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(name), &amp;entry)) != 0) {
<a name="l00881"></a>00881         <span class="keywordflow">return</span> rc;
<a name="l00882"></a>00882     }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884     <span class="comment">/* The node to remove. */</span>
<a name="l00885"></a>00885     rnode = entry-&gt;dir_node;
<a name="l00886"></a>00886     rnp = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(rnode);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     <span class="comment">/* Make sure that this node has no pending open calls. */</span>
<a name="l00889"></a>00889     <span class="keywordflow">if</span> (rnp-&gt;node_refs) {
<a name="l00890"></a>00890         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#c2a2e9fa555401f94478f74e01868032">EACCES</a>;
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <span class="comment">/* We only remove empty directories. */</span>
<a name="l00894"></a>00894     <span class="keywordflow">if</span> (rnp-&gt;node_type == <a class="code" href="group__xg_p_nut.html#gc4183a62d414b9d45cfb2753acf68345">NODETYPE_DIR</a>) {
<a name="l00895"></a>00895         <span class="keywordflow">if</span> (rnp-&gt;node_links &gt; 2 || !PnutDirIsEmpty(rnode)) {
<a name="l00896"></a>00896             <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#c2a2e9fa555401f94478f74e01868032">EACCES</a>;
<a name="l00897"></a>00897         }
<a name="l00898"></a>00898         rnp = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node);
<a name="l00899"></a>00899         rnp-&gt;node_links--;
<a name="l00900"></a>00900         PnutNodeRelease(rnode);
<a name="l00901"></a>00901     }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <span class="comment">/* Remove a file. */</span>
<a name="l00904"></a>00904     <span class="keywordflow">else</span> {
<a name="l00905"></a>00905         PnutNodeRelease(rnode);
<a name="l00906"></a>00906     }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <span class="comment">/* Mark this entry unused. */</span>
<a name="l00909"></a>00909     PnutDirFindEntry(node, name, <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(name), &amp;entry);
<a name="l00910"></a>00910     entry-&gt;dir_inuse = 0;
<a name="l00911"></a>00911 
<a name="l00912"></a>00912     <span class="keywordflow">return</span> 0;
<a name="l00913"></a>00913 }
<a name="l00914"></a>00914 
<a name="l00922"></a>00922 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDirCreate(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node;
<a name="l00925"></a>00925     PNUT_FINDRESULT found;
<a name="l00926"></a>00926     <span class="keywordtype">int</span> ec;
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <span class="comment">/* Return an error if this entry already exists. */</span>
<a name="l00929"></a>00929     <span class="keywordflow">if</span> ((ec = PnutDirFindPath(root, path, &amp;found)) == 0) {
<a name="l00930"></a>00930         ec = <a class="code" href="errno_8h.html#0a3bef9e5c47e42917692b5dae3b5498">EEXIST</a>;
<a name="l00931"></a>00931     }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="comment">/* If this component does not exist, we can create it... */</span>
<a name="l00934"></a>00934     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ec == <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>) {
<a name="l00935"></a>00935         <span class="comment">/* ...provided that all parents had been found. */</span>
<a name="l00936"></a>00936         <span class="keywordflow">if</span> (found.fr_name) {
<a name="l00937"></a>00937             <span class="comment">/* Allocate a new node block. */</span>
<a name="l00938"></a>00938             <span class="keywordflow">if</span> ((node = PnutNodeAlloc(<a class="code" href="group__xg_p_nut.html#gc4183a62d414b9d45cfb2753acf68345">NODETYPE_DIR</a>)) &lt; 0) {
<a name="l00939"></a>00939                 ec = <a class="code" href="errno_8h.html#088abe8bad2df798edad3053d719b937">ENOSPC</a>;
<a name="l00940"></a>00940             }
<a name="l00941"></a>00941             <span class="comment">/* Create a reference to itself. */</span>
<a name="l00942"></a>00942             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ec = PnutDirAddEntry(node, <span class="stringliteral">"."</span>, node)) != 0) {
<a name="l00943"></a>00943                 PnutNodeRelease(node);
<a name="l00944"></a>00944             }
<a name="l00945"></a>00945             <span class="comment">/* Create a reference to the parent. */</span>
<a name="l00946"></a>00946             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ec = PnutDirAddEntry(node, <span class="stringliteral">".."</span>, found.fr_pnode)) != 0) {
<a name="l00947"></a>00947                 PnutNodeRelease(node);
<a name="l00948"></a>00948             }
<a name="l00949"></a>00949             <span class="comment">/* Create a reference in the parent. */</span>
<a name="l00950"></a>00950             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ec = PnutDirAddEntry(found.fr_pnode, found.fr_name, node)) != 0) {
<a name="l00951"></a>00951                 PnutNodeRelease(node);
<a name="l00952"></a>00952             }
<a name="l00953"></a>00953         }
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <span class="comment">/* Something went wrong. */</span>
<a name="l00957"></a>00957     <span class="keywordflow">if</span> (ec) {
<a name="l00958"></a>00958         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = ec;
<a name="l00959"></a>00959         <span class="keywordflow">return</span> -1;
<a name="l00960"></a>00960     }
<a name="l00961"></a>00961     <span class="keywordflow">return</span> 0;
<a name="l00962"></a>00962 }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="comment">/* ------------------------ File routines ------------------------ */</span>
<a name="l00965"></a>00965 
<a name="l00988"></a>00988 <span class="keyword">static</span> NUTFILE *PnutFileOpen(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> acc)
<a name="l00989"></a>00989 {
<a name="l00990"></a>00990     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node = -1;
<a name="l00991"></a>00991     PNUT_FINDRESULT found;
<a name="l00992"></a>00992     <span class="keywordtype">int</span> rc;
<a name="l00993"></a>00993     PNUTFILE *file;
<a name="l00994"></a>00994     NUTFILE *nfp = <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="comment">/* Try to find an exisiting file. */</span>
<a name="l00997"></a>00997     <span class="keywordflow">if</span> ((rc = PnutDirFindPath(root, path, &amp;found)) == 0) {
<a name="l00998"></a>00998         <span class="comment">/* Return an error, if this is no regular file. */</span>
<a name="l00999"></a>00999         <span class="keywordflow">if</span> (<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(found.fr_node)-&gt;node_type != <a class="code" href="group__xg_p_nut.html#ge9cc3f70052dd31a2e9eb7ef5ccba0b8">NODETYPE_REG</a>) {
<a name="l01000"></a>01000             <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#e22c3a1e0a38f3896de238cc30d0e19b">EISDIR</a>;
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002 
<a name="l01003"></a>01003         <span class="comment">/*</span>
<a name="l01004"></a>01004 <span class="comment">         * We return an error, if the file exists and _O_EXCL has been</span>
<a name="l01005"></a>01005 <span class="comment">         * set with _O_CREAT.</span>
<a name="l01006"></a>01006 <span class="comment">         */</span>
<a name="l01007"></a>01007         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((mode &amp; (<a class="code" href="group__xg_crt_lowio.html#g774664d26ae1b1d55902562af5f1ec28">_O_CREAT</a> | <a class="code" href="group__xg_crt_lowio.html#g87ebc39a5c9c3505fe9cb094ef40c838">_O_EXCL</a>)) == (<a class="code" href="group__xg_crt_lowio.html#g774664d26ae1b1d55902562af5f1ec28">_O_CREAT</a> | <a class="code" href="group__xg_crt_lowio.html#g87ebc39a5c9c3505fe9cb094ef40c838">_O_EXCL</a>)) {
<a name="l01008"></a>01008             <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#0a3bef9e5c47e42917692b5dae3b5498">EEXIST</a>;
<a name="l01009"></a>01009         } <span class="keywordflow">else</span> {
<a name="l01010"></a>01010             node = found.fr_node;
<a name="l01011"></a>01011             <span class="keywordflow">if</span> (mode &amp; <a class="code" href="group__xg_crt_lowio.html#g695223e667532dd799a1c5b56d9eae75">_O_TRUNC</a>) {
<a name="l01012"></a>01012                 PnutNodeDataRelease(node);
<a name="l01013"></a>01013             }
<a name="l01014"></a>01014         }
<a name="l01015"></a>01015     }
<a name="l01016"></a>01016 
<a name="l01017"></a>01017     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>) {
<a name="l01018"></a>01018         <span class="comment">/*</span>
<a name="l01019"></a>01019 <span class="comment">         * If the search failed on the last path component, then</span>
<a name="l01020"></a>01020 <span class="comment">         * PnutDirFindPath() set fr_name. Only in this case we can</span>
<a name="l01021"></a>01021 <span class="comment">         * create a new file.</span>
<a name="l01022"></a>01022 <span class="comment">         */</span>
<a name="l01023"></a>01023         <span class="keywordflow">if</span> (found.fr_name &amp;&amp; (mode &amp; <a class="code" href="group__xg_crt_lowio.html#g774664d26ae1b1d55902562af5f1ec28">_O_CREAT</a>)) {
<a name="l01024"></a>01024             node = PnutNodeAlloc(<a class="code" href="group__xg_p_nut.html#ge9cc3f70052dd31a2e9eb7ef5ccba0b8">NODETYPE_REG</a>);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026             <span class="keywordflow">if</span> (node &lt; 0) {
<a name="l01027"></a>01027                 <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#088abe8bad2df798edad3053d719b937">ENOSPC</a>;
<a name="l01028"></a>01028                 <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l01029"></a>01029             }
<a name="l01030"></a>01030 
<a name="l01031"></a>01031             rc = PnutDirAddEntry(found.fr_pnode, found.fr_name, node);
<a name="l01032"></a>01032 
<a name="l01033"></a>01033             <span class="keywordflow">if</span> (rc) {
<a name="l01034"></a>01034                 PnutBlockRelease(node);
<a name="l01035"></a>01035             }
<a name="l01036"></a>01036         }
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="keywordflow">if</span> (rc == 0 &amp;&amp; node &gt;= 0) {
<a name="l01040"></a>01040         <span class="keywordflow">if</span> ((file = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(PNUTFILE))) != 0) {
<a name="l01041"></a>01041             file-&gt;f_flag |= mode &amp; (<a class="code" href="group__xg_crt_lowio.html#g4d457d93039cb26f27461c4af5868309">_O_RDONLY</a> | <a class="code" href="group__xg_crt_lowio.html#gc58f7734ab4dd8ae25bda2fba713ea56">_O_WRONLY</a> | <a class="code" href="group__xg_crt_lowio.html#g3639b6da1cf387c0af6a8a566a716062">_O_APPEND</a>);
<a name="l01042"></a>01042             file-&gt;f_pos = (mode &amp; <a class="code" href="group__xg_crt_lowio.html#g3639b6da1cf387c0af6a8a566a716062">_O_APPEND</a>) ? <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size : 0;
<a name="l01043"></a>01043             file-&gt;f_node = node;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045             <span class="keywordflow">if</span> ((nfp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(NUTFILE))) == 0) {
<a name="l01046"></a>01046                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(file);
<a name="l01047"></a>01047                 nfp = <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l01048"></a>01048             } <span class="keywordflow">else</span> {
<a name="l01049"></a>01049                 nfp-&gt;nf_next = 0;
<a name="l01050"></a>01050                 nfp-&gt;nf_dev = dev;
<a name="l01051"></a>01051                 nfp-&gt;nf_fcb = file;
<a name="l01052"></a>01052                 <span class="comment">/* Keep track of the number of open calls. */</span>
<a name="l01053"></a>01053                 <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_refs++;
<a name="l01054"></a>01054             }
<a name="l01055"></a>01055         }
<a name="l01056"></a>01056     }
<a name="l01057"></a>01057     <span class="keywordflow">return</span> nfp;
<a name="l01058"></a>01058 }
<a name="l01059"></a>01059 
<a name="l01063"></a>01063 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutFileClose(NUTFILE * nfp)
<a name="l01064"></a>01064 {
<a name="l01065"></a>01065     <span class="keywordflow">if</span> (nfp != <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l01066"></a>01066         PNUTFILE *fp = nfp-&gt;nf_fcb;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068         <span class="keywordflow">if</span> (fp) {
<a name="l01069"></a>01069             <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_refs--;
<a name="l01070"></a>01070             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(fp);
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(nfp);
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <span class="keywordflow">return</span> 0;
<a name="l01075"></a>01075     }
<a name="l01076"></a>01076     <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01086"></a>01086 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutDelete(<span class="keywordtype">char</span> *path)
<a name="l01087"></a>01087 {
<a name="l01088"></a>01088     <span class="keywordtype">int</span> ec;
<a name="l01089"></a>01089     PNUT_FINDRESULT found;
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <span class="keywordflow">if</span> ((ec = PnutDirFindPath(root, path, &amp;found)) == 0) {
<a name="l01092"></a>01092         ec = PnutDirDelEntry(found.fr_pnode, found.fr_name);
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094     <span class="keywordflow">if</span> (ec) {
<a name="l01095"></a>01095         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = ec;
<a name="l01096"></a>01096         <span class="keywordflow">return</span> -1;
<a name="l01097"></a>01097     }
<a name="l01098"></a>01098     <span class="keywordflow">return</span> 0;
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01109"></a>01109 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutStatus(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, <span class="keyword">struct</span> <a class="code" href="structstat.html" title="File status structure.">stat</a> *status)
<a name="l01110"></a>01110 {
<a name="l01111"></a>01111     <span class="keywordtype">int</span> rc;
<a name="l01112"></a>01112     PNUT_FINDRESULT found;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     <span class="keywordflow">if</span> ((rc = PnutDirFindPath(root, path, &amp;found)) == 0) {
<a name="l01115"></a>01115         status-&gt;<a class="code" href="structstat.html#2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(found.fr_node)-&gt;node_type;
<a name="l01116"></a>01116         status-&gt;<a class="code" href="structstat.html#ee916069ac664ab2b8cae1eac0c220b3" title="Block number.">st_ino</a> = found.fr_node;
<a name="l01117"></a>01117         status-&gt;<a class="code" href="structstat.html#98b18407739153f9ed5b046c32934e8b" title="Number of links.">st_nlink</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(found.fr_node)-&gt;node_links;
<a name="l01118"></a>01118         status-&gt;<a class="code" href="structstat.html#8301352421b5d6c322caf909b8e97ae4" title="Size.">st_size</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(found.fr_node)-&gt;node_size;
<a name="l01119"></a>01119         status-&gt;<a class="code" href="structstat.html#77e235090f8cb6897f1c0ce65689006b" title="Time of last modification.">st_mtime</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(found.fr_node)-&gt;node_mtime;
<a name="l01120"></a>01120     }
<a name="l01121"></a>01121     <span class="keywordflow">return</span> rc;
<a name="l01122"></a>01122 }
<a name="l01123"></a>01123 
<a name="l01133"></a>01133 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutFileStatus(PNUTFILE * fp, <span class="keyword">struct</span> <a class="code" href="structstat.html" title="File status structure.">stat</a> *status)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135     status-&gt;<a class="code" href="structstat.html#2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_type;
<a name="l01136"></a>01136     status-&gt;<a class="code" href="structstat.html#ee916069ac664ab2b8cae1eac0c220b3" title="Block number.">st_ino</a> = fp-&gt;f_node;
<a name="l01137"></a>01137     status-&gt;<a class="code" href="structstat.html#98b18407739153f9ed5b046c32934e8b" title="Number of links.">st_nlink</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_links;
<a name="l01138"></a>01138     status-&gt;<a class="code" href="structstat.html#8301352421b5d6c322caf909b8e97ae4" title="Size.">st_size</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_size;
<a name="l01139"></a>01139     status-&gt;<a class="code" href="structstat.html#77e235090f8cb6897f1c0ce65689006b" title="Time of last modification.">st_mtime</a> = <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_mtime;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141     <span class="keywordflow">return</span> 0;
<a name="l01142"></a>01142 }
<a name="l01143"></a>01143 
<a name="l01156"></a>01156 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutFileWrite(NUTFILE * nfp, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> len)
<a name="l01157"></a>01157 {
<a name="l01158"></a>01158     PNUTFILE *fp = nfp-&gt;nf_fcb;
<a name="l01159"></a>01159     <span class="keywordtype">int</span> ec = 0;
<a name="l01160"></a>01160     <span class="keywordtype">int</span> rc = 0;
<a name="l01161"></a>01161     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node = fp-&gt;f_node;
<a name="l01162"></a>01162     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *blkptr;
<a name="l01163"></a>01163     <span class="keywordtype">size_t</span> blksiz;
<a name="l01164"></a>01164     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *buf = buffer;
<a name="l01165"></a>01165 
<a name="l01166"></a>01166     <span class="keywordflow">while</span> (len) {
<a name="l01167"></a>01167         <span class="keywordflow">if</span> ((ec = PnutNodeGetDataPtr(node, fp-&gt;f_pos, (<span class="keywordtype">void</span> *) &amp;blkptr, &amp;blksiz, 1)) != 0) {
<a name="l01168"></a>01168             <span class="keywordflow">break</span>;
<a name="l01169"></a>01169         }
<a name="l01170"></a>01170         <span class="keywordflow">if</span> (blksiz &gt;= len) {
<a name="l01171"></a>01171             blksiz = len;
<a name="l01172"></a>01172             len = 0;
<a name="l01173"></a>01173         } <span class="keywordflow">else</span> {
<a name="l01174"></a>01174             len -= blksiz;
<a name="l01175"></a>01175         }
<a name="l01176"></a>01176         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(blkptr, buf, blksiz);
<a name="l01177"></a>01177         rc += blksiz;
<a name="l01178"></a>01178         buf += blksiz;
<a name="l01179"></a>01179         fp-&gt;f_pos += blksiz;
<a name="l01180"></a>01180     }
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (ec == 0 || ec == <a class="code" href="errno_8h.html#088abe8bad2df798edad3053d719b937">ENOSPC</a>) {
<a name="l01182"></a>01182         <span class="keywordflow">if</span> (<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size &lt; fp-&gt;f_pos) {
<a name="l01183"></a>01183             <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size = fp-&gt;f_pos;
<a name="l01184"></a>01184         }
<a name="l01185"></a>01185         <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_mtime = <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(0);
<a name="l01186"></a>01186     }
<a name="l01187"></a>01187     <span class="keywordflow">return</span> rc;
<a name="l01188"></a>01188 }
<a name="l01189"></a>01189 
<a name="l01190"></a>01190 <span class="preprocessor">#ifdef __HARVARD_ARCH__</span>
<a name="l01191"></a>01191 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> PnutFileWrite_P(NUTFILE * nfp, <a class="code" href="arm_8h.html#963f816fc88a5d8479c285ed4c630229">PGM_P</a> buffer, <span class="keywordtype">int</span> len)
<a name="l01192"></a>01192 {
<a name="l01193"></a>01193     <span class="keywordflow">return</span> -1;
<a name="l01194"></a>01194 }
<a name="l01195"></a>01195 <span class="preprocessor">#endif</span>
<a name="l01196"></a>01196 <span class="preprocessor"></span>
<a name="l01208"></a>01208 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutFileRead(NUTFILE * nfp, <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> len)
<a name="l01209"></a>01209 {
<a name="l01210"></a>01210     PNUTFILE *fp = nfp-&gt;nf_fcb;
<a name="l01211"></a>01211     <span class="keywordtype">int</span> ec = 0;
<a name="l01212"></a>01212     <span class="keywordtype">int</span> rc = 0;
<a name="l01213"></a>01213     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> node = fp-&gt;f_node;
<a name="l01214"></a>01214     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *blkptr;
<a name="l01215"></a>01215     <span class="keywordtype">size_t</span> blksiz;
<a name="l01216"></a>01216     <span class="keywordtype">char</span> *buf = buffer;
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="comment">/* Respect end of file. */</span>
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (len &gt; <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size - fp-&gt;f_pos) {
<a name="l01220"></a>01220         len = (size_t) (<a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(node)-&gt;node_size - fp-&gt;f_pos);
<a name="l01221"></a>01221     }
<a name="l01222"></a>01222     <span class="keywordflow">while</span> (len) {
<a name="l01223"></a>01223         <span class="keywordflow">if</span> ((ec = PnutNodeGetDataPtr(node, fp-&gt;f_pos, (<span class="keywordtype">void</span> *) &amp;blkptr, &amp;blksiz, 0)) != 0) {
<a name="l01224"></a>01224             <span class="keywordflow">break</span>;
<a name="l01225"></a>01225         }
<a name="l01226"></a>01226         <span class="keywordflow">if</span> (blksiz &gt;= len) {
<a name="l01227"></a>01227             blksiz = len;
<a name="l01228"></a>01228             len = 0;
<a name="l01229"></a>01229         } <span class="keywordflow">else</span> {
<a name="l01230"></a>01230             len -= blksiz;
<a name="l01231"></a>01231         }
<a name="l01232"></a>01232         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(buf, blkptr, blksiz);
<a name="l01233"></a>01233         rc += blksiz;
<a name="l01234"></a>01234         buf += blksiz;
<a name="l01235"></a>01235         fp-&gt;f_pos += blksiz;
<a name="l01236"></a>01236     }
<a name="l01237"></a>01237     <span class="keywordflow">return</span> rc;
<a name="l01238"></a>01238 }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutFileSeek(PNUTFILE * fp, <span class="keywordtype">long</span> *pos, <span class="keywordtype">int</span> whence)
<a name="l01241"></a>01241 {
<a name="l01242"></a>01242     <span class="keywordtype">int</span> rc = 0;
<a name="l01243"></a>01243     <span class="keywordtype">long</span> npos = *pos;
<a name="l01244"></a>01244 
<a name="l01245"></a>01245     <span class="keywordflow">switch</span> (whence) {
<a name="l01246"></a>01246     <span class="keywordflow">case</span> <a class="code" href="stdio_8h.html#4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>:
<a name="l01247"></a>01247         npos += fp-&gt;f_pos;
<a name="l01248"></a>01248         <span class="keywordflow">break</span>;
<a name="l01249"></a>01249     <span class="keywordflow">case</span> <a class="code" href="stdio_8h.html#d2a2e6c114780c3071efd24f16c7f7d8">SEEK_END</a>:
<a name="l01250"></a>01250         npos += <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_size;
<a name="l01251"></a>01251         <span class="keywordflow">break</span>;
<a name="l01252"></a>01252     }
<a name="l01253"></a>01253 
<a name="l01254"></a>01254     <span class="keywordflow">if</span> (npos &lt; 0 || npos &gt; (<span class="keywordtype">long</span>) <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_size) {
<a name="l01255"></a>01255         rc = <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l01256"></a>01256     } <span class="keywordflow">else</span> {
<a name="l01257"></a>01257         fp-&gt;f_pos = npos;
<a name="l01258"></a>01258         *pos = npos;
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260     <span class="keywordflow">return</span> rc;
<a name="l01261"></a>01261 }
<a name="l01262"></a>01262 
<a name="l01263"></a>01263 <span class="comment">/* ------------------------ Special function interface ------------------------ */</span>
<a name="l01264"></a>01264 
<a name="l01268"></a><a class="code" href="group__xg_p_nut.html#g4f8f4eb4ba13ea50c4c9f636980e1584">01268</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_p_nut.html#g4f8f4eb4ba13ea50c4c9f636980e1584" title="Device specific functions.">PnutIOCtl</a>(NUTDEVICE * dev, <span class="keywordtype">int</span> req, <span class="keywordtype">void</span> *conf)
<a name="l01269"></a>01269 {
<a name="l01270"></a>01270     <span class="keywordtype">int</span> rc = -1;
<a name="l01271"></a>01271 
<a name="l01272"></a>01272     <span class="keywordflow">switch</span> (req) {
<a name="l01273"></a>01273     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#gc7361462e3e2dc20109d6b45e857267f" title="Obtain information about a specified file entry.">FS_STATUS</a>:
<a name="l01274"></a>01274         {
<a name="l01275"></a>01275             <a class="code" href="struct_f_s_c_p___s_t_a_t_u_s.html">FSCP_STATUS</a> *par = (<a class="code" href="struct_f_s_c_p___s_t_a_t_u_s.html">FSCP_STATUS</a> *) conf;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277             rc = PnutStatus(par-&gt;<a class="code" href="struct_f_s_c_p___s_t_a_t_u_s.html#07981bc2309b037ce0b97581abc172ad">par_path</a>, par-&gt;<a class="code" href="struct_f_s_c_p___s_t_a_t_u_s.html#e19e946324739934687c2c5236c24741">par_stp</a>);
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279         <span class="keywordflow">break</span>;
<a name="l01280"></a>01280     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g185e4ad60ba0ccb8f628775b5990c27a" title="Create a new directory entry.">FS_DIR_CREATE</a>:
<a name="l01281"></a>01281         rc = PnutDirCreate((<span class="keywordtype">char</span> *) conf);
<a name="l01282"></a>01282         <span class="keywordflow">break</span>;
<a name="l01283"></a>01283     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g0b909ee1cfdd10479c5ba102988b712c" title="Remove a previously created directory entry.">FS_DIR_REMOVE</a>:
<a name="l01284"></a>01284         rc = PnutDelete((<span class="keywordtype">char</span> *) conf);
<a name="l01285"></a>01285         <span class="keywordflow">break</span>;
<a name="l01286"></a>01286     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g65d5a4f9156ce2b1d6d38ac7197b0f41" title="Open a directory stream.">FS_DIR_OPEN</a>:
<a name="l01287"></a>01287         rc = PnutDirOpen(dev, (<a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> *) conf);
<a name="l01288"></a>01288         <span class="keywordflow">break</span>;
<a name="l01289"></a>01289     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g35254ddb96dbf700ef930ebec7422ce1" title="Close a directory stream.">FS_DIR_CLOSE</a>:
<a name="l01290"></a>01290         rc = PnutDirClose((<a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> *) conf);
<a name="l01291"></a>01291         <span class="keywordflow">break</span>;
<a name="l01292"></a>01292     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#gcc0b85a7a28298d990785c827c424ee5" title="Read the next directory entry.">FS_DIR_READ</a>:
<a name="l01293"></a>01293         rc = PnutDirRead((<a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> *) conf);
<a name="l01294"></a>01294         <span class="keywordflow">break</span>;
<a name="l01295"></a>01295     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g4baef86647740b8b6ec41ba3eef76984" title="Obtain information about an opened file.">FS_FILE_STATUS</a>:
<a name="l01296"></a>01296         rc = PnutFileStatus((PNUTFILE *) ((<a class="code" href="struct_i_o_c_t_l___a_r_g2.html" title="General structure for two arguments.">IOCTL_ARG2</a> *) conf)-&gt;arg1,   <span class="comment">/* */</span>
<a name="l01297"></a>01297                             (<span class="keyword">struct</span> <a class="code" href="structstat.html" title="File status structure.">stat</a> *) ((<a class="code" href="struct_i_o_c_t_l___a_r_g2.html" title="General structure for two arguments.">IOCTL_ARG2</a> *) conf)-&gt;arg2);
<a name="l01298"></a>01298         <span class="keywordflow">break</span>;
<a name="l01299"></a>01299     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g6df93aa4301cc51c3bbf81012a4b1a85" title="Remove a previously created file.">FS_FILE_DELETE</a>:
<a name="l01300"></a>01300         rc = PnutDelete((<span class="keywordtype">char</span> *) conf);
<a name="l01301"></a>01301         <span class="keywordflow">break</span>;
<a name="l01302"></a>01302     <span class="keywordflow">case</span> <a class="code" href="group__xg_f_s.html#g595720b3629df2c8287de4c205d2a92b" title="Set a file pointer position.">FS_FILE_SEEK</a>:
<a name="l01303"></a>01303         PnutFileSeek((PNUTFILE *) ((<a class="code" href="struct_i_o_c_t_l___a_r_g3.html" title="General structure for three arguments.">IOCTL_ARG3</a> *) conf)-&gt;arg1,  <span class="comment">/* */</span>
<a name="l01304"></a>01304                      (<span class="keywordtype">long</span> *) ((<a class="code" href="struct_i_o_c_t_l___a_r_g3.html" title="General structure for three arguments.">IOCTL_ARG3</a> *) conf)-&gt;arg2,      <span class="comment">/* */</span>
<a name="l01305"></a>01305                      (<span class="keywordtype">int</span>) ((<a class="code" href="struct_i_o_c_t_l___a_r_g3.html" title="General structure for three arguments.">IOCTL_ARG3</a> *) conf)-&gt;arg3);
<a name="l01306"></a>01306         <span class="keywordflow">break</span>;
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308     <span class="keywordflow">return</span> rc;
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01322"></a>01322 <span class="keyword">static</span> <span class="keywordtype">long</span> PnutFileSize(NUTFILE *nfp)
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324     PNUTFILE *fp = nfp-&gt;nf_fcb;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     <span class="keywordflow">return</span> <a class="code" href="group__xg_p_nut.html#g5f3fdbd70697b26f533c03712c9e7f28" title="Select specified bank and return pointer to block.">BankNodePointer</a>(fp-&gt;f_node)-&gt;node_size;
<a name="l01327"></a>01327 }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329 <span class="comment">/* ------------------------ Initialization ------------------------ */</span>
<a name="l01330"></a>01330 
<a name="l01342"></a>01342 <span class="keyword">static</span> <span class="keywordtype">int</span> PnutInit(NUTDEVICE * dev)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344     <a class="code" href="group__xg_p_nut.html#gb1df3a55e86e5ea88e4db13d08662ad4">PNUT_BLKNUM</a> i;
<a name="l01345"></a>01345     <span class="keywordtype">int</span> rc;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     <span class="comment">/* Add all blocks to the free list. */</span>
<a name="l01348"></a>01348     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__xg_p_nut.html#g7ca418ff25e56062efc19694a920aef8" title="Total number of blocks on this device.">PNUT_TOTAL_BLOCKS</a>; i++) {
<a name="l01349"></a>01349         PnutBlockRelease(i);
<a name="l01350"></a>01350     }
<a name="l01351"></a>01351 
<a name="l01352"></a>01352     <span class="comment">/* Initialize the root directory. */</span>
<a name="l01353"></a>01353     <span class="keywordflow">if</span> ((root = PnutNodeAlloc(<a class="code" href="group__xg_p_nut.html#gc4183a62d414b9d45cfb2753acf68345">NODETYPE_DIR</a>)) == -1) {
<a name="l01354"></a>01354         rc = <a class="code" href="errno_8h.html#088abe8bad2df798edad3053d719b937">ENOSPC</a>;
<a name="l01355"></a>01355     } <span class="keywordflow">else</span> {
<a name="l01356"></a>01356         <span class="keywordflow">if</span> ((rc = PnutDirAddEntry(root, <span class="stringliteral">"."</span>, root)) == 0) {
<a name="l01357"></a>01357             rc = PnutDirAddEntry(root, <span class="stringliteral">".."</span>, root);
<a name="l01358"></a>01358         }
<a name="l01359"></a>01359         <span class="keywordflow">if</span> (rc) {
<a name="l01360"></a>01360             PnutBlockRelease(root);
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362     }
<a name="l01363"></a>01363     <span class="keywordflow">return</span> rc;
<a name="l01364"></a>01364 }
<a name="l01365"></a>01365 
<a name="l01369"></a><a class="code" href="group__xg_p_nut.html#gca108170da851cf5f834b85bb066cbaa">01369</a> NUTDEVICE <a class="code" href="group__xg_p_nut.html#gca108170da851cf5f834b85bb066cbaa" title="Peanut device information structure.">devPnut</a> = {
<a name="l01370"></a>01370     0,                          
<a name="l01371"></a>01371     {<span class="charliteral">'P'</span>, <span class="charliteral">'N'</span>, <span class="charliteral">'U'</span>, <span class="charliteral">'T'</span>, 0, 0, 0, 0, 0}
<a name="l01372"></a>01372     ,                           
<a name="l01373"></a>01373     <a class="code" href="group__xg_device.html#gdaf0becb8e956d286be219588232f118" title="RAM device.">IFTYP_RAM</a>,                  
<a name="l01374"></a>01374     0,                          
<a name="l01375"></a>01375     0,                          
<a name="l01376"></a>01376     0,                          
<a name="l01377"></a>01377     0,                          
<a name="l01378"></a>01378     PnutInit,                   
<a name="l01379"></a>01379     <a class="code" href="group__xg_p_nut.html#g4f8f4eb4ba13ea50c4c9f636980e1584" title="Device specific functions.">PnutIOCtl</a>,                  
<a name="l01380"></a>01380     PnutFileRead,               
<a name="l01381"></a>01381     PnutFileWrite,              
<a name="l01382"></a>01382 <span class="preprocessor">#ifdef __HARVARD_ARCH__</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span>    PnutFileWrite_P,            
<a name="l01384"></a>01384 <span class="preprocessor">#endif</span>
<a name="l01385"></a>01385 <span class="preprocessor"></span>    PnutFileOpen,               
<a name="l01386"></a>01386     PnutFileClose,              
<a name="l01387"></a>01387     PnutFileSize                
<a name="l01388"></a>01388 };
<a name="l01389"></a>01389 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
