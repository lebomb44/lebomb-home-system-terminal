<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_264e76a43993b4d38befcb6805fdec2d.html">arch</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b0f1ad2db40117979aa0dc775463a1e9.html">avr</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_42e6833dcb69f3de75c6e85ab40d9c56.html">dev</a>
  </div>
<div class="contents">
<h1>tlc16c550.c</h1><a href="tlc16c550_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2003 by Cyber Integration, LLC. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY CYBER INTEGRATION, LLC AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL CYBER</span>
<a name="l00021"></a>00021 <span class="comment"> * INTEGRATION, LLC OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">/*</span>
<a name="l00034"></a>00034 <span class="comment"> * $Log$</span>
<a name="l00035"></a>00035 <span class="comment"> * Revision 1.4  2009/01/17 11:26:38  haraldkipp</span>
<a name="l00036"></a>00036 <span class="comment"> * Getting rid of two remaining BSD types in favor of stdint.</span>
<a name="l00037"></a>00037 <span class="comment"> * Replaced 'u_int' by 'unsinged int' and 'uptr_t' by 'uintptr_t'.</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * Revision 1.3  2008/08/11 06:59:17  haraldkipp</span>
<a name="l00040"></a>00040 <span class="comment"> * BSD types replaced by stdint types (feature request #1282721).</span>
<a name="l00041"></a>00041 <span class="comment"> *</span>
<a name="l00042"></a>00042 <span class="comment"> * Revision 1.2  2007/05/24 07:29:10  haraldkipp</span>
<a name="l00043"></a>00043 <span class="comment"> * Update provided by Przemyslaw Rudy.</span>
<a name="l00044"></a>00044 <span class="comment"> *</span>
<a name="l00045"></a>00045 <span class="comment"> * Revision 1.1  2005/11/24 11:24:06  haraldkipp</span>
<a name="l00046"></a>00046 <span class="comment"> * Initial check-in.</span>
<a name="l00047"></a>00047 <span class="comment"> * Many thanks to William Basser for this code and also to Przemyslaw Rudy</span>
<a name="l00048"></a>00048 <span class="comment"> * for several enhancements.</span>
<a name="l00049"></a>00049 <span class="comment"> *</span>
<a name="l00050"></a>00050 <span class="comment"> */</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="comment">// system include files</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;<a class="code" href="include_2sys_2atom_8h.html">sys/atom.h</a>&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;<a class="code" href="device_8h.html" title="Nut/OS device definitions.">sys/device.h</a>&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;<a class="code" href="dev_2irqreg_8h.html" title="Interrupt management definitions.">dev/irqreg.h</a>&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;<a class="code" href="tlc16c550_8h.html" title="ACE ACE definitions.">dev/tlc16c550.h</a>&gt;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">/*</span>
<a name="l00065"></a>00065 <span class="comment"> * Not nice because stdio already defined them. But in order to save memory,</span>
<a name="l00066"></a>00066 <span class="comment"> * we do the whole buffering and including stdio here would be more weird.</span>
<a name="l00067"></a>00067 <span class="comment"> */</span>
<a name="l00068"></a>00068 <span class="preprocessor">#ifndef _IOFBF</span>
<a name="l00069"></a><a class="code" href="tlc16c550_8c.html#f7475971eb93ce0184379e71fe7626e9">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define _IOFBF      0x00</span>
<a name="l00070"></a><a class="code" href="tlc16c550_8c.html#ca9e52813bd224e4519e0b1289abbce9">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define _IOLBF      0x01</span>
<a name="l00071"></a><a class="code" href="tlc16c550_8c.html#8661edb6b53e3104bef089bef02d0508">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define _IONBF      0x02</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">// define the register offset</span>
<a name="l00081"></a>00081 <span class="comment">// define the UART Register offsets</span>
<a name="l00082"></a><a class="code" href="tlc16c550_8c.html#50df89986f86918a4ba750873ac1db70">00082</a> <span class="preprocessor">#define ACE_RBR_OFS 0</span>
<a name="l00083"></a><a class="code" href="tlc16c550_8c.html#1fcffe806b6ca0d3d4a39de773c229ba">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_THR_OFS 0</span>
<a name="l00084"></a><a class="code" href="tlc16c550_8c.html#7762267bb4a28176c28c0937cdfc11ca">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_DLL_OFS 0</span>
<a name="l00085"></a><a class="code" href="tlc16c550_8c.html#2dc62c20e1ed0b262e26852eac745f83">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_DLM_OFS 1</span>
<a name="l00086"></a><a class="code" href="tlc16c550_8c.html#226bce7d15ab072b05a6e8388a648272">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_IER_OFS 1</span>
<a name="l00087"></a><a class="code" href="tlc16c550_8c.html#889144df2c33aafc3ffb26337aafe6ff">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_FCR_OFS 2</span>
<a name="l00088"></a><a class="code" href="tlc16c550_8c.html#11c205d0834a148a09f9af56711364c4">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_IIR_OFS 2</span>
<a name="l00089"></a><a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">00089</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_LCR_OFS 3</span>
<a name="l00090"></a><a class="code" href="tlc16c550_8c.html#0bc6a1077d49f1ddaf4908048fa2d232">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_MCR_OFS 4</span>
<a name="l00091"></a><a class="code" href="tlc16c550_8c.html#d4c1f998abe6306a2967c63f5a4dd391">00091</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_LSR_OFS 5</span>
<a name="l00092"></a><a class="code" href="tlc16c550_8c.html#5ff12025e94bb0abf4850c6f7431cf39">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_MSR_OFS 6</span>
<a name="l00093"></a><a class="code" href="tlc16c550_8c.html#f69f5e64ca6c10ee9527bb17dc8b9c61">00093</a> <span class="preprocessor"></span><span class="preprocessor">#define ACE_SRC_OFS 7</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a>00095 <span class="comment">// define the interrupt enable masks</span>
<a name="l00096"></a><a class="code" href="tlc16c550_8c.html#387954150ca84a7c0b4ba27e7ce5496f">00096</a> <span class="preprocessor">#define IER_RDA_MSK 0x01    // receiver data avaialbe</span>
<a name="l00097"></a><a class="code" href="tlc16c550_8c.html#158eddf7d8c01b9553ae560cadb4826a">00097</a> <span class="preprocessor"></span><span class="preprocessor">#define IER_THE_MSK 0x02    // transmit holding empty</span>
<a name="l00098"></a><a class="code" href="tlc16c550_8c.html#d44c28b6925800e83ba285f273c94963">00098</a> <span class="preprocessor"></span><span class="preprocessor">#define IER_LST_MSK 0x04    // line status</span>
<a name="l00099"></a><a class="code" href="tlc16c550_8c.html#d72a4f0d85f1fb4a9c665aad0969cd02">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define IER_MST_MSK 0x08    // modem status</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101 <span class="comment">// define the fifo control mask</span>
<a name="l00102"></a><a class="code" href="tlc16c550_8c.html#b913b6d872443246c86605c8f012bfcf">00102</a> <span class="preprocessor">#define FCR_ENABLE     0x01     //fifo enable</span>
<a name="l00103"></a><a class="code" href="tlc16c550_8c.html#dd709470c047c5f82b501dae79dd1c04">00103</a> <span class="preprocessor"></span><span class="preprocessor">#define FCR_PURGE_I 0x02    //purge all data from input fifo</span>
<a name="l00104"></a><a class="code" href="tlc16c550_8c.html#6d7af205d94a23925ebdf911ebf1ace3">00104</a> <span class="preprocessor"></span><span class="preprocessor">#define FCR_PURGE_O 0x04    //purge all data from output fifo</span>
<a name="l00105"></a><a class="code" href="tlc16c550_8c.html#feeb6f64a2b6cb035bb937d302e73baf">00105</a> <span class="preprocessor"></span><span class="preprocessor">#define FCR_LEVEL_1    0x00     //receive trigger level 1</span>
<a name="l00106"></a><a class="code" href="tlc16c550_8c.html#03ad395c09fdeb8be2cc0bf605d62a99">00106</a> <span class="preprocessor"></span><span class="preprocessor">#define FCR_LEVEL_4    0x40     //receive trigger level 4</span>
<a name="l00107"></a><a class="code" href="tlc16c550_8c.html#4c0bc63c1e044c3598e52e354a57cc0e">00107</a> <span class="preprocessor"></span><span class="preprocessor">#define FCR_LEVEL_8    0x80     //receive trigger level 8</span>
<a name="l00108"></a><a class="code" href="tlc16c550_8c.html#dc9f464d008fc72458e75e55fc5f59bd">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define FCR_LEVEL_14   0xc0     //receive trigger level 14</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>
<a name="l00110"></a>00110 <span class="comment">// define the interrupt id masks</span>
<a name="l00111"></a><a class="code" href="tlc16c550_8c.html#a6fd2b63cd90121bd2c4a02ff01ee3c8">00111</a> <span class="preprocessor">#define IIR_MST_MSK 0x00    // modem status interrupt</span>
<a name="l00112"></a><a class="code" href="tlc16c550_8c.html#b9d422b7daba9364b49eae16d563e9d9">00112</a> <span class="preprocessor"></span><span class="preprocessor">#define IIR_TXE_MSK 0x02    // transmit buffer empty</span>
<a name="l00113"></a><a class="code" href="tlc16c550_8c.html#72878acd711986bb3691419d674f6fba">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define IIR_RDA_MSK 0x04    // receive data available</span>
<a name="l00114"></a><a class="code" href="tlc16c550_8c.html#deb089a85d6ccd66f87ffabd7da8142b">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define IIR_TDA_MSK 0x0c    // timeout receive data available</span>
<a name="l00115"></a><a class="code" href="tlc16c550_8c.html#7b06267a5a7a1427a3cb8f51a30f437e">00115</a> <span class="preprocessor"></span><span class="preprocessor">#define IIR_LST_MSK 0x06    // line status interrupt</span>
<a name="l00116"></a><a class="code" href="tlc16c550_8c.html#c595e29e0c160deb2e38a0e4e4a6f06a">00116</a> <span class="preprocessor"></span><span class="preprocessor">#define IIR_NON_MSK 0x01    // no interrupt</span>
<a name="l00117"></a><a class="code" href="tlc16c550_8c.html#f8719631ce129c3b1c4a83fc2f8e6bac">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define IIR_FIFO_MSK   0xc0     // mask to eliminate the fifo status</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>
<a name="l00119"></a>00119 <span class="comment">// define the line control masks</span>
<a name="l00120"></a><a class="code" href="tlc16c550_8c.html#f693c2ba3d535f69e0125309202a2a00">00120</a> <span class="preprocessor">#define LCR_WS0_MSK 0x01</span>
<a name="l00121"></a><a class="code" href="tlc16c550_8c.html#7885e5904121e306b2874c7414c19f97">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_WS1_MSK 0x02</span>
<a name="l00122"></a><a class="code" href="tlc16c550_8c.html#cfb7a59be4967a37d4233a1093c36236">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_STB_MSK 0x04</span>
<a name="l00123"></a><a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">00123</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_PEN_MSK 0x08</span>
<a name="l00124"></a><a class="code" href="tlc16c550_8c.html#b569c6dd010406c7e9540c94450ac05b">00124</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_PRE_MSK 0x10</span>
<a name="l00125"></a><a class="code" href="tlc16c550_8c.html#c74056375c5b8539464fdb763d68771e">00125</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_PRS_MSK 0x20</span>
<a name="l00126"></a><a class="code" href="tlc16c550_8c.html#557eaa5857940722164cbc3bfcbf36ac">00126</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_BRK_MSK 0x40</span>
<a name="l00127"></a><a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">00127</a> <span class="preprocessor"></span><span class="preprocessor">#define LCR_ENB_MSK 0x80</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>
<a name="l00129"></a>00129 <span class="comment">// define the modem control masks</span>
<a name="l00130"></a><a class="code" href="tlc16c550_8c.html#58110f0ea50675521fe00d38d701d567">00130</a> <span class="preprocessor">#define MCR_DTR_MSK 0x01</span>
<a name="l00131"></a><a class="code" href="tlc16c550_8c.html#3ab781420ff3894862d27c75baed2bb2">00131</a> <span class="preprocessor"></span><span class="preprocessor">#define MCR_RTS_MSK 0x02</span>
<a name="l00132"></a><a class="code" href="tlc16c550_8c.html#e84cb8a74a08e996472604edc8311b9b">00132</a> <span class="preprocessor"></span><span class="preprocessor">#define MCR_GP1_MSK 0x04</span>
<a name="l00133"></a><a class="code" href="tlc16c550_8c.html#a9436293bd312563ab28947585e23c40">00133</a> <span class="preprocessor"></span><span class="preprocessor">#define MCR_GP2_MSK 0x08</span>
<a name="l00134"></a><a class="code" href="tlc16c550_8c.html#12b5e38006a2776c7238d6aec7b388d5">00134</a> <span class="preprocessor"></span><span class="preprocessor">#define MCR_LOP_MSK 0x10</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>
<a name="l00136"></a>00136 <span class="comment">// define the line status masks</span>
<a name="l00137"></a><a class="code" href="tlc16c550_8c.html#5364f2a3d180f035790cfa035b5f8da8">00137</a> <span class="preprocessor">#define LSR_RDR_MSK 0x01</span>
<a name="l00138"></a><a class="code" href="tlc16c550_8c.html#d5377feb86a0ef9e5232ad05890aba58">00138</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_OVR_MSK 0x02</span>
<a name="l00139"></a><a class="code" href="tlc16c550_8c.html#e39751d8b5cd4586cdd79ae411c0d21b">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_PER_MSK 0x04</span>
<a name="l00140"></a><a class="code" href="tlc16c550_8c.html#276cb8064dde258b1d1928dab7a77d37">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_FER_MSK 0x08</span>
<a name="l00141"></a><a class="code" href="tlc16c550_8c.html#b8df4ddbf9236118ea3d479c4fea3924">00141</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_BDT_MSK 0x10</span>
<a name="l00142"></a><a class="code" href="tlc16c550_8c.html#797ab3986a2bf8a85d1f3ed4c8992548">00142</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_THE_MSK 0x20</span>
<a name="l00143"></a><a class="code" href="tlc16c550_8c.html#34beed330a975b3c1f2651dce3f22bb9">00143</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_TXE_MSK 0x40</span>
<a name="l00144"></a><a class="code" href="tlc16c550_8c.html#a9b085a4a444f5e30c6607c205aa27dd">00144</a> <span class="preprocessor"></span><span class="preprocessor">#define LSR_EIF_MSK 0x80</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>
<a name="l00146"></a>00146 <span class="comment">// define the modem status masks</span>
<a name="l00147"></a><a class="code" href="tlc16c550_8c.html#26e5d8596557ae7df575f2ee49ac61f5">00147</a> <span class="preprocessor">#define MSR_DCTS_MSK    0x01</span>
<a name="l00148"></a><a class="code" href="tlc16c550_8c.html#873ff7f5b86ce8c315b367857b56b671">00148</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_DDSR_MSK    0x02</span>
<a name="l00149"></a><a class="code" href="tlc16c550_8c.html#261a7ccf48c704fbd4883dc122b21833">00149</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_DRI_MSK 0x04</span>
<a name="l00150"></a><a class="code" href="tlc16c550_8c.html#34e1e118db5b4f83e8a111a4f71d3bbc">00150</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_DDCD_MSK    0x08</span>
<a name="l00151"></a><a class="code" href="tlc16c550_8c.html#210cfb640351bea76bb93f5e515bfcfe">00151</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_CTS_MSK 0x10</span>
<a name="l00152"></a><a class="code" href="tlc16c550_8c.html#afc074bbd1c100e69696d380e6b12092">00152</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_DSR_MSK 0x20</span>
<a name="l00153"></a><a class="code" href="tlc16c550_8c.html#ef4bc18ea3bddced0eb381c3431a1a27">00153</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_RI_MSK      0x40</span>
<a name="l00154"></a><a class="code" href="tlc16c550_8c.html#d5a7879e143db53e02d755ab715688c4">00154</a> <span class="preprocessor"></span><span class="preprocessor">#define MSR_DCD_MSK 0x80</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156 <span class="comment">// define the irq structure</span>
<a name="l00157"></a>00157 <span class="keyword">typedef</span> <span class="keyword">struct </span>tagIRQDEFS {
<a name="l00158"></a>00158     <a class="code" href="struct_i_r_q___h_a_n_d_l_e_r.html">IRQ_HANDLER</a> *pvIrq;
<a name="l00159"></a>00159     <span class="keyword">volatile</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *pnIrqMskPort;
<a name="l00160"></a>00160     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> nMask;
<a name="l00161"></a>00161 } IRQDEFS;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">// define the interrupt handlers</span>
<a name="l00164"></a>00164 <span class="keyword">static</span> <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> PROGMEM IRQDEFS atIrqDefs[] = {
<a name="l00165"></a>00165     {&amp;<a class="code" href="group__xg_irq_reg.html#g48c5067e0a6ab2cc7b479bdf42e6ddf7">sig_INTERRUPT0</a>, &amp;EICRA, 0x00},
<a name="l00166"></a>00166     {&amp;<a class="code" href="group__xg_irq_reg.html#g13551dd2ff2a44ea0fb35d48f9ff1a11">sig_INTERRUPT1</a>, &amp;EICRA, 0x00},
<a name="l00167"></a>00167     {&amp;<a class="code" href="group__xg_irq_reg.html#g0b7e39853326f70a1e2b87bd553f8cf0">sig_INTERRUPT2</a>, &amp;EICRA, 0x00},
<a name="l00168"></a>00168     {&amp;<a class="code" href="group__xg_irq_reg.html#gaf6c379dd63f582b021d35061fa6cbae">sig_INTERRUPT3</a>, &amp;EICRA, 0x00},
<a name="l00169"></a>00169     {&amp;<a class="code" href="group__xg_irq_reg.html#geeb7c3b8971d61309fa900c138dd4993">sig_INTERRUPT4</a>, &amp;EICRB, 0x00},
<a name="l00170"></a>00170     {&amp;<a class="code" href="group__xg_irq_reg.html#gba23f9724a8fd9692ac0771ee081a65f">sig_INTERRUPT5</a>, &amp;EICRB, 0x00},
<a name="l00171"></a>00171     {&amp;<a class="code" href="group__xg_irq_reg.html#g4aec933b00da485a95c5e334153717eb">sig_INTERRUPT6</a>, &amp;EICRB, 0x00},
<a name="l00172"></a>00172     {&amp;<a class="code" href="group__xg_irq_reg.html#gd05cd87319597b38f99b482af16aaa77">sig_INTERRUPT7</a>, &amp;EICRB, 0x00}
<a name="l00173"></a>00173 };
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">// define the dcb's asigned to the interrupt to have more than one device on the same interrupt</span>
<a name="l00176"></a>00176 <span class="comment">// NUT intrnal irq structure could be used instead but that would be a hack</span>
<a name="l00177"></a>00177 <span class="keyword">static</span> NUTDEVICE *pIrqDev[8] = { NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL };
<a name="l00178"></a>00178 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> irqMask = 0;
<a name="l00179"></a>00179 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ByteOcrTime(NUTDEVICE * dev);
<a name="l00181"></a>00181 <span class="keyword">static</span> <span class="keywordtype">void</span> AceTmr3Init(<span class="keywordtype">void</span>);
<a name="l00182"></a>00182 <span class="keyword">static</span> <span class="keywordtype">void</span> AceOutComp3AInt(<span class="keywordtype">void</span> *arg);
<a name="l00183"></a>00183 <span class="keyword">static</span> <span class="keywordtype">void</span> AceAddHdxTime(ACEDCB * dev);
<a name="l00184"></a>00184 <span class="preprocessor">#endif</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>
<a name="l00186"></a>00186 <span class="comment">/*</span>
<a name="l00187"></a>00187 <span class="comment"> * Handle AVR ACE interrupts</span>
<a name="l00188"></a>00188 <span class="comment"> */</span>
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keywordtype">void</span> AceIrqHandler(<span class="keywordtype">void</span> *arg)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     NUTDEVICE *dev = (NUTDEVICE *) arg;
<a name="l00192"></a>00192     IFSTREAM *ifs;
<a name="l00193"></a>00193     ACEDCB *dcb;
<a name="l00194"></a>00194     <span class="keyword">volatile</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> event;
<a name="l00195"></a>00195     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> maxData;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="keywordflow">do</span> {
<a name="l00198"></a>00198         ifs = dev-&gt;dev_icb;
<a name="l00199"></a>00199         dcb = dev-&gt;dev_dcb;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         <span class="comment">// get the interrupt source</span>
<a name="l00202"></a>00202         <span class="keywordflow">while</span> (((event = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#11c205d0834a148a09f9af56711364c4">ACE_IIR_OFS</a>)) &amp; ~<a class="code" href="tlc16c550_8c.html#f8719631ce129c3b1c4a83fc2f8e6bac">IIR_FIFO_MSK</a>) != <a class="code" href="tlc16c550_8c.html#c595e29e0c160deb2e38a0e4e4a6f06a">IIR_NON_MSK</a>) {
<a name="l00203"></a>00203             <span class="keywordflow">switch</span> (event &amp; ~<a class="code" href="tlc16c550_8c.html#f8719631ce129c3b1c4a83fc2f8e6bac">IIR_FIFO_MSK</a>) {
<a name="l00204"></a>00204             <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#72878acd711986bb3691419d674f6fba">IIR_RDA_MSK</a>:  <span class="comment">// receive data available</span>
<a name="l00205"></a>00205             <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#deb089a85d6ccd66f87ffabd7da8142b">IIR_TDA_MSK</a>:  <span class="comment">// timeout receive data available</span>
<a name="l00206"></a>00206                 <span class="comment">/* maxData can be avoided but it ensures that for slow system and fast uart we will not get stuck</span>
<a name="l00207"></a>00207 <span class="comment">                 * reading incomming data all the time.</span>
<a name="l00208"></a>00208 <span class="comment">                 */</span>
<a name="l00209"></a>00209                 maxData = (dcb-&gt;dcb_rfifo == 0) ? 1 : dcb-&gt;dcb_rfifo;
<a name="l00210"></a>00210                 for (; (*(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#d4c1f998abe6306a2967c63f5a4dd391">ACE_LSR_OFS</a>) &amp; <a class="code" href="tlc16c550_8c.html#5364f2a3d180f035790cfa035b5f8da8">LSR_RDR_MSK</a>) &amp;&amp; (maxData &gt; 0); --maxData) {
<a name="l00211"></a>00211                     <span class="comment">// get the character and store it</span>
<a name="l00212"></a>00212                     ifs-&gt;if_rx_buf[ifs-&gt;if_rx_idx] = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#50df89986f86918a4ba750873ac1db70">ACE_RBR_OFS</a>);
<a name="l00213"></a>00213                     <span class="comment">/* if we have just received a first byte into the empty buffer */</span>
<a name="l00214"></a>00214                     <span class="keywordflow">if</span> (ifs-&gt;if_rd_idx == ifs-&gt;if_rx_idx) {
<a name="l00215"></a>00215                         <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;(dcb-&gt;dcb_rx_rdy));
<a name="l00216"></a>00216                     }
<a name="l00217"></a>00217                     <span class="comment">/* Late increment fixes ICCAVR bug on volatile variables. */</span>
<a name="l00218"></a>00218                     ifs-&gt;if_rx_idx++;
<a name="l00219"></a>00219                 }
<a name="l00220"></a>00220                 <span class="keywordflow">break</span>;
<a name="l00221"></a>00221 
<a name="l00222"></a>00222             <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#b9d422b7daba9364b49eae16d563e9d9">IIR_TXE_MSK</a>:  <span class="comment">// transmit buffer empty</span>
<a name="l00223"></a>00223                 dcb-&gt;dcb_wfifo = (<span class="keyword">event</span> &amp; <a class="code" href="tlc16c550_8c.html#f8719631ce129c3b1c4a83fc2f8e6bac">IIR_FIFO_MSK</a>) ? <a class="code" href="group__xg_ace_driver.html#gd02aef620ad81b4c8c2f3cd301dc4201">ACE_FIFO_SIZE</a> : 1;
<a name="l00224"></a>00224                 <span class="keywordflow">if</span> (ifs-&gt;if_tx_idx != ifs-&gt;if_wr_idx) {
<a name="l00225"></a>00225                     <span class="keywordflow">for</span> (; (ifs-&gt;if_tx_idx != ifs-&gt;if_wr_idx) &amp;&amp; (dcb-&gt;dcb_wfifo &gt; 0); ++ifs-&gt;if_tx_idx) {
<a name="l00226"></a>00226                         --dcb-&gt;dcb_wfifo;
<a name="l00227"></a>00227                         <span class="comment">// send a character</span>
<a name="l00228"></a>00228                         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#1fcffe806b6ca0d3d4a39de773c229ba">ACE_THR_OFS</a>) = ifs-&gt;if_tx_buf[ifs-&gt;if_tx_idx];
<a name="l00229"></a>00229                     }
<a name="l00230"></a>00230                 } <span class="keywordflow">else</span> {
<a name="l00231"></a>00231 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#gbdf446f3526365f146db37874f95323d">ACE_MF_HALFDUPLEX</a>) {
<a name="l00233"></a>00233                         AceAddHdxTime(dcb);
<a name="l00234"></a>00234                     }
<a name="l00235"></a>00235 <span class="preprocessor">#endif</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>                    ifs-&gt;if_tx_act = 0;
<a name="l00237"></a>00237                     <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;(dcb-&gt;dcb_tx_rdy));
<a name="l00238"></a>00238                 }
<a name="l00239"></a>00239                 <span class="keywordflow">break</span>;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241             <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#a6fd2b63cd90121bd2c4a02ff01ee3c8">IIR_MST_MSK</a>:  <span class="comment">// modem status interrupt</span>
<a name="l00242"></a>00242                 <span class="keywordflow">break</span>;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244             <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#7b06267a5a7a1427a3cb8f51a30f437e">IIR_LST_MSK</a>:  <span class="comment">// line status interrupt</span>
<a name="l00245"></a>00245                 <span class="keywordflow">break</span>;
<a name="l00246"></a>00246             }
<a name="l00247"></a>00247         }
<a name="l00248"></a>00248         <span class="comment">/* get the next device assigned to this interrupt */</span>
<a name="l00249"></a>00249         dev = dcb-&gt;dev_next;
<a name="l00250"></a>00250     } <span class="keywordflow">while</span> (dev != NULL);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ByteOcrTime(NUTDEVICE * dev)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bv;
<a name="l00258"></a>00258     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tb = 14;             <span class="comment">/* twice of 1 start 5 char min. 1 stop */</span>
<a name="l00259"></a>00259     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sv;
<a name="l00260"></a>00260     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> s, c;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <span class="comment">/* get speed */</span>
<a name="l00263"></a>00263     *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) |= <a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">LCR_ENB_MSK</a>;
<a name="l00264"></a>00264     sv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#7762267bb4a28176c28c0937cdfc11ca">ACE_DLL_OFS</a>);
<a name="l00265"></a>00265     sv |= *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#2dc62c20e1ed0b262e26852eac745f83">ACE_DLM_OFS</a>) &lt;&lt; 8;
<a name="l00266"></a>00266     *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ <a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">LCR_ENB_MSK</a>;
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     bv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     <span class="comment">/* character length *2 */</span>
<a name="l00271"></a>00271     tb += (bv &amp; (<a class="code" href="tlc16c550_8c.html#f693c2ba3d535f69e0125309202a2a00">LCR_WS0_MSK</a> | <a class="code" href="tlc16c550_8c.html#7885e5904121e306b2874c7414c19f97">LCR_WS1_MSK</a>)) &lt;&lt; 1;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="comment">/* stop bits *2 */</span>
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (bv &amp; <a class="code" href="tlc16c550_8c.html#cfb7a59be4967a37d4233a1093c36236">LCR_STB_MSK</a>) {
<a name="l00275"></a>00275         tb += 1 + !!(bv &amp; (<a class="code" href="tlc16c550_8c.html#f693c2ba3d535f69e0125309202a2a00">LCR_WS0_MSK</a> | <a class="code" href="tlc16c550_8c.html#7885e5904121e306b2874c7414c19f97">LCR_WS1_MSK</a>));
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     <span class="comment">/* parity bit *2 */</span>
<a name="l00279"></a>00279     tb += (!!(bv &amp; <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a>)) &lt;&lt; 1;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     s = <a class="code" href="group__xg_ace_driver.html#g0294736898d5cc61dbd6517e3c05c809">ACE_CLOCK</a> * 8UL;
<a name="l00282"></a>00282     s = s / (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>) (sv);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284     c = <a class="code" href="group__xg_timer.html#g784a7f52b5167c777149fd1d874c99f0" title="Return the CPU clock frequency.">NutGetCpuClock</a>();
<a name="l00285"></a>00285     c = c * (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>) tb;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287     sv = ((<span class="keywordtype">unsigned</span> int) (c / s) &amp; 0x0000ffff) - 1;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     <span class="keywordflow">return</span> sv;
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 <span class="preprocessor">#endif</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>
<a name="l00305"></a><a class="code" href="tlc16c550_8c.html#238cbfd0bda60bd2743a177fafdb6998">00305</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#238cbfd0bda60bd2743a177fafdb6998" title="Wait for input.">AceInput</a>(NUTDEVICE * dev)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307     <span class="keywordtype">int</span> rc = 0;
<a name="l00308"></a>00308     IFSTREAM *ifs = dev-&gt;dev_icb;
<a name="l00309"></a>00309     ACEDCB *dcb = dev-&gt;dev_dcb;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (ifs-&gt;if_rd_idx == ifs-&gt;if_rx_idx) {
<a name="l00312"></a>00312         rc = <a class="code" href="group__xg_event.html#gc836d5fc78018d8d079cc9d21a2383b9" title="Wait for a new event in a specified queue.">NutEventWaitNext</a>(&amp;(dcb-&gt;dcb_rx_rdy), dcb-&gt;dcb_rtimeout);
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314     <span class="keywordflow">return</span> rc;
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00331"></a><a class="code" href="tlc16c550_8c.html#9ea31a358cd682c9ae1ca8cff879ea40">00331</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#9ea31a358cd682c9ae1ca8cff879ea40" title="Initiate output.">AceOutput</a>(NUTDEVICE * dev)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     IFSTREAM *ifs = dev-&gt;dev_icb;
<a name="l00334"></a>00334     ACEDCB *dcb = dev-&gt;dev_dcb;
<a name="l00335"></a>00335     <span class="keyword">volatile</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tmp;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     <span class="keywordflow">if</span> ((ifs-&gt;if_tx_act == 0) &amp;&amp; (ifs-&gt;if_tx_idx != ifs-&gt;if_wr_idx)) {
<a name="l00338"></a>00338         ifs-&gt;if_tx_act = 1;
<a name="l00339"></a>00339         --dcb-&gt;dcb_wfifo;
<a name="l00340"></a>00340         tmp = ifs-&gt;if_tx_idx;
<a name="l00341"></a>00341         ++ifs-&gt;if_tx_idx;
<a name="l00342"></a>00342 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#gbdf446f3526365f146db37874f95323d">ACE_MF_HALFDUPLEX</a>) {
<a name="l00344"></a>00344             ACE_HDX_TRANSMIT(dev-&gt;dev_base);
<a name="l00345"></a>00345         }
<a name="l00346"></a>00346 <span class="preprocessor">#endif</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>        <span class="comment">// send a character</span>
<a name="l00348"></a>00348         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#1fcffe806b6ca0d3d4a39de773c229ba">ACE_THR_OFS</a>) = ifs-&gt;if_tx_buf[tmp];
<a name="l00349"></a>00349         <span class="comment">// no need to enable an interrupt here as it should be enabled all the time</span>
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="keywordflow">return</span> 0;
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00365"></a><a class="code" href="tlc16c550_8c.html#772d16a30df7244d14ab92c1fffa8582">00365</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#772d16a30df7244d14ab92c1fffa8582" title="Wait for output buffer empty.">AceFlush</a>(NUTDEVICE * dev)
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367     IFSTREAM *ifs = dev-&gt;dev_icb;
<a name="l00368"></a>00368     ACEDCB *dcb = dev-&gt;dev_dcb;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment">/*</span>
<a name="l00371"></a>00371 <span class="comment">     * Start any pending output.</span>
<a name="l00372"></a>00372 <span class="comment">     */</span>
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (<a class="code" href="ace_8h.html#9ea31a358cd682c9ae1ca8cff879ea40" title="Initiate output.">AceOutput</a>(dev))
<a name="l00374"></a>00374         <span class="keywordflow">return</span> -1;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="comment">/*</span>
<a name="l00377"></a>00377 <span class="comment">     * Wait until output buffer empty.</span>
<a name="l00378"></a>00378 <span class="comment">     */</span>
<a name="l00379"></a>00379     <span class="keywordflow">while</span> (ifs-&gt;if_tx_idx != ifs-&gt;if_wr_idx) {
<a name="l00380"></a>00380         <a class="code" href="group__xg_event.html#gc836d5fc78018d8d079cc9d21a2383b9" title="Wait for a new event in a specified queue.">NutEventWaitNext</a>(&amp;dcb-&gt;dcb_tx_rdy, 100);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">return</span> 0;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">/*</span>
<a name="l00387"></a>00387 <span class="comment"> *</span>
<a name="l00388"></a>00388 <span class="comment"> * \param dev Indicates the ACE device.</span>
<a name="l00389"></a>00389 <span class="comment"> *</span>
<a name="l00390"></a>00390 <span class="comment"> * \return 0 on success, -1 otherwise.</span>
<a name="l00391"></a>00391 <span class="comment"> */</span>
<a name="l00392"></a>00392 <span class="keyword">static</span> <span class="keywordtype">int</span> AceGetStatus(NUTDEVICE * dev, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> * status)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394     IFSTREAM *ifs = dev-&gt;dev_icb;
<a name="l00395"></a>00395     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> us;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397     *status = 0;
<a name="l00398"></a>00398     us = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#d4c1f998abe6306a2967c63f5a4dd391">ACE_LSR_OFS</a>);
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (us &amp; <a class="code" href="tlc16c550_8c.html#276cb8064dde258b1d1928dab7a77d37">LSR_FER_MSK</a>)
<a name="l00400"></a>00400         *status |= <a class="code" href="group__xg_a_c_e_status.html#g43a1702a3bbadca29bb45179f649f2b1" title="Framing error.">ACE_FRAMINGERROR</a>;
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (us &amp; <a class="code" href="tlc16c550_8c.html#d5377feb86a0ef9e5232ad05890aba58">LSR_OVR_MSK</a>)
<a name="l00402"></a>00402         *status |= <a class="code" href="group__xg_a_c_e_status.html#g13c2022e1bbd02fb4d3e007f788f182f" title="Overrun error.">ACE_OVERRUNERROR</a>;
<a name="l00403"></a>00403     <span class="keywordflow">if</span> (ifs-&gt;if_tx_idx == ifs-&gt;if_wr_idx)
<a name="l00404"></a>00404         *status |= <a class="code" href="group__xg_a_c_e_status.html#gae9a79853527a9388849179e440139d3" title="Transmitter buffer empty.">ACE_TXBUFFEREMPTY</a>;
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (ifs-&gt;if_rd_idx == ifs-&gt;if_rx_idx)
<a name="l00406"></a>00406         *status |= <a class="code" href="group__xg_a_c_e_status.html#g49d1c87053b3186021ee40447ba716fd" title="Receiver buffer empty.">ACE_RXBUFFEREMPTY</a>;
<a name="l00407"></a>00407     <span class="keywordflow">return</span> 0;
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="comment">/*</span>
<a name="l00411"></a>00411 <span class="comment"> * Carefully enable ACE functions.</span>
<a name="l00412"></a>00412 <span class="comment"> */</span>
<a name="l00413"></a>00413 <span class="keyword">static</span> <span class="keywordtype">void</span> AceEnable(<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> base)
<a name="l00414"></a>00414 {
<a name="l00415"></a>00415     <span class="comment">/*volatile uint8_t* pnBase = *(volatile uint8_t* )base; */</span>
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <span class="comment">/*</span>
<a name="l00418"></a>00418 <span class="comment">     * Enable ACE interrupts.</span>
<a name="l00419"></a>00419 <span class="comment">     */</span>
<a name="l00420"></a>00420     <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00421"></a>00421     *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (base + <a class="code" href="tlc16c550_8c.html#226bce7d15ab072b05a6e8388a648272">ACE_IER_OFS</a>) = <a class="code" href="tlc16c550_8c.html#387954150ca84a7c0b4ba27e7ce5496f">IER_RDA_MSK</a> | <a class="code" href="tlc16c550_8c.html#158eddf7d8c01b9553ae560cadb4826a">IER_THE_MSK</a>;
<a name="l00422"></a>00422     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="comment">/*</span>
<a name="l00426"></a>00426 <span class="comment"> * Carefully disable ACE functions.</span>
<a name="l00427"></a>00427 <span class="comment"> */</span>
<a name="l00428"></a>00428 <span class="keyword">static</span> <span class="keywordtype">void</span> AceDisable(<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> base)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430     <span class="comment">/*volatile uint8_t* pnBase = *(volatile uint8_t* )base; */</span>
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="comment">/*</span>
<a name="l00433"></a>00433 <span class="comment">     * Disable ACE interrupts.</span>
<a name="l00434"></a>00434 <span class="comment">     */</span>
<a name="l00435"></a>00435     <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00436"></a>00436     *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (base + <a class="code" href="tlc16c550_8c.html#226bce7d15ab072b05a6e8388a648272">ACE_IER_OFS</a>) &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ (<a class="code" href="tlc16c550_8c.html#387954150ca84a7c0b4ba27e7ce5496f">IER_RDA_MSK</a>);
<a name="l00437"></a>00437     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="comment">/*</span>
<a name="l00440"></a>00440 <span class="comment">     * Allow incoming or outgoing character to finish.</span>
<a name="l00441"></a>00441 <span class="comment">     */</span>
<a name="l00442"></a>00442     <a class="code" href="group__xg_timer.html#gf787dc0e6bd39a4d32f431ae11c2add3" title="Loop for a specified number of milliseconds.">NutDelay</a>(10);
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00484"></a><a class="code" href="tlc16c550_8c.html#f9013d3c9c802b73fb0bcd85614e5db0">00484</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#f9013d3c9c802b73fb0bcd85614e5db0" title="Perform ACE control functions.">AceIOCtl</a>(NUTDEVICE * dev, <span class="keywordtype">int</span> req, <span class="keywordtype">void</span> *conf)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     <span class="keywordtype">int</span> rc = 0;
<a name="l00487"></a>00487     ACEDCB *dcb;
<a name="l00488"></a>00488     IFSTREAM *ifs;
<a name="l00489"></a>00489     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *lvp = (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *) conf;
<a name="l00490"></a>00490     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> lv = *lvp;
<a name="l00491"></a>00491     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bv = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) lv;
<a name="l00492"></a>00492     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> sv;
<a name="l00493"></a>00493     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> devnum;
<a name="l00494"></a>00494     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> tv;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (dev == 0) {
<a name="l00497"></a>00497         <span class="keywordflow">return</span> -1;
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     devnum = dev-&gt;dev_base;
<a name="l00501"></a>00501     dcb = dev-&gt;dev_dcb;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="keywordflow">switch</span> (req) {
<a name="l00504"></a>00504     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g996afe0a54a9e1b74218c7b8b1750028" title="ACE _ioctl() command code to set the line speed.">ACE_SETSPEED</a>:
<a name="l00505"></a>00505         AceDisable(devnum);
<a name="l00506"></a>00506         sv = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) (<a class="code" href="group__xg_ace_driver.html#g0294736898d5cc61dbd6517e3c05c809">ACE_CLOCK</a> / (lv * 16UL));
<a name="l00507"></a>00507         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) |= <a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">LCR_ENB_MSK</a>;
<a name="l00508"></a>00508         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#7762267bb4a28176c28c0937cdfc11ca">ACE_DLL_OFS</a>) = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (sv &amp; 0xFF);
<a name="l00509"></a>00509         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#2dc62c20e1ed0b262e26852eac745f83">ACE_DLM_OFS</a>) = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (sv &gt;&gt; 8);
<a name="l00510"></a>00510         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ <a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">LCR_ENB_MSK</a>;
<a name="l00511"></a>00511 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00512"></a>00512 <span class="preprocessor"></span>        dcb-&gt;hdxByteTime = ByteOcrTime(dev);
<a name="l00513"></a>00513 <span class="preprocessor">#endif</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>        AceEnable(devnum);
<a name="l00515"></a>00515         <span class="keywordflow">break</span>;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g952104dce3da4baeda20337dd2d74e03" title="ACE _ioctl() command code to query the line speed.">ACE_GETSPEED</a>:
<a name="l00518"></a>00518         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) |= <a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">LCR_ENB_MSK</a>;
<a name="l00519"></a>00519         sv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#7762267bb4a28176c28c0937cdfc11ca">ACE_DLL_OFS</a>);
<a name="l00520"></a>00520         sv |= *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#2dc62c20e1ed0b262e26852eac745f83">ACE_DLM_OFS</a>) &lt;&lt; 8;
<a name="l00521"></a>00521         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ <a class="code" href="tlc16c550_8c.html#436f9c963a827f96b95c07ffda99981a">LCR_ENB_MSK</a>;
<a name="l00522"></a>00522         *lvp = <a class="code" href="group__xg_ace_driver.html#g0294736898d5cc61dbd6517e3c05c809">ACE_CLOCK</a> / (16UL * (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>) (sv));
<a name="l00523"></a>00523         <span class="keywordflow">break</span>;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g6bf9025bb3325a6d645ec433d2253fcf" title="ACE _ioctl() command code to set the number of data bits.">ACE_SETDATABITS</a>:
<a name="l00526"></a>00526         AceDisable(devnum);
<a name="l00527"></a>00527         <span class="keywordflow">if</span> ((bv &gt;= 5) &amp;&amp; (bv &lt;= 8)) {
<a name="l00528"></a>00528             bv -= 5;
<a name="l00529"></a>00529             tv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>);
<a name="l00530"></a>00530             tv &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ (<a class="code" href="tlc16c550_8c.html#f693c2ba3d535f69e0125309202a2a00">LCR_WS0_MSK</a> | <a class="code" href="tlc16c550_8c.html#7885e5904121e306b2874c7414c19f97">LCR_WS1_MSK</a>);
<a name="l00531"></a>00531             tv |= (bv &amp; (<a class="code" href="tlc16c550_8c.html#f693c2ba3d535f69e0125309202a2a00">LCR_WS0_MSK</a> | <a class="code" href="tlc16c550_8c.html#7885e5904121e306b2874c7414c19f97">LCR_WS1_MSK</a>));
<a name="l00532"></a>00532             *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) = tv;
<a name="l00533"></a>00533 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>            dcb-&gt;hdxByteTime = ByteOcrTime(dev);
<a name="l00535"></a>00535 <span class="preprocessor">#endif</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>        }
<a name="l00537"></a>00537         AceEnable(devnum);
<a name="l00538"></a>00538         <span class="keywordflow">break</span>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g69aaed17861f93bfa0267fd2d88169dc" title="ACE _ioctl() command code to query the number of data bits.">ACE_GETDATABITS</a>:
<a name="l00541"></a>00541         *lvp = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) &amp; (<a class="code" href="tlc16c550_8c.html#f693c2ba3d535f69e0125309202a2a00">LCR_WS0_MSK</a> | <a class="code" href="tlc16c550_8c.html#7885e5904121e306b2874c7414c19f97">LCR_WS1_MSK</a>);
<a name="l00542"></a>00542         <span class="keywordflow">break</span>;
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g612038267ad4908888c0b2dcc3f8c017" title="ACE _ioctl() command code to set the parity mode.">ACE_SETPARITY</a>:
<a name="l00545"></a>00545         AceDisable(devnum);
<a name="l00546"></a>00546         <span class="keywordflow">if</span> (bv &lt;= 4) {
<a name="l00547"></a>00547             <span class="keywordflow">switch</span> (bv) {
<a name="l00548"></a>00548             <span class="keywordflow">case</span> 1:            <span class="comment">// odd parity</span>
<a name="l00549"></a>00549                 bv = <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a>;
<a name="l00550"></a>00550                 <span class="keywordflow">break</span>;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552             <span class="keywordflow">case</span> 2:            <span class="comment">// event parity</span>
<a name="l00553"></a>00553                 bv = <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a> | <a class="code" href="tlc16c550_8c.html#b569c6dd010406c7e9540c94450ac05b">LCR_PRE_MSK</a>;
<a name="l00554"></a>00554                 <span class="keywordflow">break</span>;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556             <span class="keywordflow">case</span> 3:            <span class="comment">// space</span>
<a name="l00557"></a>00557                 bv = <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a>;
<a name="l00558"></a>00558                 <span class="keywordflow">break</span>;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560             <span class="keywordflow">case</span> 4:            <span class="comment">// mark</span>
<a name="l00561"></a>00561                 bv = <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a> | <a class="code" href="tlc16c550_8c.html#c74056375c5b8539464fdb763d68771e">LCR_PRS_MSK</a>;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563             <span class="keywordflow">default</span>:           <span class="comment">// no parity</span>
<a name="l00564"></a>00564                 bv = 0;
<a name="l00565"></a>00565                 <span class="keywordflow">break</span>;
<a name="l00566"></a>00566             }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568             tv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>);
<a name="l00569"></a>00569             tv &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ (<a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a> | <a class="code" href="tlc16c550_8c.html#b569c6dd010406c7e9540c94450ac05b">LCR_PRE_MSK</a> | <a class="code" href="tlc16c550_8c.html#c74056375c5b8539464fdb763d68771e">LCR_PRS_MSK</a>);
<a name="l00570"></a>00570             tv |= bv;
<a name="l00571"></a>00571             *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) = tv;
<a name="l00572"></a>00572 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00573"></a>00573 <span class="preprocessor"></span>            dcb-&gt;hdxByteTime = ByteOcrTime(dev);
<a name="l00574"></a>00574 <span class="preprocessor">#endif</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>        }
<a name="l00576"></a>00576         AceEnable(devnum);
<a name="l00577"></a>00577         <span class="keywordflow">break</span>;
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g20431fec4f74b4539e226e167c3195fa" title="ACE _ioctl() command code to query the parity mode.">ACE_GETPARITY</a>:
<a name="l00580"></a>00580         tv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) &amp; (<a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a> | <a class="code" href="tlc16c550_8c.html#b569c6dd010406c7e9540c94450ac05b">LCR_PRE_MSK</a> | <a class="code" href="tlc16c550_8c.html#c74056375c5b8539464fdb763d68771e">LCR_PRS_MSK</a>);
<a name="l00581"></a>00581         <span class="keywordflow">switch</span> (tv) {
<a name="l00582"></a>00582         <span class="keywordflow">case</span> 0:
<a name="l00583"></a>00583             *lvp = 0;           <span class="comment">// no parity</span>
<a name="l00584"></a>00584             <span class="keywordflow">break</span>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a>:
<a name="l00587"></a>00587             *lvp = 1;           <span class="comment">// odd parity</span>
<a name="l00588"></a>00588             <span class="keywordflow">break</span>;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a> | <a class="code" href="tlc16c550_8c.html#b569c6dd010406c7e9540c94450ac05b">LCR_PRE_MSK</a>:
<a name="l00591"></a>00591             *lvp = 2;           <span class="comment">// event parity</span>
<a name="l00592"></a>00592             <span class="keywordflow">break</span>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594         <span class="keywordflow">case</span> <a class="code" href="tlc16c550_8c.html#2aa0e69a0907adabb919bb832566f45f">LCR_PEN_MSK</a> | <a class="code" href="tlc16c550_8c.html#c74056375c5b8539464fdb763d68771e">LCR_PRS_MSK</a>:
<a name="l00595"></a>00595             *lvp = 4;           <span class="comment">// mark parity</span>
<a name="l00596"></a>00596             <span class="keywordflow">break</span>;
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598         <span class="keywordflow">break</span>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#gc19f38ccf43fe9821b9d9abe067ac250" title="ACE _ioctl() command code to set the number of stop bits.">ACE_SETSTOPBITS</a>:
<a name="l00601"></a>00601         AceDisable(devnum);
<a name="l00602"></a>00602         <span class="keywordflow">if</span> (bv == 1 || bv == 2) {
<a name="l00603"></a>00603             tv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>);
<a name="l00604"></a>00604             tv &amp;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ~ (LCR_STB_MSK);
<a name="l00605"></a>00605             tv |= (bv == 2) ? LCR_STB_MSK : 0;
<a name="l00606"></a>00606             *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>) = tv;
<a name="l00607"></a>00607 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span>            dcb-&gt;hdxByteTime = ByteOcrTime(dev);
<a name="l00609"></a>00609 <span class="preprocessor">#endif</span>
<a name="l00610"></a>00610 <span class="preprocessor"></span>        }
<a name="l00611"></a>00611         AceEnable(devnum);
<a name="l00612"></a>00612         <span class="keywordflow">break</span>;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g43652709fda42b47baa1a345f1136aed" title="ACE _ioctl() command code to query the number of stop bits.">ACE_GETSTOPBITS</a>:
<a name="l00615"></a>00615         tv = *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#0bc3da4b88f36ee2903dd88fc3ef5cbf">ACE_LCR_OFS</a>);
<a name="l00616"></a>00616         *lvp = (tv &amp; LCR_STB_MSK) ? 2 : 1;
<a name="l00617"></a>00617         <span class="keywordflow">break</span>;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#gb575a0e40a5003a1d240f99025355210" title="ACE _ioctl() command code to set the fifo mode and receive fifo trigger level.">ACE_SETFIFO</a>:
<a name="l00620"></a>00620         AceDisable(devnum);
<a name="l00621"></a>00621         dcb-&gt;dcb_wfifo = <a class="code" href="group__xg_ace_driver.html#gd02aef620ad81b4c8c2f3cd301dc4201">ACE_FIFO_SIZE</a>;
<a name="l00622"></a>00622         <span class="keywordflow">switch</span> (bv) {
<a name="l00623"></a>00623         <span class="keywordflow">case</span> 1:
<a name="l00624"></a>00624             tv = <a class="code" href="tlc16c550_8c.html#b913b6d872443246c86605c8f012bfcf">FCR_ENABLE</a> | <a class="code" href="tlc16c550_8c.html#feeb6f64a2b6cb035bb937d302e73baf">FCR_LEVEL_1</a> | <a class="code" href="tlc16c550_8c.html#dd709470c047c5f82b501dae79dd1c04">FCR_PURGE_I</a> | <a class="code" href="tlc16c550_8c.html#6d7af205d94a23925ebdf911ebf1ace3">FCR_PURGE_O</a>;
<a name="l00625"></a>00625             <span class="keywordflow">break</span>;
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <span class="keywordflow">case</span> 4:
<a name="l00628"></a>00628             tv = <a class="code" href="tlc16c550_8c.html#b913b6d872443246c86605c8f012bfcf">FCR_ENABLE</a> | <a class="code" href="tlc16c550_8c.html#03ad395c09fdeb8be2cc0bf605d62a99">FCR_LEVEL_4</a> | <a class="code" href="tlc16c550_8c.html#dd709470c047c5f82b501dae79dd1c04">FCR_PURGE_I</a> | <a class="code" href="tlc16c550_8c.html#6d7af205d94a23925ebdf911ebf1ace3">FCR_PURGE_O</a>;
<a name="l00629"></a>00629             <span class="keywordflow">break</span>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         <span class="keywordflow">case</span> 8:
<a name="l00632"></a>00632             tv = <a class="code" href="tlc16c550_8c.html#b913b6d872443246c86605c8f012bfcf">FCR_ENABLE</a> | <a class="code" href="tlc16c550_8c.html#4c0bc63c1e044c3598e52e354a57cc0e">FCR_LEVEL_8</a> | <a class="code" href="tlc16c550_8c.html#dd709470c047c5f82b501dae79dd1c04">FCR_PURGE_I</a> | <a class="code" href="tlc16c550_8c.html#6d7af205d94a23925ebdf911ebf1ace3">FCR_PURGE_O</a>;
<a name="l00633"></a>00633             <span class="keywordflow">break</span>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635         <span class="keywordflow">case</span> 14:
<a name="l00636"></a>00636             tv = <a class="code" href="tlc16c550_8c.html#b913b6d872443246c86605c8f012bfcf">FCR_ENABLE</a> | <a class="code" href="tlc16c550_8c.html#dc9f464d008fc72458e75e55fc5f59bd">FCR_LEVEL_14</a> | <a class="code" href="tlc16c550_8c.html#dd709470c047c5f82b501dae79dd1c04">FCR_PURGE_I</a> | <a class="code" href="tlc16c550_8c.html#6d7af205d94a23925ebdf911ebf1ace3">FCR_PURGE_O</a>;
<a name="l00637"></a>00637             <span class="keywordflow">break</span>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <span class="keywordflow">default</span>:
<a name="l00640"></a>00640             bv = 0;
<a name="l00641"></a>00641             tv = 0;
<a name="l00642"></a>00642             dcb-&gt;dcb_wfifo = 1;
<a name="l00643"></a>00643             <span class="keywordflow">break</span>;
<a name="l00644"></a>00644         }
<a name="l00645"></a>00645         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#889144df2c33aafc3ffb26337aafe6ff">ACE_FCR_OFS</a>) = tv;
<a name="l00646"></a>00646         <span class="comment">/* if enabling then must write the level after */</span>
<a name="l00647"></a>00647         *(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) (dev-&gt;dev_base + <a class="code" href="tlc16c550_8c.html#889144df2c33aafc3ffb26337aafe6ff">ACE_FCR_OFS</a>) = tv;
<a name="l00648"></a>00648         dcb-&gt;dcb_rfifo = bv;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <span class="comment">/* must signal any active and waiting writer, discard pending data */</span>
<a name="l00651"></a>00651         ifs = dev-&gt;dev_icb;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         ifs-&gt;if_tx_act = 0;
<a name="l00654"></a>00654         ifs-&gt;if_tx_idx = ifs-&gt;if_wr_idx;
<a name="l00655"></a>00655         <a class="code" href="group__xg_event.html#g129d2de44ddf083f252d0754fc45d9d3" title="Asynchronously post an event to a specified queue.">NutEventPostAsync</a>(&amp;(dcb-&gt;dcb_tx_rdy));
<a name="l00656"></a>00656 
<a name="l00657"></a>00657         AceEnable(devnum);
<a name="l00658"></a>00658         <span class="keywordflow">break</span>;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#gc98feb1c432c6c78d3f37e3627425261" title="ACE _ioctl() command code to query the fifo mode and receive fifo trigger level.">ACE_GETFIFO</a>:
<a name="l00661"></a>00661         *lvp = (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>) (dcb-&gt;dcb_rfifo);
<a name="l00662"></a>00662         <span class="keywordflow">break</span>;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g942c1cf86bed14762d49fd3c3d3da1b3" title="ACE _ioctl() command code to query the status.">ACE_GETSTATUS</a>:
<a name="l00665"></a>00665         AceGetStatus(dev, lvp);
<a name="l00666"></a>00666         <span class="keywordflow">break</span>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#ge959d710910700c75adf5151b7aefee4" title="ACE _ioctl() command code to set the status.">ACE_SETSTATUS</a>:
<a name="l00669"></a>00669         rc = -1;
<a name="l00670"></a>00670         <span class="keywordflow">break</span>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g63291bcfae5ffa8e33e750812b1598d5" title="ACE _ioctl() command code to set the read timeout.">ACE_SETREADTIMEOUT</a>:
<a name="l00673"></a>00673         dcb-&gt;dcb_rtimeout = lv;
<a name="l00674"></a>00674         <span class="keywordflow">break</span>;
<a name="l00675"></a>00675     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#ge8a562b7581e4ba1cdc1cd9a804225f1" title="ACE _ioctl() command code to query the read timeout.">ACE_GETREADTIMEOUT</a>:
<a name="l00676"></a>00676         *lvp = dcb-&gt;dcb_rtimeout;
<a name="l00677"></a>00677         <span class="keywordflow">break</span>;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g39d927e2c059f0d37a321dd5d55f7a2b" title="ACE _ioctl() command code to set the write timeout.">ACE_SETWRITETIMEOUT</a>:
<a name="l00680"></a>00680         dcb-&gt;dcb_wtimeout = lv;
<a name="l00681"></a>00681         <span class="keywordflow">break</span>;
<a name="l00682"></a>00682     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g25cc1f78ba2b6e08cc6bb27bf13d10be" title="ACE _ioctl() command code to query the write timeout.">ACE_GETWRITETIMEOUT</a>:
<a name="l00683"></a>00683         *lvp = dcb-&gt;dcb_wtimeout;
<a name="l00684"></a>00684         <span class="keywordflow">break</span>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g2ddce70b526796161025e5f20effe799" title="ACE _ioctl() command code to set the local echo mode.">ACE_SETLOCALECHO</a>:
<a name="l00687"></a>00687         <span class="keywordflow">if</span> (bv)
<a name="l00688"></a>00688             dcb-&gt;dcb_modeflags |= <a class="code" href="group__xg_ace_driver.html#g87ae6755addd9ec44afd39ff04552505">ACE_MF_LOCALECHO</a>;
<a name="l00689"></a>00689         <span class="keywordflow">else</span>
<a name="l00690"></a>00690             dcb-&gt;dcb_modeflags &amp;= ~<a class="code" href="group__xg_ace_driver.html#g87ae6755addd9ec44afd39ff04552505">ACE_MF_LOCALECHO</a>;
<a name="l00691"></a>00691         <span class="keywordflow">break</span>;
<a name="l00692"></a>00692     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g72846c2dd48e3053ba0239328f320507" title="ACE _ioctl() command code to query the local echo mode.">ACE_GETLOCALECHO</a>:
<a name="l00693"></a>00693         *lvp = (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#g87ae6755addd9ec44afd39ff04552505">ACE_MF_LOCALECHO</a>) ? 1 : 0;
<a name="l00694"></a>00694         <span class="keywordflow">break</span>;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g7225343a0261da294dabaedc16892b19" title="ACE _ioctl() command code to set the flow control mode.">ACE_SETFLOWCONTROL</a>:
<a name="l00697"></a>00697 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00698"></a>00698 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (lv &amp; <a class="code" href="group__xg_ace_driver.html#gbdf446f3526365f146db37874f95323d">ACE_MF_HALFDUPLEX</a>) {
<a name="l00699"></a>00699             <span class="comment">/* next transmission will use HDX pin */</span>
<a name="l00700"></a>00700             dcb-&gt;dcb_modeflags |= ACE_MF_HALFDUPLEX;
<a name="l00701"></a>00701         } <span class="keywordflow">else</span> {
<a name="l00702"></a>00702             dcb-&gt;dcb_modeflags &amp;= ~ACE_MF_HALFDUPLEX;
<a name="l00703"></a>00703         }
<a name="l00704"></a>00704         dcb-&gt;hdxOcrTime = 0;
<a name="l00705"></a>00705         <span class="comment">/* switch HDX pin off */</span>
<a name="l00706"></a>00706         ACE_HDX_RECEIVE(dev-&gt;dev_base);
<a name="l00707"></a>00707 <span class="preprocessor">#endif</span>
<a name="l00708"></a>00708 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g970cfd39a74bf327ebc518912a25716c" title="ACE _ioctl() command code to query the flow control mode.">ACE_GETFLOWCONTROL</a>:
<a name="l00711"></a>00711 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span>        *lvp = (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a>) (dcb-&gt;dcb_modeflags &amp; ACE_MF_HALFDUPLEX);
<a name="l00713"></a>00713 <span class="preprocessor">#endif</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#gafbe0dbc33375ef4784fc5d0975e475a" title="ACE _ioctl() command code to set the cooking mode.">ACE_SETCOOKEDMODE</a>:
<a name="l00717"></a>00717         <span class="keywordflow">if</span> (bv)
<a name="l00718"></a>00718             dcb-&gt;dcb_modeflags |= <a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>;
<a name="l00719"></a>00719         <span class="keywordflow">else</span>
<a name="l00720"></a>00720             dcb-&gt;dcb_modeflags &amp;= ~<a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>;
<a name="l00721"></a>00721         <span class="keywordflow">break</span>;
<a name="l00722"></a>00722     <span class="keywordflow">case</span> <a class="code" href="group__xg_ace_driver.html#g6e190d1e4faf2afd3ea48a26942408a5" title="ACE _ioctl() command code to query the cooking mode.">ACE_GETCOOKEDMODE</a>:
<a name="l00723"></a>00723         *lvp = (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>) ? 1 : 0;
<a name="l00724"></a>00724         <span class="keywordflow">break</span>;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordflow">default</span>:
<a name="l00727"></a>00727         rc = -1;
<a name="l00728"></a>00728         <span class="keywordflow">break</span>;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="keywordflow">return</span> rc;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00743"></a><a class="code" href="tlc16c550_8c.html#b2237f5f54b5050bc0f13528e9a9ac4b">00743</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#b2237f5f54b5050bc0f13528e9a9ac4b" title="Initialize on chip ACE device.">AceInit</a>(NUTDEVICE * dev)
<a name="l00744"></a>00744 {
<a name="l00745"></a>00745     IFSTREAM *ifs;
<a name="l00746"></a>00746     ACEDCB *dcb, *pFirstDcb;
<a name="l00747"></a>00747     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> baudrate = 9600;
<a name="l00748"></a>00748     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> databits = 8;
<a name="l00749"></a>00749     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> parity = 0;
<a name="l00750"></a>00750     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> stopbits = 1;
<a name="l00751"></a>00751     <a class="code" href="struct_i_r_q___h_a_n_d_l_e_r.html">IRQ_HANDLER</a> *irq;
<a name="l00752"></a>00752     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *pnPort;
<a name="l00753"></a>00753     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> nMask;
<a name="l00754"></a>00754 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span>    <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> flowcontrol = 0;
<a name="l00756"></a>00756 <span class="preprocessor">#endif</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00758"></a>00758 <span class="comment">     * We only support character devices for on-chip ACEs.</span>
<a name="l00759"></a>00759 <span class="comment">     */</span>
<a name="l00760"></a>00760     <span class="keywordflow">if</span> (dev-&gt;dev_type != <a class="code" href="group__xg_device.html#g80960504025a60666e4dd019ab1a7bf7" title="Stream device.">IFTYP_STREAM</a>) {
<a name="l00761"></a>00761         <span class="keywordflow">return</span> -1;
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="comment">/*</span>
<a name="l00765"></a>00765 <span class="comment">     * Initialize interface control block.</span>
<a name="l00766"></a>00766 <span class="comment">     */</span>
<a name="l00767"></a>00767     ifs = dev-&gt;dev_icb;
<a name="l00768"></a>00768     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ifs, 0, <span class="keyword">sizeof</span>(IFSTREAM));
<a name="l00769"></a>00769     ifs-&gt;if_input = <a class="code" href="ace_8h.html#238cbfd0bda60bd2743a177fafdb6998" title="Wait for input.">AceInput</a>;
<a name="l00770"></a>00770     ifs-&gt;if_output = <a class="code" href="ace_8h.html#9ea31a358cd682c9ae1ca8cff879ea40" title="Initiate output.">AceOutput</a>;
<a name="l00771"></a>00771     ifs-&gt;if_flush = <a class="code" href="ace_8h.html#772d16a30df7244d14ab92c1fffa8582" title="Wait for output buffer empty.">AceFlush</a>;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     <span class="comment">/*</span>
<a name="l00774"></a>00774 <span class="comment">     * Initialize driver control block.</span>
<a name="l00775"></a>00775 <span class="comment">     */</span>
<a name="l00776"></a>00776     dcb = dev-&gt;dev_dcb;
<a name="l00777"></a>00777     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(dcb, 0, <span class="keyword">sizeof</span>(ACEDCB));
<a name="l00778"></a>00778     dcb-&gt;dcb_modeflags = <a class="code" href="group__xg_ace_driver.html#g88aa2555a94224bd9225b775730bbd85">ACE_MF_NOBUFFER</a>;
<a name="l00779"></a>00779     dcb-&gt;dcb_rfifo = 0;
<a name="l00780"></a>00780     dcb-&gt;dcb_wfifo = 1;
<a name="l00781"></a>00781     dcb-&gt;dev_next = NULL;
<a name="l00782"></a>00782 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>    dcb-&gt;hdxOcrTime = 0;
<a name="l00784"></a>00784 <span class="preprocessor">#endif</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span>
<a name="l00786"></a>00786     <span class="comment">/*</span>
<a name="l00787"></a>00787 <span class="comment">     * Register interrupt handler.</span>
<a name="l00788"></a>00788 <span class="comment">     */</span>
<a name="l00789"></a>00789     <span class="keywordflow">if</span> (dev-&gt;dev_base) {
<a name="l00790"></a>00790         <span class="comment">/* if any ACE is already assigned to this interrupt */</span>
<a name="l00791"></a>00791         <span class="keywordflow">if</span> (pIrqDev[dev-&gt;dev_irq] != NULL) {
<a name="l00792"></a>00792             pFirstDcb = pIrqDev[dev-&gt;dev_irq]-&gt;dev_dcb;
<a name="l00793"></a>00793             dcb-&gt;dev_next = pFirstDcb-&gt;dev_next;
<a name="l00794"></a>00794             pFirstDcb-&gt;dev_next = dev;
<a name="l00795"></a>00795         } <span class="keywordflow">else</span> {
<a name="l00796"></a>00796 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (irqMask == 0) {
<a name="l00798"></a>00798                 <span class="comment">/* Register interrupt handlers */</span>
<a name="l00799"></a>00799                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_interrupt.html#ga459696030a9cdf621ce3df7b3ac939d" title="Register an interrupt handler.">NutRegisterIrqHandler</a>(&amp;<a class="code" href="arch_2avr_2irqreg_8h.html#f555b88959fea8540ffc0156fd4ebb0d">sig_OUTPUT_COMPARE3A</a>, AceOutComp3AInt, NULL)) {
<a name="l00800"></a>00800                     <span class="keywordflow">return</span> -1;
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802                 AceTmr3Init();
<a name="l00803"></a>00803             }
<a name="l00804"></a>00804 <span class="preprocessor">#endif</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span>            <span class="comment">// get the appropriate irq handler</span>
<a name="l00806"></a>00806             irq = (<a class="code" href="struct_i_r_q___h_a_n_d_l_e_r.html">IRQ_HANDLER</a> *) pgm_read_word(&amp;(atIrqDefs[dev-&gt;dev_irq].pvIrq));
<a name="l00807"></a>00807 
<a name="l00808"></a>00808             <span class="keywordflow">if</span> (<a class="code" href="group__xg_interrupt.html#ga459696030a9cdf621ce3df7b3ac939d" title="Register an interrupt handler.">NutRegisterIrqHandler</a>(irq, AceIrqHandler, dev)) {
<a name="l00809"></a>00809                 <span class="keywordflow">return</span> -1;
<a name="l00810"></a>00810             }
<a name="l00811"></a>00811             <span class="comment">// enable the interrupts</span>
<a name="l00812"></a>00812             pnPort = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) pgm_read_word(&amp;(atIrqDefs[dev-&gt;dev_irq].pnIrqMskPort));
<a name="l00813"></a>00813             nMask = pgm_read_byte(&amp;(atIrqDefs[dev-&gt;dev_irq].nMask));
<a name="l00814"></a>00814             *pnPort |= nMask;
<a name="l00815"></a>00815             <span class="comment">/* remember dcb of the recently initialized device */</span>
<a name="l00816"></a>00816             pIrqDev[dev-&gt;dev_irq] = dev;
<a name="l00817"></a>00817             irqMask |= 0x01 &lt;&lt; dev-&gt;dev_irq;
<a name="l00818"></a>00818         }
<a name="l00819"></a>00819     }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <span class="comment">/*</span>
<a name="l00822"></a>00822 <span class="comment">     * Set baudrate and handshake default. This will also</span>
<a name="l00823"></a>00823 <span class="comment">     * enable the ACE functions.</span>
<a name="l00824"></a>00824 <span class="comment">     */</span>
<a name="l00825"></a>00825     <a class="code" href="ace_8h.html#f9013d3c9c802b73fb0bcd85614e5db0" title="Perform ACE control functions.">AceIOCtl</a>(dev, <a class="code" href="group__xg_ace_driver.html#g996afe0a54a9e1b74218c7b8b1750028" title="ACE _ioctl() command code to set the line speed.">ACE_SETSPEED</a>, (<span class="keywordtype">void</span> *) &amp;baudrate);
<a name="l00826"></a>00826     <a class="code" href="ace_8h.html#f9013d3c9c802b73fb0bcd85614e5db0" title="Perform ACE control functions.">AceIOCtl</a>(dev, <a class="code" href="group__xg_ace_driver.html#g6bf9025bb3325a6d645ec433d2253fcf" title="ACE _ioctl() command code to set the number of data bits.">ACE_SETDATABITS</a>, (<span class="keywordtype">void</span> *) &amp;databits);
<a name="l00827"></a>00827     <a class="code" href="ace_8h.html#f9013d3c9c802b73fb0bcd85614e5db0" title="Perform ACE control functions.">AceIOCtl</a>(dev, <a class="code" href="group__xg_ace_driver.html#g612038267ad4908888c0b2dcc3f8c017" title="ACE _ioctl() command code to set the parity mode.">ACE_SETPARITY</a>, (<span class="keywordtype">void</span> *) &amp;parity);
<a name="l00828"></a>00828     <a class="code" href="ace_8h.html#f9013d3c9c802b73fb0bcd85614e5db0" title="Perform ACE control functions.">AceIOCtl</a>(dev, <a class="code" href="group__xg_ace_driver.html#gc19f38ccf43fe9821b9d9abe067ac250" title="ACE _ioctl() command code to set the number of stop bits.">ACE_SETSTOPBITS</a>, (<span class="keywordtype">void</span> *) &amp;stopbits);
<a name="l00829"></a>00829 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>    <span class="comment">/* set HDX pin off by defalt */</span>
<a name="l00831"></a>00831     <a class="code" href="ace_8h.html#f9013d3c9c802b73fb0bcd85614e5db0" title="Perform ACE control functions.">AceIOCtl</a>(dev, <a class="code" href="group__xg_ace_driver.html#g7225343a0261da294dabaedc16892b19" title="ACE _ioctl() command code to set the flow control mode.">ACE_SETFLOWCONTROL</a>, (<span class="keywordtype">void</span> *) &amp;flowcontrol);
<a name="l00832"></a>00832 <span class="preprocessor">#endif</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#f99479fff216597a9fa50b0187920509">sbi</a>(EIMSK, dev-&gt;dev_irq);   <span class="comment">/* dev-&gt;dev_irq to IRQ_INTx map should be used for a clean implementation but it looks like an overhead */</span>
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     AceEnable(dev-&gt;dev_base);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     <span class="keywordflow">return</span> 0;
<a name="l00838"></a>00838 }
<a name="l00839"></a>00839 
<a name="l00843"></a><a class="code" href="tlc16c550_8c.html#1da9f685dab8c7ab2223bc68df94b802">00843</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#1da9f685dab8c7ab2223bc68df94b802" title="Read from device.">AceRead</a>(NUTFILE * fp, <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> size)
<a name="l00844"></a>00844 {
<a name="l00845"></a>00845     <span class="keywordtype">int</span> rc;
<a name="l00846"></a>00846     NUTDEVICE *dev;
<a name="l00847"></a>00847     IFSTREAM *ifs;
<a name="l00848"></a>00848     ACEDCB *dcb;
<a name="l00849"></a>00849     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> elmode;
<a name="l00850"></a>00850     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ch;
<a name="l00851"></a>00851     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *cp = buffer;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     dev = fp-&gt;nf_dev;
<a name="l00854"></a>00854     ifs = (IFSTREAM *) dev-&gt;dev_icb;
<a name="l00855"></a>00855     dcb = dev-&gt;dev_dcb;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     if (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>)
<a name="l00858"></a>00858         elmode = 1;
<a name="l00859"></a>00859     <span class="keywordflow">else</span>
<a name="l00860"></a>00860         elmode = 0;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     <span class="comment">/*</span>
<a name="l00863"></a>00863 <span class="comment">     * Call without data pointer discards receive buffer.</span>
<a name="l00864"></a>00864 <span class="comment">     */</span>
<a name="l00865"></a>00865     <span class="keywordflow">if</span> (buffer == 0) {
<a name="l00866"></a>00866         ifs-&gt;if_rd_idx = ifs-&gt;if_rx_idx;
<a name="l00867"></a>00867         <span class="keywordflow">return</span> 0;
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     <span class="comment">/*</span>
<a name="l00871"></a>00871 <span class="comment">     * Get characters from receive buffer.</span>
<a name="l00872"></a>00872 <span class="comment">     */</span>
<a name="l00873"></a>00873     <span class="keywordflow">for</span> (rc = 0; rc &lt; size;) {
<a name="l00874"></a>00874         <span class="comment">/* if nothing has been received yet */</span>
<a name="l00875"></a>00875         <span class="keywordflow">if</span> (ifs-&gt;if_rd_idx == ifs-&gt;if_rx_idx) {
<a name="l00876"></a>00876             <span class="comment">/* while incomming buffer is empty */</span>
<a name="l00877"></a>00877             <span class="keywordflow">while</span> (ifs-&gt;if_rd_idx == ifs-&gt;if_rx_idx) {
<a name="l00878"></a>00878                 <span class="comment">/* wait (timeout) for incomming data */</span>
<a name="l00879"></a>00879                 <span class="keywordflow">if</span> (<a class="code" href="ace_8h.html#238cbfd0bda60bd2743a177fafdb6998" title="Wait for input.">AceInput</a>(dev)) {
<a name="l00880"></a>00880                     <span class="comment">/* if a timeout */</span>
<a name="l00881"></a>00881                     <span class="keywordflow">return</span> 0;
<a name="l00882"></a>00882                 }
<a name="l00883"></a>00883             }
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885         ch = ifs-&gt;if_rx_buf[ifs-&gt;if_rd_idx++];
<a name="l00886"></a>00886         <span class="keywordflow">if</span> (elmode &amp;&amp; (ch == <span class="charliteral">'\r'</span> || ch == <span class="charliteral">'\n'</span>)) {
<a name="l00887"></a>00887             <span class="keywordflow">if</span> ((ifs-&gt;if_last_eol == 0) || (ifs-&gt;if_last_eol == ch)) {
<a name="l00888"></a>00888                 ifs-&gt;if_last_eol = ch;
<a name="l00889"></a>00889                 *cp++ = <span class="charliteral">'\n'</span>;
<a name="l00890"></a>00890                 rc++;
<a name="l00891"></a>00891             }
<a name="l00892"></a>00892         } <span class="keywordflow">else</span> {
<a name="l00893"></a>00893             ifs-&gt;if_last_eol = 0;
<a name="l00894"></a>00894             *cp++ = ch;
<a name="l00895"></a>00895             rc++;
<a name="l00896"></a>00896         }
<a name="l00897"></a>00897     }
<a name="l00898"></a>00898     <span class="keywordflow">return</span> rc;
<a name="l00899"></a>00899 }
<a name="l00900"></a>00900 
<a name="l00904"></a><a class="code" href="tlc16c550_8c.html#2d496be10664ac7257bb8959190a6856">00904</a> <span class="keywordtype">int</span> <a class="code" href="tlc16c550_8c.html#2d496be10664ac7257bb8959190a6856" title="Write to device.">AcePut</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> pflg)
<a name="l00905"></a>00905 {
<a name="l00906"></a>00906     <span class="keywordtype">int</span> rc;
<a name="l00907"></a>00907     IFSTREAM *ifs;
<a name="l00908"></a>00908     ACEDCB *dcb;
<a name="l00909"></a>00909     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *cp;
<a name="l00910"></a>00910     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> lbmode;
<a name="l00911"></a>00911     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> elmode;
<a name="l00912"></a>00912     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ch;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914     ifs = dev-&gt;dev_icb;
<a name="l00915"></a>00915     dcb = dev-&gt;dev_dcb;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <span class="keywordflow">if</span> (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#g717f217cbface19c82e50576b6c01e7f">ACE_MF_LINEBUFFER</a>)
<a name="l00918"></a>00918         lbmode = 1;
<a name="l00919"></a>00919     <span class="keywordflow">else</span>
<a name="l00920"></a>00920         lbmode = 0;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="keywordflow">if</span> (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>)
<a name="l00923"></a>00923         elmode = 1;
<a name="l00924"></a>00924     <span class="keywordflow">else</span>
<a name="l00925"></a>00925         elmode = 0;
<a name="l00926"></a>00926 
<a name="l00927"></a>00927     <span class="comment">/*</span>
<a name="l00928"></a>00928 <span class="comment">     * Call without data pointer starts transmission.</span>
<a name="l00929"></a>00929 <span class="comment">     */</span>
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (buffer == 0) {
<a name="l00931"></a>00931         rc = <a class="code" href="ace_8h.html#772d16a30df7244d14ab92c1fffa8582" title="Wait for output buffer empty.">AceFlush</a>(dev);
<a name="l00932"></a>00932         <span class="keywordflow">return</span> rc;
<a name="l00933"></a>00933     }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="comment">/*</span>
<a name="l00936"></a>00936 <span class="comment">     * Put characters in transmit buffer.</span>
<a name="l00937"></a>00937 <span class="comment">     */</span>
<a name="l00938"></a>00938     cp = buffer;
<a name="l00939"></a>00939     <span class="keywordflow">for</span> (rc = 0; rc &lt; len;) {
<a name="l00940"></a>00940         <span class="keywordflow">if</span> ((<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ifs-&gt;if_wr_idx + 1) == ifs-&gt;if_tx_idx) {
<a name="l00941"></a>00941             <span class="keywordflow">if</span> (<a class="code" href="ace_8h.html#772d16a30df7244d14ab92c1fffa8582" title="Wait for output buffer empty.">AceFlush</a>(dev)) {
<a name="l00942"></a>00942                 <span class="keywordflow">return</span> -1;
<a name="l00943"></a>00943             }
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945         ch = pflg ? <a class="code" href="arm_8h.html#0af779eb78b696dfcb017dc9be5f6d14">PRG_RDB</a>(cp) : *cp;
<a name="l00946"></a>00946         <span class="keywordflow">if</span> (elmode == 1 &amp;&amp; ch == <span class="charliteral">'\n'</span>) {
<a name="l00947"></a>00947             elmode = 2;
<a name="l00948"></a>00948             <span class="keywordflow">if</span> (lbmode == 1)
<a name="l00949"></a>00949                 lbmode = 2;
<a name="l00950"></a>00950             ch = <span class="charliteral">'\r'</span>;
<a name="l00951"></a>00951         } <span class="keywordflow">else</span> {
<a name="l00952"></a>00952             <span class="keywordflow">if</span> (elmode == 2)
<a name="l00953"></a>00953                 elmode = 1;
<a name="l00954"></a>00954             cp++;
<a name="l00955"></a>00955             rc++;
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957         ifs-&gt;if_tx_buf[ifs-&gt;if_wr_idx++] = ch;
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960     <span class="keywordflow">if</span> (lbmode &gt; 1 || (dcb-&gt;dcb_modeflags &amp; <a class="code" href="group__xg_ace_driver.html#g88aa2555a94224bd9225b775730bbd85">ACE_MF_NOBUFFER</a>) != 0) {
<a name="l00961"></a>00961         <span class="keywordflow">if</span> (<a class="code" href="ace_8h.html#772d16a30df7244d14ab92c1fffa8582" title="Wait for output buffer empty.">AceFlush</a>(dev))
<a name="l00962"></a>00962             rc = -1;
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964     <span class="keywordflow">return</span> rc;
<a name="l00965"></a>00965 }
<a name="l00966"></a>00966 
<a name="l00967"></a><a class="code" href="tlc16c550_8c.html#0c74b38b0dad7da03a28ff3d632fe8a1">00967</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#0c74b38b0dad7da03a28ff3d632fe8a1">AceWrite</a>(NUTFILE * fp, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *buffer, <span class="keywordtype">int</span> len)
<a name="l00968"></a>00968 {
<a name="l00969"></a>00969     <span class="keywordflow">return</span> <a class="code" href="tlc16c550_8c.html#2d496be10664ac7257bb8959190a6856" title="Write to device.">AcePut</a>(fp-&gt;nf_dev, buffer, len, 0);
<a name="l00970"></a>00970 }
<a name="l00971"></a>00971 
<a name="l00972"></a><a class="code" href="tlc16c550_8c.html#f1e48d81fd949df41be26b34990aacef">00972</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#f1e48d81fd949df41be26b34990aacef">AceWrite_P</a>(NUTFILE * fp, <a class="code" href="arm_8h.html#963f816fc88a5d8479c285ed4c630229">PGM_P</a> buffer, <span class="keywordtype">int</span> len)
<a name="l00973"></a>00973 {
<a name="l00974"></a>00974     <span class="keywordflow">return</span> <a class="code" href="tlc16c550_8c.html#2d496be10664ac7257bb8959190a6856" title="Write to device.">AcePut</a>(fp-&gt;nf_dev, (<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *) buffer, len, 1);
<a name="l00975"></a>00975 }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 
<a name="l00981"></a><a class="code" href="tlc16c550_8c.html#812e3d165a67080e5cff30ca3cfc0553">00981</a> NUTFILE *<a class="code" href="ace_8h.html#812e3d165a67080e5cff30ca3cfc0553" title="Open a device or file.">AceOpen</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> acc)
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983     NUTFILE *fp = <a class="code" href="heap_8h.html#1506e015e92a840d260b05a41df28fcc">NutHeapAlloc</a>(<span class="keyword">sizeof</span>(NUTFILE));
<a name="l00984"></a>00984     ACEDCB *dcb;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986     <span class="keywordflow">if</span> (fp == 0)
<a name="l00987"></a>00987         <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     dcb = dev-&gt;dev_dcb;
<a name="l00990"></a>00990     <span class="keywordflow">if</span> (mode &amp; <a class="code" href="group__xg_crt_lowio.html#g166a079a4990ddeb0a32475728bbacd0">_O_BINARY</a>)
<a name="l00991"></a>00991         dcb-&gt;dcb_modeflags &amp;= ~<a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>;
<a name="l00992"></a>00992     <span class="keywordflow">else</span>
<a name="l00993"></a>00993         dcb-&gt;dcb_modeflags |= <a class="code" href="group__xg_ace_driver.html#g6f542f348a87e7f7a2233197d2c4a7fd">ACE_MF_COOKEDMODE</a>;
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     fp-&gt;nf_next = 0;
<a name="l00996"></a>00996     fp-&gt;nf_dev = dev;
<a name="l00997"></a>00997     fp-&gt;nf_fcb = 0;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999     <span class="keywordflow">return</span> fp;
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01005"></a><a class="code" href="tlc16c550_8c.html#774c9a429c74e80a713b68edf539af2b">01005</a> <span class="keywordtype">int</span> <a class="code" href="ace_8h.html#774c9a429c74e80a713b68edf539af2b" title="Close a device or file.">AceClose</a>(NUTFILE * fp)
<a name="l01006"></a>01006 {
<a name="l01007"></a>01007     <a class="code" href="heap_8h.html#b275544ee60e3ed63b5d08adba8fa265">NutHeapFree</a>(fp);
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     <span class="keywordflow">return</span> 0;
<a name="l01010"></a>01010 }
<a name="l01011"></a>01011 
<a name="l01015"></a><a class="code" href="tlc16c550_8c.html#51b0a3e059dc18676d3884d388280c5c">01015</a> <span class="keywordtype">long</span> <a class="code" href="ace_8h.html#51b0a3e059dc18676d3884d388280c5c" title="Request file size.">AceSize</a>(NUTFILE * fp)
<a name="l01016"></a>01016 {
<a name="l01017"></a>01017     NUTDEVICE *dev;
<a name="l01018"></a>01018     IFSTREAM *ifs;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     dev = fp-&gt;nf_dev;
<a name="l01021"></a>01021     ifs = (IFSTREAM *) dev-&gt;dev_icb;
<a name="l01022"></a>01022     return ((<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ifs-&gt;if_rx_idx - ifs-&gt;if_rd_idx));
<a name="l01023"></a>01023 }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025 <span class="preprocessor">#ifdef ACE_HDX_LINE</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> AceTmr3Init(<span class="keywordtype">void</span>)
<a name="l01027"></a>01027 {
<a name="l01028"></a>01028     <span class="comment">/* TMR3 also runs in normal mode */</span>
<a name="l01029"></a>01029     TCCR3A &amp;= ~(<a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(COM3A1) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(COM3A0) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(WGM31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(WGM30));   <span class="comment">/* normal mode */</span>
<a name="l01030"></a>01030 
<a name="l01031"></a>01031     TCCR3B &amp;= ~(<a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(WGM33) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(WGM32) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS32) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS30));
<a name="l01032"></a>01032     TCCR3B |= <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS30);    <span class="comment">/* f/64 (155200Hz - 1.75Hz) */</span>
<a name="l01033"></a>01033 
<a name="l01034"></a>01034     <span class="comment">/* TMR3 output compare A match interrupt disable */</span>
<a name="l01035"></a>01035     ETIMSK &amp;= ~<a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(OCIE3A);
<a name="l01036"></a>01036 }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 <span class="keyword">static</span> <span class="keywordtype">void</span> AceOutComp3AInt(<span class="keywordtype">void</span> *arg)
<a name="l01039"></a>01039 {
<a name="l01040"></a>01040     NUTDEVICE *dev;
<a name="l01041"></a>01041     ACEDCB *dcb;
<a name="l01042"></a>01042     <span class="keywordtype">int</span> i;
<a name="l01043"></a>01043     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nextOcr = 0xffff, ocr;
<a name="l01044"></a>01044     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timerOcrDiff;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046     <span class="comment">/* TMR3 stop counting */</span>
<a name="l01047"></a>01047     TCCR3B &amp;= ~(<a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS30));
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     timerOcrDiff = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )TCNT3 - (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )OCR3A);
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <span class="comment">/* Due to interrupt nesting and as TL interrupts are higher priority - disable them.</span>
<a name="l01052"></a>01052 <span class="comment">     * This routine cannot be interrupted by a cal to the AceAddHdxTime()</span>
<a name="l01053"></a>01053 <span class="comment">     */</span>
<a name="l01054"></a>01054     EIMSK &amp;= ~irqMask;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     <span class="keywordflow">for</span> (i = 0; i &lt; 8; ++i) {
<a name="l01057"></a>01057         <span class="keywordflow">for</span> (dev = pIrqDev[i]; dev != NULL; dev = dcb-&gt;dev_next) {
<a name="l01058"></a>01058             dcb = dev-&gt;dev_dcb;
<a name="l01059"></a>01059             <span class="comment">/* only if enabled */</span>
<a name="l01060"></a>01060             <span class="keywordflow">if</span> (dcb-&gt;hdxOcrTime != 0) {
<a name="l01061"></a>01061                 <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )(dcb-&gt;hdxOcrTime - (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )OCR3A) &lt;= timerOcrDiff) {
<a name="l01062"></a>01062                     dcb-&gt;hdxOcrTime = 0;
<a name="l01063"></a>01063                     ACE_HDX_RECEIVE(dev-&gt;dev_base);
<a name="l01064"></a>01064                 } <span class="keywordflow">else</span> {
<a name="l01065"></a>01065                     ocr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )(dcb-&gt;hdxOcrTime - (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )TCNT3);
<a name="l01066"></a>01066                     <span class="keywordflow">if</span> (ocr &lt; nextOcr) {
<a name="l01067"></a>01067                         nextOcr = ocr;
<a name="l01068"></a>01068                     }
<a name="l01069"></a>01069                 }
<a name="l01070"></a>01070             }
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (nextOcr == 0xffff) {
<a name="l01075"></a>01075         <span class="comment">/* TMR3 output compare A match interrupt disable */</span>
<a name="l01076"></a>01076         ETIMSK &amp;= ~<a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(OCIE3A);
<a name="l01077"></a>01077     } <span class="keywordflow">else</span> {
<a name="l01078"></a>01078         OCR3A = nextOcr;
<a name="l01079"></a>01079         <span class="comment">/* start timer */</span>
<a name="l01080"></a>01080         TCCR3B |= <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS30);        <span class="comment">/* f/64 (155200Hz - 1.75Hz) */</span>
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <span class="comment">/* Re-enable TL interrupt. */</span>
<a name="l01084"></a>01084     EIMSK |= irqMask;
<a name="l01085"></a>01085 }
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 <span class="keyword">static</span> <span class="keywordtype">void</span> AceAddHdxTime(ACEDCB * dcb)
<a name="l01088"></a>01088 {
<a name="l01089"></a>01089     <span class="comment">/* TMR3 stop counting */</span>
<a name="l01090"></a>01090     TCCR3B &amp;= ~(<a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS30));
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     <span class="comment">/* if disabled */</span>
<a name="l01093"></a>01093     <span class="keywordflow">if</span> ((ETIMSK &amp; <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(OCIE3A)) == 0) {
<a name="l01094"></a>01094         <span class="comment">/* initialize */</span>
<a name="l01095"></a>01095         OCR3A = 0;
<a name="l01096"></a>01096         TCNT3 = 1;
<a name="l01097"></a>01097     }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099     <span class="comment">/* set offset from current counter value */</span>
<a name="l01100"></a>01100     dcb-&gt;hdxOcrTime = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )TCNT3 + dcb-&gt;hdxByteTime);
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     <span class="keywordflow">if</span> (dcb-&gt;hdxOcrTime == 0) {
<a name="l01103"></a>01103         dcb-&gt;hdxOcrTime = 1;    <span class="comment">/* 0 means disabled, one bit delay is not a problem as there is interrupt latency anyway */</span>
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <span class="keywordflow">if</span> (dcb-&gt;hdxByteTime &lt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )OCR3A - (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* modulo max */</span> )TCNT3)) {
<a name="l01107"></a>01107         OCR3A = dcb-&gt;hdxOcrTime;
<a name="l01108"></a>01108     }
<a name="l01109"></a>01109     <span class="comment">/* TMR3 output compare A match interrupt enable */</span>
<a name="l01110"></a>01110     ETIMSK |= <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(OCIE3A);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <span class="comment">/* start timer */</span>
<a name="l01113"></a>01113     TCCR3B |= <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS31) | <a class="code" href="arm_8h.html#11643f271076024c395a93800b3d9546">_BV</a>(CS30);    <span class="comment">/* f/64 (155200Hz - 1.75Hz) */</span>
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 <span class="preprocessor">#endif</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
