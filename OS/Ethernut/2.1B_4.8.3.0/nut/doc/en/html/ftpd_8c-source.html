<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_70d8cf967ca8ef90744839cf4a057d4a.html">pro</a>
  </div>
<div class="contents">
<h1>ftpd.c</h1><a href="ftpd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2005 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 
<a name="l00085"></a>00085 <span class="preprocessor">#include &lt;<a class="code" href="version_8h.html">sys/version.h</a>&gt;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html" title="UDP and TCP socket interface definitions.">sys/socket.h</a>&gt;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &lt;<a class="code" href="netinet_2tcp_8h.html" title="TCP protocol definitions.">netinet/tcp.h</a>&gt;</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &lt;<a class="code" href="stat_8h.html" title="File system status declarations.">sys/stat.h</a>&gt;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#include &lt;<a class="code" href="dirent_8h.html" title="Filesystem directory structure.">dirent.h</a>&gt;</span>
<a name="l00097"></a>00097 <span class="preprocessor">#include &lt;<a class="code" href="unistd_8h.html" title="Miscellaneous function declarations.">unistd.h</a>&gt;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="preprocessor">#include &lt;<a class="code" href="ftpd_8h.html" title="FTP protocol definitions for daemons.">pro/ftpd.h</a>&gt;</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#endif</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>
<a name="l00112"></a>00112 
<a name="l00119"></a>00119 
<a name="l00125"></a>00125 <span class="preprocessor">#ifndef FTP_ROOTPATH</span>
<a name="l00126"></a><a class="code" href="group__xg_f_t_p_d.html#g7c5a64c63f20eb3e3ebab183895a8081">00126</a> <span class="preprocessor"></span><span class="preprocessor">#define FTP_ROOTPATH "PNUT:"</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>
<a name="l00134"></a>00134 <span class="preprocessor">#ifndef FTP_DATA_PORT</span>
<a name="l00135"></a><a class="code" href="group__xg_f_t_p_d.html#g972c1b4b37ca75e1e499e91617a3e40b">00135</a> <span class="preprocessor"></span><span class="preprocessor">#define FTP_DATA_PORT   20</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>
<a name="l00140"></a>00140 <span class="keyword">static</span> <span class="keywordtype">char</span> *ftp_root;
<a name="l00141"></a>00141 <span class="keyword">static</span> <span class="keywordtype">char</span> *ftp_user;
<a name="l00142"></a>00142 <span class="keyword">static</span> <span class="keywordtype">char</span> *ftp_pass;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="comment">/*</span>
<a name="l00145"></a>00145 <span class="comment"> * On Harvard architectures constant strings are stored in ROM, </span>
<a name="l00146"></a>00146 <span class="comment"> * because RAM is usually a scarce resource on these platforms.</span>
<a name="l00147"></a>00147 <span class="comment"> */</span>
<a name="l00148"></a>00148 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_cwd_P[] = <span class="stringliteral">"CWD"</span>;
<a name="l00149"></a>00149 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_dele_P[] = <span class="stringliteral">"DELE"</span>;
<a name="l00150"></a>00150 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_list_P[] = <span class="stringliteral">"LIST"</span>;
<a name="l00151"></a>00151 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_mkd_P[] = <span class="stringliteral">"MKD"</span>;
<a name="l00152"></a>00152 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_xmkd_P[] = <span class="stringliteral">"XMKD"</span>;
<a name="l00153"></a>00153 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_nlst_P[] = <span class="stringliteral">"NLST"</span>;
<a name="l00154"></a>00154 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_noop_P[] = <span class="stringliteral">"NOOP"</span>;
<a name="l00155"></a>00155 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_pass_P[] = <span class="stringliteral">"PASS"</span>;
<a name="l00156"></a>00156 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_pasv_P[] = <span class="stringliteral">"PASV"</span>;
<a name="l00157"></a>00157 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_port_P[] = <span class="stringliteral">"PORT"</span>;
<a name="l00158"></a>00158 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_pwd_P[] = <span class="stringliteral">"PWD"</span>;
<a name="l00159"></a>00159 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_xpwd_P[] = <span class="stringliteral">"XPWD"</span>;
<a name="l00160"></a>00160 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_quit_P[] = <span class="stringliteral">"QUIT"</span>;
<a name="l00161"></a>00161 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_retr_P[] = <span class="stringliteral">"RETR"</span>;
<a name="l00162"></a>00162 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_rmd_P[] = <span class="stringliteral">"RMD"</span>;
<a name="l00163"></a>00163 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_xrmd_P[] = <span class="stringliteral">"XRMD"</span>;
<a name="l00164"></a>00164 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_stor_P[] = <span class="stringliteral">"STOR"</span>;
<a name="l00165"></a>00165 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_syst_P[] = <span class="stringliteral">"SYST"</span>;
<a name="l00166"></a>00166 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_type_P[] = <span class="stringliteral">"TYPE"</span>;
<a name="l00167"></a>00167 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_user_P[] = <span class="stringliteral">"USER"</span>;
<a name="l00168"></a>00168 
<a name="l00169"></a>00169 <span class="keyword">static</span> <span class="keywordtype">char</span> *mon_name = <span class="stringliteral">"JanFebMarAprMayJunJulAugSepOctNovDec"</span>;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> rep_banner[] = <span class="stringliteral">"220 Nut/OS FTP %s ready at %.3s%3d %02d:%02d:%02d\r\n"</span>;
<a name="l00172"></a>00172 
<a name="l00185"></a>00185 <span class="keyword">static</span> <span class="keywordtype">void</span> SplitCmdArg(<span class="keywordtype">char</span> * line, <span class="keywordtype">char</span> ** cmd, <span class="keywordtype">char</span> ** args)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187     <span class="comment">/* Skip leading spaces. */</span>
<a name="l00188"></a>00188     <span class="keywordflow">while</span> (*line &amp;&amp; *line &lt;= <span class="charliteral">' '</span>) {
<a name="l00189"></a>00189         line++;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="comment">/* The first word is the command. Convert it to upper case. */</span>
<a name="l00193"></a>00193     *cmd = line;
<a name="l00194"></a>00194     <span class="keywordflow">while</span> (*line &gt; <span class="charliteral">' '</span>) {
<a name="l00195"></a>00195         <span class="keywordflow">if</span> (*line &gt;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <span class="charliteral">'a'</span> &amp;&amp; *line &lt;= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <span class="charliteral">'z'</span>) {
<a name="l00196"></a>00196             *line -= (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <span class="charliteral">'a'</span> - <span class="charliteral">'A'</span>;
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198         line++;
<a name="l00199"></a>00199     }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="comment">/* Mark end of the command word. */</span>
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (*line) {
<a name="l00203"></a>00203         *line++ = <span class="charliteral">'\0'</span>;
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">/* Skip spaces. */</span>
<a name="l00207"></a>00207     <span class="keywordflow">while</span> (*line &amp;&amp; *line &lt;= <span class="charliteral">' '</span>) {
<a name="l00208"></a>00208         ++line;
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">/* Arguments start here. */</span>
<a name="l00212"></a>00212     *args = line;
<a name="l00213"></a>00213     <span class="keywordflow">while</span> (*line &amp;&amp; *line != <span class="charliteral">'\r'</span> &amp;&amp; *line != <span class="charliteral">'\n'</span>) {
<a name="l00214"></a>00214         line++;
<a name="l00215"></a>00215     }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="comment">/* Mark end of arguments. */</span>
<a name="l00218"></a>00218     *line = 0;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00236"></a>00236 <span class="keyword">static</span> <span class="keywordtype">int</span> ParseIpPort(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> * arg, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> * <a class="code" href="structip.html" title="Structure of an internet header.">ip</a>, <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> * port)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238     <span class="keywordtype">int</span> rc;
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     *ip = 0;
<a name="l00241"></a>00241     *port = 0;
<a name="l00242"></a>00242     <span class="keywordflow">for</span> (rc = 0; rc &lt; 6; rc++) {
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (*arg &lt; '0' || *arg &gt; <span class="charliteral">'9'</span>) {
<a name="l00244"></a>00244             <span class="keywordflow">break</span>;
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246         <span class="keywordflow">if</span> (rc &lt; 4) {
<a name="l00247"></a>00247             *ip &gt;&gt;= 8;
<a name="l00248"></a>00248             *ip += <a class="code" href="group__xg_crt_std_lib.html#g609881e6043f1810014e7c3333639e61" title="Convert string to long integer.">atol</a>(arg) &lt;&lt; 24;
<a name="l00249"></a>00249         } <span class="keywordflow">else</span> {
<a name="l00250"></a>00250             *port &lt;&lt;= 8;
<a name="l00251"></a>00251             *port += <a class="code" href="group__xg_crt_std_lib.html#g21f1bd8c533a44073a5b9f1a0a1f9fac" title="Convert string to integer.">atoi</a>(arg);
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         <span class="keywordflow">while</span> (*arg &amp;&amp; *arg != <span class="charliteral">','</span>) {
<a name="l00254"></a>00254             arg++;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256         <span class="keywordflow">if</span> (*arg == <span class="charliteral">','</span>) {
<a name="l00257"></a>00257             arg++;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260     <span class="keywordflow">return</span> rc;
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00272"></a><a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de">00272</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">int</span> code)
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274     <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> fmt_P[] = <span class="stringliteral">"%d OK\r\n"</span>;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&lt;'%d OK' "</span>, code);
<a name="l00278"></a>00278 <span class="preprocessor">#endif</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, fmt_P, code);
<a name="l00280"></a>00280     <a class="code" href="group__xg_crt_stdio.html#gdb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282     <span class="keywordflow">return</span> 0;
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00294"></a><a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632">00294</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">int</span> code)
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296     <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> fmt_P[] = <span class="stringliteral">"%d Failed\r\n"</span>;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&lt;'%d Failed' "</span>, code);
<a name="l00300"></a>00300 <span class="preprocessor">#endif</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, fmt_P, code);
<a name="l00302"></a>00302     <a class="code" href="group__xg_crt_stdio.html#gdb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00303"></a>00303 
<a name="l00304"></a>00304     <span class="keywordflow">return</span> 0;
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00316"></a><a class="code" href="group__xg_f_t_p_d.html#g7a2c08102e2c52355561453fcb15eb5e">00316</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g7a2c08102e2c52355561453fcb15eb5e" title="Send a response including the specified transfer mode.">NutFtpSendMode</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">int</span> binary)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> intro_P[] = <span class="stringliteral">"150 Opening "</span>;
<a name="l00319"></a>00319     <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> amode_P[] = <span class="stringliteral">"ASCII.\r\n"</span>;
<a name="l00320"></a>00320     <span class="keyword">static</span> <a class="code" href="arm_8h.html#950231ac87ca08b098da30dc1b065c14">prog_char</a> bmode_P[] = <span class="stringliteral">"BINARY.\r\n"</span>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&lt;'150 Opening %s' "</span>, binary ? <span class="stringliteral">"BINARY"</span> : <span class="stringliteral">"ASCII"</span>);
<a name="l00324"></a>00324 <span class="preprocessor">#endif</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#a972577646c6e64c54658f123a8044c8">fputs_P</a>(intro_P, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00326"></a>00326     <a class="code" href="h8_8h.html#a972577646c6e64c54658f123a8044c8">fputs_P</a>(binary ? bmode_P : amode_P, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00327"></a>00327     <a class="code" href="group__xg_crt_stdio.html#gdb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="keywordflow">return</span> 0;
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00352"></a><a class="code" href="group__xg_f_t_p_d.html#gad7b7118c7f21feb01fc6db7b8b0e615">00352</a> <span class="keywordtype">char</span> *<a class="code" href="group__xg_f_t_p_d.html#gad7b7118c7f21feb01fc6db7b8b0e615" title="Create an absolute path name.">CreateFullPathName</a>(<span class="keywordtype">char</span> *root, <span class="keywordtype">char</span> *work, <span class="keywordtype">char</span> *path)
<a name="l00353"></a>00353 {
<a name="l00354"></a>00354     <span class="keywordtype">char</span> *full;
<a name="l00355"></a>00355     <span class="keywordtype">char</span> *cp;
<a name="l00356"></a>00356     <span class="keywordtype">size_t</span> rl = root ? <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(root) : 0;
<a name="l00357"></a>00357     <span class="keywordtype">size_t</span> wl = work ? <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(work) : 0;
<a name="l00358"></a>00358     <span class="keywordtype">size_t</span> pl = path ? <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(path) : 0;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="comment">/* Ignore trailing slashes in root and work. */</span>
<a name="l00361"></a>00361     <span class="keywordflow">if</span> (rl &amp;&amp; *(root + rl - 1) == <span class="charliteral">'/'</span>) {
<a name="l00362"></a>00362         rl--;
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364     <span class="keywordflow">if</span> (wl &amp;&amp; *(work + wl - 1) == <span class="charliteral">'/'</span>) {
<a name="l00365"></a>00365         wl--;
<a name="l00366"></a>00366     }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     <span class="keywordflow">if</span> ((full = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(rl + wl + pl + 3)) != NULL) {
<a name="l00369"></a>00369         <span class="comment">/* Put the root in front. */</span>
<a name="l00370"></a>00370         cp = full;
<a name="l00371"></a>00371         <span class="keywordflow">if</span> (rl) {
<a name="l00372"></a>00372             cp = <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(full, root) + rl;
<a name="l00373"></a>00373         }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="comment">/* If path is relative, prepend the working directory. */</span>
<a name="l00376"></a>00376         <span class="keywordflow">if</span>(pl == 0 || *path != <span class="charliteral">'/'</span>) {
<a name="l00377"></a>00377             <span class="keywordflow">if</span> (wl) {
<a name="l00378"></a>00378                 <span class="keywordflow">if</span> (*work != <span class="charliteral">'/'</span>) {
<a name="l00379"></a>00379                     *cp++ = <span class="charliteral">'/'</span>;
<a name="l00380"></a>00380                 }
<a name="l00381"></a>00381                 cp = <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(cp, work) + wl;
<a name="l00382"></a>00382             }
<a name="l00383"></a>00383             *cp++ = <span class="charliteral">'/'</span>;
<a name="l00384"></a>00384             rl++;
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (pl) {
<a name="l00388"></a>00388             *cp = 0;
<a name="l00389"></a>00389             work = full + rl;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391             <span class="keywordflow">while</span> (*path) {
<a name="l00392"></a>00392                 <span class="comment">/* Ingore duplicate slashes. */</span>
<a name="l00393"></a>00393                 <span class="keywordflow">if</span> (*path == <span class="charliteral">'/'</span>) {
<a name="l00394"></a>00394                     *cp++ = *path++;
<a name="l00395"></a>00395                     <span class="keywordflow">while</span> (*path == <span class="charliteral">'/'</span>) {
<a name="l00396"></a>00396                         path++;
<a name="l00397"></a>00397                     }
<a name="l00398"></a>00398                 }
<a name="l00399"></a>00399                 <span class="comment">/* Ignore single dots. */</span>
<a name="l00400"></a>00400                 <span class="keywordflow">if</span> (*path == <span class="charliteral">'.'</span>) {
<a name="l00401"></a>00401                     path++;
<a name="l00402"></a>00402                     <span class="keywordflow">if</span> (*path == <span class="charliteral">'/'</span>) {
<a name="l00403"></a>00403                         path++;
<a name="l00404"></a>00404                         <span class="keywordflow">continue</span>;
<a name="l00405"></a>00405                     }
<a name="l00406"></a>00406                     <span class="keywordflow">if</span> (*path == 0) {
<a name="l00407"></a>00407                         <span class="keywordflow">break</span>;
<a name="l00408"></a>00408                     }
<a name="l00409"></a>00409                     <span class="keywordflow">if</span> (*path == <span class="charliteral">'.'</span>) {
<a name="l00410"></a>00410                         path++;
<a name="l00411"></a>00411                         <span class="keywordflow">if</span> (*path == <span class="charliteral">'/'</span> || *path == 0) {
<a name="l00412"></a>00412                             <span class="keywordflow">if</span> (cp != work) {
<a name="l00413"></a>00413                                 cp--;
<a name="l00414"></a>00414                                 <span class="keywordflow">while</span> (cp != work) {
<a name="l00415"></a>00415                                     cp--;
<a name="l00416"></a>00416                                     <span class="keywordflow">if</span> (*cp == <span class="charliteral">'/'</span>) {
<a name="l00417"></a>00417                                         <span class="keywordflow">break</span>;
<a name="l00418"></a>00418                                     }
<a name="l00419"></a>00419                                 }
<a name="l00420"></a>00420                             }
<a name="l00421"></a>00421                             <span class="keywordflow">continue</span>;
<a name="l00422"></a>00422                         }
<a name="l00423"></a>00423                         path--;
<a name="l00424"></a>00424                     }
<a name="l00425"></a>00425                     path--;
<a name="l00426"></a>00426                 }
<a name="l00427"></a>00427                 <span class="comment">/* Copy the current path component. */</span>
<a name="l00428"></a>00428                 <span class="keywordflow">while</span> (*path &amp;&amp; *path != <span class="charliteral">'/'</span>) {
<a name="l00429"></a>00429                     *cp++ = *path++;
<a name="l00430"></a>00430                 }
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433         *cp = 0;
<a name="l00434"></a>00434     }
<a name="l00435"></a>00435     <span class="keywordflow">return</span> full;
<a name="l00436"></a>00436 }
<a name="l00437"></a>00437 
<a name="l00447"></a><a class="code" href="group__xg_f_t_p_d.html#g78bc9b7d484569dce570bf8eef609eb1">00447</a> TCPSOCKET *<a class="code" href="group__xg_f_t_p_d.html#g78bc9b7d484569dce570bf8eef609eb1" title="Establish an FTP connection for data transfer.">NutFtpDataConnect</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449     TCPSOCKET *sock;
<a name="l00450"></a>00450     <span class="keywordtype">int</span> rc;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xg_tcp_socket.html#g6bf8ec59828c5a0e38423293b4dfe8e6" title="Create a TCP socket.">NutTcpCreateSocket</a>()) != 0) {
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#ba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a>) {
<a name="l00455"></a>00455             <a class="code" href="group__xg_tcp_socket.html#gb3bd1c81e2046e53cde6973b9c6bf6f4" title="Set value of a TCP socket option.">NutTcpSetSockOpt</a>(sock, <a class="code" href="netinet_2tcp_8h.html#f20c12fa9bf018281e14c3b43b777e2e" title="Set maximum segment size.">TCP_MAXSEG</a>, &amp;session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#ba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a>, <span class="keyword">sizeof</span>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#ba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a>));
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#d88f1bd2fa0e9bb84d2364aa33711098" title="FTP data transfer connection type.">ftp_passive</a>) {
<a name="l00458"></a>00458             rc = <a class="code" href="group__xg_tcp_socket.html#g3859b3c38665aedc32608827f931498a" title="Wait for incoming connect from a remote socket.">NutTcpAccept</a>(sock, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#fbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a>);
<a name="l00459"></a>00459         } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460             rc = <a class="code" href="group__xg_tcp_socket.html#g48ff1e877483a0833cf38e428eac6457" title="Connect to a remote socket.">NutTcpConnect</a>(sock, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a6a868b8985c280f0d5f6512d08e9313" title="Target IP for data transfer.">ftp_data_ip</a>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#fbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a>);
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462         <span class="keywordflow">if</span> (rc) {
<a name="l00463"></a>00463             <a class="code" href="group__xg_tcp_socket.html#g09d94fd887683a0837e06c2cc08fc7ba" title="Close TCP socket.">NutTcpCloseSocket</a>(sock);
<a name="l00464"></a>00464             sock = 0;
<a name="l00465"></a>00465         }
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467     <span class="keywordflow">return</span> sock;
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00483"></a><a class="code" href="group__xg_f_t_p_d.html#g9e41cc8f252b71d222f0d79da1899eaf">00483</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g9e41cc8f252b71d222f0d79da1899eaf" title="Register the FTP server&amp;#39;s root directory.">NutRegisterFtpRoot</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485     <span class="comment">/* Reset path to default. */</span>
<a name="l00486"></a>00486     <span class="keywordflow">if</span> (path == NULL || *path == 0) {
<a name="l00487"></a>00487         <span class="comment">/* Release previously allocate space. */</span>
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (ftp_root) {
<a name="l00489"></a>00489             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ftp_root);
<a name="l00490"></a>00490         }
<a name="l00491"></a>00491         <span class="keywordflow">if</span> ((ftp_root = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="group__xg_f_t_p_d.html#g7c5a64c63f20eb3e3ebab183895a8081" title="Default FTP root path.">FTP_ROOTPATH</a>))) == 0) {
<a name="l00492"></a>00492             <span class="keywordflow">return</span> -1;
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494         <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(ftp_root, <a class="code" href="group__xg_f_t_p_d.html#g7c5a64c63f20eb3e3ebab183895a8081" title="Default FTP root path.">FTP_ROOTPATH</a>);
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="comment">/* Set a specified path. */</span>
<a name="l00498"></a>00498     <span class="keywordflow">else</span> {
<a name="l00499"></a>00499         <span class="keywordtype">char</span> *cp = <a class="code" href="group__xg_crt_string.html#g36feeebd3867be51852ba56dee5e53eb" title="Locate the first occurrence of a character in a string.">strchr</a>(path, <span class="charliteral">':'</span>);
<a name="l00500"></a>00500         <span class="keywordtype">int</span> len = <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(path);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="comment">/* Make sure that the path fulfills all requirements. */</span>
<a name="l00503"></a>00503         <span class="keywordflow">if</span> (len &lt; 2 || cp == 0 || (*++cp &amp;&amp; *cp != <span class="charliteral">'/'</span>)) {
<a name="l00504"></a>00504             <span class="keywordflow">return</span> -1;
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="comment">/* Allocate space for new path, but preserve the current one. */</span>
<a name="l00508"></a>00508         <span class="keywordflow">if</span> ((cp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(len + 1)) == 0) {
<a name="l00509"></a>00509             <span class="keywordflow">return</span> -1;
<a name="l00510"></a>00510         }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         <span class="comment">/* Take over, releasing previously allocate space. */</span>
<a name="l00513"></a>00513         <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(cp, path);
<a name="l00514"></a>00514         <span class="keywordflow">if</span> (ftp_root) {
<a name="l00515"></a>00515             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ftp_root);
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517         ftp_root = cp;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <span class="comment">/* Chop off an optional trailing slash. */</span>
<a name="l00520"></a>00520         cp = cp + <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(cp) - 1;
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (*cp == <span class="charliteral">'/'</span>) {
<a name="l00522"></a>00522             *cp = 0;
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524     }
<a name="l00525"></a>00525     <span class="keywordflow">return</span> 0;
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00543"></a><a class="code" href="group__xg_f_t_p_d.html#g1be14e9d89556bb62edccd798e2f0713">00543</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g1be14e9d89556bb62edccd798e2f0713" title="Register an FTP user.">NutRegisterFtpUser</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *user, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *pass)
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (ftp_user) {
<a name="l00546"></a>00546         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ftp_user);
<a name="l00547"></a>00547         ftp_user = NULL;
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (user &amp;&amp; *user) {
<a name="l00550"></a>00550         <span class="keywordflow">if</span> ((ftp_user = <a class="code" href="group__xg_crt_string.html#g608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(user)) == NULL) {
<a name="l00551"></a>00551             <span class="keywordflow">return</span> -1;
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553     }
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (ftp_pass) {
<a name="l00555"></a>00555         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ftp_pass);
<a name="l00556"></a>00556         ftp_pass = NULL;
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (pass &amp;&amp; *pass) {
<a name="l00559"></a>00559         <span class="keywordflow">if</span> ((ftp_pass = <a class="code" href="group__xg_crt_string.html#g608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(pass)) == NULL) {
<a name="l00560"></a>00560             <span class="keywordflow">return</span> -1;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563     <span class="keywordflow">return</span> 0;
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 
<a name="l00576"></a><a class="code" href="group__xg_f_t_p_d.html#g9c2f592b2642d2091ea274362d2ed6bc">00576</a> <a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> *<a class="code" href="group__xg_f_t_p_d.html#g9c2f592b2642d2091ea274362d2ed6bc" title="Open an FTP server session.">NutFtpOpenSession</a>(TCPSOCKET * sock)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578     <a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> *session;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     session = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a>));
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordflow">if</span> (session) {
<a name="l00583"></a>00583         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(session, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a>));
<a name="l00584"></a>00584         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#fbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a> = <a class="code" href="group__xg_f_t_p_d.html#g972c1b4b37ca75e1e499e91617a3e40b" title="Default data port.">FTP_DATA_PORT</a>;
<a name="l00585"></a>00585         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#ba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a> = sock-&gt;so_mss;
<a name="l00586"></a>00586         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#1e1535376ca70046a6b58fe3ca889261" title="Telnet socket of this session.">ftp_sock</a> = sock;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588         <span class="comment">/* Set initial working directory. */</span>
<a name="l00589"></a>00589         <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a> = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(2)) == 0) {
<a name="l00590"></a>00590             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(session);
<a name="l00591"></a>00591             session = 0;
<a name="l00592"></a>00592         } <span class="keywordflow">else</span> {
<a name="l00593"></a>00593             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>[0] = <span class="charliteral">'/'</span>;
<a name="l00594"></a>00594             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>[1] = 0;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596             <span class="comment">/*</span>
<a name="l00597"></a>00597 <span class="comment">             * Open a stream and associate it with the socket, so </span>
<a name="l00598"></a>00598 <span class="comment">             * we can use standard I/O. Note, that socket streams</span>
<a name="l00599"></a>00599 <span class="comment">             * currently do support text mode.</span>
<a name="l00600"></a>00600 <span class="comment">             */</span>
<a name="l00601"></a>00601             <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a> = <a class="code" href="group__xg_crt_stdio.html#g907a98011e3468d951740abecb768685" title="Open a stream associated with a file, device or socket descriptor.">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">"r+b"</span>)) == 0) {
<a name="l00602"></a>00602                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00603"></a>00603                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(session);
<a name="l00604"></a>00604                 session = 0;
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606         }
<a name="l00607"></a>00607     }
<a name="l00608"></a>00608     <span class="keywordflow">return</span> session;
<a name="l00609"></a>00609 }
<a name="l00610"></a>00610 
<a name="l00617"></a><a class="code" href="group__xg_f_t_p_d.html#g4e8a0adc4680aa66e9d4d17fdc6e985d">00617</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_f_t_p_d.html#g4e8a0adc4680aa66e9d4d17fdc6e985d" title="Close an FTP server session.">NutFtpCloseSession</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (session) {
<a name="l00620"></a>00620         <span class="comment">/* Close the stream. */</span>
<a name="l00621"></a>00621         <a class="code" href="group__xg_crt_stdio.html#g76370407f9ab0402564c2bb9bc9664e0" title="Close a stream.">fclose</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00622"></a>00622         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>) {
<a name="l00623"></a>00623             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(session);
<a name="l00626"></a>00626     }
<a name="l00627"></a>00627 }
<a name="l00628"></a>00628 
<a name="l00639"></a><a class="code" href="group__xg_f_t_p_d.html#g6fe36e83d24072ff6fb7940252c51a6e">00639</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g6fe36e83d24072ff6fb7940252c51a6e" title="Process an FTP client&amp;#39;s CWD command.">NutFtpProcessCwd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00640"></a>00640 {
<a name="l00641"></a>00641     <span class="keyword">struct </span><a class="code" href="structstat.html" title="File status structure.">stat</a> st;
<a name="l00642"></a>00642     <span class="keywordtype">char</span> *cp = path + <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(ftp_root);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="keywordflow">if</span> (*cp &amp;&amp; <a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(cp, <span class="stringliteral">"/"</span>)) {
<a name="l00645"></a>00645         <span class="comment">/*</span>
<a name="l00646"></a>00646 <span class="comment">         * Check, if the path exists and if this is a directory. </span>
<a name="l00647"></a>00647 <span class="comment">         */</span>
<a name="l00648"></a>00648         <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#g91b48d99128dd507e20c8adcc22deeb2" title="Get information about a specified file.">stat</a>(path, &amp;st) || !<a class="code" href="group__xg_f_s.html#g70b64ed67c0ab484b4ba09487da34e91" title="Check for directory.">S_ISDIR</a>(st.<a class="code" href="structstat.html#2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a>)) {
<a name="l00649"></a>00649             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00650"></a>00650         }
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="comment">/*</span>
<a name="l00654"></a>00654 <span class="comment">     * Store the new working directory excluding our root part.</span>
<a name="l00655"></a>00655 <span class="comment">     */</span>
<a name="l00656"></a>00656     <span class="keywordflow">if</span> (*cp == 0) {
<a name="l00657"></a>00657         cp = <span class="stringliteral">"/"</span>;
<a name="l00658"></a>00658     }
<a name="l00659"></a>00659     <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>) {
<a name="l00660"></a>00660         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662     <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a> = <a class="code" href="group__xg_crt_string.html#g608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(cp)) == NULL) {
<a name="l00663"></a>00663         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 250);
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00680"></a><a class="code" href="group__xg_f_t_p_d.html#g8c45cdbeb27a773812a7eb6cca53125b">00680</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g8c45cdbeb27a773812a7eb6cca53125b" title="Process an FTP client&amp;#39;s DELE command.">NutFtpProcessDelete</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00681"></a>00681 {
<a name="l00682"></a>00682     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#gf5b5161e115b870e4c19cf3bbb6ed02d" title="Remove a file entry.">unlink</a>(path)) {
<a name="l00683"></a>00683         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 250);
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00705"></a><a class="code" href="group__xg_f_t_p_d.html#g80900fe10a1f7780a461127c77850275">00705</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g80900fe10a1f7780a461127c77850275" title="Transfer a file to or from the FTP client.">NutFtpTransferFile</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     TCPSOCKET *sock;
<a name="l00708"></a>00708     <span class="keywordtype">int</span> ec = 550;
<a name="l00709"></a>00709     <span class="keywordtype">int</span> fh;
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     <span class="comment">/* Open the file to send. */</span>
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (mode) {
<a name="l00713"></a>00713         fh = <a class="code" href="group__xg_crt_lowio.html#ga5b9fe6f8778481971c2e23a38348bb1" title="Open a file.">_open</a>(path, <a class="code" href="group__xg_crt_lowio.html#g166a079a4990ddeb0a32475728bbacd0">_O_BINARY</a> | <a class="code" href="group__xg_crt_lowio.html#g4d457d93039cb26f27461c4af5868309">_O_RDONLY</a>);
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715     <span class="comment">/* Open the file to receive. */</span>
<a name="l00716"></a>00716     <span class="keywordflow">else</span> {
<a name="l00717"></a>00717         fh = <a class="code" href="group__xg_crt_lowio.html#ga5b9fe6f8778481971c2e23a38348bb1" title="Open a file.">_open</a>(path, <a class="code" href="group__xg_crt_lowio.html#g774664d26ae1b1d55902562af5f1ec28">_O_CREAT</a> | <a class="code" href="group__xg_crt_lowio.html#g695223e667532dd799a1c5b56d9eae75">_O_TRUNC</a>);
<a name="l00718"></a>00718     }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (fh != -1) {
<a name="l00721"></a>00721         <span class="comment">/* File status OK, opening data connection */</span>
<a name="l00722"></a>00722         <a class="code" href="group__xg_f_t_p_d.html#g7a2c08102e2c52355561453fcb15eb5e" title="Send a response including the specified transfer mode.">NutFtpSendMode</a>(session, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#37c85d318251c52398943335ada65043" title="FTP data transfer mode.">ftp_tran_mode</a>);
<a name="l00723"></a>00723         <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xg_f_t_p_d.html#g78bc9b7d484569dce570bf8eef609eb1" title="Establish an FTP connection for data transfer.">NutFtpDataConnect</a>(session)) != 0) {
<a name="l00724"></a>00724             <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> mss = sock-&gt;so_mss;
<a name="l00725"></a>00725             <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *buf;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727             <span class="keywordflow">if</span> (mss &lt; 256) {
<a name="l00728"></a>00728                 mss = 256;
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730             <span class="keywordflow">if</span> ((buf = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(mss)) != 0) {
<a name="l00731"></a>00731                 <span class="keywordtype">int</span> got;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733                 ec = 0;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735                 <span class="comment">/* Send a file. */</span>
<a name="l00736"></a>00736                 <span class="keywordflow">if</span> (mode) {
<a name="l00737"></a>00737                     <span class="keywordflow">while</span> ((got = <a class="code" href="io_8h.html#a7278892ff16de3dd3d00ff4a89d11e4">_read</a>(fh, buf, mss)) &gt; 0) {
<a name="l00738"></a>00738                         <span class="keywordflow">if</span> (<a class="code" href="group__xg_tcp_socket.html#gfc14dd4c910afbb9269adc5bebba0281" title="Send data on a connected TCP socket.">NutTcpSend</a>(sock, buf, got) != got) {
<a name="l00739"></a>00739                             ec = 551;
<a name="l00740"></a>00740                             <span class="keywordflow">break</span>;
<a name="l00741"></a>00741                         }
<a name="l00742"></a>00742                     }
<a name="l00743"></a>00743                 }
<a name="l00744"></a>00744 
<a name="l00745"></a>00745                 <span class="comment">/* Receive a file. */</span>
<a name="l00746"></a>00746                 <span class="keywordflow">else</span> {
<a name="l00747"></a>00747                     <span class="keywordflow">while</span> ((got = <a class="code" href="group__xg_tcp_socket.html#gb08d3e50fd09da18b966af0dd23fa4aa" title="Receive data on a connected TCP socket.">NutTcpReceive</a>(sock, buf, mss)) &gt; 0) {
<a name="l00748"></a>00748                         <span class="keywordtype">int</span> x;
<a name="l00749"></a>00749                         <span class="keywordflow">if</span> ((x = <a class="code" href="io_8h.html#901fa187b164dd6faaac1b62c88614b5">_write</a>(fh, buf, got)) != got) {
<a name="l00750"></a>00750                             ec = 552;
<a name="l00751"></a>00751                             <span class="keywordflow">break</span>;
<a name="l00752"></a>00752                         }
<a name="l00753"></a>00753                     }
<a name="l00754"></a>00754                 }
<a name="l00755"></a>00755                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(buf);
<a name="l00756"></a>00756             }
<a name="l00757"></a>00757             <a class="code" href="group__xg_tcp_socket.html#g09d94fd887683a0837e06c2cc08fc7ba" title="Close TCP socket.">NutTcpCloseSocket</a>(sock);
<a name="l00758"></a>00758         }
<a name="l00759"></a>00759         <a class="code" href="group__xg_crt_lowio.html#g58a559c63748012aab165d5f82af766d" title="Close a file, device or socket.">_close</a>(fh);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761         <span class="comment">/* Remove files received with an error. */</span>
<a name="l00762"></a>00762         <span class="keywordflow">if</span> (mode == 0 &amp;&amp; ec) {
<a name="l00763"></a>00763             <a class="code" href="group__xg_f_s.html#gf5b5161e115b870e4c19cf3bbb6ed02d" title="Remove a file entry.">unlink</a>(path);
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765     }
<a name="l00766"></a>00766     <span class="keywordflow">if</span> (ec) {
<a name="l00767"></a>00767         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, ec);
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 226);
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00784"></a><a class="code" href="group__xg_f_t_p_d.html#gf4296b0e186e55d915fb843f7fde9b20">00784</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gf4296b0e186e55d915fb843f7fde9b20" title="Process an FTP client&amp;#39;s LIST or NLST command.">NutFtpTransferDirectory</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00785"></a>00785 {
<a name="l00786"></a>00786     TCPSOCKET *sock;
<a name="l00787"></a>00787     <a class="code" href="group__xg_crt_stdio.html#gb940bd570245f248e9464829cd7c8c75" title="Stream structure type.">FILE</a> *fp;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="keyword">struct </span><a class="code" href="structstat.html" title="File status structure.">stat</a> st;
<a name="l00790"></a>00790     <a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> *dir;
<a name="l00791"></a>00791     <span class="keyword">struct </span><a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a> *d_ent;
<a name="l00792"></a>00792     tm *gmt;
<a name="l00793"></a>00793     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> size;
<a name="l00794"></a>00794     <span class="keywordtype">int</span> ec = 550;
<a name="l00795"></a>00795     <span class="keywordtype">char</span> *name;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797     dir = <a class="code" href="group__xg_f_s_dir.html#g10116e941a8dfaf7e3dd345f8963fdd0" title="Open a directory stream.">opendir</a>(path);
<a name="l00798"></a>00798     <span class="keywordflow">if</span> (dir) {
<a name="l00799"></a>00799         <a class="code" href="group__xg_f_t_p_d.html#g7a2c08102e2c52355561453fcb15eb5e" title="Send a response including the specified transfer mode.">NutFtpSendMode</a>(session, 0);
<a name="l00800"></a>00800         <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xg_f_t_p_d.html#g78bc9b7d484569dce570bf8eef609eb1" title="Establish an FTP connection for data transfer.">NutFtpDataConnect</a>(session)) != 0) {
<a name="l00801"></a>00801             <span class="keywordflow">if</span> ((fp = <a class="code" href="group__xg_crt_stdio.html#g907a98011e3468d951740abecb768685" title="Open a stream associated with a file, device or socket descriptor.">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">"r+b"</span>)) != 0) {
<a name="l00802"></a>00802                 ec = 0;
<a name="l00803"></a>00803                 <span class="keywordflow">while</span> ((d_ent = <a class="code" href="group__xg_f_s_dir.html#ge4d263c5a1d3825c9511a898762513b2" title="Get the next directory entry.">readdir</a>(dir)) != 0) {
<a name="l00804"></a>00804                     <span class="keywordflow">if</span> (d_ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>[0] == <span class="charliteral">'.'</span>) {
<a name="l00805"></a>00805                         <span class="keywordflow">continue</span>;
<a name="l00806"></a>00806                     }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808                     <span class="keywordflow">if</span> ((name = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(path) + <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(d_ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>) + 2)) != 0) {
<a name="l00809"></a>00809                         <a class="code" href="icc_8h.html#5998f60c4f4af322b36debdbd11d7917">sprintf</a>(name, <span class="stringliteral">"%s/%s"</span>, path, d_ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>);
<a name="l00810"></a>00810                         <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#g91b48d99128dd507e20c8adcc22deeb2" title="Get information about a specified file.">stat</a>(name, &amp;st) == 0) {
<a name="l00811"></a>00811                             <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#g70b64ed67c0ab484b4ba09487da34e91" title="Check for directory.">S_ISDIR</a>(st.<a class="code" href="structstat.html#2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a>)) {
<a name="l00812"></a>00812                                 <a class="code" href="group__xg_crt_stdio.html#gbe6299d5823dd023e610aaa619735a3f" title="Write a character to a stream.">fputc</a>(<span class="charliteral">'d'</span>, fp);
<a name="l00813"></a>00813                                 size = 0;
<a name="l00814"></a>00814                             } <span class="keywordflow">else</span> {
<a name="l00815"></a>00815                                 <a class="code" href="group__xg_crt_stdio.html#gbe6299d5823dd023e610aaa619735a3f" title="Write a character to a stream.">fputc</a>(<span class="charliteral">'-'</span>, fp);
<a name="l00816"></a>00816                                 size = st.<a class="code" href="structstat.html#8301352421b5d6c322caf909b8e97ae4" title="Size.">st_size</a>;
<a name="l00817"></a>00817                             }
<a name="l00818"></a>00818                             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(fp, <span class="stringliteral">"rw-rw-rw-  1 0 0 %6lu "</span>, size);
<a name="l00819"></a>00819                             gmt = <a class="code" href="group__xg_crt_time.html#g4bf5c1b09409b70880b839f0ff9aeb9a" title="Convert a time value to a structure.">gmtime</a>(&amp;st.<a class="code" href="structstat.html#77e235090f8cb6897f1c0ce65689006b" title="Time of last modification.">st_mtime</a>);
<a name="l00820"></a>00820                             <span class="comment">//fprintf(fp, "%s %u %u ", mon_name[gmt-&gt;tm_mon], gmt-&gt;tm_mday, 1900 + gmt-&gt;tm_year);</span>
<a name="l00821"></a>00821                             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(fp, <span class="stringliteral">"%.3s %u "</span>, mon_name + gmt-&gt;tm_mon * 3, gmt-&gt;tm_mday);
<a name="l00822"></a>00822                             <span class="comment">//fprintf(fp, "%02u:%02u:%02u ", gmt-&gt;tm_hour, gmt-&gt;tm_min, gmt-&gt;tm_sec);</span>
<a name="l00823"></a>00823                             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(fp, <span class="stringliteral">"%02u:%02u "</span>, gmt-&gt;tm_hour, gmt-&gt;tm_min);
<a name="l00824"></a>00824                             <a class="code" href="group__xg_crt_stdio.html#g14acfae1988535199b72df91e18f72f3" title="Write a string to a stream.">fputs</a>(d_ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>, fp);
<a name="l00825"></a>00825                             <a class="code" href="group__xg_crt_stdio.html#g14acfae1988535199b72df91e18f72f3" title="Write a string to a stream.">fputs</a>(<span class="stringliteral">"\r\n"</span>, fp);
<a name="l00826"></a>00826                         }
<a name="l00827"></a>00827                         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(name);
<a name="l00828"></a>00828                     }
<a name="l00829"></a>00829                 }
<a name="l00830"></a>00830                 <a class="code" href="group__xg_crt_stdio.html#g76370407f9ab0402564c2bb9bc9664e0" title="Close a stream.">fclose</a>(fp);
<a name="l00831"></a>00831             }
<a name="l00832"></a>00832             <a class="code" href="group__xg_tcp_socket.html#g09d94fd887683a0837e06c2cc08fc7ba" title="Close TCP socket.">NutTcpCloseSocket</a>(sock);
<a name="l00833"></a>00833         }
<a name="l00834"></a>00834         <a class="code" href="group__xg_f_s_dir.html#gc0258906f9453b8abf03e945aa9c9676" title="Close a directory stream.">closedir</a>(dir);
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (ec) {
<a name="l00837"></a>00837         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, ec);
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 226);
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00854"></a><a class="code" href="group__xg_f_t_p_d.html#ge85078df724a2046bfab56e88c058357">00854</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ge85078df724a2046bfab56e88c058357" title="Process an FTP client&amp;#39;s MKD command.">NutFtpProcessMkd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00855"></a>00855 {
<a name="l00856"></a>00856     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#g4d876e05d5901bd30b82c305086e0d5e" title="Create a directory entry.">mkdir</a>(path, 0777)) {
<a name="l00857"></a>00857         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 257);
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00874"></a><a class="code" href="group__xg_f_t_p_d.html#g836d1cf7dc7ef29c929f6780477851f7">00874</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g836d1cf7dc7ef29c929f6780477851f7" title="Process an FTP client&amp;#39;s PASS command.">NutFtpProcessPass</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *pass)
<a name="l00875"></a>00875 {
<a name="l00876"></a>00876     <span class="keywordflow">if</span> (ftp_pass &amp;&amp; *ftp_pass) {
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> != 1 || <a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(ftp_pass, pass)) {
<a name="l00878"></a>00878             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 0;
<a name="l00879"></a>00879             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00880"></a>00880         }
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 2;
<a name="l00883"></a>00883     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 230);
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 
<a name="l00899"></a><a class="code" href="group__xg_f_t_p_d.html#g3564dcac7a3f46dcf9c77c78d3318b71">00899</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g3564dcac7a3f46dcf9c77c78d3318b71" title="Process an FTP client&amp;#39;s PASV command.">NutFtpProcessPassiv</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00900"></a>00900 {
<a name="l00901"></a>00901     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> ip = session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#1e1535376ca70046a6b58fe3ca889261" title="Telnet socket of this session.">ftp_sock</a>-&gt;so_local_addr;
<a name="l00902"></a>00902     <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> port = 20;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, <span class="stringliteral">"227 Passive (%u,%u,%u,%u,%u,%u).\r\n"</span>,        <span class="comment">/* */</span>
<a name="l00905"></a>00905             (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ip, (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ip &gt;&gt; 8), (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ip &gt;&gt; 16), (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ip &gt;&gt; 24),  <span class="comment">/* */</span>
<a name="l00906"></a>00906             (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (port &gt;&gt; 8), (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) port);
<a name="l00907"></a>00907     <a class="code" href="group__xg_crt_stdio.html#gdb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00908"></a>00908     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#d88f1bd2fa0e9bb84d2364aa33711098" title="FTP data transfer connection type.">ftp_passive</a> = 1;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="keywordflow">return</span> 0;
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00927"></a><a class="code" href="group__xg_f_t_p_d.html#gcf9843833821d7c38e7c1869c8555f68">00927</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gcf9843833821d7c38e7c1869c8555f68" title="Process an FTP client&amp;#39;s PORT command.">NutFtpProcessPort</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *args)
<a name="l00928"></a>00928 {
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (ParseIpPort(args, &amp;session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a6a868b8985c280f0d5f6512d08e9313" title="Target IP for data transfer.">ftp_data_ip</a>, &amp;session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#fbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a>) == 6) {
<a name="l00930"></a>00930         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#1e1535376ca70046a6b58fe3ca889261" title="Telnet socket of this session.">ftp_sock</a>-&gt;so_remote_addr == session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a6a868b8985c280f0d5f6512d08e9313" title="Target IP for data transfer.">ftp_data_ip</a>) {
<a name="l00931"></a>00931             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 200);
<a name="l00932"></a>00932         }
<a name="l00933"></a>00933         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 425);
<a name="l00934"></a>00934     }
<a name="l00935"></a>00935     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 501);;
<a name="l00936"></a>00936 }
<a name="l00937"></a>00937 
<a name="l00950"></a><a class="code" href="group__xg_f_t_p_d.html#ga58ab5aeaa0551c2a809e2d881b9272c">00950</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga58ab5aeaa0551c2a809e2d881b9272c" title="Process an FTP client&amp;#39;s PWD command.">NutFtpProcessPwd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00951"></a>00951 {
<a name="l00952"></a>00952 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00953"></a>00953 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&lt;'257 \"%s\"' "</span>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00954"></a>00954 <span class="preprocessor">#endif</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span>    <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, <span class="stringliteral">"257 \"%s\"\r\n"</span>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00956"></a>00956     <span class="keywordflow">return</span> 0;
<a name="l00957"></a>00957 }
<a name="l00958"></a>00958 
<a name="l00971"></a><a class="code" href="group__xg_f_t_p_d.html#g7b759361ed3c5ccb69461713e1857d7e">00971</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g7b759361ed3c5ccb69461713e1857d7e" title="Process an FTP client&amp;#39;s RMD command.">NutFtpProcessRmd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga1677087a1bd3fddf6245c7079625d30" title="Remove a directory.">rmdir</a>(path)) {
<a name="l00974"></a>00974         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 451);
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 257);
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 
<a name="l00988"></a><a class="code" href="group__xg_f_t_p_d.html#g727082f5c302cc37743c98321ace0509">00988</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g727082f5c302cc37743c98321ace0509" title="Process an FTP client&amp;#39;s SYST command.">NutFtpProcessSystem</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00989"></a>00989 {
<a name="l00990"></a>00990 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&lt;'215 UNIX Type: L8' "</span>);
<a name="l00992"></a>00992 <span class="preprocessor">#endif</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span>    <a class="code" href="group__xg_crt_stdio.html#g14acfae1988535199b72df91e18f72f3" title="Write a string to a stream.">fputs</a>(<span class="stringliteral">"215 UNIX Type: L8\r\n"</span>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00994"></a>00994     <span class="keywordflow">return</span> 0;
<a name="l00995"></a>00995 }
<a name="l00996"></a>00996 
<a name="l01011"></a><a class="code" href="group__xg_f_t_p_d.html#g09e1a0621e8b56f44b884aac05567607">01011</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g09e1a0621e8b56f44b884aac05567607" title="Process an FTP client&amp;#39;s TYPE command.">NutFtpProcessType</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *typecode)
<a name="l01012"></a>01012 {
<a name="l01013"></a>01013     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#37c85d318251c52398943335ada65043" title="FTP data transfer mode.">ftp_tran_mode</a> = (*typecode != <span class="charliteral">'A'</span>) &amp;&amp; (*typecode != <span class="charliteral">'a'</span>);
<a name="l01014"></a>01014     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 200);
<a name="l01015"></a>01015 }
<a name="l01016"></a>01016 
<a name="l01029"></a><a class="code" href="group__xg_f_t_p_d.html#gccd498f6cc8f1c9fe4cbc2835ea2d7cc">01029</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gccd498f6cc8f1c9fe4cbc2835ea2d7cc" title="Process an FTP client&amp;#39;s USER command.">NutFtpProcessUser</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *user)
<a name="l01030"></a>01030 {
<a name="l01031"></a>01031     <span class="keywordflow">if</span> (ftp_user &amp;&amp; *ftp_user) {
<a name="l01032"></a>01032         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> &amp;&amp; <a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(ftp_user, user)) {
<a name="l01033"></a>01033             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 0;
<a name="l01034"></a>01034             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036     }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038     <span class="comment">/* Need a password too. */</span>
<a name="l01039"></a>01039     <span class="keywordflow">if</span> (ftp_pass &amp;&amp; *ftp_pass) {
<a name="l01040"></a>01040         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 1;
<a name="l01041"></a>01041         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 331);
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043 
<a name="l01044"></a>01044     <span class="comment">/* No password required. */</span>
<a name="l01045"></a>01045     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 2;
<a name="l01046"></a>01046     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 230);
<a name="l01047"></a>01047 }
<a name="l01048"></a>01048 
<a name="l01060"></a><a class="code" href="group__xg_f_t_p_d.html#g5b72e2b9bea1143ace7837526d573444">01060</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g5b72e2b9bea1143ace7837526d573444" title="Process an FTP request.">NutFtpProcessRequest</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *request)
<a name="l01061"></a>01061 {
<a name="l01062"></a>01062     <span class="keywordtype">int</span> rc = 0;
<a name="l01063"></a>01063     <span class="keywordtype">char</span> *cmd;
<a name="l01064"></a>01064     <span class="keywordtype">char</span> *args;
<a name="l01065"></a>01065 
<a name="l01066"></a>01066     <span class="comment">/* Split the line into command and argument part. */</span>
<a name="l01067"></a>01067     SplitCmdArg(request, &amp;cmd, &amp;args);
<a name="l01068"></a>01068 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&gt;'%s %s' "</span>, cmd, args);
<a name="l01070"></a>01070 <span class="preprocessor">#endif</span>
<a name="l01071"></a>01071 <span class="preprocessor"></span>
<a name="l01072"></a>01072     <span class="comment">/* QUIT - Terminate session. */</span>
<a name="l01073"></a>01073     <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_quit_P) == 0) {
<a name="l01074"></a>01074         <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 221);
<a name="l01075"></a>01075         rc = -1;
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     <span class="comment">/* USER &lt;username&gt; - Check user name. */</span>
<a name="l01079"></a>01079     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_user_P) == 0) {
<a name="l01080"></a>01080         rc = <a class="code" href="group__xg_f_t_p_d.html#gccd498f6cc8f1c9fe4cbc2835ea2d7cc" title="Process an FTP client&amp;#39;s USER command.">NutFtpProcessUser</a>(session, args);
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083     <span class="comment">/* PASS &lt;password&gt; - Check user password. */</span>
<a name="l01084"></a>01084     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_pass_P) == 0) {
<a name="l01085"></a>01085         rc = <a class="code" href="group__xg_f_t_p_d.html#g836d1cf7dc7ef29c929f6780477851f7" title="Process an FTP client&amp;#39;s PASS command.">NutFtpProcessPass</a>(session, args);
<a name="l01086"></a>01086     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_noop_P) == 0) {
<a name="l01087"></a>01087         <a class="code" href="group__xg_f_t_p_d.html#gedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 200);
<a name="l01088"></a>01088     }
<a name="l01089"></a>01089     <span class="comment">/* Anything else requires a successful login. */</span>
<a name="l01090"></a>01090     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> &lt; 2) {
<a name="l01091"></a>01091         rc = <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 530);
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     <span class="comment">/* Valid login. */</span>
<a name="l01095"></a>01095     <span class="keywordflow">else</span> {
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="comment">/* PASV - Prepare passive transfer. */</span>
<a name="l01098"></a>01098         <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_pasv_P) == 0) {
<a name="l01099"></a>01099             rc = <a class="code" href="group__xg_f_t_p_d.html#g3564dcac7a3f46dcf9c77c78d3318b71" title="Process an FTP client&amp;#39;s PASV command.">NutFtpProcessPassiv</a>(session);
<a name="l01100"></a>01100         }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102         <span class="comment">/* PORT &lt;host-port&gt; - Set data connection. */</span>
<a name="l01103"></a>01103         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_port_P) == 0) {
<a name="l01104"></a>01104             rc = <a class="code" href="group__xg_f_t_p_d.html#gcf9843833821d7c38e7c1869c8555f68" title="Process an FTP client&amp;#39;s PORT command.">NutFtpProcessPort</a>(session, args);
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         <span class="comment">/* [X]PWD - Send name of current working directory. */</span>
<a name="l01108"></a>01108         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_pwd_P) == 0 || <a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_xpwd_P) == 0) {
<a name="l01109"></a>01109             rc = <a class="code" href="group__xg_f_t_p_d.html#ga58ab5aeaa0551c2a809e2d881b9272c" title="Process an FTP client&amp;#39;s PWD command.">NutFtpProcessPwd</a>(session);
<a name="l01110"></a>01110         }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112         <span class="comment">/* SYST - Send system identifier. */</span>
<a name="l01113"></a>01113         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_syst_P) == 0) {
<a name="l01114"></a>01114             rc = <a class="code" href="group__xg_f_t_p_d.html#g727082f5c302cc37743c98321ace0509" title="Process an FTP client&amp;#39;s SYST command.">NutFtpProcessSystem</a>(session);
<a name="l01115"></a>01115         }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117         <span class="comment">/* TYPE &lt;type-code&gt; - Receive transfer mode. */</span>
<a name="l01118"></a>01118         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_type_P) == 0) {
<a name="l01119"></a>01119             rc = <a class="code" href="group__xg_f_t_p_d.html#g09e1a0621e8b56f44b884aac05567607" title="Process an FTP client&amp;#39;s TYPE command.">NutFtpProcessType</a>(session, args);
<a name="l01120"></a>01120         }
<a name="l01121"></a>01121 
<a name="l01122"></a>01122         <span class="comment">/* Commands with path name argument. */</span>
<a name="l01123"></a>01123         <span class="keywordflow">else</span> {
<a name="l01124"></a>01124             <span class="keywordtype">char</span> *path;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126             <span class="keywordflow">if</span> ((path = <a class="code" href="group__xg_f_t_p_d.html#gad7b7118c7f21feb01fc6db7b8b0e615" title="Create an absolute path name.">CreateFullPathName</a>(ftp_root, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>, args)) == 0) {
<a name="l01127"></a>01127                 rc = <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 451);
<a name="l01128"></a>01128             }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130             <span class="comment">/* CWD &lt;pathname&gt; - Change working directory. */</span>
<a name="l01131"></a>01131             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_cwd_P) == 0) {
<a name="l01132"></a>01132                 rc = <a class="code" href="group__xg_f_t_p_d.html#g6fe36e83d24072ff6fb7940252c51a6e" title="Process an FTP client&amp;#39;s CWD command.">NutFtpProcessCwd</a>(session, path);
<a name="l01133"></a>01133             }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135             <span class="comment">/* DELE &lt;pathname&gt; - Delete a file. */</span>
<a name="l01136"></a>01136             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_dele_P) == 0) {
<a name="l01137"></a>01137                 rc = <a class="code" href="group__xg_f_t_p_d.html#g8c45cdbeb27a773812a7eb6cca53125b" title="Process an FTP client&amp;#39;s DELE command.">NutFtpProcessDelete</a>(session, path);
<a name="l01138"></a>01138             }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140             <span class="comment">/* LIST | NLST [&lt;pathname&gt;] - Send list of files in a directory. */</span>
<a name="l01141"></a>01141             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_list_P) == 0 || <a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_nlst_P) == 0) {
<a name="l01142"></a>01142                 rc = <a class="code" href="group__xg_f_t_p_d.html#gf4296b0e186e55d915fb843f7fde9b20" title="Process an FTP client&amp;#39;s LIST or NLST command.">NutFtpTransferDirectory</a>(session, path);
<a name="l01143"></a>01143             }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145             <span class="comment">/* MKD &lt;pathname&gt; - Make a directory. */</span>
<a name="l01146"></a>01146             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_mkd_P) == 0 || <a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_xmkd_P) == 0) {
<a name="l01147"></a>01147                 rc = <a class="code" href="group__xg_f_t_p_d.html#ge85078df724a2046bfab56e88c058357" title="Process an FTP client&amp;#39;s MKD command.">NutFtpProcessMkd</a>(session, path);
<a name="l01148"></a>01148             }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150             <span class="comment">/* RETR &lt;pathname&gt; - Send a file to the client. */</span>
<a name="l01151"></a>01151             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_retr_P) == 0) {
<a name="l01152"></a>01152                 rc = <a class="code" href="group__xg_f_t_p_d.html#g80900fe10a1f7780a461127c77850275" title="Transfer a file to or from the FTP client.">NutFtpTransferFile</a>(session, path, 1);
<a name="l01153"></a>01153             }
<a name="l01154"></a>01154 
<a name="l01155"></a>01155             <span class="comment">/* RMD &lt;pathname&gt; - Remove a directory. */</span>
<a name="l01156"></a>01156             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_rmd_P) == 0 || <a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_xrmd_P) == 0) {
<a name="l01157"></a>01157                 rc = <a class="code" href="group__xg_f_t_p_d.html#g7b759361ed3c5ccb69461713e1857d7e" title="Process an FTP client&amp;#39;s RMD command.">NutFtpProcessRmd</a>(session, path);
<a name="l01158"></a>01158             }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160             <span class="comment">/* STOR &lt;pathname&gt; - Receive a file from the client. */</span>
<a name="l01161"></a>01161             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_stor_P) == 0) {
<a name="l01162"></a>01162                 rc = <a class="code" href="group__xg_f_t_p_d.html#g80900fe10a1f7780a461127c77850275" title="Transfer a file to or from the FTP client.">NutFtpTransferFile</a>(session, path, 0);
<a name="l01163"></a>01163             }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165             <span class="comment">/* Anything else is an unknown command. */</span>
<a name="l01166"></a>01166             <span class="keywordflow">else</span> {
<a name="l01167"></a>01167                 rc = <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 502);
<a name="l01168"></a>01168             }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170             <span class="keywordflow">if</span> (path) {
<a name="l01171"></a>01171                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(path);
<a name="l01172"></a>01172             }
<a name="l01173"></a>01173         }
<a name="l01174"></a>01174     }
<a name="l01175"></a>01175     <span class="keywordflow">return</span> rc;
<a name="l01176"></a>01176 }
<a name="l01177"></a>01177 
<a name="l01193"></a><a class="code" href="group__xg_f_t_p_d.html#g6914104d8828e12e70984be621c87269">01193</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#g6914104d8828e12e70984be621c87269" title="Process an FTP sever session.">NutFtpServerSession</a>(TCPSOCKET * sock)
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195     <span class="keywordtype">int</span> rc = 0;
<a name="l01196"></a>01196     <a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> *session;
<a name="l01197"></a>01197     <span class="keywordtype">char</span> *buff;
<a name="l01198"></a>01198     <a class="code" href="group__xg_crt_time.html#ge33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> now;
<a name="l01199"></a>01199     <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *tip;
<a name="l01200"></a>01200     <span class="keywordtype">char</span> ch;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     <span class="comment">/* Set the root path if not yet done. */</span>
<a name="l01203"></a>01203     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_t_p_d.html#g9e41cc8f252b71d222f0d79da1899eaf" title="Register the FTP server&amp;#39;s root directory.">NutRegisterFtpRoot</a>(ftp_root)) {
<a name="l01204"></a>01204         <span class="keywordflow">return</span> -1;
<a name="l01205"></a>01205     }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     <span class="comment">/* Allocate the command line buffer. */</span>
<a name="l01208"></a>01208     <span class="keywordflow">if</span> ((buff = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="group__xg_f_t_p_d.html#g02da6fd3b04d4e1cc0e3931b47980276" title="UDP port of DHCP server.">FTP_MAX_CMDBUF</a>)) == 0) {
<a name="l01209"></a>01209         <span class="keywordflow">return</span> -1;
<a name="l01210"></a>01210     }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212     <span class="comment">/* Create a session structure and open a stream. */</span>
<a name="l01213"></a>01213     <span class="keywordflow">if</span> ((session = <a class="code" href="group__xg_f_t_p_d.html#g9c2f592b2642d2091ea274362d2ed6bc" title="Open an FTP server session.">NutFtpOpenSession</a>(sock)) == 0) {
<a name="l01214"></a>01214         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(buff);
<a name="l01215"></a>01215         <span class="keywordflow">return</span> -1;
<a name="l01216"></a>01216     }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <span class="comment">/* Send a welcome banner including system time. */</span>
<a name="l01219"></a>01219     <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(&amp;now);
<a name="l01220"></a>01220     tip = <a class="code" href="group__xg_crt_time.html#g7a9f8811ccb83dee7960cbd77dc133e9" title="Convert a time value and correct for the local time zone.">localtime</a>(&amp;now);
<a name="l01221"></a>01221 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n&lt;'"</span>);
<a name="l01223"></a>01223     <a class="code" href="group__xg_crt_stdio.html#g30b0c3fa763cfd9c65416be0c3956aa1" title="Print formatted output to the standard output stream.">printf_P</a>(rep_banner, <a class="code" href="group__xg_nut_version.html#gfc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>(), &amp;mon_name[tip-&gt;<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> * 3],        <span class="comment">/* */</span>
<a name="l01224"></a>01224              tip-&gt;<a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a>, tip-&gt;<a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a>, tip-&gt;<a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a>, tip-&gt;<a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a>);
<a name="l01225"></a>01225 <span class="preprocessor">#endif</span>
<a name="l01226"></a>01226 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, rep_banner, <a class="code" href="group__xg_nut_version.html#gfc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>(),      <span class="comment">/* */</span>
<a name="l01227"></a>01227               &amp;mon_name[tip-&gt;<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> * 3],       <span class="comment">/* */</span>
<a name="l01228"></a>01228               tip-&gt;<a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a>, tip-&gt;<a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a>, tip-&gt;<a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a>, tip-&gt;<a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a>);
<a name="l01229"></a>01229 
<a name="l01230"></a>01230     <span class="comment">/* </span>
<a name="l01231"></a>01231 <span class="comment">     * Loop for requests. </span>
<a name="l01232"></a>01232 <span class="comment">     */</span>
<a name="l01233"></a>01233     <span class="keywordflow">while</span> (rc == 0) {
<a name="l01234"></a>01234 
<a name="l01235"></a>01235         <span class="comment">/* Flush any previous output and read a new command line. */</span>
<a name="l01236"></a>01236         <a class="code" href="group__xg_crt_stdio.html#gdb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l01237"></a>01237         <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_stdio.html#g1c00c22c5e85d002e202cb733b644d63" title="Read a line from a stream.">fgets</a>(buff, <a class="code" href="group__xg_f_t_p_d.html#g02da6fd3b04d4e1cc0e3931b47980276" title="UDP port of DHCP server.">FTP_MAX_CMDBUF</a>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>) == 0) {
<a name="l01238"></a>01238             rc = -1;
<a name="l01239"></a>01239             <span class="keywordflow">break</span>;
<a name="l01240"></a>01240         }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242         <span class="comment">/* Skip command lines, which are too long. */</span>
<a name="l01243"></a>01243         <span class="keywordflow">if</span> ((ch = *(buff + <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(buff) - 1)) != <span class="charliteral">'\n'</span> &amp;&amp; ch != <span class="charliteral">'\r'</span>) {
<a name="l01244"></a>01244             <span class="keywordflow">do</span> {
<a name="l01245"></a>01245                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_stdio.html#g1c00c22c5e85d002e202cb733b644d63" title="Read a line from a stream.">fgets</a>(buff, <a class="code" href="group__xg_f_t_p_d.html#g02da6fd3b04d4e1cc0e3931b47980276" title="UDP port of DHCP server.">FTP_MAX_CMDBUF</a>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>) == 0) {
<a name="l01246"></a>01246                     rc = -1;
<a name="l01247"></a>01247                     <span class="keywordflow">break</span>;
<a name="l01248"></a>01248                 }
<a name="l01249"></a>01249             } <span class="keywordflow">while</span> ((ch = *(buff + <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(buff) - 1)) != <span class="charliteral">'\n'</span> &amp;&amp; ch != <span class="charliteral">'\r'</span>);
<a name="l01250"></a>01250             <span class="keywordflow">if</span> (rc == 0) {
<a name="l01251"></a>01251                 rc = <a class="code" href="group__xg_f_t_p_d.html#g8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 500);
<a name="l01252"></a>01252             }
<a name="l01253"></a>01253         }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255         <span class="comment">/* Process the request. */</span>
<a name="l01256"></a>01256         <span class="keywordflow">else</span> {
<a name="l01257"></a>01257             rc = <a class="code" href="group__xg_f_t_p_d.html#g5b72e2b9bea1143ace7837526d573444" title="Process an FTP request.">NutFtpProcessRequest</a>(session, buff);
<a name="l01258"></a>01258         }
<a name="l01259"></a>01259     }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261     <span class="comment">/* Cleanup and return. */</span>
<a name="l01262"></a>01262     <a class="code" href="group__xg_f_t_p_d.html#g4e8a0adc4680aa66e9d4d17fdc6e985d" title="Close an FTP server session.">NutFtpCloseSession</a>(session);
<a name="l01263"></a>01263     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(buff);
<a name="l01264"></a>01264     <span class="keywordflow">return</span> rc;
<a name="l01265"></a>01265 }
<a name="l01266"></a>01266 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
