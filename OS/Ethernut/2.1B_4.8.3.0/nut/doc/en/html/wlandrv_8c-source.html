<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_264e76a43993b4d38befcb6805fdec2d.html">arch</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_b0f1ad2db40117979aa0dc775463a1e9.html">avr</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_42e6833dcb69f3de75c6e85ab40d9c56.html">dev</a>
  </div>
<div class="contents">
<h1>wlandrv.c</h1><a href="wlandrv_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/****************************************************************************</span>
<a name="l00002"></a>00002 <span class="comment">*  This file is part of the WLAN-Ethernut device driver.</span>
<a name="l00003"></a>00003 <span class="comment">*</span>
<a name="l00004"></a>00004 <span class="comment">*  Copyright (c) 2004 by Michael Fischer. All rights reserved.</span>
<a name="l00005"></a>00005 <span class="comment">*</span>
<a name="l00006"></a>00006 <span class="comment">*  Redistribution and use in source and binary forms, with or without</span>
<a name="l00007"></a>00007 <span class="comment">*  modification, are permitted provided that the following conditions</span>
<a name="l00008"></a>00008 <span class="comment">*  are met:</span>
<a name="l00009"></a>00009 <span class="comment">*</span>
<a name="l00010"></a>00010 <span class="comment">*  1. Redistributions of source code must retain the above copyright</span>
<a name="l00011"></a>00011 <span class="comment">*     notice, this list of conditions and the following disclaimer.</span>
<a name="l00012"></a>00012 <span class="comment">*  2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00013"></a>00013 <span class="comment">*     notice, this list of conditions and the following disclaimer in the</span>
<a name="l00014"></a>00014 <span class="comment">*     documentation and/or other materials provided with the distribution.</span>
<a name="l00015"></a>00015 <span class="comment">*  3. Neither the name of the author nor the names of its contributors may</span>
<a name="l00016"></a>00016 <span class="comment">*     be used to endorse or promote products derived from this software</span>
<a name="l00017"></a>00017 <span class="comment">*     without specific prior written permission.</span>
<a name="l00018"></a>00018 <span class="comment">*</span>
<a name="l00019"></a>00019 <span class="comment">*  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00020"></a>00020 <span class="comment">*  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00021"></a>00021 <span class="comment">*  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00022"></a>00022 <span class="comment">*  FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL</span>
<a name="l00023"></a>00023 <span class="comment">*  THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00024"></a>00024 <span class="comment">*  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00025"></a>00025 <span class="comment">*  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00026"></a>00026 <span class="comment">*  OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00027"></a>00027 <span class="comment">*  AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00028"></a>00028 <span class="comment">*  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00029"></a>00029 <span class="comment">*  THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00030"></a>00030 <span class="comment">*  SUCH DAMAGE.</span>
<a name="l00031"></a>00031 <span class="comment">*</span>
<a name="l00032"></a>00032 <span class="comment">****************************************************************************</span>
<a name="l00033"></a>00033 <span class="comment">*  Portions Copyright:</span>
<a name="l00034"></a>00034 <span class="comment">*</span>
<a name="l00035"></a>00035 <span class="comment">*  Copyright (c) 2002</span>
<a name="l00036"></a>00036 <span class="comment">*    M Warner Losh &lt;imp@freebsd.org&gt;.  All rights reserved.</span>
<a name="l00037"></a>00037 <span class="comment">*  Copyright (c) 1997, 1998, 1999</span>
<a name="l00038"></a>00038 <span class="comment">*    Bill Paul &lt;wpaul@ctr.columbia.edu&gt;.  All rights reserved.</span>
<a name="l00039"></a>00039 <span class="comment">*</span>
<a name="l00040"></a>00040 <span class="comment">*  Redistribution and use in source and binary forms, with or without</span>
<a name="l00041"></a>00041 <span class="comment">*  modification, are permitted provided that the following conditions</span>
<a name="l00042"></a>00042 <span class="comment">*  are met:</span>
<a name="l00043"></a>00043 <span class="comment">*  1. Redistributions of source code must retain the above copyright</span>
<a name="l00044"></a>00044 <span class="comment">*     notice, this list of conditions and the following disclaimer.</span>
<a name="l00045"></a>00045 <span class="comment">*  2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00046"></a>00046 <span class="comment">*     notice, this list of conditions and the following disclaimer in the</span>
<a name="l00047"></a>00047 <span class="comment">*     documentation and/or other materials provided with the distribution.</span>
<a name="l00048"></a>00048 <span class="comment">*  3. Neither the name of the author nor the names of any co-contributors</span>
<a name="l00049"></a>00049 <span class="comment">*     may be used to endorse or promote products derived from this software</span>
<a name="l00050"></a>00050 <span class="comment">*     without specific prior written permission.</span>
<a name="l00051"></a>00051 <span class="comment">*</span>
<a name="l00052"></a>00052 <span class="comment">*  THIS SOFTWARE IS PROVIDED BY Bill Paul AND CONTRIBUTORS ``AS IS'' AND</span>
<a name="l00053"></a>00053 <span class="comment">*  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00054"></a>00054 <span class="comment">*  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00055"></a>00055 <span class="comment">*  ARE DISCLAIMED.  IN NO EVENT SHALL Bill Paul OR THE VOICES IN HIS HEAD</span>
<a name="l00056"></a>00056 <span class="comment">*  BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00057"></a>00057 <span class="comment">*  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00058"></a>00058 <span class="comment">*  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00059"></a>00059 <span class="comment">*  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00060"></a>00060 <span class="comment">*  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00061"></a>00061 <span class="comment">*  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF</span>
<a name="l00062"></a>00062 <span class="comment">*  THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00063"></a>00063 <span class="comment">*</span>
<a name="l00064"></a>00064 <span class="comment">****************************************************************************</span>
<a name="l00065"></a>00065 <span class="comment">*  History:</span>
<a name="l00066"></a>00066 <span class="comment">*</span>
<a name="l00067"></a>00067 <span class="comment">*  28.02.04  mifi   First Version</span>
<a name="l00068"></a>00068 <span class="comment">*                   If you like to see the original source. Take a look</span>
<a name="l00069"></a>00069 <span class="comment">*                   in if_wi.c from FreeBSD.</span>
<a name="l00070"></a>00070 <span class="comment">*  01.03.04  mifi   Now we use a timeout in our Thread, and check if we lost</span>
<a name="l00071"></a>00071 <span class="comment">*                   the card. In this case we try to Init it again.</span>
<a name="l00072"></a>00072 <span class="comment">*  02.03.04  mifi   Remove QuickHack for Networkname and WEP.</span>
<a name="l00073"></a>00073 <span class="comment">*  03.03.04  mifi   Use struct to config WLAN (WLAN_IOCTL_SET_CONFIG)</span>
<a name="l00074"></a>00074 <span class="comment">*  04.03.04  mifi   Add function to get WLAN_STATUS (WLAN_IOCTL_GET_STATUS)</span>
<a name="l00075"></a>00075 <span class="comment">*  06.03.04  mifi   Remove all @@MF later for monitor mode.</span>
<a name="l00076"></a>00076 <span class="comment">*                   It does not work with my card, and I think we need a</span>
<a name="l00077"></a>00077 <span class="comment">*                   special firmware for it.</span>
<a name="l00078"></a>00078 <span class="comment">****************************************************************************/</span>
<a name="l00079"></a><a class="code" href="wlandrv_8c.html#745b40cbe1fd6bebfd12569b9a4e8691">00079</a> <span class="preprocessor">#define __WLANDRV_C__</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &lt;<a class="code" href="compiler_8h.html">compiler.h</a>&gt;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &lt;stddef.h&gt;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &lt;<a class="code" href="if__ether_8h.html" title="Ethernet interface definitions.">netinet/if_ether.h</a>&gt;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &lt;<a class="code" href="ether_8h.html" title="Ethernet protocol definitions.">net/ether.h</a>&gt;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &lt;<a class="code" href="if__var_8h.html" title="Network interface structure.">net/if_var.h</a>&gt;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &lt;<a class="code" href="dev_2irqreg_8h.html" title="Interrupt management definitions.">dev/irqreg.h</a>&gt;</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="preprocessor">#include &lt;<a class="code" href="wlantypes_8h.html">dev/wlantypes.h</a>&gt;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#include &lt;<a class="code" href="pcmcia_8h.html">dev/pcmcia.h</a>&gt;</span>
<a name="l00097"></a>00097 <span class="preprocessor">#include &lt;<a class="code" href="wlancfg_8h.html">dev/wlancfg.h</a>&gt;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &lt;<a class="code" href="wlan_8h.html">dev/wlan.h</a>&gt;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#include &lt;<a class="code" href="wlandrv_8h.html">dev/wlandrv.h</a>&gt;</span>
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="comment">/*==========================================================*/</span>
<a name="l00102"></a>00102 <span class="comment">/*  DEFINE: All Structures and Common Constants             */</span>
<a name="l00103"></a>00103 <span class="comment">/*==========================================================*/</span>
<a name="l00104"></a>00104 <span class="preprocessor">#if (_DEBUG &gt;= 1)</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span><span class="preprocessor">#define Debug(_x)     if (bDebugState ) printf _x</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span><span class="preprocessor">#define Debug2(_x)    if (bDebugState &gt; 1) printf _x</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span><span class="preprocessor">#define panic         printf</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00109"></a><a class="code" href="wlandrv_8c.html#2aca7be7c59f822f698512c15ea29bfc">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define Debug(_x)</span>
<a name="l00110"></a><a class="code" href="wlandrv_8c.html#6d95b532efdd3430d61cd412e7ce09d4">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define Debug2(_x)</span>
<a name="l00111"></a><a class="code" href="wlandrv_8c.html#b6eb9bc6ad6b6dc0d46bea728e01d3a9">00111</a> <span class="preprocessor"></span><span class="preprocessor">#define panic</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>
<a name="l00114"></a><a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">00114</a> <span class="preprocessor">#define WI_LOCK(sc)           NutEventWait(&amp;hDeviceSemaphore,0)</span>
<a name="l00115"></a><a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">00115</a> <span class="preprocessor"></span><span class="preprocessor">#define WI_UNLOCK(sc)         NutEventPost(&amp;hDeviceSemaphore)</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>
<a name="l00117"></a><a class="code" href="wlandrv_8c.html#cf9151e6667aafff8ee2aa86d01db112">00117</a> <span class="preprocessor">#define ieee80211_new_state(_a,_b,_c)  _a-&gt;ic_state=_b</span>
<a name="l00118"></a><a class="code" href="wlandrv_8c.html#bd35e9d170aa779cc7d466eed8f07de7">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define isset(_a,_b)                  (*_a &amp; (1&lt;&lt;_b))</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">00120</a> <span class="preprocessor">#define CSR_WRITE_2(_a,_b,_c) pcmcia_WriteReg(_b,_c)</span>
<a name="l00121"></a><a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define CSR_READ_2(_a,_b)     pcmcia_ReadReg(_b)</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a>00123 <span class="comment">/*</span>
<a name="l00124"></a>00124 <span class="comment"> * Length information</span>
<a name="l00125"></a>00125 <span class="comment"> */</span>
<a name="l00126"></a><a class="code" href="wlandrv_8c.html#9c468d79f0db4075534de9afb8da690f">00126</a> <span class="preprocessor">#define WLAN_MIN_ETHERNET_FRAME_LEN 60</span>
<a name="l00127"></a><a class="code" href="wlandrv_8c.html#7d64f5982d43e13302cf283f81cdf31e">00127</a> <span class="preprocessor"></span><span class="preprocessor">#define WLAN_MAX_ETHERNET_FRAME_LEN 1514</span>
<a name="l00128"></a><a class="code" href="wlandrv_8c.html#9ced1247d3a65b1321c888fbc229d3db">00128</a> <span class="preprocessor"></span><span class="preprocessor">#define WLAN_ETHERNET_HEADER_LEN        14</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>
<a name="l00130"></a>00130 <span class="comment">/*</span>
<a name="l00131"></a>00131 <span class="comment"> * Interrupt define</span>
<a name="l00132"></a>00132 <span class="comment">*/</span>
<a name="l00133"></a><a class="code" href="wlandrv_8c.html#ba1d837c101dad261ae0df7b05bc07d1">00133</a> <span class="preprocessor">#define WI_INTRS  (WI_EV_RX | WI_EV_ALLOC | WI_EV_INFO)</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>
<a name="l00135"></a>00135 <span class="keyword">struct </span><a class="code" href="wlandrv_8c.html#c7952149387043b63035218d1f8a883e">wi_card_ident</a> {
<a name="l00136"></a>00136     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> card_id;
<a name="l00137"></a>00137     <span class="keywordtype">char</span> *card_name;
<a name="l00138"></a>00138     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> firm_type;
<a name="l00139"></a>00139 };
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="keyword">struct </span>ieee80211_frame_addr4 {
<a name="l00142"></a>00142     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_fc[2];
<a name="l00143"></a>00143     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_dur[2];
<a name="l00144"></a>00144     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_addr1[<a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>];
<a name="l00145"></a>00145     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_addr2[<a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>];
<a name="l00146"></a>00146     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_addr3[<a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>];
<a name="l00147"></a>00147     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_seq[2];
<a name="l00148"></a>00148     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> i_addr4[<a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>];
<a name="l00149"></a>00149 };
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">/*</span>
<a name="l00152"></a>00152 <span class="comment"> * transmit/receive frame structure</span>
<a name="l00153"></a>00153 <span class="comment">*/</span>
<a name="l00154"></a>00154 <span class="keyword">struct </span>wi_frame {
<a name="l00155"></a>00155     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> wi_status;        <span class="comment">/* 0x00 */</span>
<a name="l00156"></a>00156     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> wi_rx_tstamp1;    <span class="comment">/* 0x02 */</span>
<a name="l00157"></a>00157     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> wi_rx_tstamp0;    <span class="comment">/* 0x04 */</span>
<a name="l00158"></a>00158     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_rx_silence;     <span class="comment">/* 0x06 */</span>
<a name="l00159"></a>00159     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_rx_signal;      <span class="comment">/* 0x07 */</span>
<a name="l00160"></a>00160     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_rx_rate;        <span class="comment">/* 0x08 */</span>
<a name="l00161"></a>00161     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_rx_flow;        <span class="comment">/* 0x09 */</span>
<a name="l00162"></a>00162     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_tx_rtry;        <span class="comment">/* 0x0a */</span><span class="comment">/* Prism2 AP Only */</span>
<a name="l00163"></a>00163     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_tx_rate;        <span class="comment">/* 0x0b */</span><span class="comment">/* Prism2 AP Only */</span>
<a name="l00164"></a>00164     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> wi_tx_ctl;        <span class="comment">/* 0x0c */</span>
<a name="l00165"></a>00165     <span class="keyword">struct </span>ieee80211_frame_addr4 wi_whdr;       <span class="comment">/* 0x0e */</span>
<a name="l00166"></a>00166     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> wi_dat_len;       <span class="comment">/* 0x2c */</span>
<a name="l00167"></a>00167     <span class="keyword">struct </span><a class="code" href="structether__header.html" title="Ethernet protocol header.">ether_header</a> wi_ehdr;        <span class="comment">/* 0x2e */</span>
<a name="l00168"></a>00168 };
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">/*</span>
<a name="l00171"></a>00171 <span class="comment"> * Station set identification (SSID). (0xFC02, 0xFC04)</span>
<a name="l00172"></a>00172 <span class="comment">*/</span>
<a name="l00173"></a>00173 <span class="keyword">struct </span>wi_ssid {
<a name="l00174"></a>00174     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> wi_len;
<a name="l00175"></a>00175     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> wi_ssid[32];
<a name="l00176"></a>00176 };
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="comment">/*</span>
<a name="l00179"></a>00179 <span class="comment"> * Ethernet LLCS + SNAP header</span>
<a name="l00180"></a>00180 <span class="comment">*/</span>
<a name="l00181"></a>00181 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00182"></a>00182     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> DSAPSSAP;
<a name="l00183"></a>00183     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> Control;
<a name="l00184"></a>00184     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> MustZero;
<a name="l00185"></a>00185     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> Type;
<a name="l00186"></a>00186 } LLCS_SNAP_HEADER;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="comment">/*==========================================================*/</span>
<a name="l00189"></a>00189 <span class="comment">/*  DEFINE: Prototypes                                      */</span>
<a name="l00190"></a>00190 <span class="comment">/*==========================================================*/</span>
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 <span class="comment">/*==========================================================*/</span>
<a name="l00193"></a>00193 <span class="comment">/*  DEFINE: Definition of all local Data                    */</span>
<a name="l00194"></a>00194 <span class="comment">/*==========================================================*/</span>
<a name="l00195"></a>00195 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> hDeviceSemaphore;
<a name="l00196"></a>00196 <span class="keyword">static</span> <a class="code" href="wlantypes_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> bDebugState = 0;
<a name="l00197"></a>00197 
<a name="l00198"></a><a class="code" href="wlandrv_8c.html#c7952149387043b63035218d1f8a883e">00198</a> <span class="keyword">struct </span><a class="code" href="wlandrv_8c.html#c7952149387043b63035218d1f8a883e">wi_card_ident</a> <a class="code" href="wlandrv_8c.html#c7952149387043b63035218d1f8a883e">wi_card_ident</a>[] = {
<a name="l00199"></a>00199     <span class="comment">/*</span>
<a name="l00200"></a>00200 <span class="comment">     * CARD_ID          CARD_NAME      FIRM_TYPE</span>
<a name="l00201"></a>00201 <span class="comment">     */</span>
<a name="l00202"></a>00202 <span class="preprocessor">#if (WLAN_SUPPORT_LUCENT &gt;= 1)</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>    {<a class="code" href="wlandef_8h.html#cb232e91d769b7589ac3e84bb1169ed6">WI_NIC_LUCENT_ID</a>, <a class="code" href="wlandef_8h.html#1130bfd849667905bf779359f7197555">WI_NIC_LUCENT_STR</a>, <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>},
<a name="l00204"></a>00204     {<a class="code" href="wlandef_8h.html#98d1e0067511ec8ae795177adae98ba8">WI_NIC_SONY_ID</a>, <a class="code" href="wlandef_8h.html#b00b9203da5477a53493edd4f91e06ff">WI_NIC_SONY_STR</a>, <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>},
<a name="l00205"></a>00205     {<a class="code" href="wlandef_8h.html#0ef5f9675ae27e86c8551f0b77e3c2e8">WI_NIC_LUCENT_EMB_ID</a>, <a class="code" href="wlandef_8h.html#1f6de250c7ea9c4ab873805ecc8cc906">WI_NIC_LUCENT_EMB_STR</a>, <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>},
<a name="l00206"></a>00206 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_SUPPORT_LUCENT &gt;= 1) */</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="preprocessor">#if (WLAN_SUPPORT_INTERSIL &gt;= 1)</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span>    {<a class="code" href="wlandef_8h.html#5b29283598cb2aa07092b584d0e7834f">WI_NIC_EVB2_ID</a>, <a class="code" href="wlandef_8h.html#39d3f826b22ac4d811fc7439727a3b5e">WI_NIC_EVB2_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00210"></a>00210     {<a class="code" href="wlandef_8h.html#f9feaf4df27893f14c64282b86dbb342">WI_NIC_HWB3763_ID</a>, <a class="code" href="wlandef_8h.html#173e7debe7a89f6c599fe08cc5ca8164">WI_NIC_HWB3763_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00211"></a>00211     {<a class="code" href="wlandef_8h.html#f33fb81637743839f83d68731c30c0d4">WI_NIC_HWB3163_ID</a>, <a class="code" href="wlandef_8h.html#6997352229559e817997663b75ded6f1">WI_NIC_HWB3163_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00212"></a>00212     {<a class="code" href="wlandef_8h.html#6eea3c36f337ee320e5df2f517b52704">WI_NIC_HWB3163B_ID</a>, <a class="code" href="wlandef_8h.html#4a28a96064208c961eafa3dac0773966">WI_NIC_HWB3163B_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00213"></a>00213     {<a class="code" href="wlandef_8h.html#cfad523301a7ca40e90b053c25b1b841">WI_NIC_EVB3_ID</a>, <a class="code" href="wlandef_8h.html#8a0736e671a07b109a814f673855ccf0">WI_NIC_EVB3_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00214"></a>00214     {<a class="code" href="wlandef_8h.html#b01f474c6fc1c64fe2db263e2470b7d5">WI_NIC_HWB1153_ID</a>, <a class="code" href="wlandef_8h.html#fe07c5496c5b30e11b315ad985685a4e">WI_NIC_HWB1153_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00215"></a>00215     {<a class="code" href="wlandef_8h.html#fd67cd5ef8b528cf2bef481e51a56be3">WI_NIC_P2_SST_ID</a>, <a class="code" href="wlandef_8h.html#7a90d189656cb47c232f1da90762e616">WI_NIC_P2_SST_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00216"></a>00216     {<a class="code" href="wlandef_8h.html#1c88c19e2036861e847c6742a6485f45">WI_NIC_EVB2_SST_ID</a>, <a class="code" href="wlandef_8h.html#16648a0ec059a7a7dcc3b97f4d43411d">WI_NIC_EVB2_SST_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00217"></a>00217     {<a class="code" href="wlandef_8h.html#8a495fb6aa6634afca14e54eda3f8c7b">WI_NIC_3842_EVA_ID</a>, <a class="code" href="wlandef_8h.html#2e5f189d3ba4d349a6297764e20fd071">WI_NIC_3842_EVA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00218"></a>00218     {<a class="code" href="wlandef_8h.html#b639cd9e3e68a1b219aae313e05d336e">WI_NIC_3842_PCMCIA_AMD_ID</a>, <a class="code" href="wlandef_8h.html#e94b68940021069af83f2cea8055297d">WI_NIC_3842_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00219"></a>00219     {<a class="code" href="wlandef_8h.html#5ae46a882f0eb392e64e099c4375c8d3">WI_NIC_3842_PCMCIA_SST_ID</a>, <a class="code" href="wlandef_8h.html#e94b68940021069af83f2cea8055297d">WI_NIC_3842_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00220"></a>00220     {<a class="code" href="wlandef_8h.html#40488544be14c6cf41b4d589d1b01ba3">WI_NIC_3842_PCMCIA_ATL_ID</a>, <a class="code" href="wlandef_8h.html#e94b68940021069af83f2cea8055297d">WI_NIC_3842_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00221"></a>00221     {<a class="code" href="wlandef_8h.html#152f99dc91d1719004221bcea5e29800">WI_NIC_3842_PCMCIA_ATS_ID</a>, <a class="code" href="wlandef_8h.html#e94b68940021069af83f2cea8055297d">WI_NIC_3842_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00222"></a>00222     {<a class="code" href="wlandef_8h.html#4c2cb02065f1ba82bbc6903880a77fb6">WI_NIC_3842_MINI_AMD_ID</a>, <a class="code" href="wlandef_8h.html#4e7cf3519e6cdb9b9601f92b213d755f">WI_NIC_3842_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00223"></a>00223     {<a class="code" href="wlandef_8h.html#466babd0ec82b6b3ee348fbdc12d2f9b">WI_NIC_3842_MINI_SST_ID</a>, <a class="code" href="wlandef_8h.html#4e7cf3519e6cdb9b9601f92b213d755f">WI_NIC_3842_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00224"></a>00224     {<a class="code" href="wlandef_8h.html#49b0af098151d7539351a4b36b6d5eeb">WI_NIC_3842_MINI_ATL_ID</a>, <a class="code" href="wlandef_8h.html#4e7cf3519e6cdb9b9601f92b213d755f">WI_NIC_3842_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00225"></a>00225     {<a class="code" href="wlandef_8h.html#fba4937d1120160743d8d7b166e54b66">WI_NIC_3842_MINI_ATS_ID</a>, <a class="code" href="wlandef_8h.html#4e7cf3519e6cdb9b9601f92b213d755f">WI_NIC_3842_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00226"></a>00226     {<a class="code" href="wlandef_8h.html#fb35f33d661762fa270a3d36a8630404">WI_NIC_3842_PCI_AMD_ID</a>, <a class="code" href="wlandef_8h.html#02661b0fa3154422ccba0012a3846f53">WI_NIC_3842_PCI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00227"></a>00227     {<a class="code" href="wlandef_8h.html#983d7f3b17bba3ce78c037f05824690b">WI_NIC_3842_PCI_SST_ID</a>, <a class="code" href="wlandef_8h.html#02661b0fa3154422ccba0012a3846f53">WI_NIC_3842_PCI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00228"></a>00228     {<a class="code" href="wlandef_8h.html#c2ebd9d3e7319d84859135f6debc9eac">WI_NIC_3842_PCI_ATS_ID</a>, <a class="code" href="wlandef_8h.html#02661b0fa3154422ccba0012a3846f53">WI_NIC_3842_PCI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00229"></a>00229     {<a class="code" href="wlandef_8h.html#6713f8c47a831361a64ae165956af68c">WI_NIC_3842_PCI_ATL_ID</a>, <a class="code" href="wlandef_8h.html#02661b0fa3154422ccba0012a3846f53">WI_NIC_3842_PCI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00230"></a>00230     {<a class="code" href="wlandef_8h.html#aa7165858c304612350ff0aceedd5740">WI_NIC_P3_PCMCIA_AMD_ID</a>, <a class="code" href="wlandef_8h.html#6bb1d3b7f02f610e2927477a2cc22be3">WI_NIC_P3_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00231"></a>00231     {<a class="code" href="wlandef_8h.html#79fc644ceddb53123ef726f2bdda3923">WI_NIC_P3_PCMCIA_SST_ID</a>, <a class="code" href="wlandef_8h.html#6bb1d3b7f02f610e2927477a2cc22be3">WI_NIC_P3_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00232"></a>00232     {<a class="code" href="wlandef_8h.html#b39f89a66d00b988fcee1ef045be64e1">WI_NIC_P3_PCMCIA_ATL_ID</a>, <a class="code" href="wlandef_8h.html#6bb1d3b7f02f610e2927477a2cc22be3">WI_NIC_P3_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00233"></a>00233     {<a class="code" href="wlandef_8h.html#c416a5505cad8e67ccc16f47d2a326af">WI_NIC_P3_PCMCIA_ATS_ID</a>, <a class="code" href="wlandef_8h.html#6bb1d3b7f02f610e2927477a2cc22be3">WI_NIC_P3_PCMCIA_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00234"></a>00234     {<a class="code" href="wlandef_8h.html#8205fcc408032809ab476ff3b10ea3d9">WI_NIC_P3_MINI_AMD_ID</a>, <a class="code" href="wlandef_8h.html#d8daa9e518448b2dcc7c2847d723e09a">WI_NIC_P3_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00235"></a>00235     {<a class="code" href="wlandef_8h.html#e9ccf87c66286064043a23303b379a4c">WI_NIC_P3_MINI_SST_ID</a>, <a class="code" href="wlandef_8h.html#d8daa9e518448b2dcc7c2847d723e09a">WI_NIC_P3_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00236"></a>00236     {<a class="code" href="wlandef_8h.html#97470f987cc3b3cd4a9b629b6e0698fa">WI_NIC_P3_MINI_ATL_ID</a>, <a class="code" href="wlandef_8h.html#d8daa9e518448b2dcc7c2847d723e09a">WI_NIC_P3_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00237"></a>00237     {<a class="code" href="wlandef_8h.html#9c28c8c1416f467bafaf62ec9ee12e2a">WI_NIC_P3_MINI_ATS_ID</a>, <a class="code" href="wlandef_8h.html#d8daa9e518448b2dcc7c2847d723e09a">WI_NIC_P3_MINI_STR</a>, <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>},
<a name="l00238"></a>00238 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_SUPPORT_INTERSIL &gt;= 1) */</span>
<a name="l00239"></a>00239     {0, NULL, 0},
<a name="l00240"></a>00240 };
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 <span class="comment">/*==========================================================*/</span>
<a name="l00243"></a>00243 <span class="comment">/*  DEFINE: Definition of all local Procedures              */</span>
<a name="l00244"></a>00244 <span class="comment">/*==========================================================*/</span>
<a name="l00245"></a>00245 <span class="comment">/************************************************************/</span>
<a name="l00246"></a>00246 <span class="comment">/*  DELAY                                                   */</span>
<a name="l00247"></a>00247 <span class="comment">/*                                                          */</span>
<a name="l00248"></a>00248 <span class="comment">/*  Delay in us.                                            */</span>
<a name="l00249"></a>00249 <span class="comment">/************************************************************/</span>
<a name="l00250"></a>00250 <span class="keyword">static</span> <span class="keywordtype">void</span> DELAY(<a class="code" href="wlantypes_8h.html#cb58d6261a51ba1d6fd4d00de0872f84">u_int32_t</a> delay_us)
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     delay_us = delay_us / 1000;
<a name="l00253"></a>00253     delay_us++;
<a name="l00254"></a>00254     <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(delay_us);
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 <span class="comment">/************************************************************/</span>
<a name="l00258"></a>00258 <span class="comment">/*  DumpData                                                */</span>
<a name="l00259"></a>00259 <span class="comment">/*                                                          */</span>
<a name="l00260"></a>00260 <span class="comment">/*  Dump the Buffer to the Terminal                         */</span>
<a name="l00261"></a>00261 <span class="comment">/************************************************************/</span>
<a name="l00262"></a>00262 <span class="comment">/* Harald: Not always used, but not sure how. Changed</span>
<a name="l00263"></a>00263 <span class="comment">fron static to global and changed name to avoid conflicts */</span>
<a name="l00264"></a><a class="code" href="wlandrv_8c.html#74d150886c2f5c4d2d27514d643c6b80">00264</a> <span class="keywordtype">void</span> <a class="code" href="wlandrv_8c.html#74d150886c2f5c4d2d27514d643c6b80">DumpWlanData</a>(<a class="code" href="wlantypes_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> * pBuffer, <a class="code" href="wlantypes_8h.html#197942eefa7db30960ae396d68339b97">WORD</a> wBufferSize)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> x, MaxX = 16;
<a name="l00267"></a>00267     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> y, MaxY;
<a name="l00268"></a>00268     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> Size;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     <span class="keywordflow">if</span> (bDebugState != 0) {
<a name="l00271"></a>00271         Size = 0;
<a name="l00272"></a>00272         MaxY = (wBufferSize / 16) + 1;
<a name="l00273"></a>00273         <span class="keywordflow">for</span> (y = 0; y &lt; MaxY; y++) {
<a name="l00274"></a>00274             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"%04X: "</span>, (y * 16)));
<a name="l00275"></a>00275             <span class="keywordflow">for</span> (x = 0; x &lt; MaxX; x++) {
<a name="l00276"></a>00276                 <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"%02X "</span>, pBuffer[Size]));
<a name="l00277"></a>00277                 Size++;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279                 <span class="keywordflow">if</span> (Size &gt;= wBufferSize) {
<a name="l00280"></a>00280                     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"\r\n"</span>));
<a name="l00281"></a>00281                     <span class="keywordflow">return</span>;
<a name="l00282"></a>00282                 }
<a name="l00283"></a>00283             }
<a name="l00284"></a>00284             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"\r\n"</span>));
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="comment">/************************************************************/</span>
<a name="l00290"></a>00290 <span class="comment">/*  wi_cmd                                                  */</span>
<a name="l00291"></a>00291 <span class="comment">/************************************************************/</span>
<a name="l00292"></a>00292 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_cmd(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> cmd, <span class="keywordtype">int</span> val0, <span class="keywordtype">int</span> val1, <span class="keywordtype">int</span> val2)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i;            <span class="comment">/* Harald: Changed from int to long. */</span>
<a name="l00295"></a>00295     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s = 0;         <span class="comment">/* Oliver: Changed from signed to unsigned. */</span>
<a name="l00296"></a>00296     <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> count = 0;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) {
<a name="l00299"></a>00299         <span class="keywordflow">return</span> (<a class="code" href="errno_8h.html#b9b8cc17d1947160d13faaba7a18d6d1">ENODEV</a>);
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="comment">/* Harald: Removed this, it makes no sense */</span>
<a name="l00303"></a>00303     <span class="comment">//if (count &gt; 0) {</span>
<a name="l00304"></a>00304     <span class="comment">//  panic("Hey partner, hold on there!");</span>
<a name="l00305"></a>00305     <span class="comment">//}</span>
<a name="l00306"></a>00306     count++;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308     <span class="comment">/*</span>
<a name="l00309"></a>00309 <span class="comment">     * wait for the busy bit to clear</span>
<a name="l00310"></a>00310 <span class="comment">     */</span>
<a name="l00311"></a>00311     <span class="keywordflow">for</span> (i = sc-&gt;<a class="code" href="structwi__softc.html#73119ac71e03ad7e23830f81f3ee0cf6">wi_cmd_count</a>; i &gt; 0; i--) {    <span class="comment">/* 500ms */</span>
<a name="l00312"></a>00312         <span class="keywordflow">if</span> (!(<a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#35fe4cf9f7ae43d93380aaa1c4bbb5e4">WI_COMMAND</a>) &amp; <a class="code" href="wlandef_8h.html#6fe3a799228bdbd83b74e78cead98664">WI_CMD_BUSY</a>)) {
<a name="l00313"></a>00313             <span class="keywordflow">break</span>;
<a name="l00314"></a>00314         }
<a name="l00315"></a>00315         DELAY(1 * 1000);        <span class="comment">/* 1ms */</span>
<a name="l00316"></a>00316     }
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (i == 0) {
<a name="l00318"></a>00318         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_cmd: busy bit won't clear.\n"</span>));
<a name="l00319"></a>00319         sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> = 1;
<a name="l00320"></a>00320         count--;
<a name="l00321"></a>00321         <span class="keywordflow">return</span> (<a class="code" href="errno_8h.html#597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>);
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#3b875ab38b7b353a097411fe1945082a">WI_PARAM0</a>, val0);
<a name="l00325"></a>00325     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#2755f09651c022b88c3a31df7068716c">WI_PARAM1</a>, val1);
<a name="l00326"></a>00326     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#48298a9ec0854d0fe69dd3239ded3608">WI_PARAM2</a>, val2);
<a name="l00327"></a>00327     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#35fe4cf9f7ae43d93380aaa1c4bbb5e4">WI_COMMAND</a>, cmd);
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="keywordflow">if</span> (cmd == <a class="code" href="wlandef_8h.html#c47c866804d4db12e29832cf31e7fdbe">WI_CMD_INI</a>) {
<a name="l00330"></a>00330         <span class="comment">/*</span>
<a name="l00331"></a>00331 <span class="comment">         * XXX: should sleep here.</span>
<a name="l00332"></a>00332 <span class="comment">         */</span>
<a name="l00333"></a>00333         <span class="comment">/* Harald: Added UL specifiers, no idea how Michael's ICC accepted this */</span>
<a name="l00334"></a>00334         DELAY(250UL * 1000UL);  <span class="comment">/* 250ms delay for init */</span>
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="wlandef_8h.html#1185b2758de20e469abc656587bb2421">WI_TIMEOUT</a>; i++) {
<a name="l00337"></a>00337         <span class="comment">/*</span>
<a name="l00338"></a>00338 <span class="comment">         * Wait for 'command complete' bit to be</span>
<a name="l00339"></a>00339 <span class="comment">         * set in the event status register.</span>
<a name="l00340"></a>00340 <span class="comment">         */</span>
<a name="l00341"></a>00341         s = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#3979e1a080ffb89f63874f2d1cf4120b">WI_EVENT_STAT</a>);
<a name="l00342"></a>00342         <span class="keywordflow">if</span> (s &amp; <a class="code" href="wlandef_8h.html#2e51188176d6ac8a9392d9fcb5babcb8">WI_EV_CMD</a>) {
<a name="l00343"></a>00343             <span class="comment">/*</span>
<a name="l00344"></a>00344 <span class="comment">             * Ack the event and read result code.</span>
<a name="l00345"></a>00345 <span class="comment">             */</span>
<a name="l00346"></a>00346             s = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#33e21a85a714bf79055272cca971f67b">WI_STATUS</a>);
<a name="l00347"></a>00347             <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, WI_EV_CMD);
<a name="l00348"></a>00348             <span class="keywordflow">if</span> (s &amp; <a class="code" href="wlandef_8h.html#f87ee0fecb5e2e08eea2e0ef4c3bd110">WI_STAT_CMD_RESULT</a>) {
<a name="l00349"></a>00349                 count--;
<a name="l00350"></a>00350                 <span class="keywordflow">return</span> (<a class="code" href="errno_8h.html#70979f50f9c83e5aebab3d6a1bd4cf35">EIO</a>);
<a name="l00351"></a>00351             }
<a name="l00352"></a>00352             <span class="keywordflow">break</span>;
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354         DELAY(<a class="code" href="wlandef_8h.html#4f2d8caa12656462e870f13b1fd4a3d8">WI_DELAY</a>);
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     count--;
<a name="l00358"></a>00358     <span class="keywordflow">if</span> (i == WI_TIMEOUT) {
<a name="l00359"></a>00359         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"timeout in wi_cmd 0x%04x; event status 0x%04x\n"</span>, cmd, s));
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (s == 0xffff) {
<a name="l00361"></a>00361             sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> = 1;
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363         <span class="keywordflow">return</span> (<a class="code" href="errno_8h.html#597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>);
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365     <span class="keywordflow">return</span> (0);
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">/************************************************************/</span>
<a name="l00369"></a>00369 <span class="comment">/*  wi_stop                                                 */</span>
<a name="l00370"></a>00370 <span class="comment">/************************************************************/</span>
<a name="l00371"></a><a class="code" href="wlandrv_8c.html#8f5deb1fccddcab4b1d4bca80dfe35b9">00371</a> <span class="keywordtype">void</span> <a class="code" href="wlandrv_8c.html#8f5deb1fccddcab4b1d4bca80dfe35b9">wi_stop</a>(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> disable)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373     <span class="keyword">struct </span><a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     DELAY(100000);
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <a class="code" href="wlandrv_8c.html#cf9151e6667aafff8ee2aa86d01db112">ieee80211_new_state</a>(ic, <a class="code" href="wlandrv_8h.html#6c8e7861891c9e21e6a02ccdba5149445ddfd615e2f7a05d83ae61a24fa84692">IEEE80211_S_INIT</a>, -1);
<a name="l00378"></a>00378     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a> &amp;&amp; !sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) {
<a name="l00379"></a>00379         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#78962f3ef0c16eb5d61d19d889a499f1">WI_INT_EN</a>, 0);
<a name="l00380"></a>00380         wi_cmd(sc, <a class="code" href="wlandef_8h.html#7f78831b8b9e7be7a196d4da1a540fa6">WI_CMD_DISABLE</a> | sc-&gt;<a class="code" href="structwi__softc.html#5b575784a2438030945aaf2b0e7eabe5">sc_portnum</a>, 0, 0, 0);
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (disable) {
<a name="l00382"></a>00382             sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a> = 0;
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384     } <span class="keywordflow">else</span> {
<a name="l00385"></a>00385         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> &amp;&amp; disable) {   <span class="comment">/* gone --&gt; not enabled */</span>
<a name="l00386"></a>00386             sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a> = 0;
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388     }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     sc-&gt;<a class="code" href="structwi__softc.html#bd1bc3a0ac0959d43412ef89976e611f">sc_tx_timer</a> = 0;
<a name="l00391"></a>00391     sc-&gt;<a class="code" href="structwi__softc.html#61139a1785f635b7b6bf40da82a9aa9d">sc_scan_timer</a> = 0;
<a name="l00392"></a>00392 }
<a name="l00393"></a>00393 
<a name="l00394"></a>00394 <span class="comment">/************************************************************/</span>
<a name="l00395"></a>00395 <span class="comment">/*  wi_seek_bap                                             */</span>
<a name="l00396"></a>00396 <span class="comment">/************************************************************/</span>
<a name="l00397"></a>00397 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_seek_bap(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">int</span> off)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <span class="keywordtype">long</span> i;                     <span class="comment">/* Harald: from int to long  */</span>
<a name="l00400"></a>00400     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> status;        <span class="comment">/* Oliver: from signed to unsigned */</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#23cee91af59e9bbb3043d77d82634216">WI_SEL0</a>, <span class="keywordtype">id</span>);
<a name="l00403"></a>00403     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#aec6ea87fe4301de7370f157074ebad7">WI_OFF0</a>, off);
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (i = 0;; i++) {
<a name="l00406"></a>00406         status = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#aec6ea87fe4301de7370f157074ebad7">WI_OFF0</a>);
<a name="l00407"></a>00407         <span class="keywordflow">if</span> ((status &amp; <a class="code" href="wlandef_8h.html#1ab6729b505e141eedb25c5f1a8f84be">WI_OFF_BUSY</a>) == 0) {
<a name="l00408"></a>00408             <span class="keywordflow">break</span>;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (i == WI_TIMEOUT) {
<a name="l00411"></a>00411             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"timeout in wi_seek to %x/%x\n"</span>, <span class="keywordtype">id</span>, off));
<a name="l00412"></a>00412             sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a> = <a class="code" href="wlandef_8h.html#4d7ba5bf55b31d93b1b041c1219726fa">WI_OFF_ERR</a>;        <span class="comment">/* invalidate */</span>
<a name="l00413"></a>00413             <span class="keywordflow">if</span> (status == 0xffff) {
<a name="l00414"></a>00414                 sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> = 1;
<a name="l00415"></a>00415             }
<a name="l00416"></a>00416             <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>;
<a name="l00417"></a>00417         }
<a name="l00418"></a>00418         DELAY(1);
<a name="l00419"></a>00419     }
<a name="l00420"></a>00420     <span class="keywordflow">if</span> (status &amp; <a class="code" href="wlandef_8h.html#4d7ba5bf55b31d93b1b041c1219726fa">WI_OFF_ERR</a>) {
<a name="l00421"></a>00421         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"failed in wi_seek to %x/%x\n"</span>, <span class="keywordtype">id</span>, off));
<a name="l00422"></a>00422         sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a> = WI_OFF_ERR;    <span class="comment">/* invalidate */</span>
<a name="l00423"></a>00423         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#70979f50f9c83e5aebab3d6a1bd4cf35">EIO</a>;
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425     sc-&gt;<a class="code" href="structwi__softc.html#703adb9efb51c0c1ec47f6a52bb3cf21">sc_bap_id</a> = id;
<a name="l00426"></a>00426     sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a> = off;
<a name="l00427"></a>00427     <span class="keywordflow">return</span> 0;
<a name="l00428"></a>00428 }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 <span class="comment">/************************************************************/</span>
<a name="l00431"></a>00431 <span class="comment">/*  wi_read_bap                                             */</span>
<a name="l00432"></a>00432 <span class="comment">/************************************************************/</span>
<a name="l00433"></a>00433 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_read_bap(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">int</span> off, <span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> buflen)
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> *ptr;
<a name="l00436"></a>00436     <span class="keywordtype">int</span> i, error, cnt;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (buflen == 0) {
<a name="l00439"></a>00439         <span class="keywordflow">return</span> 0;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> != sc-&gt;<a class="code" href="structwi__softc.html#703adb9efb51c0c1ec47f6a52bb3cf21">sc_bap_id</a> || off != sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a>) {
<a name="l00442"></a>00442         <span class="keywordflow">if</span> ((error = wi_seek_bap(sc, <span class="keywordtype">id</span>, off)) != 0) {
<a name="l00443"></a>00443             <span class="keywordflow">return</span> error;
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446     cnt = (buflen + 1) / 2;
<a name="l00447"></a>00447     ptr = (<a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> *) buf;
<a name="l00448"></a>00448     <span class="keywordflow">for</span> (i = 0; i &lt; cnt; i++) {
<a name="l00449"></a>00449         *ptr++ = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#a1fb3f556996157b7df2e83d9c8d262c">WI_DATA0</a>);
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451     sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a> += cnt * 2;
<a name="l00452"></a>00452     <span class="keywordflow">return</span> 0;
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="comment">/************************************************************/</span>
<a name="l00456"></a>00456 <span class="comment">/*  wi_write_bap                                            */</span>
<a name="l00457"></a>00457 <span class="comment">/************************************************************/</span>
<a name="l00458"></a>00458 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_write_bap(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keywordtype">int</span> off, <span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> buflen)
<a name="l00459"></a>00459 {
<a name="l00460"></a>00460     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> *ptr;
<a name="l00461"></a>00461     <span class="keywordtype">int</span> i, error, cnt;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="keywordflow">if</span> (buflen == 0) {
<a name="l00464"></a>00464         <span class="keywordflow">return</span> 0;
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466 <span class="preprocessor">#ifdef WI_HERMES_AUTOINC_WAR</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span>  again:
<a name="l00468"></a>00468 <span class="preprocessor">#endif</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<span class="keywordtype">id</span> != sc-&gt;<a class="code" href="structwi__softc.html#703adb9efb51c0c1ec47f6a52bb3cf21">sc_bap_id</a> || off != sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a>) {
<a name="l00470"></a>00470         <span class="keywordflow">if</span> ((error = wi_seek_bap(sc, <span class="keywordtype">id</span>, off)) != 0) {
<a name="l00471"></a>00471             <span class="keywordflow">return</span> error;
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473     }
<a name="l00474"></a>00474     cnt = (buflen + 1) / 2;
<a name="l00475"></a>00475     ptr = (<a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> *) buf;
<a name="l00476"></a>00476     <span class="keywordflow">for</span> (i = 0; i &lt; cnt; i++) {
<a name="l00477"></a>00477         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#a1fb3f556996157b7df2e83d9c8d262c">WI_DATA0</a>, ptr[i]);
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479     sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a> += cnt * 2;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="preprocessor">#ifdef WI_HERMES_AUTOINC_WAR</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00483"></a>00483 <span class="comment">     * According to the comments in the HCF Light code, there is a bug</span>
<a name="l00484"></a>00484 <span class="comment">     * in the Hermes (or possibly in certain Hermes firmware revisions)</span>
<a name="l00485"></a>00485 <span class="comment">     * where the chip's internal autoincrement counter gets thrown off</span>
<a name="l00486"></a>00486 <span class="comment">     * during data writes:  the autoincrement is missed, causing one</span>
<a name="l00487"></a>00487 <span class="comment">     * data word to be overwritten and subsequent words to be written to</span>
<a name="l00488"></a>00488 <span class="comment">     * the wrong memory locations. The end result is that we could end</span>
<a name="l00489"></a>00489 <span class="comment">     * up transmitting bogus frames without realizing it. The workaround</span>
<a name="l00490"></a>00490 <span class="comment">     * for this is to write a couple of extra guard words after the end</span>
<a name="l00491"></a>00491 <span class="comment">     * of the transfer, then attempt to read then back. If we fail to</span>
<a name="l00492"></a>00492 <span class="comment">     * locate the guard words where we expect them, we preform the</span>
<a name="l00493"></a>00493 <span class="comment">     * transfer over again.</span>
<a name="l00494"></a>00494 <span class="comment">     */</span>
<a name="l00495"></a>00495     <span class="keywordflow">if</span> ((sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp; <a class="code" href="wlandrv_8h.html#a83b882895a4c863ef67d3bdc559dab9">WI_FLAGS_BUG_AUTOINC</a>) &amp;&amp; (<span class="keywordtype">id</span> &amp; 0xf000) == 0) {
<a name="l00496"></a>00496         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#a1fb3f556996157b7df2e83d9c8d262c">WI_DATA0</a>, 0x1234);
<a name="l00497"></a>00497         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#a1fb3f556996157b7df2e83d9c8d262c">WI_DATA0</a>, 0x5678);
<a name="l00498"></a>00498         wi_seek_bap(sc, <span class="keywordtype">id</span>, sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a>);
<a name="l00499"></a>00499         sc-&gt;<a class="code" href="structwi__softc.html#845caf2f646e61f9fcf3b07f4089b2b1">sc_bap_off</a> = WI_OFF_ERR;    <span class="comment">/* invalidate */</span>
<a name="l00500"></a>00500         <span class="keywordflow">if</span> (<a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#a1fb3f556996157b7df2e83d9c8d262c">WI_DATA0</a>) != 0x1234 || <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#a1fb3f556996157b7df2e83d9c8d262c">WI_DATA0</a>) != 0x5678) {
<a name="l00501"></a>00501             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"detect auto increment bug, try again\n"</span>));
<a name="l00502"></a>00502             <span class="keywordflow">goto</span> again;
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505 <span class="preprocessor">#endif</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 <span class="comment">/************************************************************/</span>
<a name="l00510"></a>00510 <span class="comment">/*  wi_read_rid                                             */</span>
<a name="l00511"></a>00511 <span class="comment">/************************************************************/</span>
<a name="l00512"></a>00512 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_read_rid(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> rid, <span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> *buflenp)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514     <span class="keywordtype">int</span> error, len;
<a name="l00515"></a>00515     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> ltbuf[2];
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="comment">/*</span>
<a name="l00518"></a>00518 <span class="comment">     * Tell the NIC to enter record read mode.</span>
<a name="l00519"></a>00519 <span class="comment">     */</span>
<a name="l00520"></a>00520     error = wi_cmd(sc, <a class="code" href="wlandef_8h.html#0b2b8f41bb7bba10429c04a448e4a4d3">WI_CMD_ACCESS</a> | <a class="code" href="wlandef_8h.html#f107b955e82672727c06d53f5f9d09ba">WI_ACCESS_READ</a>, rid, 0, 0);
<a name="l00521"></a>00521     <span class="keywordflow">if</span> (error) {
<a name="l00522"></a>00522         <span class="keywordflow">return</span> error;
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     error = wi_read_bap(sc, rid, 0, ltbuf, <span class="keyword">sizeof</span>(ltbuf));
<a name="l00526"></a>00526     <span class="keywordflow">if</span> (error) {
<a name="l00527"></a>00527         <span class="keywordflow">return</span> error;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[1]) != (<a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a>) rid) {
<a name="l00531"></a>00531         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"record read mismatch, rid=%x, got=%x\n"</span>, rid, <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[1])));
<a name="l00532"></a>00532         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#70979f50f9c83e5aebab3d6a1bd4cf35">EIO</a>;
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534     len = (<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[0]) - 1) * 2;  <span class="comment">/* already got rid */</span>
<a name="l00535"></a>00535     <span class="keywordflow">if</span> (*buflenp &lt; len) {
<a name="l00536"></a>00536         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"record buffer is too small, rid=%x, size=%d, len=%d\n"</span>, rid, *buflenp, len));
<a name="l00537"></a>00537         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#088abe8bad2df798edad3053d719b937">ENOSPC</a>;
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     *buflenp = len;
<a name="l00540"></a>00540     <span class="keywordflow">return</span> wi_read_bap(sc, rid, <span class="keyword">sizeof</span>(ltbuf), buf, len);
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="comment">/************************************************************/</span>
<a name="l00544"></a>00544 <span class="comment">/*  wi_write_rid                                            */</span>
<a name="l00545"></a>00545 <span class="comment">/*                                                          */</span>
<a name="l00546"></a>00546 <span class="comment">/*  Write a block of data to the Resource Identifier.       */</span>
<a name="l00547"></a>00547 <span class="comment">/*                                                          */</span>
<a name="l00548"></a>00548 <span class="comment">/*  Return: OK or Error cause.                              */</span>
<a name="l00549"></a>00549 <span class="comment">/************************************************************/</span>
<a name="l00550"></a>00550 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_write_rid(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> rid, <span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> buflen)
<a name="l00551"></a>00551 {
<a name="l00552"></a>00552     <span class="keywordtype">int</span> error;
<a name="l00553"></a>00553     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> ltbuf[2];
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     ltbuf[0] = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>((buflen + 1) / 2 + 1);   <span class="comment">/* includes rid */</span>
<a name="l00556"></a>00556     ltbuf[1] = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(rid);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     error = wi_write_bap(sc, rid, 0, ltbuf, <span class="keyword">sizeof</span>(ltbuf));
<a name="l00559"></a>00559     <span class="keywordflow">if</span> (error) {
<a name="l00560"></a>00560         <span class="keywordflow">return</span> error;
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562     error = wi_write_bap(sc, rid, <span class="keyword">sizeof</span>(ltbuf), buf, buflen);
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (error) {
<a name="l00564"></a>00564         <span class="keywordflow">return</span> error;
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">return</span> wi_cmd(sc, <a class="code" href="wlandef_8h.html#0b2b8f41bb7bba10429c04a448e4a4d3">WI_CMD_ACCESS</a> | <a class="code" href="wlandef_8h.html#5deb746b5f04b9c9cfb6c4885609128c">WI_ACCESS_WRITE</a>, rid, 0, 0);
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 <span class="comment">/************************************************************/</span>
<a name="l00571"></a>00571 <span class="comment">/*  wi_write_val                                            */</span>
<a name="l00572"></a>00572 <span class="comment">/*                                                          */</span>
<a name="l00573"></a>00573 <span class="comment">/*  Write the value to the Resource Identifier.             */</span>
<a name="l00574"></a>00574 <span class="comment">/*  The function will write only a WORD                     */</span>
<a name="l00575"></a>00575 <span class="comment">/*                                                          */</span>
<a name="l00576"></a>00576 <span class="comment">/*  Return: OK or Error cause.                              */</span>
<a name="l00577"></a>00577 <span class="comment">/************************************************************/</span>
<a name="l00578"></a>00578 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_write_val(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> rid, <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> val)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580     val = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(val);
<a name="l00581"></a>00581     <span class="keywordflow">return</span> wi_write_rid(sc, rid, &amp;val, <span class="keyword">sizeof</span>(val));
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 <span class="comment">/************************************************************/</span>
<a name="l00585"></a>00585 <span class="comment">/*  wi_write_txrate                                         */</span>
<a name="l00586"></a>00586 <span class="comment">/************************************************************/</span>
<a name="l00587"></a>00587 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_write_txrate(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l00588"></a>00588 {
<a name="l00589"></a>00589     <span class="keyword">struct </span><a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l00590"></a>00590     <span class="keywordtype">int</span> i;
<a name="l00591"></a>00591     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> rate;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#7d714da7c1d6891f063899e3e1bf8156">ic_fixed_rate</a> &lt; 0) {
<a name="l00594"></a>00594         rate = 0;               <span class="comment">/* auto */</span>
<a name="l00595"></a>00595     } <span class="keywordflow">else</span> {
<a name="l00596"></a>00596         rate = (ic-&gt;<a class="code" href="structieee80211com.html#4921af98b393efd47212466b0c1b670a">ic_sup_rates</a>[<a class="code" href="wlandef_8h.html#01ecdf841157b3d62127089ce8ddb9cbf3543f682e39a4e8e23614a6611c1ead">IEEE80211_MODE_11B</a>].<a class="code" href="structieee80211__rateset.html#c0f4c816724aeb78b8962cbba9918b15">rs_rates</a>[ic-&gt;<a class="code" href="structieee80211com.html#7d714da7c1d6891f063899e3e1bf8156">ic_fixed_rate</a>] &amp; <a class="code" href="wlandef_8h.html#75ec97af31f38c520b7280796e9a9a17">IEEE80211_RATE_VAL</a>) / 2;
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="comment">/*</span>
<a name="l00600"></a>00600 <span class="comment">     * rate: 0, 1, 2, 5, 11</span>
<a name="l00601"></a>00601 <span class="comment">     */</span>
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="keywordflow">switch</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a>) {
<a name="l00604"></a>00604     <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>:
<a name="l00605"></a>00605         <span class="keywordflow">switch</span> (rate) {
<a name="l00606"></a>00606         <span class="keywordflow">case</span> 0:                <span class="comment">/* auto == 11mbps auto */</span>
<a name="l00607"></a>00607             rate = 3;
<a name="l00608"></a>00608             <span class="keywordflow">break</span>;
<a name="l00609"></a>00609             <span class="comment">/*</span>
<a name="l00610"></a>00610 <span class="comment">             * case 1, 2 map to 1, 2</span>
<a name="l00611"></a>00611 <span class="comment">             */</span>
<a name="l00612"></a>00612         <span class="keywordflow">case</span> 5:                <span class="comment">/* 5.5Mbps -&gt; 4 */</span>
<a name="l00613"></a>00613             rate = 4;
<a name="l00614"></a>00614             <span class="keywordflow">break</span>;
<a name="l00615"></a>00615         <span class="keywordflow">case</span> 11:               <span class="comment">/* 11mbps -&gt; 5 */</span>
<a name="l00616"></a>00616             rate = 5;
<a name="l00617"></a>00617             <span class="keywordflow">break</span>;
<a name="l00618"></a>00618         <span class="keywordflow">default</span>:
<a name="l00619"></a>00619             <span class="keywordflow">break</span>;
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621         <span class="keywordflow">break</span>;
<a name="l00622"></a>00622     <span class="keywordflow">default</span>:
<a name="l00623"></a>00623         <span class="comment">/*</span>
<a name="l00624"></a>00624 <span class="comment">         * Choose a bit according to this table.</span>
<a name="l00625"></a>00625 <span class="comment">         * *</span>
<a name="l00626"></a>00626 <span class="comment">         * * bit | data rate</span>
<a name="l00627"></a>00627 <span class="comment">         * * ----+-------------------</span>
<a name="l00628"></a>00628 <span class="comment">         * * 0   | 1Mbps</span>
<a name="l00629"></a>00629 <span class="comment">         * * 1   | 2Mbps</span>
<a name="l00630"></a>00630 <span class="comment">         * * 2   | 5.5Mbps</span>
<a name="l00631"></a>00631 <span class="comment">         * * 3   | 11Mbps</span>
<a name="l00632"></a>00632 <span class="comment">         */</span>
<a name="l00633"></a>00633         <span class="keywordflow">for</span> (i = 8; i &gt; 0; i &gt;&gt;= 1) {
<a name="l00634"></a>00634             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>) rate &gt;= i) {
<a name="l00635"></a>00635                 <span class="keywordflow">break</span>;
<a name="l00636"></a>00636             }
<a name="l00637"></a>00637         }
<a name="l00638"></a>00638         <span class="keywordflow">if</span> (i == 0) {
<a name="l00639"></a>00639             rate = 0xf;         <span class="comment">/* auto */</span>
<a name="l00640"></a>00640         } <span class="keywordflow">else</span> {
<a name="l00641"></a>00641             rate = i;
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643         <span class="keywordflow">break</span>;
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645     <span class="keywordflow">return</span> wi_write_val(sc, <a class="code" href="wlandef_8h.html#d352440b2307600d1299eef5c341b5e8">WI_RID_TX_RATE</a>, rate);
<a name="l00646"></a>00646 }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="comment">/************************************************************/</span>
<a name="l00649"></a>00649 <span class="comment">/*  wi_reset                                                */</span>
<a name="l00650"></a>00650 <span class="comment">/************************************************************/</span>
<a name="l00651"></a>00651 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_reset(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l00652"></a>00652 {
<a name="l00653"></a>00653     <span class="comment">//struct ieee80211com *ic = &amp;sc-&gt;sc_ic; /* Harald: Not used */</span>
<a name="l00654"></a>00654     <span class="keywordtype">int</span> i;
<a name="l00655"></a>00655     <span class="keywordtype">int</span> error = 0;
<a name="l00656"></a>00656     <span class="keywordtype">int</span> tries;
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="comment">/*</span>
<a name="l00659"></a>00659 <span class="comment">     * Symbol firmware cannot be initialized more than once</span>
<a name="l00660"></a>00660 <span class="comment">     */</span>
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a> &amp;&amp; sc-&gt;<a class="code" href="structwi__softc.html#8135b7d9a2f06988ad884cf0cd518880">sc_reset</a>) {
<a name="l00662"></a>00662         <span class="keywordflow">return</span> (0);
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a>) {
<a name="l00665"></a>00665         tries = 1;
<a name="l00666"></a>00666     } <span class="keywordflow">else</span> {
<a name="l00667"></a>00667         tries = 3;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="keywordflow">for</span> (i = 0; i &lt; tries; i++) {
<a name="l00671"></a>00671         <span class="keywordflow">if</span> ((error = wi_cmd(sc, <a class="code" href="wlandef_8h.html#c47c866804d4db12e29832cf31e7fdbe">WI_CMD_INI</a>, 0, 0, 0)) == 0) {
<a name="l00672"></a>00672             <span class="keywordflow">break</span>;
<a name="l00673"></a>00673         }
<a name="l00674"></a>00674         DELAY(<a class="code" href="wlandef_8h.html#4f2d8caa12656462e870f13b1fd4a3d8">WI_DELAY</a> * 1000);
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676     sc-&gt;<a class="code" href="structwi__softc.html#8135b7d9a2f06988ad884cf0cd518880">sc_reset</a> = 1;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (i == tries) {
<a name="l00679"></a>00679         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"init failed\n"</span>));
<a name="l00680"></a>00680         <span class="keywordflow">return</span> (error);
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#78962f3ef0c16eb5d61d19d889a499f1">WI_INT_EN</a>, 0);
<a name="l00684"></a>00684     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, 0xFFFF);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     <span class="comment">/*</span>
<a name="l00687"></a>00687 <span class="comment">     * Calibrate timer</span>
<a name="l00688"></a>00688 <span class="comment">     */</span>
<a name="l00689"></a>00689     wi_write_val(sc, <a class="code" href="wlandef_8h.html#c272b65e2d851bea6b180b993149af6c">WI_RID_TICK_TIME</a>, 8);
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="keywordflow">return</span> (0);
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="comment">/************************************************************/</span>
<a name="l00695"></a>00695 <span class="comment">/*  WLANInterrupt                                           */</span>
<a name="l00696"></a>00696 <span class="comment">/************************************************************/</span>
<a name="l00697"></a>00697 <span class="keyword">static</span> <span class="keywordtype">void</span> WLANInterrupt(<span class="keywordtype">void</span> *p)
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699     NUTDEVICE *dev = (NUTDEVICE *) p;
<a name="l00700"></a>00700     <span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *sc = (<span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *) dev-&gt;dev_dcb;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702     if ((sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> == 1) || (sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a> == 0)) {
<a name="l00703"></a>00703         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#78962f3ef0c16eb5d61d19d889a499f1">WI_INT_EN</a>, 0);
<a name="l00704"></a>00704         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, 0xFFFF);
<a name="l00705"></a>00705         <span class="keywordflow">return</span>;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/*</span>
<a name="l00709"></a>00709 <span class="comment">     * Disable interrupts. We will enable the interrupt</span>
<a name="l00710"></a>00710 <span class="comment">     * later in the RxThread.</span>
<a name="l00711"></a>00711 <span class="comment">     */</span>
<a name="l00712"></a>00712     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#78962f3ef0c16eb5d61d19d889a499f1">WI_INT_EN</a>, 0);
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     sc-&gt;<a class="code" href="structwi__softc.html#50563522c68f28c395a808e645257c1b">EventStatus</a> = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#3979e1a080ffb89f63874f2d1cf4120b">WI_EVENT_STAT</a>);
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <a class="code" href="group__xg_event.html#gc52b53066d7486072b4e1ace5b4c6f3b" title="Post an event to a specified queue from interrupt context.">NutEventPostFromIrq</a>(&amp;sc-&gt;<a class="code" href="structwi__softc.html#7f48501eabd729cc03a49c9d68f1f60e">InterruptEvent</a>);
<a name="l00717"></a>00717 }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719 <span class="comment">/************************************************************/</span>
<a name="l00720"></a>00720 <span class="comment">/*  wi_tx_intr                                              */</span>
<a name="l00721"></a>00721 <span class="comment">/************************************************************/</span>
<a name="l00722"></a>00722 <span class="keyword">static</span> <span class="keywordtype">void</span> wi_tx_intr(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l00723"></a>00723 {
<a name="l00724"></a>00724     <span class="comment">// struct ieee80211com *ic = &amp;sc-&gt;sc_ic; /* Harald: Not used. */</span>
<a name="l00725"></a>00725     <span class="keywordtype">int</span> fid, cur;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) {
<a name="l00728"></a>00728         <span class="keywordflow">return</span>;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     fid = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#fd5d05179b6d756dd4e4f2a6fe577882">WI_ALLOC_FID</a>);
<a name="l00732"></a>00732     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, <a class="code" href="wlandef_8h.html#ce85c56466d97cd99ab89a9c4b19a007">WI_EV_ALLOC</a>);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     cur = sc-&gt;<a class="code" href="structwi__softc.html#68183069ce698832e1aa4d9cd7e44c31">sc_txcur</a>;
<a name="l00735"></a>00735     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#d977a6dbd0c3855d7711c6bac8cdc28f">d_fid</a> != fid) {
<a name="l00736"></a>00736 <span class="preprocessor">#if (WLAN_ENABLE_TX_FRAME_DUMP &gt;= 1)</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span>        <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"bad alloc %x != %x, cur %d nxt %d\n"</span>, fid, sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#d977a6dbd0c3855d7711c6bac8cdc28f">d_fid</a>, cur, sc-&gt;<a class="code" href="structwi__softc.html#7d9a6e80b1bf298d6a4aefd9a4f7f57a">sc_txnext</a>));
<a name="l00738"></a>00738 <span class="preprocessor">#endif</span>
<a name="l00739"></a>00739 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
<a name="l00740"></a>00740     }
<a name="l00741"></a>00741     sc-&gt;<a class="code" href="structwi__softc.html#bd1bc3a0ac0959d43412ef89976e611f">sc_tx_timer</a> = 0;
<a name="l00742"></a>00742     sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#06eef39fdf5fbca4412ade64d592295b">d_len</a> = 0;
<a name="l00743"></a>00743     sc-&gt;<a class="code" href="structwi__softc.html#68183069ce698832e1aa4d9cd7e44c31">sc_txcur</a> = cur = (cur + 1) % sc-&gt;<a class="code" href="structwi__softc.html#9661117d73615ff8ac222b79fb96ba55">sc_ntxbuf</a>;
<a name="l00744"></a>00744     if (sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#06eef39fdf5fbca4412ade64d592295b">d_len</a> == 0) {
<a name="l00745"></a>00745         <span class="comment">//ifp-&gt;if_flags &amp;= ~IFF_OACTIVE;</span>
<a name="l00746"></a>00746     } <span class="keywordflow">else</span> {
<a name="l00747"></a>00747         <span class="keywordflow">if</span> (wi_cmd(sc, <a class="code" href="wlandef_8h.html#722f1a9405561cae6b8af261388bb28e">WI_CMD_TX</a> | <a class="code" href="wlandef_8h.html#8fb006a87a7d46a05f4ed585bddc686b">WI_RECLAIM</a>, sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#d977a6dbd0c3855d7711c6bac8cdc28f">d_fid</a>, 0, 0)) {
<a name="l00748"></a>00748             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"xmit failed\n"</span>));
<a name="l00749"></a>00749             sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#06eef39fdf5fbca4412ade64d592295b">d_len</a> = 0;
<a name="l00750"></a>00750         } <span class="keywordflow">else</span> {
<a name="l00751"></a>00751             sc-&gt;<a class="code" href="structwi__softc.html#bd1bc3a0ac0959d43412ef89976e611f">sc_tx_timer</a> = 5;
<a name="l00752"></a>00752             <span class="comment">//ifp-&gt;if_timer = 1;</span>
<a name="l00753"></a>00753         }
<a name="l00754"></a>00754     }
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="comment">/************************************************************/</span>
<a name="l00758"></a>00758 <span class="comment">/*  wi_info_intr                                            */</span>
<a name="l00759"></a>00759 <span class="comment">/************************************************************/</span>
<a name="l00760"></a>00760 <span class="keyword">static</span> <span class="keywordtype">void</span> wi_info_intr(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l00761"></a>00761 {
<a name="l00762"></a>00762     <span class="keyword">struct </span><a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l00763"></a>00763     <span class="comment">//struct ifnet *ifp = &amp;ic-&gt;ic_if;</span>
<a name="l00764"></a>00764     <span class="comment">//int i, len, off; /* Harald: Not used */</span>
<a name="l00765"></a>00765     <span class="keywordtype">int</span> fid;
<a name="l00766"></a>00766     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> ltbuf[2];
<a name="l00767"></a>00767     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> <a class="code" href="structstat.html" title="File status structure.">stat</a>;
<a name="l00768"></a>00768     <span class="comment">//u_int32_t *ptr; /* Harald: Not used. */</span>
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     fid = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#4b5ee76c7fbfa93a447ca455f23a1e38">WI_INFO_FID</a>);
<a name="l00771"></a>00771     wi_read_bap(sc, fid, 0, ltbuf, <span class="keyword">sizeof</span>(ltbuf));
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     <span class="keywordflow">switch</span> (<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[1])) {
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#094baa80cd41c7d685e92d68723c980a">WI_INFO_LINK_STAT</a>:
<a name="l00776"></a>00776         wi_read_bap(sc, fid, <span class="keyword">sizeof</span>(ltbuf), &amp;stat, <span class="keyword">sizeof</span>(stat));
<a name="l00777"></a>00777 <span class="preprocessor">#if (WLAN_ENABLE_LINK_STATUS &gt;= 1)</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span>        <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_info_intr: LINK_STAT 0x%x\n"</span>, <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(stat)));
<a name="l00779"></a>00779 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_ENABLE_LINK_STATUS &gt;= 1) */</span>
<a name="l00780"></a>00780 
<a name="l00781"></a>00781         <span class="keywordflow">switch</span> (<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(stat)) {
<a name="l00782"></a>00782         <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#e89d0c6e892f325e2be6ab4fb2562de6">WI_INFO_LINK_STAT_CONNECTED</a>:
<a name="l00783"></a>00783             sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp;= ~<a class="code" href="wlandrv_8h.html#be4408a291bb63321d97d128cafa0ea0">WI_FLAGS_OUTRANGE</a>;
<a name="l00784"></a>00784             <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#46f3f5f9069850be353e63e1eafbe37c">ic_state</a> == <a class="code" href="wlandrv_8h.html#6c8e7861891c9e21e6a02ccdba51494459e567dc5761d3a082d77011fc6c1a39">IEEE80211_S_RUN</a> &amp;&amp; ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> != <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed180a49ccd179cd8f6b80a405875714648">IEEE80211_M_IBSS</a>) {
<a name="l00785"></a>00785                 <span class="keywordflow">break</span>;
<a name="l00786"></a>00786             }
<a name="l00787"></a>00787             <span class="comment">/*</span>
<a name="l00788"></a>00788 <span class="comment">             * FALLTHROUGH</span>
<a name="l00789"></a>00789 <span class="comment">             */</span>
<a name="l00790"></a>00790         <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#84d989a99a33be3d5cace12dbd1b7dd6">WI_INFO_LINK_STAT_AP_CHG</a>:
<a name="l00791"></a>00791             <a class="code" href="wlandrv_8c.html#cf9151e6667aafff8ee2aa86d01db112">ieee80211_new_state</a>(ic, <a class="code" href="wlandrv_8h.html#6c8e7861891c9e21e6a02ccdba51494459e567dc5761d3a082d77011fc6c1a39">IEEE80211_S_RUN</a>, -1);
<a name="l00792"></a>00792             <span class="keywordflow">break</span>;
<a name="l00793"></a>00793         <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#bd390d7f939e55f9138546ed5bc050eb">WI_INFO_LINK_STAT_AP_INR</a>:
<a name="l00794"></a>00794             sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp;= ~<a class="code" href="wlandrv_8h.html#be4408a291bb63321d97d128cafa0ea0">WI_FLAGS_OUTRANGE</a>;
<a name="l00795"></a>00795             <span class="keywordflow">break</span>;
<a name="l00796"></a>00796         <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#fc777b605c5ecdc5bf210c13e56187b3">WI_INFO_LINK_STAT_AP_OOR</a>:
<a name="l00797"></a>00797             <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a> &amp;&amp; sc-&gt;<a class="code" href="structwi__softc.html#61139a1785f635b7b6bf40da82a9aa9d">sc_scan_timer</a> &gt; 0) {
<a name="l00798"></a>00798                 <span class="keywordflow">if</span> (wi_cmd(sc, <a class="code" href="wlandef_8h.html#b5f21155b03e39e4d64bdbd72aa7690b">WI_CMD_INQUIRE</a>, <a class="code" href="wlandef_8h.html#be7a03c706a24096b098b4874e10c43b">WI_INFO_HOST_SCAN_RESULTS</a>, 0, 0)
<a name="l00799"></a>00799                     != 0) {
<a name="l00800"></a>00800                     sc-&gt;<a class="code" href="structwi__softc.html#61139a1785f635b7b6bf40da82a9aa9d">sc_scan_timer</a> = 0;
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802                 <span class="keywordflow">break</span>;
<a name="l00803"></a>00803             }
<a name="l00804"></a>00804             <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed16322fdc3044a505e723f3da37f9a6653">IEEE80211_M_STA</a>) {
<a name="l00805"></a>00805                 sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#be4408a291bb63321d97d128cafa0ea0">WI_FLAGS_OUTRANGE</a>;
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807             <span class="keywordflow">break</span>;
<a name="l00808"></a>00808         <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#265b8609233d6463a053568d0c982eb1">WI_INFO_LINK_STAT_DISCONNECTED</a>:
<a name="l00809"></a>00809         <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#178789f19b7e664a31d57d2d5fdcab26">WI_INFO_LINK_STAT_ASSOC_FAILED</a>:
<a name="l00810"></a>00810             <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed16322fdc3044a505e723f3da37f9a6653">IEEE80211_M_STA</a>) {
<a name="l00811"></a>00811                 <a class="code" href="wlandrv_8c.html#cf9151e6667aafff8ee2aa86d01db112">ieee80211_new_state</a>(ic, <a class="code" href="wlandrv_8h.html#6c8e7861891c9e21e6a02ccdba5149445ddfd615e2f7a05d83ae61a24fa84692">IEEE80211_S_INIT</a>, -1);
<a name="l00812"></a>00812             }
<a name="l00813"></a>00813             <span class="keywordflow">break</span>;
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815         <span class="keywordflow">break</span>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#e357fc8d73f5e77eb48cfdc249c6845c">WI_INFO_COUNTERS</a>:
<a name="l00818"></a>00818 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l00819"></a>00819 <span class="preprocessor"></span>        <span class="comment">/*</span>
<a name="l00820"></a>00820 <span class="comment">         * I think we does not need the counter,</span>
<a name="l00821"></a>00821 <span class="comment">         * therefore it can be take longer to implement it.</span>
<a name="l00822"></a>00822 <span class="comment">         */</span>
<a name="l00823"></a>00823 
<a name="l00824"></a>00824         <span class="comment">/*</span>
<a name="l00825"></a>00825 <span class="comment">         * some card versions have a larger stats structure</span>
<a name="l00826"></a>00826 <span class="comment">         */</span>
<a name="l00827"></a>00827         len = <a class="code" href="group__xg_t_c_p.html#gc6afabdc09a49a433ee19d8a9486056d">min</a>(<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[0]) - 1, <span class="keyword">sizeof</span>(sc-&gt;sc_stats) / 4);
<a name="l00828"></a>00828         ptr = (<a class="code" href="wlantypes_8h.html#cb58d6261a51ba1d6fd4d00de0872f84">u_int32_t</a> *) &amp; sc-&gt;sc_stats;
<a name="l00829"></a>00829         off = <span class="keyword">sizeof</span>(ltbuf);
<a name="l00830"></a>00830         <span class="keywordflow">for</span> (i = 0; i &lt; len; i++, off += 2, ptr++) {
<a name="l00831"></a>00831             wi_read_bap(sc, fid, off, &amp;stat, <span class="keyword">sizeof</span>(stat));
<a name="l00832"></a>00832 <span class="preprocessor">#ifdef WI_HERMES_STATS_WAR</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (stat &amp; 0xf000) {
<a name="l00834"></a>00834                 stat = ~stat;
<a name="l00835"></a>00835             }
<a name="l00836"></a>00836 <span class="preprocessor">#endif</span>
<a name="l00837"></a>00837 <span class="preprocessor"></span>            *ptr += stat;
<a name="l00838"></a>00838         }
<a name="l00839"></a>00839         ifp-&gt;if_collisions = sc-&gt;sc_stats.wi_tx_single_retries + sc-&gt;sc_stats.wi_tx_multi_retries + sc-&gt;sc_stats.wi_tx_retry_limit;
<a name="l00840"></a>00840 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l00841"></a>00841         <span class="keywordflow">break</span>;
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l00844"></a>00844 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#a335e4ff9afd9ede9cbda08cc99b8181">WI_INFO_SCAN_RESULTS</a>:
<a name="l00845"></a>00845     <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#be7a03c706a24096b098b4874e10c43b">WI_INFO_HOST_SCAN_RESULTS</a>:
<a name="l00846"></a>00846         wi_scan_result(sc, fid, <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[0]));
<a name="l00847"></a>00847         <span class="keywordflow">break</span>;
<a name="l00848"></a>00848 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="keywordflow">default</span>:
<a name="l00851"></a>00851         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_info_intr: got fid %x type %x len %d\n"</span>, fid, <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[1]), <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ltbuf[0])));
<a name="l00852"></a>00852         <span class="keywordflow">break</span>;
<a name="l00853"></a>00853     }
<a name="l00854"></a>00854     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, <a class="code" href="wlandef_8h.html#768f0c9a423317266f0b1c360a07c879">WI_EV_INFO</a>);
<a name="l00855"></a>00855 }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857 <span class="comment">/************************************************************/</span>
<a name="l00858"></a>00858 <span class="comment">/*  wi_rx_intr                                              */</span>
<a name="l00859"></a>00859 <span class="comment">/************************************************************/</span>
<a name="l00860"></a>00860 <span class="keyword">static</span> NETBUF *wi_rx_intr(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l00861"></a>00861 {
<a name="l00862"></a>00862     <span class="comment">// struct ieee80211com *ic = &amp;sc-&gt;sc_ic; /* Harald: Not used */</span>
<a name="l00863"></a>00863     <span class="keyword">struct </span>wi_frame frmhdr;
<a name="l00864"></a>00864     <span class="keywordtype">int</span> fid, len, off;
<a name="l00865"></a>00865     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> status;
<a name="l00866"></a>00866     <span class="keywordtype">int</span> error;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     NETBUF *nb = 0;
<a name="l00869"></a>00869     LLCS_SNAP_HEADER *pLLCSSNAPHeader;
<a name="l00870"></a>00870     <a class="code" href="struct_e_t_h_e_r_h_d_r.html">ETHERHDR</a> LABBuffer;
<a name="l00871"></a>00871     <a class="code" href="struct_e_t_h_e_r_h_d_r.html">ETHERHDR</a> MAC802_3;
<a name="l00872"></a>00872     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> *pFrameBuffer = 0; <span class="comment">/* Harald: Missing init */</span>
<a name="l00873"></a>00873     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> *pBytePointer;
<a name="l00874"></a>00874     <span class="keywordtype">int</span> copy_size = 0;          <span class="comment">/* Harald: Missing init */</span>
<a name="l00875"></a>00875     <span class="keywordtype">int</span> size;
<a name="l00876"></a>00876     <span class="keywordtype">int</span> IPFrame = 0;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) {
<a name="l00879"></a>00879         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_rx_intr gone\r\n"</span>));
<a name="l00880"></a>00880         <span class="keywordflow">return</span> (0);
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883     fid = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#101469232366c29eb865cb9212643986">WI_RX_FID</a>);
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="comment">/*</span>
<a name="l00886"></a>00886 <span class="comment">     * First read in the frame header</span>
<a name="l00887"></a>00887 <span class="comment">     */</span>
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (wi_read_bap(sc, fid, 0, &amp;frmhdr, <span class="keyword">sizeof</span>(frmhdr))) {
<a name="l00889"></a>00889         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, <a class="code" href="wlandef_8h.html#2e1a2fe1474af0122d2dcb91ff80dd0d">WI_EV_RX</a>);
<a name="l00890"></a>00890         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_rx_intr: read fid %x failed\n"</span>, fid));
<a name="l00891"></a>00891         <span class="keywordflow">return</span> 0;
<a name="l00892"></a>00892     }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894     <span class="comment">/*</span>
<a name="l00895"></a>00895 <span class="comment">     * Drop undecryptable or packets with receive errors here</span>
<a name="l00896"></a>00896 <span class="comment">     */</span>
<a name="l00897"></a>00897     status = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(frmhdr.wi_status);
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (status &amp; <a class="code" href="wlandef_8h.html#46b9660e214d96e0578b75046ef9df7f">WI_STAT_ERRSTAT</a>) {
<a name="l00899"></a>00899         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, <a class="code" href="wlandef_8h.html#2e1a2fe1474af0122d2dcb91ff80dd0d">WI_EV_RX</a>);
<a name="l00900"></a>00900         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_rx_intr: fid %x error status %x\n"</span>, fid, status));
<a name="l00901"></a>00901         <span class="keywordflow">return</span> 0;
<a name="l00902"></a>00902     }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904     <span class="comment">/*</span>
<a name="l00905"></a>00905 <span class="comment">     * Catch the MAC 802.3 header</span>
<a name="l00906"></a>00906 <span class="comment">     */</span>
<a name="l00907"></a>00907     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(MAC802_3.<a class="code" href="struct_e_t_h_e_r_h_d_r.html#cedf67f6cc335aa65055efc58cf1b41e" title="Destination MAC address.">ether_dhost</a>, frmhdr.wi_ehdr.ether_dhost, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l00908"></a>00908     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(MAC802_3.<a class="code" href="struct_e_t_h_e_r_h_d_r.html#943cadf0fcb742e9ad9ad1f3b5185f93" title="Source MAC address.">ether_shost</a>, frmhdr.wi_ehdr.ether_shost, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l00909"></a>00909     <span class="comment">/*</span>
<a name="l00910"></a>00910 <span class="comment">     * The ether_type comes later</span>
<a name="l00911"></a>00911 <span class="comment">     */</span>
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     <span class="comment">/*</span>
<a name="l00914"></a>00914 <span class="comment">     * Get the frame length, at this point I don't know</span>
<a name="l00915"></a>00915 <span class="comment">     * if it is a RFC1024 or RFC894 frame. But Ethernut need</span>
<a name="l00916"></a>00916 <span class="comment">     * an RFC894 frame! So we will alloc the NetBuffer later.</span>
<a name="l00917"></a>00917 <span class="comment">     */</span>
<a name="l00918"></a>00918     len = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(frmhdr.wi_dat_len);
<a name="l00919"></a>00919     off = <span class="keyword">sizeof</span>(frmhdr);
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <span class="comment">/*</span>
<a name="l00922"></a>00922 <span class="comment">     * Sometimes the PRISM2.x returns bogusly large frames. Except</span>
<a name="l00923"></a>00923 <span class="comment">     * in monitor mode, just throw them away.</span>
<a name="l00924"></a>00924 <span class="comment">     */</span>
<a name="l00925"></a>00925     <span class="keywordflow">if</span> (len &gt; <a class="code" href="wlandrv_8c.html#7d64f5982d43e13302cf283f81cdf31e">WLAN_MAX_ETHERNET_FRAME_LEN</a>) {
<a name="l00926"></a>00926         <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, <a class="code" href="wlandef_8h.html#2e1a2fe1474af0122d2dcb91ff80dd0d">WI_EV_RX</a>);
<a name="l00927"></a>00927         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_rx_intr: oversized packet\n"</span>));
<a name="l00928"></a>00928         <span class="keywordflow">return</span> (0);
<a name="l00929"></a>00929     }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931     <span class="comment">/*</span>
<a name="l00932"></a>00932 <span class="comment">     * First read the LookAheadBuffer</span>
<a name="l00933"></a>00933 <span class="comment">     */</span>
<a name="l00934"></a>00934     error = wi_read_bap(sc, fid, off, &amp;LABBuffer, <span class="keyword">sizeof</span>(LABBuffer));
<a name="l00935"></a>00935     off += <span class="keyword">sizeof</span>(LABBuffer);
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="keywordflow">if</span> (error == 0) {
<a name="l00938"></a>00938         <span class="comment">/*</span>
<a name="l00939"></a>00939 <span class="comment">         * Check if this is a 802.2 LLC 802.2 SNAP IP-Header RFC1024</span>
<a name="l00940"></a>00940 <span class="comment">         */</span>
<a name="l00941"></a>00941         pLLCSSNAPHeader = (LLCS_SNAP_HEADER *) &amp; LABBuffer;
<a name="l00942"></a>00942         <span class="keywordflow">if</span> ((pLLCSSNAPHeader-&gt;DSAPSSAP == 0xAAAA) &amp;&amp; (pLLCSSNAPHeader-&gt;Control == 0x0003) &amp;&amp; (pLLCSSNAPHeader-&gt;MustZero == 0x0000)) {
<a name="l00943"></a>00943 
<a name="l00944"></a>00944             <span class="keywordflow">if</span> ((pLLCSSNAPHeader-&gt;Type == 0x0608) || (pLLCSSNAPHeader-&gt;Type == 0x0008)) {
<a name="l00945"></a>00945 
<a name="l00946"></a>00946 <span class="preprocessor">#if (WLAN_ENABLE_RX_FRAME_DUMP &gt;= 1)</span>
<a name="l00947"></a>00947 <span class="preprocessor"></span>                <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"RFC1024 IP-Frame\n"</span>));
<a name="l00948"></a>00948 <span class="preprocessor">#endif</span>
<a name="l00949"></a>00949 <span class="preprocessor"></span>
<a name="l00950"></a>00950                 IPFrame = 1;
<a name="l00951"></a>00951                 MAC802_3.<a class="code" href="struct_e_t_h_e_r_h_d_r.html#1bfbf7b5a2275bc18f206497f52cc32d" title="Protocol type.">ether_type</a> = pLLCSSNAPHeader-&gt;Type;
<a name="l00952"></a>00952 
<a name="l00953"></a>00953                 <span class="comment">/*</span>
<a name="l00954"></a>00954 <span class="comment">                 * Now we can calculate the wFrameLength.</span>
<a name="l00955"></a>00955 <span class="comment">                 * It is a RFC1042 Frame, and we must discard the:</span>
<a name="l00956"></a>00956 <span class="comment">                 * DSAP, SSAP, cntl, and the org. code</span>
<a name="l00957"></a>00957 <span class="comment">                 *  1  +  1  +  1        +  3  = 6</span>
<a name="l00958"></a>00958 <span class="comment">                 */</span>
<a name="l00959"></a>00959                 len -= 6;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961                 <span class="comment">/*</span>
<a name="l00962"></a>00962 <span class="comment">                 * The Ethernut need the dest and source address,</span>
<a name="l00963"></a>00963 <span class="comment">                 * therefore add 12 again.</span>
<a name="l00964"></a>00964 <span class="comment">                 */</span>
<a name="l00965"></a>00965                 len += 12;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967                 <span class="comment">/*</span>
<a name="l00968"></a>00968 <span class="comment">                 * The MAC can not handle odd counts, test it.</span>
<a name="l00969"></a>00969 <span class="comment">                 *</span>
<a name="l00970"></a>00970 <span class="comment">                 */</span>
<a name="l00971"></a>00971                 len += 1;
<a name="l00972"></a>00972                 len &amp;= ~1;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974                 <span class="comment">/*</span>
<a name="l00975"></a>00975 <span class="comment">                 * Now alloc the NetBuffer for Ethernut.</span>
<a name="l00976"></a>00976 <span class="comment">                 */</span>
<a name="l00977"></a>00977                 nb = <a class="code" href="group__xgnetbuf.html#g7a733aed1e6c15aaabb6657abe5f4e39" title="Allocate or re-allocate a network buffer part.">NutNetBufAlloc</a>(0, <a class="code" href="group__xgnetbuf.html#g76d35e2032a765ab5bd310cf47841d18" title="Datalink buffer allocated flag.">NBAF_DATALINK</a>, len);
<a name="l00978"></a>00978                 <span class="keywordflow">if</span> (nb != 0) {
<a name="l00979"></a>00979                     pFrameBuffer = nb-&gt;nb_dl.vp;
<a name="l00980"></a>00980 
<a name="l00981"></a>00981                     <span class="comment">/*</span>
<a name="l00982"></a>00982 <span class="comment">                     * We must copy wFrameLength out of the MAC</span>
<a name="l00983"></a>00983 <span class="comment">                     */</span>
<a name="l00984"></a>00984                     copy_size = len;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986                     <span class="comment">/*</span>
<a name="l00987"></a>00987 <span class="comment">                     * Copy the MAC 802.3 Header</span>
<a name="l00988"></a>00988 <span class="comment">                     */</span>
<a name="l00989"></a>00989                     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(pFrameBuffer, &amp;MAC802_3, <span class="keyword">sizeof</span>(MAC802_3));
<a name="l00990"></a>00990                     pFrameBuffer += <span class="keyword">sizeof</span>(MAC802_3);
<a name="l00991"></a>00991                     copy_size -= <span class="keyword">sizeof</span>(MAC802_3);      <span class="comment">/* This was already in the WLANHeader */</span>
<a name="l00992"></a>00992 
<a name="l00993"></a>00993                     <span class="comment">/*</span>
<a name="l00994"></a>00994 <span class="comment">                     * Now we have some data in our LABBuffer which we need</span>
<a name="l00995"></a>00995 <span class="comment">                     */</span>
<a name="l00996"></a>00996                     pBytePointer = (<a class="code" href="wlantypes_8h.html#4ae1dab0fb4b072a66584546209e7d58">BYTE</a> *) &amp; LABBuffer;
<a name="l00997"></a>00997                     <span class="comment">/*</span>
<a name="l00998"></a>00998 <span class="comment">                     * jump over the header</span>
<a name="l00999"></a>00999 <span class="comment">                     */</span>
<a name="l01000"></a>01000                     pBytePointer += <span class="keyword">sizeof</span>(LLCS_SNAP_HEADER);
<a name="l01001"></a>01001                     <span class="comment">/*</span>
<a name="l01002"></a>01002 <span class="comment">                     * and copy the rest</span>
<a name="l01003"></a>01003 <span class="comment">                     */</span>
<a name="l01004"></a>01004                     size = <span class="keyword">sizeof</span>(LABBuffer) - <span class="keyword">sizeof</span>(LLCS_SNAP_HEADER);
<a name="l01005"></a>01005                     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(pFrameBuffer, pBytePointer, size);
<a name="l01006"></a>01006                     <span class="comment">/*</span>
<a name="l01007"></a>01007 <span class="comment">                     * Change the pointer for the "global copy"</span>
<a name="l01008"></a>01008 <span class="comment">                     */</span>
<a name="l01009"></a>01009                     pFrameBuffer += size;
<a name="l01010"></a>01010                     copy_size -= size;  <span class="comment">/* This was already in the LookAheadBuffer */</span>
<a name="l01011"></a>01011                 } <span class="keywordflow">else</span> {
<a name="l01012"></a>01012                     IPFrame = 0;
<a name="l01013"></a>01013                 }
<a name="l01014"></a>01014             }                   <span class="comment">/* only ARP and IP */</span>
<a name="l01015"></a>01015         } <span class="keywordflow">else</span> {
<a name="l01016"></a>01016             <span class="comment">/*</span>
<a name="l01017"></a>01017 <span class="comment">             * Check if this is a RFX894 Frame</span>
<a name="l01018"></a>01018 <span class="comment">             */</span>
<a name="l01019"></a>01019             <span class="keywordflow">if</span> ((LABBuffer.<a class="code" href="struct_e_t_h_e_r_h_d_r.html#1bfbf7b5a2275bc18f206497f52cc32d" title="Protocol type.">ether_type</a> == 0x0608) || (LABBuffer.<a class="code" href="struct_e_t_h_e_r_h_d_r.html#1bfbf7b5a2275bc18f206497f52cc32d" title="Protocol type.">ether_type</a> == 0x0008)) {
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="preprocessor">#if (WLAN_ENABLE_RX_FRAME_DUMP &gt;= 1)</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>                <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"RFC894 IP-Frame\n"</span>));
<a name="l01023"></a>01023 <span class="preprocessor">#endif</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span>
<a name="l01025"></a>01025                 IPFrame = 1;
<a name="l01026"></a>01026 
<a name="l01027"></a>01027                 <span class="comment">/*</span>
<a name="l01028"></a>01028 <span class="comment">                 * The MAC can not handle odd counts, test it.</span>
<a name="l01029"></a>01029 <span class="comment">                 *</span>
<a name="l01030"></a>01030 <span class="comment">                 */</span>
<a name="l01031"></a>01031                 len += 1;
<a name="l01032"></a>01032                 len &amp;= ~1;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034                 <span class="comment">/*</span>
<a name="l01035"></a>01035 <span class="comment">                 * The FrameLength is now the correct length for an RFC894 Frame,</span>
<a name="l01036"></a>01036 <span class="comment">                 * Now alloc the NetBuffer for Ethernut.</span>
<a name="l01037"></a>01037 <span class="comment">                 */</span>
<a name="l01038"></a>01038                 nb = <a class="code" href="group__xgnetbuf.html#g7a733aed1e6c15aaabb6657abe5f4e39" title="Allocate or re-allocate a network buffer part.">NutNetBufAlloc</a>(0, <a class="code" href="group__xgnetbuf.html#g76d35e2032a765ab5bd310cf47841d18" title="Datalink buffer allocated flag.">NBAF_DATALINK</a>, len);
<a name="l01039"></a>01039                 <span class="keywordflow">if</span> (nb != 0) {
<a name="l01040"></a>01040                     pFrameBuffer = nb-&gt;nb_dl.vp;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042                     <span class="comment">/*</span>
<a name="l01043"></a>01043 <span class="comment">                     * We must copy wFrameLength out of the MAC</span>
<a name="l01044"></a>01044 <span class="comment">                     */</span>
<a name="l01045"></a>01045                     copy_size = len;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047                     <span class="comment">/*</span>
<a name="l01048"></a>01048 <span class="comment">                     * The LookAheadBuffer is the MAC-Header</span>
<a name="l01049"></a>01049 <span class="comment">                     */</span>
<a name="l01050"></a>01050                     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(pFrameBuffer, &amp;LABBuffer, <span class="keyword">sizeof</span>(LABBuffer));
<a name="l01051"></a>01051                     pFrameBuffer += <span class="keyword">sizeof</span>(LABBuffer);
<a name="l01052"></a>01052                     copy_size -= <span class="keyword">sizeof</span>(LABBuffer);     <span class="comment">/* This was our LookAheadBuffer */</span>
<a name="l01053"></a>01053                 } <span class="keywordflow">else</span> {
<a name="l01054"></a>01054                     IPFrame = 0;
<a name="l01055"></a>01055                 }               <span class="comment">/* NutNetBufAlloc */</span>
<a name="l01056"></a>01056             }                   <span class="comment">/* RFC894 Frame */</span>
<a name="l01057"></a>01057         }                       <span class="comment">/* Error read LookAheadBuffer */</span>
<a name="l01058"></a>01058 
<a name="l01059"></a>01059         <span class="comment">/*</span>
<a name="l01060"></a>01060 <span class="comment">         * Do the rest here, "global copy"</span>
<a name="l01061"></a>01061 <span class="comment">         */</span>
<a name="l01062"></a>01062         <span class="keywordflow">if</span> (IPFrame == 1) {
<a name="l01063"></a>01063             error = wi_read_bap(sc, fid, off, pFrameBuffer, copy_size);
<a name="l01064"></a>01064             <span class="keywordflow">if</span> (error != 0) {
<a name="l01065"></a>01065                 <a class="code" href="group__xgnetbuf.html#g2e14a135152823a816388f50bdb3ea3f" title="Release a network buffer structure.">NutNetBufFree</a>(nb);
<a name="l01066"></a>01066                 nb = NULL;
<a name="l01067"></a>01067             } <span class="keywordflow">else</span> {
<a name="l01068"></a>01068 <span class="preprocessor">#if (WLAN_ENABLE_RX_FRAME_DUMP &gt;= 1)</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span>                <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"RxFrame: %d\n"</span>, len));
<a name="l01070"></a>01070                 <a class="code" href="wlandrv_8c.html#74d150886c2f5c4d2d27514d643c6b80">DumpWlanData</a>(nb-&gt;nb_dl.vp, nb-&gt;nb_dl.sz);
<a name="l01071"></a>01071 <span class="preprocessor">#endif</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span>            }
<a name="l01073"></a>01073         }
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="comment">/*</span>
<a name="l01077"></a>01077 <span class="comment">     * At least, send a ack for the event</span>
<a name="l01078"></a>01078 <span class="comment">     */</span>
<a name="l01079"></a>01079     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, <a class="code" href="wlandef_8h.html#2e1a2fe1474af0122d2dcb91ff80dd0d">WI_EV_RX</a>);
<a name="l01080"></a>01080 
<a name="l01081"></a>01081     <span class="keywordflow">return</span> (nb);
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084 <span class="comment">/************************************************************/</span>
<a name="l01085"></a>01085 <span class="comment">/*  RxThread                                                */</span>
<a name="l01086"></a>01086 <span class="comment">/************************************************************/</span>
<a name="l01087"></a><a class="code" href="wlandrv_8c.html#63420a919aa1aab627df1b2257c6953e">01087</a> <a class="code" href="thread_8h.html#9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a class="code" href="wlandrv_8c.html#63420a919aa1aab627df1b2257c6953e">RxThread</a>, arg)
<a name="l01088"></a>01088 {
<a name="l01089"></a>01089     NUTDEVICE *dev;
<a name="l01090"></a>01090     IFNET *ifn;
<a name="l01091"></a>01091     NETBUF *nb;
<a name="l01092"></a>01092     <span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *sc;
<a name="l01093"></a>01093     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> <a class="code" href="structwi__softc.html#50563522c68f28c395a808e645257c1b">EventStatus</a>;
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     dev = arg;
<a name="l01096"></a>01096     ifn = (IFNET *) dev-&gt;dev_icb;
<a name="l01097"></a>01097     sc = (<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *) dev-&gt;dev_dcb;
<a name="l01098"></a>01098 
<a name="l01099"></a>01099     <span class="keywordflow">for</span> (;;) {
<a name="l01100"></a>01100         <span class="comment">/*</span>
<a name="l01101"></a>01101 <span class="comment">         * Wait for the arrival of new packets or check</span>
<a name="l01102"></a>01102 <span class="comment">         * the receiver every two second.</span>
<a name="l01103"></a>01103 <span class="comment">         */</span>
<a name="l01104"></a>01104         <a class="code" href="group__xg_event.html#g79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;sc-&gt;<a class="code" href="structwi__softc.html#7f48501eabd729cc03a49c9d68f1f60e">InterruptEvent</a>, 2000);
<a name="l01105"></a>01105         EventStatus = sc-&gt;<a class="code" href="structwi__softc.html#50563522c68f28c395a808e645257c1b">EventStatus</a>;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107         <span class="comment">/*</span>
<a name="l01108"></a>01108 <span class="comment">         * Clear the sc-EventStatus. If the next time the</span>
<a name="l01109"></a>01109 <span class="comment">         * EventStatus is 0, it was the timeout and not</span>
<a name="l01110"></a>01110 <span class="comment">         * an interrupt.</span>
<a name="l01111"></a>01111 <span class="comment">         */</span>
<a name="l01112"></a>01112         sc-&gt;<a class="code" href="structwi__softc.html#50563522c68f28c395a808e645257c1b">EventStatus</a> = 0;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">if</span> (EventStatus != 0) {
<a name="l01115"></a>01115             <span class="keywordflow">if</span> (EventStatus &amp; <a class="code" href="wlandef_8h.html#2e1a2fe1474af0122d2dcb91ff80dd0d">WI_EV_RX</a>) {
<a name="l01116"></a>01116                 <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l01117"></a>01117                 nb = wi_rx_intr(sc);
<a name="l01118"></a>01118                 <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l01119"></a>01119 
<a name="l01120"></a>01120                 <span class="keywordflow">if</span> (nb != 0) {
<a name="l01121"></a>01121                     (*ifn-&gt;if_recv) (dev, nb);
<a name="l01122"></a>01122                 }
<a name="l01123"></a>01123             }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125             <span class="keywordflow">if</span> (EventStatus &amp; <a class="code" href="wlandef_8h.html#ce85c56466d97cd99ab89a9c4b19a007">WI_EV_ALLOC</a>) {
<a name="l01126"></a>01126                 <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l01127"></a>01127                 wi_tx_intr(sc);
<a name="l01128"></a>01128                 <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l01129"></a>01129             }
<a name="l01130"></a>01130 
<a name="l01131"></a>01131             <span class="keywordflow">if</span> (EventStatus &amp; <a class="code" href="wlandef_8h.html#768f0c9a423317266f0b1c360a07c879">WI_EV_INFO</a>) {
<a name="l01132"></a>01132                 <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l01133"></a>01133                 wi_info_intr(sc);
<a name="l01134"></a>01134                 <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l01135"></a>01135             }
<a name="l01136"></a>01136 
<a name="l01137"></a>01137             <span class="keywordflow">if</span> (EventStatus &amp; <a class="code" href="wlandef_8h.html#fe22b2ea516e791edc9f8dcbed281ba1">WI_EV_TX_EXC</a>) {
<a name="l01138"></a>01138                 <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"WI_EV_TX_EXC\n"</span>));
<a name="l01139"></a>01139             }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141 
<a name="l01142"></a>01142             <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#78962f3ef0c16eb5d61d19d889a499f1">WI_INT_EN</a>, <a class="code" href="wlandrv_8c.html#ba1d837c101dad261ae0df7b05bc07d1">WI_INTRS</a>);
<a name="l01143"></a>01143         } <span class="keywordflow">else</span> {
<a name="l01144"></a>01144             <span class="comment">/*</span>
<a name="l01145"></a>01145 <span class="comment">             * It was the timeout, check if the card is alive</span>
<a name="l01146"></a>01146 <span class="comment">             */</span>
<a name="l01147"></a>01147             <span class="keywordflow">if</span> ((sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a> == 1) &amp;&amp; (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> == 1)) {
<a name="l01148"></a>01148                 <span class="comment">/*</span>
<a name="l01149"></a>01149 <span class="comment">                 * The card was enabled but we has lost the card, reinit...</span>
<a name="l01150"></a>01150 <span class="comment">                 */</span>
<a name="l01151"></a>01151                 <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"Houston, we have a problem...\n"</span>));
<a name="l01152"></a>01152                 sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a> = 0;
<a name="l01153"></a>01153                 <a class="code" href="wlandrv_8h.html#1998f301e3afcbf4f8e6c8cf48efb6f3">wlandrv_Init</a>(dev);
<a name="l01154"></a>01154             }
<a name="l01155"></a>01155         }                       <span class="comment">/* (EventStatus != 0) */</span>
<a name="l01156"></a>01156     }                           <span class="comment">/* for */</span>
<a name="l01157"></a>01157 }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159 <span class="comment">/************************************************************/</span>
<a name="l01160"></a>01160 <span class="comment">/*  wi_alloc_fid                                            */</span>
<a name="l01161"></a>01161 <span class="comment">/************************************************************/</span>
<a name="l01162"></a>01162 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_alloc_fid(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> len, <span class="keywordtype">int</span> *idp)
<a name="l01163"></a>01163 {
<a name="l01164"></a>01164     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i;                     <span class="comment">/* Harald: Changed from int to long */</span>
<a name="l01165"></a>01165                                          <span class="comment">/* Oliver: Changed from signed to unsigned */</span>
<a name="l01166"></a>01166 
<a name="l01167"></a>01167     <span class="keywordflow">if</span> (wi_cmd(sc, <a class="code" href="wlandef_8h.html#4d45427f44891e018aefc6563745e2a5">WI_CMD_ALLOC_MEM</a>, len, 0, 0)) {
<a name="l01168"></a>01168         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"failed to allocate %d bytes on NIC\n"</span>, len));
<a name="l01169"></a>01169         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#6a05c923dad0c1208043e9c20a58c8e5">ENOMEM</a>;
<a name="l01170"></a>01170     }
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="keywordflow">for</span> (i = 0; i &lt; WI_TIMEOUT; i++) {
<a name="l01173"></a>01173         <span class="keywordflow">if</span> (<a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#3979e1a080ffb89f63874f2d1cf4120b">WI_EVENT_STAT</a>) &amp; <a class="code" href="wlandef_8h.html#ce85c56466d97cd99ab89a9c4b19a007">WI_EV_ALLOC</a>) {
<a name="l01174"></a>01174             <span class="keywordflow">break</span>;
<a name="l01175"></a>01175         }
<a name="l01176"></a>01176         <span class="keywordflow">if</span> (i == WI_TIMEOUT) {
<a name="l01177"></a>01177             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"timeout in alloc\n"</span>));
<a name="l01178"></a>01178             <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>;
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180         DELAY(1);
<a name="l01181"></a>01181     }
<a name="l01182"></a>01182     *idp = <a class="code" href="wlandrv_8c.html#e1c05c4d98fa7e74a924f5a37c01b96b">CSR_READ_2</a>(sc, <a class="code" href="wlandef_8h.html#fd5d05179b6d756dd4e4f2a6fe577882">WI_ALLOC_FID</a>);
<a name="l01183"></a>01183     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#1fe47bf041945de0d847d3529108bc08">WI_EVENT_ACK</a>, WI_EV_ALLOC);
<a name="l01184"></a>01184     <span class="keywordflow">return</span> 0;
<a name="l01185"></a>01185 }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187 <span class="comment">/************************************************************/</span>
<a name="l01188"></a>01188 <span class="comment">/*  wi_write_ssid                                           */</span>
<a name="l01189"></a>01189 <span class="comment">/************************************************************/</span>
<a name="l01190"></a>01190 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_write_ssid(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc, <span class="keywordtype">int</span> rid, <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> * buf, <span class="keywordtype">int</span> buflen)
<a name="l01191"></a>01191 {
<a name="l01192"></a>01192     <span class="keyword">struct </span>wi_ssid ssid;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="keywordflow">if</span> (buflen &gt; <a class="code" href="wlandrv_8h.html#dc15f02fa363856549741ee2a63fee03">IEEE80211_NWID_LEN</a>) {
<a name="l01195"></a>01195         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#9e655f47bfd914a1174f281fc31cf63d">ENOBUFS</a>;
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(&amp;ssid, 0, <span class="keyword">sizeof</span>(ssid));
<a name="l01198"></a>01198     ssid.wi_len = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(buflen);
<a name="l01199"></a>01199     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(ssid.wi_ssid, buf, buflen);
<a name="l01200"></a>01200     <span class="keywordflow">return</span> wi_write_rid(sc, rid, &amp;ssid, <span class="keyword">sizeof</span>(ssid));
<a name="l01201"></a>01201 }
<a name="l01202"></a>01202 
<a name="l01203"></a>01203 <span class="comment">/************************************************************/</span>
<a name="l01204"></a>01204 <span class="comment">/*  wi_read_nicid                                           */</span>
<a name="l01205"></a>01205 <span class="comment">/************************************************************/</span>
<a name="l01206"></a>01206 <span class="keyword">static</span> <span class="keywordtype">void</span> wi_read_nicid(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l01207"></a>01207 {
<a name="l01208"></a>01208     <span class="keyword">struct </span>wi_card_ident *id;
<a name="l01209"></a>01209     <span class="keywordtype">char</span> *p;
<a name="l01210"></a>01210     <span class="keywordtype">int</span> len;
<a name="l01211"></a>01211     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> ver[4];
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="comment">/*</span>
<a name="l01214"></a>01214 <span class="comment">     * getting chip identity</span>
<a name="l01215"></a>01215 <span class="comment">     */</span>
<a name="l01216"></a>01216     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ver, 0, <span class="keyword">sizeof</span>(ver));
<a name="l01217"></a>01217     len = <span class="keyword">sizeof</span>(ver);
<a name="l01218"></a>01218     wi_read_rid(sc, <a class="code" href="wlandef_8h.html#ff4a682be9c8817640e1455d4ae7cae8">WI_RID_CARD_ID</a>, ver, &amp;len);
<a name="l01219"></a>01219     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"using "</span>));
<a name="l01220"></a>01220 
<a name="l01221"></a>01221     sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> = <a class="code" href="wlandef_8h.html#ee21730d86630d5929b20d91868e15f3">WI_NOTYPE</a>;
<a name="l01222"></a>01222     <span class="keywordflow">for</span> (<span class="keywordtype">id</span> = wi_card_ident; <span class="keywordtype">id</span>-&gt;card_name != NULL; <span class="keywordtype">id</span>++) {
<a name="l01223"></a>01223         <span class="keywordflow">if</span> (<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[0]) == id-&gt;card_id) {
<a name="l01224"></a>01224             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"%s"</span>, id-&gt;card_name));
<a name="l01225"></a>01225             sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> = <span class="keywordtype">id</span>-&gt;firm_type;
<a name="l01226"></a>01226             <span class="keywordflow">break</span>;
<a name="l01227"></a>01227         }
<a name="l01228"></a>01228     }
<a name="l01229"></a>01229     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ee21730d86630d5929b20d91868e15f3">WI_NOTYPE</a>) {
<a name="l01230"></a>01230         <span class="keywordflow">if</span> (<a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[0]) &amp; 0x8000) {
<a name="l01231"></a>01231             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"Unknown PRISM2 chip"</span>));
<a name="l01232"></a>01232             sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> = <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>;
<a name="l01233"></a>01233         } <span class="keywordflow">else</span> {
<a name="l01234"></a>01234             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"Unknown Lucent chip"</span>));
<a name="l01235"></a>01235             sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> = <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>;
<a name="l01236"></a>01236         }
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238 
<a name="l01239"></a>01239     <span class="comment">/*</span>
<a name="l01240"></a>01240 <span class="comment">     * get primary firmware version (Only Prism chips)</span>
<a name="l01241"></a>01241 <span class="comment">     */</span>
<a name="l01242"></a>01242     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> != <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>) {
<a name="l01243"></a>01243         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ver, 0, <span class="keyword">sizeof</span>(ver));
<a name="l01244"></a>01244         len = <span class="keyword">sizeof</span>(ver);
<a name="l01245"></a>01245         wi_read_rid(sc, <a class="code" href="wlandef_8h.html#f65552d4472c2096cb47efeb8c9ee32c">WI_RID_PRI_IDENTITY</a>, ver, &amp;len);
<a name="l01246"></a>01246         sc-&gt;<a class="code" href="structwi__softc.html#a33c66160c0eb5ae4d48cc057523cfc9">sc_pri_firmware_ver</a> = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[2]) * 10000 + <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[3]) * 100 + <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[1]);
<a name="l01247"></a>01247     }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249     <span class="comment">/*</span>
<a name="l01250"></a>01250 <span class="comment">     * get station firmware version</span>
<a name="l01251"></a>01251 <span class="comment">     */</span>
<a name="l01252"></a>01252     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ver, 0, <span class="keyword">sizeof</span>(ver));
<a name="l01253"></a>01253     len = <span class="keyword">sizeof</span>(ver);
<a name="l01254"></a>01254     wi_read_rid(sc, <a class="code" href="wlandef_8h.html#bb77ecbaf8cd1d27c3e3491446cb3b1e">WI_RID_STA_IDENTITY</a>, ver, &amp;len);
<a name="l01255"></a>01255     sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[2]) * 10000 + <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[3]) * 100 + <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(ver[1]);
<a name="l01256"></a>01256     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a> &amp;&amp; (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> == 10102 || sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> == 20102)) {
<a name="l01257"></a>01257         <span class="keywordtype">char</span> ident[12];
<a name="l01258"></a>01258         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ident, 0, <span class="keyword">sizeof</span>(ident));
<a name="l01259"></a>01259         len = <span class="keyword">sizeof</span>(ident);
<a name="l01260"></a>01260         <span class="comment">/*</span>
<a name="l01261"></a>01261 <span class="comment">         * value should be the format like "V2.00-11"</span>
<a name="l01262"></a>01262 <span class="comment">         */</span>
<a name="l01263"></a>01263         <span class="keywordflow">if</span> (wi_read_rid(sc, <a class="code" href="wlandef_8h.html#73e58a179d4a6637919c1ab28b7597bd">WI_RID_SYMBOL_IDENTITY</a>, ident, &amp;len) == 0 &amp;&amp;
<a name="l01264"></a>01264             *(p = (<span class="keywordtype">char</span> *) ident) &gt;= <span class="charliteral">'A'</span> &amp;&amp; p[2] == <span class="charliteral">'.'</span> &amp;&amp; p[5] == <span class="charliteral">'-'</span> &amp;&amp; p[8] == <span class="charliteral">'\0'</span>) {
<a name="l01265"></a>01265             sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> = <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a>;
<a name="l01266"></a>01266             sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> = (p[1] - <span class="charliteral">'0'</span>) * 10000 +
<a name="l01267"></a>01267                 (p[3] - <span class="charliteral">'0'</span>) * 1000 + (p[4] - <span class="charliteral">'0'</span>) * 100 + (p[6] - <span class="charliteral">'0'</span>) * 10 + (p[7] - <span class="charliteral">'0'</span>);
<a name="l01268"></a>01268         }
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"\n"</span>));
<a name="l01271"></a>01271     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"%s Firmware: "</span>,
<a name="l01272"></a>01272            sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a> ? <span class="stringliteral">"Lucent"</span> : (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a> ? <span class="stringliteral">"Symbol"</span> : <span class="stringliteral">"Intersil"</span>)));
<a name="l01273"></a>01273     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> != <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>) {    <span class="comment">/* XXX */</span>
<a name="l01274"></a>01274         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"Primary (%ld.%ld.%ld), "</span>,
<a name="l01275"></a>01275                sc-&gt;<a class="code" href="structwi__softc.html#a33c66160c0eb5ae4d48cc057523cfc9">sc_pri_firmware_ver</a> / 10000, (sc-&gt;<a class="code" href="structwi__softc.html#a33c66160c0eb5ae4d48cc057523cfc9">sc_pri_firmware_ver</a> % 10000) / 100, sc-&gt;<a class="code" href="structwi__softc.html#a33c66160c0eb5ae4d48cc057523cfc9">sc_pri_firmware_ver</a> % 100));
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"Station (%ld.%ld.%ld)\n"</span>,
<a name="l01278"></a>01278            sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> / 10000, (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> % 10000) / 100, sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> % 100));
<a name="l01279"></a>01279 }
<a name="l01280"></a>01280 
<a name="l01281"></a>01281 <span class="comment">/************************************************************/</span>
<a name="l01282"></a>01282 <span class="comment">/*  wi_write_wep                                            */</span>
<a name="l01283"></a>01283 <span class="comment">/************************************************************/</span>
<a name="l01284"></a>01284 <span class="keyword">static</span> <span class="keywordtype">int</span> wi_write_wep(<span class="keyword">struct</span> <a class="code" href="structwi__softc.html">wi_softc</a> *sc)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286     <span class="keyword">struct </span><a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l01287"></a>01287     <span class="keywordtype">int</span> error = 0;
<a name="l01288"></a>01288     <span class="keywordtype">int</span> i, keylen;
<a name="l01289"></a>01289     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> val;
<a name="l01290"></a>01290     <span class="keyword">struct </span><a class="code" href="structwi__key.html">wi_key</a> wkey[<a class="code" href="wlandrv_8h.html#44b5f266294d6590b41a06b93e21e117">IEEE80211_WEP_NKID</a>];
<a name="l01291"></a>01291 
<a name="l01292"></a>01292     <span class="keywordflow">switch</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a>) {
<a name="l01293"></a>01293 <span class="preprocessor">#if (WLAN_SUPPORT_LUCENT &gt;= 1)</span>
<a name="l01294"></a>01294 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>:
<a name="l01295"></a>01295         val = (ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp; <a class="code" href="wlandrv_8h.html#c3905a90a078707426b886cf7bd82ad4">IEEE80211_F_WEPON</a>) ? 1 : 0;
<a name="l01296"></a>01296         error = wi_write_val(sc, <a class="code" href="wlandef_8h.html#097c4e1776c6a7336344ea6b69f807f1">WI_RID_ENCRYPTION</a>, val);
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (error)
<a name="l01298"></a>01298             <span class="keywordflow">break</span>;
<a name="l01299"></a>01299         error = wi_write_val(sc, <a class="code" href="wlandef_8h.html#8ee9acd5cc119bf3f6ab0a9802449b7c">WI_RID_TX_CRYPT_KEY</a>, ic-&gt;<a class="code" href="structieee80211com.html#da4daa94eb4a3b7a6f3ecb1064ae006a">ic_wep_txkey</a>);
<a name="l01300"></a>01300         <span class="keywordflow">if</span> (error)
<a name="l01301"></a>01301             <span class="keywordflow">break</span>;
<a name="l01302"></a>01302         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(wkey, 0, <span class="keyword">sizeof</span>(wkey));
<a name="l01303"></a>01303         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="wlandrv_8h.html#44b5f266294d6590b41a06b93e21e117">IEEE80211_WEP_NKID</a>; i++) {
<a name="l01304"></a>01304             keylen = ic-&gt;<a class="code" href="structieee80211com.html#5493386b04479db71c6902000f28cf6c">ic_nw_keys</a>[i].<a class="code" href="structieee80211__wepkey.html#473564b832f4bb52dedabd3a74a821d9">wk_len</a>;
<a name="l01305"></a>01305             wkey[i].wi_keylen = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(keylen);
<a name="l01306"></a>01306             <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(wkey[i].<a class="code" href="structwi__key.html#239a7c2dc6deb0ed190b560aea94c2a1">wi_keydat</a>, ic-&gt;<a class="code" href="structieee80211com.html#5493386b04479db71c6902000f28cf6c">ic_nw_keys</a>[i].<a class="code" href="structieee80211__wepkey.html#2389b70c45e7aa2e87b0438dfe11b6ba">wk_key</a>, keylen);
<a name="l01307"></a>01307         }
<a name="l01308"></a>01308         error = wi_write_rid(sc, <a class="code" href="wlandef_8h.html#269651f081d1dbce94b6e55ab26e6df2">WI_RID_DEFLT_CRYPT_KEYS</a>, wkey, <span class="keyword">sizeof</span>(wkey));
<a name="l01309"></a>01309         <span class="keywordflow">break</span>;
<a name="l01310"></a>01310 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_SUPPORT_LUCENT &gt;= 1) */</span>
<a name="l01311"></a>01311 
<a name="l01312"></a>01312 <span class="preprocessor">#if ((WLAN_SUPPORT_INTERSIL &gt;= 1) || (WLAN_SUPPORT_SYMBOL &gt;= 1))</span>
<a name="l01313"></a>01313 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>:
<a name="l01314"></a>01314     <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a>:
<a name="l01315"></a>01315         <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp; <a class="code" href="wlandrv_8h.html#c3905a90a078707426b886cf7bd82ad4">IEEE80211_F_WEPON</a>) {
<a name="l01316"></a>01316             <span class="comment">/*</span>
<a name="l01317"></a>01317 <span class="comment">             * ONLY HWB3163 EVAL-CARD Firmware version</span>
<a name="l01318"></a>01318 <span class="comment">             * less than 0.8 variant2</span>
<a name="l01319"></a>01319 <span class="comment">             *</span>
<a name="l01320"></a>01320 <span class="comment">             *   If promiscuous mode disable, Prism2 chip</span>
<a name="l01321"></a>01321 <span class="comment">             *  does not work with WEP .</span>
<a name="l01322"></a>01322 <span class="comment">             * It is under investigation for details.</span>
<a name="l01323"></a>01323 <span class="comment">             * (ichiro@netbsd.org)</span>
<a name="l01324"></a>01324 <span class="comment">             */</span>
<a name="l01325"></a>01325             <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a> &amp;&amp; sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &lt; 802) {
<a name="l01326"></a>01326                 <span class="comment">/*</span>
<a name="l01327"></a>01327 <span class="comment">                 * firm ver &lt; 0.8 variant 2</span>
<a name="l01328"></a>01328 <span class="comment">                 */</span>
<a name="l01329"></a>01329                 wi_write_val(sc, <a class="code" href="wlandef_8h.html#6c5c60df2417f4b802e70f91abd1e539">WI_RID_PROMISC</a>, 1);
<a name="l01330"></a>01330             }
<a name="l01331"></a>01331             wi_write_val(sc, <a class="code" href="wlandef_8h.html#237dea8e52fb4daf30176dacc4e5042f">WI_RID_CNFAUTHMODE</a>, sc-&gt;<a class="code" href="structwi__softc.html#ca1e78cf7f15ba297e4fc0c80030ae13">sc_cnfauthmode</a>);
<a name="l01332"></a>01332             val = <a class="code" href="wlandef_8h.html#faa076de451f143ec6996e193396581d">PRIVACY_INVOKED</a> | <a class="code" href="wlandef_8h.html#b2b8053d83456291a2191e859093ee0f">EXCLUDE_UNENCRYPTED</a>;
<a name="l01333"></a>01333             <span class="comment">/*</span>
<a name="l01334"></a>01334 <span class="comment">             * Encryption firmware has a bug for HostAP mode.</span>
<a name="l01335"></a>01335 <span class="comment">             */</span>
<a name="l01336"></a>01336             <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a> &amp;&amp; ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1452d0b2b50ada8160ea00af9456c56fd">IEEE80211_M_HOSTAP</a>) {
<a name="l01337"></a>01337                 val |= <a class="code" href="wlandef_8h.html#8a090cba578d86b3e67ba7dc56ea570f">HOST_ENCRYPT</a>;
<a name="l01338"></a>01338             }
<a name="l01339"></a>01339         } <span class="keywordflow">else</span> {
<a name="l01340"></a>01340             wi_write_val(sc, <a class="code" href="wlandef_8h.html#237dea8e52fb4daf30176dacc4e5042f">WI_RID_CNFAUTHMODE</a>, <a class="code" href="wlandef_8h.html#99fb83031ce9923c84392b4e92f956b51949c2c6f30c8a55ce13af47b8949998">IEEE80211_AUTH_OPEN</a>);
<a name="l01341"></a>01341             val = <a class="code" href="wlandef_8h.html#8a090cba578d86b3e67ba7dc56ea570f">HOST_ENCRYPT</a> | <a class="code" href="wlandef_8h.html#62920aceac00c6dc10326d649b243cda">HOST_DECRYPT</a>;
<a name="l01342"></a>01342         }
<a name="l01343"></a>01343         error = wi_write_val(sc, <a class="code" href="wlandef_8h.html#f14162730dfa7af06922a51bd2f659cb">WI_RID_P2_ENCRYPTION</a>, val);
<a name="l01344"></a>01344         <span class="keywordflow">if</span> (error) {
<a name="l01345"></a>01345             <span class="keywordflow">break</span>;
<a name="l01346"></a>01346         }
<a name="l01347"></a>01347         error = wi_write_val(sc, <a class="code" href="wlandef_8h.html#ae9eda9a7cbb8275ea76369d2148540d">WI_RID_P2_TX_CRYPT_KEY</a>, ic-&gt;<a class="code" href="structieee80211com.html#da4daa94eb4a3b7a6f3ecb1064ae006a">ic_wep_txkey</a>);
<a name="l01348"></a>01348         <span class="keywordflow">if</span> (error) {
<a name="l01349"></a>01349             <span class="keywordflow">break</span>;
<a name="l01350"></a>01350         }
<a name="l01351"></a>01351         <span class="comment">/*</span>
<a name="l01352"></a>01352 <span class="comment">         * It seems that the firmware accept 104bit key only if</span>
<a name="l01353"></a>01353 <span class="comment">         * all the keys have 104bit length.  We get the length of</span>
<a name="l01354"></a>01354 <span class="comment">         * the transmit key and use it for all other keys.</span>
<a name="l01355"></a>01355 <span class="comment">         * Perhaps we should use software WEP for such situation.</span>
<a name="l01356"></a>01356 <span class="comment">         */</span>
<a name="l01357"></a>01357         keylen = ic-&gt;<a class="code" href="structieee80211com.html#5493386b04479db71c6902000f28cf6c">ic_nw_keys</a>[ic-&gt;<a class="code" href="structieee80211com.html#da4daa94eb4a3b7a6f3ecb1064ae006a">ic_wep_txkey</a>].<a class="code" href="structieee80211__wepkey.html#473564b832f4bb52dedabd3a74a821d9">wk_len</a>;
<a name="l01358"></a>01358         <span class="keywordflow">if</span> (keylen &gt; <a class="code" href="wlandrv_8h.html#834418240c92f8b27eb734131acfd807">IEEE80211_WEP_KEYLEN</a>) {
<a name="l01359"></a>01359             keylen = 13;        <span class="comment">/* 104bit keys */</span>
<a name="l01360"></a>01360         } <span class="keywordflow">else</span> {
<a name="l01361"></a>01361             keylen = <a class="code" href="wlandrv_8h.html#834418240c92f8b27eb734131acfd807">IEEE80211_WEP_KEYLEN</a>;
<a name="l01362"></a>01362         }
<a name="l01363"></a>01363         <span class="keywordflow">for</span> (i = 0; i &lt; IEEE80211_WEP_NKID; i++) {
<a name="l01364"></a>01364             error = wi_write_rid(sc, <a class="code" href="wlandef_8h.html#ab189100909d04c6995cecf93b97c1f9">WI_RID_P2_CRYPT_KEY0</a> + i, ic-&gt;<a class="code" href="structieee80211com.html#5493386b04479db71c6902000f28cf6c">ic_nw_keys</a>[i].<a class="code" href="structieee80211__wepkey.html#2389b70c45e7aa2e87b0438dfe11b6ba">wk_key</a>, keylen);
<a name="l01365"></a>01365             <span class="keywordflow">if</span> (error) {
<a name="l01366"></a>01366                 <span class="keywordflow">break</span>;
<a name="l01367"></a>01367             }
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369         <span class="keywordflow">break</span>;
<a name="l01370"></a>01370 <span class="preprocessor">#endif                          </span><span class="comment">/* ((WLAN_SUPPORT_INTERSIL &gt;= 1) || (WLAN_SUPPORT_SYMBOL &gt;= 1)) */</span>
<a name="l01371"></a>01371     }
<a name="l01372"></a>01372     <span class="keywordflow">return</span> error;
<a name="l01373"></a>01373 }
<a name="l01374"></a>01374 
<a name="l01375"></a>01375 <span class="comment">/*==========================================================*/</span>
<a name="l01376"></a>01376 <span class="comment">/*  DEFINE: All code exported                               */</span>
<a name="l01377"></a>01377 <span class="comment">/*==========================================================*/</span>
<a name="l01378"></a>01378 <span class="comment">/************************************************************/</span>
<a name="l01379"></a>01379 <span class="comment">/*  wlandrv_ProbeDevice                                     */</span>
<a name="l01380"></a>01380 <span class="comment">/*                                                          */</span>
<a name="l01381"></a>01381 <span class="comment">/*  Make a HW-Reset and test if a card is available.        */</span>
<a name="l01382"></a>01382 <span class="comment">/*                                                          */</span>
<a name="l01383"></a>01383 <span class="comment">/*  Return: ERROR, OK                                       */</span>
<a name="l01384"></a>01384 <span class="comment">/************************************************************/</span>
<a name="l01385"></a><a class="code" href="wlandrv_8c.html#a5edb30df3e4d978b3effdb88b0aac60">01385</a> <span class="keywordtype">int</span> <a class="code" href="wlandrv_8h.html#a5edb30df3e4d978b3effdb88b0aac60">wlandrv_ProbeDevice</a>(<span class="keywordtype">void</span>)
<a name="l01386"></a>01386 {
<a name="l01387"></a>01387     <span class="keywordtype">int</span> error = -1;
<a name="l01388"></a>01388     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> <a class="code" href="union_value.html">Value</a>;
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     <span class="comment">/*</span>
<a name="l01391"></a>01391 <span class="comment">     * Set RESET</span>
<a name="l01392"></a>01392 <span class="comment">     */</span>
<a name="l01393"></a>01393     <a class="code" href="wlandrv_8h.html#18e6ff4209efae42304b51da736bb3b8">RESET_EN_PORT</a> |= <a class="code" href="wlandrv_8h.html#66f55ddd405ba42949ed56b895cc0fb7">RESET_BIT</a>;
<a name="l01394"></a>01394     <a class="code" href="wlandrv_8h.html#1ed4280c556a9f6d63204cc3ad5b3523">RESET_PORT</a> |= <a class="code" href="wlandrv_8h.html#66f55ddd405ba42949ed56b895cc0fb7">RESET_BIT</a>;
<a name="l01395"></a>01395 
<a name="l01396"></a>01396     <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(100);
<a name="l01397"></a>01397 
<a name="l01398"></a>01398     <span class="comment">/*</span>
<a name="l01399"></a>01399 <span class="comment">     * Remove RESET</span>
<a name="l01400"></a>01400 <span class="comment">     */</span>
<a name="l01401"></a>01401     <a class="code" href="wlandrv_8h.html#1ed4280c556a9f6d63204cc3ad5b3523">RESET_PORT</a> &amp;= ~<a class="code" href="wlandrv_8h.html#66f55ddd405ba42949ed56b895cc0fb7">RESET_BIT</a>;
<a name="l01402"></a>01402 
<a name="l01403"></a>01403     <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(500);
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <span class="comment">/*</span>
<a name="l01406"></a>01406 <span class="comment">     * Set the MAC into I/O mode</span>
<a name="l01407"></a>01407 <span class="comment">     */</span>
<a name="l01408"></a>01408     <a class="code" href="pcmcia_8h.html#66fffb8fb81ae0fde96fe6fc79f0dc5b">pcmcia_WriteMem</a>(<a class="code" href="wlandef_8h.html#0e0dacea6cb540d3ffe2d260613f9b24">WI_COR_OFFSET</a>, <a class="code" href="wlandef_8h.html#b9e285e6554665ee6363cdfa2ca9f4f3">WI_COR_VALUE</a>);
<a name="l01409"></a>01409     <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(100);
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     <span class="comment">/*</span>
<a name="l01412"></a>01412 <span class="comment">     * Test if we can found a card</span>
<a name="l01413"></a>01413 <span class="comment">     */</span>
<a name="l01414"></a>01414     <a class="code" href="pcmcia_8h.html#4475533bf4faa056a26b86d12c059713">pcmcia_WriteReg</a>(<a class="code" href="wlandef_8h.html#c2c068f740e8fd674e278247a42c083a">WI_HFA384X_SWSUPPORT0_OFF</a>, <a class="code" href="wlandef_8h.html#0c5853ae01bc7e00ef25ac185aa384b4">WI_PRISM2STA_MAGIC</a>);
<a name="l01415"></a>01415     Value = <a class="code" href="pcmcia_8h.html#ab2c65756fe5514117d1a3926579ea68">pcmcia_ReadReg</a>(<a class="code" href="wlandef_8h.html#c2c068f740e8fd674e278247a42c083a">WI_HFA384X_SWSUPPORT0_OFF</a>);
<a name="l01416"></a>01416     <span class="keywordflow">if</span> (Value == <a class="code" href="wlandef_8h.html#0c5853ae01bc7e00ef25ac185aa384b4">WI_PRISM2STA_MAGIC</a>) {
<a name="l01417"></a>01417         <span class="comment">/*</span>
<a name="l01418"></a>01418 <span class="comment">         * We found a card :-)</span>
<a name="l01419"></a>01419 <span class="comment">         */</span>
<a name="l01420"></a>01420         error = 0;
<a name="l01421"></a>01421     }
<a name="l01422"></a>01422 
<a name="l01423"></a>01423     <span class="keywordflow">return</span> (error);
<a name="l01424"></a>01424 }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 <span class="comment">/************************************************************/</span>
<a name="l01427"></a>01427 <span class="comment">/*  wlandrv_Attach                                          */</span>
<a name="l01428"></a>01428 <span class="comment">/*                                                          */</span>
<a name="l01429"></a>01429 <span class="comment">/*  Catch all information about the card which              */</span>
<a name="l01430"></a>01430 <span class="comment">/*  could be found. And set some default parameter          */</span>
<a name="l01431"></a>01431 <span class="comment">/*                                                          */</span>
<a name="l01432"></a>01432 <span class="comment">/*  Return: ERROR, OK                                       */</span>
<a name="l01433"></a>01433 <span class="comment">/************************************************************/</span>
<a name="l01434"></a><a class="code" href="wlandrv_8c.html#d917d5ea05d7a3c344e1fa1286333c53">01434</a> <span class="keywordtype">int</span> <a class="code" href="wlandrv_8h.html#d917d5ea05d7a3c344e1fa1286333c53">wlandrv_Attach</a>(<a class="code" href="wlandrv_8h.html#916fff5dd8c87602f2fdaa4592bd3a85">device_t</a> dev)
<a name="l01435"></a>01435 {
<a name="l01436"></a>01436     <span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *sc = <a class="code" href="wlandrv_8h.html#f193aa005ab17744015b45ad2c87a24a">device_get_softc</a>(dev);
<a name="l01437"></a>01437     <span class="keyword">struct </span><a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l01438"></a>01438     <span class="keyword">struct </span><a class="code" href="structieee80211__rateset.html">ieee80211_rateset</a> *rs;
<a name="l01439"></a>01439     <span class="keywordtype">int</span> i, nrates, buflen;
<a name="l01440"></a>01440     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> val;
<a name="l01441"></a>01441     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> ratebuf[2 + <a class="code" href="wlandef_8h.html#32ce6310626a77d6783d0d02c7953f03">IEEE80211_RATE_SIZE</a>];
<a name="l01442"></a>01442     <span class="comment">//u_int8_t empty_macaddr[IEEE80211_ADDR_LEN] = {</span>
<a name="l01443"></a>01443     <span class="comment">//  0x00, 0x00, 0x00, 0x00, 0x00, 0x00</span>
<a name="l01444"></a>01444     <span class="comment">//}; /* Harald: This is unused */</span>
<a name="l01445"></a>01445     <span class="keywordtype">int</span> error;
<a name="l01446"></a>01446 
<a name="l01447"></a>01447     bDebugState = 2;
<a name="l01448"></a>01448 
<a name="l01449"></a>01449     sc-&gt;<a class="code" href="structwi__softc.html#73119ac71e03ad7e23830f81f3ee0cf6">wi_cmd_count</a> = 500;
<a name="l01450"></a>01450     ic-&gt;<a class="code" href="structieee80211com.html#7d714da7c1d6891f063899e3e1bf8156">ic_fixed_rate</a> = -1;     <span class="comment">/* auto */</span>
<a name="l01451"></a>01451 
<a name="l01452"></a>01452 
<a name="l01453"></a>01453     <span class="comment">/*</span>
<a name="l01454"></a>01454 <span class="comment">     * Reset the NIC.</span>
<a name="l01455"></a>01455 <span class="comment">     */</span>
<a name="l01456"></a>01456     <span class="keywordflow">if</span> (wi_reset(sc) != 0) {
<a name="l01457"></a>01457         <span class="keywordflow">return</span> <a class="code" href="errno_8h.html#2b3884b11e4932bd372bb6d899d6fbfe">ENXIO</a>;           <span class="comment">/* XXX */</span>
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     <span class="comment">/*</span>
<a name="l01461"></a>01461 <span class="comment">     * Read the station address.</span>
<a name="l01462"></a>01462 <span class="comment">     * And do it twice. I've seen PRISM-based cards that return</span>
<a name="l01463"></a>01463 <span class="comment">     * an error when trying to read it the first time, which causes</span>
<a name="l01464"></a>01464 <span class="comment">     * the probe to fail.</span>
<a name="l01465"></a>01465 <span class="comment">     */</span>
<a name="l01466"></a>01466     buflen = <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>;
<a name="l01467"></a>01467     error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#c801c1211486b5d12dda56967c608d92">WI_RID_MAC_NODE</a>, ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>, &amp;buflen);
<a name="l01468"></a>01468     <span class="keywordflow">if</span> (error != 0) {
<a name="l01469"></a>01469         buflen = <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>;
<a name="l01470"></a>01470         error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#c801c1211486b5d12dda56967c608d92">WI_RID_MAC_NODE</a>, ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>, &amp;buflen);
<a name="l01471"></a>01471     }
<a name="l01472"></a>01472     <span class="keywordflow">if</span> (error != 0) {
<a name="l01473"></a>01473         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"mac read failed %d\n"</span>, error));
<a name="l01474"></a>01474         <span class="keywordflow">return</span> (error);
<a name="l01475"></a>01475     }
<a name="l01476"></a>01476     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"802.11 address: %02X-%02X-%02X-%02X-%02X-%02X\n"</span>,
<a name="l01477"></a>01477            ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>[0], ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>[1], ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>[2], ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>[3], ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>[4], ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>[5]));
<a name="l01478"></a>01478 
<a name="l01479"></a>01479     <span class="comment">/*</span>
<a name="l01480"></a>01480 <span class="comment">     * Read NIC identification</span>
<a name="l01481"></a>01481 <span class="comment">     */</span>
<a name="l01482"></a>01482     wi_read_nicid(sc);
<a name="l01483"></a>01483 
<a name="l01484"></a>01484     ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> = <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed16322fdc3044a505e723f3da37f9a6653">IEEE80211_M_STA</a>;
<a name="l01485"></a>01485     ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> = <a class="code" href="wlandrv_8h.html#df6c388edba82974ec8594165b9b4261">IEEE80211_C_PMGT</a> | <a class="code" href="wlandrv_8h.html#acdf2b91b64086abf808d592bb6a5c50">IEEE80211_C_AHDEMO</a>;
<a name="l01486"></a>01486     ic-&gt;<a class="code" href="structieee80211com.html#46f3f5f9069850be353e63e1eafbe37c">ic_state</a> = <a class="code" href="wlandrv_8h.html#6c8e7861891c9e21e6a02ccdba5149445ddfd615e2f7a05d83ae61a24fa84692">IEEE80211_S_INIT</a>;
<a name="l01487"></a>01487 
<a name="l01488"></a>01488     <span class="comment">/*</span>
<a name="l01489"></a>01489 <span class="comment">     * Query the card for available channels.</span>
<a name="l01490"></a>01490 <span class="comment">     */</span>
<a name="l01491"></a>01491     buflen = <span class="keyword">sizeof</span>(val);
<a name="l01492"></a>01492     <span class="keywordflow">if</span> (wi_read_rid(sc, <a class="code" href="wlandef_8h.html#45f8bede2765922f3b4a7ba3ac358aae">WI_RID_CHANNEL_LIST</a>, &amp;val, &amp;buflen) != 0) {
<a name="l01493"></a>01493         val = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(0x1fff);  <span class="comment">/* assume 1-13 */</span>
<a name="l01494"></a>01494     }
<a name="l01495"></a>01495     <span class="keywordflow">if</span> (val == 0) {
<a name="l01496"></a>01496         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_attach: no available channels listed!"</span>));
<a name="l01497"></a>01497     }
<a name="l01498"></a>01498     ic-&gt;<a class="code" href="structieee80211com.html#8ca80d98283bb5f86427051fefd26d48">ChannelList</a> = (val &lt;&lt; 1);
<a name="l01499"></a>01499 
<a name="l01500"></a>01500     <span class="comment">/*</span>
<a name="l01501"></a>01501 <span class="comment">     * Read the default channel from the NIC. This may vary</span>
<a name="l01502"></a>01502 <span class="comment">     * depending on the country where the NIC was purchased, so</span>
<a name="l01503"></a>01503 <span class="comment">     * we can't hard-code a default and expect it to work for</span>
<a name="l01504"></a>01504 <span class="comment">     * everyone.</span>
<a name="l01505"></a>01505 <span class="comment">     *</span>
<a name="l01506"></a>01506 <span class="comment">     * If no channel is specified, let the 802.11 code select.</span>
<a name="l01507"></a>01507 <span class="comment">     */</span>
<a name="l01508"></a>01508     buflen = <span class="keyword">sizeof</span>(val);
<a name="l01509"></a>01509     <span class="keywordflow">if</span> (wi_read_rid(sc, <a class="code" href="wlandef_8h.html#cedb0985bfe663807c733642ec60537b">WI_RID_OWN_CHNL</a>, &amp;val, &amp;buflen) == 0) {
<a name="l01510"></a>01510         val = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(val);
<a name="l01511"></a>01511         i = (1 &lt;&lt; val);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513         <span class="keywordflow">if</span> ((val &gt; 16) || ((ic-&gt;<a class="code" href="structieee80211com.html#8ca80d98283bb5f86427051fefd26d48">ChannelList</a> &amp; i) == 0)) {
<a name="l01514"></a>01514             <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_attach: invalid own channel %d!"</span>, val));
<a name="l01515"></a>01515         }
<a name="l01516"></a>01516         ic-&gt;<a class="code" href="structieee80211com.html#657d6811cb5a958a5b2ae0cc0e533926">ic_ibss_chan</a> = val;
<a name="l01517"></a>01517     } <span class="keywordflow">else</span> {
<a name="l01518"></a>01518         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"WI_RID_OWN_CHNL failed, using first channel!\n"</span>));
<a name="l01519"></a>01519         ic-&gt;<a class="code" href="structieee80211com.html#657d6811cb5a958a5b2ae0cc0e533926">ic_ibss_chan</a> = 1;
<a name="l01520"></a>01520     }
<a name="l01521"></a>01521 
<a name="l01522"></a>01522     <span class="comment">/*</span>
<a name="l01523"></a>01523 <span class="comment">     * Set flags based on firmware version.</span>
<a name="l01524"></a>01524 <span class="comment">     */</span>
<a name="l01525"></a>01525     <span class="keywordflow">switch</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a>) {
<a name="l01526"></a>01526 <span class="preprocessor">#if (WLAN_SUPPORT_LUCENT &gt;= 1)</span>
<a name="l01527"></a>01527 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>:
<a name="l01528"></a>01528         sc-&gt;<a class="code" href="structwi__softc.html#9661117d73615ff8ac222b79fb96ba55">sc_ntxbuf</a> = 1;
<a name="l01529"></a>01529         sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#100e9ef2f685e7fd813c9a1df4680be7">WI_FLAGS_HAS_SYSSCALE</a>;
<a name="l01530"></a>01530 
<a name="l01531"></a>01531 <span class="preprocessor">#ifdef WI_HERMES_AUTOINC_WAR</span>
<a name="l01532"></a>01532 <span class="preprocessor"></span>        <span class="comment">/*</span>
<a name="l01533"></a>01533 <span class="comment">         * XXX: not confirmed, but never seen for recent firmware</span>
<a name="l01534"></a>01534 <span class="comment">         */</span>
<a name="l01535"></a>01535         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &lt; 40000) {
<a name="l01536"></a>01536             sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#a83b882895a4c863ef67d3bdc559dab9">WI_FLAGS_BUG_AUTOINC</a>;
<a name="l01537"></a>01537         }
<a name="l01538"></a>01538 <span class="preprocessor">#endif</span>
<a name="l01539"></a>01539 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &gt;= 60000) {
<a name="l01540"></a>01540             sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#e53b89df16b4c028139eb6b91ec7e7e8">WI_FLAGS_HAS_MOR</a>;
<a name="l01541"></a>01541         }
<a name="l01542"></a>01542         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &gt;= 60006) {
<a name="l01543"></a>01543             ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#b9e5c9ee20392d656b15445872772562">IEEE80211_C_IBSS</a>;
<a name="l01544"></a>01544             ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#0086c29a914b7cac07824c2915b6bfbe">IEEE80211_C_MONITOR</a>;
<a name="l01545"></a>01545         }
<a name="l01546"></a>01546         sc-&gt;<a class="code" href="structwi__softc.html#6e26f216e57f82a3269e5e1219bb93d9">sc_ibss_port</a> = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(1);
<a name="l01547"></a>01547 
<a name="l01548"></a>01548         sc-&gt;<a class="code" href="structwi__softc.html#d3b52097ee95041ecf496afbd538aafa">sc_min_rssi</a> = <a class="code" href="wlandef_8h.html#18cbccbfb9045262bb435ee658722249">WI_LUCENT_MIN_RSSI</a>;
<a name="l01549"></a>01549         sc-&gt;<a class="code" href="structwi__softc.html#6b7b22a8afb44525e90a74215e76a805">sc_max_rssi</a> = <a class="code" href="wlandef_8h.html#41b794b1b9c9616264a4834b29f7bf3c">WI_LUCENT_MAX_RSSI</a>;
<a name="l01550"></a>01550         sc-&gt;<a class="code" href="structwi__softc.html#dfc37dbedb9f1f5cf88c10600c10ad0c">sc_dbm_offset</a> = <a class="code" href="wlandef_8h.html#798885616b5c72e7b62625561d70331f">WI_LUCENT_DBM_OFFSET</a>;
<a name="l01551"></a>01551         <span class="keywordflow">break</span>;
<a name="l01552"></a>01552 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_SUPPORT_LUCENT &gt;= 1) */</span>
<a name="l01553"></a>01553 
<a name="l01554"></a>01554 <span class="preprocessor">#if (WLAN_SUPPORT_INTERSIL &gt;= 1)</span>
<a name="l01555"></a>01555 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>:
<a name="l01556"></a>01556         sc-&gt;<a class="code" href="structwi__softc.html#9661117d73615ff8ac222b79fb96ba55">sc_ntxbuf</a> = <a class="code" href="wlandrv_8h.html#9760731086efe8376f15935a40b4ad4e">WI_NTXBUF</a>;
<a name="l01557"></a>01557         sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#0b31ed0d4c64ea8d9e6f9af3ba650422">WI_FLAGS_HAS_FRAGTHR</a>;
<a name="l01558"></a>01558         sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#bafbc4ffd562d01c068482594e1217d7">WI_FLAGS_HAS_ROAMING</a>;
<a name="l01559"></a>01559         sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#100e9ef2f685e7fd813c9a1df4680be7">WI_FLAGS_HAS_SYSSCALE</a>;
<a name="l01560"></a>01560         <span class="comment">/*</span>
<a name="l01561"></a>01561 <span class="comment">         * Old firmware are slow, so give peace a chance.</span>
<a name="l01562"></a>01562 <span class="comment">         */</span>
<a name="l01563"></a>01563         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &lt; 10000) {
<a name="l01564"></a>01564             sc-&gt;<a class="code" href="structwi__softc.html#73119ac71e03ad7e23830f81f3ee0cf6">wi_cmd_count</a> = 5000;
<a name="l01565"></a>01565         }
<a name="l01566"></a>01566         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &gt; 10101) {
<a name="l01567"></a>01567             sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#dda61aee7aa58221be5fb19f7e349261">WI_FLAGS_HAS_DBMADJUST</a>;
<a name="l01568"></a>01568         }
<a name="l01569"></a>01569         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &gt;= 800) {
<a name="l01570"></a>01570             ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#b9e5c9ee20392d656b15445872772562">IEEE80211_C_IBSS</a>;
<a name="l01571"></a>01571             ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#0086c29a914b7cac07824c2915b6bfbe">IEEE80211_C_MONITOR</a>;
<a name="l01572"></a>01572         }
<a name="l01573"></a>01573         <span class="comment">/*</span>
<a name="l01574"></a>01574 <span class="comment">         * version 0.8.3 and newer are the only ones that are known</span>
<a name="l01575"></a>01575 <span class="comment">         * to currently work.  Earlier versions can be made to work,</span>
<a name="l01576"></a>01576 <span class="comment">         * at least according to the Linux driver.</span>
<a name="l01577"></a>01577 <span class="comment">         */</span>
<a name="l01578"></a>01578         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &gt;= 803) {
<a name="l01579"></a>01579             ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#9849be39ff684d9007103f2120775451">IEEE80211_C_HOSTAP</a>;
<a name="l01580"></a>01580         }
<a name="l01581"></a>01581         sc-&gt;<a class="code" href="structwi__softc.html#6e26f216e57f82a3269e5e1219bb93d9">sc_ibss_port</a> = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(0);
<a name="l01582"></a>01582 
<a name="l01583"></a>01583         sc-&gt;<a class="code" href="structwi__softc.html#d3b52097ee95041ecf496afbd538aafa">sc_min_rssi</a> = <a class="code" href="wlandef_8h.html#684c3e95cf1ae8acb4961851d89920db">WI_PRISM_MIN_RSSI</a>;
<a name="l01584"></a>01584         sc-&gt;<a class="code" href="structwi__softc.html#6b7b22a8afb44525e90a74215e76a805">sc_max_rssi</a> = <a class="code" href="wlandef_8h.html#da4eaa52c1e7af90516180f460f45b67">WI_PRISM_MAX_RSSI</a>;
<a name="l01585"></a>01585         sc-&gt;<a class="code" href="structwi__softc.html#dfc37dbedb9f1f5cf88c10600c10ad0c">sc_dbm_offset</a> = <a class="code" href="wlandef_8h.html#26de516521fefd4b51a9fd48cb03311c">WI_PRISM_DBM_OFFSET</a>;
<a name="l01586"></a>01586         <span class="keywordflow">break</span>;
<a name="l01587"></a>01587 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_SUPPORT_INTERSIL &gt;= 1) */</span>
<a name="l01588"></a>01588 
<a name="l01589"></a>01589 <span class="preprocessor">#if (WLAN_SUPPORT_SYMBOL &gt;= 1)</span>
<a name="l01590"></a>01590 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a>:
<a name="l01591"></a>01591         sc-&gt;<a class="code" href="structwi__softc.html#9661117d73615ff8ac222b79fb96ba55">sc_ntxbuf</a> = 1;
<a name="l01592"></a>01592         sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> |= <a class="code" href="wlandrv_8h.html#06ee0226a8ed069c745e7457f13e32e2">WI_FLAGS_HAS_DIVERSITY</a>;
<a name="l01593"></a>01593         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#ba98570f3870192db2f5be2af477057d">sc_sta_firmware_ver</a> &gt;= 25000) {
<a name="l01594"></a>01594             ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#b9e5c9ee20392d656b15445872772562">IEEE80211_C_IBSS</a>;
<a name="l01595"></a>01595         }
<a name="l01596"></a>01596         sc-&gt;<a class="code" href="structwi__softc.html#6e26f216e57f82a3269e5e1219bb93d9">sc_ibss_port</a> = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(4);
<a name="l01597"></a>01597 
<a name="l01598"></a>01598         sc-&gt;<a class="code" href="structwi__softc.html#d3b52097ee95041ecf496afbd538aafa">sc_min_rssi</a> = <a class="code" href="wlandef_8h.html#684c3e95cf1ae8acb4961851d89920db">WI_PRISM_MIN_RSSI</a>;
<a name="l01599"></a>01599         sc-&gt;<a class="code" href="structwi__softc.html#6b7b22a8afb44525e90a74215e76a805">sc_max_rssi</a> = <a class="code" href="wlandef_8h.html#da4eaa52c1e7af90516180f460f45b67">WI_PRISM_MAX_RSSI</a>;
<a name="l01600"></a>01600         sc-&gt;<a class="code" href="structwi__softc.html#dfc37dbedb9f1f5cf88c10600c10ad0c">sc_dbm_offset</a> = <a class="code" href="wlandef_8h.html#26de516521fefd4b51a9fd48cb03311c">WI_PRISM_DBM_OFFSET</a>;
<a name="l01601"></a>01601         <span class="keywordflow">break</span>;
<a name="l01602"></a>01602 <span class="preprocessor">#endif                          </span><span class="comment">/* (WLAN_SUPPORT_SYMBOL &gt;= 1) */</span>
<a name="l01603"></a>01603     }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     <span class="comment">/*</span>
<a name="l01606"></a>01606 <span class="comment">     * Find out if we support WEP on this card.</span>
<a name="l01607"></a>01607 <span class="comment">     */</span>
<a name="l01608"></a>01608     buflen = <span class="keyword">sizeof</span>(val);
<a name="l01609"></a>01609     <span class="keywordflow">if</span> (wi_read_rid(sc, <a class="code" href="wlandef_8h.html#8d0baf7068a70f458bf52258e42991a3">WI_RID_WEP_AVAIL</a>, &amp;val, &amp;buflen) == 0 &amp;&amp; val != <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(0)) {
<a name="l01610"></a>01610         ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> |= <a class="code" href="wlandrv_8h.html#286807300599bc585b37205de93f099a">IEEE80211_C_WEP</a>;
<a name="l01611"></a>01611     }
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <span class="comment">/*</span>
<a name="l01614"></a>01614 <span class="comment">     * Find supported rates.</span>
<a name="l01615"></a>01615 <span class="comment">     */</span>
<a name="l01616"></a>01616     buflen = <span class="keyword">sizeof</span>(ratebuf);
<a name="l01617"></a>01617     rs = &amp;ic-&gt;<a class="code" href="structieee80211com.html#4921af98b393efd47212466b0c1b670a">ic_sup_rates</a>[<a class="code" href="wlandef_8h.html#01ecdf841157b3d62127089ce8ddb9cbf3543f682e39a4e8e23614a6611c1ead">IEEE80211_MODE_11B</a>];
<a name="l01618"></a>01618     <span class="keywordflow">if</span> (wi_read_rid(sc, <a class="code" href="wlandef_8h.html#381d09c08c92430df4e6f83173a5393e">WI_RID_DATA_RATES</a>, ratebuf, &amp;buflen) == 0) {
<a name="l01619"></a>01619         nrates = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(*(<a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> *) ratebuf);
<a name="l01620"></a>01620         <span class="keywordflow">if</span> (nrates &gt; <a class="code" href="wlandef_8h.html#301f4a1c05748322339944d7ef18bfc6">IEEE80211_RATE_MAXSIZE</a>) {
<a name="l01621"></a>01621             nrates = <a class="code" href="wlandef_8h.html#301f4a1c05748322339944d7ef18bfc6">IEEE80211_RATE_MAXSIZE</a>;
<a name="l01622"></a>01622         }
<a name="l01623"></a>01623         rs-&gt;<a class="code" href="structieee80211__rateset.html#6a6e98a9256aeccadb1492c3c0f3e6d7">rs_nrates</a> = 0;
<a name="l01624"></a>01624         <span class="keywordflow">for</span> (i = 0; i &lt; nrates; i++) {
<a name="l01625"></a>01625             <span class="keywordflow">if</span> (ratebuf[2 + i]) {
<a name="l01626"></a>01626                 rs-&gt;<a class="code" href="structieee80211__rateset.html#c0f4c816724aeb78b8962cbba9918b15">rs_rates</a>[rs-&gt;<a class="code" href="structieee80211__rateset.html#6a6e98a9256aeccadb1492c3c0f3e6d7">rs_nrates</a>++] = ratebuf[2 + i];
<a name="l01627"></a>01627             }
<a name="l01628"></a>01628         }
<a name="l01629"></a>01629     } <span class="keywordflow">else</span> {
<a name="l01630"></a>01630         <span class="comment">/*</span>
<a name="l01631"></a>01631 <span class="comment">         * XXX fallback on error?</span>
<a name="l01632"></a>01632 <span class="comment">         */</span>
<a name="l01633"></a>01633         rs-&gt;<a class="code" href="structieee80211__rateset.html#6a6e98a9256aeccadb1492c3c0f3e6d7">rs_nrates</a> = 0;
<a name="l01634"></a>01634     }
<a name="l01635"></a>01635 
<a name="l01636"></a>01636     buflen = <span class="keyword">sizeof</span>(val);
<a name="l01637"></a>01637     <span class="keywordflow">if</span> ((sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp; <a class="code" href="wlandrv_8h.html#dda61aee7aa58221be5fb19f7e349261">WI_FLAGS_HAS_DBMADJUST</a>) &amp;&amp; wi_read_rid(sc, <a class="code" href="wlandef_8h.html#2e12e6f5a27bd570947ff4d6d85c8fd8">WI_RID_DBM_ADJUST</a>, &amp;val, &amp;buflen) == 0) {
<a name="l01638"></a>01638         sc-&gt;<a class="code" href="structwi__softc.html#dfc37dbedb9f1f5cf88c10600c10ad0c">sc_dbm_offset</a> = <a class="code" href="wlandef_8h.html#684a5d26d1989cbd925e97292cc81c72">le16toh</a>(val);
<a name="l01639"></a>01639     }
<a name="l01640"></a>01640 
<a name="l01641"></a>01641     sc-&gt;<a class="code" href="structwi__softc.html#9d7fa3e73cc99711e80e7b211900393b">sc_max_datalen</a> = 2304;
<a name="l01642"></a>01642     sc-&gt;<a class="code" href="structwi__softc.html#f145d7879ab25b8e74bf7a9e5a7c3422">sc_system_scale</a> = 1;
<a name="l01643"></a>01643     sc-&gt;<a class="code" href="structwi__softc.html#ca1e78cf7f15ba297e4fc0c80030ae13">sc_cnfauthmode</a> = <a class="code" href="wlandef_8h.html#99fb83031ce9923c84392b4e92f956b51949c2c6f30c8a55ce13af47b8949998">IEEE80211_AUTH_OPEN</a>;
<a name="l01644"></a>01644     sc-&gt;<a class="code" href="structwi__softc.html#cbd95cc364f272b0c7e01ab216e181de">sc_roaming_mode</a> = <a class="code" href="wlandef_8h.html#d17a634f4233bbf1dda4f9010baecaa5">WI_DEFAULT_ROAMING</a>;
<a name="l01645"></a>01645 
<a name="l01646"></a>01646     sc-&gt;<a class="code" href="structwi__softc.html#5b575784a2438030945aaf2b0e7eabe5">sc_portnum</a> = <a class="code" href="wlandef_8h.html#67211f38e8b9391c68b7561aba2ca635">WI_DEFAULT_PORT</a>;
<a name="l01647"></a>01647     sc-&gt;<a class="code" href="structwi__softc.html#10408af876f351c86322dd1597b3bb7d">sc_authtype</a> = <a class="code" href="wlandef_8h.html#09bc17fdb5a39708002e82ea24601cb2">WI_DEFAULT_AUTHTYPE</a>;
<a name="l01648"></a>01648 
<a name="l01649"></a>01649     <span class="comment">/*</span>
<a name="l01650"></a>01650 <span class="comment">     * Init DeviceSemaphore</span>
<a name="l01651"></a>01651 <span class="comment">     */</span>
<a name="l01652"></a>01652     <a class="code" href="group__xg_event.html#gd519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;hDeviceSemaphore);
<a name="l01653"></a>01653 
<a name="l01654"></a>01654     <span class="keywordflow">return</span> (0);
<a name="l01655"></a>01655 }
<a name="l01656"></a>01656 
<a name="l01657"></a>01657 <span class="comment">/************************************************************/</span>
<a name="l01658"></a>01658 <span class="comment">/*  wlandrv_Init                                            */</span>
<a name="l01659"></a>01659 <span class="comment">/************************************************************/</span>
<a name="l01660"></a><a class="code" href="wlandrv_8c.html#1998f301e3afcbf4f8e6c8cf48efb6f3">01660</a> <span class="keywordtype">void</span> <a class="code" href="wlandrv_8h.html#1998f301e3afcbf4f8e6c8cf48efb6f3">wlandrv_Init</a>(<a class="code" href="wlandrv_8h.html#916fff5dd8c87602f2fdaa4592bd3a85">device_t</a> dev)
<a name="l01661"></a>01661 {
<a name="l01662"></a>01662     <span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *sc = <a class="code" href="wlandrv_8h.html#f193aa005ab17744015b45ad2c87a24a">device_get_softc</a>(dev);
<a name="l01663"></a>01663     <span class="keyword">struct </span><a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l01664"></a>01664     <span class="keywordtype">int</span> i;
<a name="l01665"></a>01665     <span class="keywordtype">int</span> error = 0, wasenabled;
<a name="l01666"></a>01666 
<a name="l01667"></a>01667     <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l01668"></a>01668 
<a name="l01669"></a>01669     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) {
<a name="l01670"></a>01670         <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l01671"></a>01671         <span class="keywordflow">return</span>;
<a name="l01672"></a>01672     }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     <span class="keywordflow">if</span> ((wasenabled = sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a>)) {
<a name="l01675"></a>01675         <a class="code" href="wlandrv_8c.html#8f5deb1fccddcab4b1d4bca80dfe35b9">wi_stop</a>(sc, 1);
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677     wi_reset(sc);
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="comment">/*</span>
<a name="l01680"></a>01680 <span class="comment">     * common 802.11 configuration</span>
<a name="l01681"></a>01681 <span class="comment">     */</span>
<a name="l01682"></a>01682     ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp;= ~<a class="code" href="wlandrv_8h.html#14afcecd16b8458b3e8eb9d0fe868ef2">IEEE80211_F_IBSSON</a>;
<a name="l01683"></a>01683     sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp;= ~<a class="code" href="wlandrv_8h.html#be4408a291bb63321d97d128cafa0ea0">WI_FLAGS_OUTRANGE</a>;
<a name="l01684"></a>01684     <span class="keywordflow">switch</span> (ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a>) {
<a name="l01685"></a>01685     <span class="keywordflow">case</span> <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed16322fdc3044a505e723f3da37f9a6653">IEEE80211_M_STA</a>:
<a name="l01686"></a>01686         wi_write_val(sc, <a class="code" href="wlandef_8h.html#4e0d63e66152ae33efbbcac7e7089c7c">WI_RID_PORTTYPE</a>, <a class="code" href="wlandef_8h.html#15781eae12efe8e13b8e204967b893f5">WI_PORTTYPE_BSS</a>);
<a name="l01687"></a>01687         <span class="keywordflow">break</span>;
<a name="l01688"></a>01688     <span class="keywordflow">case</span> <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed180a49ccd179cd8f6b80a405875714648">IEEE80211_M_IBSS</a>:
<a name="l01689"></a>01689         wi_write_val(sc, <a class="code" href="wlandef_8h.html#4e0d63e66152ae33efbbcac7e7089c7c">WI_RID_PORTTYPE</a>, sc-&gt;<a class="code" href="structwi__softc.html#6e26f216e57f82a3269e5e1219bb93d9">sc_ibss_port</a>);
<a name="l01690"></a>01690         ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> |= <a class="code" href="wlandrv_8h.html#14afcecd16b8458b3e8eb9d0fe868ef2">IEEE80211_F_IBSSON</a>;
<a name="l01691"></a>01691         <span class="keywordflow">break</span>;
<a name="l01692"></a>01692     <span class="keywordflow">case</span> <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed14cb3e43669d35a7b47135c9ee05a45fa">IEEE80211_M_AHDEMO</a>:
<a name="l01693"></a>01693         wi_write_val(sc, <a class="code" href="wlandef_8h.html#4e0d63e66152ae33efbbcac7e7089c7c">WI_RID_PORTTYPE</a>, <a class="code" href="wlandef_8h.html#bd14eba4824bc54b0147aaae5be0f1c1">WI_PORTTYPE_ADHOC</a>);
<a name="l01694"></a>01694         <span class="keywordflow">break</span>;
<a name="l01695"></a>01695     <span class="keywordflow">case</span> <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1452d0b2b50ada8160ea00af9456c56fd">IEEE80211_M_HOSTAP</a>:
<a name="l01696"></a>01696         <span class="comment">/*</span>
<a name="l01697"></a>01697 <span class="comment">         * For PRISM cards, override the empty SSID, because in</span>
<a name="l01698"></a>01698 <span class="comment">         * HostAP mode the controller will lock up otherwise.</span>
<a name="l01699"></a>01699 <span class="comment">         */</span>
<a name="l01700"></a>01700         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a> &amp;&amp; ic-&gt;<a class="code" href="structieee80211com.html#a4a30ae7ed338055c04df038e078cd7b">ic_des_esslen</a> == 0) {
<a name="l01701"></a>01701             ic-&gt;<a class="code" href="structieee80211com.html#d52a9d08fc7fb6b8624c6c0d0996eb40">ic_des_essid</a>[0] = <span class="charliteral">' '</span>;
<a name="l01702"></a>01702             ic-&gt;<a class="code" href="structieee80211com.html#a4a30ae7ed338055c04df038e078cd7b">ic_des_esslen</a> = 1;
<a name="l01703"></a>01703         }
<a name="l01704"></a>01704         wi_write_val(sc, <a class="code" href="wlandef_8h.html#4e0d63e66152ae33efbbcac7e7089c7c">WI_RID_PORTTYPE</a>, <a class="code" href="wlandef_8h.html#98a2348de71374e7139f98beafe8a92c">WI_PORTTYPE_HOSTAP</a>);
<a name="l01705"></a>01705         <span class="keywordflow">break</span>;
<a name="l01706"></a>01706     <span class="keywordflow">case</span> <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1f8306ebf9aeeade67a9f1f9d1acaa80f">IEEE80211_M_MONITOR</a>:
<a name="l01707"></a>01707         <span class="comment">/* Harald: Should be handled. */</span>
<a name="l01708"></a>01708 <span class="preprocessor">#if 0                           // @@MF this mode is not working with my card</span>
<a name="l01709"></a>01709 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>) {
<a name="l01710"></a>01710             wi_write_val(sc, <a class="code" href="wlandef_8h.html#4e0d63e66152ae33efbbcac7e7089c7c">WI_RID_PORTTYPE</a>, <a class="code" href="wlandef_8h.html#bd14eba4824bc54b0147aaae5be0f1c1">WI_PORTTYPE_ADHOC</a>);
<a name="l01711"></a>01711         }
<a name="l01712"></a>01712         error = wi_cmd(sc, <a class="code" href="wlandef_8h.html#5225adac534ee54e538de85a415d7d75">WI_CMD_DEBUG</a> | (<a class="code" href="wlandef_8h.html#de8def928262a371e7f198d4c5178b92">WI_TEST_MONITOR</a> &lt;&lt; 8), 0, 0, 0);
<a name="l01713"></a>01713 <span class="preprocessor">#endif</span>
<a name="l01714"></a>01714 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
<a name="l01715"></a>01715     }
<a name="l01716"></a>01716 
<a name="l01717"></a>01717     <span class="comment">/*</span>
<a name="l01718"></a>01718 <span class="comment">     * Intersil interprets this RID as joining ESS even in IBSS mode</span>
<a name="l01719"></a>01719 <span class="comment">     */</span>
<a name="l01720"></a>01720     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a> &amp;&amp; (ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp; <a class="code" href="wlandrv_8h.html#14afcecd16b8458b3e8eb9d0fe868ef2">IEEE80211_F_IBSSON</a>) &amp;&amp; ic-&gt;<a class="code" href="structieee80211com.html#a4a30ae7ed338055c04df038e078cd7b">ic_des_esslen</a> &gt; 0) {
<a name="l01721"></a>01721         wi_write_val(sc, <a class="code" href="wlandef_8h.html#80d238533b440160c710058d4ceecc4f">WI_RID_CREATE_IBSS</a>, 1);
<a name="l01722"></a>01722     } <span class="keywordflow">else</span> {
<a name="l01723"></a>01723         wi_write_val(sc, <a class="code" href="wlandef_8h.html#80d238533b440160c710058d4ceecc4f">WI_RID_CREATE_IBSS</a>, 0);
<a name="l01724"></a>01724     }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l01727"></a>01727 <span class="preprocessor"></span>    wi_write_val(sc, <a class="code" href="wlandef_8h.html#c8e8a9c9cd411ba47c2fa26b6aae7ea3">WI_RID_MAX_SLEEP</a>, ic-&gt;ic_lintval);
<a name="l01728"></a>01728 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     wi_write_ssid(sc, <a class="code" href="wlandef_8h.html#8841cc7f057565a47b726591b359eed0">WI_RID_DESIRED_SSID</a>, ic-&gt;<a class="code" href="structieee80211com.html#d52a9d08fc7fb6b8624c6c0d0996eb40">ic_des_essid</a>, ic-&gt;<a class="code" href="structieee80211com.html#a4a30ae7ed338055c04df038e078cd7b">ic_des_esslen</a>);
<a name="l01731"></a>01731     wi_write_val(sc, <a class="code" href="wlandef_8h.html#cedb0985bfe663807c733642ec60537b">WI_RID_OWN_CHNL</a>, ic-&gt;<a class="code" href="structieee80211com.html#657d6811cb5a958a5b2ae0cc0e533926">ic_ibss_chan</a>);
<a name="l01732"></a>01732     wi_write_ssid(sc, <a class="code" href="wlandef_8h.html#41ee693c8fa4fe5f16dc57fda357d339">WI_RID_OWN_SSID</a>, ic-&gt;<a class="code" href="structieee80211com.html#d52a9d08fc7fb6b8624c6c0d0996eb40">ic_des_essid</a>, ic-&gt;<a class="code" href="structieee80211com.html#a4a30ae7ed338055c04df038e078cd7b">ic_des_esslen</a>);
<a name="l01733"></a>01733 
<a name="l01734"></a>01734     wi_write_rid(sc, <a class="code" href="wlandef_8h.html#c801c1211486b5d12dda56967c608d92">WI_RID_MAC_NODE</a>, ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736     wi_write_val(sc, <a class="code" href="wlandef_8h.html#274840f3971337726026e9929fb96d02">WI_RID_PM_ENABLED</a>, (ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp; <a class="code" href="wlandrv_8h.html#56bb9c115b1b708993779fc9889a4757">IEEE80211_F_PMGTON</a>) ? 1 : 0);
<a name="l01737"></a>01737 
<a name="l01738"></a>01738     <span class="comment">/*</span>
<a name="l01739"></a>01739 <span class="comment">     * not yet common 802.11 configuration</span>
<a name="l01740"></a>01740 <span class="comment">     */</span>
<a name="l01741"></a>01741     wi_write_val(sc, <a class="code" href="wlandef_8h.html#cebb9cd9ddabd847a1804e813406c265">WI_RID_MAX_DATALEN</a>, sc-&gt;<a class="code" href="structwi__softc.html#9d7fa3e73cc99711e80e7b211900393b">sc_max_datalen</a>);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l01744"></a>01744 <span class="preprocessor"></span>    wi_write_val(sc, <a class="code" href="wlandef_8h.html#d4c1fba5cb84d31c07c294e43d5c35b0">WI_RID_RTS_THRESH</a>, ic-&gt;ic_rtsthreshold);
<a name="l01745"></a>01745     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp; <a class="code" href="wlandrv_8h.html#0b31ed0d4c64ea8d9e6f9af3ba650422">WI_FLAGS_HAS_FRAGTHR</a>) {
<a name="l01746"></a>01746         wi_write_val(sc, <a class="code" href="wlandef_8h.html#90355c4f707f03a99abace6878356bdd">WI_RID_FRAG_THRESH</a>, ic-&gt;ic_fragthreshold);
<a name="l01747"></a>01747     }
<a name="l01748"></a>01748 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l01749"></a>01749 
<a name="l01750"></a>01750     <span class="comment">/*</span>
<a name="l01751"></a>01751 <span class="comment">     * driver specific 802.11 configuration</span>
<a name="l01752"></a>01752 <span class="comment">     */</span>
<a name="l01753"></a>01753     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp; <a class="code" href="wlandrv_8h.html#100e9ef2f685e7fd813c9a1df4680be7">WI_FLAGS_HAS_SYSSCALE</a>) {
<a name="l01754"></a>01754         wi_write_val(sc, <a class="code" href="wlandef_8h.html#c7d0a9be38fe89276f5efccc855c4834">WI_RID_SYSTEM_SCALE</a>, sc-&gt;<a class="code" href="structwi__softc.html#f145d7879ab25b8e74bf7a9e5a7c3422">sc_system_scale</a>);
<a name="l01755"></a>01755     }
<a name="l01756"></a>01756     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp; <a class="code" href="wlandrv_8h.html#bafbc4ffd562d01c068482594e1217d7">WI_FLAGS_HAS_ROAMING</a>) {
<a name="l01757"></a>01757         wi_write_val(sc, <a class="code" href="wlandef_8h.html#7796f00d83429b580d4c9b4947399085">WI_RID_ROAMING_MODE</a>, sc-&gt;<a class="code" href="structwi__softc.html#cbd95cc364f272b0c7e01ab216e181de">sc_roaming_mode</a>);
<a name="l01758"></a>01758     }
<a name="l01759"></a>01759     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#4c2278ff385d2184c3134dbefd964ea1">sc_flags</a> &amp; <a class="code" href="wlandrv_8h.html#e53b89df16b4c028139eb6b91ec7e7e8">WI_FLAGS_HAS_MOR</a>) {
<a name="l01760"></a>01760         wi_write_val(sc, <a class="code" href="wlandef_8h.html#40dac136ac21be263377ff67686c752b">WI_RID_MICROWAVE_OVEN</a>, sc-&gt;<a class="code" href="structwi__softc.html#b635cdb1a36dcfdebd97feffc438d7b9">sc_microwave_oven</a>);
<a name="l01761"></a>01761     }
<a name="l01762"></a>01762     wi_write_txrate(sc);
<a name="l01763"></a>01763 
<a name="l01764"></a>01764 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l01765"></a>01765 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l01766"></a>01766 <span class="comment">     * What is a nodename ??? :-(</span>
<a name="l01767"></a>01767 <span class="comment">     */</span>
<a name="l01768"></a>01768     wi_write_ssid(sc, <a class="code" href="wlandef_8h.html#dc9350dc84c21be4b3c2b56ca89b42c9">WI_RID_NODENAME</a>, sc-&gt;sc_nodename, sc-&gt;sc_nodelen);
<a name="l01769"></a>01769 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l01770"></a>01770 
<a name="l01771"></a>01771 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l01772"></a>01772 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l01773"></a>01773 <span class="comment">     * Does we realy need HOSTAP on Ethernut??</span>
<a name="l01774"></a>01774 <span class="comment">     */</span>
<a name="l01775"></a>01775     <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1452d0b2b50ada8160ea00af9456c56fd">IEEE80211_M_HOSTAP</a> &amp;&amp; sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>) {
<a name="l01776"></a>01776         wi_write_val(sc, <a class="code" href="wlandef_8h.html#9b216d72dea47f0750ed8d3eb299c3ef">WI_RID_OWN_BEACON_INT</a>, ic-&gt;ic_lintval);
<a name="l01777"></a>01777         wi_write_val(sc, <a class="code" href="wlandef_8h.html#2f3670d03ef1afaebe00d9d6e9fbcb11">WI_RID_BASIC_RATE</a>, 0x03);      <span class="comment">/* 1, 2 */</span>
<a name="l01778"></a>01778         wi_write_val(sc, <a class="code" href="wlandef_8h.html#68c71b60922d473cd062ddf23bd9f920">WI_RID_SUPPORT_RATE</a>, 0x0f);    <span class="comment">/* 1, 2, 5.5, 11 */</span>
<a name="l01779"></a>01779         wi_write_val(sc, <a class="code" href="wlandef_8h.html#f2908a79cc2b13cfd4838ad4abdcfddc">WI_RID_DTIM_PERIOD</a>, 1);
<a name="l01780"></a>01780     }
<a name="l01781"></a>01781 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="comment">/*</span>
<a name="l01784"></a>01784 <span class="comment">     *  Initialize promisc mode.</span>
<a name="l01785"></a>01785 <span class="comment">     *  Being in the Host-AP mode causes a great</span>
<a name="l01786"></a>01786 <span class="comment">     *  deal of pain if primisc mode is set.</span>
<a name="l01787"></a>01787 <span class="comment">     *  Therefore we avoid confusing the firmware</span>
<a name="l01788"></a>01788 <span class="comment">     *  and always reset promisc mode in Host-AP</span>
<a name="l01789"></a>01789 <span class="comment">     *  mode.  Host-AP sees all the packets anyway.</span>
<a name="l01790"></a>01790 <span class="comment">     */</span>
<a name="l01791"></a>01791     <span class="keywordflow">if</span> ((ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> != <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1452d0b2b50ada8160ea00af9456c56fd">IEEE80211_M_HOSTAP</a>) &amp;&amp; (sc-&gt;<a class="code" href="structwi__softc.html#11651a1d206da01446529824ace60252">PromiscuousMode</a> != 0)) {
<a name="l01792"></a>01792         wi_write_val(sc, <a class="code" href="wlandef_8h.html#6c5c60df2417f4b802e70f91abd1e539">WI_RID_PROMISC</a>, 1);
<a name="l01793"></a>01793     } <span class="keywordflow">else</span> {
<a name="l01794"></a>01794         wi_write_val(sc, <a class="code" href="wlandef_8h.html#6c5c60df2417f4b802e70f91abd1e539">WI_RID_PROMISC</a>, 0);
<a name="l01795"></a>01795     }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797     <span class="comment">/*</span>
<a name="l01798"></a>01798 <span class="comment">     * Configure WEP.</span>
<a name="l01799"></a>01799 <span class="comment">     */</span>
<a name="l01800"></a>01800     <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#be998824ac56297493c801c78cc807ce">ic_caps</a> &amp; <a class="code" href="wlandrv_8h.html#286807300599bc585b37205de93f099a">IEEE80211_C_WEP</a>) {
<a name="l01801"></a>01801         wi_write_wep(sc);
<a name="l01802"></a>01802     }
<a name="l01803"></a>01803 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l01804"></a>01804 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l01805"></a>01805 <span class="comment">     * Set multicast filter.</span>
<a name="l01806"></a>01806 <span class="comment">     */</span>
<a name="l01807"></a>01807     wi_write_multi(sc);
<a name="l01808"></a>01808 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l01809"></a>01809 
<a name="l01810"></a>01810     <span class="comment">/*</span>
<a name="l01811"></a>01811 <span class="comment">     * Allocate fids for the card</span>
<a name="l01812"></a>01812 <span class="comment">     */</span>
<a name="l01813"></a>01813     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> != <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a> || !wasenabled) {
<a name="l01814"></a>01814         sc-&gt;<a class="code" href="structwi__softc.html#de1d5e188d55fa7d39cc861f9e2d3de1">sc_buflen</a> = <a class="code" href="wlandef_8h.html#55bf202a5c67336f8901ea1eadcd5af9">IEEE80211_MAX_LEN</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct </span>wi_frame);
<a name="l01815"></a>01815         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#401e16dc9d3e2d1b51c213248f63aa76">WI_SYMBOL</a>) {
<a name="l01816"></a>01816             sc-&gt;<a class="code" href="structwi__softc.html#de1d5e188d55fa7d39cc861f9e2d3de1">sc_buflen</a> = 1585;       <span class="comment">/* XXX */</span>
<a name="l01817"></a>01817         }
<a name="l01818"></a>01818         <span class="keywordflow">for</span> (i = 0; i &lt; sc-&gt;<a class="code" href="structwi__softc.html#9661117d73615ff8ac222b79fb96ba55">sc_ntxbuf</a>; i++) {
<a name="l01819"></a>01819             error = wi_alloc_fid(sc, sc-&gt;<a class="code" href="structwi__softc.html#de1d5e188d55fa7d39cc861f9e2d3de1">sc_buflen</a>, &amp;sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[i].<a class="code" href="structwi__softc.html#d977a6dbd0c3855d7711c6bac8cdc28f">d_fid</a>);
<a name="l01820"></a>01820             <span class="keywordflow">if</span> (error) {
<a name="l01821"></a>01821                 <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"tx buffer allocation failed (error %u)\n"</span>, error));
<a name="l01822"></a>01822                 <span class="keywordflow">goto</span> out;
<a name="l01823"></a>01823             }
<a name="l01824"></a>01824             sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[i].<a class="code" href="structwi__softc.html#06eef39fdf5fbca4412ade64d592295b">d_len</a> = 0;
<a name="l01825"></a>01825         }
<a name="l01826"></a>01826     }
<a name="l01827"></a>01827     sc-&gt;<a class="code" href="structwi__softc.html#68183069ce698832e1aa4d9cd7e44c31">sc_txcur</a> = sc-&gt;<a class="code" href="structwi__softc.html#7d9a6e80b1bf298d6a4aefd9a4f7f57a">sc_txnext</a> = 0;
<a name="l01828"></a>01828 
<a name="l01829"></a>01829     <span class="comment">/*</span>
<a name="l01830"></a>01830 <span class="comment">     * Enable desired port</span>
<a name="l01831"></a>01831 <span class="comment">     */</span>
<a name="l01832"></a>01832     wi_cmd(sc, <a class="code" href="wlandef_8h.html#8f269c67610a54d3a5eff9e4afda84ce">WI_CMD_ENABLE</a> | sc-&gt;<a class="code" href="structwi__softc.html#5b575784a2438030945aaf2b0e7eabe5">sc_portnum</a>, 0, 0, 0);
<a name="l01833"></a>01833 
<a name="l01834"></a>01834     sc-&gt;<a class="code" href="structwi__softc.html#56e47959d8ae3924b67887c442675517">sc_enabled</a> = 1;
<a name="l01835"></a>01835     <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed14cb3e43669d35a7b47135c9ee05a45fa">IEEE80211_M_AHDEMO</a> || ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1f8306ebf9aeeade67a9f1f9d1acaa80f">IEEE80211_M_MONITOR</a> || ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1452d0b2b50ada8160ea00af9456c56fd">IEEE80211_M_HOSTAP</a>) {
<a name="l01836"></a>01836         <a class="code" href="wlandrv_8c.html#cf9151e6667aafff8ee2aa86d01db112">ieee80211_new_state</a>(ic, <a class="code" href="wlandrv_8h.html#6c8e7861891c9e21e6a02ccdba51494459e567dc5761d3a082d77011fc6c1a39">IEEE80211_S_RUN</a>, -1);
<a name="l01837"></a>01837     }
<a name="l01838"></a>01838 
<a name="l01839"></a>01839   <span class="comment">/*************************************************************************/</span>
<a name="l01840"></a>01840     <span class="comment">/*                  Set interrupt and start RxThread                     */</span>
<a name="l01841"></a>01841   <span class="comment">/*************************************************************************/</span>
<a name="l01842"></a>01842     <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#d7ec214b85994511b56ab11eaac733b2">InterruptInitDone</a> == 0) {
<a name="l01843"></a>01843         sc-&gt;<a class="code" href="structwi__softc.html#d7ec214b85994511b56ab11eaac733b2">InterruptInitDone</a> = 1;
<a name="l01844"></a>01844         <span class="comment">/*</span>
<a name="l01845"></a>01845 <span class="comment">         * Install WLAN interrupt</span>
<a name="l01846"></a>01846 <span class="comment">         */</span>
<a name="l01847"></a>01847         PORTE |= 0x80;          <span class="comment">/* Enable PullUp */</span>
<a name="l01848"></a>01848         error = <a class="code" href="group__xg_interrupt.html#ga459696030a9cdf621ce3df7b3ac939d" title="Register an interrupt handler.">NutRegisterIrqHandler</a>(&amp;<a class="code" href="group__xg_irq_reg.html#gd05cd87319597b38f99b482af16aaa77">sig_INTERRUPT7</a>, WLANInterrupt, dev);
<a name="l01849"></a>01849         <span class="keywordflow">if</span> (error == <a class="code" href="wlantypes_8h.html#a93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l01850"></a>01850             <a class="code" href="arch_2avr_8h.html#dfe9e84cb020344da5b7554e232d6988">EICR</a> |= 0x80;       <span class="comment">// falling edge</span>
<a name="l01851"></a>01851             <a class="code" href="icc_8h.html#f99479fff216597a9fa50b0187920509">sbi</a>(EIMSK, <a class="code" href="vs10xx_8c.html#823625b077d68b82bf618893344b8282">INT7</a>);
<a name="l01852"></a>01852 
<a name="l01853"></a>01853             <span class="comment">/*</span>
<a name="l01854"></a>01854 <span class="comment">             * Start the receiver thread.</span>
<a name="l01855"></a>01855 <span class="comment">             */</span>
<a name="l01856"></a>01856             <a class="code" href="group__xg_nut_arch_avr_os_context_gcc.html#g8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="stringliteral">"rxi7"</span>, <a class="code" href="wlandrv_8c.html#63420a919aa1aab627df1b2257c6953e">RxThread</a>, dev, 640);
<a name="l01857"></a>01857         }
<a name="l01858"></a>01858     }
<a name="l01859"></a>01859   <span class="comment">/*************************************************************************/</span>
<a name="l01860"></a>01860 
<a name="l01861"></a>01861 
<a name="l01862"></a>01862     <span class="comment">/*</span>
<a name="l01863"></a>01863 <span class="comment">     * Enable interrupts</span>
<a name="l01864"></a>01864 <span class="comment">     */</span>
<a name="l01865"></a>01865     <a class="code" href="wlandrv_8c.html#83458f143ee58335271b207adc673cb5">CSR_WRITE_2</a>(sc, <a class="code" href="wlandef_8h.html#78962f3ef0c16eb5d61d19d889a499f1">WI_INT_EN</a>, <a class="code" href="wlandrv_8c.html#ba1d837c101dad261ae0df7b05bc07d1">WI_INTRS</a>);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867     <span class="keywordflow">if</span> (!wasenabled &amp;&amp; ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed1452d0b2b50ada8160ea00af9456c56fd">IEEE80211_M_HOSTAP</a> &amp;&amp; sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> == <a class="code" href="wlandef_8h.html#ea59f45e53b99367a3184ed9d8fa7abe">WI_INTERSIL</a>) {
<a name="l01868"></a>01868         <span class="comment">/*</span>
<a name="l01869"></a>01869 <span class="comment">         * XXX: some card need to be re-enabled for hostap</span>
<a name="l01870"></a>01870 <span class="comment">         */</span>
<a name="l01871"></a>01871         wi_cmd(sc, <a class="code" href="wlandef_8h.html#7f78831b8b9e7be7a196d4da1a540fa6">WI_CMD_DISABLE</a> | <a class="code" href="wlandef_8h.html#c494f3f4dafe0fa83b709c8b5705f811">WI_PORT0</a>, 0, 0, 0);
<a name="l01872"></a>01872         wi_cmd(sc, <a class="code" href="wlandef_8h.html#8f269c67610a54d3a5eff9e4afda84ce">WI_CMD_ENABLE</a> | <a class="code" href="wlandef_8h.html#c494f3f4dafe0fa83b709c8b5705f811">WI_PORT0</a>, 0, 0, 0);
<a name="l01873"></a>01873     }
<a name="l01874"></a>01874 <span class="preprocessor">#if 0                           //@@MF later</span>
<a name="l01875"></a>01875 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l01876"></a>01876 <span class="comment">     * This is only for IEEE80211_M_STA</span>
<a name="l01877"></a>01877 <span class="comment">     */</span>
<a name="l01878"></a>01878     <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> == <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed16322fdc3044a505e723f3da37f9a6653">IEEE80211_M_STA</a> &amp;&amp; ((ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp; <a class="code" href="wlandrv_8h.html#20aaace0ebd0e04cbd39a041239091e4">IEEE80211_F_DESBSSID</a>) || ic-&gt;ic_des_chan != <a class="code" href="wlandef_8h.html#84ba42e778d539bd208867e152df2429">IEEE80211_CHAN_ANYC</a>)) {
<a name="l01879"></a>01879         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(&amp;join, 0, <span class="keyword">sizeof</span>(join));
<a name="l01880"></a>01880         <span class="keywordflow">if</span> (ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp; <a class="code" href="wlandrv_8h.html#20aaace0ebd0e04cbd39a041239091e4">IEEE80211_F_DESBSSID</a>)
<a name="l01881"></a>01881             IEEE80211_ADDR_COPY(&amp;join.wi_bssid, ic-&gt;ic_des_bssid);
<a name="l01882"></a>01882         <span class="keywordflow">if</span> (ic-&gt;ic_des_chan != <a class="code" href="wlandef_8h.html#84ba42e778d539bd208867e152df2429">IEEE80211_CHAN_ANYC</a>)
<a name="l01883"></a>01883             join.wi_chan = <a class="code" href="wlandef_8h.html#3ea73a6089f61223b225c46e2ba58a47">htole16</a>(ieee80211_chan2ieee(ic, ic-&gt;ic_des_chan));
<a name="l01884"></a>01884         <span class="comment">/*</span>
<a name="l01885"></a>01885 <span class="comment">         * Lucent firmware does not support the JOIN RID.</span>
<a name="l01886"></a>01886 <span class="comment">         */</span>
<a name="l01887"></a>01887         <span class="keywordflow">if</span> (sc-&gt;<a class="code" href="structwi__softc.html#e36cbc44fd850992ef66d6ec94effa28">sc_firmware_type</a> != <a class="code" href="wlandef_8h.html#65a61da21cfc31540a6a09b29759cf53">WI_LUCENT</a>)
<a name="l01888"></a>01888             wi_write_rid(sc, WI_RID_JOIN_REQ, &amp;join, <span class="keyword">sizeof</span>(join));
<a name="l01889"></a>01889     }
<a name="l01890"></a>01890 <span class="preprocessor">#endif                          </span><span class="comment">/* later */</span>
<a name="l01891"></a>01891 
<a name="l01892"></a>01892     <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l01893"></a>01893     <span class="keywordflow">return</span>;
<a name="l01894"></a>01894   out:
<a name="l01895"></a>01895     <span class="keywordflow">if</span> (error) {
<a name="l01896"></a>01896         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"interface not running\n"</span>));
<a name="l01897"></a>01897         <a class="code" href="wlandrv_8c.html#8f5deb1fccddcab4b1d4bca80dfe35b9">wi_stop</a>(sc, 1);
<a name="l01898"></a>01898     }
<a name="l01899"></a>01899     <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l01900"></a>01900     <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wi_init: return %d\n"</span>, error));
<a name="l01901"></a>01901     <span class="keywordflow">return</span>;
<a name="l01902"></a>01902 }
<a name="l01903"></a>01903 
<a name="l01904"></a>01904 <span class="comment">/************************************************************/</span>
<a name="l01905"></a>01905 <span class="comment">/*  wlandrv_PutPacket                                       */</span>
<a name="l01906"></a>01906 <span class="comment">/************************************************************/</span>
<a name="l01907"></a><a class="code" href="wlandrv_8c.html#d4bd273426f4e25bcbf28b060a52ffa6">01907</a> <span class="keywordtype">int</span> <a class="code" href="wlandrv_8h.html#d4bd273426f4e25bcbf28b060a52ffa6">wlandrv_PutPacket</a>(NUTDEVICE * dev, NETBUF * nb)
<a name="l01908"></a>01908 {
<a name="l01909"></a>01909     <span class="keywordtype">int</span> error = -1;
<a name="l01910"></a>01910     <span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *sc = (<span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *) dev-&gt;dev_dcb;
<a name="l01911"></a>01911     <span class="keyword">struct</span> wi_frame frmhdr;
<a name="l01912"></a>01912     LLCS_SNAP_HEADER LLCSSNAPHeader;
<a name="l01913"></a>01913     <a class="code" href="struct_e_t_h_e_r_h_d_r.html">ETHERHDR</a> *pMAC8023Header;
<a name="l01914"></a>01914     <span class="keywordtype">int</span> cur, fid, off, len;
<a name="l01915"></a>01915 
<a name="l01916"></a>01916     if (sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) {
<a name="l01917"></a>01917         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"wlandrv_PutPacket gone\r\n"</span>));
<a name="l01918"></a>01918         <span class="keywordflow">return</span> (-1);
<a name="l01919"></a>01919     }
<a name="l01920"></a>01920 
<a name="l01921"></a>01921     <span class="comment">/*</span>
<a name="l01922"></a>01922 <span class="comment">     * Calculate the number of bytes to be send. Do not</span>
<a name="l01923"></a>01923 <span class="comment">     * send packets larger than 1518 bytes.</span>
<a name="l01924"></a>01924 <span class="comment">     */</span>
<a name="l01925"></a>01925     len = nb-&gt;nb_dl.sz + nb-&gt;nb_nw.sz + nb-&gt;nb_tp.sz + nb-&gt;nb_ap.sz;
<a name="l01926"></a>01926     <span class="keywordflow">if</span> (len &gt; 1518) {
<a name="l01927"></a>01927         <span class="keywordflow">return</span> (-1);
<a name="l01928"></a>01928     } <span class="keywordflow">else</span> {
<a name="l01929"></a>01929         <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="comment">/*</span>
<a name="l01932"></a>01932 <span class="comment">         * This is a RFC894 Frame from Ethernut</span>
<a name="l01933"></a>01933 <span class="comment">         */</span>
<a name="l01934"></a>01934 <span class="preprocessor">#if (WLAN_ENABLE_TX_FRAME_DUMP &gt;= 1)</span>
<a name="l01935"></a>01935 <span class="preprocessor"></span>        <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"TxFrame: %d\n"</span>, len));
<a name="l01936"></a>01936         <a class="code" href="wlandrv_8c.html#74d150886c2f5c4d2d27514d643c6b80">DumpWlanData</a>(nb-&gt;nb_dl.vp, len);
<a name="l01937"></a>01937 <span class="preprocessor">#endif</span>
<a name="l01938"></a>01938 <span class="preprocessor"></span>
<a name="l01939"></a>01939         <span class="comment">/*</span>
<a name="l01940"></a>01940 <span class="comment">         * But we must send a RFC1024 Frame.</span>
<a name="l01941"></a>01941 <span class="comment">         * ETHERHDR is not part of an RFC1024 Frame</span>
<a name="l01942"></a>01942 <span class="comment">         */</span>
<a name="l01943"></a>01943         len = len - <span class="keyword">sizeof</span>(<a class="code" href="struct_e_t_h_e_r_h_d_r.html">ETHERHDR</a>);
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         <span class="comment">/*</span>
<a name="l01946"></a>01946 <span class="comment">         * Add RFC1024 Header</span>
<a name="l01947"></a>01947 <span class="comment">         */</span>
<a name="l01948"></a>01948         len += <span class="keyword">sizeof</span>(LLCS_SNAP_HEADER);
<a name="l01949"></a>01949 
<a name="l01950"></a>01950         <span class="comment">/*</span>
<a name="l01951"></a>01951 <span class="comment">         * I do not know what I do here, therefore clear the header</span>
<a name="l01952"></a>01952 <span class="comment">         * and to hope for, the card will do the rest?</span>
<a name="l01953"></a>01953 <span class="comment">         */</span>
<a name="l01954"></a>01954         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(&amp;frmhdr, 0, <span class="keyword">sizeof</span>(frmhdr));
<a name="l01955"></a>01955 
<a name="l01956"></a>01956         <span class="comment">/*</span>
<a name="l01957"></a>01957 <span class="comment">         * Copy the Ethernut MAC 802.3 Dest/Source Address into the WLANHeader</span>
<a name="l01958"></a>01958 <span class="comment">         */</span>
<a name="l01959"></a>01959         pMAC8023Header = (<a class="code" href="struct_e_t_h_e_r_h_d_r.html">ETHERHDR</a> *) nb-&gt;nb_dl.vp;
<a name="l01960"></a>01960         frmhdr.wi_dat_len = len;
<a name="l01961"></a>01961         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(frmhdr.wi_ehdr.ether_dhost, pMAC8023Header-&gt;ether_dhost, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l01962"></a>01962         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(frmhdr.wi_ehdr.ether_shost, pMAC8023Header-&gt;ether_shost, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l01963"></a>01963         frmhdr.wi_ehdr.ether_type = <a class="code" href="wlantypes_8h.html#512c4910f8d38ead1693324fdc21b2e1">SWAP</a>(len);
<a name="l01964"></a>01964 
<a name="l01965"></a>01965         <span class="comment">/*</span>
<a name="l01966"></a>01966 <span class="comment">         * Prepare the RFC1024 Header</span>
<a name="l01967"></a>01967 <span class="comment">         */</span>
<a name="l01968"></a>01968         LLCSSNAPHeader.DSAPSSAP = 0xAAAA;
<a name="l01969"></a>01969         LLCSSNAPHeader.Control = 0x0003;
<a name="l01970"></a>01970         LLCSSNAPHeader.MustZero = 0x0000;
<a name="l01971"></a>01971         LLCSSNAPHeader.Type = pMAC8023Header-&gt;ether_type;
<a name="l01972"></a>01972 
<a name="l01973"></a>01973         <span class="comment">/*</span>
<a name="l01974"></a>01974 <span class="comment">         * Get the TX-BUffer-ID</span>
<a name="l01975"></a>01975 <span class="comment">         */</span>
<a name="l01976"></a>01976         cur = sc-&gt;<a class="code" href="structwi__softc.html#68183069ce698832e1aa4d9cd7e44c31">sc_txcur</a>;
<a name="l01977"></a>01977         fid = sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#d977a6dbd0c3855d7711c6bac8cdc28f">d_fid</a>;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979         <span class="comment">/*</span>
<a name="l01980"></a>01980 <span class="comment">         * And Copy the WLANHeader</span>
<a name="l01981"></a>01981 <span class="comment">         */</span>
<a name="l01982"></a>01982         error = wi_write_bap(sc, fid, 0, &amp;frmhdr, <span class="keyword">sizeof</span>(frmhdr));
<a name="l01983"></a>01983         <span class="keywordflow">if</span> (error == 0) {
<a name="l01984"></a>01984             off = <span class="keyword">sizeof</span>(frmhdr);
<a name="l01985"></a>01985 
<a name="l01986"></a>01986             <span class="comment">/*</span>
<a name="l01987"></a>01987 <span class="comment">             * Now copy the RFC1024 Header</span>
<a name="l01988"></a>01988 <span class="comment">             */</span>
<a name="l01989"></a>01989             error = wi_write_bap(sc, fid, off, &amp;LLCSSNAPHeader, <span class="keyword">sizeof</span>(LLCSSNAPHeader));
<a name="l01990"></a>01990             <span class="keywordflow">if</span> (error == 0) {
<a name="l01991"></a>01991                 off += <span class="keyword">sizeof</span>(LLCSSNAPHeader);
<a name="l01992"></a>01992 
<a name="l01993"></a>01993                 <span class="comment">/*</span>
<a name="l01994"></a>01994 <span class="comment">                 * Copy the rest of the Ethernut Data</span>
<a name="l01995"></a>01995 <span class="comment">                 */</span>
<a name="l01996"></a>01996                 <span class="keywordflow">if</span> ((error == 0) &amp;&amp; (nb-&gt;nb_nw.sz != 0)) {
<a name="l01997"></a>01997                     error = wi_write_bap(sc, fid, off, nb-&gt;nb_nw.vp, nb-&gt;nb_nw.sz);
<a name="l01998"></a>01998                     off += nb-&gt;nb_nw.sz;
<a name="l01999"></a>01999                 }
<a name="l02000"></a>02000                 <span class="keywordflow">if</span> ((error == 0) &amp;&amp; (nb-&gt;nb_tp.sz != 0)) {
<a name="l02001"></a>02001                     error = wi_write_bap(sc, fid, off, nb-&gt;nb_tp.vp, nb-&gt;nb_tp.sz);
<a name="l02002"></a>02002                     off += nb-&gt;nb_tp.sz;
<a name="l02003"></a>02003                 }
<a name="l02004"></a>02004                 <span class="keywordflow">if</span> ((error == 0) &amp;&amp; (nb-&gt;nb_ap.sz != 0)) {
<a name="l02005"></a>02005                     error = wi_write_bap(sc, fid, off, nb-&gt;nb_ap.vp, nb-&gt;nb_ap.sz);
<a name="l02006"></a>02006                 }
<a name="l02007"></a>02007                 <span class="keywordflow">if</span> (error == 0) {
<a name="l02008"></a>02008 
<a name="l02009"></a>02009                     <span class="comment">//@@MF sc-&gt;sc_txd[cur].d_len = off;</span>
<a name="l02010"></a>02010 
<a name="l02011"></a>02011                     error = wi_cmd(sc, <a class="code" href="wlandef_8h.html#722f1a9405561cae6b8af261388bb28e">WI_CMD_TX</a> | <a class="code" href="wlandef_8h.html#8fb006a87a7d46a05f4ed585bddc686b">WI_RECLAIM</a>, fid, 0, 0);
<a name="l02012"></a>02012                     <span class="keywordflow">if</span> (error != 0) {
<a name="l02013"></a>02013                         <a class="code" href="lpc2xxx_8h.html#b492680ed4011036b504fd042d1703e3">Debug</a>((<span class="stringliteral">"xmit failed\n"</span>));
<a name="l02014"></a>02014                         sc-&gt;<a class="code" href="structwi__softc.html#a7c20d57d728983ad5f224762d1efbe6">sc_txd</a>[cur].<a class="code" href="structwi__softc.html#06eef39fdf5fbca4412ade64d592295b">d_len</a> = 0;
<a name="l02015"></a>02015                     }
<a name="l02016"></a>02016 
<a name="l02017"></a>02017                     sc-&gt;<a class="code" href="structwi__softc.html#7d9a6e80b1bf298d6a4aefd9a4f7f57a">sc_txnext</a> = cur = (cur + 1) % sc-&gt;<a class="code" href="structwi__softc.html#9661117d73615ff8ac222b79fb96ba55">sc_ntxbuf</a>;
<a name="l02018"></a>02018                 }
<a name="l02019"></a>02019             }
<a name="l02020"></a>02020         }
<a name="l02021"></a>02021 
<a name="l02022"></a>02022         <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l02023"></a>02023     }
<a name="l02024"></a>02024 
<a name="l02025"></a>02025     <span class="keywordflow">return</span> (error);
<a name="l02026"></a>02026 }
<a name="l02027"></a>02027 
<a name="l02028"></a>02028 <span class="comment">/************************************************************/</span>
<a name="l02029"></a>02029 <span class="comment">/*  wlandrv_IOCTL                                           */</span>
<a name="l02030"></a>02030 <span class="comment">/************************************************************/</span>
<a name="l02031"></a><a class="code" href="wlandrv_8c.html#6f20a2da01210da262972a3590085599">02031</a> <span class="keywordtype">int</span> <a class="code" href="wlandrv_8h.html#6f20a2da01210da262972a3590085599">wlandrv_IOCTL</a>(NUTDEVICE * dev, <span class="keywordtype">int</span> req, <span class="keywordtype">void</span> *conf)
<a name="l02032"></a>02032 {
<a name="l02033"></a>02033     <span class="keywordtype">int</span> error = 0;
<a name="l02034"></a>02034     <span class="keywordtype">int</span> len;
<a name="l02035"></a>02035     <span class="keywordtype">int</span> i;
<a name="l02036"></a>02036     <a class="code" href="wlantypes_8h.html#3aa89f830bb876725b238e6a2a67a809">u_int16_t</a> DataBuffer[6];
<a name="l02037"></a>02037     <span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *sc = (<span class="keyword">struct </span><a class="code" href="structwi__softc.html">wi_softc</a> *) dev-&gt;dev_dcb;
<a name="l02038"></a>02038     <span class="keyword">struct</span> <a class="code" href="structieee80211com.html">ieee80211com</a> *ic = &amp;sc-&gt;<a class="code" href="structwi__softc.html#e91147dbd86fa088a23979e9e232de33">sc_ic</a>;
<a name="l02039"></a>02039     <a class="code" href="struct_w_l_a_n___c_o_n_f_i_g.html">WLAN_CONFIG</a> *pWLANConfig;
<a name="l02040"></a>02040     <a class="code" href="struct_w_l_a_n___s_t_a_t_u_s.html">WLAN_STATUS</a> *pWLANStatus;
<a name="l02041"></a>02041     <a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a> BSSIDAddress[6];
<a name="l02042"></a>02042 
<a name="l02043"></a>02043     if ((sc-&gt;<a class="code" href="structwi__softc.html#1efc3a1ec23d68afa0c5017b4379ec43">wi_gone</a>) || (conf == 0)) {
<a name="l02044"></a>02044         error = -1;
<a name="l02045"></a>02045     } <span class="keywordflow">else</span> {
<a name="l02046"></a>02046 
<a name="l02047"></a>02047         <span class="keywordflow">switch</span> (req) {
<a name="l02048"></a>02048       <span class="comment">/*****************************************************/</span>
<a name="l02049"></a>02049             <span class="comment">/*             WLAN_IOCTL_GET_MAC_ADDRESS            */</span>
<a name="l02050"></a>02050       <span class="comment">/*****************************************************/</span>
<a name="l02051"></a>02051         <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#b156d61a4fff50fc114627145652d98027fc16b31814de503710f6ec0f8cb68b">WLAN_IOCTL_GET_MAC_ADDRESS</a>:{
<a name="l02052"></a>02052                 <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(conf, ic-&gt;<a class="code" href="structieee80211com.html#9fac437a07649434da6af33f39031bd5">ic_myaddr</a>, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l02053"></a>02053                 <span class="keywordflow">break</span>;
<a name="l02054"></a>02054             }                   <span class="comment">/* WLAN_IOCTL_GET_MAC_ADDRESS */</span>
<a name="l02055"></a>02055 
<a name="l02056"></a>02056       <span class="comment">/*****************************************************/</span>
<a name="l02057"></a>02057             <span class="comment">/*                WLAN_IOCTL_SET_CONFIG              */</span>
<a name="l02058"></a>02058       <span class="comment">/*****************************************************/</span>
<a name="l02059"></a>02059         <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#b156d61a4fff50fc114627145652d98001d1b4cfa37fe93aba7ab94536a676cb">WLAN_IOCTL_SET_CONFIG</a>:{
<a name="l02060"></a>02060                 pWLANConfig = (<a class="code" href="struct_w_l_a_n___c_o_n_f_i_g.html">WLAN_CONFIG</a> *) conf;
<a name="l02061"></a>02061 
<a name="l02062"></a>02062                 <span class="keywordflow">if</span> ((pWLANConfig != NULL) &amp;&amp; (pWLANConfig-&gt;Size == <span class="keyword">sizeof</span>(<a class="code" href="struct_w_l_a_n___c_o_n_f_i_g.html">WLAN_CONFIG</a>))) {
<a name="l02063"></a>02063                     <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l02064"></a>02064 
<a name="l02065"></a>02065                     <span class="comment">/* Stop WLAN controller */</span>
<a name="l02066"></a>02066                     <a class="code" href="wlandrv_8c.html#8f5deb1fccddcab4b1d4bca80dfe35b9">wi_stop</a>(sc, 1);
<a name="l02067"></a>02067 
<a name="l02068"></a>02068                     <span class="comment">/* Set mode */</span>
<a name="l02069"></a>02069                     <span class="keywordflow">switch</span> (pWLANConfig-&gt;Mode) {
<a name="l02070"></a>02070                     <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#9850f9b43efb275d6475e2edb63b9810aea2ef80db8408504dec5ef2c5d5a756">WLAN_MODE_STOP</a>:{
<a name="l02071"></a>02071                             <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l02072"></a>02072                             <span class="keywordflow">return</span> (0);
<a name="l02073"></a>02073                             <span class="keywordflow">break</span>;
<a name="l02074"></a>02074                         }
<a name="l02075"></a>02075                     <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#9850f9b43efb275d6475e2edb63b981065e55ff6db67c7729ddd62a9566aa95d">WLAN_MODE_STATION</a>:{
<a name="l02076"></a>02076                             ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> = <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed16322fdc3044a505e723f3da37f9a6653">IEEE80211_M_STA</a>;
<a name="l02077"></a>02077                             <span class="keywordflow">break</span>;
<a name="l02078"></a>02078                         }
<a name="l02079"></a>02079                     <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#9850f9b43efb275d6475e2edb63b9810598fb0cd628b0b69d4b8419c917bd876">WLAN_MODE_ADHOC</a>:{
<a name="l02080"></a>02080                             ic-&gt;<a class="code" href="structieee80211com.html#1118402c744cf1fc5d0427d1adc55298">ic_opmode</a> = <a class="code" href="wlandrv_8h.html#b624e38122a844713ca48c7307772ed180a49ccd179cd8f6b80a405875714648">IEEE80211_M_IBSS</a>;
<a name="l02081"></a>02081                             <span class="keywordflow">break</span>;
<a name="l02082"></a>02082                         }
<a name="l02083"></a>02083                     <span class="keywordflow">default</span>:{
<a name="l02084"></a>02084                             error = -1;
<a name="l02085"></a>02085                             <span class="keywordflow">break</span>;
<a name="l02086"></a>02086                         }
<a name="l02087"></a>02087                     }
<a name="l02088"></a>02088 
<a name="l02089"></a>02089                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02090"></a>02090                         <span class="comment">/* Set SSID */</span>
<a name="l02091"></a>02091                         len = <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(pWLANConfig-&gt;Networkname);
<a name="l02092"></a>02092                         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(ic-&gt;<a class="code" href="structieee80211com.html#d52a9d08fc7fb6b8624c6c0d0996eb40">ic_des_essid</a>, pWLANConfig-&gt;Networkname, len);
<a name="l02093"></a>02093                         ic-&gt;<a class="code" href="structieee80211com.html#a4a30ae7ed338055c04df038e078cd7b">ic_des_esslen</a> = len;
<a name="l02094"></a>02094 
<a name="l02095"></a>02095                         <span class="comment">/* Enable WEP */</span>
<a name="l02096"></a>02096                         <span class="keywordflow">switch</span> (pWLANConfig-&gt;UseWEP) {
<a name="l02097"></a>02097                         <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#c58e96c73604ed64d0283e777f7c17ab1cfed49e029aa8f8ed8d895bc63e2399">WLAN_USE_NO_WEP</a>:{
<a name="l02098"></a>02098                                 ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> &amp;= ~<a class="code" href="wlandrv_8h.html#c3905a90a078707426b886cf7bd82ad4">IEEE80211_F_WEPON</a>;
<a name="l02099"></a>02099                                 <span class="keywordflow">break</span>;
<a name="l02100"></a>02100                             }
<a name="l02101"></a>02101                         <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#c58e96c73604ed64d0283e777f7c17ab38ac5fff5ba9fa976f0c96beaf4930f9">WLAN_USE_64BIT_WEP</a>:
<a name="l02102"></a>02102                         <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#c58e96c73604ed64d0283e777f7c17ab74dabe170860f61381acf59dfd6d1629">WLAN_USE_128BIT_WEP</a>:{
<a name="l02103"></a>02103                                 ic-&gt;<a class="code" href="structieee80211com.html#cf28ded7b4c32ecd02fc6cdb1ec16ada">ic_flags</a> |= <a class="code" href="wlandrv_8h.html#c3905a90a078707426b886cf7bd82ad4">IEEE80211_F_WEPON</a>;
<a name="l02104"></a>02104                                 <span class="keywordflow">break</span>;
<a name="l02105"></a>02105                             }
<a name="l02106"></a>02106                         <span class="keywordflow">default</span>:{
<a name="l02107"></a>02107                                 error = -1;
<a name="l02108"></a>02108                                 <span class="keywordflow">break</span>;
<a name="l02109"></a>02109                             }
<a name="l02110"></a>02110                         }
<a name="l02111"></a>02111 
<a name="l02112"></a>02112                         <span class="comment">/* Set WEP tx key */</span>
<a name="l02113"></a>02113                         ic-&gt;<a class="code" href="structieee80211com.html#da4daa94eb4a3b7a6f3ecb1064ae006a">ic_wep_txkey</a> = pWLANConfig-&gt;UseWEPTxKey;
<a name="l02114"></a>02114 
<a name="l02115"></a>02115                         <span class="comment">/* Set WEP keys */</span>
<a name="l02116"></a>02116                         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="wlan_8h.html#7a07c5561996375f5758fbe183c0e909">WLAN_WEP_MAX_KEY_COUNT</a>; i++) {
<a name="l02117"></a>02117                             ic-&gt;<a class="code" href="structieee80211com.html#5493386b04479db71c6902000f28cf6c">ic_nw_keys</a>[i].<a class="code" href="structieee80211__wepkey.html#473564b832f4bb52dedabd3a74a821d9">wk_len</a> = pWLANConfig-&gt;WEPKey[i].KeyLen;
<a name="l02118"></a>02118                             <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(ic-&gt;<a class="code" href="structieee80211com.html#5493386b04479db71c6902000f28cf6c">ic_nw_keys</a>[i].<a class="code" href="structieee80211__wepkey.html#2389b70c45e7aa2e87b0438dfe11b6ba">wk_key</a>, pWLANConfig-&gt;WEPKey[i].Key, <a class="code" href="wlan_8h.html#7d933ed8db994f1cca9af5fa050c7322">WLAN_WEP_MAX_KEY_SIZE</a>);
<a name="l02119"></a>02119                         }
<a name="l02120"></a>02120                     }
<a name="l02121"></a>02121 
<a name="l02122"></a>02122                     <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l02123"></a>02123 
<a name="l02124"></a>02124                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02125"></a>02125                         <a class="code" href="wlandrv_8h.html#1998f301e3afcbf4f8e6c8cf48efb6f3">wlandrv_Init</a>(dev);
<a name="l02126"></a>02126                     }
<a name="l02127"></a>02127                 } <span class="keywordflow">else</span> {
<a name="l02128"></a>02128                     error = -1;
<a name="l02129"></a>02129                 }
<a name="l02130"></a>02130                 <span class="keywordflow">break</span>;
<a name="l02131"></a>02131             }                   <span class="comment">/* WLAN_IOCTL_SET_CONFIG */</span>
<a name="l02132"></a>02132 
<a name="l02133"></a>02133       <span class="comment">/*****************************************************/</span>
<a name="l02134"></a>02134             <span class="comment">/*                WLAN_IOCTL_GET_STATUS              */</span>
<a name="l02135"></a>02135       <span class="comment">/*****************************************************/</span>
<a name="l02136"></a>02136         <span class="keywordflow">case</span> <a class="code" href="wlan_8h.html#b156d61a4fff50fc114627145652d980160314328280a7b8573f6f488ee8e2d7">WLAN_IOCTL_GET_STATUS</a>:{
<a name="l02137"></a>02137                 pWLANStatus = (<a class="code" href="struct_w_l_a_n___s_t_a_t_u_s.html">WLAN_STATUS</a> *) conf;
<a name="l02138"></a>02138 
<a name="l02139"></a>02139                 <span class="keywordflow">if</span> ((pWLANStatus != NULL) &amp;&amp; (pWLANStatus-&gt;Size == <span class="keyword">sizeof</span>(<a class="code" href="struct_w_l_a_n___s_t_a_t_u_s.html">WLAN_STATUS</a>))) {
<a name="l02140"></a>02140                     <a class="code" href="wlandrv_8c.html#58a65b784325c5c85476f4b9d8b2ad14">WI_LOCK</a>(sc);
<a name="l02141"></a>02141 
<a name="l02142"></a>02142                     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(pWLANStatus, 0x00, <span class="keyword">sizeof</span>(<a class="code" href="struct_w_l_a_n___s_t_a_t_u_s.html">WLAN_STATUS</a>));
<a name="l02143"></a>02143                     pWLANStatus-&gt;Size = <span class="keyword">sizeof</span>(<a class="code" href="struct_w_l_a_n___s_t_a_t_u_s.html">WLAN_STATUS</a>);
<a name="l02144"></a>02144 
<a name="l02145"></a>02145                     <span class="comment">/*</span>
<a name="l02146"></a>02146 <span class="comment">                     * PortStatus</span>
<a name="l02147"></a>02147 <span class="comment">                     */</span>
<a name="l02148"></a>02148                     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(DataBuffer, 0, <span class="keyword">sizeof</span>(DataBuffer));
<a name="l02149"></a>02149                     len = <span class="keyword">sizeof</span>(DataBuffer);
<a name="l02150"></a>02150                     error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#16d6a428c65e6fa59342d6cd6c66a9c4">WI_RID_PORT_STAT</a>, DataBuffer, &amp;len);
<a name="l02151"></a>02151                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02152"></a>02152                         pWLANStatus-&gt;PortStatus = (<a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a>) DataBuffer[0];
<a name="l02153"></a>02153                     }
<a name="l02154"></a>02154 
<a name="l02155"></a>02155                     <span class="comment">/*</span>
<a name="l02156"></a>02156 <span class="comment">                     * Current BSSID</span>
<a name="l02157"></a>02157 <span class="comment">                     */</span>
<a name="l02158"></a>02158                     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(BSSIDAddress, 0, <span class="keyword">sizeof</span>(BSSIDAddress));
<a name="l02159"></a>02159                     len = <span class="keyword">sizeof</span>(BSSIDAddress);
<a name="l02160"></a>02160                     error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#20951087aacde90fb510ff3170699a9a">WI_RID_CURRENT_BSSID</a>, BSSIDAddress, &amp;len);
<a name="l02161"></a>02161                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02162"></a>02162                         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(pWLANStatus-&gt;BSSIDAddress, BSSIDAddress, <a class="code" href="wlandrv_8h.html#453b082a0e442784729071fa4d844dde">IEEE80211_ADDR_LEN</a>);
<a name="l02163"></a>02163                     }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165                     <span class="comment">/*</span>
<a name="l02166"></a>02166 <span class="comment">                     * Current Channel</span>
<a name="l02167"></a>02167 <span class="comment">                     */</span>
<a name="l02168"></a>02168                     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(DataBuffer, 0, <span class="keyword">sizeof</span>(DataBuffer));
<a name="l02169"></a>02169                     len = <span class="keyword">sizeof</span>(DataBuffer);
<a name="l02170"></a>02170                     error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#5f698202e5d4d6a0cbea769111c3da3a">WI_RID_CURRENT_CHAN</a>, DataBuffer, &amp;len);
<a name="l02171"></a>02171                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02172"></a>02172                         pWLANStatus-&gt;Channel = (<a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a>) DataBuffer[0];
<a name="l02173"></a>02173                     }
<a name="l02174"></a>02174 
<a name="l02175"></a>02175                     <span class="comment">/*</span>
<a name="l02176"></a>02176 <span class="comment">                     * Current TxRate</span>
<a name="l02177"></a>02177 <span class="comment">                     */</span>
<a name="l02178"></a>02178                     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(DataBuffer, 0, <span class="keyword">sizeof</span>(DataBuffer));
<a name="l02179"></a>02179                     len = <span class="keyword">sizeof</span>(DataBuffer);
<a name="l02180"></a>02180                     error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#b0e7e5c71df916111d2912a32b1ddc4e">WI_RID_CUR_TX_RATE</a>, DataBuffer, &amp;len);
<a name="l02181"></a>02181                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02182"></a>02182                         pWLANStatus-&gt;TxRate = (<a class="code" href="wlantypes_8h.html#40a40c6e9649a4e3806e76fef247d241">u_int8_t</a>) DataBuffer[0];
<a name="l02183"></a>02183                     }
<a name="l02184"></a>02184 
<a name="l02185"></a>02185                     <span class="comment">/*</span>
<a name="l02186"></a>02186 <span class="comment">                     * Getting Quality</span>
<a name="l02187"></a>02187 <span class="comment">                     */</span>
<a name="l02188"></a>02188                     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(DataBuffer, 0, <span class="keyword">sizeof</span>(DataBuffer));
<a name="l02189"></a>02189                     len = <span class="keyword">sizeof</span>(DataBuffer);
<a name="l02190"></a>02190                     error = wi_read_rid(sc, <a class="code" href="wlandef_8h.html#e0d36d1f7e6f685752e2803a1ae80049">WI_RID_DBM_COMMS_QUAL</a>, DataBuffer, &amp;len);
<a name="l02191"></a>02191                     <span class="keywordflow">if</span> (error == 0) {
<a name="l02192"></a>02192                         pWLANStatus-&gt;Quality = DataBuffer[0];
<a name="l02193"></a>02193                         pWLANStatus-&gt;Signal = DataBuffer[1];
<a name="l02194"></a>02194                         pWLANStatus-&gt;Noise = DataBuffer[2];
<a name="l02195"></a>02195                     }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197                     <a class="code" href="wlandrv_8c.html#12a52d1c23b70d19cee5ebd649a0195a">WI_UNLOCK</a>(sc);
<a name="l02198"></a>02198                 } <span class="keywordflow">else</span> {
<a name="l02199"></a>02199                     error = -1;
<a name="l02200"></a>02200                 }
<a name="l02201"></a>02201 
<a name="l02202"></a>02202                 <span class="keywordflow">break</span>;
<a name="l02203"></a>02203             }                   <span class="comment">/* WLAN_IOCTL_GET_STATUS */</span>
<a name="l02204"></a>02204 
<a name="l02205"></a>02205 
<a name="l02206"></a>02206         <span class="keywordflow">default</span>:{
<a name="l02207"></a>02207                 error = -1;
<a name="l02208"></a>02208                 <span class="keywordflow">break</span>;
<a name="l02209"></a>02209             }
<a name="l02210"></a>02210         }                       <span class="comment">/* switch */</span>
<a name="l02211"></a>02211     }                           <span class="comment">/* sc-&gt;wi_gone */</span>
<a name="l02212"></a>02212 
<a name="l02213"></a>02213 
<a name="l02214"></a>02214     <span class="keywordflow">return</span> (error);
<a name="l02215"></a>02215 }
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
