<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_62cc943d9a5c6ffd14cbda02228b93ec.html">dev</a>
  </div>
<div class="contents">
<h1>x12rtc.c</h1><a href="x12rtc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2005-2007 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 
<a name="l00080"></a>00080 <span class="preprocessor">#include &lt;<a class="code" href="os_8h.html">cfg/os.h</a>&gt;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &lt;<a class="code" href="eeprom_8h.html">cfg/eeprom.h</a>&gt;</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="preprocessor">#include &lt;<a class="code" href="twif_8h.html">dev/twif.h</a>&gt;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 <span class="preprocessor">#include &lt;<a class="code" href="x12rtc_8h.html">dev/x12rtc.h</a>&gt;</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">#if 0</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="comment">/* Use for local debugging. */</span>
<a name="l00096"></a>00096 <span class="preprocessor">#define NUTDEBUG</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#endif</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>
<a name="l00100"></a>00100 <span class="preprocessor">#ifndef I2C_SLA_RTC</span>
<a name="l00101"></a><a class="code" href="x12rtc_8c.html#c51c0bf7789728a1b2d88356c3f789e9">00101</a> <span class="preprocessor"></span><span class="preprocessor">#define I2C_SLA_RTC     0x6F</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a>00104 <span class="preprocessor">#ifndef I2C_SLA_EEPROM</span>
<a name="l00105"></a><a class="code" href="x12rtc_8c.html#f46b456765d52c2be1515e1a1040a40b">00105</a> <span class="preprocessor"></span><span class="preprocessor">#define I2C_SLA_EEPROM  0x57</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>
<a name="l00108"></a>00108 <span class="preprocessor">#ifndef EEPROM_PAGE_SIZE</span>
<a name="l00109"></a><a class="code" href="x12rtc_8c.html#ddfda15f5f3ec6f8f325f48be50c548a">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define EEPROM_PAGE_SIZE    64</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>
<a name="l00112"></a>00112 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> rtc_chip;
<a name="l00113"></a>00113 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> rtc_status;
<a name="l00114"></a>00114 
<a name="l00123"></a>00123 <span class="keyword">static</span> <span class="keywordtype">int</span> X12WriteEnable(<span class="keywordtype">int</span> on)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125     <span class="keywordtype">int</span> rc;
<a name="l00126"></a>00126     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> buf[3];
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     buf[0] = 0;
<a name="l00129"></a>00129     buf[1] = 0x3F;
<a name="l00130"></a>00130     <span class="keywordflow">if</span> (on) {
<a name="l00131"></a>00131         buf[2] = 0x02;
<a name="l00132"></a>00132         <span class="keywordflow">if</span> ((rc = <a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="ds1307rtc_8c.html#c51c0bf7789728a1b2d88356c3f789e9">I2C_SLA_RTC</a>, buf, 3, 0, 0, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>)) == 0) {
<a name="l00133"></a>00133             buf[2] = 0x06;
<a name="l00134"></a>00134             rc = <a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="ds1307rtc_8c.html#c51c0bf7789728a1b2d88356c3f789e9">I2C_SLA_RTC</a>, buf, 3, 0, 0, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136     } <span class="keywordflow">else</span> {
<a name="l00137"></a>00137         buf[2] = 0x00;
<a name="l00138"></a>00138         rc = <a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="ds1307rtc_8c.html#c51c0bf7789728a1b2d88356c3f789e9">I2C_SLA_RTC</a>, buf, 3, 0, 0, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140     <span class="keywordflow">return</span> rc;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00148"></a>00148 <span class="keyword">static</span> <span class="keywordtype">int</span> X12WaitReady(<span class="keywordtype">void</span>)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> poll;
<a name="l00151"></a>00151     <span class="keywordtype">int</span> cnt = 200; <span class="comment">/* Ethernut 3 needs about 50 loops, so this is quite save. */</span>
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="comment">/* </span>
<a name="l00154"></a>00154 <span class="comment">     * Poll for write cycle finished. We can't use a sleep here, because our</span>
<a name="l00155"></a>00155 <span class="comment">     * X12xx routines are not re-entrant.</span>
<a name="l00156"></a>00156 <span class="comment">     */</span>
<a name="l00157"></a>00157     <span class="keywordflow">while</span> (--cnt &amp;&amp; <a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="x12rtc_8c.html#f46b456765d52c2be1515e1a1040a40b">I2C_SLA_EEPROM</a>, 0, 0, &amp;poll, 1, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>) == -1);
<a name="l00158"></a>00158 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[RtcRdy:%d]"</span>, 200 - cnt);
<a name="l00160"></a>00160 <span class="preprocessor">#endif</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>
<a name="l00162"></a>00162     <span class="keywordflow">return</span> cnt ? 0 : -1;
<a name="l00163"></a>00163 }
<a name="l00164"></a>00164 
<a name="l00174"></a><a class="code" href="x12rtc_8c.html#7947dea51e9ee22c94e660e927bef650">00174</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#17671c680b4a9179397c385cacee07d3" title="Read RTC registers.">X12RtcReadRegs</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> reg, <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *buff, <span class="keywordtype">size_t</span> cnt)
<a name="l00175"></a>00175 {
<a name="l00176"></a>00176     <span class="keywordtype">int</span> rc = -1;
<a name="l00177"></a>00177     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> wbuf[2];
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     wbuf[0] = 0;
<a name="l00180"></a>00180     wbuf[1] = reg;
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (<a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="ds1307rtc_8c.html#c51c0bf7789728a1b2d88356c3f789e9">I2C_SLA_RTC</a>, wbuf, 2, buff, cnt, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>) == cnt) {
<a name="l00182"></a>00182 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[Rtc$%02x&gt;"</span>, reg);
<a name="l00184"></a>00184         <span class="keywordflow">while</span>(cnt--) {
<a name="l00185"></a>00185             <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">" %02x"</span>, *buff++);
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187         <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">']'</span>);
<a name="l00188"></a>00188 <span class="preprocessor">#endif</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>        rc = 0;
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     <span class="keywordflow">return</span> rc;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00207"></a><a class="code" href="x12rtc_8c.html#23e5c16152b7f3d14927dba342ca0954">00207</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#cbf1e224a503e167647b2bf7aea745fe" title="Write to RTC registers.">X12RtcWrite</a>(<span class="keywordtype">int</span> nv, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *buff, <span class="keywordtype">size_t</span> cnt)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209     <span class="keywordtype">int</span> rc;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="keywordflow">if</span> ((rc = X12WriteEnable(1)) == 0) {
<a name="l00212"></a>00212         rc = <a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="ds1307rtc_8c.html#c51c0bf7789728a1b2d88356c3f789e9">I2C_SLA_RTC</a>, buff, cnt, 0, 0, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (rc == 0 &amp;&amp; nv) {
<a name="l00214"></a>00214             rc = X12WaitReady();
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216         X12WriteEnable(0);
<a name="l00217"></a>00217 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[Rtc$%02X&lt;"</span>, *++buff);
<a name="l00219"></a>00219         cnt -= 2;
<a name="l00220"></a>00220         <span class="keywordflow">while</span>(cnt--) {
<a name="l00221"></a>00221             <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">" %02x"</span>, *++buff);
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223         <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">']'</span>);
<a name="l00224"></a>00224 <span class="preprocessor">#endif</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>    }
<a name="l00226"></a>00226     <span class="keywordflow">return</span> rc;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00239"></a><a class="code" href="x12rtc_8c.html#064966fba1b531fd7ccd2b64ae5c521b">00239</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#064966fba1b531fd7ccd2b64ae5c521b" title="Get date and time from an X12xx hardware clock.">X12RtcGetClock</a>(<span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *tm)
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241     <span class="keywordtype">int</span> rc;
<a name="l00242"></a>00242     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> data[8];
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <span class="keywordflow">if</span> ((rc = <a class="code" href="x12rtc_8h.html#17671c680b4a9179397c385cacee07d3" title="Read RTC registers.">X12RtcReadRegs</a>(<a class="code" href="x12rtc_8h.html#e86be507ed5114ed2bb50728803414f4">X12RTC_SC</a>, data, 8)) == 0) {
<a name="l00245"></a>00245         tm-&gt;<a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[0]);
<a name="l00246"></a>00246         tm-&gt;<a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[1]);
<a name="l00247"></a>00247         tm-&gt;<a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[2] &amp; 0x3F);
<a name="l00248"></a>00248         tm-&gt;<a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[3]);
<a name="l00249"></a>00249         tm-&gt;<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[4]) - 1;
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (rtc_chip) {
<a name="l00251"></a>00251             tm-&gt;<a class="code" href="struct__tm.html#33adf78fd6476b2120ce3b9c4a852053" title="years since 1900">tm_year</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[5]) + 100;
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         <span class="keywordflow">else</span> {
<a name="l00254"></a>00254             tm-&gt;<a class="code" href="struct__tm.html#33adf78fd6476b2120ce3b9c4a852053" title="years since 1900">tm_year</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[5]);
<a name="l00255"></a>00255             <span class="keywordflow">if</span> (data[7] == 0x20) {
<a name="l00256"></a>00256                 tm-&gt;<a class="code" href="struct__tm.html#33adf78fd6476b2120ce3b9c4a852053" title="years since 1900">tm_year</a> += 100;
<a name="l00257"></a>00257             }
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259         tm-&gt;<a class="code" href="struct__tm.html#fe81a8c46f1c693c43f259b288859f4f" title="days since Sunday - [0,6]">tm_wday</a> = data[6];
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261     <span class="keywordflow">return</span> rc;
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00276"></a><a class="code" href="x12rtc_8c.html#5d3fff18c845694ea7c770e20b243102">00276</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#5d3fff18c845694ea7c770e20b243102" title="Set an X12xx hardware clock.">X12RtcSetClock</a>(<a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *tm)
<a name="l00277"></a>00277 {
<a name="l00278"></a>00278     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> data[10];
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00281"></a>00281     <span class="keywordflow">if</span> (tm) {
<a name="l00282"></a>00282         data[1] = <a class="code" href="x12rtc_8h.html#e86be507ed5114ed2bb50728803414f4">X12RTC_SC</a>;
<a name="l00283"></a>00283         data[2] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_sec);
<a name="l00284"></a>00284         data[3] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_min);
<a name="l00285"></a>00285         data[4] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_hour) | 0x80;
<a name="l00286"></a>00286         data[5] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_mday);
<a name="l00287"></a>00287         data[6] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_mon + 1);
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (rtc_chip) {
<a name="l00290"></a>00290             <span class="comment">/* X1286. */</span>
<a name="l00291"></a>00291             data[7] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_year % 100);
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293         <span class="comment">/* X1226. */</span>
<a name="l00294"></a>00294         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tm-&gt;tm_year &gt; 99) {
<a name="l00295"></a>00295             data[7] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_year - 100);
<a name="l00296"></a>00296             data[9] = 0x20;
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         <span class="keywordflow">else</span> {
<a name="l00299"></a>00299             data[7] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_year);
<a name="l00300"></a>00300             data[9] = 0x19;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         data[8] = tm-&gt;tm_wday;
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304     <span class="keywordflow">return</span> <a class="code" href="x12rtc_8h.html#cbf1e224a503e167647b2bf7aea745fe" title="Write to RTC registers.">X12RtcWrite</a>(0, data, 10);
<a name="l00305"></a>00305 }
<a name="l00306"></a>00306 
<a name="l00320"></a><a class="code" href="x12rtc_8c.html#b57af922d4203f808a76188b54fa3937">00320</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#b57af922d4203f808a76188b54fa3937" title="Get alarm date and time of an X12xx hardware clock.">X12RtcGetAlarm</a>(<span class="keywordtype">int</span> idx, <span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *tm, <span class="keywordtype">int</span> *aflgs)
<a name="l00321"></a>00321 {
<a name="l00322"></a>00322     <span class="keywordtype">int</span> rc;
<a name="l00323"></a>00323     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> data[8];
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     *aflgs = 0;
<a name="l00326"></a>00326     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(tm, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a>));
<a name="l00327"></a>00327     <span class="keywordflow">if</span> ((rc = <a class="code" href="x12rtc_8h.html#17671c680b4a9179397c385cacee07d3" title="Read RTC registers.">X12RtcReadRegs</a>(idx * 8, data, 8)) == 0) {
<a name="l00328"></a>00328         <span class="keywordflow">if</span> (data[0] &amp; <a class="code" href="x12rtc_8h.html#5a95f6a278d1061f6358d29dc53fe398" title="Second alarm enabled.">X12RTC_SCA_ESC</a>) {
<a name="l00329"></a>00329             *aflgs |= <a class="code" href="rtc_8h.html#69efad7ac15a4a7149f8a4ddd471c10c">RTC_ALARM_SECOND</a>;
<a name="l00330"></a>00330             tm-&gt;<a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[0] &amp; 0x7F);
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332         <span class="keywordflow">if</span> (data[1] &amp; <a class="code" href="x12rtc_8h.html#937cd6fa6c6dcc90fe8f63aaa73b7981" title="Minute alarm enabled.">X12RTC_MNA_EMN</a>) {
<a name="l00333"></a>00333             *aflgs |= <a class="code" href="rtc_8h.html#7d028dce1bb476be251ffad9f68bbe27">RTC_ALARM_MINUTE</a>;
<a name="l00334"></a>00334             tm-&gt;<a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[1]);
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336         <span class="keywordflow">if</span> (data[2] &amp; <a class="code" href="x12rtc_8h.html#cbd1abf7e7c5943ade1676a9f9b0576e" title="Hour alarm enabled.">X12RTC_HRA_EHR</a>) {
<a name="l00337"></a>00337             *aflgs |= <a class="code" href="rtc_8h.html#b985eab103d5cf66e49a7a8c66bfd835">RTC_ALARM_HOUR</a>;
<a name="l00338"></a>00338             tm-&gt;<a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[2] &amp; ~0x80);
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (data[3] &amp; <a class="code" href="x12rtc_8h.html#ce2546ff32e55343af645574d8a6b206" title="Day of month alarm enabled.">X12RTC_DTA_EDT</a>) {
<a name="l00341"></a>00341             *aflgs |= <a class="code" href="rtc_8h.html#bae7313df60c0b47fcc86323eb18f1bc">RTC_ALARM_MDAY</a>;
<a name="l00342"></a>00342             tm-&gt;<a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[3]);
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344         <span class="keywordflow">if</span> (data[4] &amp; <a class="code" href="x12rtc_8h.html#cd5422a6d293e17cf04dd2d1fb54ba18" title="Month alarm enabled.">X12RTC_MOA_EMO</a>) {
<a name="l00345"></a>00345             *aflgs |= <a class="code" href="rtc_8h.html#8888e3c5a3727c2a845534bdaae81330">RTC_ALARM_MONTH</a>;
<a name="l00346"></a>00346             tm-&gt;<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[4]) - 1;
<a name="l00347"></a>00347         }
<a name="l00348"></a>00348         <span class="keywordflow">if</span> (data[6] &amp; <a class="code" href="x12rtc_8h.html#362a258bd9eea60287742cb156f3c537" title="Weekday alarm enabled.">X12RTC_DWA_EDW</a>) {
<a name="l00349"></a>00349             *aflgs |= <a class="code" href="rtc_8h.html#2dbaf661cd1e52f8a9bf7b82510ac523">RTC_ALARM_WDAY</a>;
<a name="l00350"></a>00350             tm-&gt;<a class="code" href="struct__tm.html#fe81a8c46f1c693c43f259b288859f4f" title="days since Sunday - [0,6]">tm_wday</a> = <a class="code" href="rtc_8h.html#5efc5a2167d86820ac7d5201ca5a7190" title="Convert binary coded decimal to binary value.">BCD2BIN</a>(data[6]);
<a name="l00351"></a>00351         }
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353     <span class="keywordflow">return</span> rc;
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00374"></a><a class="code" href="x12rtc_8c.html#896520f5d3dc5c6997ff5eaff180ef91">00374</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#896520f5d3dc5c6997ff5eaff180ef91" title="Set alarm of an X12xx hardware clock.">X12RtcSetAlarm</a>(<span class="keywordtype">int</span> idx, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *tm, <span class="keywordtype">int</span> aflgs)
<a name="l00375"></a>00375 {
<a name="l00376"></a>00376     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> data[10];
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(data, 0, <span class="keyword">sizeof</span>(data));
<a name="l00379"></a>00379     data[1] = idx * 8;
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (tm) {
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (aflgs &amp; <a class="code" href="rtc_8h.html#69efad7ac15a4a7149f8a4ddd471c10c">RTC_ALARM_SECOND</a>) {
<a name="l00382"></a>00382             data[2] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_sec) | <a class="code" href="x12rtc_8h.html#5a95f6a278d1061f6358d29dc53fe398" title="Second alarm enabled.">X12RTC_SCA_ESC</a>;
<a name="l00383"></a>00383         }
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (aflgs &amp; <a class="code" href="rtc_8h.html#7d028dce1bb476be251ffad9f68bbe27">RTC_ALARM_MINUTE</a>) {
<a name="l00385"></a>00385             data[3] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_min) | <a class="code" href="x12rtc_8h.html#937cd6fa6c6dcc90fe8f63aaa73b7981" title="Minute alarm enabled.">X12RTC_MNA_EMN</a>;
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387         <span class="keywordflow">if</span> (aflgs &amp; <a class="code" href="rtc_8h.html#b985eab103d5cf66e49a7a8c66bfd835">RTC_ALARM_HOUR</a>) {
<a name="l00388"></a>00388             data[4] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_hour) | <a class="code" href="x12rtc_8h.html#cbd1abf7e7c5943ade1676a9f9b0576e" title="Hour alarm enabled.">X12RTC_HRA_EHR</a>;
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (aflgs &amp; <a class="code" href="rtc_8h.html#bae7313df60c0b47fcc86323eb18f1bc">RTC_ALARM_MDAY</a>) {
<a name="l00391"></a>00391             data[5] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_mday) | <a class="code" href="x12rtc_8h.html#ce2546ff32e55343af645574d8a6b206" title="Day of month alarm enabled.">X12RTC_DTA_EDT</a>;
<a name="l00392"></a>00392         }
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (aflgs &amp; <a class="code" href="rtc_8h.html#8888e3c5a3727c2a845534bdaae81330">RTC_ALARM_MONTH</a>) {
<a name="l00394"></a>00394             data[6] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_mon + 1) | <a class="code" href="x12rtc_8h.html#cd5422a6d293e17cf04dd2d1fb54ba18" title="Month alarm enabled.">X12RTC_MOA_EMO</a>;
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396         <span class="keywordflow">if</span> (aflgs &amp; <a class="code" href="rtc_8h.html#2dbaf661cd1e52f8a9bf7b82510ac523">RTC_ALARM_WDAY</a>) {
<a name="l00397"></a>00397             data[8] = <a class="code" href="rtc_8h.html#cae2964cdd3fefd8c560e1cdaaa0ad1e" title="Convert binary to binary coded decimal value.">BIN2BCD</a>(tm-&gt;tm_wday) | <a class="code" href="x12rtc_8h.html#362a258bd9eea60287742cb156f3c537" title="Weekday alarm enabled.">X12RTC_DWA_EDW</a>;
<a name="l00398"></a>00398         }
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400     <span class="keywordflow">return</span> <a class="code" href="x12rtc_8h.html#cbf1e224a503e167647b2bf7aea745fe" title="Write to RTC registers.">X12RtcWrite</a>(1, data, 10);
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00415"></a><a class="code" href="x12rtc_8c.html#b07d10a89ab2a8815997e3c2dd3bf41e">00415</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#b07d10a89ab2a8815997e3c2dd3bf41e" title="Query RTC status flags.">X12RtcGetStatus</a>(<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *sflgs)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <span class="keywordtype">int</span> rc;
<a name="l00418"></a>00418     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> data;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420     <span class="keywordflow">if</span> ((rc = <a class="code" href="x12rtc_8h.html#17671c680b4a9179397c385cacee07d3" title="Read RTC registers.">X12RtcReadRegs</a>(<a class="code" href="x12rtc_8h.html#7124bd6cc859d43eacdd77fcaba35ed4">X12RTC_SR</a>, &amp;data, 1)) == 0) {
<a name="l00421"></a>00421         rtc_status |= data;
<a name="l00422"></a>00422         *sflgs = rtc_status;
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     <span class="keywordflow">return</span> rc;
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00436"></a><a class="code" href="x12rtc_8c.html#1407db5b616d125020d843d602caaafb">00436</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#1407db5b616d125020d843d602caaafb" title="Clear RTC status flags.">X12RtcClearStatus</a>(<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> sflgs)
<a name="l00437"></a>00437 {
<a name="l00438"></a>00438     rtc_status &amp;= ~sflgs;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="keywordflow">return</span> 0;
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a><a class="code" href="x12rtc_8c.html#8ea7ee804bfcd8c92052c34e8bc173fb">00443</a> NUTRTC <a class="code" href="x12rtc_8h.html#8ea7ee804bfcd8c92052c34e8bc173fb">rtcX12x6</a> = {
<a name="l00444"></a>00444     <a class="code" href="x12rtc_8h.html#305d0637a6a98425e7a28badcefa0466" title="Initialize the interface to an Intersil X12xx hardware clock.">X12Init</a>,            
<a name="l00445"></a>00445     <a class="code" href="x12rtc_8h.html#064966fba1b531fd7ccd2b64ae5c521b" title="Get date and time from an X12xx hardware clock.">X12RtcGetClock</a>,     
<a name="l00446"></a>00446     <a class="code" href="x12rtc_8h.html#5d3fff18c845694ea7c770e20b243102" title="Set an X12xx hardware clock.">X12RtcSetClock</a>,     
<a name="l00447"></a>00447     <a class="code" href="x12rtc_8h.html#b57af922d4203f808a76188b54fa3937" title="Get alarm date and time of an X12xx hardware clock.">X12RtcGetAlarm</a>,     
<a name="l00448"></a>00448     <a class="code" href="x12rtc_8h.html#896520f5d3dc5c6997ff5eaff180ef91" title="Set alarm of an X12xx hardware clock.">X12RtcSetAlarm</a>,     
<a name="l00449"></a>00449     <a class="code" href="x12rtc_8h.html#b07d10a89ab2a8815997e3c2dd3bf41e" title="Query RTC status flags.">X12RtcGetStatus</a>,    
<a name="l00450"></a>00450     <a class="code" href="x12rtc_8h.html#1407db5b616d125020d843d602caaafb" title="Clear RTC status flags.">X12RtcClearStatus</a>   
<a name="l00451"></a>00451 };
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 
<a name="l00463"></a><a class="code" href="x12rtc_8c.html#8236fbe59011df5bc9db072de31128c3">00463</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#8236fbe59011df5bc9db072de31128c3" title="Read contents from non-volatile EEPROM.">X12EepromRead</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> addr, <span class="keywordtype">void</span> *buff, <span class="keywordtype">size_t</span> len)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465     <span class="keywordtype">int</span> rc = -1;
<a name="l00466"></a>00466     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> wbuf[2];
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     wbuf[0] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)(addr &gt;&gt; 8);
<a name="l00469"></a>00469     wbuf[1] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)addr;
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (<a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="x12rtc_8c.html#f46b456765d52c2be1515e1a1040a40b">I2C_SLA_EEPROM</a>, wbuf, 2, buff, len, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>) == len) {
<a name="l00471"></a>00471         rc = 0;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="keywordflow">return</span> rc;
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00488"></a><a class="code" href="x12rtc_8c.html#bee38edf014cf9a82b94c2e0a52d895e">00488</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#bee38edf014cf9a82b94c2e0a52d895e" title="Store buffer contents in non-volatile EEPROM.">X12EepromWrite</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> addr, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *buff, <span class="keywordtype">size_t</span> len)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <span class="keywordtype">int</span> rc = 0;
<a name="l00491"></a>00491     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *wbuf;
<a name="l00492"></a>00492     <span class="keywordtype">size_t</span> wlen;
<a name="l00493"></a>00493     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *wp = buff;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="comment">/*</span>
<a name="l00496"></a>00496 <span class="comment">     * Loop for each page to be written to.</span>
<a name="l00497"></a>00497 <span class="comment">     */</span>
<a name="l00498"></a>00498     <span class="keywordflow">while</span> (len) {
<a name="l00499"></a>00499         <span class="comment">/* Do not cross page boundaries. */</span>
<a name="l00500"></a>00500         wlen = <a class="code" href="x12rtc_8c.html#ddfda15f5f3ec6f8f325f48be50c548a">EEPROM_PAGE_SIZE</a> - (addr &amp; (<a class="code" href="x12rtc_8c.html#ddfda15f5f3ec6f8f325f48be50c548a">EEPROM_PAGE_SIZE</a> - 1));
<a name="l00501"></a>00501         <span class="keywordflow">if</span> (wlen &gt; len) {
<a name="l00502"></a>00502             wlen = len;
<a name="l00503"></a>00503         }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505         <span class="comment">/* Allocate and set a TWI write buffer. */</span>
<a name="l00506"></a>00506         <span class="keywordflow">if</span> ((wbuf = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(wlen + 2)) == 0) {
<a name="l00507"></a>00507             rc = -1;
<a name="l00508"></a>00508             <span class="keywordflow">break</span>;
<a name="l00509"></a>00509         }
<a name="l00510"></a>00510         wbuf[0] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)(addr &gt;&gt; 8);
<a name="l00511"></a>00511         wbuf[1] = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)addr;
<a name="l00512"></a>00512         <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(wbuf + 2, (<span class="keywordtype">void</span> *)wp, wlen);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514         <span class="comment">/* Enable EEPROM write access and send the write buffer. */</span>
<a name="l00515"></a>00515         <span class="keywordflow">if</span> ((rc = X12WriteEnable(1)) == 0) {
<a name="l00516"></a>00516             rc = <a class="code" href="group__xg_at91_twi.html#gbe6654261c61050f912f4ad48458d7d2" title="Transmit and/or receive data as a master.">TwMasterTransact</a>(<a class="code" href="x12rtc_8c.html#f46b456765d52c2be1515e1a1040a40b">I2C_SLA_EEPROM</a>, wbuf, wlen + 2, 0, 0, <a class="code" href="group__xg_event.html#gee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l00517"></a>00517         }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <span class="comment">/* Release the buffer and check the result. */</span>
<a name="l00520"></a>00520         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(wbuf);
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (rc) {
<a name="l00522"></a>00522             <span class="keywordflow">break</span>;
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524         len -= wlen;
<a name="l00525"></a>00525         addr += wlen;
<a name="l00526"></a>00526         wp += wlen;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <span class="comment">/* Poll for write cycle finished. */</span>
<a name="l00529"></a>00529         <span class="keywordflow">if</span> ((rc = X12WaitReady()) != 0) {
<a name="l00530"></a>00530             <span class="keywordflow">break</span>;
<a name="l00531"></a>00531         }
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533     X12WriteEnable(0);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="keywordflow">return</span> rc;
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00546"></a><a class="code" href="x12rtc_8c.html#305d0637a6a98425e7a28badcefa0466">00546</a> <span class="keywordtype">int</span> <a class="code" href="x12rtc_8h.html#305d0637a6a98425e7a28badcefa0466" title="Initialize the interface to an Intersil X12xx hardware clock.">X12Init</a>(<span class="keywordtype">void</span>)
<a name="l00547"></a>00547 {
<a name="l00548"></a>00548     <span class="keywordtype">int</span> rc;
<a name="l00549"></a>00549     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> tmp;
<a name="l00550"></a>00550     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> data[2];
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="comment">/* Initialize I2C bus. */</span>
<a name="l00553"></a>00553     <span class="keywordflow">if</span> ((rc = <a class="code" href="group__xg_at91_twi.html#ga4c8ead7d93be00c8a12be08e64f1666" title="Initialize TWI interface.">TwInit</a>(0)) == 0) {
<a name="l00554"></a>00554         <span class="comment">/* Query RTC status. */</span>
<a name="l00555"></a>00555         <span class="keywordflow">if</span> ((rc = <a class="code" href="x12rtc_8h.html#b07d10a89ab2a8815997e3c2dd3bf41e" title="Query RTC status flags.">X12RtcGetStatus</a>(&amp;tmp)) == 0) {
<a name="l00556"></a>00556             <span class="comment">/*</span>
<a name="l00557"></a>00557 <span class="comment">             * If I2C initialization and RTC status query succeeded, try</span>
<a name="l00558"></a>00558 <span class="comment">             * to determine the chip we got. On Ethernut 3.0 Rev-D the</span>
<a name="l00559"></a>00559 <span class="comment">             * X1226 had been mounted, while the X1286 is used on Rev-E</span>
<a name="l00560"></a>00560 <span class="comment">             * boards. We read register address 0x0037, which is the</span>
<a name="l00561"></a>00561 <span class="comment">             * century on the X1226, but the hundreds of seconds on the</span>
<a name="l00562"></a>00562 <span class="comment">             * X1286. Thus, the register contents on the latter will cange</span>
<a name="l00563"></a>00563 <span class="comment">             * every 10 milliseconds, while it is fixed to 19 or 20 on</span>
<a name="l00564"></a>00564 <span class="comment">             * the first one.</span>
<a name="l00565"></a>00565 <span class="comment">             */</span>
<a name="l00566"></a>00566             <a class="code" href="x12rtc_8h.html#17671c680b4a9179397c385cacee07d3" title="Read RTC registers.">X12RtcReadRegs</a>(<a class="code" href="x12rtc_8h.html#e98b179acddfae698e6044474fac95c5">X128xRTC_SSEC</a>, &amp;data[0], 1);
<a name="l00567"></a>00567             <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(20);
<a name="l00568"></a>00568             <a class="code" href="x12rtc_8h.html#17671c680b4a9179397c385cacee07d3" title="Read RTC registers.">X12RtcReadRegs</a>(<a class="code" href="x12rtc_8h.html#e98b179acddfae698e6044474fac95c5">X128xRTC_SSEC</a>, &amp;data[1], 1);
<a name="l00569"></a>00569             <span class="keywordflow">if</span> (data[0] != data[1]) {
<a name="l00570"></a>00570                 rtc_chip = 1;
<a name="l00571"></a>00571             }
<a name="l00572"></a>00572 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00573"></a>00573 <span class="preprocessor"></span>            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[RTC=X12%c6]"</span>, rtc_chip ? <span class="charliteral">'8'</span> : <span class="charliteral">'2'</span>);
<a name="l00574"></a>00574 <span class="preprocessor">#endif</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>        }
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577     <span class="keywordflow">return</span> rc;
<a name="l00578"></a>00578 }
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
