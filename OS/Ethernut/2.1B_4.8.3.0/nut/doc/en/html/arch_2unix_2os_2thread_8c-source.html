<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_264e76a43993b4d38befcb6805fdec2d.html">arch</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_5b20284563abb99fd48bba427a81ed0c.html">unix</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_27a5e0e6bdfed06eca005589655e5d46.html">os</a>
  </div>
<div class="contents">
<h1>thread.c</h1><a href="arch_2unix_2os_2thread_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2000-2004 by ETH Zurich</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY ETH ZURICH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL ETH ZURICH</span>
<a name="l00021"></a>00021 <span class="comment"> *  OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">/* </span>
<a name="l00035"></a>00035 <span class="comment"> * unix_thread.c - unix emulation of cooperative threads using pthreads</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * 2004.04.01 Matthias Ringwald &lt;matthias.ringwald@inf.ethz.ch&gt;</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;<a class="code" href="os_8h.html">cfg/os.h</a>&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">// #include &lt;cfg/memory.h&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html" title="Nut/OS type declarations.">sys/types.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;<a class="code" href="include_2sys_2atom_8h.html">sys/atom.h</a>&gt;</span>
<a name="l00052"></a>00052 <span class="comment">// #include &lt;sys/timer.h&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="osdebug_8h.html">sys/osdebug.h</a>&gt;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a>00059 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/* reused parameters for other calls */</span>
<a name="l00066"></a><a class="code" href="group__xg_nut_arch_unix_os_context.html#g324189adc86f9f14b363b10e4f9241f3">00066</a> pthread_attr_t <a class="code" href="group__xg_nut_arch_unix_os_context.html#g324189adc86f9f14b363b10e4f9241f3">attr</a>;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">/* protect thread signaling */</span>
<a name="l00069"></a><a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">00069</a> pthread_mutex_t <a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">/* to get a new thread start acked'd */</span>
<a name="l00072"></a><a class="code" href="group__xg_nut_arch_unix_os_context.html#g1064dcccca836197ff07f48cd33a6074">00072</a> pthread_cond_t <a class="code" href="group__xg_nut_arch_unix_os_context.html#g1064dcccca836197ff07f48cd33a6074">main_cv</a>;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">/* level of critical sections entered but not left outside a thread */</span>
<a name="l00075"></a><a class="code" href="group__xg_nut_arch_unix_os_context.html#g7d030f0c50ed9df185f74d58855bea88">00075</a> <a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="group__xg_nut_arch_unix_os_context.html#g7d030f0c50ed9df185f74d58855bea88">main_cs_level</a>;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/* has to be initialized once */</span>
<a name="l00078"></a><a class="code" href="group__xg_nut_arch_unix_os_context.html#gb455d63a630ebab93f2f2753df39185e">00078</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_nut_arch_unix_os_context.html#gb455d63a630ebab93f2f2753df39185e">NutThreadInit</a>(<span class="keywordtype">void</span>)
<a name="l00079"></a>00079 {
<a name="l00080"></a>00080     <span class="comment">/* Initialize mutex and condition variable objects */</span>
<a name="l00081"></a>00081     pthread_mutex_init(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>, NULL);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     pthread_attr_init(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#g324189adc86f9f14b363b10e4f9241f3">attr</a>);
<a name="l00084"></a>00084     pthread_attr_setdetachstate(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#g324189adc86f9f14b363b10e4f9241f3">attr</a>, PTHREAD_CREATE_JOINABLE);
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="comment">// main_cv init</span>
<a name="l00087"></a>00087     pthread_cond_init(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#g1064dcccca836197ff07f48cd33a6074">main_cv</a>, NULL);
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">/*</span>
<a name="l00092"></a>00092 <span class="comment"> * This code is executed when entering a thread.</span>
<a name="l00093"></a>00093 <span class="comment"> *  </span>
<a name="l00094"></a>00094 <span class="comment"> *</span>
<a name="l00095"></a>00095 <span class="comment"> */</span>
<a name="l00096"></a>00096 <span class="keyword">static</span> <span class="keywordtype">void</span> *NutThreadEntry(<span class="keywordtype">void</span> *arg);
<a name="l00097"></a>00097 <span class="keyword">static</span> <span class="keywordtype">void</span> *NutThreadEntry(<span class="keywordtype">void</span> *arg)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <span class="comment">// get THREADINFO back</span>
<a name="l00100"></a>00100     NUTTHREADINFO *td = (NUTTHREADINFO *) arg;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="comment">// confirm start</span>
<a name="l00103"></a>00103     pthread_mutex_lock(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00104"></a>00104     pthread_cond_signal(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#g1064dcccca836197ff07f48cd33a6074">main_cv</a>);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="comment">// wait for start signaled</span>
<a name="l00107"></a>00107     pthread_cond_wait(&amp;td-&gt;td_cv, &amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00108"></a>00108     pthread_mutex_unlock(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <span class="comment">// set critical section value </span>
<a name="l00111"></a>00111     td-&gt;td_cs_level = 0;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="comment">// enable interrupts</span>
<a name="l00114"></a>00114     pthread_sigmask(SIG_UNBLOCK, &amp;<a class="code" href="include_2arch_2unix_2atom_8h.html#7c4baba7be9ead5025b37220b7e07a54">irq_signal</a>, 0);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="comment">// call real function</span>
<a name="l00117"></a>00117     td-&gt;td_fn(td-&gt;td_arg);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">// NutExitCritical();</span>
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="comment">// tell nut/os about it</span>
<a name="l00122"></a>00122     <a class="code" href="group__xg_thread.html#gd86d73178ce22d0a32ae83ec775c4722" title="End the current thread.">NutThreadExit</a>();
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <span class="comment">// thread exit routine </span>
<a name="l00125"></a>00125     pthread_exit(NULL);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="comment">// make some compilers happy</span>
<a name="l00128"></a>00128     <span class="keywordflow">return</span> NULL;
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00143"></a>00143 <span class="keywordtype">void</span> <a class="code" href="group__xg_nut_arch_avr_os_context_icc.html#gd63408e1c4ef1c03d9f979ad2d31b7e0" title="Switch to another thread.">NutThreadSwitch</a>(<span class="keywordtype">void</span>);
<a name="l00144"></a>00144 <span class="keywordtype">void</span> <a class="code" href="group__xg_nut_arch_avr_os_context_icc.html#gd63408e1c4ef1c03d9f979ad2d31b7e0" title="Switch to another thread.">NutThreadSwitch</a>(<span class="keywordtype">void</span>)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     NUTTHREADINFO *myself;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">// lock thread switching mutex</span>
<a name="l00151"></a>00151     pthread_mutex_lock(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <span class="comment">// next thread is the first one in the run queue</span>
<a name="l00154"></a>00154     myself = <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>;
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> != <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>) {
<a name="l00156"></a>00156 
<a name="l00157"></a>00157         <span class="comment">// switching call</span>
<a name="l00158"></a>00158         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> = <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>;
<a name="l00159"></a>00159         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_state = <a class="code" href="thread_8h.html#6c7d2e848e80e808dece40238a9554d6">TDS_RUNNING</a>;
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         pthread_cond_signal(&amp;<a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>-&gt;td_cv);
<a name="l00162"></a>00162         pthread_cond_wait(&amp;myself-&gt;td_cv, &amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165     pthread_mutex_unlock(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 
<a name="l00172"></a>00172 
<a name="l00191"></a><a class="code" href="group__xg_nut_arch_unix_os_context.html#g8357f2631f0c0a9444844e5ea64be50d">00191</a> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> <a class="code" href="group__xg_nut_arch_avr_os_context_gcc.html#g8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="keywordtype">char</span> * name, <span class="keywordtype">void</span> (*fn) (<span class="keywordtype">void</span> *), <span class="keywordtype">void</span> *arg, <span class="keywordtype">size_t</span> stackSize)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     NUTTHREADINFO *td;
<a name="l00194"></a>00194     <span class="keyword">const</span> <a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a> *paddr;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     paddr = (<span class="keyword">const</span> <a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a> *) fn;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="comment">/*</span>
<a name="l00201"></a>00201 <span class="comment">     * Allocate stack and thread info structure in one block.</span>
<a name="l00202"></a>00202 <span class="comment">     */</span>
<a name="l00203"></a>00203     <span class="keywordflow">if</span> ((td = <a class="code" href="heap_8h.html#1506e015e92a840d260b05a41df28fcc">NutHeapAlloc</a>(<span class="keyword">sizeof</span>(NUTTHREADINFO))) == 0) {
<a name="l00204"></a>00204         <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00205"></a>00205         <span class="keywordflow">return</span> 0;
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208     <span class="comment">/* store thread name */</span>
<a name="l00209"></a>00209     <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(td-&gt;td_name, name, <span class="keyword">sizeof</span>(td-&gt;td_name) - 1);
<a name="l00210"></a>00210     td-&gt;td_name[<span class="keyword">sizeof</span>(td-&gt;td_name) - 1] = 0;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment">// set initial critical section value </span>
<a name="l00213"></a>00213     td-&gt;td_cs_level = 1;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">/*</span>
<a name="l00216"></a>00216 <span class="comment">     * Insert into the thread list and the run queue.</span>
<a name="l00217"></a>00217 <span class="comment">     */</span>
<a name="l00218"></a>00218     td-&gt;td_priority = 64;
<a name="l00219"></a>00219     td-&gt;td_next = <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>;
<a name="l00220"></a>00220     <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a> = td;
<a name="l00221"></a>00221     td-&gt;td_state = <a class="code" href="thread_8h.html#8e9436acfb1d3388c9ea9a502724beae">TDS_READY</a>;
<a name="l00222"></a>00222     td-&gt;td_timer = 0;
<a name="l00223"></a>00223     td-&gt;td_queue = 0;
<a name="l00224"></a>00224 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="include_2arch_2unix_2atom_8h.html#d70190a29376cc1598074842144f793c">__os_trf</a>) {
<a name="l00226"></a>00226         <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="include_2arch_2unix_2atom_8h.html#7b9fd40446b46234631704a9b46e6753">__os_trs</a>, <span class="stringliteral">"Cre&lt;%08lx&gt;\n"</span>, (<a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a>) td);
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228 <span class="preprocessor">#endif</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>    <a class="code" href="group__xg_thread.html#g4d2458fb9ec9d926a6f87706b19e7e06" title="Add a thread to a prioritiy ordered queue.">NutThreadAddPriQueue</a>(td, (NUTTHREADINFO **) &amp; <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>);
<a name="l00230"></a>00230 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="include_2arch_2unix_2atom_8h.html#d70190a29376cc1598074842144f793c">__os_trf</a>)
<a name="l00232"></a>00232         <a class="code" href="osdebug_8h.html#cc9b4c9e94b94936592ec3b84625b1fb" title="Dump system thread list.">NutDumpThreadList</a>(<a class="code" href="include_2arch_2unix_2atom_8h.html#7b9fd40446b46234631704a9b46e6753">__os_trs</a>);
<a name="l00233"></a>00233 <span class="preprocessor">#endif</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span>
<a name="l00235"></a>00235     <span class="comment">// init thread structure</span>
<a name="l00236"></a>00236     pthread_cond_init(&amp;td-&gt;td_cv, NULL);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     td-&gt;td_fn = fn;
<a name="l00239"></a>00239     td-&gt;td_arg = arg;
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="comment">/*</span>
<a name="l00242"></a>00242 <span class="comment">     * If no thread is active, switch to new thread.</span>
<a name="l00243"></a>00243 <span class="comment">     * this also means, we're called from nutinit</span>
<a name="l00244"></a>00244 <span class="comment">     * (if not, there would be a runningThread..)</span>
<a name="l00245"></a>00245 <span class="comment">     *  </span>
<a name="l00246"></a>00246 <span class="comment">     */</span>
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> == 0) {
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         <span class="comment">// correct cs level counter</span>
<a name="l00250"></a>00250         <span class="comment">// main_cs_level--;</span>
<a name="l00251"></a>00251         <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00252"></a>00252 
<a name="l00253"></a>00253         <span class="comment">// switching</span>
<a name="l00254"></a>00254         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> = runQueue;
<a name="l00255"></a>00255         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_state = <a class="code" href="thread_8h.html#6c7d2e848e80e808dece40238a9554d6">TDS_RUNNING</a>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         <span class="comment">// set initial critical section value and enable interrupts</span>
<a name="l00258"></a>00258         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_cs_level = 0;
<a name="l00259"></a>00259         pthread_sigmask(SIG_UNBLOCK, &amp;<a class="code" href="include_2arch_2unix_2atom_8h.html#7c4baba7be9ead5025b37220b7e07a54">irq_signal</a>, 0);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="comment">// go!</span>
<a name="l00262"></a>00262         fn(arg);
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Nut/OS Application terminated.\n\r"</span>);
<a name="l00265"></a>00265         exit(0);
<a name="l00266"></a>00266     };
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">// lock mutex and start thread</span>
<a name="l00269"></a>00269     pthread_mutex_lock(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00270"></a>00270     pthread_create(&amp;td-&gt;td_pthread, &amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#g324189adc86f9f14b363b10e4f9241f3">attr</a>, NutThreadEntry, (<span class="keywordtype">void</span> *) td);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">// wait for ack</span>
<a name="l00273"></a>00273     pthread_cond_wait(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#g1064dcccca836197ff07f48cd33a6074">main_cv</a>, &amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00274"></a>00274     pthread_mutex_unlock(&amp;<a class="code" href="group__xg_nut_arch_unix_os_context.html#gce91892b41d6929f6d6a6a2c1b8b5398">thread_mutex</a>);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="comment">/*</span>
<a name="l00277"></a>00277 <span class="comment">     * If current context is not in front of</span>
<a name="l00278"></a>00278 <span class="comment">     * the run queue (highest priority), then</span>
<a name="l00279"></a>00279 <span class="comment">     * switch to the thread in front.</span>
<a name="l00280"></a>00280 <span class="comment">     */</span>
<a name="l00281"></a>00281     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> != runQueue) {
<a name="l00282"></a>00282         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_state = <a class="code" href="thread_8h.html#8e9436acfb1d3388c9ea9a502724beae">TDS_READY</a>;
<a name="l00283"></a>00283 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="include_2arch_2unix_2atom_8h.html#d70190a29376cc1598074842144f793c">__os_trf</a>)
<a name="l00285"></a>00285             <a class="code" href="group__xg_crt_stdio.html#g2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="include_2arch_2unix_2atom_8h.html#7b9fd40446b46234631704a9b46e6753">__os_trs</a>, <span class="stringliteral">"New&lt;%08lx %08lx&gt;\n"</span>, (<a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a>) <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>, (<a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a>) runQueue);
<a name="l00286"></a>00286 <span class="preprocessor">#endif</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>        <a class="code" href="group__xg_nut_arch_avr_os_context_icc.html#gd63408e1c4ef1c03d9f979ad2d31b7e0" title="Switch to another thread.">NutThreadSwitch</a>();
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">return</span> td;
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
