<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="contents">
<h1>playmp3/playmp3.c</h1>$Log$ Revision 1.5 2009/02/18 12:18:58 olereinhardt 2009-02-18 Ole Reinhardt &lt;<a href="mailto:ole.reinhardt@thermotemp.de">ole.reinhardt@thermotemp.de</a>&gt;<p>
Fixed compilier warnings. Especialy signedness of char buffers as well as unused code on arm platform and main functions without return value<p>
Revision 1.4 2006/08/31 19:14:44 haraldkipp Not all platforms do have devDebug0. Use <a class="el" href="board_8h.html">board.h</a> to determine the correct driver.<p>
Revision 1.3 2006/07/21 09:06:36 haraldkipp Exclude AVR specific parts from building for other platforms. This does not imply, that all samples are working on all platforms.<p>
Revision 1.2 2006/05/15 11:53:15 haraldkipp Now a buffer flush will completely transfer the MP3 file to the decoder.<p>
Revision 1.1 2003/11/21 17:00:15 haraldkipp First release<p>
To run this example code, you need to attach the Medianut Board to the Ethernut or use a similar hardware design based on the VS1001K MP3 decoder.<p>
This sample application plays MP3 files from the UROM filesystem. It demonstrates how to use the global segmented buffer and the MP3 decoder driver and can provide a basis for talking equipment, alarm sound output etc.<p>
The UROM filesystem is located in the CPU's flash ROM. No external file storage device is required. Use the crurom utility to create a C source file named urom.c from the MP3 files located in subdirectory sounds. Here's how to call crurom:<p>
crurom -r -ourom.c sounds<p>
The created file will then be compiled and linked to the application code.<p>
UART0 is used for debug output.<p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (C) 2003-2006 by egnite Software GmbH. All rights reserved.</span>
<span class="comment"> *</span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> *</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<span class="comment"> *    from this software without specific prior written permission.</span>
<span class="comment"> *</span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="comment"> * SUCH DAMAGE.</span>
<span class="comment"> *</span>
<span class="comment"> * For additional information see http://www.ethernut.de/</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;<a class="code" href="board_8h.html">dev/board.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="vs1001k_8h.html" title="Network interface controller definitions.">dev/vs1001k.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html" title="Debug device definitions.">dev/debug.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="urom_8h.html">dev/urom.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="version_8h.html">sys/version.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2bankmem_8h.html" title="Banked memory management definitions.">sys/bankmem.h</a>&gt;</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>

<span class="preprocessor">#if defined(__AVR__)</span>
<span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> PlayMp3File(<span class="keywordtype">char</span> *path);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="keywordtype">int</span> <a name="a0"></a><a class="code" href="arm_8h.html#a4e97f3782107649d3e4eb3875090b3a">main</a>(<span class="keywordtype">void</span>)
{
    <span class="comment">/* Baudrate for debug output. */</span>
    <a name="a1"></a><a class="code" href="group__xg_nut_o_s.html#g8f25a50daf29ce2cee1ec038a4d744ea" title="Unsigned 32-bit value.">u_long</a> baud = 115200;

    <span class="comment">/*</span>
<span class="comment">     * Register our devices.</span>
<span class="comment">     */</span>
    <a name="a2"></a><a class="code" href="group__xg_device.html#g0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a3"></a><a class="code" href="group__xgurom.html#g811aff50a4bd37134c52d97b7e1a2bcf" title="UROM device information structure.">devUrom</a>, 0, 0);
    <a class="code" href="group__xg_device.html#g0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a4"></a><a class="code" href="board_8h.html#a270f48e350ff81b1e62f2c73c248ef4">DEV_DEBUG</a>, 0, 0);

    <span class="comment">/*</span>
<span class="comment">     * Assign stdout to the debug device.</span>
<span class="comment">     */</span>
    <a name="a5"></a><a class="code" href="group__xg_crt_stdio.html#g76767cc4b7500920d83e53caad264189" title="Reassign a stream.">freopen</a>(<a name="a6"></a><a class="code" href="board_8h.html#83d947e8f5620ceb7ef54384588f83d4">DEV_DEBUG_NAME</a>, <span class="stringliteral">"w"</span>, <a name="a7"></a><a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>);
    <a name="a8"></a><a class="code" href="group__xg_crt_lowio.html#g6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(<a name="a9"></a><a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(<a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>), <a name="a10"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#g2f1b5053775ad3be83ae499273a04de8" title="UART _ioctl() command code to set the line speed.">UART_SETSPEED</a>, &amp;baud);

    <span class="comment">/*</span>
<span class="comment">     * Print a banner.</span>
<span class="comment">     */</span>
    <a name="a11"></a><a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n\nPlay MP3 files on Nut/OS %s\n"</span>, <a name="a12"></a><a class="code" href="group__xg_nut_version.html#gfc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>());

<span class="preprocessor">#if defined(__AVR__)</span>
<span class="preprocessor"></span>
    <span class="comment">/*</span>
<span class="comment">     * Initialize the MP3 buffer. The NutSegBuf routines provide a global</span>
<span class="comment">     * system buffer, which works with banked and non-banked systems.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a name="a13"></a><a class="code" href="group__xg_bank_mem.html#g54b4fc4de72531a2c413219187019e71" title="Initialize the segmented buffer.">NutSegBufInit</a>(8192) == 0) {
        <a name="a14"></a><a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"NutSegBufInit: Fatal error"</span>);
    }

    <span class="comment">/* </span>
<span class="comment">     * Initialize the MP3 decoder hardware.</span>
<span class="comment">     */</span>
    <span class="keywordflow">if</span> (<a name="a15"></a><a class="code" href="group__xg_vs1001.html#g550ad3c234fc765344dec87a2a23ee12" title="Initialize the VS1001 hardware interface.">VsPlayerInit</a>() || <a name="a16"></a><a class="code" href="group__xg_vs1001.html#g1361ad712fe58c85db6252240913f211" title="Software reset the decoder.">VsPlayerReset</a>(0)) {
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"VsPlayer: Fatal error"</span>);
    }

    <span class="comment">/*</span>
<span class="comment">     * Play the MP3 files in an endless loop. For each file set the volume </span>
<span class="comment">     * of the left and right channel, call the local routine PlayMp3File() </span>
<span class="comment">     * and sleep one second before playing the next sound file.</span>
<span class="comment">     */</span>
    <span class="keywordflow">for</span> (;;) {
        <a name="a17"></a><a class="code" href="group__xg_vs1001.html#g07d2ba8f8003afec15eff22ebb537868" title="Set volume.">VsSetVolume</a>(0, 254);
        PlayMp3File(<span class="stringliteral">"UROM:sound1a.mp3"</span>);
        <a name="a18"></a><a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);

        <a class="code" href="group__xg_vs1001.html#g07d2ba8f8003afec15eff22ebb537868" title="Set volume.">VsSetVolume</a>(0, 0);
        PlayMp3File(<span class="stringliteral">"UROM:sound2a.mp3"</span>);
        <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);

        <a class="code" href="group__xg_vs1001.html#g07d2ba8f8003afec15eff22ebb537868" title="Set volume.">VsSetVolume</a>(254, 0);
        PlayMp3File(<span class="stringliteral">"UROM:sound3a.mp3"</span>);
        <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);

        <a class="code" href="group__xg_vs1001.html#g07d2ba8f8003afec15eff22ebb537868" title="Set volume.">VsSetVolume</a>(0, 0);
        PlayMp3File(<span class="stringliteral">"UROM:sound4a.mp3"</span>);
        <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);
    }
<span class="preprocessor">#else </span><span class="comment">/* !__AVR__ */</span>
    <span class="keywordflow">for</span> (;;);
<span class="preprocessor">#endif </span><span class="comment">/* !__AVR__ */</span>
    <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#if defined(__AVR__)</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * Play MP3 file from local file system.</span>
<span class="comment"> *</span>
<span class="comment"> * \param path Pathname of the MP3 file to play.</span>
<span class="comment"> *</span>
<span class="comment"> * \return 0 on success, -1 if opening the file failed.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> PlayMp3File(<span class="keywordtype">char</span> *path)
{
    <span class="keywordtype">int</span> fd;
    <span class="keywordtype">size_t</span> rbytes;
    <span class="keywordtype">char</span>  *mp3buf;
    <span class="keywordtype">int</span>    got;
    <a name="a19"></a><a class="code" href="group__xg_nut_o_s.html#ge2b02ed168fc99cff3851603910b1fb6" title="Unsigned 8-bit value.">u_char</a> ief;

    <span class="comment">/*</span>
<span class="comment">     * Open the MP3 file.</span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Play %s: "</span>, path);
    <span class="keywordflow">if</span> ((fd = <a name="a20"></a><a class="code" href="group__xg_crt_lowio.html#ga5b9fe6f8778481971c2e23a38348bb1" title="Open a file.">_open</a>(path, <a name="a21"></a><a class="code" href="group__xg_crt_lowio.html#g4d457d93039cb26f27461c4af5868309">_O_RDONLY</a> | <a name="a22"></a><a class="code" href="group__xg_crt_lowio.html#g166a079a4990ddeb0a32475728bbacd0">_O_BINARY</a>)) == -1) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Error %d\n"</span>, <a name="a23"></a><a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a>);
        <span class="keywordflow">return</span> -1;
    }
    <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"OK"</span>);

    <span class="comment">/* </span>
<span class="comment">     * Reset decoder buffer.</span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[B.RST]"</span>);
    ief = <a name="a24"></a><a class="code" href="group__xg_vs1001.html#g526a4c9a195580052e581fbf089024ed" title="Enable or disable player interrupts.">VsPlayerInterrupts</a>(0);
    <a name="a25"></a><a class="code" href="group__xg_bank_mem.html#g59e6535d66539f29aed5909eb0b70eed" title="Reset the segmented buffer.">NutSegBufReset</a>();
    <a class="code" href="group__xg_vs1001.html#g526a4c9a195580052e581fbf089024ed" title="Enable or disable player interrupts.">VsPlayerInterrupts</a>(ief);

    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/*</span>
<span class="comment">         * Query number of byte available in MP3 buffer.</span>
<span class="comment">         */</span>
        ief = <a class="code" href="group__xg_vs1001.html#g526a4c9a195580052e581fbf089024ed" title="Enable or disable player interrupts.">VsPlayerInterrupts</a>(0);
        mp3buf = <a name="a26"></a><a class="code" href="group__xg_bank_mem.html#g5dca6c51548e7ee90dc79cddaa1668fd" title="Request segmented buffer space for writing.">NutSegBufWriteRequest</a>(&amp;rbytes);
        <a class="code" href="group__xg_vs1001.html#g526a4c9a195580052e581fbf089024ed" title="Enable or disable player interrupts.">VsPlayerInterrupts</a>(ief);

        <span class="comment">/* </span>
<span class="comment">         * Read data directly into the MP3 buffer. </span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (rbytes) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[B.RD%d]"</span>, rbytes);
            <span class="keywordflow">if</span> ((got = <a name="a27"></a><a class="code" href="io_8h.html#a7278892ff16de3dd3d00ff4a89d11e4">_read</a>(fd, mp3buf, rbytes)) &gt; 0) {
                <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[B.CMT%d]"</span>, got);
                ief = <a class="code" href="group__xg_vs1001.html#g526a4c9a195580052e581fbf089024ed" title="Enable or disable player interrupts.">VsPlayerInterrupts</a>(0);
                mp3buf = <a name="a28"></a><a class="code" href="group__xg_bank_mem.html#ge7d02ba9e852fc6bde683efb8da33769" title="Commit written buffer space.">NutSegBufWriteCommit</a>(got);
                <a class="code" href="group__xg_vs1001.html#g526a4c9a195580052e581fbf089024ed" title="Enable or disable player interrupts.">VsPlayerInterrupts</a>(ief);
            } <span class="keywordflow">else</span> {
                <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[EOF]"</span>);
                <span class="keywordflow">break</span>;
            }
        }

        <span class="comment">/*</span>
<span class="comment">         * If the player is not running, kick it.</span>
<span class="comment">         */</span>
        <span class="keywordflow">if</span> (<a name="a29"></a><a class="code" href="group__xg_vs1001.html#gebf2c17443a90c905e8864685b5fd075" title="Returns status of the player.">VsGetStatus</a>() != <a name="a30"></a><a class="code" href="group__xg_vs1001.html#g9f6d29a778ea36d89dc3e900ffe265ce">VS_STATUS_RUNNING</a>) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[P.KICK]"</span>);
            <a name="a31"></a><a class="code" href="group__xg_vs1001.html#g891f3b13a6a02c4c7c9cb749ea6b499c" title="Start playback.">VsPlayerKick</a>();
        }

        <span class="comment">/*</span>
<span class="comment">         * Allow background threads to take over.</span>
<span class="comment">         */</span>
        <a name="a32"></a><a class="code" href="group__xg_thread.html#g075836f9a2596c5983b7ba88420afd11" title="Give up the CPU.">NutThreadYield</a>();
    }

    <a name="a33"></a><a class="code" href="group__xg_crt_lowio.html#g58a559c63748012aab165d5f82af766d" title="Close a file, device or socket.">_close</a>(fd);

    <span class="comment">/* </span>
<span class="comment">     * Flush decoder and wait until finished. </span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[P.FLUSH]"</span>);
    <a name="a34"></a><a class="code" href="group__xg_vs1001.html#gdd56c46477a43d4fd4861753b78edadb" title="Sets up decoder internal buffer flushing.">VsPlayerFlush</a>();
    <span class="keywordflow">while</span> (<a class="code" href="group__xg_vs1001.html#gebf2c17443a90c905e8864685b5fd075" title="Returns status of the player.">VsGetStatus</a>() != <a name="a35"></a><a class="code" href="group__xg_vs1001.html#gc9d0c5a959e8bcf10ffcd75472691aec">VS_STATUS_EMPTY</a>) {
        <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1);
    }

    <span class="comment">/*</span>
<span class="comment">     * Reset the decoder. </span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"[P.RST]"</span>);
    <a class="code" href="group__xg_vs1001.html#g1361ad712fe58c85db6252240913f211" title="Software reset the decoder.">VsPlayerReset</a>(0);

    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nDone, %u bytes free\n"</span>, <a name="a36"></a><a class="code" href="heap_8h.html#59ff999107d29a73d3bdbeaee8dce952">NutHeapAvailable</a>());
    <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#endif </span><span class="comment">/* !__AVR__ */</span>
</pre></div> </div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
