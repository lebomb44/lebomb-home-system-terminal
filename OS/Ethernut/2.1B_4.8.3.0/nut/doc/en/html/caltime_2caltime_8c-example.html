<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
<div class="contents">
<h1>caltime/caltime.c</h1>Copyright (C) 2001-2005 by egnite Software GmbH. All rights reserved.<p>
Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:<p>
1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. 3. Neither the name of the copyright holders nor the names of contributors may be used to endorse or promote products derived from this software without specific prior written permission.<p>
THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.<p>
For additional information see <a href="http://www.ethernut.de/">http://www.ethernut.de/</a><p>
$Log$ Revision 1.1 2007/06/03 08:48:17 haraldkipp New application sample demonstrates calendar functions.<p>
Demonstrates Nut/OS date and time functions, which had been contributed by Oliver Schulz.<p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;<a class="code" href="board_8h.html">dev/board.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="debug_8h.html" title="Debug device definitions.">dev/debug.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="version_8h.html">sys/version.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> *version = <span class="stringliteral">"1.0"</span>;

<span class="comment">/* Used for ASCII Art Animation. */</span>
<span class="keyword">static</span> <span class="keywordtype">char</span> *rotor = <span class="stringliteral">"|/-\\"</span>;

<span class="keyword">static</span> <span class="keywordtype">char</span> *weekday_name[7] = {
    <span class="stringliteral">"Sunday"</span>, <span class="stringliteral">"Monday"</span>, <span class="stringliteral">"Tuesday"</span>, <span class="stringliteral">"Wednesday"</span>, <span class="stringliteral">"Thursday"</span>, <span class="stringliteral">"Friday"</span>, <span class="stringliteral">"Saturday"</span>
};

<span class="comment">/*</span>
<span class="comment"> * Print content of tm structure.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> PrintDateTime(<a name="a0"></a><a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keyword">struct</span> <a name="_a1"></a><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *stm)
{
    <a name="a2"></a><a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"%s, %04d/%02d/%02d, %02d:%02d:%02d%s"</span>
        , weekday_name[stm-&gt;tm_wday]
        , stm-&gt;tm_year + 1900, stm-&gt;tm_mon + 1, stm-&gt;tm_mday
        , stm-&gt;tm_hour, stm-&gt;tm_min, stm-&gt;tm_sec
        , stm-&gt;tm_isdst ? <span class="stringliteral">" DST"</span> : <span class="stringliteral">""</span>
        );
}

<span class="comment">/*</span>
<span class="comment"> * Query calendar date from user.</span>
<span class="comment"> *</span>
<span class="comment"> * Returns 0 on success, -1 otherwise.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> EnterDate(<span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *stm)
{
    <span class="keywordtype">int</span> year;
    <span class="keywordtype">int</span> mon;
    <span class="keywordtype">int</span> mday;
    <span class="keywordtype">int</span> n;

    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Enter date, use format YYYY/MM/DD (%04d/%02d/%02d): "</span>, 
        stm-&gt;<a name="a3"></a><a class="code" href="struct__tm.html#33adf78fd6476b2120ce3b9c4a852053" title="years since 1900">tm_year</a> + 1900, stm-&gt;<a name="a4"></a><a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> + 1, stm-&gt;<a name="a5"></a><a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a>);
    n = <a name="a6"></a><a class="code" href="icc_8h.html#9d178d8ab459cd19f1a1749b60af46ca">scanf</a>(<span class="stringliteral">"%d/%d/%d"</span>, &amp;year, &amp;mon, &amp;mday);
    <span class="keywordflow">if</span> (n &gt;= 1) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"%04d"</span>, year);
        <span class="keywordflow">if</span> (year &lt; 1970 || year &gt; 2038) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad year: %d is not within range 1970..2038\n"</span>, year);
            <span class="keywordflow">return</span> -1;
        }
        stm-&gt;<a class="code" href="struct__tm.html#33adf78fd6476b2120ce3b9c4a852053" title="years since 1900">tm_year</a> = year - 1900;
    }
    <span class="keywordflow">if</span> (n &gt;= 2) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"/%02d"</span>, mon);
        <span class="keywordflow">if</span> (mon &lt; 1 || mon &gt; 31) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad month: %d is not within range 1..12\n"</span>, mon);
            <span class="keywordflow">return</span> -1;
        }
        stm-&gt;<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> = mon - 1;
    }
    <span class="keywordflow">if</span> (n &gt;= 3) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"/%02d"</span>, mday);
        <span class="keywordflow">if</span> (mday &lt; 1 || mday &gt; 31) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad day: %d is not within range 1..31\n"</span>, mday);
            <span class="keywordflow">return</span> -1;
        }
        stm-&gt;<a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a> = mday;
    }
    <a name="a7"></a><a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/*</span>
<span class="comment"> * Query time of day from user.</span>
<span class="comment"> *</span>
<span class="comment"> * Returns 0 on success, -1 otherwise.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> EnterTime(<span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *stm)
{
    <span class="keywordtype">int</span> hour;
    <span class="keywordtype">int</span> minute;
    <span class="keywordtype">int</span> second;
    <span class="keywordtype">int</span> n;

    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Enter time, use 24h format HH:MM:SS (%02d:%02d:%02d): "</span>, 
        stm-&gt;<a name="a8"></a><a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a>, stm-&gt;<a name="a9"></a><a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a>, stm-&gt;<a name="a10"></a><a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a>);
    n = <a class="code" href="icc_8h.html#9d178d8ab459cd19f1a1749b60af46ca">scanf</a>(<span class="stringliteral">"%d:%d:%d"</span>, &amp;hour, &amp;minute, &amp;second);
    <span class="keywordflow">if</span> (n &gt;= 1) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"%02d"</span>, hour);
        <span class="keywordflow">if</span> (hour &lt; 0 || hour &gt; 23) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad hour: %d is not within range 0..23\n"</span>, hour);
            <span class="keywordflow">return</span> -1;
        }
        stm-&gt;<a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a> = hour;
    }
    <span class="keywordflow">if</span> (n &gt;= 2) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">":%02d"</span>, minute);
        <span class="keywordflow">if</span> (minute &lt; 0 || minute &gt; 59) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad minute: %d is not within range 0..59\n"</span>, minute);
            <span class="keywordflow">return</span> -1;
        }
        stm-&gt;<a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a> = minute;
    }
    <span class="keywordflow">if</span> (n &gt;= 3) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">":%02d"</span>, second);
        <span class="keywordflow">if</span> (second &lt; 0 || second &gt; 59) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad second: %d is not within range 0..59\n"</span>, second);
            <span class="keywordflow">return</span> -1;
        }
        stm-&gt;<a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a> = second;
    }
    <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);

    <span class="keywordflow">return</span> 0;
}

<span class="comment">/*</span>
<span class="comment"> * Query time difference from user, specified in hours and minutes.</span>
<span class="comment"> *</span>
<span class="comment"> * 'init' specifies the default number of seconds.</span>
<span class="comment"> *</span>
<span class="comment"> * Returns the number of seconds.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">long</span> EnterTimeDiff(<span class="keywordtype">long</span> init)
{
    <span class="keywordtype">long</span> hours;
    <span class="keywordtype">long</span> minutes;
    <span class="keywordtype">long</span> seconds;
    <span class="keywordtype">int</span> n;

    seconds = init;
    minutes = seconds / 60L;
    hours = minutes / 60L;
    minutes = <a name="a11"></a><a class="code" href="group__xg_crt_std_lib.html#geb20b44c8437544e571a3cb9bb2cc37d" title="Compute absolute value of an integer.">abs</a>(minutes % 60L);
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Enter time difference in format HH:MM (%+03ld:%02ld): "</span>, hours, minutes);
    n = <a class="code" href="icc_8h.html#9d178d8ab459cd19f1a1749b60af46ca">scanf</a>(<span class="stringliteral">"%ld:%ld"</span>, &amp;hours, &amp;minutes);
    <span class="keywordflow">if</span> (n &gt;= 1) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"%+03ld"</span>, hours);
        <span class="keywordflow">if</span> (hours &lt; -12 || hours &gt; 12) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad hours: %ld is not within range -12..+12\n"</span>, hours);
            <span class="keywordflow">return</span> init;
        }
    }
    <span class="keywordflow">if</span> (n &gt;= 2) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"%02ld"</span>, minutes);
        <span class="keywordflow">if</span> (minutes &lt; 0 || minutes &gt; 59) {
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\nBad minutes: %ld is not within range 0..59\n"</span>, minutes);
            <span class="keywordflow">return</span> init;
        }
    }
    <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);

    <span class="keywordflow">return</span> (hours * 60L + minutes) * 60L;
}

<span class="comment">/*</span>
<span class="comment"> * Display the elapsed seconds of the epoch.</span>
<span class="comment"> *</span>
<span class="comment"> * The value is constantly updated until the user presses a key.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> DisplaySeconds(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> i = 0;

    <span class="keywordflow">while</span> (!<a name="a12"></a><a class="code" href="stdio_8h.html#97e9b1fe8d4c010474637a654aad6566">kbhit</a>()) {
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">" [%c] Seconds since epoch: %ld\r"</span>, rotor[++i &amp; 3], (<span class="keywordtype">long</span>)<a name="a13"></a><a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(NULL));
        <a name="a14"></a><a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(200);
    }
    <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);
}

<span class="comment">/*</span>
<span class="comment"> * Display the coordinated universal time.</span>
<span class="comment"> *</span>
<span class="comment"> * The value is constantly updated until the user presses a key.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> DisplayZuluTime(<span class="keywordtype">void</span>)
{
    <a name="a15"></a><a class="code" href="group__xg_crt_time.html#ge33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> secs;
    <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *gmt;
    <span class="keywordtype">int</span> i = 0;

    <span class="keywordflow">while</span> (!<a class="code" href="stdio_8h.html#97e9b1fe8d4c010474637a654aad6566">kbhit</a>()) {
        secs = <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(NULL);
        gmt = <a name="a16"></a><a class="code" href="group__xg_crt_time.html#g4bf5c1b09409b70880b839f0ff9aeb9a" title="Convert a time value to a structure.">gmtime</a>(&amp;secs);
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">" [%c] Universal time: "</span>, rotor[++i &amp; 3]);
        PrintDateTime(gmt);
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"    \r"</span>);
        <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(500);
    }
    <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);
}

<span class="comment">/*</span>
<span class="comment"> * Display the local time.</span>
<span class="comment"> *</span>
<span class="comment"> * The value is constantly updated until the user presses a key.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> DisplayLocalTime(<span class="keywordtype">void</span>)
{
    <a class="code" href="group__xg_crt_time.html#ge33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> tt;
    <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *ltm;
    <span class="keywordtype">int</span> i = 0;

    <span class="keywordflow">while</span> (!<a class="code" href="stdio_8h.html#97e9b1fe8d4c010474637a654aad6566">kbhit</a>()) {
        <span class="comment">/* Get local time and print it. */</span>
        tt = <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(NULL);
        ltm = <a name="a17"></a><a class="code" href="group__xg_crt_time.html#g7a9f8811ccb83dee7960cbd77dc133e9" title="Convert a time value and correct for the local time zone.">localtime</a>(&amp;tt);
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">" [%c] Local time: "</span>, rotor[++i &amp; 3]);
        PrintDateTime(ltm);

        <span class="comment">/* Calculate the offset from UTC in minutes. */</span>
        tt = <a name="a18"></a><a class="code" href="group__xg_crt_time.html#g9493c776d7de0e689626895324bd2d6e" title="Defines your local timezone.">_timezone</a>;
        <span class="keywordflow">if</span> (ltm-&gt;<a name="a19"></a><a class="code" href="struct__tm.html#5645ca0580c8ab2c24f6c2965d9c9f9c" title="daylight savings time flag">tm_isdst</a> &gt; 0) {
            tt += <a name="a20"></a><a class="code" href="group__xg_crt_time.html#g8ab2ad3557476430d80335c8df4ff374" title="Difference between standard and daylight savings time in seconds.">_dstbias</a>;
        }
        tt /= -60L;

        <span class="comment">/* Print UTC offset in format HH:MM. */</span>
        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">" UTC%+03ld:%02ld   \r"</span>, tt / 60L, <a class="code" href="group__xg_crt_std_lib.html#geb20b44c8437544e571a3cb9bb2cc37d" title="Compute absolute value of an integer.">abs</a>(tt) % 60L);
        <a class="code" href="group__xg_timer.html#gfefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(200);
    }
    <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);
}

<span class="comment">/*</span>
<span class="comment"> * Display the week day of a queried calendar date.</span>
<span class="comment"> *</span>
<span class="comment"> * mktime() updates the structure members tm_yday and tm_wday.</span>
<span class="comment"> * This can be used to determine the week day name of any given</span>
<span class="comment"> * date.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> CalcWeekDay(<span class="keywordtype">void</span>)
{
    <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> date;
    <a class="code" href="group__xg_crt_time.html#ge33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> secs;
    
    <span class="comment">/* Use current local time as default. */</span>
    <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(&amp;secs);
    <a name="a21"></a><a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(&amp;date, <a class="code" href="group__xg_crt_time.html#g7a9f8811ccb83dee7960cbd77dc133e9" title="Convert a time value and correct for the local time zone.">localtime</a>(&amp;secs), <span class="keyword">sizeof</span>(date));
    <span class="comment">/* Query date and print week day name if we got a valid entry. */</span>
    <span class="keywordflow">if</span> (EnterDate(&amp;date) == 0) {
        <a name="a22"></a><a class="code" href="group__xg_crt_time.html#g60ebe794537631d5c944d2580577068a" title="Convert the local time to a calendar value.">mktime</a>(&amp;date);
        <a name="a23"></a><a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(weekday_name[date.tm_wday]);
    }
}

<span class="comment">/*</span>
<span class="comment"> * Query user for a new time zone offset.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> SetTimeZone(<span class="keywordtype">void</span>)
{
    <span class="comment">/* Nut/OS uses a global variable to store the current TZ offset. */</span>
    <a class="code" href="group__xg_crt_time.html#g9493c776d7de0e689626895324bd2d6e" title="Defines your local timezone.">_timezone</a> = EnterTimeDiff(<a class="code" href="group__xg_crt_time.html#g9493c776d7de0e689626895324bd2d6e" title="Defines your local timezone.">_timezone</a>);
}

<span class="comment">/*</span>
<span class="comment"> * Query user for a new system time.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> SetLocalTime(<span class="keywordtype">void</span>)
{
    <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> ltm;
    <a class="code" href="group__xg_crt_time.html#ge33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> now;

    <span class="comment">/* Use current local time as default. */</span>
    <a class="code" href="group__xg_crt_time.html#g26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(&amp;now);
    <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(&amp;ltm, <a class="code" href="group__xg_crt_time.html#g7a9f8811ccb83dee7960cbd77dc133e9" title="Convert a time value and correct for the local time zone.">localtime</a>(&amp;now), <span class="keyword">sizeof</span>(ltm));

    <span class="comment">/* Query date and time. */</span>
    <span class="keywordflow">if</span> (EnterDate(&amp;ltm) == 0 &amp;&amp; EnterTime(&amp;ltm) == 0) {
        <span class="comment">/* Let mktime determine whether DST is in effect. */</span>
        ltm.<a class="code" href="struct__tm.html#5645ca0580c8ab2c24f6c2965d9c9f9c" title="daylight savings time flag">tm_isdst</a> = -1;
        <span class="comment">/* mktime expects local time and returns seconds since the epoch. */</span>
        now = <a class="code" href="group__xg_crt_time.html#g60ebe794537631d5c944d2580577068a" title="Convert the local time to a calendar value.">mktime</a>(&amp;ltm);
        <span class="comment">/* stime expects seconds since the epoch. */</span>
        <a name="a24"></a><a class="code" href="group__xg_crt_time.html#g1e9a05d0b48dcf984238438fa8efd2d8" title="Set the system time.">stime</a>(&amp;now);
    }
}

<span class="comment">/*</span>
<span class="comment"> * Application entry.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> <a name="a25"></a><a class="code" href="arm_8h.html#a4e97f3782107649d3e4eb3875090b3a">main</a>(<span class="keywordtype">void</span>)
{
    <a name="a26"></a><a class="code" href="group__xg_nut_o_s.html#g8f25a50daf29ce2cee1ec038a4d744ea" title="Unsigned 32-bit value.">u_long</a> baud = 115200;
    <span class="keywordtype">int</span> cmd;

    <span class="comment">/* Use UART device for stdin and stdout. */</span>
    <a name="a27"></a><a class="code" href="group__xg_device.html#g0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a28"></a><a class="code" href="board_8h.html#baa1375bc843b5722366b23d9d7d4f21">DEV_UART</a>, 0, 0);
    <a name="a29"></a><a class="code" href="group__xg_crt_stdio.html#g76767cc4b7500920d83e53caad264189" title="Reassign a stream.">freopen</a>(<a name="a30"></a><a class="code" href="board_8h.html#0fedadb8acad34bd107a9fc94477136a">DEV_UART_NAME</a>, <span class="stringliteral">"w"</span>, <a name="a31"></a><a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>);
    <a class="code" href="group__xg_crt_stdio.html#g76767cc4b7500920d83e53caad264189" title="Reassign a stream.">freopen</a>(<a class="code" href="board_8h.html#0fedadb8acad34bd107a9fc94477136a">DEV_UART_NAME</a>, <span class="stringliteral">"r"</span>, <a name="a32"></a><a class="code" href="group__xg_crt_stdio.html#gaca70138f0cb63ddb026921afc635179" title="Standard input stream.">stdin</a>);    
    <a name="a33"></a><a class="code" href="group__xg_crt_lowio.html#g6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(<a name="a34"></a><a class="code" href="group__xg_crt_stdio.html#gb5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(<a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>), <a name="a35"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#g2f1b5053775ad3be83ae499273a04de8" title="UART _ioctl() command code to set the line speed.">UART_SETSPEED</a>, &amp;baud);
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"\n\nCalendar Time %s running on Nut/OS %s\n"</span>, version, <a name="a36"></a><a class="code" href="group__xg_nut_version.html#gfc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>());

<span class="preprocessor">#ifdef RTC_CHIP</span>
<span class="preprocessor"></span>    <span class="comment">/* Register and query hardware RTC, if available. */</span>
    <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"Registering RTC hardware..."</span>);
    <span class="keywordflow">if</span> (<a name="a37"></a><a class="code" href="rtc_8h.html#c47307585fae3e6632d0253eb493c0f4" title="Register a specified RTC.">NutRegisterRtc</a>(&amp;RTC_CHIP)) {
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"failed"</span>);
    } <span class="keywordflow">else</span> {
        <a class="code" href="group__xg_nut_o_s.html#g8f25a50daf29ce2cee1ec038a4d744ea" title="Unsigned 32-bit value.">u_long</a> rtc_stat;

        <a name="a38"></a><a class="code" href="rtc_8h.html#4ef299e140a7550b55bd50dbeb34c985" title="Query status flags from the registered RTC.">NutRtcGetStatus</a>(&amp;rtc_stat);
        <span class="keywordflow">if</span> (rtc_stat &amp; <a name="a39"></a><a class="code" href="rtc_8h.html#aeb7283740ec89902dbc08d02b0850f5">RTC_STATUS_PF</a>) {
            <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"power failure"</span>);
        }
        <span class="keywordflow">else</span> {
            <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"OK"</span>);
        }
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/* Print command menu. */</span>
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"\n  0 - Display seconds counter"</span>);
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"  1 - Display universal time"</span>);
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"  2 - Display local time"</span>);
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"  3 - Calculate weekday"</span>);
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"  S - Set local time"</span>);
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"  Y - Toggle DST calculation"</span>);
        <a class="code" href="icc_8h.html#80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">"  Z - Set timezone"</span>);

        <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"What is thy bidding, my master? "</span>);

        <span class="comment">/* Flush input buffer. */</span>
        <span class="keywordflow">while</span> (<a class="code" href="stdio_8h.html#97e9b1fe8d4c010474637a654aad6566">kbhit</a>()) {
            cmd = <a name="a40"></a><a class="code" href="group__xg_crt_stdio.html#g3e29caa20f7cffe18f410f01278905a8" title="Read a character from a standard input.">getchar</a>();
        }

        <span class="comment">/* Get the next command. */</span>
        cmd = <a class="code" href="group__xg_crt_stdio.html#g3e29caa20f7cffe18f410f01278905a8" title="Read a character from a standard input.">getchar</a>();
        <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(cmd);
        <a class="code" href="group__xg_crt_stdio.html#gf4de2514b7778805db3815e8dd6cf09a" title="Write a character to standard output.">putchar</a>(<span class="charliteral">'\n'</span>);

        <span class="comment">/* Process the command. */</span>
        <span class="keywordflow">switch</span>(cmd) {
        <span class="keywordflow">case</span> <span class="charliteral">'0'</span>:
            DisplaySeconds();
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
            DisplayZuluTime();
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <span class="charliteral">'2'</span>:
            DisplayLocalTime();
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
            CalcWeekDay();
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
        <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
            SetLocalTime();
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <span class="charliteral">'Y'</span>:
        <span class="keywordflow">case</span> <span class="charliteral">'y'</span>:
            <span class="comment">/* Nut/OS uses a global variable to enable/disable DST. </span>
<span class="comment">               Toggle the current status and display the result. */</span>
            <a name="a41"></a><a class="code" href="group__xg_crt_time.html#g2bb3d0de4c753758209b935de23f09ae" title="Used to control daylight conversions.">_daylight</a> = <a class="code" href="group__xg_crt_time.html#g2bb3d0de4c753758209b935de23f09ae" title="Used to control daylight conversions.">_daylight</a> == 0;
            <a class="code" href="icc_8h.html#3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Specify enhanced AVR target.">printf</a>(<span class="stringliteral">"DST calculation %sabled\n"</span>, <a class="code" href="group__xg_crt_time.html#g2bb3d0de4c753758209b935de23f09ae" title="Used to control daylight conversions.">_daylight</a> ? <span class="stringliteral">"en"</span> : <span class="stringliteral">"dis"</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <span class="charliteral">'Z'</span>:
        <span class="keywordflow">case</span> <span class="charliteral">'z'</span>:
            SetTimeZone();
            <span class="keywordflow">break</span>;
        }
    }
    <span class="keywordflow">return</span> 0;
}

</pre></div> </div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
