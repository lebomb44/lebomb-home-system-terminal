<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_0467bca32e4985236ed10c22925d2307.html">os</a>
  </div>
<div class="contents">
<h1>thread.c</h1><a href="os_2thread_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2006 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * -</span>
<a name="l00033"></a>00033 <span class="comment"> * Portions Copyright (C) 2000 David J. Hudson &lt;dave@humbug.demon.co.uk&gt;</span>
<a name="l00034"></a>00034 <span class="comment"> *</span>
<a name="l00035"></a>00035 <span class="comment"> * This file is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00036"></a>00036 <span class="comment"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<a name="l00037"></a>00037 <span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE.</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * You can redistribute this file and/or modify it under the terms of the GNU</span>
<a name="l00040"></a>00040 <span class="comment"> * General Public License (GPL) as published by the Free Software Foundation;</span>
<a name="l00041"></a>00041 <span class="comment"> * either version 2 of the License, or (at your discretion) any later version.</span>
<a name="l00042"></a>00042 <span class="comment"> * See the accompanying file "copying-gpl.txt" for more details.</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * As a special exception to the GPL, permission is granted for additional</span>
<a name="l00045"></a>00045 <span class="comment"> * uses of the text contained in this file.  See the accompanying file</span>
<a name="l00046"></a>00046 <span class="comment"> * "copying-liquorice.txt" for details.</span>
<a name="l00047"></a>00047 <span class="comment"> */</span>
<a name="l00048"></a>00048 
<a name="l00207"></a>00207 <span class="preprocessor">#include &lt;<a class="code" href="os_8h.html">cfg/os.h</a>&gt;</span>
<a name="l00208"></a>00208 <span class="preprocessor">#include &lt;<a class="code" href="memory_8h.html" title="Default memory layout.">cfg/memory.h</a>&gt;</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="preprocessor">#include &lt;<a class="code" href="types_8h.html" title="Nut/OS type declarations.">sys/types.h</a>&gt;</span>
<a name="l00213"></a>00213 <span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00214"></a>00214 <span class="preprocessor">#include &lt;<a class="code" href="include_2sys_2atom_8h.html">sys/atom.h</a>&gt;</span>
<a name="l00215"></a>00215 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00216"></a>00216 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00217"></a>00217 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00218"></a>00218 <span class="preprocessor">#include &lt;<a class="code" href="nutdebug_8h.html">sys/nutdebug.h</a>&gt;</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="osdebug_8h.html">sys/osdebug.h</a>&gt;</span>
<a name="l00222"></a>00222 <span class="preprocessor">#endif</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>
<a name="l00224"></a>00224 <span class="preprocessor">#ifdef NUTTRACER</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="tracer_8h.html" title="Trace functions.">sys/tracer.h</a>&gt;</span>
<a name="l00226"></a>00226 <span class="preprocessor">#endif</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="preprocessor">#if defined(NUT_CRITICAL_NESTING) &amp;&amp; !defined(NUT_CRITICAL_NESTING_STACK)</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> critical_nesting_level;
<a name="l00235"></a>00235 <span class="preprocessor">#endif</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>
<a name="l00237"></a>00237 <span class="preprocessor">#ifdef __NUT_EMULATION__</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="comment">// prototype</span>
<a name="l00239"></a>00239 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="arch_2unix_2os_2nutinit_8c.html#9a30bd9f48ccc047fd4557d18082990e" title="Handle interrupt triggered NutEventPostAsync Check list of events to post and call...">NutUnixThreadYieldHook</a>(<span class="keywordtype">void</span>);  <span class="comment">// from unix_nutinit.c</span>
<a name="l00240"></a>00240 <span class="preprocessor">#endif</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>
<a name="l00248"></a><a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06">00248</a> NUTTHREADINFO * <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>;
<a name="l00249"></a>00249 
<a name="l00256"></a><a class="code" href="group__xg_thread.html#gac039e42bf2cb431a4bbce9fe50c577b">00256</a> NUTTHREADINFO * <a class="code" href="group__xg_thread.html#gac039e42bf2cb431a4bbce9fe50c577b" title="Thread to be killed.">killedThread</a>;
<a name="l00257"></a>00257 
<a name="l00266"></a><a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e">00266</a> NUTTHREADINFO * <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>;
<a name="l00267"></a>00267 
<a name="l00275"></a><a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1">00275</a> NUTTHREADINFO * <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 
<a name="l00289"></a><a class="code" href="group__xg_thread.html#g4d2458fb9ec9d926a6f87706b19e7e06">00289</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#g4d2458fb9ec9d926a6f87706b19e7e06" title="Add a thread to a prioritiy ordered queue.">NutThreadAddPriQueue</a>(NUTTHREADINFO * td, NUTTHREADINFO * <span class="keyword">volatile</span> *tqpp)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     NUTTHREADINFO *tqp;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <a class="code" href="nutdebug_8h.html#c8cfe28a71b6736cb1ed989e4e19bf97">NUTASSERT</a>(td != NULL);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     td-&gt;td_queue = (<a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a>) tqpp;
<a name="l00296"></a>00296     td-&gt;td_qpec = 0;            <span class="comment">// start with clean event count</span>
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="comment">/*</span>
<a name="l00299"></a>00299 <span class="comment">     * Be most careful not to override an intermediate event from interrupt </span>
<a name="l00300"></a>00300 <span class="comment">     * context, which may change a queue from empty to signaled state. Many </span>
<a name="l00301"></a>00301 <span class="comment">     * thanks to Michael Jones, who detected and corrected this bug.</span>
<a name="l00302"></a>00302 <span class="comment">     */</span>
<a name="l00303"></a>00303     <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00304"></a>00304     tqp = *tqpp;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (tqp == <a class="code" href="group__xg_event.html#g65e5b23d1a8f35862480021738a7ecbc" title="Signaled state definition.">SIGNALED</a>) {
<a name="l00307"></a>00307         tqp = 0;
<a name="l00308"></a>00308         td-&gt;td_qpec++;          <span class="comment">// transfer the signaled state </span>
<a name="l00309"></a>00309     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tqp) {
<a name="l00310"></a>00310         <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();      <span class="comment">// there are other threads in queue</span>
<a name="l00311"></a>00311                         <span class="comment">// so its save to leave critical.          </span>
<a name="l00312"></a>00312 
<a name="l00313"></a>00313         <span class="keywordflow">while</span> (tqp &amp;&amp; tqp-&gt;td_priority &lt;= td-&gt;td_priority) {
<a name="l00314"></a>00314             tqpp = &amp;tqp-&gt;td_qnxt;
<a name="l00315"></a>00315             tqp = tqp-&gt;td_qnxt;
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();     <span class="comment">// back into critical</span>
<a name="l00319"></a>00319     }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321     td-&gt;td_qnxt = tqp;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     *tqpp = td;
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (td-&gt;td_qnxt &amp;&amp; td-&gt;td_qnxt-&gt;td_qpec) {
<a name="l00325"></a>00325         td-&gt;td_qpec += td-&gt;td_qnxt-&gt;td_qpec; <span class="comment">// don't overwrite count</span>
<a name="l00326"></a>00326         td-&gt;td_qnxt-&gt;td_qpec = 0;
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00341"></a><a class="code" href="group__xg_thread.html#ge45ebad9f604755d5c5ba8adaf9e4f89">00341</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#ge45ebad9f604755d5c5ba8adaf9e4f89" title="Remove a thread from a specified queue.">NutThreadRemoveQueue</a>(NUTTHREADINFO * td, NUTTHREADINFO * <span class="keyword">volatile</span> *tqpp)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343     NUTTHREADINFO *tqp;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00346"></a>00346     tqp = *tqpp;
<a name="l00347"></a>00347     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (tqp != <a class="code" href="group__xg_event.html#g65e5b23d1a8f35862480021738a7ecbc" title="Signaled state definition.">SIGNALED</a>) {
<a name="l00350"></a>00350         <span class="keywordflow">while</span> (tqp) {
<a name="l00351"></a>00351             <span class="keywordflow">if</span> (tqp == td) {
<a name="l00352"></a>00352                 <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00353"></a>00353                 *tqpp = td-&gt;td_qnxt;
<a name="l00354"></a>00354                 <span class="keywordflow">if</span> (td-&gt;td_qpec) {
<a name="l00355"></a>00355                     <span class="keywordflow">if</span> (td-&gt;td_qnxt) {
<a name="l00356"></a>00356                         td-&gt;td_qnxt-&gt;td_qpec = td-&gt;td_qpec;
<a name="l00357"></a>00357                     }
<a name="l00358"></a>00358                     td-&gt;td_qpec = 0;
<a name="l00359"></a>00359                 }
<a name="l00360"></a>00360                 <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00361"></a>00361 
<a name="l00362"></a>00362                 td-&gt;td_qnxt = 0;
<a name="l00363"></a>00363                 td-&gt;td_queue = 0;
<a name="l00364"></a>00364                 <span class="keywordflow">break</span>;
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366             tqpp = &amp;tqp-&gt;td_qnxt;
<a name="l00367"></a>00367             tqp = tqp-&gt;td_qnxt;
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00382"></a><a class="code" href="group__xg_thread.html#gabfac60c4d51b57c2dc422d09a69df5b">00382</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#gabfac60c4d51b57c2dc422d09a69df5b" title="Continue with the highest priority thread, which is ready to run.">NutThreadResume</a>(<span class="keywordtype">void</span>)
<a name="l00383"></a>00383 {
<a name="l00384"></a>00384     NUTTHREADINFO *td;
<a name="l00385"></a>00385     NUTTHREADINFO **qhp;
<a name="l00386"></a>00386     NUTTHREADINFO *tqp;
<a name="l00387"></a>00387     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cnt;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="comment">/*</span>
<a name="l00390"></a>00390 <span class="comment">     * Process events that have been posted from interrupt context.</span>
<a name="l00391"></a>00391 <span class="comment">     */</span>
<a name="l00392"></a>00392     td = <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>;
<a name="l00393"></a>00393     <span class="keywordflow">while</span> (td) {
<a name="l00394"></a>00394         <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00395"></a>00395         cnt = td-&gt;td_qpec;
<a name="l00396"></a>00396         <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (cnt) {
<a name="l00398"></a>00398             <span class="comment">/* In order to reduce context switching time, it is sufficient </span>
<a name="l00399"></a>00399 <span class="comment">             * to remove the thread on top of the priority ordered list. */</span>
<a name="l00400"></a>00400             qhp = (NUTTHREADINFO **)(td-&gt;td_queue);
<a name="l00401"></a>00401             <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00402"></a>00402             td-&gt;td_qpec--;
<a name="l00403"></a>00403             tqp = *qhp;
<a name="l00404"></a>00404             <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00405"></a>00405             <span class="keywordflow">if</span> (tqp != <a class="code" href="group__xg_event.html#g65e5b23d1a8f35862480021738a7ecbc" title="Signaled state definition.">SIGNALED</a>) {
<a name="l00406"></a>00406                 <a class="code" href="group__xg_event.html#g129d2de44ddf083f252d0754fc45d9d3" title="Asynchronously post an event to a specified queue.">NutEventPostAsync</a>((<a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> *)qhp);
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409         td = td-&gt;td_next;
<a name="l00410"></a>00410     }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">/*</span>
<a name="l00413"></a>00413 <span class="comment">     * Process elapsed timers. Must be done after processing the</span>
<a name="l00414"></a>00414 <span class="comment">     * events from interupt routines.</span>
<a name="l00415"></a>00415 <span class="comment">     */</span>
<a name="l00416"></a>00416     <a class="code" href="group__xg_timer.html#gf719e88403b4ccc78f071ce5c85a5a71" title="Process elapsed timers.">NutTimerProcessElapsed</a>();
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="comment">/* Check for context switch. */</span>
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> != <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>) {
<a name="l00420"></a>00420 <span class="preprocessor">#ifdef NUTTRACER</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span>        <a class="code" href="tracer_8h.html#13ff70327495af9231d37e7f39566df8">TRACE_ADD_ITEM</a>(<a class="code" href="tracer_8h.html#7a5df012ac53096250c30122ee3a1f01">TRACE_TAG_THREAD_YIELD</a>,(<span class="keywordtype">int</span>)<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>);
<a name="l00422"></a>00422 <span class="preprocessor">#endif</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (runningThread-&gt;td_state == <a class="code" href="thread_8h.html#6c7d2e848e80e808dece40238a9554d6">TDS_RUNNING</a>) {
<a name="l00425"></a>00425             runningThread-&gt;td_state = <a class="code" href="thread_8h.html#8e9436acfb1d3388c9ea9a502724beae">TDS_READY</a>;
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427         <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00428"></a>00428         <a class="code" href="group__xg_nut_arch_avr_os_context_icc.html#gd63408e1c4ef1c03d9f979ad2d31b7e0" title="Switch to another thread.">NutThreadSwitch</a>();
<a name="l00429"></a>00429         <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00450"></a><a class="code" href="group__xg_thread.html#g8730ce8319ffcb5e14a413458125e41a">00450</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#g8730ce8319ffcb5e14a413458125e41a" title="Resume a previously suspended thread.">NutThreadWake</a>(<a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> timer, <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> th)
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452     <a class="code" href="nutdebug_8h.html#c8cfe28a71b6736cb1ed989e4e19bf97">NUTASSERT</a>(th != NULL);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454     <span class="comment">/* clear pointer on timer and waiting queue */</span>
<a name="l00455"></a>00455     ((NUTTHREADINFO *) th)-&gt;td_timer = 0;
<a name="l00456"></a>00456     ((NUTTHREADINFO *) th)-&gt;td_state = <a class="code" href="thread_8h.html#8e9436acfb1d3388c9ea9a502724beae">TDS_READY</a>;
<a name="l00457"></a>00457     <a class="code" href="group__xg_thread.html#g4d2458fb9ec9d926a6f87706b19e7e06" title="Add a thread to a prioritiy ordered queue.">NutThreadAddPriQueue</a>(th, (NUTTHREADINFO **) &amp; <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>);
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00468"></a><a class="code" href="group__xg_thread.html#g075836f9a2596c5983b7ba88420afd11">00468</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#g075836f9a2596c5983b7ba88420afd11" title="Give up the CPU.">NutThreadYield</a>(<span class="keywordtype">void</span>)
<a name="l00469"></a>00469 {
<a name="l00470"></a>00470 
<a name="l00471"></a>00471 <span class="preprocessor">#ifdef __NUT_EMULATION__</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span>    <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00473"></a>00473     <a class="code" href="arch_2unix_2os_2nutinit_8c.html#9a30bd9f48ccc047fd4557d18082990e" title="Handle interrupt triggered NutEventPostAsync Check list of events to post and call...">NutUnixThreadYieldHook</a>();
<a name="l00474"></a>00474     <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00475"></a>00475 <span class="preprocessor">#endif</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span>
<a name="l00477"></a>00477     <span class="comment">/*</span>
<a name="l00478"></a>00478 <span class="comment">     * Remove current thread from runQueue and reinsert it.</span>
<a name="l00479"></a>00479 <span class="comment">     * The idle thread is the last one in the queue and will</span>
<a name="l00480"></a>00480 <span class="comment">     * never be removed.</span>
<a name="l00481"></a>00481 <span class="comment">     */</span>
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_qnxt) {
<a name="l00483"></a>00483         <a class="code" href="group__xg_thread.html#ge45ebad9f604755d5c5ba8adaf9e4f89" title="Remove a thread from a specified queue.">NutThreadRemoveQueue</a>(<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>, (NUTTHREADINFO **) &amp; <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>);
<a name="l00484"></a>00484         <a class="code" href="group__xg_thread.html#g4d2458fb9ec9d926a6f87706b19e7e06" title="Add a thread to a prioritiy ordered queue.">NutThreadAddPriQueue</a>(<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>, (NUTTHREADINFO **) &amp; runQueue);
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="comment">/* Continue with the highest priority thread, which is ready to run. */</span>
<a name="l00488"></a>00488     <a class="code" href="group__xg_thread.html#gabfac60c4d51b57c2dc422d09a69df5b" title="Continue with the highest priority thread, which is ready to run.">NutThreadResume</a>();
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00518"></a><a class="code" href="group__xg_thread.html#g8ebe134e9c404072584e80fb8d7e8985">00518</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="group__xg_thread.html#g8ebe134e9c404072584e80fb8d7e8985" title="Set the current thread&amp;#39;s priority.">NutThreadSetPriority</a>(<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> level)
<a name="l00519"></a>00519 {
<a name="l00520"></a>00520     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> last = <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_priority;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522     <span class="comment">/*</span>
<a name="l00523"></a>00523 <span class="comment">     * Remove the thread from the run queue and re-insert it with a new</span>
<a name="l00524"></a>00524 <span class="comment">     * priority, if this new priority level is below 255. A priotity of</span>
<a name="l00525"></a>00525 <span class="comment">     * 255 will kill the thread.</span>
<a name="l00526"></a>00526 <span class="comment">     */</span>
<a name="l00527"></a>00527     <a class="code" href="group__xg_thread.html#ge45ebad9f604755d5c5ba8adaf9e4f89" title="Remove a thread from a specified queue.">NutThreadRemoveQueue</a>(<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>, &amp;<a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>);
<a name="l00528"></a>00528     <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_priority = level;
<a name="l00529"></a>00529     <span class="keywordflow">if</span> (level &lt; 255) {
<a name="l00530"></a>00530         <a class="code" href="group__xg_thread.html#g4d2458fb9ec9d926a6f87706b19e7e06" title="Add a thread to a prioritiy ordered queue.">NutThreadAddPriQueue</a>(<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>, (NUTTHREADINFO **) &amp; <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>);
<a name="l00531"></a>00531     } <span class="keywordflow">else</span> {
<a name="l00532"></a>00532         <a class="code" href="group__xg_thread.html#gf8e9b69ee0082bcdb00fd6cdb68f4136" title="Kill the running thread.">NutThreadKill</a>();
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="comment">/*</span>
<a name="l00536"></a>00536 <span class="comment">     * Are we still on top of the queue? If yes, then change our status</span>
<a name="l00537"></a>00537 <span class="comment">     * back to running, otherwise do a context switch.</span>
<a name="l00538"></a>00538 <span class="comment">     */</span>
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a> == <a class="code" href="group__xg_thread.html#gc3d0eb03ee830f18f4b8e2c7deaaa4f1" title="List of ready-to-run threads.">runQueue</a>) {
<a name="l00540"></a>00540         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_state = <a class="code" href="thread_8h.html#6c7d2e848e80e808dece40238a9554d6">TDS_RUNNING</a>;
<a name="l00541"></a>00541     } <span class="keywordflow">else</span> {
<a name="l00542"></a>00542         <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>-&gt;td_state = <a class="code" href="thread_8h.html#8e9436acfb1d3388c9ea9a502724beae">TDS_READY</a>;
<a name="l00543"></a>00543 <span class="preprocessor">#ifdef NUTTRACER</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span>        <a class="code" href="tracer_8h.html#13ff70327495af9231d37e7f39566df8">TRACE_ADD_ITEM</a>(<a class="code" href="tracer_8h.html#504d144a14eb452b4ffcd41a0fd78867">TRACE_TAG_THREAD_SETPRIO</a>,(<span class="keywordtype">int</span>)<a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>);
<a name="l00545"></a>00545 <span class="preprocessor">#endif</span>
<a name="l00546"></a>00546 <span class="preprocessor"></span>
<a name="l00547"></a>00547         <a class="code" href="include_2arch_2arm_2atom_8h.html#87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00548"></a>00548         <a class="code" href="group__xg_nut_arch_avr_os_context_icc.html#gd63408e1c4ef1c03d9f979ad2d31b7e0" title="Switch to another thread.">NutThreadSwitch</a>();
<a name="l00549"></a>00549         <a class="code" href="include_2arch_2arm_2atom_8h.html#06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keywordflow">return</span> last;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00565"></a><a class="code" href="group__xg_thread.html#gd86d73178ce22d0a32ae83ec775c4722">00565</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#gd86d73178ce22d0a32ae83ec775c4722" title="End the current thread.">NutThreadExit</a>(<span class="keywordtype">void</span>)
<a name="l00566"></a>00566 {
<a name="l00567"></a>00567     <a class="code" href="group__xg_thread.html#g8ebe134e9c404072584e80fb8d7e8985" title="Set the current thread&amp;#39;s priority.">NutThreadSetPriority</a>(255);
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00579"></a><a class="code" href="group__xg_thread.html#gba085dddcb4bf80a0b246bd06618d740">00579</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#gba085dddcb4bf80a0b246bd06618d740" title="Free a thread that was previously killed and release memory back to the OS.">NutThreadDestroy</a>(<span class="keywordtype">void</span>)
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581     <span class="keywordflow">if</span> (<a class="code" href="group__xg_thread.html#gac039e42bf2cb431a4bbce9fe50c577b" title="Thread to be killed.">killedThread</a>) {
<a name="l00582"></a>00582         <a class="code" href="heap_8h.html#c92bf33fd5f02c9d6d48a383c09dd9cb">NutStackFree</a>(<a class="code" href="group__xg_thread.html#gac039e42bf2cb431a4bbce9fe50c577b" title="Thread to be killed.">killedThread</a>-&gt;td_memory);
<a name="l00583"></a>00583         <a class="code" href="group__xg_thread.html#gac039e42bf2cb431a4bbce9fe50c577b" title="Thread to be killed.">killedThread</a> = 0;
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00594"></a><a class="code" href="group__xg_thread.html#gf8e9b69ee0082bcdb00fd6cdb68f4136">00594</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_thread.html#gf8e9b69ee0082bcdb00fd6cdb68f4136" title="Kill the running thread.">NutThreadKill</a>(<span class="keywordtype">void</span>)
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     NUTTHREADINFO *pCur = <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>;
<a name="l00598"></a>00598     NUTTHREADINFO **pp = (NUTTHREADINFO **) &amp; <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="comment">/* Free up any unfinished already killed threads. */</span>
<a name="l00601"></a>00601     <a class="code" href="group__xg_thread.html#gba085dddcb4bf80a0b246bd06618d740" title="Free a thread that was previously killed and release memory back to the OS.">NutThreadDestroy</a>();
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     <span class="comment">/* Remove from the thread list. */</span>
<a name="l00604"></a>00604     <span class="keywordflow">while</span> (pCur) {
<a name="l00605"></a>00605         <span class="keywordflow">if</span> (pCur == <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>) {
<a name="l00606"></a>00606             *pp = pCur-&gt;td_next;
<a name="l00607"></a>00607             <span class="keywordflow">break</span>;
<a name="l00608"></a>00608         }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610         pp = (NUTTHREADINFO **) &amp; pCur-&gt;td_next;
<a name="l00611"></a>00611         pCur = pCur-&gt;td_next;
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="comment">/* Schedule for cleanup. */</span>
<a name="l00615"></a>00615     <a class="code" href="group__xg_thread.html#gac039e42bf2cb431a4bbce9fe50c577b" title="Thread to be killed.">killedThread</a> = <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00627"></a><a class="code" href="group__xg_thread.html#g175aed2a498e36845b8cbfdd99731f75">00627</a> <a class="code" href="nut__types_8h.html#a8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> <a class="code" href="group__xg_thread.html#g175aed2a498e36845b8cbfdd99731f75" title="Query handle of a thread with a specific name.">GetThreadByName</a>(<span class="keywordtype">char</span> * name)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     NUTTHREADINFO *tdp;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     <span class="keywordflow">if</span> (name) {
<a name="l00632"></a>00632         <span class="keywordflow">for</span> (tdp = <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>; tdp; tdp = tdp-&gt;td_next) {
<a name="l00633"></a>00633             <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(tdp-&gt;td_name, name) == 0)
<a name="l00634"></a>00634                 <span class="keywordflow">return</span> tdp;
<a name="l00635"></a>00635         }
<a name="l00636"></a>00636     } <span class="keywordflow">else</span> {
<a name="l00637"></a>00637         <span class="keywordflow">return</span> <a class="code" href="group__xg_thread.html#g1308a2cb119d012de42abc74121c5b06" title="Currently running thread.">runningThread</a>;
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639     <span class="keywordflow">return</span> NULL;
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="preprocessor">#if defined(NUTDEBUG_CHECK_STACKMIN) || defined(NUTDEBUG_CHECK_STACK)</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span><span class="comment">/* Calculate the size if untouched stack space. */</span>
<a name="l00644"></a>00644 <span class="keyword">static</span> <span class="keywordtype">size_t</span> StackAvail(NUTTHREADINFO *td)
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *sp = (<a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> *)td-&gt;td_memory;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     <span class="keywordflow">while</span>(*sp++ == <a class="code" href="thread_8h.html#4d42db9fd9bb0a17135c07effdf7c1e6">DEADBEEF</a>);
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     <span class="keywordflow">return</span> (<span class="keywordtype">size_t</span>)((<a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a>)sp - (<a class="code" href="stdint_8h.html#2c8c1b9f53772a86b0827ce7399b68aa">uintptr_t</a>)td-&gt;td_memory);
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00674"></a>00674 <span class="keywordtype">size_t</span> <a class="code" href="thread_8h.html#d3d53c8f90bef732dd044b78c55f801c">NutThreadStackAvailable</a>(<span class="keywordtype">char</span> *name)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676     NUTTHREADINFO *tdp = (NUTTHREADINFO *)<a class="code" href="group__xg_thread.html#g175aed2a498e36845b8cbfdd99731f75" title="Query handle of a thread with a specific name.">GetThreadByName</a>(name);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678     <span class="keywordflow">return</span> tdp ? StackAvail(tdp) : 0;
<a name="l00679"></a>00679 }
<a name="l00680"></a>00680 
<a name="l00692"></a>00692 NUTTHREADINFO *<a class="code" href="thread_8h.html#e6ac99d712c1561b526b09c5a1da604d">NutThreadStackCheck</a>(<span class="keywordtype">size_t</span> minsiz)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694     NUTTHREADINFO *tdp;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="keywordflow">for</span> (tdp = <a class="code" href="group__xg_thread.html#g4795eff325a697d9e5d1cddaf81a251e" title="List of all created threads.">nutThreadList</a>; tdp; tdp = tdp-&gt;td_next) {
<a name="l00697"></a>00697         <span class="keywordflow">if</span> (StackAvail(tdp) &lt; minsiz) {
<a name="l00698"></a>00698             <span class="keywordflow">break</span>;
<a name="l00699"></a>00699         }
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     <span class="keywordflow">return</span> tdp;
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 <span class="preprocessor">#endif</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
