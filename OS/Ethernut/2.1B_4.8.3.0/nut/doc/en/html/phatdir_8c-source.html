<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Nut/OS API</title>
    <link href="nut_en.css" rel="stylesheet" type="text/css">
    <link href="nut_entabs.css" rel="stylesheet" type="text/css">
</head>
<body>
<!-- Generated by Doxygen 1.5.8 -->
  <div class="navpath"><a class="el" href="dir_f74ade614ec31c2ba6c13faba1bd859c.html">fs</a>
  </div>
<div class="contents">
<h1>phatdir.c</h1><a href="phatdir_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2005-2006 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 
<a name="l00108"></a>00108 <span class="preprocessor">#include &lt;<a class="code" href="fs_2fs_8h.html" title="File system access.">fs/fs.h</a>&gt;</span>
<a name="l00109"></a>00109 <span class="preprocessor">#include &lt;<a class="code" href="phatfs_8h.html" title="PHAT file system.">fs/phatfs.h</a>&gt;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &lt;<a class="code" href="phatvol_8h.html" title="PHAT file system.">fs/phatvol.h</a>&gt;</span>
<a name="l00111"></a>00111 <span class="preprocessor">#include &lt;<a class="code" href="phatio_8h.html" title="PHAT file system.">fs/phatio.h</a>&gt;</span>
<a name="l00112"></a>00112 <span class="preprocessor">#include &lt;<a class="code" href="phatutil_8h.html" title="PHAT file system.">fs/phatutil.h</a>&gt;</span>
<a name="l00113"></a>00113 <span class="preprocessor">#include &lt;<a class="code" href="phatdir_8h.html" title="PHAT file system.">fs/phatdir.h</a>&gt;</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00116"></a>00116 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00117"></a>00117 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00118"></a>00118 <span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<a name="l00119"></a>00119 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00120"></a>00120 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>
<a name="l00121"></a>00121 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="preprocessor">#if 0</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span><span class="comment">/* Use for local debugging. */</span>
<a name="l00125"></a>00125 <span class="preprocessor">#define NUTDEBUG</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00127"></a>00127 <span class="preprocessor">#include &lt;<a class="code" href="phatdbg_8h.html" title="PHAT debugging routine prototypes.">fs/phatdbg.h</a>&gt;</span>
<a name="l00128"></a>00128 <span class="preprocessor">#endif</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>
<a name="l00134"></a>00134 
<a name="l00136"></a><a class="code" href="group__xg_phat_dir.html#ge5abe16bc7566cadbae28e55c8f04f79">00136</a> <span class="preprocessor">#define PHAT_MAXDIRENT   65536</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>
<a name="l00144"></a>00144 <span class="keyword">static</span> <a class="code" href="arm_8h.html#2eb6f9e0395b47b8d5e3eeae4fe0c116">INLINE</a> <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> GenShortNameChecksum(<span class="keywordtype">char</span> *sfn)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> rc = 0;
<a name="l00147"></a>00147     <span class="keywordtype">int</span> i;
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     <span class="keywordflow">for</span> (i = 0; i &lt; 11; i++) {
<a name="l00150"></a>00150         rc = ((rc &gt;&gt; 1) | ((rc &amp; 1) &lt;&lt; 7)) + (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)(sfn[i]);
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     <span class="keywordflow">return</span> rc;
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00166"></a>00166 <span class="keyword">static</span> <span class="keywordtype">int</span> GenShortName(NUTFILE * ndp, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *lfn, <span class="keywordtype">char</span> *sfn)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <span class="keywordtype">int</span> rc = -1;
<a name="l00169"></a>00169     <span class="keywordtype">int</span> i;
<a name="l00170"></a>00170     <span class="keywordtype">int</span> got;
<a name="l00171"></a>00171     <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> *entry;
<a name="l00172"></a>00172     <span class="keywordtype">char</span> *xp;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">/* Fill the buffer with spaces. */</span>
<a name="l00175"></a>00175     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(sfn, <span class="charliteral">' '</span>, 11);
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="comment">/* Get the position of the last dot in the long name. */</span>
<a name="l00178"></a>00178     xp = <a class="code" href="group__xg_crt_string.html#gf8adfe0dbc4a2fe911d1385883279000" title="Locate the last occurrence of a character in a NUL terminated string.">strrchr</a>(lfn, <span class="charliteral">'.'</span>);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/* Now collect up to 8 characters for the basename and 3 characters</span>
<a name="l00181"></a>00181 <span class="comment">     * for the extension. */</span>
<a name="l00182"></a>00182     <span class="keywordflow">for</span> (i = 0; i &lt; 11 &amp;&amp; *lfn; lfn++) {
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (*lfn == <span class="charliteral">'.'</span>) {
<a name="l00184"></a>00184             <span class="comment">/* We reached the first dot. The basename ends here. */</span>
<a name="l00185"></a>00185             <span class="keywordflow">if</span> (lfn == xp) {
<a name="l00186"></a>00186                 <span class="comment">/* This is also the last dot. Start copying the extension. */</span>
<a name="l00187"></a>00187                 lfn++;
<a name="l00188"></a>00188                 <span class="keywordflow">if</span> (*lfn) {
<a name="l00189"></a>00189                     sfn[8] = <a class="code" href="wins_8c.html#b6182394c667c4e4426f98af3309c30d">toupper</a>(*lfn);
<a name="l00190"></a>00190                 }
<a name="l00191"></a>00191                 i = 9;
<a name="l00192"></a>00192             }
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i == 8) {
<a name="l00195"></a>00195             <span class="comment">/* First 8 characters collected. */</span>
<a name="l00196"></a>00196             <span class="keywordflow">if</span> (xp == NULL) {
<a name="l00197"></a>00197                 <span class="comment">/* No dot, no extension. */</span>
<a name="l00198"></a>00198                 <span class="keywordflow">break</span>;
<a name="l00199"></a>00199             }
<a name="l00200"></a>00200             lfn = xp + 1;
<a name="l00201"></a>00201             <span class="keywordflow">if</span> (*lfn) {
<a name="l00202"></a>00202                 sfn[i++] = <a class="code" href="wins_8c.html#b6182394c667c4e4426f98af3309c30d">toupper</a>(*lfn);
<a name="l00203"></a>00203             }
<a name="l00204"></a>00204         }
<a name="l00205"></a>00205         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*lfn != <span class="charliteral">' '</span>) {
<a name="l00206"></a>00206             <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#gf8adfe0dbc4a2fe911d1385883279000" title="Locate the last occurrence of a character in a NUL terminated string.">strrchr</a>(<span class="stringliteral">"+,;=[]"</span>, *lfn)) {
<a name="l00207"></a>00207                 sfn[i++] = <span class="charliteral">'_'</span>;
<a name="l00208"></a>00208             }
<a name="l00209"></a>00209             <span class="keywordflow">else</span> {
<a name="l00210"></a>00210                 sfn[i++] = <a class="code" href="wins_8c.html#b6182394c667c4e4426f98af3309c30d">toupper</a>(*lfn);
<a name="l00211"></a>00211             }
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">/*</span>
<a name="l00216"></a>00216 <span class="comment">     * Select a unique short name by verifying existing entries in the </span>
<a name="l00217"></a>00217 <span class="comment">     * specified directory.</span>
<a name="l00218"></a>00218 <span class="comment">     */</span>
<a name="l00219"></a>00219     <span class="keywordflow">if</span> ((entry = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>))) != NULL) {
<a name="l00220"></a>00220         xp = sfn;
<a name="l00221"></a>00221         <span class="keywordflow">for</span> (i = 0; i &lt; 6 &amp;&amp; *xp != <span class="charliteral">' '</span>; i++) {
<a name="l00222"></a>00222             xp++;
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224         <span class="comment">/*</span>
<a name="l00225"></a>00225 <span class="comment">         * We try up to 99 unique short names only, but this should be</span>
<a name="l00226"></a>00226 <span class="comment">         * sufficient for our tiny system - hopefully.</span>
<a name="l00227"></a>00227 <span class="comment">         */</span>
<a name="l00228"></a>00228         <span class="keywordflow">for</span> (i = 1; i &lt;= 99 &amp;&amp; rc; i++) {
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (i == 10) {
<a name="l00230"></a>00230                 xp--;
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232             *xp = <span class="charliteral">'~'</span>;
<a name="l00233"></a>00233             <span class="keywordflow">if</span> (i &gt; 9) {
<a name="l00234"></a>00234                 *(xp + 1) = <span class="charliteral">'0'</span> + i / 10;
<a name="l00235"></a>00235                 *(xp + 2) = <span class="charliteral">'0'</span> + i % 10;
<a name="l00236"></a>00236             }
<a name="l00237"></a>00237             <span class="keywordflow">else</span> {
<a name="l00238"></a>00238                 *(xp + 1) = <span class="charliteral">'0'</span> + i;
<a name="l00239"></a>00239             }
<a name="l00240"></a>00240             <a class="code" href="group__xg_phat_util.html#g3ac06e687a0ad471beaf7a25a48730f0" title="Set file pointer back to zero.">PhatFilePosRewind</a>((<a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *)ndp-&gt;nf_fcb);
<a name="l00241"></a>00241             <span class="keywordflow">for</span> (;;) {
<a name="l00242"></a>00242                 <span class="comment">/* Read next entry. */</span>
<a name="l00243"></a>00243                 <span class="keywordflow">if</span> ((got = <a class="code" href="group__xg_phat_fs.html#g8ca25466d168febccd7d82c6d6412281" title="Read data from a file.">PhatFileRead</a>(ndp, entry, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>))) != <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) {
<a name="l00244"></a>00244                     <span class="keywordflow">if</span> (got) {
<a name="l00245"></a>00245                         <span class="comment">/* Read error, stop searching. */</span>
<a name="l00246"></a>00246                         i = 9;
<a name="l00247"></a>00247                     }
<a name="l00248"></a>00248                     <span class="keywordflow">else</span> {
<a name="l00249"></a>00249                         <span class="comment">/* End of directory reached, entry is unique. */</span>
<a name="l00250"></a>00250                         rc = 0;
<a name="l00251"></a>00251                     }
<a name="l00252"></a>00252                     <span class="keywordflow">break</span>;
<a name="l00253"></a>00253                 }
<a name="l00254"></a>00254                 <span class="keywordflow">if</span> ((entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> &amp; <a class="code" href="group__xg_phat_fs.html#g3184332097dd301d8308d8a505ecae32">PHAT_FATTR_VOLID</a>) == 0) {
<a name="l00255"></a>00255                     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] == 0) {
<a name="l00256"></a>00256                         <span class="comment">/* End of directory reached, entry is unique. */</span>
<a name="l00257"></a>00257                         rc = 0;
<a name="l00258"></a>00258                         <span class="keywordflow">break</span>;
<a name="l00259"></a>00259                     }
<a name="l00260"></a>00260                     <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#g135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(sfn, (<span class="keywordtype">char</span> *)entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>, 11) == 0) {
<a name="l00261"></a>00261                         <span class="comment">/* Entry exists, try next one. */</span>
<a name="l00262"></a>00262                         <span class="keywordflow">break</span>;
<a name="l00263"></a>00263                     }
<a name="l00264"></a>00264                 }
<a name="l00265"></a>00265             }
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(entry);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     <span class="keywordflow">return</span> rc;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="keywordtype">int</span> PhatDirEntryAlloc(NUTFILE * ndp, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *fname, <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> * entry)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283     <span class="keywordtype">int</span> rc;
<a name="l00284"></a>00284     <span class="keywordtype">int</span> pos = 0;
<a name="l00285"></a>00285     <span class="keywordtype">int</span> got;
<a name="l00286"></a>00286     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> sect;
<a name="l00287"></a>00287     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *temp;
<a name="l00288"></a>00288     NUTDEVICE *dev = ndp-&gt;nf_dev;
<a name="l00289"></a>00289     <a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *dfcb = ndp-&gt;nf_fcb;
<a name="l00290"></a>00290     <a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *vol = (<a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *) dev-&gt;dev_dcb;
<a name="l00291"></a>00291     <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> *dent;
<a name="l00292"></a>00292     <a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a> *xdent;
<a name="l00293"></a>00293     <span class="keywordtype">int</span> nwant = 1;
<a name="l00294"></a>00294     <span class="keywordtype">int</span> ngot = 0;
<a name="l00295"></a>00295     <span class="keywordtype">int</span> npos = 0;
<a name="l00296"></a>00296     <span class="keywordtype">int</span> i;
<a name="l00297"></a>00297     <span class="keywordtype">int</span> ci;
<a name="l00298"></a>00298     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> cks = 0;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="comment">/* Convert the dotted name to a space filled one. */</span>
<a name="l00301"></a>00301     if ((rc = <a class="code" href="group__xg_phat_util.html#g7d4c4a20a85f59021d9ad21b2cad9213" title="Convert filename to a directory entry name.">MakePhatName</a>(fname, entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>)) == 1) {
<a name="l00302"></a>00302         <span class="comment">/* Reject name with wildcards. */</span>
<a name="l00303"></a>00303         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l00304"></a>00304         <span class="keywordflow">return</span> -1;
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (rc == 0) {
<a name="l00307"></a>00307         <span class="keywordtype">char</span> vname[16];
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <a class="code" href="group__xg_phat_util.html#gb8acd5bc4ad4a825280e77591812f392" title="Convert a directory entry name to a visible file name.">MakeVisibleName</a>(entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>, vname);
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#gafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(fname, vname)) {
<a name="l00311"></a>00311             rc = 1;
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314     <span class="keywordflow">if</span> (rc) {
<a name="l00315"></a>00315         <span class="keywordflow">if</span> (GenShortName(ndp, fname, (<span class="keywordtype">char</span> *)entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>)) {
<a name="l00316"></a>00316             <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l00317"></a>00317             <span class="keywordflow">return</span> -1;
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         nwant = (<a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(fname) + 12) / 13 + 1;
<a name="l00320"></a>00320         cks = GenShortNameChecksum((<span class="keywordtype">char</span> *)entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>);
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     <span class="comment">/* Allocate a temporary entry buffer. */</span>
<a name="l00324"></a>00324     <span class="keywordflow">if</span> ((dent = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>))) == NULL) {
<a name="l00325"></a>00325         <span class="keywordflow">return</span> -1;
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <span class="comment">/*</span>
<a name="l00329"></a>00329 <span class="comment">     * Find free entries, starting from the beginning.</span>
<a name="l00330"></a>00330 <span class="comment">     */</span>
<a name="l00331"></a>00331     <a class="code" href="group__xg_phat_util.html#g3ac06e687a0ad471beaf7a25a48730f0" title="Set file pointer back to zero.">PhatFilePosRewind</a>(dfcb);
<a name="l00332"></a>00332     rc = -1;
<a name="l00333"></a>00333     <span class="keywordflow">for</span> (;;) {
<a name="l00334"></a>00334         <span class="comment">/* Memorize the current position and try to read the next entry. */</span>
<a name="l00335"></a>00335         npos = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#0ad124686894e2428706975fc49d3460" title="Current position into the file.">f_pos</a>;
<a name="l00336"></a>00336         <span class="keywordflow">if</span> ((got = <a class="code" href="group__xg_phat_fs.html#g8ca25466d168febccd7d82c6d6412281" title="Read data from a file.">PhatFileRead</a>(ndp, dent, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>))) &lt; 0) {
<a name="l00337"></a>00337             <span class="comment">/* Read failed. */</span>
<a name="l00338"></a>00338             <span class="keywordflow">break</span>;
<a name="l00339"></a>00339         }
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (got != <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) {
<a name="l00341"></a>00341             <span class="comment">/*</span>
<a name="l00342"></a>00342 <span class="comment">             * End of directory reached. Try to expand it. </span>
<a name="l00343"></a>00343 <span class="comment">             */</span>
<a name="l00344"></a>00344             <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_util.html#gdeebffe4cccf50aee555551e8e90ee13" title="Test for PHAT12/PHAT16 root directory.">IsFixedRootDir</a>(ndp) ||  <span class="comment">/* */</span>
<a name="l00345"></a>00345                 dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#0ad124686894e2428706975fc49d3460" title="Current position into the file.">f_pos</a> &gt;= <a class="code" href="group__xg_phat_dir.html#ge5abe16bc7566cadbae28e55c8f04f79" title="Maximum number of directory entries.">PHAT_MAXDIRENT</a> * <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) {
<a name="l00346"></a>00346                 <span class="comment">/* Failed. Either PHAT12/16 root dir or max. size reached. */</span>
<a name="l00347"></a>00347                 <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#f5401a500939ed1812c04ca200b95eef">EFBIG</a>;
<a name="l00348"></a>00348                 <span class="keywordflow">break</span>;
<a name="l00349"></a>00349             }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351             <span class="comment">/* Fill a new cluster with zeros. */</span>
<a name="l00352"></a>00352             <span class="keywordflow">if</span> ((temp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#fdc954c2e8cbdf751299576d2b49a402" title="Bytes per sector.">vol_sectsz</a>)) == NULL) {
<a name="l00353"></a>00353                 <span class="keywordflow">break</span>;
<a name="l00354"></a>00354             }
<a name="l00355"></a>00355             <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(temp, 0, vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#fdc954c2e8cbdf751299576d2b49a402" title="Bytes per sector.">vol_sectsz</a>);
<a name="l00356"></a>00356             <span class="keywordflow">for</span> (sect = vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#97c3a93b08c83b1605b4e58b79b8dfa2" title="Sectors per cluster.">vol_clustsz</a>; sect; sect--) {
<a name="l00357"></a>00357                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, temp, vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#fdc954c2e8cbdf751299576d2b49a402" title="Bytes per sector.">vol_sectsz</a>) &lt; 0) {
<a name="l00358"></a>00358                     <span class="comment">/* Write failed. */</span>
<a name="l00359"></a>00359                     <span class="keywordflow">break</span>;
<a name="l00360"></a>00360                 }
<a name="l00361"></a>00361             }
<a name="l00362"></a>00362             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(temp);
<a name="l00363"></a>00363             <span class="comment">/* End of directory reached and expanded by a new cluster. */</span>
<a name="l00364"></a>00364             <span class="keywordflow">if</span> (sect == 0) {
<a name="l00365"></a>00365                 <span class="keywordflow">if</span> (ngot == 0) {
<a name="l00366"></a>00366                     pos = npos;
<a name="l00367"></a>00367                 }
<a name="l00368"></a>00368                 rc = 0;
<a name="l00369"></a>00369             }
<a name="l00370"></a>00370             <span class="keywordflow">break</span>;
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (dent-&gt;dent_name[0] == <a class="code" href="group__xg_phat_dir.html#g37e0fa01713a0cd842b8da950338b808">PHAT_REM_DIRENT</a> || dent-&gt;dent_name[0] == 0) {
<a name="l00373"></a>00373             <span class="comment">/* Empty entry found. */</span>
<a name="l00374"></a>00374             <span class="keywordflow">if</span> (ngot == 0) {
<a name="l00375"></a>00375                 pos = npos;
<a name="l00376"></a>00376             }
<a name="l00377"></a>00377             ngot++;
<a name="l00378"></a>00378             <span class="keywordflow">if</span> (ngot &gt;= nwant) {
<a name="l00379"></a>00379                 rc = 0;
<a name="l00380"></a>00380                 <span class="keywordflow">break</span>;
<a name="l00381"></a>00381             }
<a name="l00382"></a>00382         }
<a name="l00383"></a>00383         <span class="keywordflow">else</span> {
<a name="l00384"></a>00384             ngot = 0;
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dent);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (rc == 0) {
<a name="l00390"></a>00390         <span class="comment">/* Return to the memorized position and write the new entry. */</span>
<a name="l00391"></a>00391         <a class="code" href="group__xg_phat_util.html#g2bd74a76e042a33207b0425982e46466" title="Move file pointer to a specified position.">PhatFilePosSet</a>(ndp, pos);
<a name="l00392"></a>00392         <span class="keywordflow">if</span> ((xdent = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a>))) == NULL) {
<a name="l00393"></a>00393             <span class="keywordflow">return</span> -1;
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395         <span class="keywordflow">for</span> (ngot = nwant - 1; ngot; ngot--) {
<a name="l00396"></a>00396             <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(xdent, 0xFF, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a>));
<a name="l00397"></a>00397             xdent-&gt;xdent_seq = ngot;
<a name="l00398"></a>00398             <span class="keywordflow">if</span> (ngot == nwant - 1) {
<a name="l00399"></a>00399                 xdent-&gt;xdent_seq |= 0x40;
<a name="l00400"></a>00400             }
<a name="l00401"></a>00401             xdent-&gt;xdent_attr = <a class="code" href="group__xg_phat_fs.html#g4810a4182f7086ca462240dc8d2f080e">PHAT_FATTR_LFN</a>;
<a name="l00402"></a>00402             xdent-&gt;xdent_cks = cks;
<a name="l00403"></a>00403             xdent-&gt;xdent_clust = 0;
<a name="l00404"></a>00404             xdent-&gt;xdent_rsvd = 0;
<a name="l00405"></a>00405             <span class="comment">/* Simplified unicode conversion, ignores double byte characters. */</span>
<a name="l00406"></a>00406             ci = (ngot - 1) * 13;
<a name="l00407"></a>00407             <span class="keywordflow">for</span> (i = 0; i &lt; 13; i++) {
<a name="l00408"></a>00408                 <span class="keywordflow">if</span> (ci + i &lt;= <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(fname)) {
<a name="l00409"></a>00409                     <span class="keywordflow">if</span> (i &lt; 5) {
<a name="l00410"></a>00410                         xdent-&gt;xdent_uname_1_5[i] = fname[ci + i];
<a name="l00411"></a>00411                     }
<a name="l00412"></a>00412                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &lt; 11) {
<a name="l00413"></a>00413                         xdent-&gt;xdent_uname_6_11[i - 5] = fname[ci + i];
<a name="l00414"></a>00414                     }
<a name="l00415"></a>00415                     <span class="keywordflow">else</span> {
<a name="l00416"></a>00416                         xdent-&gt;xdent_uname_12_13[i - 11] = fname[ci + i];
<a name="l00417"></a>00417                     }
<a name="l00418"></a>00418                 }
<a name="l00419"></a>00419             }
<a name="l00420"></a>00420             <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, xdent, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a>)) &lt; 0) {
<a name="l00421"></a>00421                 <span class="comment">/* Write error. */</span>
<a name="l00422"></a>00422                 rc = -1;
<a name="l00423"></a>00423                 <span class="keywordflow">break</span>;
<a name="l00424"></a>00424             }
<a name="l00425"></a>00425         }
<a name="l00426"></a>00426         <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, entry, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) &lt; 0) {
<a name="l00427"></a>00427             <span class="comment">/* Write error. */</span>
<a name="l00428"></a>00428             rc = -1;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(xdent);
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432     <span class="keywordflow">return</span> rc;
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00447"></a>00447 <span class="keyword">static</span> <span class="keywordtype">int</span> PhatDirEntryRelease(NUTFILE * ndp, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> pos, <span class="keywordtype">int</span> lfncnt)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ch = <a class="code" href="group__xg_phat_dir.html#g37e0fa01713a0cd842b8da950338b808">PHAT_REM_DIRENT</a>;
<a name="l00450"></a>00450     <span class="keywordtype">int</span> i;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordflow">for</span> (i = lfncnt; i; i--) {
<a name="l00453"></a>00453         <a class="code" href="group__xg_phat_util.html#g2bd74a76e042a33207b0425982e46466" title="Move file pointer to a specified position.">PhatFilePosSet</a>(ndp, pos - i * <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a>));
<a name="l00454"></a>00454         <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, &amp;ch, 1) &lt; 0) {
<a name="l00455"></a>00455             <span class="keywordflow">return</span> -1;
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458     <a class="code" href="group__xg_phat_util.html#g2bd74a76e042a33207b0425982e46466" title="Move file pointer to a specified position.">PhatFilePosSet</a>(ndp, pos);
<a name="l00459"></a>00459     <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, &amp;ch, 1) &lt; 0) {
<a name="l00460"></a>00460         <span class="keywordflow">return</span> -1;
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462     <span class="keywordflow">return</span> 0;
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00475"></a><a class="code" href="group__xg_phat_dir.html#gd4cf520f42cad1386fd6efc8c9ca3c5c">00475</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#gd4cf520f42cad1386fd6efc8c9ca3c5c" title="Create a new directory entry.">PhatDirEntryCreate</a>(NUTFILE * ndp, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> acc, <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> * <a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a>)
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477     dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) acc;
<a name="l00478"></a>00478     <a class="code" href="group__xg_phat_util.html#ge5d9710a8d3d5561eccd84268bec6d58" title="Create a DOS timestamp of the current time and date.">GetDosTimeStamp</a>(&amp;dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#29f39d0b737f351e8551fb29bcfc465d" title="File creation time.">dent_ctime</a>, &amp;dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#7d20fbc290a39d8112a3c20b997cbcd9" title="File creation date.">dent_cdate</a>);
<a name="l00479"></a>00479     dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#f292c5fbff180ae3e28e32e5e6b94b59" title="Last file access date.">dent_adate</a> = dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#7d20fbc290a39d8112a3c20b997cbcd9" title="File creation date.">dent_cdate</a>;
<a name="l00480"></a>00480     dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#fe8a17c11dff1e97623c7a234cf503d1" title="Last file modification time.">dent_mtime</a> = dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#29f39d0b737f351e8551fb29bcfc465d" title="File creation time.">dent_ctime</a>;
<a name="l00481"></a>00481     dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6355236fa326e27167598953c8fe3997" title="Last file modification date.">dent_mdate</a> = dirent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#7d20fbc290a39d8112a3c20b997cbcd9" title="File creation date.">dent_cdate</a>;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keywordflow">if</span> (PhatDirEntryAlloc(ndp, name, dirent)) {
<a name="l00484"></a>00484         <span class="keywordflow">return</span> -1;
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00487"></a>00487 <span class="preprocessor"></span>    <a class="code" href="group__xg_phat_dbg.html#g8b498add6cde6ee3e88711e4cb3a5a9b">PhatDbgFileInfo</a>(<a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>, <span class="stringliteral">"New Dir Entry"</span>, ndp-&gt;nf_fcb);
<a name="l00488"></a>00488 <span class="preprocessor">#endif</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00499"></a><a class="code" href="group__xg_phat_dir.html#gbd687b9101986e1a2dfa98bf58596320">00499</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#gbd687b9101986e1a2dfa98bf58596320" title="Update directory entry of an opened file or directory.">PhatDirEntryUpdate</a>(NUTFILE * nfp)
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501     <span class="keywordtype">int</span> sbn;
<a name="l00502"></a>00502     NUTDEVICE *dev = nfp-&gt;nf_dev;
<a name="l00503"></a>00503     <a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *vol = (<a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *) dev-&gt;dev_dcb;
<a name="l00504"></a>00504     <a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *fcb = nfp-&gt;nf_fcb;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506     if (fcb-&gt;f_de_dirty) {
<a name="l00507"></a>00507         <span class="comment">/*</span>
<a name="l00508"></a>00508 <span class="comment">         * The file may specify the root directory, in which case</span>
<a name="l00509"></a>00509 <span class="comment">         * the updated is skipped.</span>
<a name="l00510"></a>00510 <span class="comment">         */</span>
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (fcb-&gt;f_de_sect) {
<a name="l00512"></a>00512 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>            <a class="code" href="group__xg_phat_dbg.html#g5f85cf69cb129bf2cb5e1eef197e4446">PhatDbgDirEntry</a>(<a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>, <span class="stringliteral">"PhatDirEntryUpdate"</span>, &amp;fcb-&gt;f_dirent);
<a name="l00514"></a>00514 <span class="preprocessor">#endif</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((sbn = <a class="code" href="group__xg_phat_io.html#gbcf9fe7d5cf300725e1ac2a0f3c14d47">PhatSectorLoad</a>(dev, fcb-&gt;f_de_sect)) &lt; 0) {
<a name="l00516"></a>00516                 <span class="keywordflow">return</span> -1;
<a name="l00517"></a>00517             }
<a name="l00518"></a>00518             <a class="code" href="group__xg_crt_string.html#g09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#00d64180165838d6183f500326ab2f2b" title="Sector buffer of this volume.">vol_buf</a>[sbn].<a class="code" href="struct_p_h_a_t_s_e_c_t_b_u_f.html#fea6e5e6b35987e06f90cfc77b3b7b5d" title="Sector data buffer.">sect_data</a> + fcb-&gt;f_de_offs, &amp;fcb-&gt;f_dirent, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>));
<a name="l00519"></a>00519             vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#00d64180165838d6183f500326ab2f2b" title="Sector buffer of this volume.">vol_buf</a>[sbn].<a class="code" href="struct_p_h_a_t_s_e_c_t_b_u_f.html#3eed6b495667f8e551dd6fbfda46e970" title="If not zero, buffer needs to be written.">sect_dirty</a> = 1;
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         fcb-&gt;f_de_dirty = 0;
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523     <span class="keywordflow">return</span> 0;
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00534"></a>00534 <span class="keyword">static</span> <span class="keywordtype">int</span> PhatDirEntryRead(NUTFILE * ndp, <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> * srch)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536     <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> *entry = &amp;srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>;
<a name="l00537"></a>00537     <a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *fcb = ndp-&gt;nf_fcb;
<a name="l00538"></a>00538     <a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a> *xentry;
<a name="l00539"></a>00539     <span class="keywordtype">char</span> *lfn = NULL;
<a name="l00540"></a>00540     <span class="keywordtype">int</span> lfnpos = 0;
<a name="l00541"></a>00541     <span class="keywordtype">int</span> nxtseq = 0;
<a name="l00542"></a>00542     <span class="keywordtype">int</span> lfncnt = 0;
<a name="l00543"></a>00543     <span class="keywordtype">int</span> i;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     <span class="keywordflow">for</span> (;;) {
<a name="l00546"></a>00546         <span class="comment">/* Read next entry. */</span>
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g8ca25466d168febccd7d82c6d6412281" title="Read data from a file.">PhatFileRead</a>(ndp, entry, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) {
<a name="l00548"></a>00548             <span class="keywordflow">break</span>;
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550         <span class="comment">/* Skip removed entries. */</span>
<a name="l00551"></a>00551         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] == <a class="code" href="group__xg_phat_dir.html#g37e0fa01713a0cd842b8da950338b808">PHAT_REM_DIRENT</a>) {
<a name="l00552"></a>00552             <span class="keywordflow">if</span> (lfn) {
<a name="l00553"></a>00553                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(lfn);
<a name="l00554"></a>00554                 lfn = NULL;
<a name="l00555"></a>00555             }
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557         <span class="comment">/* Process long filename entries. */</span>
<a name="l00558"></a>00558         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> == <a class="code" href="group__xg_phat_fs.html#g4810a4182f7086ca462240dc8d2f080e">PHAT_FATTR_LFN</a>) {
<a name="l00559"></a>00559             xentry = (<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html" title="Structure of an extended directory entry.">PHATXDIRENT</a> *)entry;
<a name="l00560"></a>00560             lfnpos = (xentry-&gt;<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html#02e5b92b0f94465a0edd69f27c7e7fc1" title="Sequence number.">xdent_seq</a> &amp; 0x3F);
<a name="l00561"></a>00561             <span class="comment">/* Make sure we are in sequence. */</span>
<a name="l00562"></a>00562             <span class="keywordflow">if</span> ((nxtseq == 0 &amp;&amp; (xentry-&gt;<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html#02e5b92b0f94465a0edd69f27c7e7fc1" title="Sequence number.">xdent_seq</a> &amp; 0x40) != 0) || nxtseq == lfnpos) {
<a name="l00563"></a>00563                 nxtseq = --lfnpos;
<a name="l00564"></a>00564                 lfnpos *= 13;
<a name="l00565"></a>00565                 <span class="keywordflow">if</span> (lfnpos + 13 &gt; <a class="code" href="group__xg_phat_dir.html#g108a48447b91028faf4329a6f0f4e7da" title="Maximum length of a base file name.">PHAT_MAX_NAMELEN</a>) {
<a name="l00566"></a>00566                     <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#2d1678d5a7cc8ce499643f3b8957def4">EINVAL</a>;
<a name="l00567"></a>00567                     <span class="keywordflow">break</span>;
<a name="l00568"></a>00568                 }
<a name="l00569"></a>00569                 <span class="keywordflow">if</span> (xentry-&gt;<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html#02e5b92b0f94465a0edd69f27c7e7fc1" title="Sequence number.">xdent_seq</a> &amp; 0x40) {
<a name="l00570"></a>00570                     <span class="keywordflow">if</span> (lfn == NULL) {
<a name="l00571"></a>00571                         lfn = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="group__xg_phat_dir.html#g108a48447b91028faf4329a6f0f4e7da" title="Maximum length of a base file name.">PHAT_MAX_NAMELEN</a> + 1);
<a name="l00572"></a>00572                     }
<a name="l00573"></a>00573                     lfn[lfnpos + 13] = 0;
<a name="l00574"></a>00574                     lfncnt = 0;
<a name="l00575"></a>00575                 }
<a name="l00576"></a>00576                 lfncnt++;
<a name="l00577"></a>00577                 <span class="comment">/* Simplified unicode conversion, ignores double byte characters. */</span>
<a name="l00578"></a>00578                 <span class="keywordflow">for</span> (i = 0; i &lt; 5; i++) {
<a name="l00579"></a>00579                     lfn[lfnpos + i] = (char)xentry-&gt;<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html#0d79cf02f4fa4cafd97f194facf807ee" title="Unicode characters 1-5.">xdent_uname_1_5</a>[i];
<a name="l00580"></a>00580                 }
<a name="l00581"></a>00581                 <span class="keywordflow">for</span> (i = 0; i &lt; 6; i++) {
<a name="l00582"></a>00582                     lfn[lfnpos + 5 + i] = (char)xentry-&gt;<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html#2f39e448477ae31ab07e83db7301b4de" title="Unicode characters 6-11.">xdent_uname_6_11</a>[i];
<a name="l00583"></a>00583                 }
<a name="l00584"></a>00584                 <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l00585"></a>00585                     lfn[lfnpos + 11 + i] = (char)xentry-&gt;<a class="code" href="struct_p_h_a_t_x_d_i_r_e_n_t.html#3ab5d0012c681a84cba04867f10baf4c" title="Unicode characters 12-13.">xdent_uname_12_13</a>[i];
<a name="l00586"></a>00586                 }
<a name="l00587"></a>00587             }
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590         <span class="comment">/* Skip volume IDs. */</span>
<a name="l00591"></a>00591         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> &amp; <a class="code" href="group__xg_phat_fs.html#g3184332097dd301d8308d8a505ecae32">PHAT_FATTR_VOLID</a>) == 0) {
<a name="l00592"></a>00592             <span class="comment">/* Stop searching if last entry reached. */</span>
<a name="l00593"></a>00593             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] == 0) {
<a name="l00594"></a>00594                 <span class="keywordflow">break</span>;
<a name="l00595"></a>00595             }
<a name="l00596"></a>00596             <span class="comment">/* Valid entry found. Return success. */</span>
<a name="l00597"></a>00597             srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#aa17c8a960f0b7e9f9f81f5e6df2e0cf">phfind_pos</a> = fcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#0ad124686894e2428706975fc49d3460" title="Current position into the file.">f_pos</a> - <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>);
<a name="l00598"></a>00598             <span class="keywordflow">if</span> (lfn &amp;&amp; lfnpos == 0) {
<a name="l00599"></a>00599                 <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#88d0acb3d534c60275a4ec98cf99541e">phfind_name</a>, lfn);
<a name="l00600"></a>00600                 srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#e6457f051c46afe3ec3088be6cf31e28">phfind_xcnt</a> = lfncnt;
<a name="l00601"></a>00601             }
<a name="l00602"></a>00602             <span class="keywordflow">else</span> {
<a name="l00603"></a>00603                 <a class="code" href="group__xg_phat_util.html#gb8acd5bc4ad4a825280e77591812f392" title="Convert a directory entry name to a visible file name.">MakeVisibleName</a>(entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>, srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#88d0acb3d534c60275a4ec98cf99541e">phfind_name</a>);
<a name="l00604"></a>00604                 srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#e6457f051c46afe3ec3088be6cf31e28">phfind_xcnt</a> = 0;
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606             <span class="keywordflow">if</span> (lfn) {
<a name="l00607"></a>00607                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(lfn);
<a name="l00608"></a>00608             }
<a name="l00609"></a>00609             nxtseq = 0;
<a name="l00610"></a>00610             lfncnt = 0;
<a name="l00611"></a>00611             <span class="keywordflow">return</span> 0;
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lfn) {
<a name="l00614"></a>00614             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(lfn);
<a name="l00615"></a>00615             lfn = NULL;
<a name="l00616"></a>00616             nxtseq = 0;
<a name="l00617"></a>00617             lfncnt = 0;
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619     }
<a name="l00620"></a>00620     <span class="keywordflow">if</span> (lfn) {
<a name="l00621"></a>00621         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(lfn);
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623     <span class="keywordflow">return</span> -1;
<a name="l00624"></a>00624 }
<a name="l00625"></a>00625 
<a name="l00638"></a><a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076">00638</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076" title="Find a directory entry with a specified name.">PhatDirEntryFind</a>(NUTFILE * ndp, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *spec, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> attmsk, <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> * srch)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640     <span class="keywordtype">int</span> rc;
<a name="l00641"></a>00641     <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> *temps;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="comment">/* Allocate a temporary structure to store the search result. */</span>
<a name="l00644"></a>00644     <span class="keywordflow">if</span> ((temps = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a>))) == NULL) {
<a name="l00645"></a>00645         <span class="keywordflow">return</span> -1;
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     <span class="comment">/*</span>
<a name="l00649"></a>00649 <span class="comment">     * Loop until the specified entry was found or until we reach the</span>
<a name="l00650"></a>00650 <span class="comment">     * end of the directory.</span>
<a name="l00651"></a>00651 <span class="comment">     */</span>
<a name="l00652"></a>00652     <a class="code" href="group__xg_phat_util.html#g3ac06e687a0ad471beaf7a25a48730f0" title="Set file pointer back to zero.">PhatFilePosRewind</a>((<a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *)ndp-&gt;nf_fcb);
<a name="l00653"></a>00653     <span class="keywordflow">while</span> ((rc = PhatDirEntryRead(ndp, temps)) == 0) {
<a name="l00654"></a>00654         <span class="keywordflow">if</span> ((temps-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> | attmsk) == attmsk) {
<a name="l00655"></a>00655             <span class="keywordflow">if</span> (<a class="code" href="lpc2xxx_8h.html#28a86b9c77e40821f2ecaa16cf97f54f" title="Case insensitive string comparisions.">strcasecmp</a>(temps-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#88d0acb3d534c60275a4ec98cf99541e">phfind_name</a>, spec) == 0) {
<a name="l00656"></a>00656                 <span class="comment">/* Specified entry found. */</span>
<a name="l00657"></a>00657                 <span class="keywordflow">if</span> (srch) {
<a name="l00658"></a>00658                     *srch = *temps;
<a name="l00659"></a>00659                 }
<a name="l00660"></a>00660                 <span class="keywordflow">break</span>;
<a name="l00661"></a>00661             }
<a name="l00662"></a>00662         }
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(temps);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="keywordflow">return</span> rc;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 
<a name="l00679"></a><a class="code" href="group__xg_phat_dir.html#gc1b0cbea3eb7b9842608e06564066525">00679</a> NUTFILE *<a class="code" href="group__xg_phat_dir.html#gc1b0cbea3eb7b9842608e06564066525" title="Open parent directory of a given path.">PhatDirOpenParent</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> **<a class="code" href="libgen_8h.html#6406fc630ba87e33651531f0dafa07f2" title="Return the last component from a given pathname.">basename</a>)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     NUTFILE *rc = <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00682"></a>00682     <span class="keywordtype">char</span> *parent;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="keywordflow">if</span> ((parent = <a class="code" href="group__xg_phat_util.html#g7d3877a760e62215db139eed631a71ad" title="Chop off the last component of a path.">GetParentPath</a>(path, basename)) != NULL) {
<a name="l00685"></a>00685         rc = <a class="code" href="group__xg_phat_dir.html#g76c33dbcfa5ac6188e054409429f5333" title="Open a directory.">PhatDirOpen</a>(dev, parent);
<a name="l00686"></a>00686         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(parent);
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688     <span class="keywordflow">return</span> rc;
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00700"></a><a class="code" href="group__xg_phat_dir.html#g5d17533db4a5a037851c00a0e61dde31">00700</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#g5d17533db4a5a037851c00a0e61dde31" title="Rename file.">PhatDirRenameEntry</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *old_path, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *new_path)
<a name="l00701"></a>00701 {
<a name="l00702"></a>00702     <span class="keywordtype">int</span> rc = -1;
<a name="l00703"></a>00703     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *fname;
<a name="l00704"></a>00704     NUTFILE *old_ndp;
<a name="l00705"></a>00705     NUTFILE *new_ndp;
<a name="l00706"></a>00706     <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> *srch;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/*</span>
<a name="l00709"></a>00709 <span class="comment">     * Open directory of the old file.</span>
<a name="l00710"></a>00710 <span class="comment">     */</span>
<a name="l00711"></a>00711     <span class="keywordflow">if</span> ((old_ndp = <a class="code" href="group__xg_phat_dir.html#gc1b0cbea3eb7b9842608e06564066525" title="Open parent directory of a given path.">PhatDirOpenParent</a>(dev, old_path, &amp;fname)) == <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l00712"></a>00712         <span class="keywordflow">return</span> -1;
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715     <span class="keywordflow">if</span> ((srch = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a>))) != NULL) {
<a name="l00716"></a>00716         <span class="keywordflow">if</span> ((rc = <a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076" title="Find a directory entry with a specified name.">PhatDirEntryFind</a>(old_ndp, fname, <a class="code" href="group__xg_phat_fs.html#ge68316b37a26a8da9f9035d9b9ba57bc">PHAT_FATTR_FILEMASK</a>, srch)) == 0) {
<a name="l00717"></a>00717             rc = -1;
<a name="l00718"></a>00718             <span class="keywordflow">if</span> ((new_ndp = <a class="code" href="group__xg_phat_dir.html#gc1b0cbea3eb7b9842608e06564066525" title="Open parent directory of a given path.">PhatDirOpenParent</a>(dev, new_path, &amp;fname)) != <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l00719"></a>00719                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076" title="Find a directory entry with a specified name.">PhatDirEntryFind</a>(new_ndp, fname, <a class="code" href="group__xg_phat_fs.html#ge68316b37a26a8da9f9035d9b9ba57bc">PHAT_FATTR_FILEMASK</a>, NULL) == 0) {
<a name="l00720"></a>00720                     <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#0a3bef9e5c47e42917692b5dae3b5498">EEXIST</a>;
<a name="l00721"></a>00721                 } <span class="keywordflow">else</span> {
<a name="l00722"></a>00722                     <span class="keywordflow">if</span> ((rc = PhatDirEntryAlloc(new_ndp, fname, &amp;srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>)) == 0) {
<a name="l00723"></a>00723                         rc = PhatDirEntryRelease(old_ndp, srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#aa17c8a960f0b7e9f9f81f5e6df2e0cf">phfind_pos</a>, srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#e6457f051c46afe3ec3088be6cf31e28">phfind_xcnt</a>);
<a name="l00724"></a>00724                     }
<a name="l00725"></a>00725                 }
<a name="l00726"></a>00726                 <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(new_ndp);
<a name="l00727"></a>00727             }
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729         <span class="keywordflow">else</span> {
<a name="l00730"></a>00730             <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>;
<a name="l00731"></a>00731         }
<a name="l00732"></a>00732         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(srch);
<a name="l00733"></a>00733     }
<a name="l00734"></a>00734     <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(old_ndp);
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">return</span> rc;
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00747"></a><a class="code" href="group__xg_phat_dir.html#g054a857b1c7c295c44d306823cbb505f">00747</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#g054a857b1c7c295c44d306823cbb505f" title="Release a cluster chain of a specified directory entry.">PhatDirReleaseChain</a>(NUTDEVICE * dev, <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> *dent)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749     <span class="keywordtype">int</span> rc = 0;
<a name="l00750"></a>00750     <a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *vol = (<a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *) dev-&gt;dev_dcb;
<a name="l00751"></a>00751     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> clust;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="comment">/* Do not remove clusters of files with RDONLY attribute. */</span>
<a name="l00754"></a>00754     if (dent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> &amp; <a class="code" href="group__xg_phat_fs.html#g82e08def5724e129b9b5442be5bd6c0e">PHAT_FATTR_RDONLY</a>) {
<a name="l00755"></a>00755         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#c2a2e9fa555401f94478f74e01868032">EACCES</a>;
<a name="l00756"></a>00756         <span class="keywordflow">return</span> -1;
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759     <span class="comment">/* Get the first cluster of this file. The directory entry stores this</span>
<a name="l00760"></a>00760 <span class="comment">       value in two positions. */</span>
<a name="l00761"></a>00761     clust = dent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a>;
<a name="l00762"></a>00762     clust &lt;&lt;= 16;
<a name="l00763"></a>00763     clust |= dent-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a>;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765     <span class="comment">/* The data area starts at cluster 2. With empty files the first cluster </span>
<a name="l00766"></a>00766 <span class="comment">       is set to zero. A value of one is suspicious and will be ignored. */</span>
<a name="l00767"></a>00767     <span class="keywordflow">if</span> (clust &gt;= 2) {
<a name="l00768"></a>00768         <span class="comment">/* Call the format specific release routine. */</span>
<a name="l00769"></a>00769         <span class="keywordflow">if</span> (vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#03b433b1cddedb1a271d8859286e90c9" title="Type of volume.">vol_type</a> == 32) {
<a name="l00770"></a>00770             rc = <a class="code" href="group__xg_phat32.html#gfe7a32b7baf78a8d2c02779139b38ef4" title="Release a cluster chain.">Phat32ReleaseChain</a>(dev, clust);
<a name="l00771"></a>00771         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#03b433b1cddedb1a271d8859286e90c9" title="Type of volume.">vol_type</a> == 16) {
<a name="l00772"></a>00772             rc = <a class="code" href="group__xg_phat16.html#g678e3c870d78566a8b6363a7e8141774" title="Release a cluster chain.">Phat16ReleaseChain</a>(dev, clust);
<a name="l00773"></a>00773         } <span class="keywordflow">else</span> {
<a name="l00774"></a>00774             rc = <a class="code" href="group__xg_phat12.html#g7078825413937c6d1be9474eef18c6bd" title="Release a cluster chain.">Phat12ReleaseChain</a>(dev, clust);
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777     <span class="keywordflow">return</span> rc;
<a name="l00778"></a>00778 }
<a name="l00779"></a>00779 
<a name="l00791"></a><a class="code" href="group__xg_phat_dir.html#gfa9fbc7d8e3cfc1b90bd2dda1ea2ab3a">00791</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#gfa9fbc7d8e3cfc1b90bd2dda1ea2ab3a" title="Remove a directory entry.">PhatDirDelEntry</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> flags)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793     <span class="keywordtype">int</span> rc = -1;
<a name="l00794"></a>00794     <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> *srch;
<a name="l00795"></a>00795     NUTFILE *ndp;
<a name="l00796"></a>00796     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *fname;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="comment">/* Open the parent directory. */</span>
<a name="l00799"></a>00799     <span class="keywordflow">if</span> ((ndp = <a class="code" href="group__xg_phat_dir.html#gc1b0cbea3eb7b9842608e06564066525" title="Open parent directory of a given path.">PhatDirOpenParent</a>(dev, path, &amp;fname)) != <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l00800"></a>00800         <span class="keywordflow">if</span> ((srch = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a>))) != NULL) {
<a name="l00801"></a>00801             <span class="comment">/* Find the specified file name. */</span>
<a name="l00802"></a>00802             <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076" title="Find a directory entry with a specified name.">PhatDirEntryFind</a>(ndp, fname, flags, srch) == 0) {
<a name="l00803"></a>00803                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_dir.html#g054a857b1c7c295c44d306823cbb505f" title="Release a cluster chain of a specified directory entry.">PhatDirReleaseChain</a>(dev, &amp;srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>) == 0) {
<a name="l00804"></a>00804                     rc = PhatDirEntryRelease(ndp, srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#aa17c8a960f0b7e9f9f81f5e6df2e0cf">phfind_pos</a>, srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#e6457f051c46afe3ec3088be6cf31e28">phfind_xcnt</a>);
<a name="l00805"></a>00805                 }
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807             <span class="keywordflow">else</span> {
<a name="l00808"></a>00808                 <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>;
<a name="l00809"></a>00809             }
<a name="l00810"></a>00810             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(srch);
<a name="l00811"></a>00811         }
<a name="l00812"></a>00812         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814     <span class="keywordflow">return</span> rc;
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00825"></a><a class="code" href="group__xg_phat_dir.html#g76c33dbcfa5ac6188e054409429f5333">00825</a> NUTFILE *<a class="code" href="group__xg_phat_dir.html#g76c33dbcfa5ac6188e054409429f5333" title="Open a directory.">PhatDirOpen</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *dpath)
<a name="l00826"></a>00826 {
<a name="l00827"></a>00827     NUTFILE *ndp;
<a name="l00828"></a>00828     <a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *dfcb;
<a name="l00829"></a>00829     <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> *srch;
<a name="l00830"></a>00830     <span class="keywordtype">char</span> *comp;
<a name="l00831"></a>00831     <span class="keywordtype">char</span> *cp;
<a name="l00832"></a>00832     <span class="keywordtype">int</span> sz;
<a name="l00833"></a>00833     <a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *vol = (<a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *) dev-&gt;dev_dcb;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     <span class="comment">/* Make sure the volume is mounted. */</span>
<a name="l00836"></a>00836     if (vol == NULL) {
<a name="l00837"></a>00837         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#b9b8cc17d1947160d13faaba7a18d6d1">ENODEV</a>;
<a name="l00838"></a>00838         <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840 
<a name="l00841"></a>00841     <span class="comment">/* Allocate the structure to return. */</span>
<a name="l00842"></a>00842     <span class="keywordflow">if</span> ((ndp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(NUTFILE))) == NULL) {
<a name="l00843"></a>00843         <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845     <span class="keywordflow">if</span> ((ndp-&gt;nf_fcb = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a>))) == NULL) {
<a name="l00846"></a>00846         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ndp);
<a name="l00847"></a>00847         <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00848"></a>00848     }
<a name="l00849"></a>00849     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(ndp-&gt;nf_fcb, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a>));
<a name="l00850"></a>00850     ndp-&gt;nf_next = NULL;
<a name="l00851"></a>00851     ndp-&gt;nf_dev = dev;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853     dfcb = ndp-&gt;nf_fcb;
<a name="l00854"></a>00854     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> = <a class="code" href="group__xg_phat_fs.html#g21f87cae5e2116503bf4468583ded14d">PHAT_FATTR_DIR</a>;
<a name="l00855"></a>00855     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#0dd88227230f95976d5c75628e46685b" title="File open mode flags.">f_mode</a> = <a class="code" href="group__xg_crt_lowio.html#g4d457d93039cb26f27461c4af5868309">_O_RDONLY</a>;
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="comment">/* We start at the root directory. */</span>
<a name="l00858"></a>00858     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#2b6848ce67e18168e3ca245ac0bcd9ad" title="Current cluster.">f_clust</a> = vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a>;
<a name="l00859"></a>00859     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a> = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) (vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a> &gt;&gt; 16);
<a name="l00860"></a>00860     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a> = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a>;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     if (*dpath == <span class="charliteral">'/'</span>) {
<a name="l00863"></a>00863         dpath++;
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865     <span class="keywordflow">if</span> (*dpath) {
<a name="l00866"></a>00866         <span class="comment">/*</span>
<a name="l00867"></a>00867 <span class="comment">         * We are looking for a subdirectory.</span>
<a name="l00868"></a>00868 <span class="comment">         */</span>
<a name="l00869"></a>00869         <span class="keywordflow">if</span> ((comp = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="group__xg_phat_dir.html#g108a48447b91028faf4329a6f0f4e7da" title="Maximum length of a base file name.">PHAT_MAX_NAMELEN</a> + 1)) == NULL) {
<a name="l00870"></a>00870             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dfcb);
<a name="l00871"></a>00871             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ndp);
<a name="l00872"></a>00872             <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874         <span class="keywordflow">if</span> ((srch = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a>))) == NULL) {
<a name="l00875"></a>00875             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(comp);
<a name="l00876"></a>00876             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dfcb);
<a name="l00877"></a>00877             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ndp);
<a name="l00878"></a>00878             <span class="keywordflow">return</span> <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881         <span class="comment">/*</span>
<a name="l00882"></a>00882 <span class="comment">         * Walk down the path.</span>
<a name="l00883"></a>00883 <span class="comment">         */</span>
<a name="l00884"></a>00884         <span class="keywordflow">while</span> (*dpath) {
<a name="l00885"></a>00885             <span class="comment">/* Fetch the next component from the path. */</span>
<a name="l00886"></a>00886             cp = comp;
<a name="l00887"></a>00887             sz = 0;
<a name="l00888"></a>00888             <span class="keywordflow">while</span> (*dpath) {
<a name="l00889"></a>00889                 <span class="keywordflow">if</span> (*dpath == <span class="charliteral">'/'</span>) {
<a name="l00890"></a>00890                     dpath++;
<a name="l00891"></a>00891                     <span class="keywordflow">break</span>;
<a name="l00892"></a>00892                 }
<a name="l00893"></a>00893                 <span class="keywordflow">if</span> (++sz &gt; <a class="code" href="group__xg_phat_dir.html#g108a48447b91028faf4329a6f0f4e7da" title="Maximum length of a base file name.">PHAT_MAX_NAMELEN</a>) {
<a name="l00894"></a>00894                     <span class="keywordflow">break</span>;
<a name="l00895"></a>00895                 }
<a name="l00896"></a>00896                 *cp++ = *dpath++;
<a name="l00897"></a>00897             }
<a name="l00898"></a>00898             *cp = 0;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900             <span class="comment">/* Search component's entry in the current directory. */</span>
<a name="l00901"></a>00901             <span class="keywordflow">if</span> (sz &gt; <a class="code" href="group__xg_phat_dir.html#g108a48447b91028faf4329a6f0f4e7da" title="Maximum length of a base file name.">PHAT_MAX_NAMELEN</a> || <a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076" title="Find a directory entry with a specified name.">PhatDirEntryFind</a>(ndp, comp, <a class="code" href="group__xg_phat_fs.html#ge68316b37a26a8da9f9035d9b9ba57bc">PHAT_FATTR_FILEMASK</a>, srch)) {
<a name="l00902"></a>00902                 <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#03e689f378f643d16ea7537918528a48">ENOENT</a>;
<a name="l00903"></a>00903                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(dfcb);
<a name="l00904"></a>00904                 <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(ndp);
<a name="l00905"></a>00905                 ndp = <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>;
<a name="l00906"></a>00906                 <span class="keywordflow">break</span>;
<a name="l00907"></a>00907             }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909             <span class="comment">/*</span>
<a name="l00910"></a>00910 <span class="comment">             * Next component found. Mimic the open by updating the existing</span>
<a name="l00911"></a>00911 <span class="comment">             * file control block structure.</span>
<a name="l00912"></a>00912 <span class="comment">             */</span>
<a name="l00913"></a>00913             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#c61b77c618ab5bcf6664e06c1ffbb5ab" title="Sector of the directory entry.">f_de_sect</a> = <a class="code" href="group__xg_phat_vol.html#gaf0b8da0234a73af6a22e011bf39a116">PhatClusterSector</a>(ndp, dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#2b6848ce67e18168e3ca245ac0bcd9ad" title="Current cluster.">f_clust</a>) + dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#db93a681fa7a2e5fb426baf9ec899930" title="Sector within the current cluster.">f_clust_pos</a>;
<a name="l00914"></a>00914             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#073bea476c9b413f81fe4f7fb5fe504a" title="Offset into the sector containing the directory entry.">f_de_offs</a> = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#363edb9f52f88b4b4b1ffc5bfcabb023" title="Position within the sector.">f_sect_pos</a> - 32;
<a name="l00915"></a>00915 
<a name="l00916"></a>00916             <span class="comment">/* Set the cluster of our directory entry. */</span>
<a name="l00917"></a>00917             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#904bff71475a3e42a175e35994abf064" title="First cluster of the parent directory, high word.">f_pde_clusthi</a> = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a>;
<a name="l00918"></a>00918             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#5bd5799b458105fd235fb7f767386f11" title="First cluster of the parent directory, low word.">f_pde_clust</a> = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a>;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a> = srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>;
<a name="l00921"></a>00921 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00922"></a>00922 <span class="preprocessor"></span>            <a class="code" href="group__xg_phat_dbg.html#g8b498add6cde6ee3e88711e4cb3a5a9b">PhatDbgFileInfo</a>(<a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>, <span class="stringliteral">"Component"</span>, dfcb);
<a name="l00923"></a>00923 <span class="preprocessor">#endif</span>
<a name="l00924"></a>00924 <span class="preprocessor"></span>
<a name="l00925"></a>00925             <span class="comment">/*</span>
<a name="l00926"></a>00926 <span class="comment">             * Handle root directory.</span>
<a name="l00927"></a>00927 <span class="comment">             */</span>
<a name="l00928"></a>00928             <span class="keywordflow">if</span> (dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> &amp; <a class="code" href="group__xg_phat_fs.html#g21f87cae5e2116503bf4468583ded14d">PHAT_FATTR_DIR</a>) {
<a name="l00929"></a>00929                 <span class="keywordflow">if</span> (dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a> == 0 &amp;&amp; dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a> == 0) {
<a name="l00930"></a>00930                     <span class="keywordflow">if</span> (vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#03b433b1cddedb1a271d8859286e90c9" title="Type of volume.">vol_type</a> != 32) {
<a name="l00931"></a>00931                         dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#c61b77c618ab5bcf6664e06c1ffbb5ab" title="Sector of the directory entry.">f_de_sect</a> = 0;
<a name="l00932"></a>00932                     }
<a name="l00933"></a>00933                     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a> = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) (vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a> &gt;&gt; 16);
<a name="l00934"></a>00934                     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a> = (<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a>;
<a name="l00935"></a>00935                 }
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937 
<a name="l00938"></a>00938             <span class="comment">/*</span>
<a name="l00939"></a>00939 <span class="comment">             * Reset position.</span>
<a name="l00940"></a>00940 <span class="comment">             */</span>
<a name="l00941"></a>00941             <a class="code" href="group__xg_phat_util.html#g3ac06e687a0ad471beaf7a25a48730f0" title="Set file pointer back to zero.">PhatFilePosRewind</a>(dfcb);
<a name="l00942"></a>00942             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#8f3aced25f25c2cbc1b61ad8efd33980" title="Previous cluster used,.">f_clust_prv</a> = 0;
<a name="l00943"></a>00943             dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#0dd88227230f95976d5c75628e46685b" title="File open mode flags.">f_mode</a> = <a class="code" href="group__xg_crt_lowio.html#g4d457d93039cb26f27461c4af5868309">_O_RDONLY</a>;
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(srch);
<a name="l00946"></a>00946         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(comp);
<a name="l00947"></a>00947     }
<a name="l00948"></a>00948     <span class="keywordflow">return</span> ndp;
<a name="l00949"></a>00949 }
<a name="l00950"></a>00950 
<a name="l00958"></a><a class="code" href="group__xg_phat_dir.html#g9ee97fcc03ddf2f8c6a985f328748fe3">00958</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#g9ee97fcc03ddf2f8c6a985f328748fe3" title="Read the next directory entry.">PhatDirRead</a>(<a class="code" href="struct_d_i_r.html" title="Internally used directory information structure.">DIR</a> * dir)
<a name="l00959"></a>00959 {
<a name="l00960"></a>00960     <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> *srch;
<a name="l00961"></a>00961     <span class="keyword">struct </span><a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a> *ent;
<a name="l00962"></a>00962 
<a name="l00963"></a>00963     <span class="keywordflow">if</span> ((srch = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a>))) == NULL) {
<a name="l00964"></a>00964         <span class="keywordflow">return</span> -1;
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (PhatDirEntryRead(dir-&gt;<a class="code" href="struct_d_i_r.html#8f92a67a0adbd4bd5b6c2dfd38838933" title="File descriptor associated with directory.">dd_fd</a>, srch)) {
<a name="l00967"></a>00967         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(srch);
<a name="l00968"></a>00968         <span class="keywordflow">return</span> -1;
<a name="l00969"></a>00969     }
<a name="l00970"></a>00970 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00971"></a>00971 <span class="preprocessor"></span>    <a class="code" href="group__xg_phat_dbg.html#g5f85cf69cb129bf2cb5e1eef197e4446">PhatDbgDirEntry</a>(<a class="code" href="group__xg_crt_stdio.html#g0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>, <span class="stringliteral">"Read entry"</span>, &amp;srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>);
<a name="l00972"></a>00972 <span class="preprocessor">#endif</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>
<a name="l00974"></a>00974     ent = (<span class="keyword">struct </span><a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a> *) dir-&gt;<a class="code" href="struct_d_i_r.html#f36e05d988a827346a3d2d8b98225131" title="Data buffer.">dd_buf</a>;
<a name="l00975"></a>00975     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(dir-&gt;<a class="code" href="struct_d_i_r.html#f36e05d988a827346a3d2d8b98225131" title="Data buffer.">dd_buf</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a>));
<a name="l00976"></a>00976     ent-&gt;<a class="code" href="structdirent.html#99c6f10c9d89ed5cb752dc01d0a2daf0" title="Length of string in d_name.">d_namlen</a> = (<a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <a class="code" href="group__xg_crt_string.html#g7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#88d0acb3d534c60275a4ec98cf99541e">phfind_name</a>);
<a name="l00977"></a>00977     <a class="code" href="group__xg_crt_string.html#g5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(ent-&gt;<a class="code" href="structdirent.html#d2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>, srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#88d0acb3d534c60275a4ec98cf99541e">phfind_name</a>);
<a name="l00978"></a>00978     <span class="keywordflow">if</span> (srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> &amp; <a class="code" href="group__xg_phat_fs.html#g21f87cae5e2116503bf4468583ded14d">PHAT_FATTR_DIR</a>) {
<a name="l00979"></a>00979         ent-&gt;<a class="code" href="structdirent.html#948760e3b7f607213a19f85e7af15a32" title="File type, 0=regular, 1=directory.">d_type</a> = 1;
<a name="l00980"></a>00980     }
<a name="l00981"></a>00981     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(srch);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="keywordflow">return</span> 0;
<a name="l00984"></a>00984 }
<a name="l00985"></a>00985 
<a name="l00997"></a><a class="code" href="group__xg_phat_dir.html#g3c08e9c174b2af4d6cf5736c6c3489dd">00997</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#g3c08e9c174b2af4d6cf5736c6c3489dd" title="Create a new subdirectory.">PhatDirCreate</a>(NUTDEVICE * dev, <span class="keywordtype">char</span> *path)
<a name="l00998"></a>00998 {
<a name="l00999"></a>00999     NUTFILE *ndp;
<a name="l01000"></a>01000     <a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *vol = (<a class="code" href="struct_p_h_a_t_v_o_l.html" title="Volume info structure.">PHATVOL</a> *) dev-&gt;dev_dcb;
<a name="l01001"></a>01001     <a class="code" href="struct_p_h_a_t_f_i_l_e.html" title="PHAT file descriptor structure.">PHATFILE</a> *dfcb;
<a name="l01002"></a>01002     <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> *entry;
<a name="l01003"></a>01003     <a class="code" href="stdint_8h.html#ba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *buf;
<a name="l01004"></a>01004     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> sect;
<a name="l01005"></a>01005     <a class="code" href="stdint_8h.html#06896e8c53f721507066c079052171f8">uint32_t</a> clust;
<a name="l01006"></a>01006 
<a name="l01007"></a>01007     <span class="comment">/*</span>
<a name="l01008"></a>01008 <span class="comment">     * Create the new directory like a normal file with a special attribute.</span>
<a name="l01009"></a>01009 <span class="comment">     */</span>
<a name="l01010"></a>01010     if ((ndp = <a class="code" href="group__xg_phat_fs.html#ga464e4dad8c05b0248d32c11488e9342" title="Open a file.">PhatFileOpen</a>(dev, path, <a class="code" href="group__xg_crt_lowio.html#g774664d26ae1b1d55902562af5f1ec28">_O_CREAT</a> | <a class="code" href="group__xg_crt_lowio.html#g010187fb7398870cb57af650e65bded1">_O_RDWR</a> | <a class="code" href="group__xg_crt_lowio.html#g87ebc39a5c9c3505fe9cb094ef40c838">_O_EXCL</a>, <a class="code" href="group__xg_phat_fs.html#g21f87cae5e2116503bf4468583ded14d">PHAT_FATTR_DIR</a>)) == <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l01011"></a>01011         <span class="keywordflow">return</span> -1;
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013     dfcb = ndp-&gt;nf_fcb;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="comment">/*</span>
<a name="l01016"></a>01016 <span class="comment">     * Allocate a first cluster and initialize it with zeros.</span>
<a name="l01017"></a>01017 <span class="comment">     */</span>
<a name="l01018"></a>01018     <span class="keywordflow">if</span> ((clust = <a class="code" href="group__xg_phat_fs.html#g5c475eac7203c35965ad03a7e672e002" title="Allocate the first cluster of a file.">AllocFirstCluster</a>(ndp)) &lt; 2) {
<a name="l01019"></a>01019         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01020"></a>01020         <span class="keywordflow">return</span> -1;
<a name="l01021"></a>01021     }
<a name="l01022"></a>01022     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#8f3aced25f25c2cbc1b61ad8efd33980" title="Previous cluster used,.">f_clust_prv</a> = clust;
<a name="l01023"></a>01023     dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#2b6848ce67e18168e3ca245ac0bcd9ad" title="Current cluster.">f_clust</a> = clust;
<a name="l01024"></a>01024     <span class="keywordflow">if</span> ((buf = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#fdc954c2e8cbdf751299576d2b49a402" title="Bytes per sector.">vol_sectsz</a>)) == NULL) {
<a name="l01025"></a>01025         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01026"></a>01026         <span class="keywordflow">return</span> -1;
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(buf, 0, vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#fdc954c2e8cbdf751299576d2b49a402" title="Bytes per sector.">vol_sectsz</a>);
<a name="l01029"></a>01029     <span class="keywordflow">for</span> (sect = vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#97c3a93b08c83b1605b4e58b79b8dfa2" title="Sectors per cluster.">vol_clustsz</a>; sect; sect--) {
<a name="l01030"></a>01030         <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, buf, vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#fdc954c2e8cbdf751299576d2b49a402" title="Bytes per sector.">vol_sectsz</a>) &lt; 0) {
<a name="l01031"></a>01031             <span class="comment">/* Write failed. */</span>
<a name="l01032"></a>01032             <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(buf);
<a name="l01033"></a>01033             <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01034"></a>01034             <span class="keywordflow">return</span> -1;
<a name="l01035"></a>01035         }
<a name="l01036"></a>01036     }
<a name="l01037"></a>01037     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(buf);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="comment">/*</span>
<a name="l01040"></a>01040 <span class="comment">     * Write the dot entry.</span>
<a name="l01041"></a>01041 <span class="comment">     */</span>
<a name="l01042"></a>01042     entry = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>));
<a name="l01043"></a>01043     *entry = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#6c5215b16e7fa953cc2b414cb4ff0259" title="Directory entry of this file.">f_dirent</a>;
<a name="l01044"></a>01044     <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>, <span class="charliteral">' '</span>, <span class="keyword">sizeof</span>(entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>));
<a name="l01045"></a>01045     entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] = <span class="charliteral">'.'</span>;
<a name="l01046"></a>01046     <a class="code" href="group__xg_phat_util.html#g3ac06e687a0ad471beaf7a25a48730f0" title="Set file pointer back to zero.">PhatFilePosRewind</a>(dfcb);
<a name="l01047"></a>01047     <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, entry, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) {
<a name="l01048"></a>01048         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01049"></a>01049         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(entry);
<a name="l01050"></a>01050         <span class="keywordflow">return</span> -1;
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="comment">/*</span>
<a name="l01054"></a>01054 <span class="comment">     * Write the double dot entry. If it points to the root cluster,</span>
<a name="l01055"></a>01055 <span class="comment">     * then the cluster number in the directory entry must be zero.</span>
<a name="l01056"></a>01056 <span class="comment">     */</span>
<a name="l01057"></a>01057     <span class="keywordflow">if</span> ((<a class="code" href="stdint_8h.html#1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a> == dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#5bd5799b458105fd235fb7f767386f11" title="First cluster of the parent directory, low word.">f_pde_clust</a> &amp;&amp;   <span class="comment">/* */</span>
<a name="l01058"></a>01058         vol-&gt;<a class="code" href="struct_p_h_a_t_v_o_l.html#18bea1658e388e92223c6a80e458d1f6" title="First cluster of the root directory.">vol_root_clust</a> &gt;&gt; 16 == dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#904bff71475a3e42a175e35994abf064" title="First cluster of the parent directory, high word.">f_pde_clusthi</a>) {
<a name="l01059"></a>01059         entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a> = 0;
<a name="l01060"></a>01060         entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a> = 0;
<a name="l01061"></a>01061     } <span class="keywordflow">else</span> {
<a name="l01062"></a>01062         entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#0219ee440326be566a2fda4f221ef0de" title="First cluster used.">dent_clust</a> = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#5bd5799b458105fd235fb7f767386f11" title="First cluster of the parent directory, low word.">f_pde_clust</a>;
<a name="l01063"></a>01063         entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#068d0a1c3ced6c50f70571d47f6b8c54" title="High bytes of first cluster of this file.">dent_clusthi</a> = dfcb-&gt;<a class="code" href="struct_p_h_a_t_f_i_l_e.html#904bff71475a3e42a175e35994abf064" title="First cluster of the parent directory, high word.">f_pde_clusthi</a>;
<a name="l01064"></a>01064     }
<a name="l01065"></a>01065     entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[1] = <span class="charliteral">'.'</span>;
<a name="l01066"></a>01066     <span class="keywordflow">if</span> (<a class="code" href="group__xg_phat_fs.html#g120618f0cddfec33499e65550565500c" title="Write data to a file.">PhatFileWrite</a>(ndp, entry, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>)) {
<a name="l01067"></a>01067         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01068"></a>01068         <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(entry);
<a name="l01069"></a>01069         <span class="keywordflow">return</span> -1;
<a name="l01070"></a>01070     }
<a name="l01071"></a>01071     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(entry);
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="keywordflow">return</span> <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 
<a name="l01084"></a><a class="code" href="group__xg_phat_dir.html#gbb854d6cc74fd1ca3e766b0d199c2333">01084</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#gbb854d6cc74fd1ca3e766b0d199c2333" title="Remove a specified subdirectory.">PhatDirRemove</a>(NUTDEVICE * dev, <span class="keywordtype">char</span> *path)
<a name="l01085"></a>01085 {
<a name="l01086"></a>01086     <span class="keywordtype">int</span> rc = -1;
<a name="l01087"></a>01087     <a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a> *entry;
<a name="l01088"></a>01088     NUTFILE *ndp;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <span class="comment">/* Never remove the root directory */</span>
<a name="l01091"></a>01091     <span class="keywordflow">if</span> (path[0] == <span class="charliteral">'/'</span> &amp;&amp; path[1] == 0) {
<a name="l01092"></a>01092         <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#8368025077a0385849d6817b2007c095">EBUSY</a>;
<a name="l01093"></a>01093         <span class="keywordflow">return</span> -1;
<a name="l01094"></a>01094     }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keywordflow">if</span> ((entry = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>))) == NULL) {
<a name="l01097"></a>01097         <span class="keywordflow">return</span> -1;
<a name="l01098"></a>01098     }
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     <span class="comment">/*</span>
<a name="l01101"></a>01101 <span class="comment">     * Make sure, that the directory we want to remove is empty. The dot </span>
<a name="l01102"></a>01102 <span class="comment">     * and double dot entries are ignored.</span>
<a name="l01103"></a>01103 <span class="comment">     */</span>
<a name="l01104"></a>01104     <span class="keywordflow">if</span> ((ndp = <a class="code" href="group__xg_phat_fs.html#ga464e4dad8c05b0248d32c11488e9342" title="Open a file.">PhatFileOpen</a>(dev, path, <a class="code" href="group__xg_crt_lowio.html#g4d457d93039cb26f27461c4af5868309">_O_RDONLY</a>, 0)) != <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l01105"></a>01105         rc = 0;
<a name="l01106"></a>01106         <span class="keywordflow">for</span> (;;) {
<a name="l01107"></a>01107             rc = <a class="code" href="group__xg_phat_fs.html#g8ca25466d168febccd7d82c6d6412281" title="Read data from a file.">PhatFileRead</a>(ndp, entry, <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>));
<a name="l01108"></a>01108             <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01109"></a>01109                 <span class="keywordflow">break</span>;
<a name="l01110"></a>01110             }
<a name="l01111"></a>01111             <span class="comment">/* Check for end of directory. */</span>
<a name="l01112"></a>01112             <span class="keywordflow">if</span> (rc &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html" title="Structure of a directory entry.">PHATDIRENT</a>) || entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] == 0) {
<a name="l01113"></a>01113                 rc = 0;
<a name="l01114"></a>01114                 <span class="keywordflow">break</span>;
<a name="l01115"></a>01115             }
<a name="l01116"></a>01116             <span class="comment">/* Skip removed entries. */</span>
<a name="l01117"></a>01117             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] == <a class="code" href="group__xg_phat_dir.html#g37e0fa01713a0cd842b8da950338b808">PHAT_REM_DIRENT</a>) {
<a name="l01118"></a>01118                 <span class="keywordflow">continue</span>;
<a name="l01119"></a>01119             }
<a name="l01120"></a>01120             <span class="comment">/* Ignore entries which are not files. */</span>
<a name="l01121"></a>01121             <span class="keywordflow">if</span> ((entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> | <a class="code" href="group__xg_phat_fs.html#ge68316b37a26a8da9f9035d9b9ba57bc">PHAT_FATTR_FILEMASK</a>) != <a class="code" href="group__xg_phat_fs.html#ge68316b37a26a8da9f9035d9b9ba57bc">PHAT_FATTR_FILEMASK</a>) {
<a name="l01122"></a>01122                 <span class="keywordflow">continue</span>;
<a name="l01123"></a>01123             }
<a name="l01124"></a>01124             <span class="comment">/* Ignore dot and double dot entries. */</span>
<a name="l01125"></a>01125             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[0] == <span class="charliteral">'.'</span> &amp;&amp;   <span class="comment">/* */</span>
<a name="l01126"></a>01126                 (entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[1] == <span class="charliteral">'.'</span> || entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[1] == <span class="charliteral">' '</span>)) {
<a name="l01127"></a>01127                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#g135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(<span class="stringliteral">"         "</span>, &amp;entry-&gt;<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#4406e54d4732c5051a9f00e926c97970" title="File name, padded with blanks.">dent_name</a>[2], 9) == 0) {
<a name="l01128"></a>01128                     <span class="keywordflow">continue</span>;
<a name="l01129"></a>01129                 }
<a name="l01130"></a>01130             }
<a name="l01131"></a>01131             <a class="code" href="errno_8h.html#d65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="errno_8h.html#a0f602f3fd369a6fede82190710b9c5c">ENOTEMPTY</a>;
<a name="l01132"></a>01132             rc = -1;
<a name="l01133"></a>01133             <span class="keywordflow">break</span>;
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01136"></a>01136     }
<a name="l01137"></a>01137     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(entry);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     <span class="comment">/* If the empty check was successful, then remove the entry. */</span>
<a name="l01140"></a>01140     <span class="keywordflow">if</span> (rc == 0) {
<a name="l01141"></a>01141         rc = <a class="code" href="group__xg_phat_dir.html#gfa9fbc7d8e3cfc1b90bd2dda1ea2ab3a" title="Remove a directory entry.">PhatDirDelEntry</a>(dev, path, <a class="code" href="group__xg_phat_fs.html#g21f87cae5e2116503bf4468583ded14d">PHAT_FATTR_DIR</a>);
<a name="l01142"></a>01142     }
<a name="l01143"></a>01143     <span class="keywordflow">return</span> rc;
<a name="l01144"></a>01144 }
<a name="l01145"></a>01145 
<a name="l01155"></a><a class="code" href="group__xg_phat_dir.html#g94c6770a6af26dca8b08bcee13502913">01155</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_phat_dir.html#g94c6770a6af26dca8b08bcee13502913" title="Retrieve status of a specified file.">PhatDirEntryStatus</a>(NUTDEVICE * dev, <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path, <span class="keyword">struct</span> <a class="code" href="structstat.html" title="File status structure.">stat</a> *stp)
<a name="l01156"></a>01156 {
<a name="l01157"></a>01157     <span class="keywordtype">int</span> rc;
<a name="l01158"></a>01158     <a class="code" href="arm_8h.html#0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *fname;
<a name="l01159"></a>01159     NUTFILE *ndp;
<a name="l01160"></a>01160     <a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a> *srch;
<a name="l01161"></a>01161     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <span class="comment">/* Open parent directory. */</span>
<a name="l01164"></a>01164     <span class="keywordflow">if</span> ((ndp = <a class="code" href="group__xg_phat_dir.html#gc1b0cbea3eb7b9842608e06564066525" title="Open parent directory of a given path.">PhatDirOpenParent</a>(dev, path, &amp;fname)) == <a class="code" href="group__xg_device.html#g40f0743f7e612c96b4fb57e7696da6a0">NUTFILE_EOF</a>) {
<a name="l01165"></a>01165         <span class="keywordflow">return</span> -1;
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     <span class="keywordflow">if</span> ((srch = <a class="code" href="icc_8h.html#cf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_p_h_a_t_f_i_n_d.html">PHATFIND</a>))) == NULL) {
<a name="l01169"></a>01169         <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01170"></a>01170         <span class="keywordflow">return</span> -1;
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172     <span class="keywordflow">if</span> ((rc = <a class="code" href="group__xg_phat_dir.html#gc54c4da3eb7a99e9839d835f75633076" title="Find a directory entry with a specified name.">PhatDirEntryFind</a>(ndp, fname, <a class="code" href="group__xg_phat_fs.html#ge68316b37a26a8da9f9035d9b9ba57bc">PHAT_FATTR_FILEMASK</a>, srch)) == 0) {
<a name="l01173"></a>01173         <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> t;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175         <a class="code" href="group__xg_crt_string.html#ga4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(&amp;t, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a>));
<a name="l01176"></a>01176         val = srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#fe8a17c11dff1e97623c7a234cf503d1" title="Last file modification time.">dent_mtime</a>;
<a name="l01177"></a>01177         t.<a class="code" href="struct__tm.html#4d098a9a5c03a00b2ee61e10851de81e" title="seconds after the minute - [0,59]">tm_sec</a> = (val &amp; 0x1F) &lt;&lt; 1;
<a name="l01178"></a>01178         t.<a class="code" href="struct__tm.html#f414eb7c86cc3099595211eee4d4211b" title="minutes after the hour - [0,59]">tm_min</a> = (val &gt;&gt; 5) &amp; 0x3F;
<a name="l01179"></a>01179         t.<a class="code" href="struct__tm.html#3e7ca4e37f1abcaf56b8a916c38eb9fe" title="hours since midnight - [0,23]">tm_hour</a> = (val &gt;&gt; 11) &amp; 0x1F;
<a name="l01180"></a>01180         val = srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6355236fa326e27167598953c8fe3997" title="Last file modification date.">dent_mdate</a>;
<a name="l01181"></a>01181         t.<a class="code" href="struct__tm.html#b8d8904bad43b0c8b96e61941c5b5310" title="day of the month - [1,31]">tm_mday</a> = val &amp; 0x1F;
<a name="l01182"></a>01182         t.<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a> = ((val &gt;&gt; 5) &amp; 0x0F);
<a name="l01183"></a>01183         <span class="keywordflow">if</span> (t.<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a>) {
<a name="l01184"></a>01184             t.<a class="code" href="struct__tm.html#112ac36fa2f593777138a417cf031e17" title="months since January - [0,11]">tm_mon</a>--;
<a name="l01185"></a>01185         }
<a name="l01186"></a>01186         t.<a class="code" href="struct__tm.html#33adf78fd6476b2120ce3b9c4a852053" title="years since 1900">tm_year</a> = ((val &gt;&gt; 9) &amp; 0x7F) + 80;
<a name="l01187"></a>01187         t.<a class="code" href="struct__tm.html#5645ca0580c8ab2c24f6c2965d9c9f9c" title="daylight savings time flag">tm_isdst</a> = <a class="code" href="group__xg_crt_time.html#g2bb3d0de4c753758209b935de23f09ae" title="Used to control daylight conversions.">_daylight</a>; 
<a name="l01188"></a>01188         stp-&gt;<a class="code" href="structstat.html#77e235090f8cb6897f1c0ce65689006b" title="Time of last modification.">st_mtime</a> = <a class="code" href="group__xg_crt_time.html#g60ebe794537631d5c944d2580577068a" title="Convert the local time to a calendar value.">mktime</a>(&amp;t);
<a name="l01189"></a>01189 
<a name="l01190"></a>01190         stp-&gt;<a class="code" href="structstat.html#ee916069ac664ab2b8cae1eac0c220b3" title="Block number.">st_ino</a> = 0;
<a name="l01191"></a>01191         stp-&gt;<a class="code" href="structstat.html#2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a> = (srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#6ad520ad1844430f7d94155085269585" title="File attributes.">dent_attr</a> &amp; <a class="code" href="group__xg_phat_fs.html#g21f87cae5e2116503bf4468583ded14d">PHAT_FATTR_DIR</a>) != 0;
<a name="l01192"></a>01192         stp-&gt;<a class="code" href="structstat.html#98b18407739153f9ed5b046c32934e8b" title="Number of links.">st_nlink</a> = 0;
<a name="l01193"></a>01193         stp-&gt;<a class="code" href="structstat.html#8301352421b5d6c322caf909b8e97ae4" title="Size.">st_size</a> = srch-&gt;<a class="code" href="struct_p_h_a_t_f_i_n_d.html#0d934dbceb4aacfc178ee6a9543e866a">phfind_ent</a>.<a class="code" href="struct_p_h_a_t_d_i_r_e_n_t.html#ced2e3a8996e82a3d58c52dc08eea056" title="Size of the file in bytes.">dent_fsize</a>;
<a name="l01194"></a>01194     }
<a name="l01195"></a>01195     <a class="code" href="icc_8h.html#2c6efa7679f8cd9f61af96e105017560">free</a>(srch);
<a name="l01196"></a>01196     <a class="code" href="group__xg_phat_fs.html#g8d1fd9e79e3bb572e6d44877473f3143" title="Close a file.">PhatFileClose</a>(ndp);
<a name="l01197"></a>01197 
<a name="l01198"></a>01198     <span class="keywordflow">return</span> rc;
<a name="l01199"></a>01199 }
<a name="l01200"></a>01200 
</pre></div></div>
<hr>
<address>
  <small>
    &copy;&nbsp;2000-2007 by egnite Software GmbH - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
