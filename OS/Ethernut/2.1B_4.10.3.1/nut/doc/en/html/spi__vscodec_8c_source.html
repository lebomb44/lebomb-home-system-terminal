<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: dev/spi_vscodec.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS
   &#160;<span id="projectnumber">4.10.3</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('spi__vscodec_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">spi_vscodec.c</div>  </div>
</div>
<div class="contents">
<a href="spi__vscodec_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2008-2009 by egnite GmbH</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (C) 2001-2007 by egnite Software GmbH</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * All rights reserved.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00008"></a>00008 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00009"></a>00009 <span class="comment"> * are met:</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00012"></a>00012 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00013"></a>00013 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00014"></a>00014 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00015"></a>00015 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00016"></a>00016 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00017"></a>00017 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00018"></a>00018 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00019"></a>00019 <span class="comment"> *</span>
<a name="l00020"></a>00020 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00021"></a>00021 <span class="comment"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00022"></a>00022 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00023"></a>00023 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<a name="l00024"></a>00024 <span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00025"></a>00025 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00026"></a>00026 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00027"></a>00027 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00028"></a>00028 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00029"></a>00029 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00030"></a>00030 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00031"></a>00031 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00032"></a>00032 <span class="comment"> *</span>
<a name="l00033"></a>00033 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00034"></a>00034 <span class="comment"> */</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/*</span>
<a name="l00037"></a>00037 <span class="comment"> * $Id: spi_vscodec.c 2702 2009-09-17 11:01:21Z haraldkipp $</span>
<a name="l00038"></a>00038 <span class="comment"> */</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="vscodec_8h.html" title="VLSI decoder definitions.">dev/vscodec.h</a>&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="nutdebug_8h.html">sys/nutdebug.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="sys_2bankmem_8h.html" title="Banked memory management definitions.">sys/bankmem.h</a>&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<a name="l00051"></a>00051 
<a name="l00056"></a>00056 
<a name="l00060"></a><a class="code" href="group__xg_vs_codec.html#gaa9148051010a1172434c8680307df41f">00060</a> <span class="preprocessor">#define VSREQ_PLAY      0x00000001</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a><a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47">00062</a> <span class="preprocessor">#define VSREQ_CANCEL    0x00000002</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="group__xg_vs_codec.html#ga7630d64fba7e157d1153e8c33794193f">00064</a> <span class="preprocessor">#define VSREQ_VOLUPD    0x00000004</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a><a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766">00066</a> <span class="preprocessor">#define VSREQ_AUDIOE    0x00000008</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>
<a name="l00068"></a><a class="code" href="group__xg_vs_codec.html#ga7f0e0b6f52a30c87fb9e161b5ef58c9b">00068</a> <span class="preprocessor">#define VSREQ_BEEP      0x00000010</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a><a class="code" href="group__xg_vs_codec.html#ga246288d78f86589c4513b34006205fa3">00070</a> <span class="preprocessor">#define VSREQ_RECORD    0x00000020</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00074"></a>00074 <span class="comment">/* Used to send zeros to the decoder. */</span>
<a name="l00075"></a><a class="code" href="group__xg_vs_codec.html#gaaaac16fe0ab58fb35e2a5debe1f4e35a">00075</a> <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="group__xg_vs_codec.html#gaaaac16fe0ab58fb35e2a5debe1f4e35a">zero_chunk</a>[<a class="code" href="group__xg_vs_codec.html#gaf21682ff6c6b9a4540908e3e05994bd2" title="Number of data bytes we can send without checking DREQ.">VSCODEC_DATA_CHUNK_SIZE</a>];
<a name="l00076"></a>00076 
<a name="l00085"></a><a class="code" href="group__xg_vs_codec.html#ga5b4989c20b35f2410102ffcc4fae38f7">00085</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga5b4989c20b35f2410102ffcc4fae38f7" title="Wait until codec is ready.">VsCodecWaitReady</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tmo)
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *) dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     while (!(* dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#ac55564ad82b6df053e3b2019f9ec9514">dcb_isready</a>)()) {
<a name="l00090"></a>00090         <span class="keywordflow">if</span> (<a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>, tmo)) {
<a name="l00091"></a>00091             <span class="keywordflow">return</span> -1;
<a name="l00092"></a>00092         }
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094     <span class="keywordflow">return</span> 0;
<a name="l00095"></a>00095 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="comment">/*</span>
<a name="l00098"></a>00098 <span class="comment"> * \brief Read from or write to a VLSI audio codec register.</span>
<a name="l00099"></a>00099 <span class="comment"> *</span>
<a name="l00100"></a>00100 <span class="comment"> * \param dev  Specifies the codec device.</span>
<a name="l00101"></a>00101 <span class="comment"> * \param op   Operation, either \ref VS_OPCODE_READ or</span>
<a name="l00102"></a>00102 <span class="comment"> *             \ref VS_OPCODE_WRITE.</span>
<a name="l00103"></a>00103 <span class="comment"> * \param reg  The register index.</span>
<a name="l00104"></a>00104 <span class="comment"> * \param val  This value will be stored in the register on a write</span>
<a name="l00105"></a>00105 <span class="comment"> *             operation. It is ignored on read operations.</span>
<a name="l00106"></a>00106 <span class="comment"> *</span>
<a name="l00107"></a>00107 <span class="comment"> * \return Register contents. On write operations, the contents before</span>
<a name="l00108"></a>00108 <span class="comment"> *         the modification is returned.</span>
<a name="l00109"></a>00109 <span class="comment"> */</span>
<a name="l00110"></a><a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">00110</a> <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> op, <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> reg, <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> val)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> cmd[4];
<a name="l00113"></a>00113     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *) dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">/* Assemble command buffer. */</span>
<a name="l00116"></a>00116     cmd[0] = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) op;
<a name="l00117"></a>00117     cmd[1] = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) reg;
<a name="l00118"></a>00118     cmd[2] = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (val &gt;&gt; 8);
<a name="l00119"></a>00119     cmd[3] = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) val;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <a class="code" href="group__xg_vs_codec.html#ga5b4989c20b35f2410102ffcc4fae38f7" title="Wait until codec is ready.">VsCodecWaitReady</a>(dev, <a class="code" href="group__xg_vs_codec.html#ga4be341cd5628148ca64c035b8b150ffe" title="Minimum time in milliseconds to held hardware reset low.">VSCODEC_CMD_TIMEOUT</a>);
<a name="l00122"></a>00122     (*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a595b21492fc0f54493720a5fa9a65bca">dcb_sendcmd</a>)(cmd, 4);
<a name="l00123"></a>00123     val = cmd[2];
<a name="l00124"></a>00124     val &lt;&lt;= 8;
<a name="l00125"></a>00125     val |= cmd[3];
<a name="l00126"></a>00126     <span class="keywordflow">return</span> (<a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) val;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00141"></a><a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206">00141</a> <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> flags, <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> mask)
<a name="l00142"></a>00142 {
<a name="l00143"></a>00143     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> rc;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="comment">/* Read the mode register. */</span>
<a name="l00146"></a>00146     rc = <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#ga0450ad0b8d21faada19079f1c7a65485">VS_OPCODE_READ</a>, <a class="code" href="group__xg_vs1001.html#gaccba6b54e1b7ca88a099e55bf5ebc966">VS_MODE_REG</a>, 0);
<a name="l00147"></a>00147     <span class="keywordflow">if</span> (mask | flags) {
<a name="l00148"></a>00148         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs1001.html#gaccba6b54e1b7ca88a099e55bf5ebc966">VS_MODE_REG</a>, (rc &amp; ~mask) | flags);
<a name="l00149"></a>00149         <span class="comment">/* Add delay after software reset, if configured. */</span>
<a name="l00150"></a>00150 <span class="preprocessor">#if defined(VSCODEC_SWRST_RECOVER)</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>) {
<a name="l00152"></a>00152             <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(VSCODEC_SWRST_RECOVER);
<a name="l00153"></a>00153         }
<a name="l00154"></a>00154 <span class="preprocessor">#endif</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>    }
<a name="l00156"></a>00156     <span class="keywordflow">return</span> rc;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00168"></a><a class="code" href="group__xg_vs_codec.html#gac949b5ce86d7bd719420ecde3a7ccc56">00168</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#gac949b5ce86d7bd719420ecde3a7ccc56" title="Set volume.">VsDecoderSetVolume</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <span class="keywordtype">int</span> left, <span class="keywordtype">int</span> right)
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *)dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00171"></a>00171     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> l;
<a name="l00172"></a>00172     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> r;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="comment">/* Honor limits. */</span>
<a name="l00175"></a>00175     left = left &gt; <a class="code" href="group__xg_helix_codec.html#ga61b84c9ac0047ee21e8a1d1e6b8d6668">AUDIO_DAC_MAX_GAIN</a> ? <a class="code" href="group__xg_helix_codec.html#ga61b84c9ac0047ee21e8a1d1e6b8d6668">AUDIO_DAC_MAX_GAIN</a> : left;
<a name="l00176"></a>00176     left = left &lt; <a class="code" href="group__xg_helix_codec.html#gacdb7befbaf4356f8ce3dc93837313b5c">AUDIO_DAC_MIN_GAIN</a> ? <a class="code" href="group__xg_helix_codec.html#gacdb7befbaf4356f8ce3dc93837313b5c">AUDIO_DAC_MIN_GAIN</a> : left;
<a name="l00177"></a>00177     right = right &gt; <a class="code" href="group__xg_helix_codec.html#ga61b84c9ac0047ee21e8a1d1e6b8d6668">AUDIO_DAC_MAX_GAIN</a> ? <a class="code" href="group__xg_helix_codec.html#ga61b84c9ac0047ee21e8a1d1e6b8d6668">AUDIO_DAC_MAX_GAIN</a> : right;
<a name="l00178"></a>00178     right = right &lt; <a class="code" href="group__xg_helix_codec.html#gacdb7befbaf4356f8ce3dc93837313b5c">AUDIO_DAC_MIN_GAIN</a> ? <a class="code" href="group__xg_helix_codec.html#gacdb7befbaf4356f8ce3dc93837313b5c">AUDIO_DAC_MIN_GAIN</a> : right;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/* Convert to register values. */</span>
<a name="l00181"></a>00181     l = (<a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>)(-2 * left);
<a name="l00182"></a>00182     r = (<a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>)(-2 * right);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs1001.html#ga98db54eca0bd0182bfafbd643c9876de">VS_VOL_REG</a>, (l &lt;&lt; <a class="code" href="group__xg_vs10xx.html#ga170f956f82d4a418df342b583922a12a" title="Right channel volume LSB.">VS_VOL_LEFT_LSB</a>) | (r &lt;&lt; <a class="code" href="group__xg_vs10xx.html#ga00aedaa886fd3d933e42d263e246d70e" title="Right channel volume LSB.">VS_VOL_RIGHT_LSB</a>));
<a name="l00185"></a>00185     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa8ffb49ed96f05a07b1babe2d770e8c0" title="Volume of left channel.">dcb_lvol</a> = left;
<a name="l00186"></a>00186     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a8767cd313198ed224a757cce3ad3cf2c" title="Volume of right channel.">dcb_rvol</a> = right;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">return</span> 0;
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00202"></a><a class="code" href="group__xg_vs_codec.html#ga1c426e54d8e8713958c9aefa006d5f17">00202</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga1c426e54d8e8713958c9aefa006d5f17" title="Set Bass.">VsDecoderSetBass</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <span class="keywordtype">int</span> treb, <span class="keywordtype">int</span> tfin, <span class="keywordtype">int</span> bass, <span class="keywordtype">int</span> bfin)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204 <span class="preprocessor">#ifdef VS_HAS_BASS_REG</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>    <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *)dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00206"></a>00206 <span class="comment">//    uint16_t t;</span>
<a name="l00207"></a>00207 <span class="comment">//    uint16_t b;</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="comment">//printf(&quot;bass: t:%ddB tf:%dHz b:%ddB bf:%dHz\n&quot;, treb, tfin*1000, bass, bfin);</span>
<a name="l00210"></a>00210     <span class="comment">/* Honor limits. */</span>
<a name="l00211"></a>00211     treb = treb &gt; <a class="code" href="group__xg_vs_codec.html#gaf5981f0f7dd1842df26dad9648c111e1">AUDIO_DAC_MAX_TREB</a> ? <a class="code" href="group__xg_vs_codec.html#gaf5981f0f7dd1842df26dad9648c111e1">AUDIO_DAC_MAX_TREB</a> : treb;
<a name="l00212"></a>00212     treb = treb &lt; 0 ? 0 : treb;
<a name="l00213"></a>00213     tfin = tfin &gt; <a class="code" href="group__xg_vs_codec.html#gab332289b144a32513a9b689a2d60ccb3">AUDIO_DAC_MAX_TFIN</a> ? <a class="code" href="group__xg_vs_codec.html#gab332289b144a32513a9b689a2d60ccb3">AUDIO_DAC_MAX_TFIN</a> : tfin;
<a name="l00214"></a>00214     tfin = tfin &lt; 0 ? 0 : tfin;
<a name="l00215"></a>00215     bass = bass &gt; <a class="code" href="group__xg_vs_codec.html#gab6585360ecf7f35a32715b156cd7933b">AUDIO_DAC_MAX_BASS</a> ? <a class="code" href="group__xg_vs_codec.html#gab6585360ecf7f35a32715b156cd7933b">AUDIO_DAC_MAX_BASS</a> : bass;
<a name="l00216"></a>00216     bass = bass &lt; 0 ? 0 : bass;
<a name="l00217"></a>00217     bfin = bfin &gt; <a class="code" href="group__xg_vs_codec.html#gae031c2be5a908db8c80ddef663a88907">AUDIO_DAC_MAX_BFIN</a> ? <a class="code" href="group__xg_vs_codec.html#gae031c2be5a908db8c80ddef663a88907">AUDIO_DAC_MAX_BFIN</a> : bfin;
<a name="l00218"></a>00218     bfin = bfin &lt; 0 ? 0 : bfin;
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment">/* Convert to register values. */</span>
<a name="l00221"></a>00221     <span class="comment">/*</span>
<a name="l00222"></a>00222 <span class="comment">    l = (uint16_t)(-2 * left);</span>
<a name="l00223"></a>00223 <span class="comment">    r = (uint16_t)(-2 * right);</span>
<a name="l00224"></a>00224 <span class="comment">    */</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#gaf264165917c58d3f122953c1f6de6d73" title="Register index.">VS_BASS_REG</a>,
<a name="l00227"></a>00227         (treb &lt;&lt; <a class="code" href="group__xg_vs10xx.html#ga066db6744b3b20f00ad8a4a282eaa161" title="Bass enhancement LSB.">VS_ST_AMPLITUDE_LSB</a>) | (tfin &lt;&lt; <a class="code" href="group__xg_vs10xx.html#gab6a8ea0d0d85ae7eb47a98e16660b808" title="Lower limit frequency LSB.">VS_ST_FREQLIMIT_LSB</a>) |
<a name="l00228"></a>00228         (treb &lt;&lt; <a class="code" href="group__xg_vs10xx.html#ga71da44e0c52718dc00f9f83baf8775e6" title="Bass enhancement LSB.">VS_SB_AMPLITUDE_LSB</a>) | (tfin &lt;&lt; <a class="code" href="group__xg_vs10xx.html#ga64c72f67415234dddb26759a177f9a4c" title="Lower limit frequency LSB.">VS_SB_FREQLIMIT_LSB</a>)
<a name="l00229"></a>00229     );
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a961ba955d6efbf960513f0f52ad596dc" title="Treble enhancement *1.5dB.">dcb_treb</a> = treb;
<a name="l00232"></a>00232     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a56d56d82c181a67132dba7fd819de003" title="Treble limit frequency *1000Hz.">dcb_tfin</a> = tfin;
<a name="l00233"></a>00233     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a3bfdf93c4b16544b57955c4a55c78d0a" title="Bass enhancement *1dB.">dcb_bass</a> = bass;
<a name="l00234"></a>00234     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a2615649c5640ed45c3ff28e5563c3448" title="Bass limit frequency *10Hz.">dcb_bfin</a> = bfin;
<a name="l00235"></a>00235 <span class="preprocessor">#endif</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>
<a name="l00237"></a>00237     <span class="keywordflow">return</span> 0;
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00251"></a><a class="code" href="group__xg_vs_codec.html#gab793ab548ad40c8e2b9f7d5ce32affe3">00251</a> <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="group__xg_vs_codec.html#gab793ab548ad40c8e2b9f7d5ce32affe3" title="Start or stop sine wave beeper.">VsCodecBeep</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> fsin)
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> rc = 0;
<a name="l00254"></a>00254     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> on[] = { 0x53, 0xEF, 0x6E, 0x3F, 0x00, 0x00, 0x00, 0x00 };
<a name="l00255"></a>00255     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> off[] = { 0x45, 0x78, 0x69, 0x74, 0x00, 0x00, 0x00, 0x00 };
<a name="l00256"></a>00256     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> ftab[] = { 44100, 48000, 32000, 22050, 24000, 16000, 11025, 12000 };
<a name="l00257"></a>00257     <span class="keyword">static</span> <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> mode;
<a name="l00258"></a>00258     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *)dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     if (fsin) {
<a name="l00261"></a>00261         <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> s;
<a name="l00262"></a>00262         <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> f;
<a name="l00263"></a>00263         <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> d;
<a name="l00264"></a>00264         <a class="code" href="stdint_8h.html#a880ed9ceb8621521452c81d03bd08cfb">int_fast8_t</a> i = <span class="keyword">sizeof</span>(ftab) / <span class="keyword">sizeof</span>(ftab[0]);
<a name="l00265"></a>00265         <a class="code" href="stdint_8h.html#a880ed9ceb8621521452c81d03bd08cfb">int_fast8_t</a> ie = 0;
<a name="l00266"></a>00266         <a class="code" href="stdint_8h.html#a9b7386d4af0e20ee32296d9a158c9f3a">int_fast16_t</a> dmin = fsin;
<a name="l00267"></a>00267         <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> fs = (long)fsin * 128;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">while</span> (--i &gt;= ie) {
<a name="l00270"></a>00270             <span class="comment">/* Calculate skip speed. */</span>
<a name="l00271"></a>00271             f = ftab[i];
<a name="l00272"></a>00272             s = (fs + f / 2) / f;
<a name="l00273"></a>00273             <span class="comment">/* Check that skip is within 5-bit range. */</span>
<a name="l00274"></a>00274             <span class="keywordflow">if</span> (s &amp;&amp; s &lt; 32) {
<a name="l00275"></a>00275                 <span class="comment">/* Calculate the absolute deviation. */</span>
<a name="l00276"></a>00276                 f *= s;
<a name="l00277"></a>00277                 f += 64;
<a name="l00278"></a>00278                 f &gt;&gt;= 7;
<a name="l00279"></a>00279                 d = (<a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a>)(fsin &gt; f ? fsin - f : f - fsin);
<a name="l00280"></a>00280                 <span class="comment">/* Check if this is a new minimum. */</span>
<a name="l00281"></a>00281                 <span class="keywordflow">if</span> (d &lt; dmin) {
<a name="l00282"></a>00282                     dmin = d;
<a name="l00283"></a>00283                     rc = (<a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) f;
<a name="l00284"></a>00284                     <span class="comment">/* Set new skip speed and frequency index. */</span>
<a name="l00285"></a>00285                     on[3] = (i &lt;&lt; 5) | s;
<a name="l00286"></a>00286                     <span class="comment">/* We can stop earlier with this fit. */</span>
<a name="l00287"></a>00287                     <span class="keywordflow">if</span> (i &gt; 1) {
<a name="l00288"></a>00288                         ie = i - 2;
<a name="l00289"></a>00289                     }
<a name="l00290"></a>00290                 }
<a name="l00291"></a>00291             }
<a name="l00292"></a>00292         }
<a name="l00293"></a>00293         mode = <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>);
<a name="l00294"></a>00294 <span class="preprocessor">#ifdef VS_SM_TESTS</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span>        <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, mode | <a class="code" href="group__xg_vs10xx.html#ga6bc9f02a2bb154a626f3fee3a024e5b4" title="Allow SDI tests.">VS_SM_TESTS</a>, 0xffff);
<a name="l00296"></a>00296 <span class="preprocessor">#endif</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>        (*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#abefbccfa4e02460bc8219f6da7932540">dcb_senddata</a>)(on, <span class="keyword">sizeof</span>(on));
<a name="l00298"></a>00298     } <span class="keywordflow">else</span> {
<a name="l00299"></a>00299         (*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#abefbccfa4e02460bc8219f6da7932540">dcb_senddata</a>)(off, <span class="keyword">sizeof</span>(off));
<a name="l00300"></a>00300 <span class="preprocessor">#ifdef VS_SM_TESTS</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>        <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a> | <a class="code" href="group__xg_vs10xx.html#ga6bc9f02a2bb154a626f3fee3a024e5b4" title="Allow SDI tests.">VS_SM_TESTS</a>);
<a name="l00302"></a>00302 <span class="preprocessor">#else</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>        <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>);
<a name="l00304"></a>00304 <span class="preprocessor">#endif</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span>        <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, mode, 0xffff);
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     <span class="keywordflow">return</span> rc;
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="comment">/*</span>
<a name="l00311"></a>00311 <span class="comment"> * Initialize the stream output buffer with a given size.</span>
<a name="l00312"></a>00312 <span class="comment"> *</span>
<a name="l00313"></a>00313 <span class="comment"> * \param dev Specifies the audio codec device.</span>
<a name="l00314"></a>00314 <span class="comment"> */</span>
<a name="l00315"></a><a class="code" href="group__xg_vs_codec.html#ga090ebb4cca00fab8498bccdf5eb27bb6">00315</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga090ebb4cca00fab8498bccdf5eb27bb6">VsDecoderBufferInit</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> size)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *)dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="comment">/* Make sure that the decoder is idle. */</span>
<a name="l00320"></a>00320     if (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> != <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>) {
<a name="l00321"></a>00321         <span class="keywordflow">return</span> -1;
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323     <span class="comment">/* Set new buffer size. */</span>
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (<a class="code" href="group__xg_bank_mem.html#ga54b4fc4de72531a2c413219187019e71" title="Initialize the segmented buffer.">NutSegBufInit</a>((<span class="keywordtype">size_t</span>)size) == NULL) {
<a name="l00325"></a>00325         <span class="keywordflow">return</span> -1;
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327     <span class="comment">/* Set watermark defaults. */</span>
<a name="l00328"></a>00328     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a7cb867a14d1020fd247324f07ac7f7c4" title="Playback buffer low watermark.">dcb_pbwlo</a> = <a class="code" href="group__xg_bank_mem.html#ga866d595bca99894fdee0e1e59cdc5d7d" title="Return the available buffer space.">NutSegBufAvailable</a>() / 3;
<a name="l00329"></a>00329     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a66aea1826dc4383953108efb3cf16be3" title="Playback buffer high watermark.">dcb_pbwhi</a> = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a7cb867a14d1020fd247324f07ac7f7c4" title="Playback buffer low watermark.">dcb_pbwlo</a> * 2;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="keywordflow">return</span> 0;
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="comment">/*</span>
<a name="l00335"></a>00335 <span class="comment"> * VLSI decoder feeding thread.</span>
<a name="l00336"></a>00336 <span class="comment"> */</span>
<a name="l00337"></a><a class="code" href="group__xg_vs_codec.html#ga821f8b84af3f2fe88e7ed278735cae1a">00337</a> <a class="code" href="thread_8h.html#a9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a class="code" href="group__xg_helix_codec.html#ga821f8b84af3f2fe88e7ed278735cae1a">FeederThread</a>, arg)
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *bp;
<a name="l00340"></a>00340     <span class="keywordtype">size_t</span> avail;
<a name="l00341"></a>00341     <span class="keywordtype">int</span> filled;
<a name="l00342"></a>00342     <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> intest = 0;
<a name="l00343"></a>00343     <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> idlefill = 0;
<a name="l00344"></a>00344     <a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev = (<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *)arg;
<a name="l00345"></a>00345     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *)dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="comment">/* We are a high priority thread. */</span>
<a name="l00348"></a>00348     <a class="code" href="group__xg_thread.html#ga8ebe134e9c404072584e80fb8d7e8985" title="Set the current thread&#39;s priority.">NutThreadSetPriority</a>(7);
<a name="l00349"></a>00349     <span class="keywordflow">for</span> (;;) {
<a name="l00350"></a>00350         <span class="comment">/*</span>
<a name="l00351"></a>00351 <span class="comment">        ** Idle mode processing.</span>
<a name="l00352"></a>00352 <span class="comment">        */</span>
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>) {
<a name="l00354"></a>00354             <span class="comment">/* Loop while in test mode. */</span>
<a name="l00355"></a>00355             <span class="keywordflow">do</span> {
<a name="l00356"></a>00356                 <span class="comment">/* Wait for a request or a buffer update. */</span>
<a name="l00357"></a>00357                 <a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>, <a class="code" href="group__xg_event.html#gaee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l00358"></a>00358                 <span class="comment">/* Process beep commands. */</span>
<a name="l00359"></a>00359                 <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#ga7f0e0b6f52a30c87fb9e161b5ef58c9b" title="Sine wave test.">VSREQ_BEEP</a>) {
<a name="l00360"></a>00360                     <span class="keywordflow">if</span> ((*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#ac55564ad82b6df053e3b2019f9ec9514">dcb_isready</a>)()) {
<a name="l00361"></a>00361                         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~<a class="code" href="group__xg_vs_codec.html#ga7f0e0b6f52a30c87fb9e161b5ef58c9b" title="Sine wave test.">VSREQ_BEEP</a>;
<a name="l00362"></a>00362                         intest = <a class="code" href="group__xg_vs_codec.html#gab793ab548ad40c8e2b9f7d5ce32affe3" title="Start or stop sine wave beeper.">VsCodecBeep</a>(dev, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a48c8962adcb252c6092a87a5ac034d2c" title="Requested beep frequency.">dcb_sinefreq</a>) != 0;
<a name="l00363"></a>00363                     }
<a name="l00364"></a>00364                 }
<a name="l00365"></a>00365             } <span class="keywordflow">while</span> (intest);
<a name="l00366"></a>00366             <span class="comment">/* Check if we should change to record mode. */</span>
<a name="l00367"></a>00367             <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#ga246288d78f86589c4513b34006205fa3" title="Start recording.">VSREQ_RECORD</a>) {
<a name="l00368"></a>00368                 dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~(<a class="code" href="group__xg_vs_codec.html#ga246288d78f86589c4513b34006205fa3" title="Start recording.">VSREQ_RECORD</a> | <a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>);
<a name="l00369"></a>00369                 dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> = <a class="code" href="group__xg_vs_codec.html#ga1208e98c9d2a71276c6a3f212da5307b">CODEC_STATUS_RECORDING</a>;
<a name="l00370"></a>00370                 <span class="comment">/* Activate the encoder. */</span>
<a name="l00371"></a>00371                 <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#ga932ee95930c93003b75c59867994636f" title="Register index.">VS_AIADDR_REG</a>, 0x0034);
<a name="l00372"></a>00372             }
<a name="l00373"></a>00373             <span class="comment">/* Check if we should change to play mode. This will happen</span>
<a name="l00374"></a>00374 <span class="comment">            ** if we receive a play request or if the buffer contents</span>
<a name="l00375"></a>00375 <span class="comment">            ** reaches the high watermark. */</span>
<a name="l00376"></a>00376             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#gaa9148051010a1172434c8680307df41f" title="Force immediate player start.">VSREQ_PLAY</a>) != 0 || <a class="code" href="group__xg_bank_mem.html#gacc5a7121fca5d27017c4d9f851a90475" title="Return the used buffer space.">NutSegBufUsed</a>() &gt;=  dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a66aea1826dc4383953108efb3cf16be3" title="Playback buffer high watermark.">dcb_pbwhi</a>) {
<a name="l00377"></a>00377                 dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~(<a class="code" href="group__xg_vs_codec.html#gaa9148051010a1172434c8680307df41f" title="Force immediate player start.">VSREQ_PLAY</a> | <a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>);
<a name="l00378"></a>00378                 dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> = <a class="code" href="group__xg_helix_codec.html#gae617586ed1ccf27121ca932e8955efcc">CODEC_STATUS_PLAYING</a>;
<a name="l00379"></a>00379                 <a class="code" href="group__xg_vs_codec.html#gac949b5ce86d7bd719420ecde3a7ccc56" title="Set volume.">VsDecoderSetVolume</a>(dev, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa8ffb49ed96f05a07b1babe2d770e8c0" title="Volume of left channel.">dcb_lvol</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a8767cd313198ed224a757cce3ad3cf2c" title="Volume of right channel.">dcb_rvol</a>);
<a name="l00380"></a>00380             }
<a name="l00381"></a>00381         }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383         <span class="comment">/*</span>
<a name="l00384"></a>00384 <span class="comment">        ** Play mode processing.</span>
<a name="l00385"></a>00385 <span class="comment">        */</span>
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gae617586ed1ccf27121ca932e8955efcc">CODEC_STATUS_PLAYING</a>) {
<a name="l00387"></a>00387             <span class="comment">/* Wait while decoder is busy. */</span>
<a name="l00388"></a>00388             <a class="code" href="group__xg_vs_codec.html#ga5b4989c20b35f2410102ffcc4fae38f7" title="Wait until codec is ready.">VsCodecWaitReady</a>(dev, <a class="code" href="group__xg_event.html#gaee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l00389"></a>00389             <span class="comment">/* Process cancel requests. */</span>
<a name="l00390"></a>00390             <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>) {
<a name="l00391"></a>00391                 dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~<a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>;
<a name="l00392"></a>00392                 <a class="code" href="group__xg_bank_mem.html#ga59e6535d66539f29aed5909eb0b70eed" title="Reset the segmented buffer.">NutSegBufReset</a>();
<a name="l00393"></a>00393 <span class="preprocessor">#if VS_HAS_SM_CANCEL</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>                <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, VS_SM_CANCEL, VS_SM_CANCEL);
<a name="l00395"></a>00395 <span class="preprocessor">#endif</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>            }
<a name="l00397"></a>00397             <span class="comment">/* Retrieve new data from the input buffer. */</span>
<a name="l00398"></a>00398             bp = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) <a class="code" href="group__xg_bank_mem.html#gac9fb2d54037da348dfc6a9c99b47e75f" title="Request segmented buffer space for reading.">NutSegBufReadRequest</a>(&amp;avail);
<a name="l00399"></a>00399             <span class="keywordflow">if</span> (avail) {
<a name="l00400"></a>00400                 <span class="comment">/* More data available, send as much as possible to the</span>
<a name="l00401"></a>00401 <span class="comment">                ** decoder. If no data was sent, then the bus may be</span>
<a name="l00402"></a>00402 <span class="comment">                ** blocked by another device. */</span>
<a name="l00403"></a>00403                 filled = (*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#abefbccfa4e02460bc8219f6da7932540">dcb_senddata</a>)(bp, avail);
<a name="l00404"></a>00404                 <span class="keywordflow">if</span> (filled) {
<a name="l00405"></a>00405                     <span class="comment">/* Update the buffer&#39;s read position. */</span>
<a name="l00406"></a>00406                     <a class="code" href="group__xg_bank_mem.html#gad9e27e0283495409f46e25e794286b4b" title="Commit written buffer space and finish read access.">NutSegBufReadLast</a>(filled);
<a name="l00407"></a>00407                     <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>);
<a name="l00408"></a>00408                     idlefill = 2048;
<a name="l00409"></a>00409                 }
<a name="l00410"></a>00410                 <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#ga7630d64fba7e157d1153e8c33794193f" title="Volume update.">VSREQ_VOLUPD</a>) {
<a name="l00411"></a>00411                     <a class="code" href="group__xg_vs_codec.html#gac949b5ce86d7bd719420ecde3a7ccc56" title="Set volume.">VsDecoderSetVolume</a>(dev, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa8ffb49ed96f05a07b1babe2d770e8c0" title="Volume of left channel.">dcb_lvol</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a8767cd313198ed224a757cce3ad3cf2c" title="Volume of right channel.">dcb_rvol</a>);
<a name="l00412"></a>00412                     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~<a class="code" href="group__xg_vs_codec.html#ga7630d64fba7e157d1153e8c33794193f" title="Volume update.">VSREQ_VOLUPD</a>;
<a name="l00413"></a>00413                 }
<a name="l00414"></a>00414                 <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766" title="Audio enhancement update.">VSREQ_AUDIOE</a>) {
<a name="l00415"></a>00415                     <a class="code" href="group__xg_vs_codec.html#ga1c426e54d8e8713958c9aefa006d5f17" title="Set Bass.">VsDecoderSetBass</a>( dev, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a961ba955d6efbf960513f0f52ad596dc" title="Treble enhancement *1.5dB.">dcb_treb</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a56d56d82c181a67132dba7fd819de003" title="Treble limit frequency *1000Hz.">dcb_tfin</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a3bfdf93c4b16544b57955c4a55c78d0a" title="Bass enhancement *1dB.">dcb_bass</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a2615649c5640ed45c3ff28e5563c3448" title="Bass limit frequency *10Hz.">dcb_bfin</a>);
<a name="l00416"></a>00416                     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~<a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766" title="Audio enhancement update.">VSREQ_AUDIOE</a>;
<a name="l00417"></a>00417                 }
<a name="l00418"></a>00418             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__xg_bank_mem.html#gacc5a7121fca5d27017c4d9f851a90475" title="Return the used buffer space.">NutSegBufUsed</a>() == 0) {
<a name="l00419"></a>00419                 <span class="comment">/* Running out of data. */</span>
<a name="l00420"></a>00420                 <span class="keywordflow">if</span> (idlefill) {
<a name="l00421"></a>00421                     <span class="comment">/* For some reason the HDAT0/HDAT1 registers in the</span>
<a name="l00422"></a>00422 <span class="comment">                    ** VS1053 do not contain zero when the codec runs</span>
<a name="l00423"></a>00423 <span class="comment">                    ** empty. I expected this when reading the datasheet.</span>
<a name="l00424"></a>00424 <span class="comment">                    ** Instead we fill the buffer with zeros, to make</span>
<a name="l00425"></a>00425 <span class="comment">                    ** sure that the whole buffer is decoded before we</span>
<a name="l00426"></a>00426 <span class="comment">                    ** enter idle mode. */</span>
<a name="l00427"></a>00427                     idlefill -= (*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#abefbccfa4e02460bc8219f6da7932540">dcb_senddata</a>)(NULL, idlefill);
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429                 <span class="keywordflow">if</span> (idlefill == 0) {
<a name="l00430"></a>00430                     <span class="comment">/* Finally we reached idle mode. */</span>
<a name="l00431"></a>00431                     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> = <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>;
<a name="l00432"></a>00432                     <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>);
<a name="l00433"></a>00433                 }
<a name="l00434"></a>00434             }
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437         <span class="comment">/* </span>
<a name="l00438"></a>00438 <span class="comment">        ** Record mode processing. </span>
<a name="l00439"></a>00439 <span class="comment">        */</span>
<a name="l00440"></a>00440         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_vs_codec.html#ga1208e98c9d2a71276c6a3f212da5307b">CODEC_STATUS_RECORDING</a>) {
<a name="l00441"></a>00441             <span class="keywordflow">for</span> (;;) {
<a name="l00442"></a>00442                 <span class="comment">/* Process cancel requests. */</span>
<a name="l00443"></a>00443                 <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp; <a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>) {
<a name="l00444"></a>00444                     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> &amp;= ~<a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>;
<a name="l00445"></a>00445                     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> = <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>;
<a name="l00446"></a>00446                     <span class="keywordflow">break</span>;
<a name="l00447"></a>00447                 }
<a name="l00448"></a>00448                 bp = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *)<a class="code" href="group__xg_bank_mem.html#ga5dca6c51548e7ee90dc79cddaa1668fd" title="Request segmented buffer space for writing.">NutSegBufWriteRequest</a>(&amp;avail);
<a name="l00449"></a>00449                 avail &gt;&gt;= 1;
<a name="l00450"></a>00450                 <span class="keywordflow">if</span> (avail == 0) {
<a name="l00451"></a>00451                     <span class="comment">/* Buffer overflow. */</span>
<a name="l00452"></a>00452                     dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> = <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>;
<a name="l00453"></a>00453                     <span class="keywordflow">break</span>;
<a name="l00454"></a>00454                 }
<a name="l00455"></a>00455 <span class="preprocessor">#if defined(VS_HDAT0_REG) &amp;&amp; defined(VS_HDAT1_REG)</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span>                <span class="comment">/* TODO: Missing register definitions give compiler error. */</span>
<a name="l00457"></a>00457                 filled = <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#ga0450ad0b8d21faada19079f1c7a65485">VS_OPCODE_READ</a>, <a class="code" href="group__xg_vs1001.html#ga05ce4437f2508d1c78e64ce23562d9be">VS_HDAT1_REG</a>, 0);
<a name="l00458"></a>00458                 <span class="keywordflow">if</span> (filled &gt; 255) {
<a name="l00459"></a>00459                     <span class="keywordflow">if</span> (avail &gt; filled) {
<a name="l00460"></a>00460                         avail = filled;
<a name="l00461"></a>00461                     } <span class="keywordflow">else</span> {
<a name="l00462"></a>00462                         filled = avail;
<a name="l00463"></a>00463                     }
<a name="l00464"></a>00464                     <span class="keywordflow">while</span> (filled--) {
<a name="l00465"></a>00465                         <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> data = <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#ga0450ad0b8d21faada19079f1c7a65485">VS_OPCODE_READ</a>, <a class="code" href="group__xg_vs1001.html#ga7865576d053f6e0713d4ad2df4c08a28">VS_HDAT0_REG</a>, 0);
<a name="l00466"></a>00466                         *bp++ = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) data &gt;&gt; 8;
<a name="l00467"></a>00467                         *bp++ = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) data &gt;&gt; 8;
<a name="l00468"></a>00468                     }
<a name="l00469"></a>00469                     <a class="code" href="group__xg_bank_mem.html#ga435c70799400cd3fab9b305d9e83987c" title="Commit written buffer space and finish write access.">NutSegBufWriteLast</a>(avail &lt;&lt; 1);
<a name="l00470"></a>00470                     <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>);
<a name="l00471"></a>00471                 } <span class="keywordflow">else</span> {
<a name="l00472"></a>00472                     <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(200);
<a name="l00473"></a>00473                 }
<a name="l00474"></a>00474 <span class="preprocessor">#endif</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span>            }
<a name="l00476"></a>00476             <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>);
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="comment">/* TODO: This is a preview and may not work as expected. */</span>
<a name="l00482"></a>00482 <span class="keyword">static</span> <span class="keywordtype">int</span> VsCodecLoadPlugIn(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html">VS_PLUGIN_INFO</a> *plg)
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484     <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> reg;
<a name="l00485"></a>00485     <a class="code" href="stdint_8h.html#a6ed085329b153773ff76afa0702cf897">uint_fast16_t</a> cnt;
<a name="l00486"></a>00486     <span class="keywordtype">size_t</span> i = 0;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="preprocessor">#ifdef VS_SM_ADPCM</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>    <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, 0, <a class="code" href="group__xg_vs10xx.html#ga8f6c65126f1983cee21e5c57fe2d827f" title="ADPCM recording.">VS_SM_ADPCM</a>);
<a name="l00490"></a>00490 <span class="preprocessor">#endif</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>    <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs1001.html#ga2c94c300a231523b2b36dfa4715dfdde">VS_CLOCKF_REG</a>, 0xC000);
<a name="l00492"></a>00492     <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(100);
<a name="l00493"></a>00493 <span class="preprocessor">#if VS_HAS_BASS_REG</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span>    <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#gaf264165917c58d3f122953c1f6de6d73" title="Register index.">VS_BASS_REG</a>, 0);
<a name="l00495"></a>00495 <span class="preprocessor">#endif</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>        <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#ga932ee95930c93003b75c59867994636f" title="Register index.">VS_AIADDR_REG</a>, 0);
<a name="l00497"></a>00497         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs1001.html#ga4f1697c4d64db06bb0310ec1bd716a6a">VS_WRAMADDR_REG</a>, 0xC01A);
<a name="l00498"></a>00498         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs1001.html#gacb2334bb4ec31cec72bc353e8f389054">VS_WRAM_REG</a>, 0x0002);
<a name="l00499"></a>00499     <span class="keywordflow">while</span> (i + 3 &lt;= plg-&gt;<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html#a7278d9f8df2391f7bf1fdb3f7b546669">vsplg_size</a>) {
<a name="l00500"></a>00500         reg = (<a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a>)plg-&gt;<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html#a49c04c3dfd2a289e6765115df2475bcb">vsplg_data</a>[i++];
<a name="l00501"></a>00501         cnt = plg-&gt;<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html#a49c04c3dfd2a289e6765115df2475bcb">vsplg_data</a>[i++];
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         if (cnt &amp; 0x8000) {
<a name="l00504"></a>00504             cnt &amp;= 0x7FFF;
<a name="l00505"></a>00505             <span class="keywordflow">while</span> (cnt--) {
<a name="l00506"></a>00506                 <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, reg, plg-&gt;<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html#a49c04c3dfd2a289e6765115df2475bcb">vsplg_data</a>[i]);
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508             i++;
<a name="l00509"></a>00509         } 
<a name="l00510"></a>00510         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i + cnt &lt;= plg-&gt;vsplg_size) {
<a name="l00511"></a>00511             <span class="keywordflow">while</span> (cnt--) {
<a name="l00512"></a>00512                 <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, reg, plg-&gt;<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html#a49c04c3dfd2a289e6765115df2475bcb">vsplg_data</a>[i]);
<a name="l00513"></a>00513                 i++;
<a name="l00514"></a>00514             }
<a name="l00515"></a>00515         } 
<a name="l00516"></a>00516         <span class="keywordflow">else</span> {
<a name="l00517"></a>00517             <span class="keywordflow">break</span>;
<a name="l00518"></a>00518         }
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520     <span class="keywordflow">if</span> (i != plg-&gt;<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html#a7278d9f8df2391f7bf1fdb3f7b546669">vsplg_size</a>) {
<a name="l00521"></a>00521         <span class="keywordflow">return</span> -1;
<a name="l00522"></a>00522     }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="preprocessor">#ifdef VS_SM_ADPCM</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span>        <span class="comment">// set bits 12 and 13 of register SCI_MODE</span>
<a name="l00526"></a>00526         <span class="comment">// 12 is the ADPCM bit, 13 is the MIC/LINE bit.</span>
<a name="l00527"></a>00527     <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, <a class="code" href="group__xg_vs10xx.html#ga2258a94f61185f2293c538f467ef57e2" title="ADPCM recording selector.">VS_SM_LINE_IN</a> | <a class="code" href="group__xg_vs10xx.html#ga8f6c65126f1983cee21e5c57fe2d827f" title="ADPCM recording.">VS_SM_ADPCM</a>, <a class="code" href="group__xg_vs10xx.html#ga2258a94f61185f2293c538f467ef57e2" title="ADPCM recording selector.">VS_SM_LINE_IN</a> | <a class="code" href="group__xg_vs10xx.html#ga8f6c65126f1983cee21e5c57fe2d827f" title="ADPCM recording.">VS_SM_ADPCM</a>);
<a name="l00528"></a>00528 <span class="preprocessor">#endif</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span>
<a name="l00530"></a>00530 <span class="preprocessor">#if VS_HAS_AICTRL0_REG</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>        <span class="comment">// write 0 to SCI_AICTRL0 (maximum signal level, set by encoder to read later on)</span>
<a name="l00532"></a>00532         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#gaed5baa388b0a7c60602ee4ed51116687" title="Application register 0 index.">VS_AICTRL0_REG</a>, 0);
<a name="l00533"></a>00533 <span class="preprocessor">#endif</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span>
<a name="l00535"></a>00535     <span class="comment">// recording gain 0: automatic gain control on</span>
<a name="l00536"></a>00536         <span class="comment">//CodecReg(&amp;codec_node, VS_OPCODE_WRITE, VS_AICTRL1_REG, 0);</span>
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 <span class="preprocessor">#if VS_HAS_AICTRL1_REG</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span>        <span class="comment">// recording gain 1</span>
<a name="l00540"></a>00540         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#ga91f1f32092888a503b448b25736b6372" title="Application register 1 index.">VS_AICTRL1_REG</a>, 1024);
<a name="l00541"></a>00541 <span class="preprocessor">#endif</span>
<a name="l00542"></a>00542 <span class="preprocessor"></span>
<a name="l00543"></a>00543 <span class="preprocessor">#if VS_HAS_AICTRL2_REG</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span>        <span class="comment">// maximum autogain amplification, 4096 (=4x) is recommended</span>
<a name="l00545"></a>00545         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#ga87e1e12532bd4bac1476b52c5b386db4" title="Application register 2 index.">VS_AICTRL2_REG</a>, 4096);
<a name="l00546"></a>00546 <span class="preprocessor">#endif</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span>
<a name="l00548"></a>00548 <span class="preprocessor">#if VS_HAS_AICTRL3_REG  </span>
<a name="l00549"></a>00549 <span class="preprocessor"></span>        <span class="comment">// setting SCI_AICTRL3 should be fine, too...</span>
<a name="l00550"></a>00550         <a class="code" href="group__xg_vs_codec.html#ga74b6bf3f0e6260da1002842ed1a3adef">VsCodecReg</a>(dev, <a class="code" href="group__xg_vs1001.html#gaa5584f99434f2094703901e0aa504ac9">VS_OPCODE_WRITE</a>, <a class="code" href="group__xg_vs10xx.html#gac2fb3c1cf6a462e95b880f8963afd25e" title="Application register 3 index.">VS_AICTRL3_REG</a>, 0);
<a name="l00551"></a>00551 <span class="preprocessor">#endif</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span>
<a name="l00553"></a>00553     <span class="keywordflow">return</span> 0;
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00577"></a><a class="code" href="group__xg_vs_codec.html#ga0dfdf6b6c0b6284c60cb2b5714e70763">00577</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga0dfdf6b6c0b6284c60cb2b5714e70763" title="Handle I/O controls for audio codec.">VsCodecIOCtl</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> * dev, <span class="keywordtype">int</span> req, <span class="keywordtype">void</span> *conf)
<a name="l00578"></a>00578 {
<a name="l00579"></a>00579     <span class="keywordtype">int</span> rc = 0;
<a name="l00580"></a>00580     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> *lvp = (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> *) conf;
<a name="l00581"></a>00581     <span class="keywordtype">int</span> *ivp = (<span class="keywordtype">int</span> *) conf;
<a name="l00582"></a>00582     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = (<a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *)dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     switch (req) {
<a name="l00585"></a>00585     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gaf75bd0f8fec1efbe0e896a830e3b6084" title="Immediately start playing.">AUDIO_PLAY</a>:
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>) {
<a name="l00587"></a>00587             <span class="comment">/* Immediately start playing. */</span>
<a name="l00588"></a>00588             dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#gaa9148051010a1172434c8680307df41f" title="Force immediate player start.">VSREQ_PLAY</a>;
<a name="l00589"></a>00589         }
<a name="l00590"></a>00590         <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>);
<a name="l00591"></a>00591         <span class="keywordflow">break</span>;
<a name="l00592"></a>00592     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gafd45015bab3e0e8d10d790aab40faab1" title="Immediately stop playing and discard buffer.">AUDIO_CANCEL</a>:
<a name="l00593"></a>00593         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gae617586ed1ccf27121ca932e8955efcc">CODEC_STATUS_PLAYING</a>) {
<a name="l00594"></a>00594             <span class="comment">/* Immediately stop playing and discard buffer. */</span>
<a name="l00595"></a>00595             dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#gaa8db5d5a71bfe0198dee4482cf6eba47" title="Force immediate player stop.">VSREQ_CANCEL</a>;
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597         <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>);
<a name="l00598"></a>00598         <span class="keywordflow">break</span>;
<a name="l00599"></a>00599     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga5833b2613fb9992234f25c4b50cb7b39">AUDIO_GET_STATUS</a>:
<a name="l00600"></a>00600         *ivp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a>;
<a name="l00601"></a>00601         <span class="keywordflow">break</span>;
<a name="l00602"></a>00602     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gac70cb868fe465e1b01df3d5711c9e0c7">AUDIO_GET_PLAYGAIN</a>:
<a name="l00603"></a>00603         *ivp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a8767cd313198ed224a757cce3ad3cf2c" title="Volume of right channel.">dcb_rvol</a> &gt; dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa8ffb49ed96f05a07b1babe2d770e8c0" title="Volume of left channel.">dcb_lvol</a> ? dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a8767cd313198ed224a757cce3ad3cf2c" title="Volume of right channel.">dcb_rvol</a> : dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa8ffb49ed96f05a07b1babe2d770e8c0" title="Volume of left channel.">dcb_lvol</a>;
<a name="l00604"></a>00604         <span class="keywordflow">break</span>;
<a name="l00605"></a>00605     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gaed24791e260473ba2b26ea0dddfdcef3">AUDIO_SET_PLAYGAIN</a>:
<a name="l00606"></a>00606         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa8ffb49ed96f05a07b1babe2d770e8c0" title="Volume of left channel.">dcb_lvol</a> = *ivp;
<a name="l00607"></a>00607         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a8767cd313198ed224a757cce3ad3cf2c" title="Volume of right channel.">dcb_rvol</a> = *ivp;
<a name="l00608"></a>00608         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga7630d64fba7e157d1153e8c33794193f" title="Volume update.">VSREQ_VOLUPD</a>;
<a name="l00609"></a>00609         <span class="keywordflow">break</span>;
<a name="l00610"></a>00610     <span class="keywordflow">case</span> <a class="code" href="group__xg_vs_codec.html#gae9eb3b4b2237ffff9ff004db7448743d" title="Set audio enhancement treble value.">AUDIO_SET_TREB</a>:
<a name="l00611"></a>00611         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a961ba955d6efbf960513f0f52ad596dc" title="Treble enhancement *1.5dB.">dcb_treb</a> = *ivp;
<a name="l00612"></a>00612         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766" title="Audio enhancement update.">VSREQ_AUDIOE</a>;
<a name="l00613"></a>00613         <span class="keywordflow">break</span>;
<a name="l00614"></a>00614     <span class="keywordflow">case</span> <a class="code" href="group__xg_vs_codec.html#ga9778ec3ad98f6d5be6cb655bbb1a8f88" title="Set audio enhancement treble frequency.">AUDIO_SET_TFIN</a>:
<a name="l00615"></a>00615         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a56d56d82c181a67132dba7fd819de003" title="Treble limit frequency *1000Hz.">dcb_tfin</a> = *ivp;
<a name="l00616"></a>00616         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766" title="Audio enhancement update.">VSREQ_AUDIOE</a>;
<a name="l00617"></a>00617         <span class="keywordflow">break</span>;
<a name="l00618"></a>00618     <span class="keywordflow">case</span> <a class="code" href="group__xg_vs_codec.html#ga69c21b8b14c6c40e344695b55c8a5129" title="Set audio enhancement bass value.">AUDIO_SET_BASS</a>:
<a name="l00619"></a>00619         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a3bfdf93c4b16544b57955c4a55c78d0a" title="Bass enhancement *1dB.">dcb_bass</a> = *ivp;
<a name="l00620"></a>00620         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766" title="Audio enhancement update.">VSREQ_AUDIOE</a>;
<a name="l00621"></a>00621         <span class="keywordflow">break</span>;
<a name="l00622"></a>00622     <span class="keywordflow">case</span> <a class="code" href="group__xg_vs_codec.html#ga1e0cf63ba56ec5dfca025a4915c49b09" title="Set audio enhancement bass frequency.">AUDIO_SET_BFIN</a>:
<a name="l00623"></a>00623         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a2615649c5640ed45c3ff28e5563c3448" title="Bass limit frequency *10Hz.">dcb_bfin</a> = *ivp;
<a name="l00624"></a>00624         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga1f361485e0129cba1b4efe629ee03766" title="Audio enhancement update.">VSREQ_AUDIOE</a>;
<a name="l00625"></a>00625         <span class="keywordflow">break</span>;
<a name="l00626"></a>00626     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gade402c342a141f3bfaf3da7abff8cc95">AUDIO_GET_PBSIZE</a>:
<a name="l00627"></a>00627         *lvp = <a class="code" href="group__xg_bank_mem.html#ga866d595bca99894fdee0e1e59cdc5d7d" title="Return the available buffer space.">NutSegBufAvailable</a>() + <a class="code" href="group__xg_bank_mem.html#gacc5a7121fca5d27017c4d9f851a90475" title="Return the used buffer space.">NutSegBufUsed</a>();
<a name="l00628"></a>00628         <span class="keywordflow">break</span>;
<a name="l00629"></a>00629     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga50984c096656a97532c4ab457ed69dee">AUDIO_SET_PBSIZE</a>:
<a name="l00630"></a>00630         rc = <a class="code" href="group__xg_vs_codec.html#ga090ebb4cca00fab8498bccdf5eb27bb6">VsDecoderBufferInit</a>(dev, *lvp);
<a name="l00631"></a>00631         <span class="keywordflow">break</span>;
<a name="l00632"></a>00632     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gad79e0da695c8284864961c8a39fcdd45">AUDIO_GET_PBLEVEL</a>:
<a name="l00633"></a>00633         *lvp = <a class="code" href="group__xg_bank_mem.html#gacc5a7121fca5d27017c4d9f851a90475" title="Return the used buffer space.">NutSegBufUsed</a>();
<a name="l00634"></a>00634         <span class="keywordflow">break</span>;
<a name="l00635"></a>00635     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga5419d7fd67c143304911ffeb45bdcc44">AUDIO_GET_PBWLOW</a>:
<a name="l00636"></a>00636         *lvp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a7cb867a14d1020fd247324f07ac7f7c4" title="Playback buffer low watermark.">dcb_pbwlo</a>;
<a name="l00637"></a>00637         <span class="keywordflow">break</span>;
<a name="l00638"></a>00638     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga773b52c72dd515df2a4df1d9b59dc46b">AUDIO_SET_PBWLOW</a>:
<a name="l00639"></a>00639         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a7cb867a14d1020fd247324f07ac7f7c4" title="Playback buffer low watermark.">dcb_pbwlo</a> = *lvp;
<a name="l00640"></a>00640         <span class="keywordflow">break</span>;
<a name="l00641"></a>00641     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gaecb9b5e9a1ff104ad12ef1f08969ba90">AUDIO_GET_PBWHIGH</a>:
<a name="l00642"></a>00642         *lvp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a66aea1826dc4383953108efb3cf16be3" title="Playback buffer high watermark.">dcb_pbwhi</a>;
<a name="l00643"></a>00643         <span class="keywordflow">break</span>;
<a name="l00644"></a>00644     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gafcf14accf27c6156da21cb9c30eac273">AUDIO_SET_PBWHIGH</a>:
<a name="l00645"></a>00645         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a66aea1826dc4383953108efb3cf16be3" title="Playback buffer high watermark.">dcb_pbwhi</a> = *lvp;
<a name="l00646"></a>00646         <span class="keywordflow">break</span>;
<a name="l00647"></a>00647     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga48d40c8744e04d739d51715854c2817c">AUDIO_SETWRITETIMEOUT</a>:
<a name="l00648"></a>00648         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aaae10bb3cbf8306530ae3e176cab04cf" title="Write timeout.">dcb_wtmo</a> = *lvp;
<a name="l00649"></a>00649         <span class="keywordflow">break</span>;
<a name="l00650"></a>00650     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga80c40f275cc62b3a732f15ed43b55054">AUDIO_GETWRITETIMEOUT</a>:
<a name="l00651"></a>00651         *lvp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aaae10bb3cbf8306530ae3e176cab04cf" title="Write timeout.">dcb_wtmo</a>;
<a name="l00652"></a>00652         <span class="keywordflow">break</span>;
<a name="l00653"></a>00653     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gaaf34e4126556aa90089b58e5bbff5f0a">AUDIO_BEEP</a>:
<a name="l00654"></a>00654         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>) {
<a name="l00655"></a>00655             dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a48c8962adcb252c6092a87a5ac034d2c" title="Requested beep frequency.">dcb_sinefreq</a> = *((<a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> *) conf);
<a name="l00656"></a>00656             dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga7f0e0b6f52a30c87fb9e161b5ef58c9b" title="Sine wave test.">VSREQ_BEEP</a>;
<a name="l00657"></a>00657             <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>);
<a name="l00658"></a>00658         } <span class="keywordflow">else</span> {
<a name="l00659"></a>00659             rc = -1;
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661         <span class="keywordflow">break</span>;
<a name="l00662"></a>00662     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gaace7dfeb0b358dded58abf0e4a980478" title="Retrieve decoder capabilities.">AUDIO_GET_DECCAPS</a>:
<a name="l00663"></a>00663         <span class="comment">/* Retrieve decoder capabilities. */</span>
<a name="l00664"></a>00664         *lvp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aa4d8ddeabd5ba00d0c64ba7521ea2f4a" title="Decoder capabilities.">dcb_dec_caps</a>;
<a name="l00665"></a>00665         <span class="keywordflow">break</span>;
<a name="l00666"></a>00666     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gab8e3bb8c50217995eea4129e47c41eae" title="Retrieve encoder capabilities.">AUDIO_GET_CODCAPS</a>:
<a name="l00667"></a>00667         <span class="comment">/* Retrieve encoder capabilities. */</span>
<a name="l00668"></a>00668         *lvp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a0adfc11ddfa95711df123b595e6c6d98" title="Encoder capabilities.">dcb_cod_caps</a>;
<a name="l00669"></a>00669         <span class="keywordflow">break</span>;
<a name="l00670"></a>00670     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#gaa20240344bf4858a9920980091eb584e" title="Retrieve midi capabilities.">AUDIO_GET_MIDCAPS</a>:
<a name="l00671"></a>00671         <span class="comment">/* Retrieve midi capabilities. */</span>
<a name="l00672"></a>00672         *lvp = dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4de2225304a26f355dbb5c292a2ef6f1" title="MIDI capabilities.">dcb_midi_caps</a>;
<a name="l00673"></a>00673         <span class="keywordflow">break</span>;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 <span class="preprocessor">#if 0</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga8eb42f4b694df9ba15c59207291c3fa5" title="Retrieve decoder information.">AUDIO_GET_DECINFO</a>:
<a name="l00677"></a>00677         <span class="comment">/* Retrieve decoder information. */</span>
<a name="l00678"></a>00678         <span class="keywordflow">break</span>;
<a name="l00679"></a>00679     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga71f83400d22d7deb032497844f25f48b" title="Retrieve encoder information.">AUDIO_GET_CODINFO</a>:
<a name="l00680"></a>00680         <span class="comment">/* Retrieve encoder information. */</span>
<a name="l00681"></a>00681         <span class="keywordflow">break</span>;
<a name="l00682"></a>00682     <span class="keywordflow">case</span> <a class="code" href="group__xg_helix_codec.html#ga788d785a053ed11e38594867344780e5" title="Retrieve midi information.">AUDIO_GET_MIDINFO</a>:
<a name="l00683"></a>00683         <span class="comment">/* Retrieve midi information. */</span>
<a name="l00684"></a>00684         <span class="keywordflow">break</span>;
<a name="l00685"></a>00685 <span class="preprocessor">#endif</span>
<a name="l00686"></a>00686 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="group__xg_vs_codec.html#ga8310e44d9b28f95434b3508c7d1b2eb4" title="Upload plug-in.">AUDIO_PLUGIN_UPLOAD</a>:
<a name="l00687"></a>00687         rc = VsCodecLoadPlugIn(dev, (<a class="code" href="struct___v_s___p_l_u_g_i_n___i_n_f_o.html">VS_PLUGIN_INFO</a> *) conf);
<a name="l00688"></a>00688         <span class="keywordflow">break</span>;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="keywordflow">default</span>:
<a name="l00691"></a>00691         rc = (*dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#abc1cfbf55943e7780272338544eb1b56">dcb_control</a>)(req, conf);
<a name="l00692"></a>00692         <span class="keywordflow">break</span>;
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694     <span class="keywordflow">return</span> rc;
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 
<a name="l00709"></a>00709 <span class="keyword">static</span> <span class="keywordtype">int</span> VsDecoderBufferFlush(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tmo)
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711     <span class="keywordtype">int</span> rc = 0;
<a name="l00712"></a>00712     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <span class="keywordflow">for</span> (;;) {
<a name="l00715"></a>00715         <span class="comment">/* Keep the player running if the buffer contains data. */</span>
<a name="l00716"></a>00716         <span class="keywordflow">if</span> (<a class="code" href="group__xg_bank_mem.html#gacc5a7121fca5d27017c4d9f851a90475" title="Return the used buffer space.">NutSegBufUsed</a>()) {
<a name="l00717"></a>00717             <a class="code" href="group__xg_vs_codec.html#ga0dfdf6b6c0b6284c60cb2b5714e70763" title="Handle I/O controls for audio codec.">VsCodecIOCtl</a>(dev, <a class="code" href="group__xg_helix_codec.html#gaf75bd0f8fec1efbe0e896a830e3b6084" title="Immediately start playing.">AUDIO_PLAY</a>, NULL);
<a name="l00718"></a>00718         }
<a name="l00719"></a>00719         <span class="comment">/* No data in buffer. If idle, then we are done. */</span>
<a name="l00720"></a>00720         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>) {
<a name="l00721"></a>00721             <span class="comment">/* No data and player is idle. */</span>
<a name="l00722"></a>00722             <span class="keywordflow">break</span>;
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724         <span class="comment">/* Wait for a new buffer update. */</span>
<a name="l00725"></a>00725         rc = <a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>, tmo);
<a name="l00726"></a>00726         <span class="keywordflow">if</span> (rc) {
<a name="l00727"></a>00727             <span class="keywordflow">break</span>;
<a name="l00728"></a>00728         }
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="keywordflow">return</span> rc;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00746"></a><a class="code" href="group__xg_vs_codec.html#ga888783673f8461806a1e9fca5b12e92e">00746</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga888783673f8461806a1e9fca5b12e92e" title="Read from the encoder.">VsCodecRead</a>(<a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a> * nfp, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> len)
<a name="l00747"></a>00747 {
<a name="l00748"></a>00748     <span class="keywordtype">int</span> rc = 0;
<a name="l00749"></a>00749     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *bp;
<a name="l00750"></a>00750     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *dp;
<a name="l00751"></a>00751     <span class="keywordtype">size_t</span> rbytes;
<a name="l00752"></a>00752     <a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev;
<a name="l00753"></a>00753     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     dev = nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab2f35ab91ee2a28023be41bb03b8db5b" title="Device containing this file.">nf_dev</a>;
<a name="l00756"></a>00756     dcb = dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="comment">/* Flush buffer if data pointer is a NULL pointer. */</span>
<a name="l00759"></a>00759     <span class="keywordflow">if</span> (data == NULL || len == 0) {
<a name="l00760"></a>00760         <span class="keywordflow">return</span> 0;
<a name="l00761"></a>00761     }
<a name="l00762"></a>00762     <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gae617586ed1ccf27121ca932e8955efcc">CODEC_STATUS_PLAYING</a>) {
<a name="l00763"></a>00763         <span class="comment">/* Cannot read decoder data. */</span>
<a name="l00764"></a>00764         <span class="keywordflow">return</span> -1;
<a name="l00765"></a>00765     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a450db443d2351887de345a91b78f86ae" title="Playback status.">dcb_pbstat</a> == <a class="code" href="group__xg_helix_codec.html#gad2afa8a293c6c194442943510240dc81">CODEC_STATUS_IDLE</a>) {
<a name="l00766"></a>00766         <span class="comment">/* Start recording if idle. */</span>
<a name="l00767"></a>00767         <span class="keywordflow">if</span> (dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#ad11962bb376d04f5ccfd2b436d5f6bb6" title="Encoder mode.">dcb_cod_mode</a> &amp; <a class="code" href="group__xg_vs_codec.html#gab1597592df2d30f6345f2d8027d031d7">AUDIO_FMT_VORBIS</a>) {
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769         dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a6a2e802e13807e2f1ad1c97523b0336d" title="Requested command flags, see VSREQ_ flags.">dcb_scmd</a> |= <a class="code" href="group__xg_vs_codec.html#ga246288d78f86589c4513b34006205fa3" title="Start recording.">VSREQ_RECORD</a>;
<a name="l00770"></a>00770         <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>);
<a name="l00771"></a>00771     }
<a name="l00772"></a>00772     dp = data;
<a name="l00773"></a>00773     <span class="keywordflow">while</span> (len) {
<a name="l00774"></a>00774         <span class="comment">/* Retrieve new data from the input buffer. */</span>
<a name="l00775"></a>00775         bp = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) <a class="code" href="group__xg_bank_mem.html#gac9fb2d54037da348dfc6a9c99b47e75f" title="Request segmented buffer space for reading.">NutSegBufReadRequest</a>(&amp;rbytes);
<a name="l00776"></a>00776         <span class="keywordflow">if</span> (rbytes) {
<a name="l00777"></a>00777             <span class="keywordflow">if</span> (rbytes &gt; len) {
<a name="l00778"></a>00778                 rbytes = len;
<a name="l00779"></a>00779             }
<a name="l00780"></a>00780             <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(dp, bp, rbytes);
<a name="l00781"></a>00781             <a class="code" href="group__xg_bank_mem.html#gad9e27e0283495409f46e25e794286b4b" title="Commit written buffer space and finish read access.">NutSegBufReadLast</a>(rbytes);
<a name="l00782"></a>00782             <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>);
<a name="l00783"></a>00783             len -= rbytes;
<a name="l00784"></a>00784             rc += rbytes;
<a name="l00785"></a>00785             dp += rbytes;
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787         <span class="comment">/* Wait for data. */</span>
<a name="l00788"></a>00788         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a97f62b85293b58fa22042b36e7118007" title="Read timeout.">dcb_rtmo</a>)) {
<a name="l00789"></a>00789             <span class="comment">/* Read timeout. */</span>
<a name="l00790"></a>00790             <span class="keywordflow">break</span>;
<a name="l00791"></a>00791         }
<a name="l00792"></a>00792     }
<a name="l00793"></a>00793     <span class="keywordflow">return</span> rc;
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00809"></a><a class="code" href="group__xg_vs_codec.html#ga2a731a44c0041cde2759c3549eacb62f">00809</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga2a731a44c0041cde2759c3549eacb62f" title="Write to decoder.">VsCodecWrite</a>(<a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a> * nfp, <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> len)
<a name="l00810"></a>00810 {
<a name="l00811"></a>00811     <span class="keywordtype">int</span> rc = 0;
<a name="l00812"></a>00812     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *bp;
<a name="l00813"></a>00813     <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *dp;
<a name="l00814"></a>00814     <span class="keywordtype">size_t</span> rbytes;
<a name="l00815"></a>00815     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab2f35ab91ee2a28023be41bb03b8db5b" title="Device containing this file.">nf_dev</a>-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="comment">/* Flush buffer if data pointer is a NULL pointer. */</span>
<a name="l00818"></a>00818     <span class="keywordflow">if</span> (data == NULL || len == 0) {
<a name="l00819"></a>00819         <span class="keywordflow">return</span> VsDecoderBufferFlush(nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab2f35ab91ee2a28023be41bb03b8db5b" title="Device containing this file.">nf_dev</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aaae10bb3cbf8306530ae3e176cab04cf" title="Write timeout.">dcb_wtmo</a>);
<a name="l00820"></a>00820     }
<a name="l00821"></a>00821     dp = data;
<a name="l00822"></a>00822     <span class="keywordflow">while</span> (len) {
<a name="l00823"></a>00823         bp = (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *)<a class="code" href="group__xg_bank_mem.html#ga5dca6c51548e7ee90dc79cddaa1668fd" title="Request segmented buffer space for writing.">NutSegBufWriteRequest</a>(&amp;rbytes);
<a name="l00824"></a>00824         <span class="keywordflow">if</span> (rbytes == 0) {
<a name="l00825"></a>00825             <span class="comment">/* No buffer space, wait for change. */</span>
<a name="l00826"></a>00826             <span class="keywordflow">if</span> (<a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a4abb0bad4fe2bd4c8ebfbcdfbae783f4" title="Buffer change event.">dcb_bufque</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aaae10bb3cbf8306530ae3e176cab04cf" title="Write timeout.">dcb_wtmo</a>)) {
<a name="l00827"></a>00827                 <span class="comment">/* Write timeout. */</span>
<a name="l00828"></a>00828                 <span class="keywordflow">break</span>;
<a name="l00829"></a>00829             }
<a name="l00830"></a>00830         } <span class="keywordflow">else</span> {
<a name="l00831"></a>00831             <span class="keywordflow">if</span> (rbytes &gt; len) {
<a name="l00832"></a>00832                 rbytes = len;
<a name="l00833"></a>00833             }
<a name="l00834"></a>00834             <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(bp, dp, rbytes);
<a name="l00835"></a>00835             <a class="code" href="group__xg_bank_mem.html#ga435c70799400cd3fab9b305d9e83987c" title="Commit written buffer space and finish write access.">NutSegBufWriteLast</a>(rbytes);
<a name="l00836"></a>00836             <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#a787647b9d314997104ee21eeb88bd77c" title="Decoder hungry event.">dcb_feedme</a>);
<a name="l00837"></a>00837             len -= rbytes;
<a name="l00838"></a>00838             rc += rbytes;
<a name="l00839"></a>00839             dp += rbytes;
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842     <span class="keywordflow">return</span> rc;
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="preprocessor">#ifdef __HARVARD_ARCH__</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span>
<a name="l00868"></a><a class="code" href="group__xg_vs_codec.html#ga3ad46e0080a3d8a4d601bd344ea8da0c">00868</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#ga3ad46e0080a3d8a4d601bd344ea8da0c" title="Write program data to decoder.">VsCodecWrite_P</a>(<a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a> * nfp, <a class="code" href="arm_8h.html#a963f816fc88a5d8479c285ed4c630229">PGM_P</a> buffer, <span class="keywordtype">int</span> len)
<a name="l00869"></a>00869 {
<a name="l00870"></a>00870     <span class="keywordflow">return</span> -1;
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 <span class="preprocessor">#endif</span>
<a name="l00873"></a>00873 <span class="preprocessor"></span>
<a name="l00874"></a>00874 <span class="comment">/*</span>
<a name="l00875"></a>00875 <span class="comment"> * Open codec stream.</span>
<a name="l00876"></a>00876 <span class="comment"> */</span>
<a name="l00877"></a><a class="code" href="group__xg_vs_codec.html#ga7c69e552333967834aa20ec7cd293bb9">00877</a> <a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a> *<a class="code" href="group__xg_vs_codec.html#ga7c69e552333967834aa20ec7cd293bb9">VsCodecOpen</a>(<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> * dev, <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> acc)
<a name="l00878"></a>00878 {
<a name="l00879"></a>00879     <a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a> *nfp;
<a name="l00880"></a>00880     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="preprocessor">#if defined(VS_SW_RESET_ON_OPEN)</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>    <a class="code" href="group__xg_vs_codec.html#ga8e4e11e7781779bb088876926261a206" title="Read and modify VLSI audio codec mode flags.">VsCodecMode</a>(dev, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>, <a class="code" href="group__xg_vs1001.html#ga1dd90d648012b0c03acbd773f06f1419">VS_SM_RESET</a>);
<a name="l00884"></a>00884 <span class="preprocessor">#endif</span>
<a name="l00885"></a>00885 <span class="preprocessor"></span>
<a name="l00886"></a>00886     dcb = dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00887"></a>00887     <span class="keywordflow">if</span> (mode &amp; <a class="code" href="group__xg_crt_lowio.html#gac58f7734ab4dd8ae25bda2fba713ea56">_O_WRONLY</a>) {
<a name="l00888"></a>00888         <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> on = 1;
<a name="l00889"></a>00889         <span class="comment">/* Decoder. */</span>
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (<a class="code" href="group__xg_vs_codec.html#ga0dfdf6b6c0b6284c60cb2b5714e70763" title="Handle I/O controls for audio codec.">VsCodecIOCtl</a>(dev, <a class="code" href="group__xg_vs_codec.html#ga8fed6c57b09d32f02fe0180b50cb2e35" title="Enable interrupts.">AUDIO_IRQ_ENABLE</a>, &amp;on)) {
<a name="l00891"></a>00891             <span class="keywordflow">return</span> NULL;
<a name="l00892"></a>00892         }
<a name="l00893"></a>00893     } <span class="keywordflow">else</span> {
<a name="l00894"></a>00894         <span class="comment">/* Encoder. */</span>
<a name="l00895"></a>00895         <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#gaafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(name, <span class="stringliteral">&quot;vorbis&quot;</span>) == 0) {
<a name="l00896"></a>00896             dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#ad11962bb376d04f5ccfd2b436d5f6bb6" title="Encoder mode.">dcb_cod_mode</a> = <a class="code" href="group__xg_vs_codec.html#gab1597592df2d30f6345f2d8027d031d7">AUDIO_FMT_VORBIS</a>;
<a name="l00897"></a>00897         } <span class="keywordflow">else</span> {
<a name="l00898"></a>00898             dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#ad11962bb376d04f5ccfd2b436d5f6bb6" title="Encoder mode.">dcb_cod_mode</a> = <a class="code" href="group__xg_vs_codec.html#ga2053f1bfabbe7147b2408779e04e0ff5">AUDIO_FMT_WAV_IMA_ADPCM</a>;
<a name="l00899"></a>00899         }
<a name="l00900"></a>00900     }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902     nfp = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a>));
<a name="l00903"></a>00903     <span class="keywordflow">if</span> (nfp) {
<a name="l00904"></a>00904         nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#a3622b9d9a960280a147bd3548f2cfb19" title="Link to the next file structure.">nf_next</a> = NULL;
<a name="l00905"></a>00905         nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab2f35ab91ee2a28023be41bb03b8db5b" title="Device containing this file.">nf_dev</a> = dev;
<a name="l00906"></a>00906         nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab3291b1d7ce574c521ade39622c6f290" title="Device specific file control block.">nf_fcb</a> = NULL;
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908     <a class="code" href="group__xg_bank_mem.html#ga59e6535d66539f29aed5909eb0b70eed" title="Reset the segmented buffer.">NutSegBufReset</a>();
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="keywordflow">return</span> nfp;
<a name="l00911"></a>00911 }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913 <span class="comment">/*</span>
<a name="l00914"></a>00914 <span class="comment"> * Close codec stream.</span>
<a name="l00915"></a>00915 <span class="comment"> */</span>
<a name="l00916"></a><a class="code" href="group__xg_vs_codec.html#gada0927a9dba1ef21d0ef36814fe3213f">00916</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_vs_codec.html#gada0927a9dba1ef21d0ef36814fe3213f">VsCodecClose</a>(<a class="code" href="struct___n_u_t_f_i_l_e.html" title="File structure.">NUTFILE</a> * nfp)
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918     <a class="code" href="struct___v_s_d_c_b.html" title="Internal codec control block.">VSDCB</a> *dcb = nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab2f35ab91ee2a28023be41bb03b8db5b" title="Device containing this file.">nf_dev</a>-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <span class="keywordtype">int</span> rc = VsDecoderBufferFlush(nfp-&gt;<a class="code" href="struct___n_u_t_f_i_l_e.html#ab2f35ab91ee2a28023be41bb03b8db5b" title="Device containing this file.">nf_dev</a>, dcb-&gt;<a class="code" href="struct___v_s_d_c_b.html#aaae10bb3cbf8306530ae3e176cab04cf" title="Write timeout.">dcb_wtmo</a>);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="keywordflow">if</span> (nfp) {
<a name="l00923"></a>00923         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(nfp);
<a name="l00924"></a>00924     }
<a name="l00925"></a>00925     <span class="keywordflow">return</span> rc;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="spi__vscodec_8c.html">spi_vscodec.c</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
