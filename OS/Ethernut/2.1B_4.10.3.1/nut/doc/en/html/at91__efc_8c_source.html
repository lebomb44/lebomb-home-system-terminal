<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: arch/arm/dev/atmel/at91_efc.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS
   &#160;<span id="projectnumber">4.10.3</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('at91__efc_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">at91_efc.c</div>  </div>
</div>
<div class="contents">
<a href="at91__efc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2006 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;<a class="code" href="memory_8h.html" title="Default memory layout.">cfg/memory.h</a>&gt;</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#include &lt;<a class="code" href="sys_2atom_8h.html">sys/atom.h</a>&gt;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;<a class="code" href="nvmem_8h.html" title="Header file for non-volatile memory access.">dev/nvmem.h</a>&gt;</span>
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;<a class="code" href="stdint_8h.html">stdint.h</a>&gt;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;<a class="code" href="arch_2arm_2atmel_2at91__efc_8h.html">arch/arm/atmel/at91_efc.h</a>&gt;</span>
<a name="l00069"></a>00069 
<a name="l00074"></a>00074 
<a name="l00077"></a>00077 <span class="preprocessor">#ifndef EFC_CHIP_BASE</span>
<a name="l00078"></a><a class="code" href="group__xg_at91_efc.html#gaf9a83c4161707d5da96c540056cb1abe">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define EFC_CHIP_BASE  0x00100000</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00083"></a>00083 <span class="preprocessor">#ifndef EFC_CHIP_SIZE</span>
<a name="l00084"></a><a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define EFC_CHIP_SIZE  0x00040000</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>
<a name="l00095"></a>00095 <span class="preprocessor">#ifndef FLASH_CONF_SECTOR</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="preprocessor">#if defined(MCU_AT91SAM7S512) || defined(MCU_AT91SAM7SE512) || \</span>
<a name="l00097"></a>00097 <span class="preprocessor">    defined(MCU_AT91SAM7X512) || defined(MCU_AT91SAM9XE512)</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor">#define FLASH_CONF_SECTOR  0x0007FF00</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00100"></a><a class="code" href="group__xg_at91_efc.html#ga595dfd7b134ea9a53694d15d1257e8bb">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define FLASH_CONF_SECTOR  0x0003FF00</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00113"></a>00113 <span class="preprocessor">#ifndef FLASH_CONF_SIZE</span>
<a name="l00114"></a><a class="code" href="group__xg_at91_efc.html#ga8e065f9b904e53143ae888c7fda42f05">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define FLASH_CONF_SIZE         256</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>
<a name="l00117"></a>00117 <span class="preprocessor">#ifndef EFC_WRITE_WAIT</span>
<a name="l00118"></a><a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define EFC_WRITE_WAIT        60000</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a>00121 <span class="preprocessor">#ifndef EFC_ERASE_WAIT</span>
<a name="l00122"></a><a class="code" href="group__xg_at91_efc.html#ga7a3ed6877610ac4176f796797374aba3">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define EFC_ERASE_WAIT        60000</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>
<a name="l00125"></a>00125 <span class="preprocessor">#ifndef EFC_CHIP_ERASE_WAIT</span>
<a name="l00126"></a><a class="code" href="group__xg_at91_efc.html#ga99ad0865f9250e6ce5912641a5488b52">00126</a> <span class="preprocessor"></span><span class="preprocessor">#define EFC_CHIP_ERASE_WAIT   600000</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>
<a name="l00129"></a>00129 
<a name="l00130"></a><a class="code" href="group__xg_at91_efc.html#ga4675bd1d7d87956594ce6fa5a4e26390">00130</a> <span class="keyword">typedef</span> <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="group__xg_at91_efc.html#ga4675bd1d7d87956594ce6fa5a4e26390">flashdat_t</a>;
<a name="l00131"></a><a class="code" href="group__xg_at91_efc.html#gac0623a540fa40efe5ef5aab73db3b29b">00131</a> <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="group__xg_at91_efc.html#gac0623a540fa40efe5ef5aab73db3b29b">flashadr_t</a>;
<a name="l00132"></a><a class="code" href="group__xg_at91_efc.html#gab4cbfef5302d042e1e56bf34c497422a">00132</a> <span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="group__xg_at91_efc.html#ga4675bd1d7d87956594ce6fa5a4e26390">flashdat_t</a> *<a class="code" href="group__xg_at91_efc.html#gab4cbfef5302d042e1e56bf34c497422a">flashptr_t</a>;
<a name="l00133"></a>00133 
<a name="l00140"></a><a class="code" href="group__xg_at91_efc.html#ga6315a1e14f08e327ae62aa2c98ab0049">00140</a> <a class="code" href="arm_8h.html#aef8a9ac028b813702d0b053b4c14b25e">RAMFUNC</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#ga6315a1e14f08e327ae62aa2c98ab0049" title="Execute flash controller command.">At91EfcCmdEx</a>(<span class="keywordtype">int</span> fci, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cmd, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tmo)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     <span class="keywordtype">int</span> rc = 0;
<a name="l00143"></a>00143     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fsr;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="comment">/* Make sure that the previous command has finished. */</span>
<a name="l00146"></a>00146     <span class="keywordflow">while</span> ((<a class="code" href="arm_8h.html#a50deead5ad7d2cf1f5321bd84543e382">inr</a>(fci ? <a class="code" href="at91__mc_8h.html#a3f9cd69afff29c36f7d83f69f02409eb" title="MC flash mode register bank 1 address.">MC_FSR_EFC1</a>: <a class="code" href="at91__mc_8h.html#a22d07a4f2eb7545d2f8eea47e06dd041" title="MC flash mode register bank 0 address.">MC_FSR_EFC0</a>) &amp; <a class="code" href="at91__mc_8h.html#abab16ad095e72a70b9cfb5c6bcd2e252" title="Flash ready.">MC_FRDY</a>) == 0) {
<a name="l00147"></a>00147         <span class="keywordflow">if</span> (tmo &amp;&amp; --tmo &lt; 1) {
<a name="l00148"></a>00148             <span class="keywordflow">return</span> -1;
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="comment">/* IRQ handlers are located in flash. Disable them. */</span>
<a name="l00153"></a>00153     <a class="code" href="arch_2arm_2atom_8h.html#a87280d882ea631ee08df697179c5d9ad">NutEnterCritical</a>();
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="comment">/* Write command. */</span>
<a name="l00156"></a>00156     <a class="code" href="arm_8h.html#a8f6bb1dce3338ad7f49a57f3156a0c96">outr</a>(fci ? <a class="code" href="at91__mc_8h.html#a50297a692881fcb114adaf8ff3d1eaa0" title="MC flash mode register bank 1 address.">MC_FCR_EFC1</a> : <a class="code" href="at91__mc_8h.html#abc4a27f9198743dbacbaa2a456822ff6" title="MC flash mode register bank 0 address.">MC_FCR_EFC0</a>, <a class="code" href="at91__mc_8h.html#ab6128b471c32396326cc345d386658cc" title="Writing protect key.">MC_KEY</a> | cmd);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="comment">/* Wait for ready flag set. */</span>
<a name="l00159"></a>00159     <span class="keywordflow">while</span> (((fsr = <a class="code" href="arm_8h.html#a50deead5ad7d2cf1f5321bd84543e382">inr</a>(fci ? <a class="code" href="at91__mc_8h.html#a3f9cd69afff29c36f7d83f69f02409eb" title="MC flash mode register bank 1 address.">MC_FSR_EFC1</a> : MC_FSR_EFC0)) &amp; MC_FRDY) == 0) {
<a name="l00160"></a>00160         <span class="keywordflow">if</span> (tmo &amp;&amp; --tmo &lt; 1) {
<a name="l00161"></a>00161             rc = -1;
<a name="l00162"></a>00162             <span class="keywordflow">break</span>;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="comment">/* Flash command finished. Re-enable IRQ handlers. */</span>
<a name="l00167"></a>00167     <a class="code" href="arch_2arm_2atom_8h.html#a06e861b2acb2eb533dd1928acdd868d9">NutExitCritical</a>();
<a name="l00168"></a>00168 
<a name="l00169"></a>00169     <span class="comment">/* Check result. */</span>
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (fsr &amp; (<a class="code" href="at91__mc_8h.html#a8bd1dea305dfc93a031ecb52f052d8b0" title="Lock error.">MC_LOCKE</a> | <a class="code" href="at91__mc_8h.html#a9f66d5a24d156e5859f83af684271e0c" title="Programming error.">MC_PROGE</a>)) {
<a name="l00171"></a>00171         rc = -1;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <span class="keywordflow">return</span> rc;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00182"></a><a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503">00182</a> <a class="code" href="arm_8h.html#aef8a9ac028b813702d0b053b4c14b25e">RAMFUNC</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503" title="Execute flash controller command.">At91EfcCmd</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cmd, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tmo)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184     <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#ga6315a1e14f08e327ae62aa2c98ab0049" title="Execute flash controller command.">At91EfcCmdEx</a>(0, cmd, tmo);
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00196"></a><a class="code" href="group__xg_at91_efc.html#ga2d623df273e1ea7cf78f106452d34ba3">00196</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#ga2d623df273e1ea7cf78f106452d34ba3" title="Read data from flash memory.">At91EfcSectorRead</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> off, <span class="keywordtype">void</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len)
<a name="l00197"></a>00197 {
<a name="l00198"></a>00198     <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(data, (<span class="keywordtype">void</span> *) (<a class="code" href="nut__types_8h.html#a831c0774de8c5ae75b53d20fce88ce6d" title="Unsigned pointer value type.">uptr_t</a>) (<a class="code" href="group__xg_at91_efc.html#gaf9a83c4161707d5da96c540056cb1abe" title="Base address of the flash memory chip.">EFC_CHIP_BASE</a> + off), len);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">return</span> 0;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00215"></a><a class="code" href="group__xg_at91_efc.html#gadc029df0303c39750db82268a4f69d82">00215</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#gadc029df0303c39750db82268a4f69d82" title="Write data into flash memory.">At91EfcSectorWrite</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> off, <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217     <a class="code" href="group__xg_at91_efc.html#gab4cbfef5302d042e1e56bf34c497422a">flashptr_t</a> dp = (<a class="code" href="group__xg_at91_efc.html#gab4cbfef5302d042e1e56bf34c497422a">flashptr_t</a>) (<a class="code" href="nut__types_8h.html#a831c0774de8c5ae75b53d20fce88ce6d" title="Unsigned pointer value type.">uptr_t</a>) (<a class="code" href="group__xg_at91_efc.html#gaf9a83c4161707d5da96c540056cb1abe" title="Base address of the flash memory chip.">EFC_CHIP_BASE</a> + off);
<a name="l00218"></a>00218     <span class="keywordtype">int</span> rc;
<a name="l00219"></a>00219     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (data) {
<a name="l00222"></a>00222         <a class="code" href="group__xg_at91_efc.html#gab4cbfef5302d042e1e56bf34c497422a">flashptr_t</a> sp = (<a class="code" href="group__xg_at91_efc.html#gab4cbfef5302d042e1e56bf34c497422a">flashptr_t</a>) data;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224         <span class="comment">/* Copy data to the flash write buffer. */</span>
<a name="l00225"></a>00225         <span class="keywordflow">for</span> (i = 0; i &lt; len; i += <span class="keyword">sizeof</span>(<a class="code" href="group__xg_at91_efc.html#ga4675bd1d7d87956594ce6fa5a4e26390">flashdat_t</a>)) {
<a name="l00226"></a>00226             *dp++ = *sp++;
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229     <span class="keywordflow">else</span> {
<a name="l00230"></a>00230         <span class="comment">/* All bits set to emulate sector erasing. */</span>
<a name="l00231"></a>00231         <span class="keywordflow">for</span> (i = 0; i &lt; len; i += <span class="keyword">sizeof</span>(<a class="code" href="group__xg_at91_efc.html#ga4675bd1d7d87956594ce6fa5a4e26390">flashdat_t</a>)) {
<a name="l00232"></a>00232             *dp++ = (<a class="code" href="group__xg_at91_efc.html#ga4675bd1d7d87956594ce6fa5a4e26390">flashdat_t</a>)(-1);
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (off &lt; <a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff" title="Size handled by each controller.">EFC_CHIP_SIZE</a>) {
<a name="l00237"></a>00237         <span class="comment">/* Clear NEBP in mode register for automatic erasure. */</span>
<a name="l00238"></a>00238         <a class="code" href="arm_8h.html#a8f6bb1dce3338ad7f49a57f3156a0c96">outr</a>(<a class="code" href="at91__mc_8h.html#a56e71c1eef6133561636a2dad91b5121" title="MC flash mode register address.">MC_FMR</a>, (i = <a class="code" href="arm_8h.html#a50deead5ad7d2cf1f5321bd84543e382">inr</a>(<a class="code" href="at91__mc_8h.html#a56e71c1eef6133561636a2dad91b5121" title="MC flash mode register address.">MC_FMR</a>)) &amp; ~<a class="code" href="at91__mc_8h.html#ab92c3057f71f2f4dd2b5ce8227df312d" title="No erase before programming.">MC_NEBP</a>);
<a name="l00239"></a>00239         <span class="comment">/* Execute page write command. */</span>
<a name="l00240"></a>00240         rc = <a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503" title="Execute flash controller command.">At91EfcCmd</a>((off &amp; <a class="code" href="at91__mc_8h.html#afce8b3033d0417b4979eadd8de5ba774" title="Page number mask.">MC_PAGEN_MASK</a>) | <a class="code" href="at91__mc_8h.html#a7276dd0e62348c88321b4ad4b9a266ac" title="Write page.">MC_FCMD_WP</a>, <a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">EFC_WRITE_WAIT</a>);
<a name="l00241"></a>00241         <span class="comment">/* Restore mode register. */</span>
<a name="l00242"></a>00242         <a class="code" href="arm_8h.html#a8f6bb1dce3338ad7f49a57f3156a0c96">outr</a>(<a class="code" href="at91__mc_8h.html#a56e71c1eef6133561636a2dad91b5121" title="MC flash mode register address.">MC_FMR</a>, i);
<a name="l00243"></a>00243     } <span class="keywordflow">else</span> {
<a name="l00244"></a>00244         <span class="comment">/* Clear NEBP in mode register for automatic erasure. */</span>
<a name="l00245"></a>00245         <a class="code" href="arm_8h.html#a8f6bb1dce3338ad7f49a57f3156a0c96">outr</a>(<a class="code" href="at91__mc_8h.html#a472b61edfe8c1cefe23c9baba5882c88" title="MC flash mode register bank 1 address.">MC_FMR_EFC1</a>, (i = <a class="code" href="arm_8h.html#a50deead5ad7d2cf1f5321bd84543e382">inr</a>(<a class="code" href="at91__mc_8h.html#a472b61edfe8c1cefe23c9baba5882c88" title="MC flash mode register bank 1 address.">MC_FMR_EFC1</a>)) &amp; ~<a class="code" href="at91__mc_8h.html#ab92c3057f71f2f4dd2b5ce8227df312d" title="No erase before programming.">MC_NEBP</a>);
<a name="l00246"></a>00246         <span class="comment">/* Execute page write command. */</span>
<a name="l00247"></a>00247         rc = <a class="code" href="group__xg_at91_efc.html#ga6315a1e14f08e327ae62aa2c98ab0049" title="Execute flash controller command.">At91EfcCmdEx</a>(1, ((off - <a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff" title="Size handled by each controller.">EFC_CHIP_SIZE</a>) &amp; <a class="code" href="at91__mc_8h.html#afce8b3033d0417b4979eadd8de5ba774" title="Page number mask.">MC_PAGEN_MASK</a>) | <a class="code" href="at91__mc_8h.html#a7276dd0e62348c88321b4ad4b9a266ac" title="Write page.">MC_FCMD_WP</a>, <a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">EFC_WRITE_WAIT</a>);
<a name="l00248"></a>00248         <span class="comment">/* Restore mode register. */</span>
<a name="l00249"></a>00249         <a class="code" href="arm_8h.html#a8f6bb1dce3338ad7f49a57f3156a0c96">outr</a>(<a class="code" href="at91__mc_8h.html#a472b61edfe8c1cefe23c9baba5882c88" title="MC flash mode register bank 1 address.">MC_FMR_EFC1</a>, i);
<a name="l00250"></a>00250     }
<a name="l00251"></a>00251     <span class="keywordflow">return</span> rc;
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00257"></a><a class="code" href="group__xg_at91_efc.html#ga44eceeb3eefc83d58368dddb92e706d4">00257</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#ga44eceeb3eefc83d58368dddb92e706d4" title="Erase sector at the specified offset.">At91EfcSectorErase</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> off)
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259     <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#gadc029df0303c39750db82268a4f69d82" title="Write data into flash memory.">At91EfcSectorWrite</a>(off, NULL, 256);
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00269"></a><a class="code" href="group__xg_at91_efc.html#gadf838420be2862f0cc0967678b6a851a">00269</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#gadf838420be2862f0cc0967678b6a851a" title="Lock specified region.">At91EfcRegionLock</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> off)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (off &lt; <a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff" title="Size handled by each controller.">EFC_CHIP_SIZE</a>) {
<a name="l00272"></a>00272         <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503" title="Execute flash controller command.">At91EfcCmd</a>((off &amp; <a class="code" href="at91__mc_8h.html#afce8b3033d0417b4979eadd8de5ba774" title="Page number mask.">MC_PAGEN_MASK</a>) | <a class="code" href="at91__mc_8h.html#aadc861a424dc809b3f6c9e4a527d8ad6" title="Set lock bit.">MC_FCMD_SLB</a>, <a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">EFC_WRITE_WAIT</a>);
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274     off -= <a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff" title="Size handled by each controller.">EFC_CHIP_SIZE</a>;
<a name="l00275"></a>00275     <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503" title="Execute flash controller command.">At91EfcCmd</a>((off &amp; <a class="code" href="at91__mc_8h.html#afce8b3033d0417b4979eadd8de5ba774" title="Page number mask.">MC_PAGEN_MASK</a>) | <a class="code" href="at91__mc_8h.html#aadc861a424dc809b3f6c9e4a527d8ad6" title="Set lock bit.">MC_FCMD_SLB</a>, <a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">EFC_WRITE_WAIT</a>);
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00285"></a><a class="code" href="group__xg_at91_efc.html#ga88dd492ad5906d8775958dfa32ace2a5">00285</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#ga88dd492ad5906d8775958dfa32ace2a5" title="Unlock specified region.">At91EfcRegionUnlock</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> off)
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287     <span class="keywordflow">if</span> (off &lt; <a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff" title="Size handled by each controller.">EFC_CHIP_SIZE</a>) {
<a name="l00288"></a>00288         <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503" title="Execute flash controller command.">At91EfcCmd</a>((off &amp; <a class="code" href="at91__mc_8h.html#afce8b3033d0417b4979eadd8de5ba774" title="Page number mask.">MC_PAGEN_MASK</a>) | <a class="code" href="at91__mc_8h.html#ade6b7a313805fa6db71fed0725abbd8c" title="Clear lock bit.">MC_FCMD_CLB</a>, <a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">EFC_WRITE_WAIT</a>);
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290     off -= <a class="code" href="group__xg_at91_efc.html#gaa55641d8aa3a2b5382cb001061bd11ff" title="Size handled by each controller.">EFC_CHIP_SIZE</a>;
<a name="l00291"></a>00291     <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#gaa023dac60c83ca0a115a78a09d1d7503" title="Execute flash controller command.">At91EfcCmd</a>((off &amp; <a class="code" href="at91__mc_8h.html#afce8b3033d0417b4979eadd8de5ba774" title="Page number mask.">MC_PAGEN_MASK</a>) | <a class="code" href="at91__mc_8h.html#ade6b7a313805fa6db71fed0725abbd8c" title="Clear lock bit.">MC_FCMD_CLB</a>, <a class="code" href="group__xg_at91_efc.html#ga964def6c49245ddd99a5f95deada9983">EFC_WRITE_WAIT</a>);
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00305"></a><a class="code" href="group__xg_at91_efc.html#gade437bc357f6a11778bb746aad15ab73">00305</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#gade437bc357f6a11778bb746aad15ab73" title="Load configuration parameters from embedded flash memory.">At91EfcParamRead</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos, <span class="keywordtype">void</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307     <span class="keywordflow">return</span> <a class="code" href="group__xg_at91_efc.html#ga2d623df273e1ea7cf78f106452d34ba3" title="Read data from flash memory.">At91EfcSectorRead</a>(<a class="code" href="group__xg_at91_efc.html#ga595dfd7b134ea9a53694d15d1257e8bb" title="Address offset of the configuration sector.">FLASH_CONF_SECTOR</a> + pos, data, len);
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00324"></a><a class="code" href="group__xg_at91_efc.html#ga4a417f5fa6cb2544033200d4c16c40e0">00324</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_at91_efc.html#ga4a417f5fa6cb2544033200d4c16c40e0" title="Store configuration parameters in embedded flash memory.">At91EfcParamWrite</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pos, <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">void</span> *data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326     <span class="keywordtype">int</span> rc = -1;
<a name="l00327"></a>00327     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *buff;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="comment">/* Load the complete configuration area. */</span>
<a name="l00330"></a>00330     <span class="keywordflow">if</span> ((buff = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<a class="code" href="group__xg_at91_efc.html#ga8e065f9b904e53143ae888c7fda42f05" title="Size of the configuration area.">FLASH_CONF_SIZE</a>)) != NULL) {
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         rc = <a class="code" href="group__xg_at91_efc.html#ga2d623df273e1ea7cf78f106452d34ba3" title="Read data from flash memory.">At91EfcSectorRead</a>(<a class="code" href="group__xg_at91_efc.html#ga595dfd7b134ea9a53694d15d1257e8bb" title="Address offset of the configuration sector.">FLASH_CONF_SECTOR</a>, buff, <a class="code" href="group__xg_at91_efc.html#ga8e065f9b904e53143ae888c7fda42f05" title="Size of the configuration area.">FLASH_CONF_SIZE</a>);
<a name="l00333"></a>00333         <span class="comment">/* Compare old with new contents. */</span>
<a name="l00334"></a>00334         <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#ga135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(buff + pos, data, len)) {
<a name="l00335"></a>00335             <span class="comment">/* New contents differs. Copy it into the sector buffer. */</span>
<a name="l00336"></a>00336             <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(buff + pos, data, len);
<a name="l00337"></a>00337             <span class="comment">/* Write back new data. Maintain region lock. */</span>
<a name="l00338"></a>00338             <span class="keywordflow">if</span> (<a class="code" href="group__xg_at91_efc.html#ga88dd492ad5906d8775958dfa32ace2a5" title="Unlock specified region.">At91EfcRegionUnlock</a>(<a class="code" href="group__xg_at91_efc.html#ga595dfd7b134ea9a53694d15d1257e8bb" title="Address offset of the configuration sector.">FLASH_CONF_SECTOR</a>) == 0) {
<a name="l00339"></a>00339                 rc = <a class="code" href="group__xg_at91_efc.html#gadc029df0303c39750db82268a4f69d82" title="Write data into flash memory.">At91EfcSectorWrite</a>(<a class="code" href="group__xg_at91_efc.html#ga595dfd7b134ea9a53694d15d1257e8bb" title="Address offset of the configuration sector.">FLASH_CONF_SECTOR</a>, buff, <a class="code" href="group__xg_at91_efc.html#ga8e065f9b904e53143ae888c7fda42f05" title="Size of the configuration area.">FLASH_CONF_SIZE</a>);
<a name="l00340"></a>00340                 <a class="code" href="group__xg_at91_efc.html#gadf838420be2862f0cc0967678b6a851a" title="Lock specified region.">At91EfcRegionLock</a>(<a class="code" href="group__xg_at91_efc.html#ga595dfd7b134ea9a53694d15d1257e8bb" title="Address offset of the configuration sector.">FLASH_CONF_SECTOR</a>);
<a name="l00341"></a>00341             }
<a name="l00342"></a>00342         }
<a name="l00343"></a>00343         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(buff);
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345     <span class="keywordflow">return</span> rc;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="at91__efc_8c.html">at91_efc.c</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
