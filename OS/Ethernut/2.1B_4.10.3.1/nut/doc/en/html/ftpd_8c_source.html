<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: pro/ftpd.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS
   &#160;<span id="projectnumber">4.10.3</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ftpd_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ftpd.c</div>  </div>
</div>
<div class="contents">
<a href="ftpd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2005 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 
<a name="l00094"></a>00094 <span class="comment">//#define FTPD_DEBUG</span>
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#include &lt;<a class="code" href="version_8h.html">sys/version.h</a>&gt;</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html" title="UDP and TCP socket interface definitions.">sys/socket.h</a>&gt;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#include &lt;<a class="code" href="netinet_2tcp_8h.html" title="TCP protocol definitions.">netinet/tcp.h</a>&gt;</span>
<a name="l00100"></a>00100 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00103"></a>00103 <span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<a name="l00107"></a>00107 <span class="preprocessor">#include &lt;<a class="code" href="stat_8h.html" title="File system status declarations.">sys/stat.h</a>&gt;</span>
<a name="l00108"></a>00108 <span class="preprocessor">#include &lt;<a class="code" href="dirent_8h.html" title="Filesystem directory structure.">dirent.h</a>&gt;</span>
<a name="l00109"></a>00109 <span class="preprocessor">#include &lt;<a class="code" href="unistd_8h.html" title="Miscellaneous function declarations.">unistd.h</a>&gt;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 <span class="preprocessor">#include &lt;<a class="code" href="ftpd_8h.html" title="FTP protocol definitions for daemons.">pro/ftpd.h</a>&gt;</span>
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="heap_8h.html" title="Heap management definitions.">sys/heap.h</a>&gt;</span>
<a name="l00116"></a>00116 <span class="preprocessor">#endif</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>
<a name="l00124"></a>00124 
<a name="l00131"></a>00131 
<a name="l00137"></a>00137 <span class="preprocessor">#ifndef FTP_ROOTPATH</span>
<a name="l00138"></a><a class="code" href="group__xg_f_t_p_d.html#ga7c5a64c63f20eb3e3ebab183895a8081">00138</a> <span class="preprocessor"></span><span class="preprocessor">#define FTP_ROOTPATH &quot;PNUT:&quot;</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>
<a name="l00146"></a>00146 <span class="preprocessor">#ifndef FTP_DATA_PORT</span>
<a name="l00147"></a><a class="code" href="group__xg_f_t_p_d.html#ga972c1b4b37ca75e1e499e91617a3e40b">00147</a> <span class="preprocessor"></span><span class="preprocessor">#define FTP_DATA_PORT   20</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>
<a name="l00152"></a>00152 <span class="keyword">static</span> <span class="keywordtype">char</span> *ftp_root;
<a name="l00153"></a>00153 <span class="keyword">static</span> <span class="keywordtype">char</span> *ftp_user;
<a name="l00154"></a>00154 <span class="keyword">static</span> <span class="keywordtype">char</span> *ftp_pass;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="comment">/*</span>
<a name="l00157"></a>00157 <span class="comment"> * On Harvard architectures constant strings are stored in ROM,</span>
<a name="l00158"></a>00158 <span class="comment"> * because RAM is usually a scarce resource on these platforms.</span>
<a name="l00159"></a>00159 <span class="comment"> */</span>
<a name="l00160"></a>00160 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_cwd_P[] = <span class="stringliteral">&quot;CWD&quot;</span>;
<a name="l00161"></a>00161 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_dele_P[] = <span class="stringliteral">&quot;DELE&quot;</span>;
<a name="l00162"></a>00162 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_list_P[] = <span class="stringliteral">&quot;LIST&quot;</span>;
<a name="l00163"></a>00163 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_mkd_P[] = <span class="stringliteral">&quot;MKD&quot;</span>;
<a name="l00164"></a>00164 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_xmkd_P[] = <span class="stringliteral">&quot;XMKD&quot;</span>;
<a name="l00165"></a>00165 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_nlst_P[] = <span class="stringliteral">&quot;NLST&quot;</span>;
<a name="l00166"></a>00166 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_noop_P[] = <span class="stringliteral">&quot;NOOP&quot;</span>;
<a name="l00167"></a>00167 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_pass_P[] = <span class="stringliteral">&quot;PASS&quot;</span>;
<a name="l00168"></a>00168 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_pasv_P[] = <span class="stringliteral">&quot;PASV&quot;</span>;
<a name="l00169"></a>00169 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_port_P[] = <span class="stringliteral">&quot;PORT&quot;</span>;
<a name="l00170"></a>00170 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_pwd_P[] = <span class="stringliteral">&quot;PWD&quot;</span>;
<a name="l00171"></a>00171 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_xpwd_P[] = <span class="stringliteral">&quot;XPWD&quot;</span>;
<a name="l00172"></a>00172 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_quit_P[] = <span class="stringliteral">&quot;QUIT&quot;</span>;
<a name="l00173"></a>00173 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_retr_P[] = <span class="stringliteral">&quot;RETR&quot;</span>;
<a name="l00174"></a>00174 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_rmd_P[] = <span class="stringliteral">&quot;RMD&quot;</span>;
<a name="l00175"></a>00175 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_xrmd_P[] = <span class="stringliteral">&quot;XRMD&quot;</span>;
<a name="l00176"></a>00176 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_stor_P[] = <span class="stringliteral">&quot;STOR&quot;</span>;
<a name="l00177"></a>00177 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_syst_P[] = <span class="stringliteral">&quot;SYST&quot;</span>;
<a name="l00178"></a>00178 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_type_P[] = <span class="stringliteral">&quot;TYPE&quot;</span>;
<a name="l00179"></a>00179 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_user_P[] = <span class="stringliteral">&quot;USER&quot;</span>;
<a name="l00180"></a>00180 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_rename1_P[] = <span class="stringliteral">&quot;RNFR&quot;</span>;
<a name="l00181"></a>00181 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> cmd_rename2_P[] = <span class="stringliteral">&quot;RNTO&quot;</span>;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="keyword">static</span> <span class="keywordtype">char</span> *mon_name = <span class="stringliteral">&quot;JanFebMarAprMayJunJulAugSepOctNovDec&quot;</span>;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> rep_banner[] = <span class="stringliteral">&quot;220 Nut/OS FTP %s ready at %.3s%3d %02d:%02d:%02d\r\n&quot;</span>;
<a name="l00187"></a>00187 
<a name="l00200"></a>00200 <span class="keyword">static</span> <span class="keywordtype">void</span> SplitCmdArg(<span class="keywordtype">char</span> * line, <span class="keywordtype">char</span> ** cmd, <span class="keywordtype">char</span> ** args)
<a name="l00201"></a>00201 {
<a name="l00202"></a>00202     <span class="comment">/* Skip leading spaces. */</span>
<a name="l00203"></a>00203     <span class="keywordflow">while</span> (*line &amp;&amp; *line &lt;= <span class="charliteral">&#39; &#39;</span>) {
<a name="l00204"></a>00204         line++;
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <span class="comment">/* The first word is the command. Convert it to upper case. */</span>
<a name="l00208"></a>00208     *cmd = line;
<a name="l00209"></a>00209     <span class="keywordflow">while</span> (*line &gt; <span class="charliteral">&#39; &#39;</span>) {
<a name="l00210"></a>00210         <span class="keywordflow">if</span> (*line &gt;= (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <span class="charliteral">&#39;a&#39;</span> &amp;&amp; *line &lt;= (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <span class="charliteral">&#39;z&#39;</span>) {
<a name="l00211"></a>00211             *line -= (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) <span class="charliteral">&#39;a&#39;</span> - <span class="charliteral">&#39;A&#39;</span>;
<a name="l00212"></a>00212         }
<a name="l00213"></a>00213         line++;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="comment">/* Mark end of the command word. */</span>
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (*line) {
<a name="l00218"></a>00218         *line++ = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="comment">/* Skip spaces. */</span>
<a name="l00222"></a>00222     <span class="keywordflow">while</span> (*line &amp;&amp; *line &lt;= <span class="charliteral">&#39; &#39;</span>) {
<a name="l00223"></a>00223         ++line;
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="comment">/* Arguments start here. */</span>
<a name="l00227"></a>00227     *args = line;
<a name="l00228"></a>00228     <span class="keywordflow">while</span> (*line &amp;&amp; *line != <span class="charliteral">&#39;\r&#39;</span> &amp;&amp; *line != <span class="charliteral">&#39;\n&#39;</span>) {
<a name="l00229"></a>00229         line++;
<a name="l00230"></a>00230     }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="comment">/* Mark end of arguments. */</span>
<a name="l00233"></a>00233     *line = 0;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00251"></a>00251 <span class="keyword">static</span> <span class="keywordtype">int</span> ParseIpPort(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> * arg, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> * <a class="code" href="structip.html" title="Structure of an internet header.">ip</a>, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> * port)
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <span class="keywordtype">int</span> rc;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     *ip = 0;
<a name="l00256"></a>00256     *port = 0;
<a name="l00257"></a>00257     <span class="keywordflow">for</span> (rc = 0; rc &lt; 6; rc++) {
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (*arg &lt; &#39;0&#39; || *arg &gt; <span class="charliteral">&#39;9&#39;</span>) {
<a name="l00259"></a>00259             <span class="keywordflow">break</span>;
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (rc &lt; 4) {
<a name="l00262"></a>00262             *ip &gt;&gt;= 8;
<a name="l00263"></a>00263             *ip += <a class="code" href="group__xg_crt_std_lib.html#ga609881e6043f1810014e7c3333639e61" title="Convert string to long integer.">atol</a>(arg) &lt;&lt; 24;
<a name="l00264"></a>00264         } <span class="keywordflow">else</span> {
<a name="l00265"></a>00265             *port &lt;&lt;= 8;
<a name="l00266"></a>00266             *port += <a class="code" href="group__xg_crt_std_lib.html#ga21f1bd8c533a44073a5b9f1a0a1f9fac" title="Convert string to integer.">atoi</a>(arg);
<a name="l00267"></a>00267         }
<a name="l00268"></a>00268         <span class="keywordflow">while</span> (*arg &amp;&amp; *arg != <span class="charliteral">&#39;,&#39;</span>) {
<a name="l00269"></a>00269             arg++;
<a name="l00270"></a>00270         }
<a name="l00271"></a>00271         <span class="keywordflow">if</span> (*arg == <span class="charliteral">&#39;,&#39;</span>) {
<a name="l00272"></a>00272             arg++;
<a name="l00273"></a>00273         }
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     <span class="keywordflow">return</span> rc;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00287"></a><a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de">00287</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">int</span> code)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> fmt_P[] = <span class="stringliteral">&quot;%d OK\r\n&quot;</span>;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&lt;&#39;%d OK&#39; &quot;</span>, code);
<a name="l00293"></a>00293 <span class="preprocessor">#endif</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, fmt_P, code);
<a name="l00295"></a>00295     <a class="code" href="group__xg_crt_stdio.html#gadb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297     <span class="keywordflow">return</span> 0;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00309"></a><a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632">00309</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">int</span> code)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> fmt_P[] = <span class="stringliteral">&quot;%d Failed\r\n&quot;</span>;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&lt;&#39;%d Failed&#39; &quot;</span>, code);
<a name="l00315"></a>00315 <span class="preprocessor">#endif</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, fmt_P, code);
<a name="l00317"></a>00317     <a class="code" href="group__xg_crt_stdio.html#gadb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     <span class="keywordflow">return</span> 0;
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00331"></a><a class="code" href="group__xg_f_t_p_d.html#ga7a2c08102e2c52355561453fcb15eb5e">00331</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga7a2c08102e2c52355561453fcb15eb5e" title="Send a response including the specified transfer mode.">NutFtpSendMode</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">int</span> binary)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> intro_P[] = <span class="stringliteral">&quot;150 Opening &quot;</span>;
<a name="l00334"></a>00334     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> amode_P[] = <span class="stringliteral">&quot;ASCII.\r\n&quot;</span>;
<a name="l00335"></a>00335     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> bmode_P[] = <span class="stringliteral">&quot;BINARY.\r\n&quot;</span>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&lt;&#39;150 Opening %s&#39; &quot;</span>, binary ? <span class="stringliteral">&quot;BINARY&quot;</span> : <span class="stringliteral">&quot;ASCII&quot;</span>);
<a name="l00339"></a>00339 <span class="preprocessor">#endif</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#aa972577646c6e64c54658f123a8044c8">fputs_P</a>(intro_P, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00341"></a>00341     <a class="code" href="h8_8h.html#aa972577646c6e64c54658f123a8044c8">fputs_P</a>(binary ? bmode_P : amode_P, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00342"></a>00342     <a class="code" href="group__xg_crt_stdio.html#gadb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="keywordflow">return</span> 0;
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00367"></a><a class="code" href="group__xg_f_t_p_d.html#gaad7b7118c7f21feb01fc6db7b8b0e615">00367</a> <span class="keywordtype">char</span> *<a class="code" href="group__xg_f_t_p_d.html#gaad7b7118c7f21feb01fc6db7b8b0e615" title="Create an absolute path name.">CreateFullPathName</a>(<span class="keywordtype">char</span> *root, <span class="keywordtype">char</span> *work, <span class="keywordtype">char</span> *path)
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <span class="keywordtype">char</span> *full;
<a name="l00370"></a>00370     <span class="keywordtype">char</span> *cp;
<a name="l00371"></a>00371     <span class="keywordtype">size_t</span> rl = root ? <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(root) : 0;
<a name="l00372"></a>00372     <span class="keywordtype">size_t</span> wl = work ? <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(work) : 0;
<a name="l00373"></a>00373     <span class="keywordtype">size_t</span> pl = path ? <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(path) : 0;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="comment">/* Ignore trailing slashes in root and work. */</span>
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (rl &amp;&amp; *(root + rl - 1) == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00377"></a>00377         rl--;
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379     <span class="keywordflow">if</span> (wl &amp;&amp; *(work + wl - 1) == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00380"></a>00380         wl--;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="keywordflow">if</span> ((full = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(rl + wl + pl + 3)) != NULL) {
<a name="l00384"></a>00384         <span class="comment">/* Put the root in front. */</span>
<a name="l00385"></a>00385         cp = full;
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (rl) {
<a name="l00387"></a>00387             cp = <a class="code" href="group__xg_crt_string.html#ga5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(full, root) + rl;
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389 
<a name="l00390"></a>00390         <span class="comment">/* If path is relative, prepend the working directory. */</span>
<a name="l00391"></a>00391         <span class="keywordflow">if</span>(pl == 0 || *path != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00392"></a>00392             <span class="keywordflow">if</span> (wl) {
<a name="l00393"></a>00393                 <span class="keywordflow">if</span> (*work != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00394"></a>00394                     *cp++ = <span class="charliteral">&#39;/&#39;</span>;
<a name="l00395"></a>00395                 }
<a name="l00396"></a>00396                 cp = <a class="code" href="group__xg_crt_string.html#ga5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(cp, work) + wl;
<a name="l00397"></a>00397             }
<a name="l00398"></a>00398             *cp++ = <span class="charliteral">&#39;/&#39;</span>;
<a name="l00399"></a>00399             rl++;
<a name="l00400"></a>00400         }
<a name="l00401"></a>00401 
<a name="l00402"></a>00402         <span class="keywordflow">if</span> (pl) {
<a name="l00403"></a>00403             *cp = 0;
<a name="l00404"></a>00404             work = full + rl;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406             <span class="keywordflow">while</span> (*path) {
<a name="l00407"></a>00407                 <span class="comment">/* Ingore duplicate slashes. */</span>
<a name="l00408"></a>00408                 <span class="keywordflow">if</span> (*path == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00409"></a>00409                     <span class="comment">/* No double slash in target if we are at the root */</span>
<a name="l00410"></a>00410                     <span class="keywordflow">if</span> ((cp == full) || (*(cp-1) != <span class="charliteral">&#39;/&#39;</span>)) {
<a name="l00411"></a>00411                         *cp++ = *path++;
<a name="l00412"></a>00412                     }
<a name="l00413"></a>00413                     <span class="keywordflow">while</span> (*path == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00414"></a>00414                         path++;
<a name="l00415"></a>00415                     }
<a name="l00416"></a>00416                 }
<a name="l00417"></a>00417                 <span class="comment">/* Ignore single dots. */</span>
<a name="l00418"></a>00418                 <span class="keywordflow">if</span> (*path == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00419"></a>00419                     path++;
<a name="l00420"></a>00420                     <span class="keywordflow">if</span> (*path == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00421"></a>00421                         path++;
<a name="l00422"></a>00422                         <span class="keywordflow">continue</span>;
<a name="l00423"></a>00423                     }
<a name="l00424"></a>00424                     <span class="keywordflow">if</span> (*path == 0) {
<a name="l00425"></a>00425                         <span class="keywordflow">break</span>;
<a name="l00426"></a>00426                     }
<a name="l00427"></a>00427                     <span class="keywordflow">if</span> (*path == <span class="charliteral">&#39;.&#39;</span>) {
<a name="l00428"></a>00428                         path++;
<a name="l00429"></a>00429                         <span class="keywordflow">if</span> (*path == <span class="charliteral">&#39;/&#39;</span> || *path == 0) {
<a name="l00430"></a>00430                             <span class="keywordflow">if</span> (cp != work) {
<a name="l00431"></a>00431                                 cp--;
<a name="l00432"></a>00432                                 <span class="keywordflow">while</span> (cp != work) {
<a name="l00433"></a>00433                                     cp--;
<a name="l00434"></a>00434                                     <span class="keywordflow">if</span> (*cp == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00435"></a>00435                                         <span class="keywordflow">break</span>;
<a name="l00436"></a>00436                                     }
<a name="l00437"></a>00437                                 }
<a name="l00438"></a>00438                             }
<a name="l00439"></a>00439                             <span class="keywordflow">continue</span>;
<a name="l00440"></a>00440                         }
<a name="l00441"></a>00441                         path--;
<a name="l00442"></a>00442                     }
<a name="l00443"></a>00443                     path--;
<a name="l00444"></a>00444                 }
<a name="l00445"></a>00445                 <span class="comment">/* Copy the current path component. */</span>
<a name="l00446"></a>00446                 <span class="keywordflow">while</span> (*path &amp;&amp; *path != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00447"></a>00447                     *cp++ = *path++;
<a name="l00448"></a>00448                 }
<a name="l00449"></a>00449             }
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         *cp = 0;
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453     <span class="keywordflow">return</span> full;
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00465"></a><a class="code" href="group__xg_f_t_p_d.html#ga78bc9b7d484569dce570bf8eef609eb1">00465</a> <a class="code" href="structtcp__socket.html" title="TCP socket information structure.">TCPSOCKET</a> *<a class="code" href="group__xg_f_t_p_d.html#ga78bc9b7d484569dce570bf8eef609eb1" title="Establish an FTP connection for data transfer.">NutFtpDataConnect</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span>    <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> errorcode_P[] = <span class="stringliteral">&quot;errorcode of active socket: %i\n&quot;</span>;
<a name="l00469"></a>00469     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> socfailed_P[] = <span class="stringliteral">&quot;Create socket failed&quot;</span>;
<a name="l00470"></a>00470 <span class="preprocessor">#endif</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>    <a class="code" href="structtcp__socket.html" title="TCP socket information structure.">TCPSOCKET</a> *sock;
<a name="l00472"></a>00472     <span class="keywordtype">int</span> rc;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xg_tcp_socket.html#ga6bf8ec59828c5a0e38423293b4dfe8e6" title="Create a TCP socket.">NutTcpCreateSocket</a>()) != 0) {
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a>) {
<a name="l00477"></a>00477             <a class="code" href="group__xg_tcp_socket.html#gab3bd1c81e2046e53cde6973b9c6bf6f4" title="Set value of a TCP socket option.">NutTcpSetSockOpt</a>(sock, <a class="code" href="netinet_2tcp_8h.html#af20c12fa9bf018281e14c3b43b777e2e" title="Set maximum segment size.">TCP_MAXSEG</a>, &amp;session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a>, <span class="keyword">sizeof</span>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a>));
<a name="l00478"></a>00478         }
<a name="l00479"></a>00479         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#ad88f1bd2fa0e9bb84d2364aa33711098" title="FTP data transfer connection type.">ftp_passive</a>) {
<a name="l00480"></a>00480             rc = <a class="code" href="group__xg_tcp_socket.html#ga3859b3c38665aedc32608827f931498a" title="Wait for incoming connect from a remote socket.">NutTcpAccept</a>(sock, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#afbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a>);
<a name="l00481"></a>00481         } <span class="keywordflow">else</span> {
<a name="l00482"></a>00482             rc = <a class="code" href="group__xg_tcp_socket.html#ga48ff1e877483a0833cf38e428eac6457" title="Connect to a remote socket.">NutTcpConnect</a>(sock, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aa6a868b8985c280f0d5f6512d08e9313" title="Target IP for data transfer.">ftp_data_ip</a>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#afbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a>);
<a name="l00483"></a>00483 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (rc) {
<a name="l00485"></a>00485               <span class="keywordtype">int</span> errorcode = <a class="code" href="group__xg_tcp_socket.html#ga3953f713369f008979d738b32d8fc255" title="Return specific code of the last error.">NutTcpError</a>(sock);
<a name="l00486"></a>00486               <a class="code" href="group__xg_crt_stdio.html#ga30b0c3fa763cfd9c65416be0c3956aa1" title="Print formatted output to the standard output stream.">printf_P</a>(errorcode_P, errorcode);
<a name="l00487"></a>00487             }
<a name="l00488"></a>00488 <span class="preprocessor">#endif</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>        }
<a name="l00490"></a>00490         <span class="keywordflow">if</span> (rc) {
<a name="l00491"></a>00491             <a class="code" href="group__xg_tcp_socket.html#ga09d94fd887683a0837e06c2cc08fc7ba" title="Close TCP socket.">NutTcpCloseSocket</a>(sock);
<a name="l00492"></a>00492             sock = 0;
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
<a name="l00497"></a>00497         <a class="code" href="group__xg_crt_stdio.html#ga8263f041e271555a786c93572c45bb81" title="Write a string from program memory to stdout.">puts_P</a>(socfailed_P);
<a name="l00498"></a>00498     }
<a name="l00499"></a>00499 <span class="preprocessor">#endif</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>    <span class="keywordflow">return</span> sock;
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00516"></a><a class="code" href="group__xg_f_t_p_d.html#ga9e41cc8f252b71d222f0d79da1899eaf">00516</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga9e41cc8f252b71d222f0d79da1899eaf" title="Register the FTP server&#39;s root directory.">NutRegisterFtpRoot</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *path)
<a name="l00517"></a>00517 {
<a name="l00518"></a>00518     <span class="comment">/* Reset path to default. */</span>
<a name="l00519"></a>00519     <span class="keywordflow">if</span> (path == NULL || *path == 0) {
<a name="l00520"></a>00520         <span class="comment">/* Release previously allocate space. */</span>
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (ftp_root) {
<a name="l00522"></a>00522             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(ftp_root);
<a name="l00523"></a>00523         }
<a name="l00524"></a>00524         <span class="keywordflow">if</span> ((ftp_root = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="group__xg_f_t_p_d.html#ga7c5a64c63f20eb3e3ebab183895a8081" title="Default FTP root path.">FTP_ROOTPATH</a>))) == 0) {
<a name="l00525"></a>00525             <span class="keywordflow">return</span> -1;
<a name="l00526"></a>00526         }
<a name="l00527"></a>00527         <a class="code" href="group__xg_crt_string.html#ga5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(ftp_root, <a class="code" href="group__xg_f_t_p_d.html#ga7c5a64c63f20eb3e3ebab183895a8081" title="Default FTP root path.">FTP_ROOTPATH</a>);
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="comment">/* Set a specified path. */</span>
<a name="l00531"></a>00531     <span class="keywordflow">else</span> {
<a name="l00532"></a>00532         <span class="keywordtype">char</span> *cp = <a class="code" href="group__xg_crt_string.html#ga36feeebd3867be51852ba56dee5e53eb" title="Locate the first occurrence of a character in a string.">strchr</a>(path, <span class="charliteral">&#39;:&#39;</span>);
<a name="l00533"></a>00533         <span class="keywordtype">int</span> len = <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(path);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535         <span class="comment">/* Make sure that the path fulfills all requirements. */</span>
<a name="l00536"></a>00536         <span class="keywordflow">if</span> (len &lt; 2 || cp == 0 || (*++cp &amp;&amp; *cp != <span class="charliteral">&#39;/&#39;</span>)) {
<a name="l00537"></a>00537             <span class="keywordflow">return</span> -1;
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540         <span class="comment">/* Allocate space for new path, but preserve the current one. */</span>
<a name="l00541"></a>00541         <span class="keywordflow">if</span> ((cp = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(len + 1)) == 0) {
<a name="l00542"></a>00542             <span class="keywordflow">return</span> -1;
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545         <span class="comment">/* Take over, releasing previously allocate space. */</span>
<a name="l00546"></a>00546         <a class="code" href="group__xg_crt_string.html#ga5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(cp, path);
<a name="l00547"></a>00547         <span class="keywordflow">if</span> (ftp_root) {
<a name="l00548"></a>00548             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(ftp_root);
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550         ftp_root = cp;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         <span class="comment">/* Chop off an optional trailing slash. */</span>
<a name="l00553"></a>00553         cp = cp + <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(cp) - 1;
<a name="l00554"></a>00554         <span class="keywordflow">if</span> (*cp == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00555"></a>00555             *cp = 0;
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557     }
<a name="l00558"></a>00558     <span class="keywordflow">return</span> 0;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00576"></a><a class="code" href="group__xg_f_t_p_d.html#ga1be14e9d89556bb62edccd798e2f0713">00576</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga1be14e9d89556bb62edccd798e2f0713" title="Register an FTP user.">NutRegisterFtpUser</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *user, <a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *pass)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (ftp_user) {
<a name="l00579"></a>00579         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(ftp_user);
<a name="l00580"></a>00580         ftp_user = NULL;
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582     <span class="keywordflow">if</span> (user &amp;&amp; *user) {
<a name="l00583"></a>00583         <span class="keywordflow">if</span> ((ftp_user = <a class="code" href="group__xg_crt_string.html#ga608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(user)) == NULL) {
<a name="l00584"></a>00584             <span class="keywordflow">return</span> -1;
<a name="l00585"></a>00585         }
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587     <span class="keywordflow">if</span> (ftp_pass) {
<a name="l00588"></a>00588         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(ftp_pass);
<a name="l00589"></a>00589         ftp_pass = NULL;
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (pass &amp;&amp; *pass) {
<a name="l00592"></a>00592         <span class="keywordflow">if</span> ((ftp_pass = <a class="code" href="group__xg_crt_string.html#ga608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(pass)) == NULL) {
<a name="l00593"></a>00593             <span class="keywordflow">return</span> -1;
<a name="l00594"></a>00594         }
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596     <span class="keywordflow">return</span> 0;
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 
<a name="l00609"></a><a class="code" href="group__xg_f_t_p_d.html#ga9c2f592b2642d2091ea274362d2ed6bc">00609</a> <a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> *<a class="code" href="group__xg_f_t_p_d.html#ga9c2f592b2642d2091ea274362d2ed6bc" title="Open an FTP server session.">NutFtpOpenSession</a>(<a class="code" href="structtcp__socket.html" title="TCP socket information structure.">TCPSOCKET</a> * sock)
<a name="l00610"></a>00610 {
<a name="l00611"></a>00611     <a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> *session;
<a name="l00612"></a>00612 
<a name="l00613"></a>00613     session = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a>));
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (session) {
<a name="l00616"></a>00616         <a class="code" href="group__xg_crt_string.html#gaa4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(session, 0, <span class="keyword">sizeof</span>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a>));
<a name="l00617"></a>00617         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#afbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a> = <a class="code" href="group__xg_f_t_p_d.html#ga972c1b4b37ca75e1e499e91617a3e40b" title="Default data port.">FTP_DATA_PORT</a>;
<a name="l00618"></a>00618         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aba138dc804a1f7e0bc3b4efe7698715d" title="Maximum TCP segment size for data transfer.">ftp_maxseg</a> = sock-&gt;<a class="code" href="structtcp__socket.html#a83b24869cd4abe48b29688ed0a827ece" title="MSS, limited by remote option or MTU.">so_mss</a>;
<a name="l00619"></a>00619         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a1e1535376ca70046a6b58fe3ca889261" title="Telnet socket of this session.">ftp_sock</a> = sock;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         <span class="comment">/* Set initial working directory. */</span>
<a name="l00622"></a>00622         <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a> = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(2)) == 0) {
<a name="l00623"></a>00623             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session);
<a name="l00624"></a>00624             session = 0;
<a name="l00625"></a>00625         } <span class="keywordflow">else</span> {
<a name="l00626"></a>00626             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>[0] = <span class="charliteral">&#39;/&#39;</span>;
<a name="l00627"></a>00627             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>[1] = 0;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629             <span class="comment">/*</span>
<a name="l00630"></a>00630 <span class="comment">             * Open a stream and associate it with the socket, so</span>
<a name="l00631"></a>00631 <span class="comment">             * we can use standard I/O. Note, that socket streams</span>
<a name="l00632"></a>00632 <span class="comment">             * currently do support text mode.</span>
<a name="l00633"></a>00633 <span class="comment">             */</span>
<a name="l00634"></a>00634             <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a> = <a class="code" href="group__xg_crt_stdio.html#ga907a98011e3468d951740abecb768685" title="Open a stream associated with a file, device or socket descriptor.">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">&quot;r+b&quot;</span>)) == 0) {
<a name="l00635"></a>00635                 <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00636"></a>00636                 <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session);
<a name="l00637"></a>00637                 session = 0;
<a name="l00638"></a>00638             }
<a name="l00639"></a>00639         }
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641     <span class="keywordflow">return</span> session;
<a name="l00642"></a>00642 }
<a name="l00643"></a>00643 
<a name="l00650"></a><a class="code" href="group__xg_f_t_p_d.html#ga4e8a0adc4680aa66e9d4d17fdc6e985d">00650</a> <span class="keywordtype">void</span> <a class="code" href="group__xg_f_t_p_d.html#ga4e8a0adc4680aa66e9d4d17fdc6e985d" title="Close an FTP server session.">NutFtpCloseSession</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <span class="keywordflow">if</span> (session) {
<a name="l00653"></a>00653         <span class="comment">/* Close the stream. */</span>
<a name="l00654"></a>00654         <a class="code" href="group__xg_crt_stdio.html#ga76370407f9ab0402564c2bb9bc9664e0" title="Close a stream.">fclose</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l00655"></a>00655         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>) {
<a name="l00656"></a>00656             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00657"></a>00657         }
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>) {
<a name="l00659"></a>00659             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>);
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session);
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00675"></a><a class="code" href="group__xg_f_t_p_d.html#ga6fe36e83d24072ff6fb7940252c51a6e">00675</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga6fe36e83d24072ff6fb7940252c51a6e" title="Process an FTP client&#39;s CWD command.">NutFtpProcessCwd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00676"></a>00676 {
<a name="l00677"></a>00677     <span class="keyword">struct </span><a class="code" href="structstat.html" title="File status structure.">stat</a> st;
<a name="l00678"></a>00678     <span class="keywordtype">char</span> *cp = path + <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(ftp_root);
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     <span class="keywordflow">if</span> (*cp &amp;&amp; <a class="code" href="group__xg_crt_string.html#gaafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(cp, <span class="stringliteral">&quot;/&quot;</span>)) {
<a name="l00681"></a>00681         <span class="comment">/*</span>
<a name="l00682"></a>00682 <span class="comment">         * Check, if the path exists and if this is a directory.</span>
<a name="l00683"></a>00683 <span class="comment">         */</span>
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga91b48d99128dd507e20c8adcc22deeb2" title="Get information about a specified file.">stat</a>(path, &amp;st) || !<a class="code" href="group__xg_f_s.html#ga70b64ed67c0ab484b4ba09487da34e91" title="Check for directory.">S_ISDIR</a>(st.<a class="code" href="structstat.html#a2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a>)) {
<a name="l00685"></a>00685             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689     <span class="comment">/*</span>
<a name="l00690"></a>00690 <span class="comment">     * Store the new working directory excluding our root part.</span>
<a name="l00691"></a>00691 <span class="comment">     */</span>
<a name="l00692"></a>00692     <span class="keywordflow">if</span> (*cp == 0) {
<a name="l00693"></a>00693         cp = <span class="stringliteral">&quot;/&quot;</span>;
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>) {
<a name="l00696"></a>00696         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698     <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a> = <a class="code" href="group__xg_crt_string.html#ga608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(cp)) == NULL) {
<a name="l00699"></a>00699         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 250);
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00716"></a><a class="code" href="group__xg_f_t_p_d.html#ga8c45cdbeb27a773812a7eb6cca53125b">00716</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga8c45cdbeb27a773812a7eb6cca53125b" title="Process an FTP client&#39;s DELE command.">NutFtpProcessDelete</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#gaf5b5161e115b870e4c19cf3bbb6ed02d" title="Remove a file entry.">unlink</a>(path)) {
<a name="l00719"></a>00719         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 250);
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00741"></a><a class="code" href="group__xg_f_t_p_d.html#ga80900fe10a1f7780a461127c77850275">00741</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga80900fe10a1f7780a461127c77850275" title="Transfer a file to or from the FTP client.">NutFtpTransferFile</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l00742"></a>00742 {
<a name="l00743"></a>00743 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span>    <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> dataconnectfailed_P[] = <span class="stringliteral">&quot;NutFtpDataConnect failed&quot;</span>;
<a name="l00745"></a>00745 <span class="preprocessor">#endif</span>
<a name="l00746"></a>00746 <span class="preprocessor"></span>    <a class="code" href="structtcp__socket.html" title="TCP socket information structure.">TCPSOCKET</a> *sock;
<a name="l00747"></a>00747     <span class="keywordtype">int</span> ec = 550;
<a name="l00748"></a>00748     <span class="keywordtype">int</span> fh = -1;
<a name="l00749"></a>00749     <span class="comment">/* Open the file to send. */</span>
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (mode) {
<a name="l00751"></a>00751         <span class="comment">/* Some clients open file as directorys. Giving them a direct failure */</span>
<a name="l00752"></a>00752         <span class="keyword">struct </span><a class="code" href="structstat.html" title="File status structure.">stat</a> st;
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga91b48d99128dd507e20c8adcc22deeb2" title="Get information about a specified file.">stat</a>(path, &amp;st) == 0) {
<a name="l00754"></a>00754             <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#gabf68371159fa46b5cc47d0f3ac9ab723" title="Check for regular file.">S_ISREG</a>(st.<a class="code" href="structstat.html#a2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a>)) {
<a name="l00755"></a>00755                 fh = <a class="code" href="group__xg_crt_lowio.html#gaa5b9fe6f8778481971c2e23a38348bb1" title="Open a file.">_open</a>(path, <a class="code" href="group__xg_crt_lowio.html#ga166a079a4990ddeb0a32475728bbacd0">_O_BINARY</a> | <a class="code" href="group__xg_crt_lowio.html#ga4d457d93039cb26f27461c4af5868309">_O_RDONLY</a>);
<a name="l00756"></a>00756             } <span class="keywordflow">else</span> {
<a name="l00757"></a>00757 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>               <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Not a regular file\n&quot;</span>);
<a name="l00759"></a>00759 <span class="preprocessor">#endif</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span>            }
<a name="l00761"></a>00761         } <span class="keywordflow">else</span> {
<a name="l00762"></a>00762 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00763"></a>00763 <span class="preprocessor"></span>            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;&#39;%s&#39; stat() failed\n&quot;</span>, path);
<a name="l00764"></a>00764 <span class="preprocessor">#endif</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>        }
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767     <span class="comment">/* Open the file to receive. */</span>
<a name="l00768"></a>00768     <span class="keywordflow">else</span> {
<a name="l00769"></a>00769         fh = <a class="code" href="group__xg_crt_lowio.html#gaa5b9fe6f8778481971c2e23a38348bb1" title="Open a file.">_open</a>(path, <a class="code" href="group__xg_crt_lowio.html#ga774664d26ae1b1d55902562af5f1ec28">_O_CREAT</a> | <a class="code" href="group__xg_crt_lowio.html#ga695223e667532dd799a1c5b56d9eae75">_O_TRUNC</a>);
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (fh != -1) {
<a name="l00772"></a>00772         <span class="comment">/* File status OK, opening data connection */</span>
<a name="l00773"></a>00773         <a class="code" href="group__xg_f_t_p_d.html#ga7a2c08102e2c52355561453fcb15eb5e" title="Send a response including the specified transfer mode.">NutFtpSendMode</a>(session, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a37c85d318251c52398943335ada65043" title="FTP data transfer mode.">ftp_tran_mode</a>);
<a name="l00774"></a>00774         <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xg_f_t_p_d.html#ga78bc9b7d484569dce570bf8eef609eb1" title="Establish an FTP connection for data transfer.">NutFtpDataConnect</a>(session)) != 0) {
<a name="l00775"></a>00775             <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> mss = sock-&gt;<a class="code" href="structtcp__socket.html#a83b24869cd4abe48b29688ed0a827ece" title="MSS, limited by remote option or MTU.">so_mss</a>;
<a name="l00776"></a>00776             <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *buf;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778             <span class="keywordflow">if</span> (mss &lt; 256) {
<a name="l00779"></a>00779                 mss = 256;
<a name="l00780"></a>00780             }
<a name="l00781"></a>00781             <span class="keywordflow">if</span> ((buf = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(mss)) != 0) {
<a name="l00782"></a>00782                 <span class="keywordtype">int</span> got;
<a name="l00783"></a>00783 
<a name="l00784"></a>00784                 ec = 0;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786                 <span class="comment">/* Send a file. */</span>
<a name="l00787"></a>00787                 <span class="keywordflow">if</span> (mode) {
<a name="l00788"></a>00788                     <span class="keywordflow">while</span> ((got = <a class="code" href="io_8h.html#aa7278892ff16de3dd3d00ff4a89d11e4">_read</a>(fh, buf, mss)) &gt; 0) {
<a name="l00789"></a>00789                         <span class="keywordtype">int</span> send = 0;
<a name="l00790"></a>00790                         <span class="keywordtype">int</span> retcode;
<a name="l00791"></a>00791                         <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> timeout = 0;
<a name="l00792"></a>00792                         <span class="comment">/* Mentioned in inetq.c, NutTcpSend does not gurantee</span>
<a name="l00793"></a>00793 <span class="comment">                           to send all bytes, so we use a loop and do a timeout if</span>
<a name="l00794"></a>00794 <span class="comment">                           no byte has been send within two seconds. */</span>
<a name="l00795"></a>00795                         <span class="keywordflow">do</span> {
<a name="l00796"></a>00796                             retcode = <a class="code" href="group__xg_tcp_socket.html#gafc14dd4c910afbb9269adc5bebba0281" title="Send data on a connected TCP socket.">NutTcpSend</a>(sock, buf+send, got-send);
<a name="l00797"></a>00797                             send += retcode; <span class="comment">//if &lt; 0, we will leave the loop anyway</span>
<a name="l00798"></a>00798                             <span class="keywordflow">if</span> (send == 0) {
<a name="l00799"></a>00799                                 timeout++;
<a name="l00800"></a>00800                                 <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(10);
<a name="l00801"></a>00801                             } <span class="keywordflow">else</span> {
<a name="l00802"></a>00802                                 timeout = 0;
<a name="l00803"></a>00803                             }
<a name="l00804"></a>00804                         } <span class="keywordflow">while</span> ((send &lt; got ) &amp;&amp; (retcode &gt;= 0) &amp;&amp; (timeout &lt; 200));
<a name="l00805"></a>00805                         <span class="keywordflow">if</span> (retcode &lt;= 0) {
<a name="l00806"></a>00806 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span>                            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Error in NutTcpSend\n&quot;</span>);
<a name="l00808"></a>00808 <span class="preprocessor">#endif</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>                            ec = 551;
<a name="l00810"></a>00810                             <span class="keywordflow">break</span>;
<a name="l00811"></a>00811                         }
<a name="l00812"></a>00812                     }
<a name="l00813"></a>00813                 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815                 <span class="comment">/* Receive a file. */</span>
<a name="l00816"></a>00816                 <span class="keywordflow">else</span> {
<a name="l00817"></a>00817                     <span class="keywordflow">while</span> ((got = <a class="code" href="group__xg_tcp_socket.html#gab08d3e50fd09da18b966af0dd23fa4aa" title="Receive data on a connected TCP socket.">NutTcpReceive</a>(sock, buf, mss)) &gt; 0) {
<a name="l00818"></a>00818                         <span class="keywordtype">int</span> x;
<a name="l00819"></a>00819                         <span class="keywordflow">if</span> ((x = <a class="code" href="io_8h.html#a901fa187b164dd6faaac1b62c88614b5">_write</a>(fh, buf, got)) != got) {
<a name="l00820"></a>00820                             ec = 552;
<a name="l00821"></a>00821                             <span class="keywordflow">break</span>;
<a name="l00822"></a>00822                         }
<a name="l00823"></a>00823                     }
<a name="l00824"></a>00824                 }
<a name="l00825"></a>00825                 <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(buf);
<a name="l00826"></a>00826             }
<a name="l00827"></a>00827             <a class="code" href="group__xg_tcp_socket.html#ga09d94fd887683a0837e06c2cc08fc7ba" title="Close TCP socket.">NutTcpCloseSocket</a>(sock);
<a name="l00828"></a>00828         }
<a name="l00829"></a>00829 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>          <span class="keywordflow">else</span> {
<a name="l00831"></a>00831           <a class="code" href="group__xg_crt_stdio.html#ga8263f041e271555a786c93572c45bb81" title="Write a string from program memory to stdout.">puts_P</a>(dataconnectfailed_P);
<a name="l00832"></a>00832         }
<a name="l00833"></a>00833 <span class="preprocessor">#endif</span>
<a name="l00834"></a>00834 <span class="preprocessor"></span>        <a class="code" href="group__xg_crt_lowio.html#ga58a559c63748012aab165d5f82af766d" title="Close a file, device or socket.">_close</a>(fh);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836         <span class="comment">/* Remove files received with an error. */</span>
<a name="l00837"></a>00837         <span class="keywordflow">if</span> (mode == 0 &amp;&amp; ec) {
<a name="l00838"></a>00838             <a class="code" href="group__xg_f_s.html#gaf5b5161e115b870e4c19cf3bbb6ed02d" title="Remove a file entry.">unlink</a>(path);
<a name="l00839"></a>00839         }
<a name="l00840"></a>00840     }
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (ec) {
<a name="l00842"></a>00842         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, ec);
<a name="l00843"></a>00843     }
<a name="l00844"></a>00844     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 226);
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00860"></a><a class="code" href="group__xg_f_t_p_d.html#ga8048da8373cec681730f81e25269948f">00860</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga8048da8373cec681730f81e25269948f" title="Process an FTP client&#39;s LIST or NLST command.">NutFtpTransferDirectoryOptions</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> options)
<a name="l00861"></a>00861 {
<a name="l00862"></a>00862     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> fileattributes_P[] = <span class="stringliteral">&quot;rw-rw-rw-  1 0 0 %6lu &quot;</span>;
<a name="l00863"></a>00863     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> dateattribute_P[] = <span class="stringliteral">&quot;%.3s %u &quot;</span>;
<a name="l00864"></a>00864     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> timeattribute_P[] = <span class="stringliteral">&quot;%02u:%02u &quot;</span>;
<a name="l00865"></a>00865     <a class="code" href="structtcp__socket.html" title="TCP socket information structure.">TCPSOCKET</a> *sock;
<a name="l00866"></a>00866     <a class="code" href="fatfs_8h.html#a1bcda75666d51eabcbd6e14ec07da8f8">FILE</a> *fp;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="keyword">struct </span><a class="code" href="structstat.html" title="File status structure.">stat</a> st;
<a name="l00869"></a>00869     <a class="code" href="struct__dirdesc.html" title="Internally used directory information structure.">DIR</a> *dir;
<a name="l00870"></a>00870     <span class="keyword">struct </span><a class="code" href="structdirent.html" title="Directory entry structure.">dirent</a> *d_ent;
<a name="l00871"></a>00871     <a class="code" href="struct__tm.html" title="structure to store a date/time value.">tm</a> *gmt;
<a name="l00872"></a>00872     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> size;
<a name="l00873"></a>00873     <span class="keywordtype">int</span> ec = 550;
<a name="l00874"></a>00874     <span class="keywordtype">char</span> *name;
<a name="l00875"></a>00875     <span class="keywordtype">size_t</span> pathlen;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     dir = <a class="code" href="group__xg_f_s_dir.html#ga10116e941a8dfaf7e3dd345f8963fdd0" title="Open a directory stream.">opendir</a>(path);
<a name="l00878"></a>00878     <span class="keywordflow">if</span> (dir) {
<a name="l00879"></a>00879         <a class="code" href="group__xg_f_t_p_d.html#ga7a2c08102e2c52355561453fcb15eb5e" title="Send a response including the specified transfer mode.">NutFtpSendMode</a>(session, 0);
<a name="l00880"></a>00880         <span class="keywordflow">if</span> ((sock = <a class="code" href="group__xg_f_t_p_d.html#ga78bc9b7d484569dce570bf8eef609eb1" title="Establish an FTP connection for data transfer.">NutFtpDataConnect</a>(session)) != 0) {
<a name="l00881"></a>00881             <span class="keywordflow">if</span> ((fp = <a class="code" href="group__xg_crt_stdio.html#ga907a98011e3468d951740abecb768685" title="Open a stream associated with a file, device or socket descriptor.">_fdopen</a>((<span class="keywordtype">int</span>) sock, <span class="stringliteral">&quot;r+b&quot;</span>)) != 0) {
<a name="l00882"></a>00882                 ec = 0;
<a name="l00883"></a>00883                 pathlen = <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(path);
<a name="l00884"></a>00884                 <span class="keywordflow">while</span> ((d_ent = <a class="code" href="group__xg_f_s_dir.html#gae4d263c5a1d3825c9511a898762513b2" title="Get the next directory entry.">readdir</a>(dir)) != 0) {
<a name="l00885"></a>00885                     <span class="keywordflow">if</span> ((d_ent-&gt;<a class="code" href="structdirent.html#ad2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>[0] == <span class="charliteral">&#39;.&#39;</span>)  &amp;&amp; ((options &amp; 1) == 0)) {
<a name="l00886"></a>00886                         <span class="keywordflow">continue</span>;
<a name="l00887"></a>00887                     }
<a name="l00888"></a>00888                     <span class="keywordflow">if</span> ((name = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(pathlen + <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(d_ent-&gt;<a class="code" href="structdirent.html#ad2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>) + 2)) != 0) {
<a name="l00889"></a>00889                         <a class="code" href="group__xg_crt_string.html#ga5f9abaa6c5ffa26025ca901c14cb1056" title="Copy a string.">strcpy</a>(name, path);
<a name="l00890"></a>00890                         <span class="keywordflow">if</span> (pathlen == 0 || name[pathlen - 1] != <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00891"></a>00891                             <a class="code" href="group__xg_crt_string.html#gae96d8d456d5360ebbe0d588475bd6381" title="Concatenate two strings.">strcat</a>(name, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l00892"></a>00892                         }
<a name="l00893"></a>00893                         <a class="code" href="group__xg_crt_string.html#gae96d8d456d5360ebbe0d588475bd6381" title="Concatenate two strings.">strcat</a>(name, d_ent-&gt;<a class="code" href="structdirent.html#ad2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>);
<a name="l00894"></a>00894                         <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga91b48d99128dd507e20c8adcc22deeb2" title="Get information about a specified file.">stat</a>(name, &amp;st) == 0) {
<a name="l00895"></a>00895                             <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga70b64ed67c0ab484b4ba09487da34e91" title="Check for directory.">S_ISDIR</a>(st.<a class="code" href="structstat.html#a2e69cfd4e16f32cb13390523fde1772a" title="Mode flags.">st_mode</a>)) {
<a name="l00896"></a>00896                                 <a class="code" href="group__xg_crt_stdio.html#gabe6299d5823dd023e610aaa619735a3f" title="Write a character to a stream.">fputc</a>(<span class="charliteral">&#39;d&#39;</span>, fp);
<a name="l00897"></a>00897                                 size = 0;
<a name="l00898"></a>00898                             } <span class="keywordflow">else</span> {
<a name="l00899"></a>00899                                 <a class="code" href="group__xg_crt_stdio.html#gabe6299d5823dd023e610aaa619735a3f" title="Write a character to a stream.">fputc</a>(<span class="charliteral">&#39;-&#39;</span>, fp);
<a name="l00900"></a>00900                                 size = st.<a class="code" href="structstat.html#a8301352421b5d6c322caf909b8e97ae4" title="Size.">st_size</a>;
<a name="l00901"></a>00901                             }
<a name="l00902"></a>00902                             <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(fp, fileattributes_P, size);
<a name="l00903"></a>00903                             gmt = <a class="code" href="group__xg_crt_time.html#ga4bf5c1b09409b70880b839f0ff9aeb9a" title="Convert a time value to a structure.">gmtime</a>(&amp;st.<a class="code" href="structstat.html#a77e235090f8cb6897f1c0ce65689006b" title="Time of last modification.">st_mtime</a>);
<a name="l00904"></a>00904                             <span class="comment">//fprintf(fp, &quot;%s %u %u &quot;, mon_name[gmt-&gt;tm_mon], gmt-&gt;tm_mday, 1900 + gmt-&gt;tm_year);</span>
<a name="l00905"></a>00905                             <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(fp, dateattribute_P, mon_name + gmt-&gt;<a class="code" href="struct__tm.html#a5b0caaf824889c6fb03f045e6fe7ab0f" title="months since January - [0,11]">tm_mon</a> * 3, gmt-&gt;<a class="code" href="struct__tm.html#a57ccfe4f816d4c25009693f025989874" title="day of the month - [1,31]">tm_mday</a>);
<a name="l00906"></a>00906                             <span class="comment">//fprintf(fp, &quot;%02u:%02u:%02u &quot;, gmt-&gt;tm_hour, gmt-&gt;tm_min, gmt-&gt;tm_sec);</span>
<a name="l00907"></a>00907                             <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(fp, timeattribute_P, gmt-&gt;<a class="code" href="struct__tm.html#a39f017347ad46548a120eaf0ddf6a226" title="hours since midnight - [0,23]">tm_hour</a>, gmt-&gt;<a class="code" href="struct__tm.html#ab0a4136cc3488707cc7a2c4ad3a3587b" title="minutes after the hour - [0,59]">tm_min</a>);
<a name="l00908"></a>00908                             <a class="code" href="group__xg_crt_stdio.html#ga14acfae1988535199b72df91e18f72f3" title="Write a string to a stream.">fputs</a>(d_ent-&gt;<a class="code" href="structdirent.html#ad2e718a8e07b81e1aa9c4a95a25924d6" title="Name of this entry.">d_name</a>, fp);
<a name="l00909"></a>00909                             <a class="code" href="group__xg_crt_stdio.html#ga14acfae1988535199b72df91e18f72f3" title="Write a string to a stream.">fputs</a>(<span class="stringliteral">&quot;\r\n&quot;</span>, fp);
<a name="l00910"></a>00910                         }
<a name="l00911"></a>00911                         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(name);
<a name="l00912"></a>00912                     }
<a name="l00913"></a>00913                 }
<a name="l00914"></a>00914                 <a class="code" href="group__xg_crt_stdio.html#ga76370407f9ab0402564c2bb9bc9664e0" title="Close a stream.">fclose</a>(fp);
<a name="l00915"></a>00915             }
<a name="l00916"></a>00916             <a class="code" href="group__xg_tcp_socket.html#ga09d94fd887683a0837e06c2cc08fc7ba" title="Close TCP socket.">NutTcpCloseSocket</a>(sock);
<a name="l00917"></a>00917         }
<a name="l00918"></a>00918         <a class="code" href="group__xg_f_s_dir.html#gac0258906f9453b8abf03e945aa9c9676" title="Close a directory stream.">closedir</a>(dir);
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (ec) {
<a name="l00921"></a>00921         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, ec);
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 226);
<a name="l00924"></a>00924 }
<a name="l00925"></a>00925 
<a name="l00938"></a><a class="code" href="group__xg_f_t_p_d.html#gaf4296b0e186e55d915fb843f7fde9b20">00938</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gaf4296b0e186e55d915fb843f7fde9b20" title="Process an FTP client&#39;s LIST or NLST command.">NutFtpTransferDirectory</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00939"></a>00939 {
<a name="l00940"></a>00940     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8048da8373cec681730f81e25269948f" title="Process an FTP client&#39;s LIST or NLST command.">NutFtpTransferDirectoryOptions</a>(session, path, 0);
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00955"></a><a class="code" href="group__xg_f_t_p_d.html#gae85078df724a2046bfab56e88c058357">00955</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gae85078df724a2046bfab56e88c058357" title="Process an FTP client&#39;s MKD command.">NutFtpProcessMkd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00956"></a>00956 {
<a name="l00957"></a>00957     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga4d876e05d5901bd30b82c305086e0d5e" title="Create a directory entry.">mkdir</a>(path, 0777)) {
<a name="l00958"></a>00958         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l00959"></a>00959     }
<a name="l00960"></a>00960     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 257);
<a name="l00961"></a>00961 }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963 
<a name="l00964"></a><a class="code" href="group__xg_f_t_p_d.html#ga78dd6dc6c0371a2ace8f2ff4e33c9444">00964</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga78dd6dc6c0371a2ace8f2ff4e33c9444">NutFtpRenamePrepare</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00965"></a>00965 {
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>) {
<a name="l00967"></a>00967         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>);
<a name="l00968"></a>00968         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a> = NULL;
<a name="l00969"></a>00969     }
<a name="l00970"></a>00970     <span class="keywordflow">if</span> (path) {
<a name="l00971"></a>00971         <span class="keyword">struct </span><a class="code" href="structstat.html" title="File status structure.">stat</a> st;
<a name="l00972"></a>00972         <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#ga91b48d99128dd507e20c8adcc22deeb2" title="Get information about a specified file.">stat</a>(path, &amp;st) == 0) {
<a name="l00973"></a>00973             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a> = <a class="code" href="group__xg_crt_string.html#ga608db5821b635f6a719ecb7f76d4a5da" title="Create a copy of a string.">strdup</a>(path);
<a name="l00974"></a>00974             <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>) {
<a name="l00975"></a>00975                 <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 350);
<a name="l00976"></a>00976             }
<a name="l00977"></a>00977         } <span class="keywordflow">else</span> {
<a name="l00978"></a>00978           <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 450);
<a name="l00979"></a>00979         }
<a name="l00980"></a>00980     }
<a name="l00981"></a>00981     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 501);
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 
<a name="l00984"></a><a class="code" href="group__xg_f_t_p_d.html#ga68b21460a1f27307ed029da5464a0dff">00984</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga68b21460a1f27307ed029da5464a0dff">NutFtpRenameAction</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> responsebad;
<a name="l00987"></a>00987     <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>) {
<a name="l00988"></a>00988          <span class="keywordflow">if</span> (path) {
<a name="l00989"></a>00989              <span class="keywordtype">int</span> res = <a class="code" href="group__xg_f_s.html#gac52010fcf7e8443c53b263c41d9710f6" title="Rename a file.">rename</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>, path);
<a name="l00990"></a>00990              <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>);
<a name="l00991"></a>00991              session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a> = NULL;
<a name="l00992"></a>00992              <span class="keywordflow">if</span> (res == 0) {
<a name="l00993"></a>00993                  <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 250);
<a name="l00994"></a>00994              } <span class="keywordflow">else</span> {
<a name="l00995"></a>00995                  responsebad = 550;
<a name="l00996"></a>00996              }
<a name="l00997"></a>00997          } <span class="keywordflow">else</span> {
<a name="l00998"></a>00998              responsebad = 501;
<a name="l00999"></a>00999          }
<a name="l01000"></a>01000     } <span class="keywordflow">else</span> {
<a name="l01001"></a>01001          responsebad = 503;
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, responsebad);
<a name="l01004"></a>01004 }
<a name="l01005"></a>01005 
<a name="l01006"></a>01006 
<a name="l01019"></a><a class="code" href="group__xg_f_t_p_d.html#ga836d1cf7dc7ef29c929f6780477851f7">01019</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga836d1cf7dc7ef29c929f6780477851f7" title="Process an FTP client&#39;s PASS command.">NutFtpProcessPass</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *pass)
<a name="l01020"></a>01020 {
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (ftp_pass &amp;&amp; *ftp_pass) {
<a name="l01022"></a>01022         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> != 1 || <a class="code" href="group__xg_crt_string.html#gaafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(ftp_pass, pass)) {
<a name="l01023"></a>01023             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 0;
<a name="l01024"></a>01024             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l01025"></a>01025         }
<a name="l01026"></a>01026     }
<a name="l01027"></a>01027     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 2;
<a name="l01028"></a>01028     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 230);
<a name="l01029"></a>01029 }
<a name="l01030"></a>01030 
<a name="l01044"></a><a class="code" href="group__xg_f_t_p_d.html#ga3564dcac7a3f46dcf9c77c78d3318b71">01044</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga3564dcac7a3f46dcf9c77c78d3318b71" title="Process an FTP client&#39;s PASV command.">NutFtpProcessPassiv</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l01045"></a>01045 {
<a name="l01046"></a>01046     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> passiveprint_P[] = <span class="stringliteral">&quot;227 Passive (%u,%u,%u,%u,%u,%u).\r\n&quot;</span>;
<a name="l01047"></a>01047     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> ip = session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a1e1535376ca70046a6b58fe3ca889261" title="Telnet socket of this session.">ftp_sock</a>-&gt;<a class="code" href="structtcp__socket.html#ab9eca08f572d60862b4be9468bb45c2d" title="Local IP address in net byte order.">so_local_addr</a>;
<a name="l01048"></a>01048     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> port = 20;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050     <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, passiveprint_P,        <span class="comment">/* */</span>
<a name="l01051"></a>01051             (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) ip, (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ip &gt;&gt; 8), (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ip &gt;&gt; 16), (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (ip &gt;&gt; 24),  <span class="comment">/* */</span>
<a name="l01052"></a>01052             (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) (port &gt;&gt; 8), (<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>) port);
<a name="l01053"></a>01053     <a class="code" href="group__xg_crt_stdio.html#gadb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l01054"></a>01054     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#ad88f1bd2fa0e9bb84d2364aa33711098" title="FTP data transfer connection type.">ftp_passive</a> = 1;
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     <span class="keywordflow">return</span> 0;
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01073"></a><a class="code" href="group__xg_f_t_p_d.html#gacf9843833821d7c38e7c1869c8555f68">01073</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gacf9843833821d7c38e7c1869c8555f68" title="Process an FTP client&#39;s PORT command.">NutFtpProcessPort</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *args)
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075     <span class="keywordflow">if</span> (ParseIpPort(args, &amp;session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aa6a868b8985c280f0d5f6512d08e9313" title="Target IP for data transfer.">ftp_data_ip</a>, &amp;session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#afbadd16f2ebabec71dd2df464018c756" title="TCP port for data transfer.">ftp_data_port</a>) == 6) {
<a name="l01076"></a>01076         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a1e1535376ca70046a6b58fe3ca889261" title="Telnet socket of this session.">ftp_sock</a>-&gt;<a class="code" href="structtcp__socket.html#aed6cf7508dd7df21101bf588cf5779eb" title="Remote IP address in net byte order.">so_remote_addr</a> == session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#aa6a868b8985c280f0d5f6512d08e9313" title="Target IP for data transfer.">ftp_data_ip</a>) {
<a name="l01077"></a>01077             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 200);
<a name="l01078"></a>01078         }
<a name="l01079"></a>01079         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 425);
<a name="l01080"></a>01080     }
<a name="l01081"></a>01081     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 501);;
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01096"></a><a class="code" href="group__xg_f_t_p_d.html#gaa58ab5aeaa0551c2a809e2d881b9272c">01096</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gaa58ab5aeaa0551c2a809e2d881b9272c" title="Process an FTP client&#39;s PWD command.">NutFtpProcessPwd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l01097"></a>01097 {
<a name="l01098"></a>01098     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> pwdanswer_P[] = <span class="stringliteral">&quot;257 \&quot;%s\&quot;\r\n&quot;</span>;
<a name="l01099"></a>01099 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l01100"></a>01100 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&lt;&#39;257 \&quot;%s\&quot;&#39; &quot;</span>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l01101"></a>01101 <span class="preprocessor">#endif</span>
<a name="l01102"></a>01102 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, pwdanswer_P, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>);
<a name="l01103"></a>01103     <span class="keywordflow">return</span> 0;
<a name="l01104"></a>01104 }
<a name="l01105"></a>01105 
<a name="l01118"></a><a class="code" href="group__xg_f_t_p_d.html#ga7b759361ed3c5ccb69461713e1857d7e">01118</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga7b759361ed3c5ccb69461713e1857d7e" title="Process an FTP client&#39;s RMD command.">NutFtpProcessRmd</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *path)
<a name="l01119"></a>01119 {
<a name="l01120"></a>01120     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_s.html#gaa1677087a1bd3fddf6245c7079625d30" title="Remove a directory.">rmdir</a>(path)) {
<a name="l01121"></a>01121         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 451);
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 257);
<a name="l01124"></a>01124 }
<a name="l01125"></a>01125 
<a name="l01135"></a><a class="code" href="group__xg_f_t_p_d.html#ga727082f5c302cc37743c98321ace0509">01135</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga727082f5c302cc37743c98321ace0509" title="Process an FTP client&#39;s SYST command.">NutFtpProcessSystem</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session)
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137     <span class="keyword">static</span> <a class="code" href="arm_8h.html#a950231ac87ca08b098da30dc1b065c14">prog_char</a> unixtype_P[] = <span class="stringliteral">&quot;215 UNIX Type: L8\r\n&quot;</span>;
<a name="l01138"></a>01138 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l01139"></a>01139 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&lt;&#39;215 UNIX Type: L8&#39; &quot;</span>);
<a name="l01140"></a>01140 <span class="preprocessor">#endif</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#aa972577646c6e64c54658f123a8044c8">fputs_P</a>(unixtype_P, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l01142"></a>01142     <span class="keywordflow">return</span> 0;
<a name="l01143"></a>01143 }
<a name="l01144"></a>01144 
<a name="l01159"></a><a class="code" href="group__xg_f_t_p_d.html#ga09e1a0621e8b56f44b884aac05567607">01159</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga09e1a0621e8b56f44b884aac05567607" title="Process an FTP client&#39;s TYPE command.">NutFtpProcessType</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *typecode)
<a name="l01160"></a>01160 {
<a name="l01161"></a>01161     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a37c85d318251c52398943335ada65043" title="FTP data transfer mode.">ftp_tran_mode</a> = (*typecode != <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (*typecode != <span class="charliteral">&#39;a&#39;</span>);
<a name="l01162"></a>01162     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 200);
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 
<a name="l01177"></a><a class="code" href="group__xg_f_t_p_d.html#gaccd498f6cc8f1c9fe4cbc2835ea2d7cc">01177</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#gaccd498f6cc8f1c9fe4cbc2835ea2d7cc" title="Process an FTP client&#39;s USER command.">NutFtpProcessUser</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *user)
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179     <span class="keywordflow">if</span> (ftp_user &amp;&amp; *ftp_user) {
<a name="l01180"></a>01180         <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> &amp;&amp; <a class="code" href="group__xg_crt_string.html#gaafa356ff1e215725834bc57e8e4fae60" title="Compare two strings.">strcmp</a>(ftp_user, user)) {
<a name="l01181"></a>01181             session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 0;
<a name="l01182"></a>01182             <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 550);
<a name="l01183"></a>01183         }
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186     <span class="comment">/* Need a password too. */</span>
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (ftp_pass &amp;&amp; *ftp_pass) {
<a name="l01188"></a>01188         session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 1;
<a name="l01189"></a>01189         <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 331);
<a name="l01190"></a>01190     }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <span class="comment">/* No password required. */</span>
<a name="l01193"></a>01193     session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> = 2;
<a name="l01194"></a>01194     <span class="keywordflow">return</span> <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 230);
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01208"></a><a class="code" href="group__xg_f_t_p_d.html#ga5b72e2b9bea1143ace7837526d573444">01208</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga5b72e2b9bea1143ace7837526d573444" title="Process an FTP request.">NutFtpProcessRequest</a>(<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> * session, <span class="keywordtype">char</span> *request)
<a name="l01209"></a>01209 {
<a name="l01210"></a>01210     <span class="keywordtype">int</span> rc = 0;
<a name="l01211"></a>01211     <span class="keywordtype">char</span> *cmd;
<a name="l01212"></a>01212     <span class="keywordtype">char</span> *args;
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     <span class="comment">/* Split the line into command and argument part. */</span>
<a name="l01215"></a>01215     SplitCmdArg(request, &amp;cmd, &amp;args);
<a name="l01216"></a>01216 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l01217"></a>01217 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&gt;&#39;%s %s&#39; &quot;</span>, cmd, args);
<a name="l01218"></a>01218 <span class="preprocessor">#endif</span>
<a name="l01219"></a>01219 <span class="preprocessor"></span>
<a name="l01220"></a>01220     <span class="comment">/* Clean-up if rename request is incomplete */</span>
<a name="l01221"></a>01221     <span class="keywordflow">if</span> ((session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>) &amp;&amp; (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_rename2_P))) {
<a name="l01222"></a>01222           <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a>);
<a name="l01223"></a>01223           session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a80b16302ca41cf6a24c5a612f7a0c23b" title="Source file for renaming. NULL if no &quot;RNFR&quot; has been send or rename is finished.">ftp_renamesource</a> = NULL;
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225     <span class="comment">/* QUIT - Terminate session. */</span>
<a name="l01226"></a>01226     <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_quit_P) == 0) {
<a name="l01227"></a>01227         <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 221);
<a name="l01228"></a>01228         rc = -1;
<a name="l01229"></a>01229     }
<a name="l01230"></a>01230     <span class="comment">/* USER &lt;username&gt; - Check user name. */</span>
<a name="l01231"></a>01231     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_user_P) == 0) {
<a name="l01232"></a>01232         rc = <a class="code" href="group__xg_f_t_p_d.html#gaccd498f6cc8f1c9fe4cbc2835ea2d7cc" title="Process an FTP client&#39;s USER command.">NutFtpProcessUser</a>(session, args);
<a name="l01233"></a>01233     }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="comment">/* PASS &lt;password&gt; - Check user password. */</span>
<a name="l01236"></a>01236     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_pass_P) == 0) {
<a name="l01237"></a>01237         rc = <a class="code" href="group__xg_f_t_p_d.html#ga836d1cf7dc7ef29c929f6780477851f7" title="Process an FTP client&#39;s PASS command.">NutFtpProcessPass</a>(session, args);
<a name="l01238"></a>01238     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_noop_P) == 0) {
<a name="l01239"></a>01239         <a class="code" href="group__xg_f_t_p_d.html#gaedf4862063aad8c80cf50025318e25de" title="Send a positive response.">NutFtpRespondOk</a>(session, 200);
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241     <span class="comment">/* Anything else requires a successful login. */</span>
<a name="l01242"></a>01242     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a4d93e32feb28dc2807d6507f5b4ced62" title="Login status.">ftp_login</a> &lt; 2) {
<a name="l01243"></a>01243         rc = <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 530);
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     <span class="comment">/* Valid login. */</span>
<a name="l01247"></a>01247     <span class="keywordflow">else</span> {
<a name="l01248"></a>01248 
<a name="l01249"></a>01249         <span class="comment">/* PASV - Prepare passive transfer. */</span>
<a name="l01250"></a>01250         <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_pasv_P) == 0) {
<a name="l01251"></a>01251             rc = <a class="code" href="group__xg_f_t_p_d.html#ga3564dcac7a3f46dcf9c77c78d3318b71" title="Process an FTP client&#39;s PASV command.">NutFtpProcessPassiv</a>(session);
<a name="l01252"></a>01252         }
<a name="l01253"></a>01253 
<a name="l01254"></a>01254         <span class="comment">/* PORT &lt;host-port&gt; - Set data connection. */</span>
<a name="l01255"></a>01255         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_port_P) == 0) {
<a name="l01256"></a>01256             rc = <a class="code" href="group__xg_f_t_p_d.html#gacf9843833821d7c38e7c1869c8555f68" title="Process an FTP client&#39;s PORT command.">NutFtpProcessPort</a>(session, args);
<a name="l01257"></a>01257         }
<a name="l01258"></a>01258 
<a name="l01259"></a>01259         <span class="comment">/* [X]PWD - Send name of current working directory. */</span>
<a name="l01260"></a>01260         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_pwd_P) == 0 || <a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_xpwd_P) == 0) {
<a name="l01261"></a>01261             rc = <a class="code" href="group__xg_f_t_p_d.html#gaa58ab5aeaa0551c2a809e2d881b9272c" title="Process an FTP client&#39;s PWD command.">NutFtpProcessPwd</a>(session);
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264         <span class="comment">/* SYST - Send system identifier. */</span>
<a name="l01265"></a>01265         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_syst_P) == 0) {
<a name="l01266"></a>01266             rc = <a class="code" href="group__xg_f_t_p_d.html#ga727082f5c302cc37743c98321ace0509" title="Process an FTP client&#39;s SYST command.">NutFtpProcessSystem</a>(session);
<a name="l01267"></a>01267         }
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         <span class="comment">/* TYPE &lt;type-code&gt; - Receive transfer mode. */</span>
<a name="l01270"></a>01270         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_type_P) == 0) {
<a name="l01271"></a>01271             rc = <a class="code" href="group__xg_f_t_p_d.html#ga09e1a0621e8b56f44b884aac05567607" title="Process an FTP client&#39;s TYPE command.">NutFtpProcessType</a>(session, args);
<a name="l01272"></a>01272         }
<a name="l01273"></a>01273         <span class="comment">/* Commands with path name argument. */</span>
<a name="l01274"></a>01274         <span class="keywordflow">else</span> {
<a name="l01275"></a>01275             <span class="keywordtype">char</span> *path;
<a name="l01276"></a>01276             <span class="keywordtype">char</span> *argsredux = args;
<a name="l01277"></a>01277             <span class="keywordtype">int</span> options = 0;
<a name="l01278"></a>01278             <span class="keywordflow">if</span> (args[0] == <span class="charliteral">&#39;-&#39;</span>) {
<a name="l01279"></a>01279                  <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#ga36feeebd3867be51852ba56dee5e53eb" title="Locate the first occurrence of a character in a string.">strchr</a>(args, <span class="charliteral">&#39;a&#39;</span>)) {
<a name="l01280"></a>01280                    options = 1;
<a name="l01281"></a>01281                  }
<a name="l01282"></a>01282                  argsredux = <a class="code" href="group__xg_crt_string.html#ga36feeebd3867be51852ba56dee5e53eb" title="Locate the first occurrence of a character in a string.">strchr</a>(args, <span class="charliteral">&#39; &#39;</span>);
<a name="l01283"></a>01283                  <span class="keywordflow">if</span> ((argsredux) &amp;&amp; (<a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(argsredux) &gt; 0)) {
<a name="l01284"></a>01284                      argsredux++; <span class="comment">//remove space</span>
<a name="l01285"></a>01285                  } <span class="keywordflow">else</span> {
<a name="l01286"></a>01286                      argsredux = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01287"></a>01287                  }
<a name="l01288"></a>01288             }
<a name="l01289"></a>01289             <span class="keywordflow">if</span> ((path = <a class="code" href="group__xg_f_t_p_d.html#gaad7b7118c7f21feb01fc6db7b8b0e615" title="Create an absolute path name.">CreateFullPathName</a>(ftp_root, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a48b954550bf1d35d62daeef415b85886" title="Current working directory for this session.">ftp_cwd</a>, argsredux)) == 0) {
<a name="l01290"></a>01290                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 451);
<a name="l01291"></a>01291             }
<a name="l01292"></a>01292 
<a name="l01293"></a>01293             <span class="comment">/* CWD &lt;pathname&gt; - Change working directory. */</span>
<a name="l01294"></a>01294             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_cwd_P) == 0) {
<a name="l01295"></a>01295                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga6fe36e83d24072ff6fb7940252c51a6e" title="Process an FTP client&#39;s CWD command.">NutFtpProcessCwd</a>(session, path);
<a name="l01296"></a>01296             }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298             <span class="comment">/* DELE &lt;pathname&gt; - Delete a file. */</span>
<a name="l01299"></a>01299             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_dele_P) == 0) {
<a name="l01300"></a>01300                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga8c45cdbeb27a773812a7eb6cca53125b" title="Process an FTP client&#39;s DELE command.">NutFtpProcessDelete</a>(session, path);
<a name="l01301"></a>01301             }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303             <span class="comment">/* LIST | NLST [&lt;pathname&gt;] - Send list of files in a directory. */</span>
<a name="l01304"></a>01304             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_list_P) == 0 || <a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_nlst_P) == 0) {
<a name="l01305"></a>01305                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga8048da8373cec681730f81e25269948f" title="Process an FTP client&#39;s LIST or NLST command.">NutFtpTransferDirectoryOptions</a>(session, path, options);
<a name="l01306"></a>01306             }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308             <span class="comment">/* MKD &lt;pathname&gt; - Make a directory. */</span>
<a name="l01309"></a>01309             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_mkd_P) == 0 || <a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_xmkd_P) == 0) {
<a name="l01310"></a>01310                 rc = <a class="code" href="group__xg_f_t_p_d.html#gae85078df724a2046bfab56e88c058357" title="Process an FTP client&#39;s MKD command.">NutFtpProcessMkd</a>(session, path);
<a name="l01311"></a>01311             }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313             <span class="comment">/* RETR &lt;pathname&gt; - Send a file to the client. */</span>
<a name="l01314"></a>01314             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_retr_P) == 0) {
<a name="l01315"></a>01315                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga80900fe10a1f7780a461127c77850275" title="Transfer a file to or from the FTP client.">NutFtpTransferFile</a>(session, path, 1);
<a name="l01316"></a>01316             }
<a name="l01317"></a>01317 
<a name="l01318"></a>01318             <span class="comment">/* RMD &lt;pathname&gt; - Remove a directory. */</span>
<a name="l01319"></a>01319             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_rmd_P) == 0 || <a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_xrmd_P) == 0) {
<a name="l01320"></a>01320                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga7b759361ed3c5ccb69461713e1857d7e" title="Process an FTP client&#39;s RMD command.">NutFtpProcessRmd</a>(session, path);
<a name="l01321"></a>01321             }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323             <span class="comment">/* STOR &lt;pathname&gt; - Receive a file from the client. */</span>
<a name="l01324"></a>01324             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_stor_P) == 0) {
<a name="l01325"></a>01325                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga80900fe10a1f7780a461127c77850275" title="Transfer a file to or from the FTP client.">NutFtpTransferFile</a>(session, path, 0);
<a name="l01326"></a>01326             }
<a name="l01327"></a>01327             <span class="comment">/* RNFR &lt;pathname&gt; from - Rename a file on the client. */</span>
<a name="l01328"></a>01328             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_rename1_P) == 0) {
<a name="l01329"></a>01329                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga78dd6dc6c0371a2ace8f2ff4e33c9444">NutFtpRenamePrepare</a>(session, path);
<a name="l01330"></a>01330             }
<a name="l01331"></a>01331             <span class="comment">/* RNTO &lt;pathname&gt; to - Rename a file on the client. */</span>
<a name="l01332"></a>01332             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="arm_8h.html#a5caf45496d9f7b320f9cf1bb2aa6d61f">strcmp_P</a>(cmd, cmd_rename2_P) == 0) {
<a name="l01333"></a>01333                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga68b21460a1f27307ed029da5464a0dff">NutFtpRenameAction</a>(session, path);
<a name="l01334"></a>01334             }
<a name="l01335"></a>01335             <span class="comment">/* Anything else is an unknown command. */</span>
<a name="l01336"></a>01336             <span class="keywordflow">else</span> {
<a name="l01337"></a>01337                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 502);
<a name="l01338"></a>01338             }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340             <span class="keywordflow">if</span> (path) {
<a name="l01341"></a>01341                 <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(path);
<a name="l01342"></a>01342             }
<a name="l01343"></a>01343         }
<a name="l01344"></a>01344     }
<a name="l01345"></a>01345     <span class="keywordflow">return</span> rc;
<a name="l01346"></a>01346 }
<a name="l01347"></a>01347 
<a name="l01363"></a><a class="code" href="group__xg_f_t_p_d.html#ga6914104d8828e12e70984be621c87269">01363</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_f_t_p_d.html#ga6914104d8828e12e70984be621c87269" title="Process an FTP sever session.">NutFtpServerSession</a>(<a class="code" href="structtcp__socket.html" title="TCP socket information structure.">TCPSOCKET</a> * sock)
<a name="l01364"></a>01364 {
<a name="l01365"></a>01365     <span class="keywordtype">int</span> rc = 0;
<a name="l01366"></a>01366     <a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html" title="FTP session information structure.">FTPSESSION</a> *session;
<a name="l01367"></a>01367     <span class="keywordtype">char</span> *buff;
<a name="l01368"></a>01368     <a class="code" href="group__xg_crt_time.html#gae33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> now;
<a name="l01369"></a>01369     <span class="keyword">struct </span><a class="code" href="struct__tm.html" title="structure to store a date/time value.">_tm</a> *tip;
<a name="l01370"></a>01370     <span class="keywordtype">char</span> ch;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372     <span class="comment">/* Set the root path if not yet done. */</span>
<a name="l01373"></a>01373     <span class="keywordflow">if</span> (<a class="code" href="group__xg_f_t_p_d.html#ga9e41cc8f252b71d222f0d79da1899eaf" title="Register the FTP server&#39;s root directory.">NutRegisterFtpRoot</a>(ftp_root)) {
<a name="l01374"></a>01374         <span class="keywordflow">return</span> -1;
<a name="l01375"></a>01375     }
<a name="l01376"></a>01376 
<a name="l01377"></a>01377     <span class="comment">/* Allocate the command line buffer. */</span>
<a name="l01378"></a>01378     <span class="keywordflow">if</span> ((buff = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<a class="code" href="group__xg_f_t_p_d.html#ga02da6fd3b04d4e1cc0e3931b47980276" title="UDP port of DHCP server.">FTP_MAX_CMDBUF</a>)) == 0) {
<a name="l01379"></a>01379         <span class="keywordflow">return</span> -1;
<a name="l01380"></a>01380     }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382     <span class="comment">/* Create a session structure and open a stream. */</span>
<a name="l01383"></a>01383     <span class="keywordflow">if</span> ((session = <a class="code" href="group__xg_f_t_p_d.html#ga9c2f592b2642d2091ea274362d2ed6bc" title="Open an FTP server session.">NutFtpOpenSession</a>(sock)) == 0) {
<a name="l01384"></a>01384         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(buff);
<a name="l01385"></a>01385         <span class="keywordflow">return</span> -1;
<a name="l01386"></a>01386     }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388     <span class="comment">/* Send a welcome banner including system time. */</span>
<a name="l01389"></a>01389     <a class="code" href="group__xg_crt_time.html#ga26c7d1dbf93fa8c23c5effbacec91f8c" title="Get the system time.">time</a>(&amp;now);
<a name="l01390"></a>01390     tip = <a class="code" href="group__xg_crt_time.html#ga7a9f8811ccb83dee7960cbd77dc133e9" title="Convert a time value and correct for the local time zone.">localtime</a>(&amp;now);
<a name="l01391"></a>01391 <span class="preprocessor">#ifdef FTPD_DEBUG</span>
<a name="l01392"></a>01392 <span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n&lt;&#39;&quot;</span>);
<a name="l01393"></a>01393     <a class="code" href="group__xg_crt_stdio.html#ga30b0c3fa763cfd9c65416be0c3956aa1" title="Print formatted output to the standard output stream.">printf_P</a>(rep_banner, <a class="code" href="group__xg_nut_version.html#gafc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>(), &amp;mon_name[tip-&gt;<a class="code" href="struct__tm.html#a5b0caaf824889c6fb03f045e6fe7ab0f" title="months since January - [0,11]">tm_mon</a> * 3],        <span class="comment">/* */</span>
<a name="l01394"></a>01394              tip-&gt;<a class="code" href="struct__tm.html#a57ccfe4f816d4c25009693f025989874" title="day of the month - [1,31]">tm_mday</a>, tip-&gt;<a class="code" href="struct__tm.html#a39f017347ad46548a120eaf0ddf6a226" title="hours since midnight - [0,23]">tm_hour</a>, tip-&gt;<a class="code" href="struct__tm.html#ab0a4136cc3488707cc7a2c4ad3a3587b" title="minutes after the hour - [0,59]">tm_min</a>, tip-&gt;<a class="code" href="struct__tm.html#a73b45a4fdb2c4c178444f16e9ad21d7b" title="seconds after the minute - [0,59]">tm_sec</a>);
<a name="l01395"></a>01395 <span class="preprocessor">#endif</span>
<a name="l01396"></a>01396 <span class="preprocessor"></span>    <a class="code" href="h8_8h.html#a367ddb82626c7102012eeef97bfb06cc">fprintf_P</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>, rep_banner, <a class="code" href="group__xg_nut_version.html#gafc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>(),      <span class="comment">/* */</span>
<a name="l01397"></a>01397               &amp;mon_name[tip-&gt;<a class="code" href="struct__tm.html#a5b0caaf824889c6fb03f045e6fe7ab0f" title="months since January - [0,11]">tm_mon</a> * 3],       <span class="comment">/* */</span>
<a name="l01398"></a>01398               tip-&gt;<a class="code" href="struct__tm.html#a57ccfe4f816d4c25009693f025989874" title="day of the month - [1,31]">tm_mday</a>, tip-&gt;<a class="code" href="struct__tm.html#a39f017347ad46548a120eaf0ddf6a226" title="hours since midnight - [0,23]">tm_hour</a>, tip-&gt;<a class="code" href="struct__tm.html#ab0a4136cc3488707cc7a2c4ad3a3587b" title="minutes after the hour - [0,59]">tm_min</a>, tip-&gt;<a class="code" href="struct__tm.html#a73b45a4fdb2c4c178444f16e9ad21d7b" title="seconds after the minute - [0,59]">tm_sec</a>);
<a name="l01399"></a>01399 
<a name="l01400"></a>01400     <span class="comment">/*</span>
<a name="l01401"></a>01401 <span class="comment">     * Loop for requests.</span>
<a name="l01402"></a>01402 <span class="comment">     */</span>
<a name="l01403"></a>01403     <span class="keywordflow">while</span> (rc == 0) {
<a name="l01404"></a>01404 
<a name="l01405"></a>01405         <span class="comment">/* Flush any previous output and read a new command line. */</span>
<a name="l01406"></a>01406         <a class="code" href="group__xg_crt_stdio.html#gadb974f28765a31026ee6bf71d5175951" title="Flush a stream.">fflush</a>(session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>);
<a name="l01407"></a>01407         <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_stdio.html#ga1c00c22c5e85d002e202cb733b644d63" title="Read a line from a stream.">fgets</a>(buff, <a class="code" href="group__xg_f_t_p_d.html#ga02da6fd3b04d4e1cc0e3931b47980276" title="UDP port of DHCP server.">FTP_MAX_CMDBUF</a>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>) == 0) {
<a name="l01408"></a>01408             rc = -1;
<a name="l01409"></a>01409             <span class="keywordflow">break</span>;
<a name="l01410"></a>01410         }
<a name="l01411"></a>01411 
<a name="l01412"></a>01412         <span class="comment">/* Skip command lines, which are too long. */</span>
<a name="l01413"></a>01413         <span class="keywordflow">if</span> ((ch = *(buff + <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(buff) - 1)) != <span class="charliteral">&#39;\n&#39;</span> &amp;&amp; ch != <span class="charliteral">&#39;\r&#39;</span>) {
<a name="l01414"></a>01414             <span class="keywordflow">do</span> {
<a name="l01415"></a>01415                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_stdio.html#ga1c00c22c5e85d002e202cb733b644d63" title="Read a line from a stream.">fgets</a>(buff, <a class="code" href="group__xg_f_t_p_d.html#ga02da6fd3b04d4e1cc0e3931b47980276" title="UDP port of DHCP server.">FTP_MAX_CMDBUF</a>, session-&gt;<a class="code" href="struct_f_t_p_s_e_s_s_i_o_n.html#a9ad78054054ed8ae347fbfcf75aa90bf" title="Stream associated to the Telnet socket.">ftp_stream</a>) == 0) {
<a name="l01416"></a>01416                     rc = -1;
<a name="l01417"></a>01417                     <span class="keywordflow">break</span>;
<a name="l01418"></a>01418                 }
<a name="l01419"></a>01419             } <span class="keywordflow">while</span> ((ch = *(buff + <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(buff) - 1)) != <span class="charliteral">&#39;\n&#39;</span> &amp;&amp; ch != <span class="charliteral">&#39;\r&#39;</span>);
<a name="l01420"></a>01420             <span class="keywordflow">if</span> (rc == 0) {
<a name="l01421"></a>01421                 rc = <a class="code" href="group__xg_f_t_p_d.html#ga8a198e099aa073c08ae2203233bce632" title="Send a negative response.">NutFtpRespondBad</a>(session, 500);
<a name="l01422"></a>01422             }
<a name="l01423"></a>01423         }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425         <span class="comment">/* Process the request. */</span>
<a name="l01426"></a>01426         <span class="keywordflow">else</span> {
<a name="l01427"></a>01427             rc = <a class="code" href="group__xg_f_t_p_d.html#ga5b72e2b9bea1143ace7837526d573444" title="Process an FTP request.">NutFtpProcessRequest</a>(session, buff);
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429     }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431     <span class="comment">/* Cleanup and return. */</span>
<a name="l01432"></a>01432     <a class="code" href="group__xg_f_t_p_d.html#ga4e8a0adc4680aa66e9d4d17fdc6e985d" title="Close an FTP server session.">NutFtpCloseSession</a>(session);
<a name="l01433"></a>01433     <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(buff);
<a name="l01434"></a>01434     <span class="keywordflow">return</span> rc;
<a name="l01435"></a>01435 }
<a name="l01436"></a>01436 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ftpd_8c.html">ftpd.c</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
