<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: icmp-udp/icmp-udp.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS
   &#160;<span id="projectnumber">4.10.3</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('icmp-udp_2icmp-udp_8c-example.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">icmp-udp/icmp-udp.c</div>  </div>
</div>
<div class="contents">
<p>Copyright (C) 2009 by Ole Reinhardt &lt;<a href="mailto:ole.reinhardt@thermotemp.de">ole.reinhardt@thermotemp.de</a>&gt;.</p>
<p>All rights reserved.</p>
<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</p>
<p>1. Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. 3. Neither the name of the copyright holders nor the names of contributors may be used to endorse or promote products derived from this software without specific prior written permission.</p>
<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
<p>For additional information see <a href="http://www.ethernut.de/">http://www.ethernut.de/</a></p>
<dl class="rcs"><dt><b>Id:</b></dt><dd><a class="el" href="icmp-udp_8c.html">icmp-udp.c</a> 3538 2011-08-10 16:34:10Z haraldkipp </dd></dl>
<p>This sample demonstrates the icmp error handling for udp sockets. NUT_UDP_ICMP_SUPPORT has to be enabled in the configurator to use icmp support on UDP sockets.</p>
<p>Connect the RS232 port of the Ethernut with a free COM port of your PC and run a terminal emulator at 115200 Baud.</p>
<p>Configure MY_IP, MY_MASK, and MY_GATE approriate. Configure UDP_ECHO_IP to the IP of a host running an udp echo server.</p>
<p>The program will try to send some UDP packets to the given destination address on port 7 (UDP echo port) and will try to read back the sended data.</p>
<p>You can run the udp_echo java program in this directory with admin (root) priviledges to have a simple udp echo server on your pc.</p>
<p>Just start the program with 'java udp_echo.class' This program will echo back every data packet received on udp port 7. The program can be stoped with &lt;ctrl&gt;+<code></code></p>
<p><code> If the udp_echo program (or any other udp echo server) is not running you'll receive ICMP destination unreachable messages. Which will be noticed from this demo app on the next send or receive call.</code></p>
<p><code></p>
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#define MY_MAC          {0x00,0x06,0x98,0x20,0x00,0x00}</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_IP           &quot;192.168.1.100&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_MASK         &quot;255.255.255.0&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">#define MY_GATE         &quot;192.168.1.254&quot;</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define UDP_ECHO_IP     &quot;192.168.1.103&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">#define UDP_ECHO_PORT   7</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>
<span class="comment">//#include &lt;inttypes.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="board_8h.html">dev/board.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html" title="UDP and TCP socket interface definitions.">sys/socket.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html" title="Header file for network configuration.">sys/confnet.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html" title="Internet address conversion.">arpa/inet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="route_8h.html" title="Routing information definitions.">net/route.h</a>&gt;</span>

<span class="preprocessor">#define UDP_BUFF_SIZE 256</span>
<span class="preprocessor"></span>
<span class="keyword">static</span> <span class="keywordtype">char</span> send_buffer[<a name="a0"></a><a class="code" href="icmp-udp_8c.html#a4b2fed9caf28ead17a8f3e3b192294b4">UDP_BUFF_SIZE</a>];
<span class="keyword">static</span> <span class="keywordtype">char</span> rcv_buffer[<a class="code" href="icmp-udp_8c.html#a4b2fed9caf28ead17a8f3e3b192294b4">UDP_BUFF_SIZE</a>];
<span class="keyword">static</span> <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> my_mac[] = <a name="a1"></a><a class="code" href="ftpserv_8c.html#aeaa487f5205c0aac9da4e004c173429c">MY_MAC</a>;

<span class="preprocessor">#ifdef DEV_ETHER</span>
<span class="preprocessor"></span>
<span class="comment">/* Print error message */</span>
<span class="keywordtype">void</span> <a name="a2"></a><a class="code" href="icmp-udp_8c.html#a1f080e27c3b1092d5a574019002eebe0">print_udp_icmp_error</a>(<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> remote_ip, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> remote_port, <span class="keywordtype">int</span> error)
{
    <a name="a3"></a><a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;ICMP destination unreachable received for remote ip: %s\r\nremote port: %d, errno: %d -- &quot;</span>, 
           <a name="a4"></a><a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(remote_ip), remote_port, error);
    
    <span class="keywordflow">switch</span> (error) {
        <span class="keywordflow">case</span> <a name="a5"></a><a class="code" href="errno_8h.html#a3f91f1ad503432783c7a5d1481b45419">ENETUNREACH</a>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Destination network unreachable\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a6"></a><a class="code" href="errno_8h.html#a53e186028fc992c3341ccb0d4d239b24">EHOSTUNREACH</a>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Destination host unreachable\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a7"></a><a class="code" href="errno_8h.html#acd570f8ab92198653b4459773dc3bca3">ENOPROTOOPT</a>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Destination protocol unreachable\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a8"></a><a class="code" href="errno_8h.html#aad88020b394ef1aa4af2f4ef9b4c8b39">ECONNREFUSED</a>:      
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Destination port unreachable / connection refused\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a9"></a><a class="code" href="errno_8h.html#ae37becfaa095a9df5c5c788bce5aa06f">EMSGSIZE</a>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Fragmentation required, and DF flag set\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a10"></a><a class="code" href="errno_8h.html#a4b807895c74cea4d0302bf27725d4b9d">EOPNOTSUPP</a>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Source route failed\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> <a name="a11"></a><a class="code" href="errno_8h.html#aa92bcaf70544db6998f4c503026359c5">EHOSTDOWN</a>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Destination host unknown or down\r\n&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Other error\r\n&quot;</span>);
    }
}

<a name="a12"></a><a class="code" href="thread_8h.html#a9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a name="a13"></a><a class="code" href="icmp-udp_8c.html#a22bfd031a3b3b234b2660890ede49323">UDPReceiver</a>, arg)
{
    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> remote_ip;
    <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> remote_port;
    <a name="_a14"></a><a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> *socket = (<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a>*) arg;
    <span class="keywordtype">int</span>      rc;
    
    <span class="keywordflow">while</span> (1) {
        rc = <a name="a15"></a><a class="code" href="group__xg_udp_socket.html#ga6b8b9b8ddce0e1024f75c7575d8c9e3b" title="Receive a UDP datagram.">NutUdpReceiveFrom</a>(socket, &amp;remote_ip, &amp;remote_port, rcv_buffer, <a class="code" href="icmp-udp_8c.html#a4b2fed9caf28ead17a8f3e3b192294b4">UDP_BUFF_SIZE</a>, 2000);
        <span class="keywordflow">if</span> (rc == 0) {
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;&lt;-- Timeout (2 sec.) on UDP receive\r\n&quot;</span>);
        } <span class="keywordflow">else</span> 
        <span class="keywordflow">if</span> (rc &lt; 0) {
<span class="preprocessor">#ifdef NUT_UDP_ICMP_SUPPORT             </span>
<span class="preprocessor"></span>            <span class="keywordtype">int</span> error;
            error = <a name="a16"></a><a class="code" href="group__xg_udp_socket.html#ga1cc6c30fe6d110875fc592b09d986926" title="Return specific code of the last error and the IP address / port of the host to which the communicati...">NutUdpError</a>(socket, &amp;remote_ip, &amp;remote_port);
            <a class="code" href="icmp-udp_8c.html#a1f080e27c3b1092d5a574019002eebe0">print_udp_icmp_error</a>(remote_ip, remote_port, error);
<span class="preprocessor">#endif            </span>
<span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;&lt;-- Received packet: \&quot;%s\&quot;\r\n&quot;</span>, rcv_buffer);
        }
    }
}

<span class="preprocessor">#endif </span><span class="comment">/* DEV_ETHER */</span>

<span class="comment">/*</span>
<span class="comment"> * Main application routine. </span>
<span class="comment"> *</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> <a name="a17"></a><a class="code" href="arm_8h.html#aa4e97f3782107649d3e4eb3875090b3a">main</a>(<span class="keywordtype">void</span>)
{
    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> baud = 115200;
    <a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> *socket;

    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> ip_addr;
    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> ip_udp_echo;
    <span class="keywordtype">int</span>    rc;
    <span class="keywordtype">int</span>    packet_nr;
    <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> length;

    <span class="comment">/*</span>
<span class="comment">     * Initialize the uart device.</span>
<span class="comment">     */</span>
    <a name="a18"></a><a class="code" href="group__xg_device.html#ga0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a19"></a><a class="code" href="board_8h.html#ac2ef4e8d5bb559c608f6a795a3a3496e">DEV_CONSOLE</a>, 0, 0);
    <a name="a20"></a><a class="code" href="group__xg_crt_stdio.html#ga76767cc4b7500920d83e53caad264189" title="Reassign a stream.">freopen</a>(<a name="a21"></a><a class="code" href="board_8h.html#aa4a1e62a728655728db6adcd38c6855e">DEV_CONSOLE_NAME</a>, <span class="stringliteral">&quot;w&quot;</span>, <a name="a22"></a><a class="code" href="group__xg_crt_stdio.html#ga0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>);
    <a name="a23"></a><a class="code" href="group__xg_crt_lowio.html#ga6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(<a name="a24"></a><a class="code" href="group__xg_crt_stdio.html#gab5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(<a class="code" href="group__xg_crt_stdio.html#ga0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>), <a name="a25"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#ga2f1b5053775ad3be83ae499273a04de8" title="UART _ioctl() command code to set the line speed.">UART_SETSPEED</a>, &amp;baud);
    <a name="a26"></a><a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Demo for ICMP support in UDP sockets...\r\n&quot;</span>);

<span class="preprocessor">#ifdef DEV_ETHER</span>
<span class="preprocessor"></span><span class="preprocessor">#ifndef NUT_UDP_ICMP_SUPPORT</span>
<span class="preprocessor"></span><span class="preprocessor">#warning ICMP support for UDP sockets not enabled in the configurator, please enable NUT_UDP_ICMP_SUPPORT</span>
<span class="preprocessor"></span>    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;ICMP support for UDP sockets not enabled in the configurator\r\n&quot;</span>);
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Please enable NUT_UDP_ICMP_SUPPORT\r\n&quot;</span>);
<span class="preprocessor">#endif    </span>
<span class="preprocessor"></span>    <span class="comment">/*</span>
<span class="comment">     * Register the network device.</span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Configuring Ethernet interface&quot;</span>);
    <a class="code" href="group__xg_device.html#ga0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a27"></a><a class="code" href="dev_2at91__emac_8h.html#ac8dd96e43e6ce38f3259b56db85065c9">DEV_ETHER</a>, 0, 0);

    ip_addr = <a name="a28"></a><a class="code" href="group__xg_i_p.html#gadbce564458332a83ab871b91a54269dd" title="Convert decimal dotted ASCII representation into numeric IP address.">inet_addr</a>(<a name="a29"></a><a class="code" href="icmp-udp_8c.html#ad9d15cbd5b02e0e6765bcf511743d680">MY_IP</a>);
    <a name="a30"></a><a class="code" href="group__xg_i_p.html#ga3d6e30d2a89522f9166d59cde5c85b94" title="Configure a network interface.">NutNetIfConfig</a>(<span class="stringliteral">&quot;eth0&quot;</span>, my_mac, ip_addr, <a class="code" href="group__xg_i_p.html#gadbce564458332a83ab871b91a54269dd" title="Convert decimal dotted ASCII representation into numeric IP address.">inet_addr</a>(<a name="a31"></a><a class="code" href="icmp-udp_8c.html#a20c17eb7d0dca9196ad551d1675c3d77">MY_MASK</a>));
    <a name="a32"></a><a class="code" href="group__xg_i_p.html#gaeb3b4f86e57db7d3e047b0c53aa94e60" title="Add a new entry to the IP routing table.">NutIpRouteAdd</a>(0, 0, <a class="code" href="group__xg_i_p.html#gadbce564458332a83ab871b91a54269dd" title="Convert decimal dotted ASCII representation into numeric IP address.">inet_addr</a>(<a name="a33"></a><a class="code" href="icmp-udp_8c.html#a803653b048f98f35b18787c67a898fc1">MY_GATE</a>), &amp;<a class="code" href="dev_2at91__emac_8h.html#ac8dd96e43e6ce38f3259b56db85065c9">DEV_ETHER</a>);

    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;%s ready\r\n&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(ip_addr));


    socket = <a name="a34"></a><a class="code" href="group__xg_udp_socket.html#gae3f0a4c71eecf9a01920852dd0f0592d" title="Create a UDP socket.">NutUdpCreateSocket</a>(<a name="a35"></a><a class="code" href="icmp-udp_8c.html#a291b520bd7e3a9ec774c402e62e54466">UDP_ECHO_PORT</a>);
    <span class="keywordflow">if</span> (socket == 0) {
        <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Could not create UDP socket in port &#39;%d&#39;\r\n&quot;</span>, <a class="code" href="icmp-udp_8c.html#a291b520bd7e3a9ec774c402e62e54466">UDP_ECHO_PORT</a>);
        <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Demo halted...\r\n&quot;</span>);
        <span class="keywordflow">while</span> (1);
    } <span class="keywordflow">else</span> {
        <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Successfully created UDP socket on port &#39;%d&#39;\r\n&quot;</span>, <a class="code" href="icmp-udp_8c.html#a291b520bd7e3a9ec774c402e62e54466">UDP_ECHO_PORT</a>);
        length = <a class="code" href="icmp-udp_8c.html#a4b2fed9caf28ead17a8f3e3b192294b4">UDP_BUFF_SIZE</a>;
        <span class="keywordflow">if</span> (<a name="a36"></a><a class="code" href="group__xg_udp_socket.html#ga2051b9300c656a4e01b964d054f0a9ec" title="Set value of a UDP socket option.">NutUdpSetSockOpt</a>(socket, <a name="a37"></a><a class="code" href="socket_8h.html#a0db12e960ac303030400d9fd95391b52" title="Receive buffer size.">SO_RCVBUF</a>, &amp;length, <span class="keyword">sizeof</span>(length))) {;
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Could not set UDP receive buffer size (%d)\r\n&quot;</span>, length);
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Demo halted...\r\n&quot;</span>);
            <span class="keywordflow">while</span> (1);
        }
    }
    
    <span class="keywordflow">if</span> (<a name="a38"></a><a class="code" href="group__xg_nut_arch_arm_os_context.html#ga8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="stringliteral">&quot;RCV&quot;</span>, <a class="code" href="icmp-udp_8c.html#a22bfd031a3b3b234b2660890ede49323">UDPReceiver</a>, (<span class="keywordtype">void</span>*)socket, 1024) == 0) {
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Could not start receiver thread\r\n&quot;</span>);
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Demo halted...\r\n&quot;</span>);
            <span class="keywordflow">while</span> (1);
    } <span class="keywordflow">else</span> {
        <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Receiver thread started\r\n&quot;</span>);
    }
    
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Starting echo test (1 packet / second)\r\n&quot;</span>);
    
    ip_udp_echo = <a class="code" href="group__xg_i_p.html#gadbce564458332a83ab871b91a54269dd" title="Convert decimal dotted ASCII representation into numeric IP address.">inet_addr</a>(<a name="a39"></a><a class="code" href="icmp-udp_8c.html#a1c62e008ca75944fb5e0c47c1e65ede6">UDP_ECHO_IP</a>);
    packet_nr = 0;
    
    <span class="keywordflow">while</span> (1) {
        packet_nr ++;
        <a name="a40"></a><a class="code" href="icc_8h.html#a5998f60c4f4af322b36debdbd11d7917">sprintf</a>(send_buffer, <span class="stringliteral">&quot;Packet: %d&quot;</span>, packet_nr);
        rc = <a name="a41"></a><a class="code" href="group__xg_udp_socket.html#ga10191929e17f17de9f49c5b1f8822154" title="Send a UDP datagram.">NutUdpSendTo</a>(socket, ip_udp_echo, <a class="code" href="icmp-udp_8c.html#a291b520bd7e3a9ec774c402e62e54466">UDP_ECHO_PORT</a>, send_buffer, length);
        <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;--&gt; Sended packet: \&quot;%s\&quot;, to %s, rc: %d\r\n&quot;</span>, send_buffer, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(ip_udp_echo), rc);
        <span class="keywordflow">if</span> (rc &lt; 0) {
<span class="preprocessor">#ifdef NUT_UDP_ICMP_SUPPORT</span>
<span class="preprocessor"></span>            <span class="keywordtype">int</span>      error;
            <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> remote_ip;
            <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> remote_port;             
            error = <a class="code" href="group__xg_udp_socket.html#ga1cc6c30fe6d110875fc592b09d986926" title="Return specific code of the last error and the IP address / port of the host to which the communicati...">NutUdpError</a>(socket, &amp;remote_ip, &amp;remote_port);
            <a class="code" href="icmp-udp_8c.html#a1f080e27c3b1092d5a574019002eebe0">print_udp_icmp_error</a>(remote_ip, remote_port, error);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        }
        
        <a name="a42"></a><a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);
    }
<span class="preprocessor">#endif </span><span class="comment">/* DEV_ETHER */</span>
    <span class="keywordflow">return</span> 0;
}
</pre></div><p> </code></p>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
