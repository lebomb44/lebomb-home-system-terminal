<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: pppc/pppc.c</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS
   &#160;<span id="projectnumber">4.10.3</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('pppc_2pppc_8c-example.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">pppc/pppc.c</div>  </div>
</div>
<div class="contents">
<dl class="rcs"><dt><b>Id:</b></dt><dd><a class="el" href="pppc_8c.html">pppc.c</a> 3538 2011-08-10 16:34:10Z haraldkipp </dd></dl>
<p>PPP client sample.</p>
<p>This example demonstrates Nut/OS Point-To-Point protocol. Most likely it will not run without modification. See the '#define' entries below.</p>
<p>The application will dial the provider via a modem, using the specified chat script. When connected, it will establish a PPP session. Then DNS is used to query the IP address of an NTP server, from which it queries the current time. Finally the PPP session is terminated and the whole procedure is repeated every hour.</p>
<p>By default the application will use 2 serial ports. The first one is used for debugging output on stdout and the second UART will be connected to a modem.</p>
<p>Note, that PPP is not available for all target boards. If this is the case the program will use the local Ethernet network, where DHCP must be available.</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (C) 2011 by egnite GmbH</span>
<span class="comment"> * Copyright (C) 2003-2006 by egnite Software GmbH</span>
<span class="comment"> *</span>
<span class="comment"> * All rights reserved.</span>
<span class="comment"> *</span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> *</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<span class="comment"> *    from this software without specific prior written permission.</span>
<span class="comment"> *</span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="comment"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<span class="comment"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="comment"> * SUCH DAMAGE.</span>
<span class="comment"> *</span>
<span class="comment"> * For additional information see http://www.ethernut.de/</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;<a class="code" href="cfg_2ahdlc_8h.html" title="AHDLC driver configuration.">cfg/ahdlc.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="board_8h.html">dev/board.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="ahdlcavr_8h.html" title="On-chip UART HDLC device definitions.">dev/ahdlcavr.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dev_2ppp_8h.html" title="PPP device definitions.">dev/ppp.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="dev_2chat_8h.html">dev/chat.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="version_8h.html">sys/version.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html" title="Internet address conversion.">arpa/inet.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="netdb_8h.html">netdb.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="if__var_8h.html" title="Network interface structure.">net/if_var.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="route_8h.html" title="Routing information definitions.">net/route.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html" title="DHCP protocol definitions.">pro/dhcp.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="pro_2sntp_8h.html">pro/sntp.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="rfctime_8h.html" title="RFC date and time conversion header.">pro/rfctime.h</a>&gt;</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="io_8h.html">io.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="fcntl_8h.html" title="File control flags.">fcntl.h</a>&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>

<span class="comment">/*</span>
<span class="comment"> * Conversational script with a modem.</span>
<span class="comment"> *</span>
<span class="comment"> * The Nut/OS modem chat utility works similar to the the UNIX chat</span>
<span class="comment"> * script. In general it consists of one or more expect-send pairs of</span>
<span class="comment"> * strings or optional keyword-parameter pairs. Keywords are</span>
<span class="comment"> *</span>
<span class="comment"> * - TIMEOUT to set the max. time in seconds to wait for expected string</span>
<span class="comment"> * - ABORT to specify up to 10 abort strings</span>
<span class="comment"> * - REPORT to specify up to 3 reported abort strings</span>
<span class="comment"> *</span>
<span class="comment"> * Adjust this script to the requirements of your modem equipment</span>
<span class="comment"> * and your GPRS provider.</span>
<span class="comment"> *</span>
<span class="comment"> * The following script had been tested with a Siemens GPRS modem</span>
<span class="comment"> * (S55 mobile phone), using a t-mobile pre-paid account.</span>
<span class="comment"> */</span>
<span class="preprocessor">#define PPP_CHAT    </span><span class="comment">/* Wait up to 20 seconds for any response. */</span> \
                    &quot;TIMEOUT 20&quot; \
                    <span class="comment">/* Expect nothing at the beginning. */</span> \
                    &quot; &#39;&#39;&quot; \
                    <span class="comment">/* Send simple AT command to check the modem. */</span> \
                    &quot; AT OK&quot; \
                    <span class="comment">/* Define PDP context, expecting &#39;OK&#39;. */</span> \
                    &quot; AT+CGDCONT=1,\&quot;IP\&quot;,\&quot;internet.t-mobile\&quot; OK&quot; \
                    <span class="comment">/* Dial and wait for &#39;CONNECT&#39;. */</span> \
                    &quot; ATD*99***1# CONNECT&quot;

<span class="comment">/*</span>
<span class="comment"> * PPP user and password.</span>
<span class="comment"> *</span>
<span class="comment"> * Often GPRS providers accept any login.</span>
<span class="comment"> */</span>
<span class="preprocessor">#define PPP_USER    &quot;me&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">#define PPP_PASS    &quot;secret&quot;</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * PPP device settings.</span>
<span class="comment"> */</span>
<span class="preprocessor">#if defined(NUT_THREAD_AHDLCRXSTACK)</span>
<span class="preprocessor"></span><span class="preprocessor">#define PPP_DEV         devAhdlc1   </span><span class="comment">/* AHDLC driver */</span>
<span class="preprocessor">#define PPP_DEV_NAME    &quot;uart1&quot;     </span><span class="comment">/* Physical device name */</span>
<span class="preprocessor">#define PPP_SPEED       115200      </span><span class="comment">/* Baudrate */</span>
<span class="preprocessor">#define PPP_RXTO        1000        </span><span class="comment">/* Receive timeout (ms) */</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#warning &quot;PPP is not supported on your target&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment"> * Open serial debug port for standard output.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> DebugPortOpen(<span class="keywordtype">void</span>)
{
    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> baud = 115200;

    <span class="comment">/* Register debug UART. */</span>
    <a name="a0"></a><a class="code" href="group__xg_device.html#ga0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a1"></a><a class="code" href="board_8h.html#ac2ef4e8d5bb559c608f6a795a3a3496e">DEV_CONSOLE</a>, 0, 0);
    <span class="comment">/* Open debug device for standard output. */</span>
    <a name="a2"></a><a class="code" href="group__xg_crt_stdio.html#ga76767cc4b7500920d83e53caad264189" title="Reassign a stream.">freopen</a>(<a name="a3"></a><a class="code" href="board_8h.html#aa4a1e62a728655728db6adcd38c6855e">DEV_CONSOLE_NAME</a>, <span class="stringliteral">&quot;w&quot;</span>, <a name="a4"></a><a class="code" href="group__xg_crt_stdio.html#ga0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>);
    <span class="comment">/* Set baud rate. */</span>
    <a name="a5"></a><a class="code" href="group__xg_crt_lowio.html#ga6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(<a name="a6"></a><a class="code" href="group__xg_crt_stdio.html#gab5ec3b6c064aca1b990c342a82e64aae" title="Get the file descriptor associated with a stream.">_fileno</a>(<a class="code" href="group__xg_crt_stdio.html#ga0c0ef221f95f64e8632451312fd18cc8" title="Standard output stream.">stdout</a>), <a name="a7"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#ga2f1b5053775ad3be83ae499273a04de8" title="UART _ioctl() command code to set the line speed.">UART_SETSPEED</a>, &amp;baud);
}

<span class="comment">/*</span>
<span class="comment"> * Initialize the protocol port.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> ProtocolPortInit(<span class="keywordtype">void</span>)
{
<span class="preprocessor">#ifdef PPP_DEV</span>
<span class="preprocessor"></span>    <span class="comment">/* Register PPP and UART device. */</span>
    <a class="code" href="group__xg_device.html#ga0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;PPP_DEV, 0, 0);
    <a class="code" href="group__xg_device.html#ga0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a8"></a><a class="code" href="group__xg_p_p_p.html#gae862c6c489e1992ea8e9b572d5ef70c3" title="Device information structure.">devPpp</a>, 0, 0);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <span class="comment">/* Use Ethernet. */</span>
    <a class="code" href="group__xg_device.html#ga0d73e3153bf9f210194bd862d9b91c61" title="Register and initialize a device.">NutRegisterDevice</a>(&amp;<a name="a9"></a><a class="code" href="dev_2at91__emac_8h.html#ac8dd96e43e6ce38f3259b56db85065c9">DEV_ETHER</a>, 0, 0);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}

<span class="comment">/*</span>
<span class="comment"> * Open the physical device.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> ProtocolPortOpen(<span class="keywordtype">void</span>)
{
<span class="preprocessor">#ifdef PPP_DEV</span>
<span class="preprocessor"></span>    <span class="keywordtype">int</span> pppcom;
    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> lctl;

    <span class="comment">/* Open PPP device. Specify physical device, user and password. */</span>
    <a name="a10"></a><a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Open PPP interface at &quot;</span> PPP_DEV_NAME <span class="stringliteral">&quot;...&quot;</span>);
    pppcom = <a name="a11"></a><a class="code" href="group__xg_crt_lowio.html#gaa5b9fe6f8778481971c2e23a38348bb1" title="Open a file.">_open</a>(<span class="stringliteral">&quot;ppp:&quot;</span> PPP_DEV_NAME <span class="stringliteral">&quot;/&quot;</span> <a name="a12"></a><a class="code" href="pppc_8c.html#a9923a0d7c154ea0025ee04cb41945605">PPP_USER</a> <span class="stringliteral">&quot;/&quot;</span> <a name="a13"></a><a class="code" href="pppc_8c.html#a6048655b2cf8f8e2e1c732f3cd6af9e2">PPP_PASS</a>, <a name="a14"></a><a class="code" href="group__xg_crt_lowio.html#ga010187fb7398870cb57af650e65bded1">_O_RDWR</a> | <a name="a15"></a><a class="code" href="group__xg_crt_lowio.html#ga166a079a4990ddeb0a32475728bbacd0">_O_BINARY</a>);
    <span class="keywordflow">if</span> (pppcom == -1) {
        <a name="a16"></a><a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;failed&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">/*</span>
<span class="comment">     * Set PPP line speed.</span>
<span class="comment">     */</span>
    lctl = PPP_SPEED;
    <a class="code" href="group__xg_crt_lowio.html#ga6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(pppcom, <a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#ga2f1b5053775ad3be83ae499273a04de8" title="UART _ioctl() command code to set the line speed.">UART_SETSPEED</a>, &amp;lctl);
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;%lu baud&quot;</span>, lctl);

    <span class="comment">/*</span>
<span class="comment">     * The PPP driver doesn&#39;t set any receive timeout, but</span>
<span class="comment">     * may require it.</span>
<span class="comment">     */</span>
    lctl = PPP_RXTO;
    <a class="code" href="group__xg_crt_lowio.html#ga6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(pppcom, <a name="a17"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#gac6096987e89c87f241ec277eea1613e8" title="UART _ioctl() command code to set the read timeout.">UART_SETREADTIMEOUT</a>, &amp;lctl);
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;, %lu ms timeout\n&quot;</span>, lctl);

    <span class="keywordflow">return</span> pppcom;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <span class="comment">/* Nothing to be done for Ethernet. */</span>
    <span class="keywordflow">return</span> 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}

<span class="comment">/*</span>
<span class="comment"> * Establish a modem connection.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> ProtocolPortConnect(<span class="keywordtype">int</span> pppcom)
{
<span class="preprocessor">#ifdef PPP_DEV</span>
<span class="preprocessor"></span>    <span class="keywordtype">int</span> rc;

    <span class="comment">/*</span>
<span class="comment">     * Connect using a chat script. We may also set any</span>
<span class="comment">     * required hardware handshake line at this stage.</span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Connecting...&quot;</span>);
    <span class="keywordflow">for</span> (;;) {
        rc = <a name="a18"></a><a class="code" href="dev_2chat_8h.html#af4857d26bf25c81b1ebe9392bd46d00c" title="Execute a conversational exchange with a serial device.">NutChat</a>(pppcom, <a name="a19"></a><a class="code" href="pppc_8c.html#a57751b44272a5012bda90b5443df27ec">PPP_CHAT</a>);
        <span class="keywordflow">switch</span> (rc) {
        <span class="keywordflow">case</span> 0:
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;done&quot;</span>);
            <span class="comment">/* A short pause is required here to let the driver</span>
<span class="comment">               initialize the receiver thread. */</span>
            <a name="a20"></a><a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(100);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 1:
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;bad script&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 2:
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;I/O error&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span> 3:
            <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;no response&quot;</span>);
            <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>:
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;aborted (%d)\n&quot;</span>, rc);
            <span class="keywordflow">break</span>;
        }
        <span class="keywordflow">if</span> (rc != 3) {
            <span class="keywordflow">break</span>;
        }
        <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(1000);
    }
    <span class="keywordflow">return</span> rc;
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <span class="comment">/* Nothing to be done for Ethernet. */</span>
    <span class="keywordflow">return</span> 0;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}

<span class="comment">/*</span>
<span class="comment"> * Hang up.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> ProtocolPortClose(<span class="keywordtype">int</span> pppcom)
{
<span class="preprocessor">#ifdef PPP_DEV</span>
<span class="preprocessor"></span>    <span class="comment">/* Set the UART back to normal mode. */</span>
    <a class="code" href="group__xg_crt_lowio.html#ga6b356746f1f26fb46f2afe4357ab3534" title="Perform device specific control functions.">_ioctl</a>(pppcom, <a name="a21"></a><a class="code" href="group__xg_u_a_r_t_i_o_c_t_l.html#ga056fd5203780a8ef5bed031b32d3836b" title="UART _ioctl() command code to set the network interface mode.">HDLC_SETIFNET</a>, NULL);
    <span class="comment">/* Close the physical port. This may or may not hang up. Please</span>
<span class="comment">       check the modem&#39;s documentation. */</span>
    <a name="a22"></a><a class="code" href="group__xg_crt_lowio.html#ga58a559c63748012aab165d5f82af766d" title="Close a file, device or socket.">_close</a>(pppcom);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>}

<span class="keyword">static</span> <span class="keywordtype">int</span> ProtocolPortConfigure(<span class="keywordtype">void</span>)
{
<span class="preprocessor">#ifdef PPP_DEV</span>
<span class="preprocessor"></span>    <a name="_a23"></a><a class="code" href="struct___p_p_p_d_c_b.html" title="PPP interface structure.">PPPDCB</a> *dcb;

    <span class="comment">/*</span>
<span class="comment">     * We are connected, configure our PPP network interface.</span>
<span class="comment">     * This will initiate the PPP configuration negotiation</span>
<span class="comment">     * and authentication with the server.</span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Configure network interface...&quot;</span>);
    <span class="keywordflow">if</span> (<a name="a24"></a><a class="code" href="group__xg_i_p.html#ga3d6e30d2a89522f9166d59cde5c85b94" title="Configure a network interface.">NutNetIfConfig</a>(<span class="stringliteral">&quot;ppp&quot;</span>, 0, 0, 0)) {
        <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;failed&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;done&quot;</span>);

    <span class="comment">/*</span>
<span class="comment">     * Set name server and default route. Actually the PPP interface</span>
<span class="comment">     * should do this, but the current release doesn&#39;t.</span>
<span class="comment">     */</span>
    dcb = <a class="code" href="group__xg_p_p_p.html#gae862c6c489e1992ea8e9b572d5ef70c3" title="Device information structure.">devPpp</a>.<a name="a25"></a><a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a10b785b6b1d51c4179ad067ea0ebecf2" title="Driver control block.">dev_dcb</a>;
    <a name="a26"></a><a class="code" href="group__xg_d_n_s.html#gac3f37bb5099633796580e35bb3cd0913" title="Set DNS configuration.">NutDnsConfig2</a>(0, 0, dcb-&gt;<a name="a27"></a><a class="code" href="struct___p_p_p_d_c_b.html#a83f14732437ad23ea3e69080b439d09b" title="Negotiated primary DNS.">dcb_ip_dns1</a>, dcb-&gt;<a name="a28"></a><a class="code" href="struct___p_p_p_d_c_b.html#add81d73c0b1ae9e37fa549a461a6ab48" title="Negotiated secondary DNS.">dcb_ip_dns2</a>);
    <a name="a29"></a><a class="code" href="group__xg_i_p.html#gaeb3b4f86e57db7d3e047b0c53aa94e60" title="Add a new entry to the IP routing table.">NutIpRouteAdd</a>(0, 0, dcb-&gt;<a name="a30"></a><a class="code" href="struct___p_p_p_d_c_b.html#a63c42c5f204b7a81cd162154a8145743" title="Remote IP address.">dcb_remote_ip</a>, &amp;<a class="code" href="group__xg_p_p_p.html#gae862c6c489e1992ea8e9b572d5ef70c3" title="Device information structure.">devPpp</a>);

    <span class="comment">/*</span>
<span class="comment">     * Display our IP settings.</span>
<span class="comment">     */</span>
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;     Local IP: %s\n&quot;</span>, <a name="a31"></a><a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(dcb-&gt;<a name="a32"></a><a class="code" href="struct___p_p_p_d_c_b.html#ac5973b2b72641fdfc787c1fc598fc3fa" title="Local IP address.">dcb_local_ip</a>));
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;    Remote IP: %s\n&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(dcb-&gt;<a class="code" href="struct___p_p_p_d_c_b.html#a63c42c5f204b7a81cd162154a8145743" title="Remote IP address.">dcb_remote_ip</a>));
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;  Primary DNS: %s\n&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(dcb-&gt;<a class="code" href="struct___p_p_p_d_c_b.html#a83f14732437ad23ea3e69080b439d09b" title="Negotiated primary DNS.">dcb_ip_dns1</a>));
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Secondary DNS: %s\n&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(dcb-&gt;<a class="code" href="struct___p_p_p_d_c_b.html#add81d73c0b1ae9e37fa549a461a6ab48" title="Negotiated secondary DNS.">dcb_ip_dns2</a>));
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>    <span class="comment">/* We use DHCP on Ethernet. */</span>
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Configure network interface...&quot;</span>);
    <span class="keywordflow">if</span> (<a name="a33"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga23fddfde13e6e0581258ac7f0fc1d025" title="Automatically configure an Ethernet network interface.">NutDhcpIfConfig</a>(<a name="a34"></a><a class="code" href="board_8h.html#a0fc4eeb9caa6e287bdd5c4e7c8a83f9b">DEV_ETHER_NAME</a>, 0, 60000)) {
        <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;failed&quot;</span>);
        <span class="keywordflow">return</span> -1;
    }
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;done&quot;</span>);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">return</span> 0;
}

<span class="comment">/*</span>
<span class="comment"> * Connect any NTP-Pool server to query the current time.</span>
<span class="comment"> */</span>
<span class="keyword">static</span> <span class="keywordtype">void</span> QueryDateAndTime(<span class="keywordtype">void</span>)
{
    <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a name="_a35"></a><a class="code" href="structip.html" title="Structure of an internet header.">ip</a>;
    <a class="code" href="group__xg_crt_time.html#gae33b844d9ee195d9df95b93b5fb312c5" title="Serial date/time. Holds number of seconds after January 1st, 1970.">time_t</a> now;
    <span class="keywordtype">int</span> i;

    <span class="comment">/* First connect the DNS server to get the IP address. */</span>
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Is There Anybody Out There? &quot;</span>);
    ip = <a name="a36"></a><a class="code" href="group__xg_d_n_s.html#ga7645f7a6e530441ae9c17a772e7a83ca">NutDnsGetHostByName</a>((<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *) <span class="stringliteral">&quot;pool.ntp.org&quot;</span>);
    <span class="keywordflow">if</span> (ip == 0) {
        <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;No?&quot;</span>);
    } <span class="keywordflow">else</span> {
        <span class="comment">/* We do have an IP, now try to connect it. */</span>
        <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;Yes, found %s\n&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(ip));
        <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
            <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;What&#39;s the time? &quot;</span>);
            <span class="keywordflow">if</span> (<a name="a37"></a><a class="code" href="group__xg_sntp.html#gad2dcefed95ef5ff0f942fe0263000a3d">NutSNTPGetTime</a>(&amp;ip, &amp;now) == 0) {
                <span class="comment">/* We got a valid response, display the result. */</span>
                <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;%s GMT\n&quot;</span>, <a name="a38"></a><a class="code" href="rfctime_8h.html#a4c9b4f497dc1389439566e8e94ed51c9" title="Create RFC 1123 date and time string.">Rfc1123TimeString</a>(<a name="a39"></a><a class="code" href="group__xg_crt_time.html#ga4bf5c1b09409b70880b839f0ff9aeb9a" title="Convert a time value to a structure.">gmtime</a>(&amp;now)));
                <span class="keywordflow">return</span>;
            } <span class="keywordflow">else</span> {
                <span class="comment">/* It failed. May be the server is too busy. Try</span>
<span class="comment">                   again in 5 seconds. */</span>
                <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Sorry?&quot;</span>);
                <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(5000);
            }
        }
    }
    <span class="comment">/* We give up after 3 trials. */</span>
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;You missed the starting gun.&quot;</span>);
}

<span class="comment">/*</span>
<span class="comment"> * PPP client application entry.</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> <a name="a40"></a><a class="code" href="arm_8h.html#aa4e97f3782107649d3e4eb3875090b3a">main</a>(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> pppcom;

    <span class="comment">/* Initialize a debug port for standard output and display a banner. */</span>
    DebugPortOpen();
    <a class="code" href="icc_8h.html#a3cb9f0894fab1c8fbb0753c9c7c2a8d9" title="Redefined standard library routines.">printf</a>(<span class="stringliteral">&quot;\n\nPPP Client Sample - Nut/OS %s\n&quot;</span>, <a name="a41"></a><a class="code" href="group__xg_nut_version.html#gafc224f8837d06742cb90826cdf1dea12" title="Return Nut/OS version string.">NutVersionString</a>());

    <span class="comment">/* Initialize the network interface. */</span>
    ProtocolPortInit();
    <span class="comment">/* This loop runs once per hour. */</span>
    <span class="keywordflow">for</span> (;;) {
        <span class="comment">/* Open the network interface. */</span>
        pppcom = ProtocolPortOpen();
        <span class="keywordflow">if</span> (pppcom == -1) {
            <span class="comment">/* If this fails, we are busted. */</span>
            <span class="keywordflow">break</span>;
        }
        <span class="comment">/* Establish the modem connection. */</span>
        <span class="keywordflow">if</span> (ProtocolPortConnect(pppcom) == 0) {
            <span class="comment">/* Configure the network interface. */</span>
            <span class="keywordflow">if</span> (ProtocolPortConfigure() == 0) {
                <span class="comment">/* Talk to the Internet. */</span>
                QueryDateAndTime();
            }
        }
        <span class="comment">/* Hang up. */</span>
        ProtocolPortClose(pppcom);

        <span class="comment">/* Sleep 1 hour. */</span>
        <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;I&#39;ll be back in 1 hour.&quot;</span>);
        <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(3600000);
    }
    <span class="comment">/* Ouch... */</span>
    <a class="code" href="icc_8h.html#a80022cbe72a24b85437c2326543509be">puts</a>(<span class="stringliteral">&quot;Good bye cruel world&quot;</span>);

    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
