<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Nut/OS: pro/dhcpc.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="nutos_logo.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Nut/OS
   &#160;<span id="projectnumber">4.10.3</span>
   </div>
   <div id="projectbrief">API Reference</div>
  </td>
  
  
  
   
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
   
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('dhcpc_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">dhcpc.c</div>  </div>
</div>
<div class="contents">
<a href="dhcpc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2001-2005 by egnite Software GmbH. All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00005"></a>00005 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00006"></a>00006 <span class="comment"> * are met:</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00009"></a>00009 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00010"></a>00010 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00012"></a>00012 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00013"></a>00013 <span class="comment"> * 3. Neither the name of the copyright holders nor the names of</span>
<a name="l00014"></a>00014 <span class="comment"> *    contributors may be used to endorse or promote products derived</span>
<a name="l00015"></a>00015 <span class="comment"> *    from this software without specific prior written permission.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY EGNITE SOFTWARE GMBH AND CONTRIBUTORS</span>
<a name="l00018"></a>00018 <span class="comment"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00019"></a>00019 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<a name="l00020"></a>00020 <span class="comment"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL EGNITE</span>
<a name="l00021"></a>00021 <span class="comment"> * SOFTWARE GMBH OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<a name="l00022"></a>00022 <span class="comment"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<a name="l00023"></a>00023 <span class="comment"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<a name="l00024"></a>00024 <span class="comment"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<a name="l00025"></a>00025 <span class="comment"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<a name="l00026"></a>00026 <span class="comment"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF</span>
<a name="l00027"></a>00027 <span class="comment"> * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00028"></a>00028 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00029"></a>00029 <span class="comment"> *</span>
<a name="l00030"></a>00030 <span class="comment"> * For additional information see http://www.ethernut.de/</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * -</span>
<a name="l00033"></a>00033 <span class="comment"> * Portions Copyright (c) 1983, 1993 by</span>
<a name="l00034"></a>00034 <span class="comment"> *  The Regents of the University of California.  All rights reserved.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00037"></a>00037 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00038"></a>00038 <span class="comment"> * are met:</span>
<a name="l00039"></a>00039 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00040"></a>00040 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
<a name="l00041"></a>00041 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00042"></a>00042 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
<a name="l00043"></a>00043 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
<a name="l00044"></a>00044 <span class="comment"> * 3. Neither the name of the University nor the names of its contributors</span>
<a name="l00045"></a>00045 <span class="comment"> *    may be used to endorse or promote products derived from this software</span>
<a name="l00046"></a>00046 <span class="comment"> *    without specific prior written permission.</span>
<a name="l00047"></a>00047 <span class="comment"> *</span>
<a name="l00048"></a>00048 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<a name="l00049"></a>00049 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00050"></a>00050 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00051"></a>00051 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
<a name="l00052"></a>00052 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<a name="l00053"></a>00053 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<a name="l00054"></a>00054 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<a name="l00055"></a>00055 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<a name="l00056"></a>00056 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<a name="l00057"></a>00057 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<a name="l00058"></a>00058 <span class="comment"> * SUCH DAMAGE.</span>
<a name="l00059"></a>00059 <span class="comment"> * -</span>
<a name="l00060"></a>00060 <span class="comment"> * Portions Copyright (c) 1993 by Digital Equipment Corporation.</span>
<a name="l00061"></a>00061 <span class="comment"> *</span>
<a name="l00062"></a>00062 <span class="comment"> * Permission to use, copy, modify, and distribute this software for any</span>
<a name="l00063"></a>00063 <span class="comment"> * purpose with or without fee is hereby granted, provided that the above</span>
<a name="l00064"></a>00064 <span class="comment"> * copyright notice and this permission notice appear in all copies, and that</span>
<a name="l00065"></a>00065 <span class="comment"> * the name of Digital Equipment Corporation not be used in advertising or</span>
<a name="l00066"></a>00066 <span class="comment"> * publicity pertaining to distribution of the document or software without</span>
<a name="l00067"></a>00067 <span class="comment"> * specific, written prior permission.</span>
<a name="l00068"></a>00068 <span class="comment"> *</span>
<a name="l00069"></a>00069 <span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND DIGITAL EQUIPMENT CORP. DISCLAIMS ALL</span>
<a name="l00070"></a>00070 <span class="comment"> * WARRANTIES WITH REGARD TO THIS SOFTWARE, INCLUDING ALL IMPLIED WARRANTIES</span>
<a name="l00071"></a>00071 <span class="comment"> * OF MERCHANTABILITY AND FITNESS.   IN NO EVENT SHALL DIGITAL EQUIPMENT</span>
<a name="l00072"></a>00072 <span class="comment"> * CORPORATION BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL</span>
<a name="l00073"></a>00073 <span class="comment"> * DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR</span>
<a name="l00074"></a>00074 <span class="comment"> * PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS</span>
<a name="l00075"></a>00075 <span class="comment"> * ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS</span>
<a name="l00076"></a>00076 <span class="comment"> * SOFTWARE.</span>
<a name="l00077"></a>00077 <span class="comment"> */</span>
<a name="l00078"></a>00078 
<a name="l00199"></a>00199 <span class="preprocessor">#include &lt;<a class="code" href="os_8h.html">cfg/os.h</a>&gt;</span>
<a name="l00200"></a>00200 <span class="preprocessor">#include &lt;<a class="code" href="thread_8h.html" title="Thread management definitions.">sys/thread.h</a>&gt;</span>
<a name="l00201"></a>00201 <span class="preprocessor">#include &lt;<a class="code" href="event_8h.html" title="Event management definitions.">sys/event.h</a>&gt;</span>
<a name="l00202"></a>00202 <span class="preprocessor">#include &lt;<a class="code" href="sys_2timer_8h.html" title="Timer management definitions.">sys/timer.h</a>&gt;</span>
<a name="l00203"></a>00203 <span class="preprocessor">#include &lt;<a class="code" href="confnet_8h.html" title="Header file for network configuration.">sys/confnet.h</a>&gt;</span>
<a name="l00204"></a>00204 <span class="preprocessor">#include &lt;<a class="code" href="confos_8h.html" title="Header file for global system configuration.">sys/confos.h</a>&gt;</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00207"></a>00207 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00208"></a>00208 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Standard C time handling functions.">time.h</a>&gt;</span>
<a name="l00209"></a>00209 <span class="preprocessor">#include &lt;<a class="code" href="memdebug_8h.html">memdebug.h</a>&gt;</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="preprocessor">#include &lt;<a class="code" href="inet_8h.html" title="Internet address conversion.">arpa/inet.h</a>&gt;</span>
<a name="l00212"></a>00212 <span class="preprocessor">#include &lt;<a class="code" href="in_8h.html" title="Internet definitions.">netinet/in.h</a>&gt;</span>
<a name="l00213"></a>00213 <span class="preprocessor">#include &lt;<a class="code" href="netdb_8h.html">netdb.h</a>&gt;</span>
<a name="l00214"></a>00214 <span class="preprocessor">#include &lt;<a class="code" href="route_8h.html" title="Routing information definitions.">net/route.h</a>&gt;</span>
<a name="l00215"></a>00215 <span class="preprocessor">#include &lt;<a class="code" href="socket_8h.html" title="UDP and TCP socket interface definitions.">sys/socket.h</a>&gt;</span>
<a name="l00216"></a>00216 <span class="preprocessor">#include &lt;<a class="code" href="pro_2dhcp_8h.html" title="DHCP protocol definitions.">pro/dhcp.h</a>&gt;</span>
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="netdebug_8h.html">net/netdebug.h</a>&gt;</span>
<a name="l00220"></a>00220 <span class="preprocessor">#endif</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>
<a name="l00222"></a>00222 <span class="preprocessor">#if 0</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span><span class="comment">/* Use for local debugging. */</span>
<a name="l00224"></a>00224 <span class="preprocessor">#define NUTDEBUG</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="stdio_8h.html" title="C Standard I/O.">stdio.h</a>&gt;</span>
<a name="l00226"></a>00226 <span class="preprocessor">#define __tcp_trs stdout</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> <a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> = 1;
<a name="l00228"></a>00228 <span class="preprocessor">#endif</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>
<a name="l00234"></a>00234 
<a name="l00241"></a>00241 
<a name="l00247"></a>00247 <span class="preprocessor">#ifndef DHCP_SERVERPORT</span>
<a name="l00248"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga3acf53e1d76d3ac7ce7bb68c6e946792">00248</a> <span class="preprocessor"></span><span class="preprocessor">#define DHCP_SERVERPORT      67</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span>
<a name="l00256"></a>00256 <span class="preprocessor">#ifndef DHCP_CLIENTPORT</span>
<a name="l00257"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga79a9a113fa47629510b6d5dd6fef9f83">00257</a> <span class="preprocessor"></span><span class="preprocessor">#define DHCP_CLIENTPORT      68</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>
<a name="l00269"></a>00269 <span class="preprocessor">#ifndef MAX_DHCP_MSGSIZE</span>
<a name="l00270"></a><a class="code" href="group__xg_d_h_c_p_c.html#gad3f666f92061936c7d8be6c00cbf9cd0">00270</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_MSGSIZE    576</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span>
<a name="l00280"></a>00280 <span class="preprocessor">#ifndef MIN_DHCP_MSGSIZE</span>
<a name="l00281"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga270c234bea4dc7da27ee3b5b561d0bc4">00281</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN_DHCP_MSGSIZE    300</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span>
<a name="l00299"></a>00299 <span class="preprocessor">#ifndef MAX_DHCP_BUFSIZE</span>
<a name="l00300"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga800db42c93d35caa64eb2b0d6f492731">00300</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_BUFSIZE    1728</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>
<a name="l00312"></a>00312 <span class="preprocessor">#ifndef MIN_DHCP_WAIT</span>
<a name="l00313"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga4ab1c132c4f2daaab22d85b3d4afe984">00313</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN_DHCP_WAIT       4000</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span>
<a name="l00324"></a>00324 <span class="preprocessor">#ifndef MAX_DHCP_WAIT</span>
<a name="l00325"></a><a class="code" href="group__xg_d_h_c_p_c.html#gacd76719c532ca403fc624016fd56ade3">00325</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_WAIT       64000</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>
<a name="l00336"></a>00336 <span class="preprocessor">#ifndef MAX_DCHP_RETRIES</span>
<a name="l00337"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga0f2c916299b753d6201f90917d83793a">00337</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DCHP_RETRIES    3</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span>
<a name="l00348"></a>00348 <span class="preprocessor">#ifndef MAX_DCHP_RELEASE_RETRIES</span>
<a name="l00349"></a><a class="code" href="group__xg_d_h_c_p_c.html#gab9e5603e983fc563188a47a2397537d8">00349</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DCHP_RELEASE_RETRIES    0</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span>
<a name="l00359"></a>00359 <span class="preprocessor">#ifndef DHCP_DEFAULT_LEASE</span>
<a name="l00360"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga7574583d7750943017fa8cde5ee952a0">00360</a> <span class="preprocessor"></span><span class="preprocessor">#define DHCP_DEFAULT_LEASE  43200</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>
<a name="l00368"></a>00368 <span class="preprocessor">#ifndef MAX_DHCP_NAPTIME</span>
<a name="l00369"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga954acae12281d9d625376976442a5713">00369</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_DHCP_NAPTIME    4294967</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00371"></a>00371 <span class="preprocessor"></span>
<a name="l00377"></a>00377 <span class="preprocessor">#ifndef NUT_THREAD_DHCPSTACK</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span><span class="preprocessor">#if defined(__AVR__)</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span><span class="preprocessor">#if defined(__GNUC__)</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span><span class="comment">/* avr-gcc size optimized code used 192 bytes. */</span>
<a name="l00381"></a>00381 <span class="preprocessor">#define NUT_THREAD_DHCPSTACK    288</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span><span class="comment">/* icc-avr v7.19 used 360 bytes. */</span>
<a name="l00384"></a>00384 <span class="preprocessor">#define NUT_THREAD_DHCPSTACK    512</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span><span class="comment">/* arm-elf-gcc used 276 bytes with size optimized, 680 bytes with debug code. */</span>
<a name="l00388"></a>00388 <span class="comment">/* arm-none-eabi creates stack overflow with 384 bytes on EIR 1.0 board. */</span>
<a name="l00389"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga2f3a479eff1da93bc057498174f94f78">00389</a> <span class="preprocessor">#define NUT_THREAD_DHCPSTACK    512</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>
<a name="l00401"></a>00401 
<a name="l00404"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga368aca81d0a71853aa3939f546cc25ae">00404</a> <span class="preprocessor">#define DHCP_DISCOVER   1</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>
<a name="l00410"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga4649df4abbae20e28fe422d09decd450">00410</a> <span class="preprocessor">#define DHCP_OFFER      2</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>
<a name="l00419"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga98a346c53c91848070fd980a98fa77d1">00419</a> <span class="preprocessor">#define DHCP_REQUEST    3</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>
<a name="l00425"></a><a class="code" href="group__xg_d_h_c_p_c.html#gae7469660afdf7997c020f7fbf5164548">00425</a> <span class="preprocessor">#define DHCP_DECLINE    4</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>
<a name="l00431"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e">00431</a> <span class="preprocessor">#define DHCP_ACK        5</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span>
<a name="l00437"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221">00437</a> <span class="preprocessor">#define DHCP_NAK        6</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>
<a name="l00441"></a><a class="code" href="group__xg_d_h_c_p_c.html#gae629d2dc5df40f03ea87cc94a5e3f3eb">00441</a> <span class="preprocessor">#define DHCP_RELEASE    7</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>
<a name="l00447"></a><a class="code" href="group__xg_d_h_c_p_c.html#gaaea6a969c0da81c2611885514bbe433f">00447</a> <span class="preprocessor">#define DHCP_INFORM     8</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span>
<a name="l00458"></a>00458 
<a name="l00465"></a><a class="code" href="group__xg_d_h_c_p_c.html#gae4c88fabfacd94d1c6ba3e4334d0ba3a">00465</a> <span class="preprocessor">#define DHCPOPT_PAD          0</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>
<a name="l00470"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga674742203c633d7b8d832acaddbc0e97">00470</a> <span class="preprocessor">#define DHCPOPT_NETMASK      1</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>
<a name="l00475"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga94a8a8a86b5c060777a78985ba8a5b3c">00475</a> <span class="preprocessor">#define DHCPOPT_GATEWAY      3</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span>
<a name="l00480"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga91e45feb40748587587943ec54bbd84b">00480</a> <span class="preprocessor">#define DHCPOPT_DNS          6</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span>
<a name="l00485"></a><a class="code" href="group__xg_d_h_c_p_c.html#gafeee77350e816dc77536191de1f96d18">00485</a> <span class="preprocessor">#define DHCPOPT_HOSTNAME     12</span>
<a name="l00486"></a>00486 <span class="preprocessor"></span>
<a name="l00490"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga016f2d39467829054af8983362cf3f25">00490</a> <span class="preprocessor">#define DHCPOPT_DOMAIN       15</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>
<a name="l00495"></a><a class="code" href="group__xg_d_h_c_p_c.html#gaf3a20d70f3031064737e2590bbb11117">00495</a> <span class="preprocessor">#define DHCPOPT_BROADCAST    28</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>
<a name="l00500"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga9c2fb45faa505750ea030d53c9358461">00500</a> <span class="preprocessor">#define DHCPOPT_REQESTIP     50</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>
<a name="l00505"></a><a class="code" href="group__xg_d_h_c_p_c.html#gab6526238588621f1a79810fa60844a06">00505</a> <span class="preprocessor">#define DHCPOPT_LEASETIME    51</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span>
<a name="l00510"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga656aec5e7e57c681b762299c5e2aedee">00510</a> <span class="preprocessor">#define DHCPOPT_MSGTYPE      53</span>
<a name="l00511"></a>00511 <span class="preprocessor"></span>
<a name="l00515"></a><a class="code" href="group__xg_d_h_c_p_c.html#gaded839fd1ad6d43e60374db9e13cab34">00515</a> <span class="preprocessor">#define DHCPOPT_SID          54</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span>
<a name="l00520"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga77d347bafe70ed15f161851d06dacf53">00520</a> <span class="preprocessor">#define DHCPOPT_PARAMREQUEST 55</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span>
<a name="l00525"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga2c7a6575a0b44e10eaef28472a0daa01">00525</a> <span class="preprocessor">#define DHCPOPT_MAXMSGSIZE   57</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span>
<a name="l00530"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga196e0f2e83a278ac19f8f31c64bdac0b">00530</a> <span class="preprocessor">#define DHCPOPT_RENEWALTIME  58</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>
<a name="l00535"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga8f8581ab278c2f8db2eb5a7b0bc9a91a">00535</a> <span class="preprocessor">#define DHCPOPT_REBINDTIME   59</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>
<a name="l00540"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga4e0c63157dd2df622328943ac434e1cf">00540</a> <span class="preprocessor">#define DHCPOPT_END          255</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>
<a name="l00547"></a><a class="code" href="group__xg_d_h_c_p_c.html#gace212e07de7210967671e3544c3c786f">00547</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structbootp.html" title="BOOTP message structure.">bootp</a> <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a>;
<a name="l00548"></a>00548 
<a name="l00552"></a><a class="code" href="structbootp.html">00552</a> <span class="keyword">struct </span><a class="code" href="icc_8h.html#a9d373a9b65ff25b2db84c07394e1c212" title="Object attribute support.">__attribute__</a> ((packed)) <a class="code" href="structbootp.html" title="BOOTP message structure.">bootp</a> {
<a name="l00553"></a><a class="code" href="structbootp.html#a36e1dd7e7b3adc1012590e0abf187b3c">00553</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="structbootp.html#a36e1dd7e7b3adc1012590e0abf187b3c" title="Packet opcode type: 1=request, 2=reply.">bp_op</a>;              
<a name="l00554"></a><a class="code" href="structbootp.html#a447cf4e6908d606159aa7dbe97b16738">00554</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="structbootp.html#a447cf4e6908d606159aa7dbe97b16738" title="Hardware address type: 1=Ethernet.">bp_htype</a>;           
<a name="l00555"></a><a class="code" href="structbootp.html#ad49711938cf665d3f7bac20f123bf603">00555</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="structbootp.html#ad49711938cf665d3f7bac20f123bf603" title="Hardware address length: 6 for Ethernet.">bp_hlen</a>;            
<a name="l00556"></a><a class="code" href="structbootp.html#a604aee4ec8df26b01d286699c4e01ef0">00556</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="structbootp.html#a604aee4ec8df26b01d286699c4e01ef0" title="Gateway hops.">bp_hops</a>;            
<a name="l00557"></a><a class="code" href="structbootp.html#a2a0effb3e0f992700b85f593b4541271">00557</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structbootp.html#a2a0effb3e0f992700b85f593b4541271" title="Transaction ID.">bp_xid</a>;              
<a name="l00558"></a><a class="code" href="structbootp.html#aaba6c7ef415c5b3dc032589069006f8e">00558</a>     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="structbootp.html#aaba6c7ef415c5b3dc032589069006f8e" title="Seconds since boot began.">bp_secs</a>;            
<a name="l00559"></a><a class="code" href="structbootp.html#ad925eb66a6be60b26610eb224d583049">00559</a>     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> <a class="code" href="structbootp.html#ad925eb66a6be60b26610eb224d583049" title="RFC1532 broadcast, etc.">bp_flags</a>;           
<a name="l00560"></a><a class="code" href="structbootp.html#a90f14f14a5bda582e8d5d27cb3962e39">00560</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structbootp.html#a90f14f14a5bda582e8d5d27cb3962e39" title="Client IP address.">bp_ciaddr</a>;           
<a name="l00561"></a><a class="code" href="structbootp.html#ab2b981f7226cdaedc2be820be26932ab">00561</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structbootp.html#ab2b981f7226cdaedc2be820be26932ab" title="&#39;Your&#39; IP address">bp_yiaddr</a>;           
<a name="l00562"></a><a class="code" href="structbootp.html#acf9ca7e3cb1b6cf0481fe27e6870a1aa">00562</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structbootp.html#acf9ca7e3cb1b6cf0481fe27e6870a1aa" title="Server IP address.">bp_siaddr</a>;           
<a name="l00563"></a><a class="code" href="structbootp.html#ab3e8d6ec120cb6773f1b4342b30f53e9">00563</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structbootp.html#ab3e8d6ec120cb6773f1b4342b30f53e9" title="Gateway IP address.">bp_giaddr</a>;           
<a name="l00564"></a><a class="code" href="structbootp.html#aa6c7be0d245875e80de0aec61bb8bbda">00564</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_chaddr[16];      
<a name="l00565"></a><a class="code" href="structbootp.html#ae5d27efec1b542d6b3420e7848d28d4b">00565</a>     <span class="keywordtype">char</span> bp_sname[64];          
<a name="l00566"></a><a class="code" href="structbootp.html#a2328a1358dc32bb596d16660e355d315">00566</a>     <span class="keywordtype">char</span> bp_file[128];          
<a name="l00567"></a><a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b">00567</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> bp_options[312];    
<a name="l00568"></a>00568 };
<a name="l00569"></a>00569 
<a name="l00573"></a><a class="code" href="group__xg_d_h_c_p_c.html#gac56b6eea66869e71711c32cee953ee59">00573</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">dyn_cfg</a> <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a>;
<a name="l00574"></a>00574 
<a name="l00578"></a><a class="code" href="structdyn__cfg.html">00578</a> <span class="keyword">struct </span><a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">dyn_cfg</a> {
<a name="l00579"></a><a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215">00579</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a>;         
<a name="l00580"></a><a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c">00580</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>;          
<a name="l00581"></a><a class="code" href="structdyn__cfg.html#a2451feada0200db194e27e4b8ab23fcd">00581</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a2451feada0200db194e27e4b8ab23fcd" title="Local IP netmask.">dyn_netmask</a>;         
<a name="l00582"></a><a class="code" href="structdyn__cfg.html#a9d637b82508b35557aa5bcc8f19f9bd9">00582</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a9d637b82508b35557aa5bcc8f19f9bd9" title="Local IP broadcast address.">dyn_broadcast</a>;       
<a name="l00583"></a><a class="code" href="structdyn__cfg.html#a01e42f8db0a5032d178ef42677c85980">00583</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a01e42f8db0a5032d178ef42677c85980" title="Default gate IP address.">dyn_gateway</a>;         
<a name="l00584"></a><a class="code" href="structdyn__cfg.html#a13c0470be95b037b0c1100bc1a2d4446">00584</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a13c0470be95b037b0c1100bc1a2d4446" title="Primary DNS IP address.">dyn_pdns</a>;            
<a name="l00585"></a><a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a">00585</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a" title="Secondary DNS IP address.">dyn_sdns</a>;            
<a name="l00586"></a><a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf">00586</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a>;             
<a name="l00587"></a><a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869">00587</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a>;     
<a name="l00588"></a><a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0">00588</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a>;      
<a name="l00589"></a><a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba">00589</a>     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> <a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba" title="Offered lease time in seconds.">dyn_leaseTime</a>;       
<a name="l00590"></a><a class="code" href="structdyn__cfg.html#a25b592e63981f1ec4a2a83927be921a3">00590</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *<a class="code" href="structdyn__cfg.html#a25b592e63981f1ec4a2a83927be921a3" title="Local hostname.">dyn_hostname</a>;      
<a name="l00591"></a><a class="code" href="structdyn__cfg.html#a98facbe6e45b15996ba186e7e918663b">00591</a>     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *<a class="code" href="structdyn__cfg.html#a98facbe6e45b15996ba186e7e918663b" title="Name of local domain.">dyn_domain</a>;        
<a name="l00592"></a>00592 };
<a name="l00593"></a>00593 
<a name="l00600"></a>00600 <span class="keyword">static</span> <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> *dhcpConfig;
<a name="l00601"></a>00601 
<a name="l00608"></a>00608 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#aa8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> dhcpThread;
<a name="l00609"></a>00609 
<a name="l00613"></a>00613 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> dhcpState;
<a name="l00614"></a>00614 
<a name="l00618"></a>00618 <span class="keyword">static</span> <span class="keywordtype">int</span> dhcpError;
<a name="l00619"></a>00619 
<a name="l00625"></a>00625 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#aa8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> dhcpWake;
<a name="l00626"></a>00626 
<a name="l00632"></a>00632 <span class="keyword">static</span> <a class="code" href="nut__types_8h.html#aa8c0374618b33785ccb02f74bcfebc46" title="Void pointer.">HANDLE</a> dhcpDone;
<a name="l00633"></a>00633 
<a name="l00639"></a>00639 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> dhcpApiTimeout;
<a name="l00640"></a>00640 
<a name="l00647"></a>00647 <span class="keyword">static</span> <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> dhcpApiStart;
<a name="l00648"></a>00648 
<a name="l00655"></a>00655 <span class="preprocessor">#ifdef __arm__</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dhcpDev;
<a name="l00657"></a>00657 <span class="preprocessor">#endif</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span>
<a name="l00670"></a>00670 <span class="keyword">static</span> <span class="keywordtype">void</span> copy_str(<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ** dst, <span class="keywordtype">void</span> *src, <span class="keywordtype">int</span> len)
<a name="l00671"></a>00671 {
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (*dst) {
<a name="l00673"></a>00673         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(*dst);
<a name="l00674"></a>00674     }
<a name="l00675"></a>00675     <span class="keywordflow">if</span> ((*dst = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(len + 1)) != 0) {
<a name="l00676"></a>00676         <span class="keywordflow">if</span> (len) {
<a name="l00677"></a>00677             <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(*dst, src, len);
<a name="l00678"></a>00678         }
<a name="l00679"></a>00679         *(*dst + len) = 0;
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681 }
<a name="l00682"></a>00682 
<a name="l00690"></a>00690 <span class="keyword">static</span> <span class="keywordtype">void</span> ReleaseDynCfg(<a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> * dyncfg)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     <span class="keywordflow">if</span> (dyncfg) {
<a name="l00693"></a>00693         <span class="keywordflow">if</span> (dyncfg-&gt;<a class="code" href="structdyn__cfg.html#a25b592e63981f1ec4a2a83927be921a3" title="Local hostname.">dyn_hostname</a>) {
<a name="l00694"></a>00694             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(dyncfg-&gt;<a class="code" href="structdyn__cfg.html#a25b592e63981f1ec4a2a83927be921a3" title="Local hostname.">dyn_hostname</a>);
<a name="l00695"></a>00695         }
<a name="l00696"></a>00696         <span class="keywordflow">if</span> (dyncfg-&gt;<a class="code" href="structdyn__cfg.html#a98facbe6e45b15996ba186e7e918663b" title="Name of local domain.">dyn_domain</a>) {
<a name="l00697"></a>00697             <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(dyncfg-&gt;<a class="code" href="structdyn__cfg.html#a98facbe6e45b15996ba186e7e918663b" title="Name of local domain.">dyn_domain</a>);
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699         <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(dyncfg);
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00714"></a>00714 <span class="keyword">static</span> <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> *ParseReply(<a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <span class="keywordtype">int</span> len)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op;
<a name="l00717"></a>00717     <span class="keywordtype">int</span> left;
<a name="l00718"></a>00718     <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> *cfgp;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720     <span class="comment">/* Allocate and initialize a new structure. */</span>
<a name="l00721"></a>00721     <span class="keywordflow">if</span> ((cfgp = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a>))) == 0) {
<a name="l00722"></a>00722         <span class="keywordflow">return</span> 0;
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724     <a class="code" href="group__xg_crt_string.html#gaa4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(cfgp, 0, <span class="keyword">sizeof</span>(<a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a>));
<a name="l00725"></a>00725     cfgp-&gt;<a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba" title="Offered lease time in seconds.">dyn_leaseTime</a> = <a class="code" href="group__xg_d_h_c_p_c.html#ga7574583d7750943017fa8cde5ee952a0" title="Default lease time in seconds.">DHCP_DEFAULT_LEASE</a>;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     <span class="comment">/* Set the assigned IP address. */</span>
<a name="l00728"></a>00728     <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(&amp;cfgp-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, &amp;bp-&gt;<a class="code" href="structbootp.html#ab2b981f7226cdaedc2be820be26932ab" title="&#39;Your&#39; IP address">bp_yiaddr</a>, 4);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="comment">/*</span>
<a name="l00731"></a>00731 <span class="comment">     * Parse options until an end option is found or until we reached</span>
<a name="l00732"></a>00732 <span class="comment">     * the end of the message.</span>
<a name="l00733"></a>00733 <span class="comment">     */</span>
<a name="l00734"></a>00734     op = bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a> + 4;
<a name="l00735"></a>00735     left = len - (<span class="keyword">sizeof</span>(*bp) - <span class="keyword">sizeof</span>(bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>)) - 4;
<a name="l00736"></a>00736     <span class="keywordflow">while</span> (*op != <a class="code" href="group__xg_d_h_c_p_c.html#ga4e0c63157dd2df622328943ac434e1cf" title="DHCP end option.">DHCPOPT_END</a> &amp;&amp; left &gt; 0) {
<a name="l00737"></a>00737         <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ol;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a>) {
<a name="l00741"></a>00741             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Opt-%u]&quot;</span>, *op);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743 <span class="preprocessor">#endif</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span>        <span class="comment">/* Pad option is used for boundary alignment. */</span>
<a name="l00745"></a>00745         <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gae4c88fabfacd94d1c6ba3e4334d0ba3a" title="DHCP pad option.">DHCPOPT_PAD</a>) {
<a name="l00746"></a>00746             op++;
<a name="l00747"></a>00747             left--;
<a name="l00748"></a>00748             <span class="keywordflow">continue</span>;
<a name="l00749"></a>00749         }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751         <span class="comment">/* Reject if option length exceeds total length. */</span>
<a name="l00752"></a>00752         <span class="keywordflow">if</span> ((ol = *(op + 1)) &gt; left) {
<a name="l00753"></a>00753             <span class="keywordflow">break</span>;
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="comment">/* Type of this message. */</span>
<a name="l00757"></a>00757         <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga656aec5e7e57c681b762299c5e2aedee" title="DHCP message type option.">DHCPOPT_MSGTYPE</a>) {
<a name="l00758"></a>00758             <span class="keywordflow">if</span> (ol != 1) {
<a name="l00759"></a>00759                 <span class="keywordflow">break</span>;
<a name="l00760"></a>00760             }
<a name="l00761"></a>00761             cfgp-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> = *(op + 2);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00764"></a>00764 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; <a class="code" href="netdebug_8h.html#a9950796d9f90f77548eaf6f97645c045">NET_DBG_DHCP</a>) {
<a name="l00765"></a>00765                 <span class="keywordflow">switch</span>(cfgp-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a>) {
<a name="l00766"></a>00766                     <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga4649df4abbae20e28fe422d09decd450" title="Server to client in response to DHCP_DISCOVER.">DHCP_OFFER</a>:
<a name="l00767"></a>00767                         <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;+MSGT-OFFER+\n&quot;</span>);
<a name="l00768"></a>00768                         <span class="keywordflow">break</span>;
<a name="l00769"></a>00769                     <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>:
<a name="l00770"></a>00770                         <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;+MSGT-ACK+\n&quot;</span>);
<a name="l00771"></a>00771                         <span class="keywordflow">break</span>;
<a name="l00772"></a>00772                     <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>:
<a name="l00773"></a>00773                         <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;-MSGT-NAK-\n&quot;</span>);
<a name="l00774"></a>00774                         <span class="keywordflow">break</span>;
<a name="l00775"></a>00775                     <span class="keywordflow">default</span>:
<a name="l00776"></a>00776                         <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;#MSGT-UNK#\n&quot;</span>);
<a name="l00777"></a>00777                         <span class="keywordflow">break</span>;
<a name="l00778"></a>00778                 }
<a name="l00779"></a>00779             }
<a name="l00780"></a>00780 <span class="preprocessor">#endif</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>        }
<a name="l00782"></a>00782         <span class="comment">/* Our host name. May or may not include the domain. */</span>
<a name="l00783"></a>00783         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gafeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>) {
<a name="l00784"></a>00784             copy_str(&amp;cfgp-&gt;<a class="code" href="structdyn__cfg.html#a25b592e63981f1ec4a2a83927be921a3" title="Local hostname.">dyn_hostname</a>, op + 2, ol);
<a name="l00785"></a>00785         }
<a name="l00786"></a>00786         <span class="comment">/* Name of the domain we are in. */</span>
<a name="l00787"></a>00787         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga016f2d39467829054af8983362cf3f25" title="DHCP domain name option.">DHCPOPT_DOMAIN</a>) {
<a name="l00788"></a>00788             copy_str(&amp;cfgp-&gt;<a class="code" href="structdyn__cfg.html#a98facbe6e45b15996ba186e7e918663b" title="Name of local domain.">dyn_domain</a>, op + 2, ol);
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         <span class="comment">/* All remaining options require at least 4 octets. */</span>
<a name="l00792"></a>00792         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ol &gt;= 4) {
<a name="l00793"></a>00793             <span class="comment">/* Preset most often used long value. */</span>
<a name="l00794"></a>00794             <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> lval = *(op + 2);
<a name="l00795"></a>00795             lval += (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 3)) &lt;&lt; 8;
<a name="l00796"></a>00796             lval += (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 4)) &lt;&lt; 16;
<a name="l00797"></a>00797             lval += (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 5)) &lt;&lt; 24;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799             <span class="comment">/* Our IP network mask. */</span>
<a name="l00800"></a>00800             <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga674742203c633d7b8d832acaddbc0e97" title="DHCP subnet mask option.">DHCPOPT_NETMASK</a>) {
<a name="l00801"></a>00801                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a2451feada0200db194e27e4b8ab23fcd" title="Local IP netmask.">dyn_netmask</a> = lval;
<a name="l00802"></a>00802             }
<a name="l00803"></a>00803             <span class="comment">/* Our IP broadcast address. */</span>
<a name="l00804"></a>00804             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gaf3a20d70f3031064737e2590bbb11117" title="DHCP broadcast address option.">DHCPOPT_BROADCAST</a>) {
<a name="l00805"></a>00805                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a9d637b82508b35557aa5bcc8f19f9bd9" title="Local IP broadcast address.">dyn_broadcast</a> = lval;
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807             <span class="comment">/* Our IP default gate. More than one gateway may be</span>
<a name="l00808"></a>00808 <span class="comment">               specified. We take the fist one only and ignore the</span>
<a name="l00809"></a>00809 <span class="comment">               rest. */</span>
<a name="l00810"></a>00810             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga94a8a8a86b5c060777a78985ba8a5b3c" title="DHCP router option.">DHCPOPT_GATEWAY</a>) {
<a name="l00811"></a>00811                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a01e42f8db0a5032d178ef42677c85980" title="Default gate IP address.">dyn_gateway</a> = lval;
<a name="l00812"></a>00812             }
<a name="l00813"></a>00813             <span class="comment">/* Our DNS server. Updated by Jelle Martijn Kok to</span>
<a name="l00814"></a>00814 <span class="comment">               support a secondary DNS. */</span>
<a name="l00815"></a>00815             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga91e45feb40748587587943ec54bbd84b" title="DHCP domain name server option.">DHCPOPT_DNS</a>) {
<a name="l00816"></a>00816                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a13c0470be95b037b0c1100bc1a2d4446" title="Primary DNS IP address.">dyn_pdns</a> = lval;
<a name="l00817"></a>00817                 <span class="keywordflow">if</span> (ol &gt;= 8) {
<a name="l00818"></a>00818                     cfgp-&gt;<a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a" title="Secondary DNS IP address.">dyn_sdns</a> = *(op + 6);
<a name="l00819"></a>00819                     cfgp-&gt;<a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a" title="Secondary DNS IP address.">dyn_sdns</a> += (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 7)) &lt;&lt; 8;
<a name="l00820"></a>00820                     cfgp-&gt;<a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a" title="Secondary DNS IP address.">dyn_sdns</a> += (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 8)) &lt;&lt; 16;
<a name="l00821"></a>00821                     cfgp-&gt;<a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a" title="Secondary DNS IP address.">dyn_sdns</a> += (<a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)(*(op + 9)) &lt;&lt; 24;
<a name="l00822"></a>00822                 }
<a name="l00823"></a>00823             }
<a name="l00824"></a>00824             <span class="comment">/* Server identifier. */</span>
<a name="l00825"></a>00825             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gaded839fd1ad6d43e60374db9e13cab34" title="DHCP server identifier option.">DHCPOPT_SID</a>) {
<a name="l00826"></a>00826                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a> = lval;
<a name="l00827"></a>00827             }
<a name="l00828"></a>00828             <span class="comment">/* Renewal time. */</span>
<a name="l00829"></a>00829             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga196e0f2e83a278ac19f8f31c64bdac0b" title="DHCP renewal time option.">DHCPOPT_RENEWALTIME</a>) {
<a name="l00830"></a>00830                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> = <a class="code" href="group__xg_nut_o_s.html#gac317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(lval);
<a name="l00831"></a>00831             }
<a name="l00832"></a>00832             <span class="comment">/* Rebinding time. */</span>
<a name="l00833"></a>00833             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#ga8f8581ab278c2f8db2eb5a7b0bc9a91a" title="DHCP rebinding time option.">DHCPOPT_REBINDTIME</a>) {
<a name="l00834"></a>00834                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> = <a class="code" href="group__xg_nut_o_s.html#gac317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(lval);
<a name="l00835"></a>00835             }
<a name="l00836"></a>00836             <span class="comment">/* Total lease time granted. */</span>
<a name="l00837"></a>00837             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*op == <a class="code" href="group__xg_d_h_c_p_c.html#gab6526238588621f1a79810fa60844a06" title="DHCP IP address lease time option.">DHCPOPT_LEASETIME</a>) {
<a name="l00838"></a>00838                 cfgp-&gt;<a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba" title="Offered lease time in seconds.">dyn_leaseTime</a> = <a class="code" href="group__xg_nut_o_s.html#gac317b3e903719ba02894f1710f7f2439" title="Convert long value from network to host byte order.">ntohl</a>(lval);
<a name="l00839"></a>00839             }
<a name="l00840"></a>00840         }
<a name="l00841"></a>00841         op += ol + 2;
<a name="l00842"></a>00842         left -= ol + 2;
<a name="l00843"></a>00843     }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845     <span class="comment">/*</span>
<a name="l00846"></a>00846 <span class="comment">     * Discard this configuration if parsing stopped before reaching</span>
<a name="l00847"></a>00847 <span class="comment">     * the end option or if we didn&#39;t receive an expected message type.</span>
<a name="l00848"></a>00848 <span class="comment">     */</span>
<a name="l00849"></a>00849     <span class="keywordflow">if</span> (*op != <a class="code" href="group__xg_d_h_c_p_c.html#ga4e0c63157dd2df622328943ac434e1cf" title="DHCP end option.">DHCPOPT_END</a> ||
<a name="l00850"></a>00850         (cfgp-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> != <a class="code" href="group__xg_d_h_c_p_c.html#ga4649df4abbae20e28fe422d09decd450" title="Server to client in response to DHCP_DISCOVER.">DHCP_OFFER</a> &amp;&amp;
<a name="l00851"></a>00851          cfgp-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> != <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a> &amp;&amp;
<a name="l00852"></a>00852          cfgp-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> != <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>)) {
<a name="l00853"></a>00853 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l00854"></a>00854 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l00855"></a>00855             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Parse Error]&quot;</span>);
<a name="l00856"></a>00856         }
<a name="l00857"></a>00857 <span class="preprocessor">#endif</span>
<a name="l00858"></a>00858 <span class="preprocessor"></span>        ReleaseDynCfg(cfgp);
<a name="l00859"></a>00859         <span class="keywordflow">return</span> 0;
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862     <span class="comment">/* Calculate renewal and rebind times. */</span>
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (cfgp-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> == 0) {
<a name="l00864"></a>00864         cfgp-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> = cfgp-&gt;<a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba" title="Offered lease time in seconds.">dyn_leaseTime</a> / 2;
<a name="l00865"></a>00865     }
<a name="l00866"></a>00866     <span class="keywordflow">if</span> (cfgp-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> == 0) {
<a name="l00867"></a>00867         cfgp-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> = cfgp-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> +  <span class="comment">/* */</span>
<a name="l00868"></a>00868             cfgp-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> / 2 + <span class="comment">/* */</span>
<a name="l00869"></a>00869             cfgp-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> / 4;
<a name="l00870"></a>00870     }
<a name="l00871"></a>00871     <span class="keywordflow">return</span> cfgp;
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00884"></a>00884 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddOption(<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ot, <span class="keywordtype">void</span> *ov, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> len)
<a name="l00885"></a>00885 {
<a name="l00886"></a>00886     *op++ = ot;
<a name="l00887"></a>00887     *op++ = len;
<a name="l00888"></a>00888     <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(op, ov, len);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890     <span class="keywordflow">return</span> 2 + len;
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00902"></a>00902 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddByteOption(<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ot, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ov)
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904     *op++ = ot;
<a name="l00905"></a>00905     *op++ = 1;
<a name="l00906"></a>00906     *op++ = ov;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <span class="keywordflow">return</span> 3;
<a name="l00909"></a>00909 }
<a name="l00910"></a>00910 
<a name="l00921"></a>00921 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddShortOption(<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> ot, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> ov)
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923     *op++ = ot;
<a name="l00924"></a>00924     *op++ = 2;
<a name="l00925"></a>00925     ov = <a class="code" href="group__xg_nut_o_s.html#ga51799f5ebb4c7228ef7e95c247030f42" title="Convert short value from host to network byte order.">htons</a>(ov);
<a name="l00926"></a>00926     <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(op, &amp;ov, 2);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     <span class="keywordflow">return</span> 4;
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00943"></a>00943 <span class="keyword">static</span> <span class="keywordtype">size_t</span> DhcpAddParmReqOption(<a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * op)
<a name="l00944"></a>00944 {
<a name="l00945"></a>00945     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#ga77d347bafe70ed15f161851d06dacf53" title="DHCP parameter request list option.">DHCPOPT_PARAMREQUEST</a>;
<a name="l00946"></a>00946     *op++ = 3;                  <span class="comment">/* Adjust when adding more options! */</span>
<a name="l00947"></a>00947     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#ga674742203c633d7b8d832acaddbc0e97" title="DHCP subnet mask option.">DHCPOPT_NETMASK</a>;    <span class="comment">/* Typically sent by default, but play safe. */</span>
<a name="l00948"></a>00948     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#ga94a8a8a86b5c060777a78985ba8a5b3c" title="DHCP router option.">DHCPOPT_GATEWAY</a>;    <span class="comment">/* We want a default gateway. */</span>
<a name="l00949"></a>00949     *op++ = <a class="code" href="group__xg_d_h_c_p_c.html#ga91e45feb40748587587943ec54bbd84b" title="DHCP domain name server option.">DHCPOPT_DNS</a>;        <span class="comment">/* We want the DNS&#39; IP. */</span>
<a name="l00950"></a>00950     <span class="keywordflow">return</span> 5;                   <span class="comment">/* Adjust when adding more options! */</span>
<a name="l00951"></a>00951 }
<a name="l00952"></a>00952 
<a name="l00974"></a>00974 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> DhcpPrepHeader(<a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> msgtyp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> ciaddr, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l00975"></a>00975 {
<a name="l00976"></a>00976     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978     <a class="code" href="group__xg_crt_string.html#gaa4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(bp, 0, <span class="keyword">sizeof</span>(*bp));
<a name="l00979"></a>00979     <span class="comment">/* Clients send bootp requests (op code 1) only. */</span>
<a name="l00980"></a>00980     bp-&gt;<a class="code" href="structbootp.html#a36e1dd7e7b3adc1012590e0abf187b3c" title="Packet opcode type: 1=request, 2=reply.">bp_op</a> = 1;
<a name="l00981"></a>00981     <span class="comment">/* Ethernet addresses are type 1 with 6 octets. */</span>
<a name="l00982"></a>00982     bp-&gt;<a class="code" href="structbootp.html#a447cf4e6908d606159aa7dbe97b16738" title="Hardware address type: 1=Ethernet.">bp_htype</a> = 1;
<a name="l00983"></a>00983     bp-&gt;<a class="code" href="structbootp.html#ad49711938cf665d3f7bac20f123bf603" title="Hardware address length: 6 for Ethernet.">bp_hlen</a> = 6;
<a name="l00984"></a>00984     <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(bp-&gt;<a class="code" href="structbootp.html#aa6c7be0d245875e80de0aec61bb8bbda" title="Client hardware address.">bp_chaddr</a>, <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a60f7de301d8f6a941581d1f587e6c3f6" title="Ethernet MAC address.">cdn_mac</a>, 6);
<a name="l00985"></a>00985     <span class="comment">/* Transaction identifier. */</span>
<a name="l00986"></a>00986     bp-&gt;<a class="code" href="structbootp.html#a2a0effb3e0f992700b85f593b4541271" title="Transaction ID.">bp_xid</a> = xid;
<a name="l00987"></a>00987     <span class="comment">/* Seconds elapsed since address acquisition. */</span>
<a name="l00988"></a>00988     bp-&gt;<a class="code" href="structbootp.html#aaba6c7ef415c5b3dc032589069006f8e" title="Seconds since boot began.">bp_secs</a> = <a class="code" href="group__xg_nut_o_s.html#ga51799f5ebb4c7228ef7e95c247030f42" title="Convert short value from host to network byte order.">htons</a>(secs);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 <span class="preprocessor">#ifdef DHCP_BROADCAST_FLAG</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00992"></a>00992 <span class="comment">     * We do not need the broadcast flag, because our stack accepts IP</span>
<a name="l00993"></a>00993 <span class="comment">     * messages to any destination if no local address has been assigned,</span>
<a name="l00994"></a>00994 <span class="comment">     * However, we continue supporting this compile time option.</span>
<a name="l00995"></a>00995 <span class="comment">     */</span>
<a name="l00996"></a>00996     bp-&gt;<a class="code" href="structbootp.html#ad925eb66a6be60b26610eb224d583049" title="RFC1532 broadcast, etc.">bp_flags</a> = <a class="code" href="group__xg_nut_o_s.html#ga51799f5ebb4c7228ef7e95c247030f42" title="Convert short value from host to network byte order.">htons</a>(0x8000);
<a name="l00997"></a>00997 <span class="preprocessor">#endif</span>
<a name="l00998"></a>00998 <span class="preprocessor"></span>
<a name="l00999"></a>00999     bp-&gt;<a class="code" href="structbootp.html#a90f14f14a5bda582e8d5d27cb3962e39" title="Client IP address.">bp_ciaddr</a> = ciaddr;
<a name="l01000"></a>01000 
<a name="l01001"></a>01001     <span class="comment">/* Add the DHCP magic cookie according to RFC 1497. */</span>
<a name="l01002"></a>01002     op = bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>;
<a name="l01003"></a>01003     *op++ = 0x63;
<a name="l01004"></a>01004     *op++ = 0x82;
<a name="l01005"></a>01005     *op++ = 0x53;
<a name="l01006"></a>01006     *op++ = 0x63;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008     <span class="comment">/* Add the DHCP message type option. */</span>
<a name="l01009"></a>01009     <span class="keywordflow">return</span> DhcpAddByteOption(op, <a class="code" href="group__xg_d_h_c_p_c.html#ga656aec5e7e57c681b762299c5e2aedee" title="DHCP message type option.">DHCPOPT_MSGTYPE</a>, msgtyp) + 4;
<a name="l01010"></a>01010 }
<a name="l01011"></a>01011 
<a name="l01030"></a>01030 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendMessage(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> addr, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <span class="keywordtype">size_t</span> len)
<a name="l01031"></a>01031 {
<a name="l01032"></a>01032     <span class="comment">/* Add &#39;end of options&#39;. */</span>
<a name="l01033"></a>01033     bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>[len++] = <a class="code" href="group__xg_d_h_c_p_c.html#ga4e0c63157dd2df622328943ac434e1cf" title="DHCP end option.">DHCPOPT_END</a>;
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     <span class="comment">/* Maintain a BOOTP compatible minimum packet size of 300 octets.</span>
<a name="l01036"></a>01036 <span class="comment">       Thanks to Tomohiro Haraikawa. */</span>
<a name="l01037"></a>01037     <span class="keywordflow">if</span> ((len += <span class="keyword">sizeof</span>(<a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a>) - <span class="keyword">sizeof</span>(bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>)) &lt; <a class="code" href="group__xg_d_h_c_p_c.html#ga270c234bea4dc7da27ee3b5b561d0bc4" title="Minimum DHCP message length.">MIN_DHCP_MSGSIZE</a>) {
<a name="l01038"></a>01038         len = <a class="code" href="group__xg_d_h_c_p_c.html#ga270c234bea4dc7da27ee3b5b561d0bc4" title="Minimum DHCP message length.">MIN_DHCP_MSGSIZE</a>;
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01041"></a>01041 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l01042"></a>01042         <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Send to %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(addr));
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 <span class="preprocessor">#endif</span>
<a name="l01045"></a>01045 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__xg_udp_socket.html#ga10191929e17f17de9f49c5b1f8822154" title="Send a UDP datagram.">NutUdpSendTo</a>(sock, addr, <a class="code" href="group__xg_d_h_c_p_c.html#ga3acf53e1d76d3ac7ce7bb68c6e946792" title="UDP port of DHCP server.">DHCP_SERVERPORT</a>, bp, len) &lt; 0) {
<a name="l01046"></a>01046         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#ga7406fc3703f9bca15d9acc123d53df7c" title="DHCP transmit error.">DHCPERR_TRANSMIT</a>;
<a name="l01047"></a>01047         <span class="keywordflow">return</span> -1;
<a name="l01048"></a>01048     }
<a name="l01049"></a>01049     <span class="keywordflow">return</span> 0;
<a name="l01050"></a>01050 }
<a name="l01051"></a>01051 
<a name="l01065"></a>01065 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpRecvMessage(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tmo)
<a name="l01066"></a>01066 {
<a name="l01067"></a>01067     <span class="keywordtype">int</span> rc;
<a name="l01068"></a>01068     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> port;
<a name="l01069"></a>01069     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> addr;
<a name="l01070"></a>01070     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> etim;
<a name="l01071"></a>01071     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> wtim;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="comment">/* Set our start time. */</span>
<a name="l01074"></a>01074     etim = <a class="code" href="group__xg_timer.html#gac1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>();
<a name="l01075"></a>01075     <span class="comment">/* Set the initial receive timeout. */</span>
<a name="l01076"></a>01076     wtim = tmo;
<a name="l01077"></a>01077     <span class="keywordflow">for</span> (;;) {
<a name="l01078"></a>01078         rc = <a class="code" href="group__xg_udp_socket.html#ga6b8b9b8ddce0e1024f75c7575d8c9e3b" title="Receive a UDP datagram.">NutUdpReceiveFrom</a>(sock, &amp;addr, &amp;port, bp, <span class="keyword">sizeof</span>(<a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a>), wtim);
<a name="l01079"></a>01079 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l01081"></a>01081             <span class="keywordflow">if</span> (rc &gt; 0) {
<a name="l01082"></a>01082                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Recv from %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(addr));
<a name="l01083"></a>01083             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01084"></a>01084                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Recv Error]&quot;</span>);
<a name="l01085"></a>01085             } <span class="keywordflow">else</span> {
<a name="l01086"></a>01086                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Recv Timeout %lu]&quot;</span>, tmo);
<a name="l01087"></a>01087             }
<a name="l01088"></a>01088         }
<a name="l01089"></a>01089 <span class="preprocessor">#endif</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span>        <span class="comment">/* Immediately return on receive errors and timeouts. */</span>
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (rc &lt;= 0) {
<a name="l01092"></a>01092             <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01093"></a>01093                 dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#ga848d743685215f672e45520af5df2a56" title="DHCP receive error.">DHCPERR_RECEIVE</a>;
<a name="l01094"></a>01094             }
<a name="l01095"></a>01095             <span class="keywordflow">break</span>;
<a name="l01096"></a>01096         }
<a name="l01097"></a>01097         <span class="comment">/* The message must at least include the BOOTP header plus five</span>
<a name="l01098"></a>01098 <span class="comment">           bytes of options (magic and end). We are quite liberal here. */</span>
<a name="l01099"></a>01099         <span class="keywordflow">if</span> (rc &gt; <span class="keyword">sizeof</span>(<a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a>) - <span class="keyword">sizeof</span>(bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>) + 5) {
<a name="l01100"></a>01100             <span class="comment">/* The message must be a BOOTP reply with the expected XID. */</span>
<a name="l01101"></a>01101             <span class="keywordflow">if</span> (bp-&gt;<a class="code" href="structbootp.html#a36e1dd7e7b3adc1012590e0abf187b3c" title="Packet opcode type: 1=request, 2=reply.">bp_op</a> == 2 &amp;&amp; bp-&gt;<a class="code" href="structbootp.html#a2a0effb3e0f992700b85f593b4541271" title="Transaction ID.">bp_xid</a> == xid) {
<a name="l01102"></a>01102                 <span class="comment">/* Message is acceptable. */</span>
<a name="l01103"></a>01103                 <span class="keywordflow">break</span>;
<a name="l01104"></a>01104             }
<a name="l01105"></a>01105         }
<a name="l01106"></a>01106         <span class="comment">/* Calculate the remaining timeout for not getting trapped here</span>
<a name="l01107"></a>01107 <span class="comment">           on a busy network, which regularly broadcasts DHCP messages. */</span>
<a name="l01108"></a>01108         wtim = <a class="code" href="group__xg_timer.html#gac1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() - etim;
<a name="l01109"></a>01109         <span class="keywordflow">if</span> (wtim &gt;= tmo - 250) {
<a name="l01110"></a>01110             <span class="comment">/* Less than 250 ms left, return timeout. */</span>
<a name="l01111"></a>01111             rc = 0;
<a name="l01112"></a>01112             <span class="keywordflow">break</span>;
<a name="l01113"></a>01113         }
<a name="l01114"></a>01114         wtim = tmo - wtim;
<a name="l01115"></a>01115     }
<a name="l01116"></a>01116     <span class="keywordflow">return</span> rc;
<a name="l01117"></a>01117 }
<a name="l01118"></a>01118 
<a name="l01133"></a>01133 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpBroadcastDiscover(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> raddr, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135     <span class="keywordtype">size_t</span> optlen;
<a name="l01136"></a>01136     <span class="keywordtype">int</span> len;
<a name="l01137"></a>01137     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#ga368aca81d0a71853aa3939f546cc25ae" title="Client broadcast to locate available servers.">DHCP_DISCOVER</a>, xid, 0, secs);
<a name="l01140"></a>01140 
<a name="l01141"></a>01141     <span class="comment">/* Request a specific IP if one had been assigned previously. */</span>
<a name="l01142"></a>01142     <span class="keywordflow">if</span> (raddr) {
<a name="l01143"></a>01143         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#ga9c2fb45faa505750ea030d53c9358461" title="DHCP requested IP address option.">DHCPOPT_REQESTIP</a>, &amp;raddr, <span class="keyword">sizeof</span>(raddr));
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146     optlen += DhcpAddParmReqOption(op + optlen);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148     <span class="comment">/* Pass host name if specified in confos structure.</span>
<a name="l01149"></a>01149 <span class="comment">     * Win2k DHCP server can register this as dynamic DNS entry.</span>
<a name="l01150"></a>01150 <span class="comment">     * Also viewing DHCP lease table shows something sensible.</span>
<a name="l01151"></a>01151 <span class="comment">     */</span>
<a name="l01152"></a>01152     len = <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(<a class="code" href="group__xg_conf_os.html#gae98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.<a class="code" href="struct___c_o_n_f_o_s.html#aa17ae44378303bf9095f545f37217e81" title="Host name of the system.">hostname</a>);
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l01154"></a>01154         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gafeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>, <a class="code" href="group__xg_conf_os.html#gae98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.<a class="code" href="struct___c_o_n_f_o_s.html#aa17ae44378303bf9095f545f37217e81" title="Host name of the system.">hostname</a>, len);
<a name="l01155"></a>01155     }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="comment">/* Request a maximum message size. */</span>
<a name="l01158"></a>01158     optlen += DhcpAddShortOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#ga2c7a6575a0b44e10eaef28472a0daa01" title="Maximum DHCP message size option.">DHCPOPT_MAXMSGSIZE</a>, <a class="code" href="group__xg_d_h_c_p_c.html#gad3f666f92061936c7d8be6c00cbf9cd0" title="Maximum DHCP message size we can accept.">MAX_DHCP_MSGSIZE</a>);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     <span class="keywordflow">return</span> DhcpSendMessage(sock, <a class="code" href="in_8h.html#a4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>, bp, optlen);
<a name="l01161"></a>01161 }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 
<a name="l01183"></a>01183 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendRequest(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> daddr, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid,        <span class="comment">/* */</span>
<a name="l01184"></a>01184                            <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> caddr, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> raddr, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> sid, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l01185"></a>01185 {
<a name="l01186"></a>01186     <span class="keywordtype">size_t</span> optlen;
<a name="l01187"></a>01187     <span class="keywordtype">int</span> len;
<a name="l01188"></a>01188     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     <span class="comment">/* Initialize the BOOTP header. */</span>
<a name="l01191"></a>01191     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#ga98a346c53c91848070fd980a98fa77d1" title="Client message to servers.">DHCP_REQUEST</a>, xid, caddr, secs);
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     <span class="comment">/* Add specified options. */</span>
<a name="l01194"></a>01194     <span class="keywordflow">if</span> (raddr) {
<a name="l01195"></a>01195         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#ga9c2fb45faa505750ea030d53c9358461" title="DHCP requested IP address option.">DHCPOPT_REQESTIP</a>, &amp;raddr, <span class="keyword">sizeof</span>(raddr));
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197     <span class="keywordflow">if</span> (sid) {
<a name="l01198"></a>01198         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gaded839fd1ad6d43e60374db9e13cab34" title="DHCP server identifier option.">DHCPOPT_SID</a>, &amp;sid, <span class="keyword">sizeof</span>(sid));
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200     optlen += DhcpAddParmReqOption(op + optlen);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     <span class="comment">/* Pass host name if specified in confos structure.  */</span>
<a name="l01203"></a>01203     <span class="comment">/* viewing DHCP lease table shows something sensible. */</span>
<a name="l01204"></a>01204     len = <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(<a class="code" href="group__xg_conf_os.html#gae98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.<a class="code" href="struct___c_o_n_f_o_s.html#aa17ae44378303bf9095f545f37217e81" title="Host name of the system.">hostname</a>);
<a name="l01205"></a>01205     <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l01206"></a>01206         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gafeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>, <a class="code" href="group__xg_conf_os.html#gae98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.<a class="code" href="struct___c_o_n_f_o_s.html#aa17ae44378303bf9095f545f37217e81" title="Host name of the system.">hostname</a>, len);
<a name="l01207"></a>01207     }
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="keywordflow">return</span> DhcpSendMessage(sock, daddr, bp, optlen);
<a name="l01210"></a>01210 }
<a name="l01211"></a>01211 
<a name="l01230"></a>01230 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpBroadcastRequest(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid, <span class="comment">/* */</span>
<a name="l01231"></a>01231                                 <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> caddr, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> raddr, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> sid, <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs)
<a name="l01232"></a>01232 {
<a name="l01233"></a>01233     <span class="keywordflow">return</span> DhcpSendRequest(sock, <a class="code" href="in_8h.html#a4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>, bp, xid, caddr, raddr, sid, secs);
<a name="l01234"></a>01234 }
<a name="l01235"></a>01235 
<a name="l01251"></a>01251 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendRelease(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> daddr, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> caddr, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> sid)
<a name="l01252"></a>01252 {
<a name="l01253"></a>01253     <span class="keywordtype">size_t</span> optlen;
<a name="l01254"></a>01254     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     <span class="comment">/* Prepare BOOTP header. &#39;secs&#39; is set to zero. */</span>
<a name="l01257"></a>01257     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#gae629d2dc5df40f03ea87cc94a5e3f3eb" title="Client to server relinquishing network address and cancelling remaining lease.">DHCP_RELEASE</a>, xid, caddr, 0);
<a name="l01258"></a>01258 
<a name="l01259"></a>01259     <span class="comment">/* Optionally add server identifier. */</span>
<a name="l01260"></a>01260     <span class="keywordflow">if</span> (sid) {
<a name="l01261"></a>01261         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gaded839fd1ad6d43e60374db9e13cab34" title="DHCP server identifier option.">DHCPOPT_SID</a>, &amp;sid, <span class="keyword">sizeof</span>(sid));
<a name="l01262"></a>01262     }
<a name="l01263"></a>01263     <span class="keywordflow">return</span> DhcpSendMessage(sock, daddr, bp, optlen);
<a name="l01264"></a>01264 }
<a name="l01265"></a>01265 
<a name="l01278"></a>01278 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpSendInform(<a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> * sock, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> daddr, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> caddr)
<a name="l01279"></a>01279 {
<a name="l01280"></a>01280     <span class="keywordtype">size_t</span> optlen;
<a name="l01281"></a>01281     <span class="keywordtype">size_t</span> len;
<a name="l01282"></a>01282     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> *op = bp-&gt;<a class="code" href="structbootp.html#a72e53591c71a3e046066aa48985a7d5b" title="Vendor-specific area.">bp_options</a>;
<a name="l01283"></a>01283 
<a name="l01284"></a>01284     <span class="comment">/* Prepare BOOTP header. &#39;secs&#39; is set to zero. */</span>
<a name="l01285"></a>01285     optlen = DhcpPrepHeader(bp, <a class="code" href="group__xg_d_h_c_p_c.html#gaaea6a969c0da81c2611885514bbe433f" title="Client to server, asking only for local configuration parameters.">DHCP_INFORM</a>, xid, caddr, 0);
<a name="l01286"></a>01286 
<a name="l01287"></a>01287     <span class="comment">/* Additional options we want. */</span>
<a name="l01288"></a>01288     optlen += DhcpAddParmReqOption(op + optlen);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290     <span class="comment">/* Add our configured host name. */</span>
<a name="l01291"></a>01291     len = <a class="code" href="group__xg_crt_string.html#ga7b9fc4834c90ac78977b5fbb3076c5ac" title="Compute the length of a NUL terminated string.">strlen</a>(<a class="code" href="group__xg_conf_os.html#gae98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.<a class="code" href="struct___c_o_n_f_o_s.html#aa17ae44378303bf9095f545f37217e81" title="Host name of the system.">hostname</a>);
<a name="l01292"></a>01292     <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l01293"></a>01293         optlen += DhcpAddOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#gafeee77350e816dc77536191de1f96d18" title="DHCP host name option.">DHCPOPT_HOSTNAME</a>, <a class="code" href="group__xg_conf_os.html#gae98d016e7c4645211b4c87491df67d4a" title="Global system configuration structure.">confos</a>.<a class="code" href="struct___c_o_n_f_o_s.html#aa17ae44378303bf9095f545f37217e81" title="Host name of the system.">hostname</a>, len);
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296     <span class="comment">/* We should provide the maximum message size. */</span>
<a name="l01297"></a>01297     optlen += DhcpAddShortOption(op + optlen, <a class="code" href="group__xg_d_h_c_p_c.html#ga2c7a6575a0b44e10eaef28472a0daa01" title="Maximum DHCP message size option.">DHCPOPT_MAXMSGSIZE</a>, <a class="code" href="group__xg_d_h_c_p_c.html#gad3f666f92061936c7d8be6c00cbf9cd0" title="Maximum DHCP message size we can accept.">MAX_DHCP_MSGSIZE</a>);
<a name="l01298"></a>01298 
<a name="l01299"></a>01299     <span class="keywordflow">return</span> DhcpSendMessage(sock, daddr, bp, optlen);
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 
<a name="l01302"></a>01302 
<a name="l01313"></a>01313 <span class="keyword">static</span> <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> *CheckOffer(<a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> * dyncfg, <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp, <span class="keywordtype">size_t</span> len)
<a name="l01314"></a>01314 {
<a name="l01315"></a>01315     <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> *offer;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;\n[chkoffer %s &quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>( dyncfg-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>));
<a name="l01319"></a>01319 <span class="preprocessor">#endif</span>
<a name="l01320"></a>01320 <span class="preprocessor"></span>
<a name="l01321"></a>01321     <span class="comment">/* Parse the new offer. If it&#39;s invalid, return the current</span>
<a name="l01322"></a>01322 <span class="comment">       configuration. */</span>
<a name="l01323"></a>01323     <span class="keywordflow">if</span> ((offer = ParseReply(bp, len)) == 0) {
<a name="l01324"></a>01324 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;TAKE: %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>( offer-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>));
<a name="l01326"></a>01326 <span class="preprocessor">#endif</span>
<a name="l01327"></a>01327 <span class="preprocessor"></span>        <span class="keywordflow">return</span> dyncfg;
<a name="l01328"></a>01328     }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     <span class="comment">/* Discard anything which is not an offer. */</span>
<a name="l01331"></a>01331     <span class="keywordflow">if</span> (offer-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> != <a class="code" href="group__xg_d_h_c_p_c.html#ga4649df4abbae20e28fe422d09decd450" title="Server to client in response to DHCP_DISCOVER.">DHCP_OFFER</a>) {
<a name="l01332"></a>01332         ReleaseDynCfg(offer);
<a name="l01333"></a>01333 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01334"></a>01334 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;NO-OFFER]&quot;</span>);
<a name="l01335"></a>01335 <span class="preprocessor">#endif</span>
<a name="l01336"></a>01336 <span class="preprocessor"></span>        <span class="keywordflow">return</span> dyncfg;
<a name="l01337"></a>01337     }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339     <span class="comment">/* First offer, take it. */</span>
<a name="l01340"></a>01340     <span class="keywordflow">if</span> (dyncfg == 0) {
<a name="l01341"></a>01341         dyncfg = offer;
<a name="l01342"></a>01342 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01343"></a>01343 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;FIRST: %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(offer-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>));
<a name="l01344"></a>01344 <span class="preprocessor">#endif</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span>    }
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     <span class="comment">/*</span>
<a name="l01348"></a>01348 <span class="comment">     * Check if the new offer is better than the current configuration:</span>
<a name="l01349"></a>01349 <span class="comment">     */</span>
<a name="l01350"></a>01350     <span class="keywordflow">else</span> {
<a name="l01351"></a>01351         <span class="comment">/* If we remember a previously allocated IP which isn&#39;t in the</span>
<a name="l01352"></a>01352 <span class="comment">           current configuration but in the new offer, then let&#39;s take</span>
<a name="l01353"></a>01353 <span class="comment">           the new one. */</span>
<a name="l01354"></a>01354 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01355"></a>01355 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;PREV &quot;</span>);
<a name="l01356"></a>01356 <span class="preprocessor">#endif</span>
<a name="l01357"></a>01357 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a> &amp; <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>) {
<a name="l01358"></a>01358             <span class="keywordflow">if</span> (dyncfg-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a> != <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a> &amp;&amp;    <span class="comment">/* */</span>
<a name="l01359"></a>01359                 offer-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a> == <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a>) {
<a name="l01360"></a>01360                 ReleaseDynCfg(dyncfg);
<a name="l01361"></a>01361                 dyncfg = offer;
<a name="l01362"></a>01362 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01363"></a>01363 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;OLD: %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>( dyncfg-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>));
<a name="l01364"></a>01364 <span class="preprocessor">#endif</span>
<a name="l01365"></a>01365 <span class="preprocessor"></span>            }
<a name="l01366"></a>01366         }
<a name="l01367"></a>01367         <span class="comment">/* In the second place prefer long lease times. */</span>
<a name="l01368"></a>01368         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (offer-&gt;<a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba" title="Offered lease time in seconds.">dyn_leaseTime</a> &gt; dyncfg-&gt;<a class="code" href="structdyn__cfg.html#a8af6d63df914c26d7a4c25854aed83ba" title="Offered lease time in seconds.">dyn_leaseTime</a>) {
<a name="l01369"></a>01369             ReleaseDynCfg(dyncfg);
<a name="l01370"></a>01370             dyncfg = offer;
<a name="l01371"></a>01371 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01372"></a>01372 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;LONG: %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>( dyncfg-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>));
<a name="l01373"></a>01373 <span class="preprocessor">#endif</span>
<a name="l01374"></a>01374 <span class="preprocessor"></span>        }
<a name="l01375"></a>01375         <span class="comment">/* The new one deosn&#39;t offer anything interesting. Discard it. */</span>
<a name="l01376"></a>01376         <span class="keywordflow">else</span> {
<a name="l01377"></a>01377             ReleaseDynCfg(offer);
<a name="l01378"></a>01378 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;DSIC]&quot;</span>);
<a name="l01380"></a>01380 <span class="preprocessor">#endif</span>
<a name="l01381"></a>01381 <span class="preprocessor"></span>        }
<a name="l01382"></a>01382     }
<a name="l01383"></a>01383     <span class="keywordflow">return</span> dyncfg;
<a name="l01384"></a>01384 }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01387"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga5d0a5ef0d01a3999f5e2c49cc320b13a">01387</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga5d0a5ef0d01a3999f5e2c49cc320b13a">DhcpStateDebug</a>( <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> n, <a class="code" href="stdint_8h.html#ad0fca8b15c218d2c687f8c373a71d228">uint_fast8_t</a> s, <span class="keywordtype">int</span> li, <span class="keywordtype">int</span> lt, <a class="code" href="nut__types_8h.html#ae15262a08334eeeacd9a24f219a89d46" title="Unsigned register type.">ureg_t</a> retries)
<a name="l01388"></a>01388 {
<a name="l01389"></a>01389     <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l01390"></a>01390         <span class="keywordflow">if</span>( n)
<a name="l01391"></a>01391             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;\n[%u.DHCP-&quot;</span>, retries + 1);
<a name="l01392"></a>01392         <span class="keywordflow">else</span>
<a name="l01393"></a>01393             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;\n-&gt;[%u.DHCP-&quot;</span>, retries + 1);
<a name="l01394"></a>01394 
<a name="l01395"></a>01395         <span class="keywordflow">switch</span> (dhcpState) {
<a name="l01396"></a>01396         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>:
<a name="l01397"></a>01397             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;INIT]&quot;</span>);
<a name="l01398"></a>01398             <span class="keywordflow">break</span>;
<a name="l01399"></a>01399         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>:
<a name="l01400"></a>01400             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;SELECTING]&quot;</span>);
<a name="l01401"></a>01401             <span class="keywordflow">break</span>;
<a name="l01402"></a>01402         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>:
<a name="l01403"></a>01403             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;REQUESTING]&quot;</span>);
<a name="l01404"></a>01404             <span class="keywordflow">break</span>;
<a name="l01405"></a>01405         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#gaf62a09c8a9ec624a01d4a250b429416e" title="DHCP state: Rebooting.">DHCPST_REBOOTING</a>:
<a name="l01406"></a>01406             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;REBOOTING %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(li));
<a name="l01407"></a>01407             <span class="keywordflow">break</span>;
<a name="l01408"></a>01408         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>:
<a name="l01409"></a>01409             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;BOUND %lu]&quot;</span>, <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - lt);
<a name="l01410"></a>01410             <span class="keywordflow">break</span>;
<a name="l01411"></a>01411         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>:
<a name="l01412"></a>01412             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;RENEWING %lu]&quot;</span>, <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - lt);
<a name="l01413"></a>01413             <span class="keywordflow">break</span>;
<a name="l01414"></a>01414         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>:
<a name="l01415"></a>01415             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;REBINDING %lu]&quot;</span>, <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - lt);
<a name="l01416"></a>01416             <span class="keywordflow">break</span>;
<a name="l01417"></a>01417         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga4abafabe4257cdd6afd733dd9a12bee7" title="DHCP state: Informing.">DHCPST_INFORMING</a>:
<a name="l01418"></a>01418             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;INFORMING]&quot;</span>);
<a name="l01419"></a>01419             <span class="keywordflow">break</span>;
<a name="l01420"></a>01420         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga512ac4affb0ba009424b5a46b5216c08" title="DHCP state: Releasing.">DHCPST_RELEASING</a>:
<a name="l01421"></a>01421             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;RELEASING]&quot;</span>);
<a name="l01422"></a>01422             <span class="keywordflow">break</span>;
<a name="l01423"></a>01423         <span class="keywordflow">case</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>:
<a name="l01424"></a>01424             <span class="keywordflow">if</span> (dhcpError) {
<a name="l01425"></a>01425                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;ERROR %u]&quot;</span>, dhcpError);
<a name="l01426"></a>01426             } <span class="keywordflow">else</span> {
<a name="l01427"></a>01427                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;IDLE]&quot;</span>);
<a name="l01428"></a>01428             }
<a name="l01429"></a>01429             <span class="keywordflow">break</span>;
<a name="l01430"></a>01430         <span class="keywordflow">default</span>:
<a name="l01431"></a>01431             <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;UNKNOWN %u]&quot;</span>, dhcpState);
<a name="l01432"></a>01432             <span class="keywordflow">break</span>;
<a name="l01433"></a>01433         }
<a name="l01434"></a>01434     }
<a name="l01435"></a>01435 }
<a name="l01436"></a>01436 <span class="preprocessor">#endif</span>
<a name="l01437"></a>01437 <span class="preprocessor"></span>
<a name="l01451"></a><a class="code" href="group__xg_d_h_c_p_c.html#gaec068ced6e47d6a29ba229b256b16628">01451</a> <a class="code" href="thread_8h.html#a9e196c330bbf6578b06f412df8d19f4c" title="Macro for thread entry definitions.">THREAD</a>(<a class="code" href="group__xg_d_h_c_p_c.html#gaec068ced6e47d6a29ba229b256b16628" title="DHCP client thread.">NutDhcpClient</a>, arg)
<a name="l01452"></a>01452 {
<a name="l01453"></a>01453     <a class="code" href="structdyn__cfg.html" title="Dynamic configuration structure.">DYNCFG</a> *reply = 0;
<a name="l01454"></a>01454     <a class="code" href="structudp__socket.html" title="UDP socket information structure.">UDPSOCKET</a> *sock = 0;
<a name="l01455"></a>01455     <a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a> *bp = 0;
<a name="l01456"></a>01456     <span class="keywordtype">int</span> n;
<a name="l01457"></a>01457     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> xid;
<a name="l01458"></a>01458     <a class="code" href="structifnet.html" title="Network interface structure.">IFNET</a> *nif;
<a name="l01459"></a>01459     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> secs = 0;
<a name="l01460"></a>01460     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> aqsTime = <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>();
<a name="l01461"></a>01461     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> leaseTime = 0;
<a name="l01462"></a>01462     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> napTime;
<a name="l01463"></a>01463     <a class="code" href="nut__types_8h.html#ae15262a08334eeeacd9a24f219a89d46" title="Unsigned register type.">ureg_t</a> retries;
<a name="l01464"></a>01464     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tmo = <a class="code" href="group__xg_d_h_c_p_c.html#ga4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>;
<a name="l01465"></a>01465     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> last_ip = <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a>;
<a name="l01466"></a>01466     <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> server_ip;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468     <span class="comment">/*</span>
<a name="l01469"></a>01469 <span class="comment">     * Hack alert: Our ARM port doesn&#39;t allow parameter</span>
<a name="l01470"></a>01470 <span class="comment">     * passing to threads.</span>
<a name="l01471"></a>01471 <span class="comment">     */</span>
<a name="l01472"></a>01472 <span class="preprocessor">#ifdef __arm__</span>
<a name="l01473"></a>01473 <span class="preprocessor"></span>    nif = dhcpDev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a5bbb3ca6e1ee25bd67d6453f41a9dd20" title="Interface control block.">dev_icb</a>;
<a name="l01474"></a>01474 <span class="preprocessor">#else</span>
<a name="l01475"></a>01475 <span class="preprocessor"></span>    nif = ((<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *) arg)-&gt;dev_icb;
<a name="l01476"></a>01476 <span class="preprocessor">#endif</span>
<a name="l01477"></a>01477 <span class="preprocessor"></span>
<a name="l01478"></a>01478     <span class="comment">/*</span>
<a name="l01479"></a>01479 <span class="comment">     * Generate a random transaction identifier based on our MAC</span>
<a name="l01480"></a>01480 <span class="comment">     * address with the least significant byte of the MAC address</span>
<a name="l01481"></a>01481 <span class="comment">     * becoming the most significant byte of the identifier. This</span>
<a name="l01482"></a>01482 <span class="comment">     * should give a sufficient unique value when several Ethernuts</span>
<a name="l01483"></a>01483 <span class="comment">     * are started concurrently.</span>
<a name="l01484"></a>01484 <span class="comment">     */</span>
<a name="l01485"></a>01485     xid = 0;
<a name="l01486"></a>01486     <span class="keywordflow">for</span> (retries = 0; retries &lt; <span class="keyword">sizeof</span>(xid); retries++) {
<a name="l01487"></a>01487         xid &lt;&lt;= 8;
<a name="l01488"></a>01488         xid += nif-&gt;<a class="code" href="structifnet.html#a4dcc5bf67449bc30c11eb46af2d0cee2" title="Hardware net address.">if_mac</a>[5 - retries];
<a name="l01489"></a>01489     }
<a name="l01490"></a>01490     retries = 0;
<a name="l01491"></a>01491 
<a name="l01492"></a>01492     <span class="keywordflow">for</span> (;;) {
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01495"></a>01495 <span class="preprocessor"></span>        <a class="code" href="group__xg_d_h_c_p_c.html#ga5d0a5ef0d01a3999f5e2c49cc320b13a">DhcpStateDebug</a>( 0, dhcpState, last_ip, leaseTime, retries);
<a name="l01496"></a>01496 <span class="preprocessor">#endif</span>
<a name="l01497"></a>01497 <span class="preprocessor"></span>
<a name="l01498"></a>01498         <span class="comment">/*</span>
<a name="l01499"></a>01499 <span class="comment">         * Setup some values based on the number of retry attempts.</span>
<a name="l01500"></a>01500 <span class="comment">         */</span>
<a name="l01501"></a>01501         server_ip = <a class="code" href="in_8h.html#a4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>;   <span class="comment">/* Broadcasting is default. */</span>
<a name="l01502"></a>01502         <span class="keywordflow">if</span> (retries) {
<a name="l01503"></a>01503             <span class="comment">/* Double our timeout on each retry. */</span>
<a name="l01504"></a>01504             tmo += tmo;
<a name="l01505"></a>01505             <span class="keywordflow">if</span> (tmo &gt; <a class="code" href="group__xg_d_h_c_p_c.html#gacd76719c532ca403fc624016fd56ade3" title="Maximum number of milliseconds to wait for a response.">MAX_DHCP_WAIT</a>) {
<a name="l01506"></a>01506                 tmo = <a class="code" href="group__xg_d_h_c_p_c.html#gacd76719c532ca403fc624016fd56ade3" title="Maximum number of milliseconds to wait for a response.">MAX_DHCP_WAIT</a>;
<a name="l01507"></a>01507             }
<a name="l01508"></a>01508         } <span class="keywordflow">else</span> {
<a name="l01509"></a>01509             <span class="comment">/* Start with minimum timeout first. */</span>
<a name="l01510"></a>01510             tmo = <a class="code" href="group__xg_d_h_c_p_c.html#ga4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>;
<a name="l01511"></a>01511             <span class="comment">/* Use a new xid for the first message in each state except</span>
<a name="l01512"></a>01512 <span class="comment">             * when requesting, where we should continue using the xid</span>
<a name="l01513"></a>01513 <span class="comment">             * from the offer message we received.</span>
<a name="l01514"></a>01514 <span class="comment">             */</span>
<a name="l01515"></a>01515             <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#ga838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>) {
<a name="l01516"></a>01516                 xid++;
<a name="l01517"></a>01517             }
<a name="l01518"></a>01518 
<a name="l01519"></a>01519             <span class="comment">/* If we know the server&#39;s IP, try to unicast on the first</span>
<a name="l01520"></a>01520 <span class="comment">               attempt. */</span>
<a name="l01521"></a>01521             <span class="keywordflow">if</span> (dhcpConfig &amp;&amp; dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a>) {
<a name="l01522"></a>01522                 server_ip = dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a>;
<a name="l01523"></a>01523             }
<a name="l01524"></a>01524         }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526         <span class="comment">/*</span>
<a name="l01527"></a>01527 <span class="comment">         * Keep track of the API timeout.</span>
<a name="l01528"></a>01528 <span class="comment">         */</span>
<a name="l01529"></a>01529         <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a> &amp;&amp; dhcpApiTimeout != <a class="code" href="group__xg_event.html#gaee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>) {
<a name="l01530"></a>01530             <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> tt = <a class="code" href="group__xg_timer.html#gac1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>() - dhcpApiStart;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532             <span class="keywordflow">if</span> (dhcpApiTimeout &lt;= tt) {
<a name="l01533"></a>01533                 dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gab48de5519f2f998b14e321e092e71008" title="DHCP timeout error.">DHCPERR_TIMEOUT</a>;
<a name="l01534"></a>01534                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01535"></a>01535                 <span class="keywordflow">continue</span>;
<a name="l01536"></a>01536             }
<a name="l01537"></a>01537             <span class="keywordflow">if</span> ((tt = dhcpApiTimeout - tt) &lt; tmo) {
<a name="l01538"></a>01538                 tmo = tt;
<a name="l01539"></a>01539             }
<a name="l01540"></a>01540         }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542         <span class="comment">/*</span>
<a name="l01543"></a>01543 <span class="comment">         * Keep track of acquisition time.</span>
<a name="l01544"></a>01544 <span class="comment">         */</span>
<a name="l01545"></a>01545         <span class="keywordflow">if</span> ((dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>) || (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>) || (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>)) {
<a name="l01546"></a>01546             <span class="comment">/* For retries make sure that secs doesn&#39;t overflow. */</span>
<a name="l01547"></a>01547             <span class="keywordflow">if</span> (retries) {
<a name="l01548"></a>01548                 <span class="keywordflow">if</span> (<a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - aqsTime &gt; 0xffffUL) {
<a name="l01549"></a>01549                     secs = 0xffff;
<a name="l01550"></a>01550                 } <span class="keywordflow">else</span> {
<a name="l01551"></a>01551                     secs = (<a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a>) (<a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - aqsTime);
<a name="l01552"></a>01552                 }
<a name="l01553"></a>01553             }
<a name="l01554"></a>01554             <span class="comment">/* For first transmissions make sure that secs is zero. */</span>
<a name="l01555"></a>01555             <span class="keywordflow">else</span> {
<a name="l01556"></a>01556                 aqsTime = <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>();
<a name="l01557"></a>01557                 secs = 0;
<a name="l01558"></a>01558             }
<a name="l01559"></a>01559         }
<a name="l01560"></a>01560 
<a name="l01561"></a>01561         <span class="comment">/*</span>
<a name="l01562"></a>01562 <span class="comment">         * Release UDP socket and buffer in states with long inactive time.</span>
<a name="l01563"></a>01563 <span class="comment">         */</span>
<a name="l01564"></a>01564         <span class="keywordflow">if</span> ((dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) || (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>)) {
<a name="l01565"></a>01565             <span class="keywordflow">if</span> (sock) {
<a name="l01566"></a>01566                 <a class="code" href="group__xg_udp_socket.html#ga73efaff2acbe9b93f6a27a643471ef63" title="Close UDP socket.">NutUdpDestroySocket</a>(sock);
<a name="l01567"></a>01567                 sock = 0;
<a name="l01568"></a>01568             }
<a name="l01569"></a>01569             <span class="keywordflow">if</span> (bp) {
<a name="l01570"></a>01570                 <a class="code" href="group__xg_heap.html#ga9f850d0608418aea291e4c0fdab93826" title="Return a block to heap memory.">free</a>(bp);
<a name="l01571"></a>01571                 bp = 0;
<a name="l01572"></a>01572             }
<a name="l01573"></a>01573         }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575         <span class="comment">/*</span>
<a name="l01576"></a>01576 <span class="comment">         * In all other states we need the socket and the buffer.</span>
<a name="l01577"></a>01577 <span class="comment">         */</span>
<a name="l01578"></a>01578         <span class="keywordflow">else</span> {
<a name="l01579"></a>01579             <span class="comment">/*</span>
<a name="l01580"></a>01580 <span class="comment">             * Check if something else configured our interface.</span>
<a name="l01581"></a>01581 <span class="comment">             */</span>
<a name="l01582"></a>01582             <span class="keywordflow">if</span> (dhcpConfig == 0 &amp;&amp; nif-&gt;<a class="code" href="structifnet.html#acfb8fe99d274de277721386bf7789f55" title="IP address.">if_local_ip</a>) {
<a name="l01583"></a>01583                 <span class="comment">/* If we need additional configuration, we can sent</span>
<a name="l01584"></a>01584 <span class="comment">                   a DHCP Inform message here. */</span>
<a name="l01585"></a>01585                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01586"></a>01586                 <span class="keywordflow">continue</span>;
<a name="l01587"></a>01587             }
<a name="l01588"></a>01588 
<a name="l01589"></a>01589             <span class="keywordflow">if</span> ((sock == 0) || (bp == 0)) {
<a name="l01590"></a>01590                 <span class="keywordflow">if</span> (sock == 0) {
<a name="l01591"></a>01591                     sock = <a class="code" href="group__xg_udp_socket.html#gae3f0a4c71eecf9a01920852dd0f0592d" title="Create a UDP socket.">NutUdpCreateSocket</a>(<a class="code" href="group__xg_d_h_c_p_c.html#ga79a9a113fa47629510b6d5dd6fef9f83" title="UDP port of DHCP client.">DHCP_CLIENTPORT</a>);
<a name="l01592"></a>01592                 }
<a name="l01593"></a>01593                 <span class="keywordflow">if</span> (bp == 0) {
<a name="l01594"></a>01594                     bp = <a class="code" href="group__xg_heap.html#ga381d0a123dbf80ca3efe2614aa826e08" title="Allocate a block from heap memory.">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="structbootp.html" title="BOOTP message structure.">BOOTP</a>));
<a name="l01595"></a>01595                 }
<a name="l01596"></a>01596                 <span class="keywordflow">if</span> ((sock == 0) || (bp == 0)) {
<a name="l01597"></a>01597                     <span class="comment">/* Looks like we are out of memory. */</span>
<a name="l01598"></a>01598                     dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#ga8a82e5f1081e5d941e848d4a0a6debd5" title="DHCP system error.">DHCPERR_SYSTEM</a>;
<a name="l01599"></a>01599                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01600"></a>01600                     <span class="comment">/* At this point either socket or buffer may be allocated.</span>
<a name="l01601"></a>01601 <span class="comment">                       Thus we need to jump back to the top of our state loop</span>
<a name="l01602"></a>01602 <span class="comment">                       to release it. */</span>
<a name="l01603"></a>01603                     <span class="keywordflow">continue</span>;
<a name="l01604"></a>01604                 }
<a name="l01605"></a>01605 <span class="preprocessor">#if MAX_DHCP_BUFSIZE</span>
<a name="l01606"></a>01606 <span class="preprocessor"></span>                {
<a name="l01607"></a>01607                     <a class="code" href="stdint_8h.html#a1f1825b69244eb3ad2c7165ddc99c956">uint16_t</a> max_ms = <a class="code" href="group__xg_d_h_c_p_c.html#ga800db42c93d35caa64eb2b0d6f492731" title="Maximum UDP buffer size used by the DHCP client.">MAX_DHCP_BUFSIZE</a>;
<a name="l01608"></a>01608                     <a class="code" href="group__xg_udp_socket.html#ga2051b9300c656a4e01b964d054f0a9ec" title="Set value of a UDP socket option.">NutUdpSetSockOpt</a>(sock, <a class="code" href="socket_8h.html#a0db12e960ac303030400d9fd95391b52" title="Receive buffer size.">SO_RCVBUF</a>, &amp;max_ms, <span class="keyword">sizeof</span>(max_ms));
<a name="l01609"></a>01609                 }
<a name="l01610"></a>01610 <span class="preprocessor">#endif</span>
<a name="l01611"></a>01611 <span class="preprocessor"></span>            }
<a name="l01612"></a>01612         }
<a name="l01613"></a>01613 
<a name="l01614"></a>01614         <span class="comment">/*</span>
<a name="l01615"></a>01615 <span class="comment">         * (Re)Start.</span>
<a name="l01616"></a>01616 <span class="comment">         */</span>
<a name="l01617"></a>01617         <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>) {
<a name="l01618"></a>01618             <span class="comment">/* Clear the retry counter. */</span>
<a name="l01619"></a>01619             retries = 0;
<a name="l01620"></a>01620             <span class="comment">/* Use a new XID on each attempt. */</span>
<a name="l01621"></a>01621             xid++;
<a name="l01622"></a>01622             <span class="comment">/* Determine whether this is an initial boot or a reboot. */</span>
<a name="l01623"></a>01623             <span class="keywordflow">if</span> ((last_ip &amp; <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>) == 0) {
<a name="l01624"></a>01624                 <span class="comment">/* No previous IP, start from ground up. */</span>
<a name="l01625"></a>01625                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>;
<a name="l01626"></a>01626             } <span class="keywordflow">else</span> {
<a name="l01627"></a>01627                 <span class="comment">/* We got a previously allocated IP configuration from</span>
<a name="l01628"></a>01628 <span class="comment">                 * non-volatile configuration memory. Try to re-use it. */</span>
<a name="l01629"></a>01629                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gaf62a09c8a9ec624a01d4a250b429416e" title="DHCP state: Rebooting.">DHCPST_REBOOTING</a>;
<a name="l01630"></a>01630             }
<a name="l01631"></a>01631         }
<a name="l01632"></a>01632 
<a name="l01633"></a>01633 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01634"></a>01634 <span class="preprocessor"></span><span class="comment">//        DhcpStateDebug( 1, dhcpState, last_ip, leaseTime, retries);</span>
<a name="l01635"></a>01635 <span class="preprocessor">#endif</span>
<a name="l01636"></a>01636 <span class="preprocessor"></span>        <span class="comment">/*</span>
<a name="l01637"></a>01637 <span class="comment">         * Broadcast discover and collect incoming offers.</span>
<a name="l01638"></a>01638 <span class="comment">         */</span>
<a name="l01639"></a>01639         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga53023b54b471169dc7fd5c5a43434f66" title="DHCP state: Selecting.">DHCPST_SELECTING</a>) {
<a name="l01640"></a>01640 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01641"></a>01641 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[SEL: TICK %p]&quot;</span>, dhcpConfig);
<a name="l01642"></a>01642 <span class="preprocessor">#endif</span>
<a name="l01643"></a>01643 <span class="preprocessor"></span>
<a name="l01644"></a>01644             <span class="keywordflow">if</span> (retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#ga0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01645"></a>01645                 <span class="keywordflow">if</span>( dhcpConfig) {
<a name="l01646"></a>01646                     <span class="comment">/* Ulrich says: we got at least one valid offer from a DHCP server */</span>
<a name="l01647"></a>01647                     reply = 0;
<a name="l01648"></a>01648                     leaseTime = aqsTime;
<a name="l01649"></a>01649                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01650"></a>01650                 }
<a name="l01651"></a>01651                 <span class="keywordflow">else</span> {
<a name="l01652"></a>01652                     <span class="comment">/* Too many retries while discovering DHCP. Give up. */</span>
<a name="l01653"></a>01653                     dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gab48de5519f2f998b14e321e092e71008" title="DHCP timeout error.">DHCPERR_TIMEOUT</a>;
<a name="l01654"></a>01654                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01655"></a>01655                 }
<a name="l01656"></a>01656             }
<a name="l01657"></a>01657             <span class="comment">/* Send the discovering broadcast. */</span>
<a name="l01658"></a>01658             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastDiscover(sock, bp, xid, last_ip, secs) &lt; 0) {
<a name="l01659"></a>01659                 <span class="comment">/* Fatal transmit error on broadcast. */</span>
<a name="l01660"></a>01660 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01661"></a>01661 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[SEL-TXERR]&quot;</span>);
<a name="l01662"></a>01662 <span class="preprocessor">#endif</span>
<a name="l01663"></a>01663 <span class="preprocessor"></span>                dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01664"></a>01664             } <span class="keywordflow">else</span> {
<a name="l01665"></a>01665                 <span class="comment">/* Collect incoming offers. */</span>
<a name="l01666"></a>01666                 <span class="keywordflow">while</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &gt; 0) {
<a name="l01667"></a>01667                     <span class="comment">/* Check if this is a valid offer. */</span>
<a name="l01668"></a>01668                     <span class="keywordflow">if</span> ((dhcpConfig = CheckOffer(dhcpConfig, bp, n)) != 0) {
<a name="l01669"></a>01669 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01670"></a>01670 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[SEL-OFFER n=%d]&quot;</span>, n);
<a name="l01671"></a>01671 <span class="preprocessor">#endif</span>
<a name="l01672"></a>01672 <span class="preprocessor"></span>                        <span class="comment">/* If the callers timeout is low, do not collect</span>
<a name="l01673"></a>01673 <span class="comment">                           more than one. Thanks to Jelle Kok. */</span>
<a name="l01674"></a>01674                         <span class="keywordflow">if</span> (dhcpApiTimeout &lt; <a class="code" href="group__xg_d_h_c_p_c.html#ga4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a> * 3) {
<a name="l01675"></a>01675 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01676"></a>01676 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[NOTL]&quot;</span>);
<a name="l01677"></a>01677 <span class="preprocessor">#endif</span>
<a name="l01678"></a>01678 <span class="preprocessor"></span>                            <span class="keywordflow">break</span>;
<a name="l01679"></a>01679                         }
<a name="l01680"></a>01680                         <span class="comment">/* Switch to lowest timeout after we received</span>
<a name="l01681"></a>01681 <span class="comment">                           a first response. */</span>
<a name="l01682"></a>01682                         tmo = <a class="code" href="group__xg_d_h_c_p_c.html#ga4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>;
<a name="l01683"></a>01683                     }
<a name="l01684"></a>01684                 }
<a name="l01685"></a>01685                 <span class="comment">/* Change to ERROR state on fatal receive errors. */</span>
<a name="l01686"></a>01686                 <span class="keywordflow">if</span> (n &lt; 0) {
<a name="l01687"></a>01687 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01688"></a>01688 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[SEL-FATERR]&quot;</span>);
<a name="l01689"></a>01689 <span class="preprocessor">#endif</span>
<a name="l01690"></a>01690 <span class="preprocessor"></span>                    dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01691"></a>01691                 }
<a name="l01692"></a>01692                 <span class="comment">/* Change to REQUESTING state if we got a valid offer.</span>
<a name="l01693"></a>01693 <span class="comment">                   Otherwise we stay in SELECTING state. */</span>
<a name="l01694"></a>01694                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpConfig) {
<a name="l01695"></a>01695                     <span class="comment">/* Wait for at least one period for other DHCP servers to offer */</span>
<a name="l01696"></a>01696                     retries = <a class="code" href="group__xg_d_h_c_p_c.html#ga0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>+1;
<a name="l01697"></a>01697 <span class="comment">//                    dhcpState = DHCPST_REQUESTING;</span>
<a name="l01698"></a>01698 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01699"></a>01699 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[SEL-WAIT]&quot;</span>);
<a name="l01700"></a>01700 <span class="preprocessor">#endif</span>
<a name="l01701"></a>01701 <span class="preprocessor"></span>                }
<a name="l01702"></a>01702             }
<a name="l01703"></a>01703         }
<a name="l01704"></a>01704 
<a name="l01705"></a>01705         <span class="comment">/*</span>
<a name="l01706"></a>01706 <span class="comment">         * Send request and wait for an acknowledge.</span>
<a name="l01707"></a>01707 <span class="comment">         */</span>
<a name="l01708"></a>01708         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga838304df574dd7d5621ddcd2eb2204ce" title="DHCP state: Requesting.">DHCPST_REQUESTING</a>) {
<a name="l01709"></a>01709             <span class="keywordflow">if</span> (retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#ga0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01710"></a>01710                 <span class="comment">/* Too many retries with this server, fall back to discovery. */</span>
<a name="l01711"></a>01711                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01712"></a>01712             }
<a name="l01713"></a>01713             <span class="comment">/* Request an offered configuration. According to RFC 2131 this</span>
<a name="l01714"></a>01714 <span class="comment">               has to be broadcasted. */</span>
<a name="l01715"></a>01715             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastRequest(sock, bp, xid, 0, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a>, secs) &lt; 0) {
<a name="l01716"></a>01716                 <span class="comment">/* Fatal transmit error on broadcast. Give up. */</span>
<a name="l01717"></a>01717                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01718"></a>01718             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01719"></a>01719                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01720"></a>01720                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01721"></a>01721             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01722"></a>01722                 <span class="comment">/* The server accepted our request. We are bound. */</span>
<a name="l01723"></a>01723                 <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01724"></a>01724                     ReleaseDynCfg(dhcpConfig);
<a name="l01725"></a>01725                     dhcpConfig = reply;
<a name="l01726"></a>01726                     reply = 0;
<a name="l01727"></a>01727                     leaseTime = aqsTime;
<a name="l01728"></a>01728                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01729"></a>01729                 }
<a name="l01730"></a>01730                 <span class="comment">/* The server declines a previously offered configuration.</span>
<a name="l01731"></a>01731 <span class="comment">                   Restart discovery. */</span>
<a name="l01732"></a>01732                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01733"></a>01733 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01734"></a>01734 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-NAK1]&quot;</span>);
<a name="l01735"></a>01735 <span class="preprocessor">#endif</span>
<a name="l01736"></a>01736 <span class="preprocessor"></span>                    dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01737"></a>01737                 }
<a name="l01738"></a>01738             }
<a name="l01739"></a>01739         }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741         <span class="comment">/*</span>
<a name="l01742"></a>01742 <span class="comment">         * Reusing a previously allocated network address after reboot.</span>
<a name="l01743"></a>01743 <span class="comment">         */</span>
<a name="l01744"></a>01744         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#gaf62a09c8a9ec624a01d4a250b429416e" title="DHCP state: Rebooting.">DHCPST_REBOOTING</a>) {
<a name="l01745"></a>01745             <span class="keywordflow">if</span> (++retries &gt; <a class="code" href="group__xg_d_h_c_p_c.html#ga0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01746"></a>01746                 <span class="comment">/* Too many retries, fall back to discovery. */</span>
<a name="l01747"></a>01747                 last_ip = 0;
<a name="l01748"></a>01748                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01749"></a>01749             }
<a name="l01750"></a>01750             <span class="comment">/* Broadcast a request for our previous configuration. */</span>
<a name="l01751"></a>01751             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastRequest(sock, bp, xid, 0, last_ip, 0, secs) &lt; 0) {
<a name="l01752"></a>01752                 <span class="comment">/* Fatal transmit error on broadcast. Give up. */</span>
<a name="l01753"></a>01753 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01754"></a>01754 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[BC-FATAL]&quot;</span>);
<a name="l01755"></a>01755 <span class="preprocessor">#endif</span>
<a name="l01756"></a>01756 <span class="preprocessor"></span>                dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01757"></a>01757             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01758"></a>01758                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01759"></a>01759 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01760"></a>01760 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[RCV-FATAL]&quot;</span>);
<a name="l01761"></a>01761 <span class="preprocessor">#endif</span>
<a name="l01762"></a>01762 <span class="preprocessor"></span>                dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01763"></a>01763             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01764"></a>01764                 <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01765"></a>01765                     ReleaseDynCfg(dhcpConfig);
<a name="l01766"></a>01766                     dhcpConfig = reply;
<a name="l01767"></a>01767                     reply = 0;
<a name="l01768"></a>01768                     leaseTime = aqsTime;
<a name="l01769"></a>01769                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01770"></a>01770 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01771"></a>01771 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[OK]&quot;</span>);
<a name="l01772"></a>01772 <span class="preprocessor">#endif</span>
<a name="l01773"></a>01773 <span class="preprocessor"></span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01774"></a>01774                     <span class="comment">/* Either our previous address had been allocated by</span>
<a name="l01775"></a>01775 <span class="comment">                       someone else or we changed the network. Remove the</span>
<a name="l01776"></a>01776 <span class="comment">                       previous address and restart. */</span>
<a name="l01777"></a>01777 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01778"></a>01778 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-NAK2]&quot;</span>);
<a name="l01779"></a>01779 <span class="preprocessor">#endif</span>
<a name="l01780"></a>01780 <span class="preprocessor"></span>                    last_ip = 0;
<a name="l01781"></a>01781                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01782"></a>01782                 }
<a name="l01783"></a>01783             }
<a name="l01784"></a>01784         }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786         <span class="comment">/*</span>
<a name="l01787"></a>01787 <span class="comment">         * Maintain lease time.</span>
<a name="l01788"></a>01788 <span class="comment">         */</span>
<a name="l01789"></a>01789         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) {
<a name="l01790"></a>01790             retries = 0;
<a name="l01791"></a>01791             <a class="code" href="group__xg_event.html#ga575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;dhcpDone);
<a name="l01792"></a>01792             <span class="keywordflow">if</span> (dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> &lt;= <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) {
<a name="l01793"></a>01793                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>;
<a name="l01794"></a>01794             } <span class="keywordflow">else</span> {
<a name="l01795"></a>01795                 <span class="comment">/* Calculate the remaining lease time and take a nap. */</span>
<a name="l01796"></a>01796                 napTime = dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a0cefbe25f7c4f73c07bc7f3b03625869" title="Renewal time in seconds.">dyn_renewalTime</a> - (<a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime);
<a name="l01797"></a>01797                 <span class="keywordflow">if</span> (napTime &gt; <a class="code" href="group__xg_d_h_c_p_c.html#ga954acae12281d9d625376976442a5713" title="Maximum sleep time in seconds.">MAX_DHCP_NAPTIME</a>) {
<a name="l01798"></a>01798                     napTime = <a class="code" href="group__xg_d_h_c_p_c.html#ga954acae12281d9d625376976442a5713" title="Maximum sleep time in seconds.">MAX_DHCP_NAPTIME</a>;
<a name="l01799"></a>01799                 }
<a name="l01800"></a>01800                 <a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dhcpWake, napTime * 1000UL);
<a name="l01801"></a>01801             }
<a name="l01802"></a>01802         }
<a name="l01803"></a>01803 
<a name="l01804"></a>01804         <span class="comment">/*</span>
<a name="l01805"></a>01805 <span class="comment">         * Waiting for an acknowledge of our renewal request.</span>
<a name="l01806"></a>01806 <span class="comment">         */</span>
<a name="l01807"></a>01807         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga7927c76748a360748ccb94119384a8d4" title="DHCP state: Renewing.">DHCPST_RENEWING</a>) {
<a name="l01808"></a>01808             retries++;
<a name="l01809"></a>01809             <span class="keywordflow">if</span> (tmo / 1000 &gt; dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> - (<a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime)) {
<a name="l01810"></a>01810                 tmo = dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> - (<a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) * 1000;
<a name="l01811"></a>01811             }
<a name="l01812"></a>01812             <span class="keywordflow">if</span> (dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> &lt;= <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) {
<a name="l01813"></a>01813                 retries = 0;
<a name="l01814"></a>01814                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01815"></a>01815             }
<a name="l01816"></a>01816             <span class="comment">/* Send a request to our leasing server. We must not include</span>
<a name="l01817"></a>01817 <span class="comment">               the server identifier. */</span>
<a name="l01818"></a>01818             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpSendRequest(sock, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a>, bp, xid, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, 0, secs) &lt;
<a name="l01819"></a>01819                      0) {
<a name="l01820"></a>01820                 <span class="comment">/* Unicast transmit error. */</span>
<a name="l01821"></a>01821                 retries = 0;
<a name="l01822"></a>01822                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01823"></a>01823             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01824"></a>01824                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01825"></a>01825                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01826"></a>01826             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01827"></a>01827                 <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01828"></a>01828                     <span class="comment">/* Got an acknowledge, return to bound state. */</span>
<a name="l01829"></a>01829                     ReleaseDynCfg(dhcpConfig);
<a name="l01830"></a>01830                     dhcpConfig = reply;
<a name="l01831"></a>01831                     reply = 0;
<a name="l01832"></a>01832                     leaseTime = aqsTime;
<a name="l01833"></a>01833                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01834"></a>01834                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01835"></a>01835                     <span class="comment">/* Unexpected NAK. */</span>
<a name="l01836"></a>01836 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01837"></a>01837 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-UXNAK]&quot;</span>);
<a name="l01838"></a>01838 <span class="preprocessor">#endif</span>
<a name="l01839"></a>01839 <span class="preprocessor"></span>                    retries = 0;
<a name="l01840"></a>01840                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01841"></a>01841                 }
<a name="l01842"></a>01842             }
<a name="l01843"></a>01843         }
<a name="l01844"></a>01844 
<a name="l01845"></a>01845         <span class="comment">/*</span>
<a name="l01846"></a>01846 <span class="comment">         * Waiting for an acknowledge of our rebind request.</span>
<a name="l01847"></a>01847 <span class="comment">         */</span>
<a name="l01848"></a>01848         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>) {
<a name="l01849"></a>01849             retries++;
<a name="l01850"></a>01850             <span class="keywordflow">if</span> (tmo &gt; dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> - (<a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime)) {
<a name="l01851"></a>01851                 tmo = dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> - <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime;
<a name="l01852"></a>01852             }
<a name="l01853"></a>01853             <span class="keywordflow">if</span> (dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2a8170aaf92217fad57106bc48b48bf0" title="Rebind time in seconds.">dyn_rebindTime</a> &lt;= <a class="code" href="group__xg_timer.html#ga8bc858a1ca645b9e0cf9d03d7c9adfb3" title="Return the seconds counter value.">NutGetSeconds</a>() - leaseTime) {
<a name="l01854"></a>01854                 retries = 0;
<a name="l01855"></a>01855                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga4b45d96383a5e0d09b9a3d2bebf548c8" title="DHCP state: Rebinding.">DHCPST_REBINDING</a>;
<a name="l01856"></a>01856             }
<a name="l01857"></a>01857             <span class="comment">/* Broadcast a request for our previous configuration. We</span>
<a name="l01858"></a>01858 <span class="comment">               must not include a server identifier. */</span>
<a name="l01859"></a>01859             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpBroadcastRequest(sock, bp, xid, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, 0, secs) &lt; 0) {
<a name="l01860"></a>01860                 <span class="comment">/* Fatal transmit error on broadcast. Give up. */</span>
<a name="l01861"></a>01861                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01862"></a>01862             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01863"></a>01863                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01864"></a>01864                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01865"></a>01865             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01866"></a>01866                 <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01867"></a>01867                     <span class="comment">/* Got an acknowledge, return to bound state. */</span>
<a name="l01868"></a>01868                     ReleaseDynCfg(dhcpConfig);
<a name="l01869"></a>01869                     dhcpConfig = reply;
<a name="l01870"></a>01870                     reply = 0;
<a name="l01871"></a>01871                     leaseTime = aqsTime;
<a name="l01872"></a>01872                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>;
<a name="l01873"></a>01873                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01874"></a>01874                     <span class="comment">/*</span>
<a name="l01875"></a>01875 <span class="comment">                     * We have a problem here if the last DHCP server died.</span>
<a name="l01876"></a>01876 <span class="comment">                     * If a backup server exists, it may probe our IP address</span>
<a name="l01877"></a>01877 <span class="comment">                     * using ARP or ICMP. Our interface is up and responding,</span>
<a name="l01878"></a>01878 <span class="comment">                     * so the backup server may think that the IP address</span>
<a name="l01879"></a>01879 <span class="comment">                     * is in use and respond with NAK. Without shutting</span>
<a name="l01880"></a>01880 <span class="comment">                     * down our interface (not yet implemented) we are stuck.</span>
<a name="l01881"></a>01881 <span class="comment">                     * We switch to discovery state, but the problem remains.</span>
<a name="l01882"></a>01882 <span class="comment">                     */</span>
<a name="l01883"></a>01883 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01884"></a>01884 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-NAK3]&quot;</span>);
<a name="l01885"></a>01885 <span class="preprocessor">#endif</span>
<a name="l01886"></a>01886 <span class="preprocessor"></span>                    dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>;
<a name="l01887"></a>01887                 }
<a name="l01888"></a>01888             }
<a name="l01889"></a>01889         }
<a name="l01890"></a>01890 
<a name="l01891"></a>01891         <span class="comment">/*</span>
<a name="l01892"></a>01892 <span class="comment">         * Send an inform and wait for its (optional) echo.</span>
<a name="l01893"></a>01893 <span class="comment">         */</span>
<a name="l01894"></a>01894         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga4abafabe4257cdd6afd733dd9a12bee7" title="DHCP state: Informing.">DHCPST_INFORMING</a>) {
<a name="l01895"></a>01895             <span class="keywordflow">if</span> (retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#ga0f2c916299b753d6201f90917d83793a" title="Maximum number of request retries.">MAX_DCHP_RETRIES</a>) {
<a name="l01896"></a>01896                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01897"></a>01897             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DhcpSendInform(sock, server_ip, bp, xid, nif-&gt;<a class="code" href="structifnet.html#acfb8fe99d274de277721386bf7789f55" title="IP address.">if_local_ip</a>) &lt; 0) {
<a name="l01898"></a>01898                 <span class="keywordflow">if</span> (server_ip == <a class="code" href="in_8h.html#a4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>) {
<a name="l01899"></a>01899                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01900"></a>01900                 }
<a name="l01901"></a>01901             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) != 0) {
<a name="l01902"></a>01902                 <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp;    <span class="comment">/* No receive error. */</span>
<a name="l01903"></a>01903                     (reply = ParseReply(bp, n)) != 0 &amp;&amp; <span class="comment">/* No parser error. */</span>
<a name="l01904"></a>01904                     reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {    <span class="comment">/* Acknowledged. */</span>
<a name="l01905"></a>01905                     <span class="comment">/* Take over this configuration. */</span>
<a name="l01906"></a>01906                     ReleaseDynCfg(dhcpConfig);
<a name="l01907"></a>01907                     dhcpConfig = reply;
<a name="l01908"></a>01908                     reply = 0;
<a name="l01909"></a>01909                 }
<a name="l01910"></a>01910                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01911"></a>01911             }
<a name="l01912"></a>01912         }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914         <span class="comment">/*</span>
<a name="l01915"></a>01915 <span class="comment">         * Send a release and wait for its (optional) echo.</span>
<a name="l01916"></a>01916 <span class="comment">         */</span>
<a name="l01917"></a>01917         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga512ac4affb0ba009424b5a46b5216c08" title="DHCP state: Releasing.">DHCPST_RELEASING</a>) {
<a name="l01918"></a>01918             <span class="keywordflow">if</span> (dhcpConfig == 0 ||      <span class="comment">/* Not configured. */</span>
<a name="l01919"></a>01919                 retries++ &gt; <a class="code" href="group__xg_d_h_c_p_c.html#gab9e5603e983fc563188a47a2397537d8" title="Maximum number of release retries.">MAX_DCHP_RELEASE_RETRIES</a> || <span class="comment">/* Too many retries. */</span>
<a name="l01920"></a>01920                 DhcpSendRelease(sock, server_ip, bp, xid, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a8d155d426be7e05fac9d8a64f33851bf" title="Server identifier.">dyn_sid</a>) &lt; 0) {
<a name="l01921"></a>01921                 <span class="keywordflow">if</span> (server_ip == <a class="code" href="in_8h.html#a4a725f61ded23ce8a7dff8e82ed51986" title="Broadcast IP address.">INADDR_BROADCAST</a>) {
<a name="l01922"></a>01922                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01923"></a>01923                 }
<a name="l01924"></a>01924             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n = DhcpRecvMessage(sock, xid, bp, tmo)) &lt; 0) {
<a name="l01925"></a>01925                 <span class="comment">/* Fatal receive error. */</span>
<a name="l01926"></a>01926                 dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01927"></a>01927             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &gt; 0 &amp;&amp; (reply = ParseReply(bp, n)) != 0) {
<a name="l01928"></a>01928                 <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga3cca70105d2c42c3381829f456446e0e" title="Server to client with configuration parameters.">DHCP_ACK</a>) {
<a name="l01929"></a>01929                     dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01930"></a>01930                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reply-&gt;<a class="code" href="structdyn__cfg.html#a314ad2f65eeface977eba1145084e215" title="DHCP message type.">dyn_msgtyp</a> == <a class="code" href="group__xg_d_h_c_p_c.html#ga12682fd5edb10129309f2046504d4221" title="Server to client indicating client&#39;s notion of network address is incorrect.">DHCP_NAK</a>) {
<a name="l01931"></a>01931 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l01932"></a>01932 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-FNAK]&quot;</span>);
<a name="l01933"></a>01933 <span class="preprocessor">#endif</span>
<a name="l01934"></a>01934 <span class="preprocessor"></span>                    dhcpState = <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>;
<a name="l01935"></a>01935                 }
<a name="l01936"></a>01936             }
<a name="l01937"></a>01937         }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939         <span class="comment">/*</span>
<a name="l01940"></a>01940 <span class="comment">         * We are done somehow. Either a fatal error occured or we</span>
<a name="l01941"></a>01941 <span class="comment">         * reached the specified timeout time or our lease has been</span>
<a name="l01942"></a>01942 <span class="comment">         * release or something else configured our interface.</span>
<a name="l01943"></a>01943 <span class="comment">         * Release all resources and wait for a new API call to</span>
<a name="l01944"></a>01944 <span class="comment">         * wake us up.</span>
<a name="l01945"></a>01945 <span class="comment">         */</span>
<a name="l01946"></a>01946         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>) {
<a name="l01947"></a>01947             ReleaseDynCfg(dhcpConfig);
<a name="l01948"></a>01948             dhcpConfig = 0;
<a name="l01949"></a>01949             retries = 0;
<a name="l01950"></a>01950             <a class="code" href="group__xg_event.html#ga575628f89864beb575a161f10f3de62c" title="Broadcast an event to a specified queue.">NutEventBroadcast</a>(&amp;dhcpDone);
<a name="l01951"></a>01951             <a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dhcpWake, <a class="code" href="group__xg_event.html#gaee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l01952"></a>01952         }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954         <span class="comment">/* Release any received reply. */</span>
<a name="l01955"></a>01955         <span class="keywordflow">if</span> (reply) {
<a name="l01956"></a>01956             ReleaseDynCfg(reply);
<a name="l01957"></a>01957             reply = 0;
<a name="l01958"></a>01958         }
<a name="l01959"></a>01959     }
<a name="l01960"></a>01960 }
<a name="l01961"></a>01961 
<a name="l01976"></a>01976 <span class="keyword">static</span> <span class="keywordtype">int</span> DhcpKick(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> state, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l01977"></a>01977 {
<a name="l01978"></a>01978     <a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev;
<a name="l01979"></a>01979     <a class="code" href="structifnet.html" title="Network interface structure.">IFNET</a> *nif;
<a name="l01980"></a>01980 
<a name="l01981"></a>01981     <span class="comment">/* Lookup the Ethernet device. */</span>
<a name="l01982"></a>01982     <span class="keywordflow">if</span> ((dev = <a class="code" href="group__xg_device.html#ga913130771bea4118ae58e2a0ccb50a4d" title="Find device entry by name.">NutDeviceLookup</a>(name)) == 0 ||   <span class="comment">/* No device */</span>
<a name="l01983"></a>01983         dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a3c8936fc8444a7920c8f79dceaf991c2" title="Type of interface.">dev_type</a> != <a class="code" href="group__xg_device.html#gaa3f88c08759f21a3a876721fd184d0ba" title="Net device.">IFTYP_NET</a> ||   <span class="comment">/* Wrong type */</span>
<a name="l01984"></a>01984         (nif = dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a5bbb3ca6e1ee25bd67d6453f41a9dd20" title="Interface control block.">dev_icb</a>) == 0 ||    <span class="comment">/* No netif */</span>
<a name="l01985"></a>01985         nif-&gt;<a class="code" href="structifnet.html#a154c84905708bba2667b314572fa5f43" title="Interface type. Either IFT_ETHER or IFT_PPP.">if_type</a> != <a class="code" href="if__types_8h.html#ae4eb2208d7f67fefe11586dd32cb1bcc" title="Ethernet interface.">IFT_ETHER</a>) {    <span class="comment">/* Wrong if type */</span>
<a name="l01986"></a>01986         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#ga0b7d014e36cbac1c1dd67d7e40ec06cd" title="DHCP error: Bad device.">DHCPERR_BADDEV</a>;
<a name="l01987"></a>01987         <span class="keywordflow">return</span> -1;
<a name="l01988"></a>01988     }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990     <span class="comment">/* Initialize timeout checking. */</span>
<a name="l01991"></a>01991     dhcpApiStart = <a class="code" href="group__xg_timer.html#gac1887264221d66b13d1e86d034227f1c" title="Return the milliseconds counter value.">NutGetMillis</a>();
<a name="l01992"></a>01992     dhcpApiTimeout = timeout;
<a name="l01993"></a>01993 
<a name="l01994"></a>01994     dhcpState = state;
<a name="l01995"></a>01995     <span class="keywordflow">if</span> (dhcpThread == 0) {
<a name="l01996"></a>01996 <span class="preprocessor">#ifdef __arm__</span>
<a name="l01997"></a>01997 <span class="preprocessor"></span>        dhcpDev = dev;
<a name="l01998"></a>01998 <span class="preprocessor">#endif</span>
<a name="l01999"></a>01999 <span class="preprocessor"></span>        dhcpThread = <a class="code" href="group__xg_nut_arch_arm_os_context.html#ga8357f2631f0c0a9444844e5ea64be50d" title="Create a new thread.">NutThreadCreate</a>(<span class="stringliteral">&quot;dhcpc&quot;</span>, <a class="code" href="group__xg_d_h_c_p_c.html#gaec068ced6e47d6a29ba229b256b16628" title="DHCP client thread.">NutDhcpClient</a>, dev,
<a name="l02000"></a>02000             (<a class="code" href="group__xg_d_h_c_p_c.html#ga2f3a479eff1da93bc057498174f94f78" title="Stack size of the DHCP client thread.">NUT_THREAD_DHCPSTACK</a> * <a class="code" href="thread_8h.html#a829893ef9f0c6a5efc2559ed359c8592" title="Stack size factor.">NUT_THREAD_STACK_MULT</a>) + <a class="code" href="thread_8h.html#a61adeb6c97cb1f740e729fbf33e9a15c" title="Stack size summand.">NUT_THREAD_STACK_ADD</a>);
<a name="l02001"></a>02001     }
<a name="l02002"></a>02002     <a class="code" href="group__xg_event.html#gad519c6b1469621d2b3909fe58d1ac40b" title="Post an event to a specified queue.">NutEventPost</a>(&amp;dhcpWake);
<a name="l02003"></a>02003     <a class="code" href="group__xg_event.html#ga79af18e0842286182af7c5b647526ce5" title="Wait for an event in a specified queue.">NutEventWait</a>(&amp;dhcpDone, <a class="code" href="group__xg_event.html#gaee7b86caed1918238b71ffbff86e1eb7" title="Infinite waiting time definition.">NUT_WAIT_INFINITE</a>);
<a name="l02004"></a>02004 
<a name="l02005"></a>02005     <span class="keywordflow">return</span> 0;
<a name="l02006"></a>02006 }
<a name="l02007"></a>02007 
<a name="l02047"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga23fddfde13e6e0581258ac7f0fc1d025">02047</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga23fddfde13e6e0581258ac7f0fc1d025" title="Automatically configure an Ethernet network interface.">NutDhcpIfConfig</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> * mac, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> mac0[6];
<a name="l02050"></a>02050     <a class="code" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> macF[6];
<a name="l02051"></a>02051     <a class="code" href="struct___n_u_t_d_e_v_i_c_e.html" title="Device structure.">NUTDEVICE</a> *dev;
<a name="l02052"></a>02052     <a class="code" href="structifnet.html" title="Network interface structure.">IFNET</a> *nif;
<a name="l02053"></a>02053 
<a name="l02054"></a>02054     <span class="comment">/*</span>
<a name="l02055"></a>02055 <span class="comment">     * Lookup the Ethernet device.</span>
<a name="l02056"></a>02056 <span class="comment">     */</span>
<a name="l02057"></a>02057     <span class="keywordflow">if</span> ((dev = <a class="code" href="group__xg_device.html#ga913130771bea4118ae58e2a0ccb50a4d" title="Find device entry by name.">NutDeviceLookup</a>(name)) == 0 ||   <span class="comment">/* No device */</span>
<a name="l02058"></a>02058         dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a3c8936fc8444a7920c8f79dceaf991c2" title="Type of interface.">dev_type</a> != <a class="code" href="group__xg_device.html#gaa3f88c08759f21a3a876721fd184d0ba" title="Net device.">IFTYP_NET</a> ||   <span class="comment">/* Wrong type */</span>
<a name="l02059"></a>02059         (nif = dev-&gt;<a class="code" href="struct___n_u_t_d_e_v_i_c_e.html#a5bbb3ca6e1ee25bd67d6453f41a9dd20" title="Interface control block.">dev_icb</a>) == 0 ||    <span class="comment">/* No netif */</span>
<a name="l02060"></a>02060         nif-&gt;<a class="code" href="structifnet.html#a154c84905708bba2667b314572fa5f43" title="Interface type. Either IFT_ETHER or IFT_PPP.">if_type</a> != <a class="code" href="if__types_8h.html#ae4eb2208d7f67fefe11586dd32cb1bcc" title="Ethernet interface.">IFT_ETHER</a>) {    <span class="comment">/* Wrong if type */</span>
<a name="l02061"></a>02061         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#ga0b7d014e36cbac1c1dd67d7e40ec06cd" title="DHCP error: Bad device.">DHCPERR_BADDEV</a>;
<a name="l02062"></a>02062         <span class="keywordflow">return</span> -1;
<a name="l02063"></a>02063     }
<a name="l02064"></a>02064 
<a name="l02065"></a>02065     <span class="comment">/*</span>
<a name="l02066"></a>02066 <span class="comment">     * We determine whether the interface is enabled by checking</span>
<a name="l02067"></a>02067 <span class="comment">     * the MAC address. This is so bloody brain dead.</span>
<a name="l02068"></a>02068 <span class="comment">     */</span>
<a name="l02069"></a>02069     <a class="code" href="group__xg_crt_string.html#gaa4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(mac0, 0x00, <span class="keyword">sizeof</span>(mac0));   <span class="comment">/* Uses more code but less RAM... */</span>
<a name="l02070"></a>02070     <a class="code" href="group__xg_crt_string.html#gaa4075a014de11292d9105188ddbeb216" title="Fill memory region with a specific byte value.">memset</a>(macF, 0xFF, <span class="keyword">sizeof</span>(macF));   <span class="comment">/* ...than init in declaration.   */</span>
<a name="l02071"></a>02071     <span class="keywordflow">if</span> (<a class="code" href="group__xg_crt_string.html#ga135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(nif-&gt;<a class="code" href="structifnet.html#a4dcc5bf67449bc30c11eb46af2d0cee2" title="Hardware net address.">if_mac</a>, mac0, 6) == 0 || <a class="code" href="group__xg_crt_string.html#ga135578e5537357b84cf147e3b352902d" title="Compare memory regions.">memcmp</a>(nif-&gt;<a class="code" href="structifnet.html#a4dcc5bf67449bc30c11eb46af2d0cee2" title="Hardware net address.">if_mac</a>, macF, 6) == 0) {
<a name="l02072"></a>02072         <span class="comment">/*</span>
<a name="l02073"></a>02073 <span class="comment">         * If the caller specified a MAC address, we use it and</span>
<a name="l02074"></a>02074 <span class="comment">         * overwrite the configuration.</span>
<a name="l02075"></a>02075 <span class="comment">         */</span>
<a name="l02076"></a>02076         <span class="keywordflow">if</span> (mac) {
<a name="l02077"></a>02077             <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(<a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a60f7de301d8f6a941581d1f587e6c3f6" title="Ethernet MAC address.">cdn_mac</a>, mac, <span class="keyword">sizeof</span>(<a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a60f7de301d8f6a941581d1f587e6c3f6" title="Ethernet MAC address.">cdn_mac</a>));
<a name="l02078"></a>02078         }
<a name="l02079"></a>02079 
<a name="l02080"></a>02080         <span class="comment">/*</span>
<a name="l02081"></a>02081 <span class="comment">         * If no MAC address has been specified, read the configuration</span>
<a name="l02082"></a>02082 <span class="comment">         * from EEPROM. If this fails, we do not continue any further,</span>
<a name="l02083"></a>02083 <span class="comment">         * but let the caller know that something is wrong. He may call</span>
<a name="l02084"></a>02084 <span class="comment">         * us again with a valid MAC address.</span>
<a name="l02085"></a>02085 <span class="comment">         */</span>
<a name="l02086"></a>02086         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__xg_conf_net.html#ga1b658703cf61dd0152f312a59989bed0" title="Load network configuration from non-volatile memory.">NutNetLoadConfig</a>(name)) {
<a name="l02087"></a>02087             dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#ga9fb8f0830e5a38a65177fd3f91d7d0ae" title="DHCP MAC error.">DHCPERR_NOMAC</a>;
<a name="l02088"></a>02088             <span class="keywordflow">return</span> -1;
<a name="l02089"></a>02089         }
<a name="l02090"></a>02090 
<a name="l02091"></a>02091         <span class="comment">/*</span>
<a name="l02092"></a>02092 <span class="comment">         * Copy the MAC address to the interface structure. This will</span>
<a name="l02093"></a>02093 <span class="comment">         * magically brain dead enable the interface.</span>
<a name="l02094"></a>02094 <span class="comment">         */</span>
<a name="l02095"></a>02095         <a class="code" href="group__xg_crt_string.html#ga09a4c3953e2e41a212a73cf3df4c8c8e">memcpy</a>(nif-&gt;<a class="code" href="structifnet.html#a4dcc5bf67449bc30c11eb46af2d0cee2" title="Hardware net address.">if_mac</a>, <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a60f7de301d8f6a941581d1f587e6c3f6" title="Ethernet MAC address.">cdn_mac</a>, 6);
<a name="l02096"></a>02096         <a class="code" href="group__xg_timer.html#gafefcf81d05019a8134b49fa44d8c114a" title="Temporarily suspends the current thread.">NutSleep</a>(500);
<a name="l02097"></a>02097     }
<a name="l02098"></a>02098 
<a name="l02099"></a>02099     <span class="comment">/*</span>
<a name="l02100"></a>02100 <span class="comment">     * Zero out the ip address and mask. This allows to switch between</span>
<a name="l02101"></a>02101 <span class="comment">     * DHCP and static IP addresses without resetting/power cycling.</span>
<a name="l02102"></a>02102 <span class="comment">     * See patch #2903940.</span>
<a name="l02103"></a>02103 <span class="comment">     */</span>
<a name="l02104"></a>02104     nif-&gt;<a class="code" href="structifnet.html#acfb8fe99d274de277721386bf7789f55" title="IP address.">if_local_ip</a> = 0;
<a name="l02105"></a>02105     nif-&gt;<a class="code" href="structifnet.html#a105f355e7b8bd2a08b0518d68a061948" title="IP network mask.">if_mask</a> = <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>;
<a name="l02106"></a>02106 
<a name="l02107"></a>02107     <span class="comment">/*</span>
<a name="l02108"></a>02108 <span class="comment">     * If the EEPROM contains a fixed network configuration, we skip DHCP.</span>
<a name="l02109"></a>02109 <span class="comment">     */</span>
<a name="l02110"></a>02110     <span class="keywordflow">if</span> ((<a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#aa657a4e05527aa55d7578c08b7f17e6d" title="Configured IP address.">cdn_cip_addr</a> &amp; <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>) != 0) {
<a name="l02111"></a>02111         <span class="comment">/* Give up a previously allocated lease. See patch #2903940. */</span>
<a name="l02112"></a>02112         (void)<a class="code" href="group__xg_d_h_c_p_c.html#ga2efa947f8718bb11f6674cb3011aa520" title="Relinguish our DHCP lease.">NutDhcpRelease</a>(name, (3*<a class="code" href="group__xg_d_h_c_p_c.html#ga4ab1c132c4f2daaab22d85b3d4afe984" title="Minimum number of milliseconds to wait for a response.">MIN_DHCP_WAIT</a>));
<a name="l02113"></a>02113         <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a> = <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#aa657a4e05527aa55d7578c08b7f17e6d" title="Configured IP address.">cdn_cip_addr</a>;
<a name="l02114"></a>02114         <a class="code" href="group__xg_i_p.html#gaa7092b805dccd43209f32ad437dc2a3f" title="Configure a network interface including the default gateway.">NutNetIfConfig2</a>(name,
<a name="l02115"></a>02115                         <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a60f7de301d8f6a941581d1f587e6c3f6" title="Ethernet MAC address.">cdn_mac</a>,
<a name="l02116"></a>02116                         <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a>,
<a name="l02117"></a>02117                         <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>,
<a name="l02118"></a>02118                         <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2bef100194721f03e3519bff3d93c94e" title="Default route.">cdn_gateway</a>);
<a name="l02119"></a>02119         <span class="keywordflow">return</span> 0;
<a name="l02120"></a>02120     }
<a name="l02121"></a>02121 
<a name="l02122"></a>02122     <span class="comment">/*</span>
<a name="l02123"></a>02123 <span class="comment">     * Start the DHCP thread if not running or wake it up. Pass the caller&#39;s</span>
<a name="l02124"></a>02124 <span class="comment">     * timeout to the thread and wait an infinite time. We rely on the thread</span>
<a name="l02125"></a>02125 <span class="comment">     * to wake us up on timeout.</span>
<a name="l02126"></a>02126 <span class="comment">     */</span>
<a name="l02127"></a>02127     <span class="keywordflow">if</span> (DhcpKick(name, <a class="code" href="group__xg_d_h_c_p_c.html#gab3575e63ae39bfe127bce78b2f56943e" title="DHCP state: Starting.">DHCPST_INIT</a>, timeout) == 0) {
<a name="l02128"></a>02128         <span class="comment">/*</span>
<a name="l02129"></a>02129 <span class="comment">         * The thread finished its task. If it reached the bound state, then</span>
<a name="l02130"></a>02130 <span class="comment">         * we got a valid configuration from DHCP.</span>
<a name="l02131"></a>02131 <span class="comment">         */</span>
<a name="l02132"></a>02132         <span class="keywordflow">if</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) {
<a name="l02133"></a>02133 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l02134"></a>02134 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l02135"></a>02135                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Config %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>));
<a name="l02136"></a>02136             }
<a name="l02137"></a>02137 <span class="preprocessor">#endif</span>
<a name="l02138"></a>02138 <span class="preprocessor"></span>            <a class="code" href="group__xg_i_p.html#gabf73942328e57e1c1c72abe1f9e6e359" title="Network interface setup.">NutNetIfSetup</a>(dev, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ae3ad67ca16aaa7a3e33f129e2353c61c" title="Offered IP address.">dyn_yiaddr</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a2451feada0200db194e27e4b8ab23fcd" title="Local IP netmask.">dyn_netmask</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a01e42f8db0a5032d178ef42677c85980" title="Default gate IP address.">dyn_gateway</a>);
<a name="l02139"></a>02139             <a class="code" href="group__xg_d_n_s.html#gac3f37bb5099633796580e35bb3cd0913" title="Set DNS configuration.">NutDnsConfig2</a>(NULL, NULL, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#a13c0470be95b037b0c1100bc1a2d4446" title="Primary DNS IP address.">dyn_pdns</a>, dhcpConfig-&gt;<a class="code" href="structdyn__cfg.html#ab1ff09a8cc419679222755358b29014a" title="Secondary DNS IP address.">dyn_sdns</a>);
<a name="l02140"></a>02140             <span class="keywordflow">return</span> 0;
<a name="l02141"></a>02141         }
<a name="l02142"></a>02142 
<a name="l02143"></a>02143         <span class="comment">/*</span>
<a name="l02144"></a>02144 <span class="comment">         * Our interface has been configured externally, possibly by auto</span>
<a name="l02145"></a>02145 <span class="comment">         * ARP or a similar function implemented by the application.</span>
<a name="l02146"></a>02146 <span class="comment">         */</span>
<a name="l02147"></a>02147         <span class="keywordflow">if</span> (nif-&gt;<a class="code" href="structifnet.html#acfb8fe99d274de277721386bf7789f55" title="IP address.">if_local_ip</a>) {
<a name="l02148"></a>02148 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l02149"></a>02149 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l02150"></a>02150                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-External %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(nif-&gt;<a class="code" href="structifnet.html#acfb8fe99d274de277721386bf7789f55" title="IP address.">if_local_ip</a>));
<a name="l02151"></a>02151             }
<a name="l02152"></a>02152 <span class="preprocessor">#endif</span>
<a name="l02153"></a>02153 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l02154"></a>02154         }
<a name="l02155"></a>02155 
<a name="l02156"></a>02156         <span class="comment">/*</span>
<a name="l02157"></a>02157 <span class="comment">         * DHCP failed. In case we remember a previously allocated address,</span>
<a name="l02158"></a>02158 <span class="comment">         * then let&#39;s use it.</span>
<a name="l02159"></a>02159 <span class="comment">         */</span>
<a name="l02160"></a>02160         <span class="keywordflow">if</span> ((<a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a> &amp; <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>) != 0) {
<a name="l02161"></a>02161 <span class="preprocessor">#ifdef NUTDEBUG</span>
<a name="l02162"></a>02162 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="netdebug_8h.html#a7413c42e3d61d35f61ca3ce02239782e" title="TCP trace flags.">__tcp_trf</a> &amp; NET_DBG_DHCP) {
<a name="l02163"></a>02163                 <a class="code" href="group__xg_crt_stdio.html#ga2f7351ee13f3f4c465c65e849a12a3fd" title="Print formatted data to a stream.">fprintf</a>(<a class="code" href="netdebug_8h.html#acfd2291903cef784fed77104998ecebd" title="TCP trace output stream.">__tcp_trs</a>, <span class="stringliteral">&quot;[DHCP-Reusing %s]&quot;</span>, <a class="code" href="group__xg_i_p.html#ga9daa3cef32d6bcb76a95d0e869fd8b7a" title="Convert numeric IP address into decimal dotted ASCII representation.">inet_ntoa</a>(<a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a>));
<a name="l02164"></a>02164             }
<a name="l02165"></a>02165 <span class="preprocessor">#endif</span>
<a name="l02166"></a>02166 <span class="preprocessor"></span>            <a class="code" href="group__xg_i_p.html#gaa7092b805dccd43209f32ad437dc2a3f" title="Configure a network interface including the default gateway.">NutNetIfConfig2</a>(name, <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a60f7de301d8f6a941581d1f587e6c3f6" title="Ethernet MAC address.">cdn_mac</a>, <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2d9fc9733178f0ed7abb797f7e7d037e" title="Last used IP address.">cdn_ip_addr</a>, <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#afc1285f9c389c10dbb198116564ed052" title="IP netmask.">cdn_ip_mask</a>, <a class="code" href="group__xg_conf_net.html#ga7096052825ae4f4e42da20d38997842b" title="Global network configuration structure.">confnet</a>.<a class="code" href="struct___c_o_n_f_n_e_t.html#a2bef100194721f03e3519bff3d93c94e" title="Default route.">cdn_gateway</a>);
<a name="l02167"></a>02167             <span class="keywordflow">return</span> 0;
<a name="l02168"></a>02168         }
<a name="l02169"></a>02169     }
<a name="l02170"></a>02170     <span class="keywordflow">return</span> -1;
<a name="l02171"></a>02171 }
<a name="l02172"></a>02172 
<a name="l02189"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga2efa947f8718bb11f6674cb3011aa520">02189</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga2efa947f8718bb11f6674cb3011aa520" title="Relinguish our DHCP lease.">NutDhcpRelease</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l02190"></a>02190 {
<a name="l02191"></a>02191     <span class="comment">/* Check the state. */</span>
<a name="l02192"></a>02192     <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>) {
<a name="l02193"></a>02193         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gaba878e739d434e142fe34a96be7e2f5b" title="DHCP state error.">DHCPERR_STATE</a>;
<a name="l02194"></a>02194         <span class="keywordflow">return</span> -1;
<a name="l02195"></a>02195     }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197     <span class="comment">/* Action! */</span>
<a name="l02198"></a>02198     <span class="keywordflow">return</span> DhcpKick(name, <a class="code" href="group__xg_d_h_c_p_c.html#ga512ac4affb0ba009424b5a46b5216c08" title="DHCP state: Releasing.">DHCPST_RELEASING</a>, timeout);
<a name="l02199"></a>02199 }
<a name="l02200"></a>02200 
<a name="l02211"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga503ce1d2310d16f60ea1f88ae38d119a">02211</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga503ce1d2310d16f60ea1f88ae38d119a" title="Inform DHCP about an allocated address.">NutDhcpInform</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name, <a class="code" href="stdint_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a> timeout)
<a name="l02212"></a>02212 {
<a name="l02213"></a>02213     <span class="comment">/* Check the state. */</span>
<a name="l02214"></a>02214     <span class="keywordflow">if</span> (dhcpState != <a class="code" href="group__xg_d_h_c_p_c.html#ga5ab8e487a62ebb3ed7ed1d7357debf05" title="DHCP state: Stopped.">DHCPST_IDLE</a>) {
<a name="l02215"></a>02215         dhcpError = <a class="code" href="group__xg_d_h_c_p_c.html#gaba878e739d434e142fe34a96be7e2f5b" title="DHCP state error.">DHCPERR_STATE</a>;
<a name="l02216"></a>02216         <span class="keywordflow">return</span> -1;
<a name="l02217"></a>02217     }
<a name="l02218"></a>02218 
<a name="l02219"></a>02219     <span class="comment">/* Action! */</span>
<a name="l02220"></a>02220     <span class="keywordflow">return</span> DhcpKick(name, <a class="code" href="group__xg_d_h_c_p_c.html#ga4abafabe4257cdd6afd733dd9a12bee7" title="DHCP state: Informing.">DHCPST_INFORMING</a>, timeout);
<a name="l02221"></a>02221 }
<a name="l02222"></a>02222 
<a name="l02240"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga9c16be9d86c6824b7fc557fd2289442a">02240</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga9c16be9d86c6824b7fc557fd2289442a" title="Return DHCP client status.">NutDhcpStatus</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name)
<a name="l02241"></a>02241 {
<a name="l02242"></a>02242     <span class="keywordflow">return</span> dhcpState;
<a name="l02243"></a>02243 }
<a name="l02244"></a>02244 
<a name="l02263"></a><a class="code" href="group__xg_d_h_c_p_c.html#ga444065dc84a618a407d05913552942fa">02263</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#ga444065dc84a618a407d05913552942fa" title="Return DHCP error code.">NutDhcpError</a>(<a class="code" href="arm_8h.html#a0c33b494a68ce28497e7ce8e5e95feff">CONST</a> <span class="keywordtype">char</span> *name)
<a name="l02264"></a>02264 {
<a name="l02265"></a>02265     <span class="keywordtype">int</span> rc = dhcpError;
<a name="l02266"></a>02266     dhcpError = 0;
<a name="l02267"></a>02267     <span class="keywordflow">return</span> rc;
<a name="l02268"></a>02268 }
<a name="l02269"></a>02269 
<a name="l02277"></a><a class="code" href="group__xg_d_h_c_p_c.html#gaf62239b0c937c5c43d7e085876a51f0a">02277</a> <span class="keywordtype">int</span> <a class="code" href="group__xg_d_h_c_p_c.html#gaf62239b0c937c5c43d7e085876a51f0a" title="Check if DHCP has configured our interface.">NutDhcpIsConfigured</a>(<span class="keywordtype">void</span>)
<a name="l02278"></a>02278 {
<a name="l02279"></a>02279     <span class="keywordflow">return</span> (dhcpState == <a class="code" href="group__xg_d_h_c_p_c.html#ga740113714ed7fb10d4e645aa89a216e9" title="DHCP state: Bound.">DHCPST_BOUND</a>);
<a name="l02280"></a>02280 }
<a name="l02281"></a>02281 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dhcpc_8c.html">dhcpc.c</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr>
<address>
  <small>
    &copy;&nbsp;2000-2010 by contributors - 
    visit <a href="http://www.ethernut.de/">http://www.ethernut.de/</a>
  </small>
</address>
</body>
</html>
